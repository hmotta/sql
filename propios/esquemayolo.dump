--
-- PostgreSQL database dump
--

SET client_encoding = 'LATIN1';
SET standard_conforming_strings = off;
SET check_function_bodies = false;
SET client_min_messages = warning;
SET escape_string_warning = off;

--
-- Name: SCHEMA public; Type: COMMENT; Schema: -; Owner: postgres
--

COMMENT ON SCHEMA public IS 'Standard public schema';


--
-- Name: sucursal1; Type: SCHEMA; Schema: -; Owner: sistema
--

CREATE SCHEMA sucursal1;


ALTER SCHEMA sucursal1 OWNER TO sistema;

--
-- Name: plpgsql; Type: PROCEDURAL LANGUAGE; Schema: -; Owner: postgres
--

CREATE PROCEDURAL LANGUAGE plpgsql;


SET search_path = public, pg_catalog;

--
-- Name: cartera; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE cartera AS (
	descripcionfinalidad character varying(30),
	desctipoprestamo character(30),
	total numeric,
	menor30 numeric,
	dias1_7 numeric,
	dias8_30 numeric,
	dias31_60 numeric,
	dias61_90 numeric,
	dias91_120 numeric,
	dias121_180 numeric,
	mayor180 numeric
);


ALTER TYPE public.cartera OWNER TO sistema;

--
-- Name: carterac; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE carterac AS (
	clavefinalidad character(3),
	tipoprestamoid character(3),
	diasvencidos integer,
	saldoprestamo numeric
);


ALTER TYPE public.carterac OWNER TO sistema;

--
-- Name: datoaval; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE datoaval AS (
	nombre character varying,
	domicilio character varying,
	nombreciudadmex character varying(20),
	nombreestadomex character varying(20),
	interes numeric,
	moratorio numeric,
	capital numeric,
	diasint integer,
	montoprestamo numeric,
	fecha_otorga date,
	referenciaprestamo character(18)
);


ALTER TYPE public.datoaval OWNER TO sistema;

--
-- Name: dblink_pkey_results; Type: TYPE; Schema: public; Owner: postgres
--

CREATE TYPE dblink_pkey_results AS (
	"position" integer,
	colname text
);


ALTER TYPE public.dblink_pkey_results OWNER TO postgres;

--
-- Name: inversiones; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE inversiones AS (
	clavesocioint character(15),
	nombresocio character varying(80),
	inversionid integer,
	fechainversion date,
	fechavencimiento date,
	tasainteresnormalinversion numeric,
	plazo integer,
	deposito numeric,
	diasvencimiento integer,
	fechapagoanterior date,
	interes numeric,
	tipoinversionid character(3),
	socioid integer,
	grupo character(25)
);


ALTER TYPE public.inversiones OWNER TO sistema;

--
-- Name: inversionesxtipo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE inversionesxtipo AS (
	tipoinversionid character(3),
	cuentapasivo character(24),
	clavesocioint character(15),
	nombresocio character varying(80),
	inversionid integer,
	fechainversion date,
	fechavencimiento date,
	tasainteresnormalinversion numeric,
	plazo integer,
	deposito numeric,
	diasvencimiento integer,
	fechapagoanterior date,
	interes numeric
);


ALTER TYPE public.inversionesxtipo OWNER TO sistema;

--
-- Name: movimientos; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE movimientos AS (
	cuentaid character(24),
	serie character(7),
	numero_poliza integer,
	referencia integer,
	fecha date,
	concepto character varying(255),
	saldoinicial numeric,
	debe numeric,
	haber numeric,
	saldofinal numeric,
	tipo_poliza character(1)
);


ALTER TYPE public.movimientos OWNER TO sistema;

--
-- Name: pdatoaval; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE pdatoaval AS (
	aval character varying,
	domicilio character varying,
	telefono character varying(20),
	socioid integer,
	claveaval character varying(15)
);


ALTER TYPE public.pdatoaval OWNER TO sistema;

--
-- Name: precortec; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE precortec AS (
	clavefinalidad character(3),
	tipoprestamoid character(3),
	diasvencidos integer,
	reservacalculada numeric,
	saldoprestamo numeric
);


ALTER TYPE public.precortec OWNER TO sistema;

--
-- Name: prestamogrupal; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE prestamogrupal AS (
	prestamoid integer,
	tipoprestamoid character(3),
	monto numeric,
	comision numeric,
	grupo character(25),
	contratogrupo integer
);


ALTER TYPE public.prestamogrupal OWNER TO sistema;

--
-- Name: prestamosxt; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE prestamosxt AS (
	essubtotal integer,
	clavesocioint character(15),
	referenciaprestamo character(18),
	montoprestamo numeric,
	saldoprestamo numeric,
	tipoprestamoid character(3),
	fecha_otorga date,
	fecha_vencimiento date
);


ALTER TYPE public.prestamosxt OWNER TO sistema;

--
-- Name: prestamoxtipo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE prestamoxtipo AS (
	essubtotal integer,
	clavesocioint character(15),
	referenciaprestamo character(18),
	montoprestamo numeric,
	saldoprestamo numeric,
	tipoprestamoid character(3),
	fecha_otorga date,
	fecha_vencimiento date,
	nombre character varying(82)
);


ALTER TYPE public.prestamoxtipo OWNER TO sistema;

--
-- Name: primer; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE primer AS (
	primer numeric,
	ultimo numeric
);


ALTER TYPE public.primer OWNER TO sistema;

--
-- Name: raltasbajas; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE raltasbajas AS (
	clavesocioint character(15),
	nombre character varying(80),
	fechaalta date,
	fechabaja date,
	tipo character(1)
);


ALTER TYPE public.raltasbajas OWNER TO sistema;

--
-- Name: ramortizacionesxgrupo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE ramortizacionesxgrupo AS (
	grupo character(25),
	referenciaprestamo character(18),
	numamortizacion integer,
	fechadepago date,
	importeamortizacion numeric,
	interesnormal numeric,
	iva numeric,
	totalpago numeric,
	prestamoid integer,
	clavesocioint character(15),
	nombresocio character(40),
	vencapital numeric,
	veninteres numeric,
	venmoratorio numeric,
	veniva numeric,
	ventotal numeric
);


ALTER TYPE public.ramortizacionesxgrupo OWNER TO sistema;

--
-- Name: rantiguedad; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rantiguedad AS (
	menor90 numeric,
	mayor90 numeric
);


ALTER TYPE public.rantiguedad OWNER TO sistema;

--
-- Name: rautorizabonifica; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rautorizabonifica AS (
	inormal numeric,
	imoratorio numeric,
	cobranza numeric,
	seguro numeric,
	comision numeric,
	ahorro numeric,
	totalbonificacion numeric
);


ALTER TYPE public.rautorizabonifica OWNER TO sistema;

--
-- Name: ravalados; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE ravalados AS (
	clavesocioint character(15),
	referenciaprestamo character(18),
	nombre character varying(80),
	monto numeric,
	saldo numeric,
	atraso numeric
);


ALTER TYPE public.ravalados OWNER TO sistema;

--
-- Name: ravisos; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE ravisos AS (
	avisoid integer,
	tipoavisoid integer,
	prestamoid integer,
	fechaenvio date,
	fechacontestacion date,
	diasatrasoprestamo integer,
	amortizacionesvencidas integer,
	capitalvencido numeric,
	interesvencido numeric,
	observacionaviso text,
	estatusaviso character(1),
	clavesocioint character(15),
	nombresocio character varying(80),
	referenciaprestamo character(18),
	descripciontipoaviso character varying(60)
);


ALTER TYPE public.ravisos OWNER TO sistema;

--
-- Name: rbuscasucursal; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rbuscasucursal AS (
	host character varying(40),
	basededatos character varying(20),
	esquema character varying(20)
);


ALTER TYPE public.rbuscasucursal OWNER TO sistema;

--
-- Name: rcarteracomunidad; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rcarteracomunidad AS (
	tiposocioid integer,
	prestamoid integer,
	socioid integer,
	sujetoid integer,
	clavesocioint character(15),
	referenciaprestamo character(18),
	tipoprestamo character(3),
	nombre character varying(80),
	paterno character varying(80),
	materno character varying(80),
	calle character varying(80),
	numeroext character varying(20),
	numeroint character varying(20),
	colonia character varying(80),
	ciudad character varying(80),
	estado character varying(80),
	telefono character varying(30),
	comunidad character varying(80),
	cp character varying(7),
	rfc character(20),
	curp character(25),
	sexo character(3),
	totalingresos numeric,
	ocupacion character varying(60),
	finalidad character varying(30),
	fecha_otorga date,
	fecha_vencimiento date,
	fecha_ultimopago date,
	fecha_nacimiento date,
	fecha_de_ingreso date,
	mesesavencer numeric,
	montoprestamo numeric,
	saldoprest numeric,
	cantidadpagada numeric,
	diasatraso numeric,
	amortizacion numeric,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	vencidas numeric,
	ahorro numeric,
	ahorro_reci numeric,
	caval1 character(15),
	nombreaval1 character varying(80),
	calleaval1 character varying(50),
	numeroextaval1 character(10),
	numerointaval1 character(10),
	coloniaaval1 character varying(50),
	comunidadaval1 character varying(50),
	ciudadaval1 character varying(50),
	estadoaval1 character varying(50),
	telefonoaval1 character(20),
	caval2 character(15),
	nombreaval2 character varying(80),
	calleaval2 character varying(50),
	numeroextaval2 character(10),
	numerointaval2 character(10),
	coloniaaval2 character varying(50),
	comunidadaval2 character varying(50),
	ciudadaval2 character varying(50),
	estadoaval2 character varying(50),
	telefonoaval2 character(20),
	caval3 character(15),
	nombreaval3 character varying(80),
	calleaval3 character varying(50),
	numeroextaval3 character(10),
	numerointaval3 character(10),
	coloniaaval3 character varying(50),
	comunidadaval3 character varying(50),
	ciudadaval3 character varying(50),
	estadoaval3 character varying(50),
	telefonoaval3 character(20),
	caval4 character(15),
	nombreaval4 character varying(80),
	calleaval4 character varying(50),
	numeroextaval4 character(10),
	numerointaval4 character(10),
	coloniaaval4 character varying(50),
	comunidadaval4 character varying(50),
	ciudadaval4 character varying(50),
	estadoaval4 character varying(50),
	telefonoaval4 character(20)
);


ALTER TYPE public.rcarteracomunidad OWNER TO sistema;

--
-- Name: rcatalogosocio; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rcatalogosocio AS (
	clavesocioint character(15),
	nombresocio character varying(80),
	domicilio character varying(150),
	telefono character varying(20),
	ciudad character varying(35),
	fechaingreso date,
	fechabaja date,
	tipo character(1),
	edad numeric
);


ALTER TYPE public.rcatalogosocio OWNER TO sistema;

--
-- Name: rcobranza; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rcobranza AS (
	cobranza numeric,
	ivacobranza numeric
);


ALTER TYPE public.rcobranza OWNER TO sistema;

--
-- Name: rcobranzaesperada; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rcobranzaesperada AS (
	prestamoid integer,
	clavesocioint character(15),
	nombre character varying(80),
	referenciaprestamo character(18),
	fechadepago date,
	amortizacion numeric,
	vencidas numeric,
	diasint numeric,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	total numeric
);


ALTER TYPE public.rcobranzaesperada OWNER TO sistema;

--
-- Name: rcomision; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rcomision AS (
	comision numeric,
	ivacomision numeric
);


ALTER TYPE public.rcomision OWNER TO sistema;

--
-- Name: rconsultamov; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rconsultamov AS (
	clavesocioint character(15),
	nombresocio character varying(81),
	saldo1 numeric,
	saldo2 numeric,
	saldo3 numeric,
	saldo4 numeric,
	fecha1 date,
	fecha2 date,
	fecha3 date,
	fecha4 date
);


ALTER TYPE public.rconsultamov OWNER TO sistema;

--
-- Name: rconvenios; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rconvenios AS (
	clavesocioint character(15),
	referenciaprestamo character(18),
	nombre character(80),
	usuarioid character(20),
	fechaconvenio date,
	lugar character(7)
);


ALTER TYPE public.rconvenios OWNER TO sistema;

--
-- Name: rcortecaja; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rcortecaja AS (
	folio integer,
	referencia integer,
	serie character(2),
	socioid integer,
	clavesocioint character(15),
	fecha date,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	deposito numeric,
	retiro numeric,
	tipomovimientoid character(2),
	tipoprestamoid character(3),
	cobranza numeric
);


ALTER TYPE public.rcortecaja OWNER TO sistema;

--
-- Name: rcortecajapdf; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rcortecajapdf AS (
	folio integer,
	referencia integer,
	serie character(2),
	socioid integer,
	clavesocioint character(15),
	fecha date,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	deposito numeric,
	retiro numeric,
	tipomovimientoid character(2),
	tipoprestamoid character(3),
	cobranza numeric
);


ALTER TYPE public.rcortecajapdf OWNER TO sistema;

--
-- Name: rdepositos; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rdepositos AS (
	clavesocioint character(15),
	paterno character varying(20),
	materno character varying(20),
	nombre character varying(40),
	depositos numeric,
	idecalculado numeric,
	ideretenido numeric,
	rfccaja character varying(20),
	nombrecaja character varying(80),
	razonsocial character varying(60),
	montoide numeric,
	idexrecaudar numeric,
	idexrecaudaranterior numeric,
	socioid integer
);


ALTER TYPE public.rdepositos OWNER TO sistema;

--
-- Name: rdepreciacion; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rdepreciacion AS (
	activoid integer,
	activoclave character(15),
	activodescripcion character varying(255),
	valormercado numeric,
	feciniciodepfiscal date,
	inpcprimeramitad numeric,
	inpcadquiscion numeric,
	factdeprec numeric,
	deprecactejerc numeric,
	factsaldo numeric,
	saldoxdeduc numeric,
	deprecactulizada numeric,
	baseimpac numeric
);


ALTER TYPE public.rdepreciacion OWNER TO sistema;

--
-- Name: rdetallemovicaptacion; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rdetallemovicaptacion AS (
	suc character(4),
	clavesocioint character(16),
	nombresocio character varying(80),
	fechamvto date,
	t_mvto character(2),
	desctipomovimiento character(30),
	deposito numeric,
	retiro numeric,
	s_pol character(30),
	usuarioid character(20)
);


ALTER TYPE public.rdetallemovicaptacion OWNER TO sistema;

--
-- Name: redocta; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE redocta AS (
	numamortizacion integer,
	fechadepago date,
	ultimoabono date,
	importeamortizacion numeric,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	total numeric
);


ALTER TYPE public.redocta OWNER TO sistema;

--
-- Name: redoctainversion; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE redoctainversion AS (
	tipomov character(5),
	inversionid integer,
	clavesocioint character(15),
	fechadepago date,
	capital numeric,
	interes numeric,
	isr numeric,
	proxfechainteres date,
	proxinteres numeric,
	proxisr numeric
);


ALTER TYPE public.redoctainversion OWNER TO sistema;

--
-- Name: restadistico; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE restadistico AS (
	noprestamos integer,
	fechaultprestamo date,
	cumplimiento integer,
	observacion character(255)
);


ALTER TYPE public.restadistico OWNER TO sistema;

--
-- Name: restadisticoctas; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE restadisticoctas AS (
	tipo character(3),
	descripcion character(30),
	nosocios integer,
	saldo numeric,
	ordenmov character(1)
);


ALTER TYPE public.restadisticoctas OWNER TO sistema;

--
-- Name: restadisticoporsexo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE restadisticoporsexo AS (
	sucid character(4),
	nombrecaja character varying(80),
	mujer integer,
	hombre integer,
	tipomov character(2),
	desctipomov character(30)
);


ALTER TYPE public.restadisticoporsexo OWNER TO sistema;

--
-- Name: restadocta; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE restadocta AS (
	fecha date,
	serie character(2),
	nopoliza integer,
	referenciacaja integer,
	monto_prestamo numeric,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	total numeric,
	saldoinicial numeric,
	saldofinal numeric
);


ALTER TYPE public.restadocta OWNER TO sistema;

--
-- Name: restadoinversion; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE restadoinversion AS (
	inversionid integer,
	socioid integer,
	depositoinversion numeric,
	interesinversion numeric,
	fechainversion date,
	fechavencimiento date,
	noderenovaciones integer,
	tasainteresnormalinversion numeric,
	fechapagoinversion date,
	isrinversion numeric,
	instrucciones text,
	tipoinversionid character(3)
);


ALTER TYPE public.restadoinversion OWNER TO sistema;

--
-- Name: resumenprestamos; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE resumenprestamos AS (
	sucursal character(4),
	descripcionfinalidad character varying(30),
	referenciaprestamo character(18),
	clavesocioint character(15),
	nombresocio character varying(82),
	fechacierre date,
	saldovencidomenoravencido numeric,
	saldovencidomayoravencido numeric,
	interesdevengadomenoravencido numeric,
	interesdevengadomayoravencido numeric,
	montoprestamo numeric,
	tasanormal numeric,
	numero_de_amor integer,
	fecha_otorga date,
	fecha_vencimiento date,
	ultimoabono date,
	tantos numeric,
	diasmora integer,
	diasporvencer integer
);


ALTER TYPE public.resumenprestamos OWNER TO sistema;

--
-- Name: rformato; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rformato AS (
	clave integer,
	nombre text,
	fecha_reporte character(9),
	paterno character varying(20),
	materno character varying(20),
	adicional character varying(40),
	primer_nombre character varying(40),
	segundo character varying(40),
	fecha_nac character(9),
	rfc character(13),
	prefijo character varying(10),
	edo_civil character varying(8),
	sexo character(2),
	f_def date,
	indic_def character varying(2),
	calle_numero character varying(80),
	segunda_linea character varying(80),
	colonia character varying(100),
	municipio character varying(100),
	ciudad character varying(100),
	estado character varying(4),
	cp character varying(15),
	telefono character varying(20),
	member character varying(10),
	nombre_2 character varying(100),
	cuenta character varying(19),
	responsabilidad character varying(2),
	tipo_cta character varying(2),
	tipo_contrato character varying(3),
	moneda character varying(3),
	num_pagos integer,
	frec_pagos character varying(2),
	importe_pago numeric,
	apertura character(9),
	pago character(9),
	compra character(9),
	cierre character(9),
	reporte character(9),
	cred_maximo numeric,
	saldo_actual numeric,
	limite_credito numeric,
	saldo_vencido numeric,
	pagos_vencidos numeric,
	forma_pago_actual character varying(3),
	observacion character varying(80),
	member_ant character varying(10),
	nombre_ant character varying(30),
	numero_ant character varying(10)
);


ALTER TYPE public.rformato OWNER TO sistema;

--
-- Name: rgeneralsocios; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rgeneralsocios AS (
	clavesocioint character(15),
	grupo character(25),
	tiposocioid character(2),
	personajuridica character(10),
	nombre character varying(80),
	sucursal character(4),
	direccion character varying(80),
	colonia character varying(50),
	comunidadmigrada character varying(50),
	ciudadsepomex character varying(50),
	claveestadoconapo character varying(10),
	clavemunicipioconapo character varying(10),
	clavelocalidadconapo character(10),
	municipioconapo character varying(100),
	localidadconapo character varying(100),
	parte_social_pa numeric,
	parte_adicional_pb numeric,
	parte_p3 numeric,
	profesion character varying(40),
	ocupacion character varying(40),
	sexo character(15),
	fecha_nacimiento date,
	estado_civil character(15),
	fechaingreso date,
	numerohabitantes integer,
	grado_de_marginacion character(15),
	poblacion_indigena character(2),
	saldo_ahorro numeric,
	fechaultimoahorro date,
	saldo_promedio_inver numeric,
	fechaultimoinversion date,
	edad integer
);


ALTER TYPE public.rgeneralsocios OWNER TO sistema;

--
-- Name: rhistoricoabono; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rhistoricoabono AS (
	referenciacaja integer,
	seriecaja character(2),
	numero_poliza integer,
	tipomovimientoid character(2),
	fechapoliza date,
	concepto_poliza character varying(255),
	cuentanombre character varying(100),
	debe numeric,
	haber numeric
);


ALTER TYPE public.rhistoricoabono OWNER TO sistema;

--
-- Name: ringresoegreso; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE ringresoegreso AS (
	orden character(1),
	cuentaid character(24),
	cuentacaja character(24),
	cuentanombre character(50),
	debe numeric,
	haber numeric
);


ALTER TYPE public.ringresoegreso OWNER TO sistema;

--
-- Name: rinversiones; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rinversiones AS (
	inversionid integer,
	clavesocionint character(15),
	depositoinversion numeric,
	fechavencimiento date,
	fechapagoinversion date,
	interesinversion numeric,
	dias integer,
	tipoinversionid character(3),
	tasainteresnormalinversion numeric,
	noderenovaciones integer
);


ALTER TYPE public.rinversiones OWNER TO sistema;

--
-- Name: rinversionesporpagar; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rinversionesporpagar AS (
	inversionid integer,
	socioid integer,
	nombre character varying(50),
	depositoinversion numeric,
	interesinversion numeric,
	fechainversion date,
	fechavencimiento date,
	noderenovaciones integer,
	tasainteresnormalinversion numeric,
	fechapagoinversion date,
	isrinversion numeric,
	instrucciones text,
	tipoinversionid character(3),
	proxfechapago date,
	proxcapital numeric,
	proxinteres numeric,
	proxisr numeric,
	grupo character(25)
);


ALTER TYPE public.rinversionesporpagar OWNER TO sistema;

--
-- Name: rinversiontipo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rinversiontipo AS (
	clavesocioint character(15),
	referenciainversion integer,
	nombre character varying(80),
	fechainversion date,
	fechavencimiento date,
	depositoinversion numeric,
	tasainteresnormalinversion numeric,
	interes numeric,
	isr numeric,
	tipoinversionid character(3)
);


ALTER TYPE public.rinversiontipo OWNER TO sistema;

--
-- Name: rlibromayor; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rlibromayor AS (
	cuentaid character(24),
	cuentanombre character(50),
	periodo integer,
	cargosm numeric,
	abonosm numeric,
	saldo numeric,
	cargosa numeric,
	abonosa numeric
);


ALTER TYPE public.rlibromayor OWNER TO sistema;

--
-- Name: rmayor; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rmayor AS (
	cuentaid character(24),
	cuentanombre character(50),
	periodo integer,
	debe numeric,
	haber numeric
);


ALTER TYPE public.rmayor OWNER TO sistema;

--
-- Name: rmovicaja; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rmovicaja AS (
	movicajaid integer,
	socioid integer,
	tipomovimientoid character(2),
	polizaid integer,
	referenciacaja integer,
	seriecaja character(2),
	movipolizaid integer,
	prestamoid integer,
	estatusmovicaja character(1),
	inversionid integer,
	debe numeric,
	haber numeric
);


ALTER TYPE public.rmovicaja OWNER TO sistema;

--
-- Name: rmovicaja00; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rmovicaja00 AS (
	movicajaid integer,
	socioid integer,
	tipomovimientoid character(2),
	polizaid integer,
	referenciacaja integer,
	seriecaja character(2),
	movipolizaid integer,
	prestamoid integer,
	estatusmovicaja character(1),
	inversionid integer,
	debe numeric,
	haber numeric,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric
);


ALTER TYPE public.rmovicaja00 OWNER TO sistema;

--
-- Name: rmovimientoscaja; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rmovimientoscaja AS (
	fechapoliza date,
	seriepoliza character(2),
	numero_poliza integer,
	seriecaja character(2),
	referenciacaja integer,
	desctipomovimiento character(30),
	refmovimiento character(30),
	debe numeric,
	haber numeric,
	tipomovimientoid character(3),
	movicajaid integer
);


ALTER TYPE public.rmovimientoscaja OWNER TO sistema;

--
-- Name: rmovimientosxfecha; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rmovimientosxfecha AS (
	clavesocioint character(15),
	nombre character varying(80),
	depaa numeric,
	retaa numeric,
	depdv numeric,
	retdv numeric,
	depin numeric,
	retin numeric
);


ALTER TYPE public.rmovimientosxfecha OWNER TO sistema;

--
-- Name: rpagoprocampo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rpagoprocampo AS (
	referenciaprestamo character(18),
	nombresocio character varying(80),
	montoprestamo numeric,
	fechaultimopago date
);


ALTER TYPE public.rpagoprocampo OWNER TO sistema;

--
-- Name: rpagoprocamponopagados; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rpagoprocamponopagados AS (
	referenciaprestamo character(18),
	nombresocio character varying(80),
	montoprestamo numeric,
	saldoprestamo numeric,
	fecha_vencimiento date,
	fechaultimopago date,
	fecha_otorga date,
	dias integer,
	tasanormal numeric,
	interes_prestamo numeric,
	total_interes numeric
);


ALTER TYPE public.rpagoprocamponopagados OWNER TO sistema;

--
-- Name: rpavisos; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rpavisos AS (
	clavesocioint character(15),
	nombre character varying(80),
	telefono character(20),
	descripciontipoaviso character(60),
	montoprestamo numeric,
	saldoprestamo numeric,
	amortizacion numeric,
	diasatraso integer,
	fechaenvio date,
	prestamoid integer,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	amortvencidas integer,
	fechaultimopago date,
	domicilio character(60),
	aval1 character(60),
	domaval1 character(60),
	aval2 character(60),
	domaval2 character(60),
	tipoprestamoid character(30)
);


ALTER TYPE public.rpavisos OWNER TO sistema;

--
-- Name: rpermisomodulo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rpermisomodulo AS (
	permisomoduloid integer,
	clavemodulo character(10),
	usuarioid character(20),
	permiso character(1),
	descripcionmodulos character(80)
);


ALTER TYPE public.rpermisomodulo OWNER TO sistema;

--
-- Name: rpfolioscancelados; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rpfolioscancelados AS (
	referencia integer,
	serie character(2),
	numero_poliza integer,
	tipomovimientoid character(2),
	clavesocioint character(15),
	fecha date,
	concepto character(40)
);


ALTER TYPE public.rpfolioscancelados OWNER TO sistema;

--
-- Name: rprestamosactivos; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rprestamosactivos AS (
	treferenciaprestamo character(18),
	tmontoprestamo numeric,
	tsaldoprestamo numeric,
	tfecha_vencimiento date,
	tasanormal numeric,
	tasamoratoria numeric,
	tfechaultimopago date
);


ALTER TYPE public.rprestamosactivos OWNER TO sistema;

--
-- Name: rprestamosrelacionados; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rprestamosrelacionados AS (
	socioid integer,
	clavesocioint character(15),
	nombre character varying(80),
	colonia character varying(30),
	codpostal integer,
	partesocial numeric,
	cuentacorriente numeric,
	ahorrosedesol numeric,
	ahorroordinario numeric,
	plazofijo numeric,
	otrohaberes numeric,
	credifacil numeric,
	confianza numeric,
	credihogar numeric,
	automatico numeric,
	renovado numeric,
	ordinario numeric,
	reestructurado numeric,
	extraordinario numeric,
	alapalabracint numeric,
	alapalabrasint numeric,
	otros numeric,
	totalprestamos numeric,
	tipoprestamo character(3)
);


ALTER TYPE public.rprestamosrelacionados OWNER TO sistema;

--
-- Name: rprestamossocio; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rprestamossocio AS (
	refererenciaprestamo character(18),
	fecha_otorga date,
	clavesocioint character(15),
	montoprestamo numeric,
	descripcionedocredito character varying(30)
);


ALTER TYPE public.rprestamossocio OWNER TO sistema;

--
-- Name: rpresupuestosocios; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rpresupuestosocios AS (
	sociomayormes numeric,
	sociomenormes numeric,
	socioformames numeric,
	sociomayor numeric,
	sociomenor numeric,
	socioforma numeric
);


ALTER TYPE public.rpresupuestosocios OWNER TO sistema;

--
-- Name: rpromocion; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rpromocion AS (
	clavesocioint character(15),
	nombresocio character varying(81),
	fecha date,
	estatus integer,
	promocionid integer
);


ALTER TYPE public.rpromocion OWNER TO sistema;

--
-- Name: rptintdevxtipo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rptintdevxtipo AS (
	tipoprestamoid character(3),
	desctipoprestamo character(30),
	intdevvigente numeric,
	intdevvencido numeric
);


ALTER TYPE public.rptintdevxtipo OWNER TO sistema;

--
-- Name: rptmovibanco; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rptmovibanco AS (
	consecutivo integer,
	fechapoliza date,
	referenciamovi character(14),
	descritipomovibanco character(30),
	beneficiario character(45),
	debe numeric,
	haber numeric,
	serie character(2)
);


ALTER TYPE public.rptmovibanco OWNER TO sistema;

--
-- Name: rptprestamo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rptprestamo AS (
	referenciaprestamo character(18),
	clavesocioint character(15),
	monto_prestamo numeric,
	saldo_prestamo numeric,
	fecha_otorga date,
	fecha_vencimiento date,
	tasa_normal numeric,
	tasa_moratoria numeric,
	descripcionedocredito character varying(30),
	usuarioid character(20)
);


ALTER TYPE public.rptprestamo OWNER TO sistema;

--
-- Name: rptsaldosxfecha; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rptsaldosxfecha AS (
	tipomovimientoid character(2),
	desctipomovimiento character(30),
	saldoinicial numeric,
	depositos numeric,
	retiros numeric,
	saldofinal numeric
);


ALTER TYPE public.rptsaldosxfecha OWNER TO sistema;

--
-- Name: rptxtipomovimiento; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rptxtipomovimiento AS (
	tipomovimientoid character(2),
	serie character(2),
	referencia integer,
	numero_poliza integer,
	fecha date,
	saldoinicial numeric,
	depositos numeric,
	retiros numeric,
	interes numeric,
	saldofinal numeric
);


ALTER TYPE public.rptxtipomovimiento OWNER TO sistema;

--
-- Name: rrcoeficiente; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rrcoeficiente AS (
	concepto1 text,
	concepto2 text,
	concepto3 text,
	a numeric,
	b numeric
);


ALTER TYPE public.rrcoeficiente OWNER TO sistema;

--
-- Name: rrecupera; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rrecupera AS (
	suc character(4),
	referenciaprestamo character(18),
	prestamoid integer,
	clavesocioint character(15),
	fechadepago date,
	nombresocio character varying(80),
	montoprestamo numeric,
	tipoprestamoid character(3),
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	ivacalculado numeric,
	grupo character(25),
	cobrador character varying(60)
);


ALTER TYPE public.rrecupera OWNER TO sistema;

--
-- Name: rredores; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rredores AS (
	rubro1 character varying(400),
	t1 numeric,
	t2 numeric,
	t3 numeric,
	t4 numeric
);


ALTER TYPE public.rredores OWNER TO sistema;

--
-- Name: rrelacionessocio; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rrelacionessocio AS (
	socioid integer,
	parentesco character varying(20),
	clavesocioint character(16)
);


ALTER TYPE public.rrelacionessocio OWNER TO sistema;

--
-- Name: rreporte1; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rreporte1 AS (
	clavesocioint character(15),
	nombre character varying(40),
	fecha_nacimiento date,
	fecha_ingreso date,
	tiposocioid character(2),
	socioid integer,
	edad integer,
	estatussocio integer,
	tipopersona character(10),
	saldohaberes numeric,
	saldodebes numeric,
	saldoparte numeric
);


ALTER TYPE public.rreporte1 OWNER TO sistema;

--
-- Name: rreporte4; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rreporte4 AS (
	tipoprestamoid character(3),
	desctipoprestamo character varying(30),
	tasanormal numeric,
	sumaprestamos integer,
	sumamonto numeric,
	sumasaldo numeric
);


ALTER TYPE public.rreporte4 OWNER TO sistema;

--
-- Name: rreportecomisionescob; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rreportecomisionescob AS (
	suc character(4),
	clavesocioint character(16),
	nombresocio character varying(80),
	fechamvto date,
	polizaid integer,
	monto numeric,
	t_mvto character(20),
	desctipomovimiento character(30),
	s_pol character(30),
	usuarioid character(20),
	comision numeric,
	iva numeric
);


ALTER TYPE public.rreportecomisionescob OWNER TO sistema;

--
-- Name: rreporteide; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rreporteide AS (
	suc character(4),
	clavesocioint character(15),
	socioid integer,
	nombre character varying(80),
	tipopersona character(10),
	rfc character(15),
	curp character(20),
	domicilio character varying(80),
	comunidad character varying(80),
	saldoide numeric,
	importe numeric
);


ALTER TYPE public.rreporteide OWNER TO sistema;

--
-- Name: rreporteisr; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rreporteisr AS (
	suc character(4),
	clavesocioint character(16),
	nombresocio character varying(80),
	fechamvto date,
	polizaid integer,
	cobro_isr numeric,
	inversionid integer,
	monto_inversion numeric,
	interes_inversion numeric,
	s_pol character(30)
);


ALTER TYPE public.rreporteisr OWNER TO sistema;

--
-- Name: rreportepagoscobros; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rreportepagoscobros AS (
	suc character(4),
	clavesocioint character(16),
	nombresocio character varying(80),
	fechamvto date,
	polizaid integer,
	deposito numeric,
	retiro numeric,
	t_mvto character(2),
	desctipomovimiento character(30),
	s_pol character(30),
	usuarioid character(20)
);


ALTER TYPE public.rreportepagoscobros OWNER TO sistema;

--
-- Name: rreporteseleccion; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rreporteseleccion AS (
	socioid integer,
	clavesocioint character(15),
	nombre character varying(80),
	colonia character varying(30),
	codpostal integer,
	direccion character varying(50),
	telefono character varying(20),
	comunidad character varying(40),
	partesocial numeric,
	cuentacorriente numeric,
	ahorrosedesol numeric,
	ahorroordinario numeric,
	plazofijo numeric,
	otrohaberes numeric,
	credifacil numeric,
	confianza numeric,
	credihogar numeric,
	automatico numeric,
	renovado numeric,
	ordinario numeric,
	reestructurado numeric,
	extraordinario numeric,
	alapalabracint numeric,
	alapalabrasint numeric,
	otros numeric,
	totalprestamos numeric,
	tipoprestamo character(3)
);


ALTER TYPE public.rreporteseleccion OWNER TO sistema;

--
-- Name: rriesgocomun; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rriesgocomun AS (
	clavesocioint character(15),
	tipoprestamoid character(3),
	fecha_otorga date,
	monto numeric,
	nombre character(40),
	paterno character(20),
	materno character(20),
	rfc character(16),
	curp character(20),
	parentesco character(20),
	domicilio character varying(80),
	colonia character varying(100),
	ciudad character varying(100),
	telefono character varying(20),
	solicitudingresoid integer
);


ALTER TYPE public.rriesgocomun OWNER TO sistema;

--
-- Name: rrpbalance; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rrpbalance AS (
	rubro1 character varying(200),
	t1 numeric,
	t2 numeric,
	rubro2 character varying(200),
	t3 numeric,
	t4 numeric
);


ALTER TYPE public.rrpbalance OWNER TO sistema;

--
-- Name: rrpcambios; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rrpcambios AS (
	rubro1 character varying(200),
	t1 numeric,
	t2 numeric,
	t3 numeric,
	t4 numeric,
	t5 numeric,
	t6 numeric,
	t7 numeric,
	t8 numeric,
	t9 numeric,
	t10 numeric,
	t11 numeric,
	t12 numeric,
	t13 numeric,
	t14 numeric,
	t15 numeric,
	t16 numeric,
	t17 numeric,
	t18 numeric,
	t19 numeric
);


ALTER TYPE public.rrpcambios OWNER TO sistema;

--
-- Name: rrpedores; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rrpedores AS (
	rubro1 character varying(200),
	t1 numeric,
	t2 numeric,
	t3 numeric,
	t4 numeric,
	rubro2 character varying(100),
	rubro3 character varying(100)
);


ALTER TYPE public.rrpedores OWNER TO sistema;

--
-- Name: rrprazones; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rrprazones AS (
	rubro1 character varying(200),
	rubro2 character varying(200),
	t2 numeric,
	t3 numeric,
	t4 numeric
);


ALTER TYPE public.rrprazones OWNER TO sistema;

--
-- Name: rsaldofechacorte; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rsaldofechacorte AS (
	prestamoid integer,
	clavesocioint character(15),
	referenciaprestamo character(18),
	nombre character varying(80),
	fecha_otorga date,
	fecha_vencimiento date,
	montoprestamo numeric,
	saldoprest numeric,
	diasatraso numeric,
	amortizacion numeric,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	vencidas numeric,
	fechaultimopago date,
	direccion character(256),
	telefono character(20)
);


ALTER TYPE public.rsaldofechacorte OWNER TO sistema;

--
-- Name: rsaldos; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rsaldos AS (
	tipor integer,
	referenciaprestamo character(18),
	clavesocioint character(15),
	nombresocio character varying(80),
	fecha_otorga date,
	montoprestamo numeric,
	saldoprestamo numeric,
	desctipoprestamo character(30),
	tipoprestamoid character(3),
	usuarioid character(10)
);


ALTER TYPE public.rsaldos OWNER TO sistema;

--
-- Name: rsaldosdemovimientos; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rsaldosdemovimientos AS (
	tipomovimientoid character(2),
	clavesocioint character(15),
	nombre character varying(80),
	saldo numeric,
	fechaultmov date
);


ALTER TYPE public.rsaldosdemovimientos OWNER TO sistema;

--
-- Name: rsaldospprocampo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rsaldospprocampo AS (
	referenciaprestamo character(18),
	nombresocio character varying(80),
	fecha_otorga date,
	montoprestamo numeric,
	saldoprestamo numeric,
	desctipoprestamo character(30),
	tipoprestamoid character(3)
);


ALTER TYPE public.rsaldospprocampo OWNER TO sistema;

--
-- Name: rsdocalculado; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rsdocalculado AS (
	saldoprestamo numeric,
	saldocalculado numeric,
	claveestadocredito character(3)
);


ALTER TYPE public.rsdocalculado OWNER TO sistema;

--
-- Name: rseguro; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rseguro AS (
	seguro numeric,
	ivaseguro numeric
);


ALTER TYPE public.rseguro OWNER TO sistema;

--
-- Name: rstatusconocecliente; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rstatusconocecliente AS (
	clavesocioint character(15)
);


ALTER TYPE public.rstatusconocecliente OWNER TO sistema;

--
-- Name: rsucursalesenlace; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rsucursalesenlace AS (
	sucursalid integer,
	basededatos character(20)
);


ALTER TYPE public.rsucursalesenlace OWNER TO sistema;

--
-- Name: rvalorrango; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE rvalorrango AS (
	rangoid integer,
	nombrerango character(80),
	saldoinicial numeric,
	cargos numeric,
	abonos numeric,
	saldofinal numeric
);


ALTER TYPE public.rvalorrango OWNER TO sistema;

--
-- Name: saldossocio; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE saldossocio AS (
	socioid integer,
	haberes numeric,
	deberes numeric,
	parte numeric
);


ALTER TYPE public.saldossocio OWNER TO sistema;

--
-- Name: sdomovsocio; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE sdomovsocio AS (
	tiposocio integer,
	clavesocioint character(15),
	nombre character varying(80),
	ultimomovimiento date,
	saldo numeric
);


ALTER TYPE public.sdomovsocio OWNER TO sistema;

--
-- Name: socioactivo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE socioactivo AS (
	clavesocioint character(15),
	nombre character varying(80),
	direccion character varying(145),
	estatus integer
);


ALTER TYPE public.socioactivo OWNER TO sistema;

--
-- Name: sociosxtipomovimiento; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE sociosxtipomovimiento AS (
	socioid integer,
	clavesocioint character(18),
	saldomovimiento numeric
);


ALTER TYPE public.sociosxtipomovimiento OWNER TO sistema;

--
-- Name: socioxtipo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE socioxtipo AS (
	clavesocioint character(15),
	nombre character varying(80),
	direccion character varying(100),
	colonia character varying(30),
	cp integer,
	comunidad character varying(50),
	nombreciudadmex character varying(35),
	partesocial numeric,
	tiposocioid character(2),
	estatus integer
);


ALTER TYPE public.socioxtipo OWNER TO sistema;

--
-- Name: sptipoinversion; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE sptipoinversion AS (
	tipoinversionid character(3),
	cuentariesgocred character(24),
	cuentaintinvernocob character(24),
	calculoid integer,
	cuentapasivo character(24),
	cuentapasivovencida character(24),
	cuentaintinver character(24),
	cuentaivainver character(24),
	desctipoinversion character(30),
	tasa_normal_inversion numeric,
	plazo integer,
	aplicaivainversion character(1),
	aplicaisr integer,
	reinvierteinteres integer,
	tipomovimientoid character(2),
	cuentaprovisionisr character(24),
	clasificacionid integer,
	plazomaximo integer
);


ALTER TYPE public.sptipoinversion OWNER TO sistema;

--
-- Name: tablaamor; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tablaamor AS (
	numamortizacion integer,
	fechadepago date,
	tasainteres numeric,
	importeamortizacion numeric,
	interesnormal numeric,
	iva numeric,
	saldo_absoluto numeric,
	pagototal numeric
);


ALTER TYPE public.tablaamor OWNER TO sistema;

--
-- Name: tanalisiscartera; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tanalisiscartera AS (
	prestamoid integer,
	clavesocioint character(15),
	nombre character varying(120),
	referenciaprestamo character(18),
	fecha_otorgamiento date,
	montoprestamo numeric,
	dias_mora integer,
	categoria_mora_precierre character(10),
	saldo_prestamo_precierre numeric,
	fecha_precierre date,
	categoria_mora_actual character(10),
	saldo_prestamo_actual numeric,
	fecha_actual date,
	sucursal character(4),
	tipoprestamo character(32),
	dias_mora_precierre integer,
	cobrador character varying(80)
);


ALTER TYPE public.tanalisiscartera OWNER TO sistema;

--
-- Name: tavalriesgo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tavalriesgo AS (
	prestamoid integer,
	paterno character(20),
	materno character varying(20),
	nombre character varying(40),
	curp character(20),
	rfc character(16),
	calle character(50),
	numero_ext character varying(15),
	numero_int character varying(15),
	nombrecolonia character varying(50),
	codpostal integer
);


ALTER TYPE public.tavalriesgo OWNER TO sistema;

--
-- Name: tcalculopago; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcalculopago AS (
	prestamoid integer,
	amortizacion numeric,
	vencidas numeric,
	diasint integer,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	total numeric
);


ALTER TYPE public.tcalculopago OWNER TO sistema;

--
-- Name: tcalculopagocartera; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcalculopagocartera AS (
	prestamoid integer,
	amortizacion numeric,
	vencidas numeric,
	diasint integer,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	total numeric,
	saldoprestamo numeric,
	fechaultimopago date
);


ALTER TYPE public.tcalculopagocartera OWNER TO sistema;

--
-- Name: tcalculopagos; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcalculopagos AS (
	prestamoid integer,
	saldoprestamo numeric,
	amortizacion numeric,
	vencidas numeric,
	diasint integer,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	total numeric
);


ALTER TYPE public.tcalculopagos OWNER TO sistema;

--
-- Name: tcaptacnbv; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcaptacnbv AS (
	clavesocioint character(18),
	nombresocio character varying(80),
	desctipoinversion character(30),
	inversionid integer,
	fechainversion date,
	fechavencimiento date,
	tasainteresnormalinversion numeric,
	plazo integer,
	deposito numeric,
	diasvencimiento integer,
	formapagorendimiento integer,
	tipoinversionid character(3)
);


ALTER TYPE public.tcaptacnbv OWNER TO sistema;

--
-- Name: tcarteracnbv; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcarteracnbv AS (
	clavesocioint character(15),
	referenciaprestamo character(18),
	ejercicio integer,
	periodo integer,
	fechacierre date,
	diasvencidos integer,
	porcentajeaplicado numeric,
	factoraplicado numeric,
	saldoprestamo numeric,
	reservacalculada numeric,
	interesdevengadomenoravencido numeric,
	interesdevengadomayoravencido numeric,
	pagocapitalenperiodo numeric,
	pagointeresenperiodo numeric,
	pagomoratorioenperiodo numeric,
	bonificacionenperiodo numeric,
	bonificacionmorenperiodo numeric,
	noamorvencidas integer,
	saldovencidomernoavencido numeric,
	saldovencidomayoravencido numeric,
	fechaultamorpagada date,
	desctipoprestamo character(30),
	montoprestamo numeric,
	fecha_vencimiento date,
	tantos integer,
	depositogarantia numeric,
	tasanormal numeric,
	tasa_moratoria numeric,
	nombresocio character(82),
	calle character varying(30),
	numero_ext character varying(15),
	colonia character varying(30),
	comunidad character varying(50),
	codpostal integer,
	nombreciudadmex character varying(50),
	ultimoabono date,
	diastraspasoavencida integer,
	ultimoabonointeres date,
	numero_de_amor integer,
	fecha_otorga date,
	descripcionfinalidad character varying(30),
	diasrestantes integer,
	frecuencia numeric,
	interesdevmormenor numeric,
	interesdevmormayor numeric,
	condiciones character varying(30),
	estacion character varying(30),
	dias_cobro integer,
	prestamodescontado character(2),
	estacion1 character varying(30),
	norenovaciones integer,
	clavegarantia character(3),
	monto_garantia numeric,
	interesanterior numeric,
	devengadovigente numeric,
	devengadovencido numeric,
	parte numeric
);


ALTER TYPE public.tcarteracnbv OWNER TO sistema;

--
-- Name: tcarteracobrador; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcarteracobrador AS (
	prestamoid integer,
	referenciaprestamo character varying(18),
	montoprestamo numeric
);


ALTER TYPE public.tcarteracobrador OWNER TO sistema;

--
-- Name: tcarteracrediticia; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcarteracrediticia AS (
	clavesocioint character(15),
	referenciaprestamo character(18),
	ejercicio integer,
	periodo integer,
	fechacierre date,
	diasvencidos integer,
	porcentajeaplicado numeric,
	factoraplicado numeric,
	saldoprestamo numeric,
	reservacalculada numeric,
	interesdevengadomenoravencido numeric,
	interesdevengadomayoravencido numeric,
	pagocapitalenperiodo numeric,
	pagointeresenperiodo numeric,
	pagomoratorioenperiodo numeric,
	bonificacionenperiodo numeric,
	bonificacionmorenperiodo numeric,
	noamorvencidas integer,
	saldovencidomernoavencido numeric,
	saldovencidomayoravencido numeric,
	fechaultamorpagada date,
	desctipoprestamo character(30),
	montoprestamo numeric,
	fecha_vencimiento date,
	tantos integer,
	depositogarantia numeric,
	tasanormal numeric,
	tasa_moratoria numeric,
	nombresocio character(82),
	calle character varying(30),
	numero_ext character varying(15),
	colonia character varying(50),
	comunidad character varying(50),
	codpostal integer,
	nombreciudadmex character varying(50),
	ultimoabono date,
	diastraspasoavencida integer,
	ultimoabonointeres date,
	numero_de_amor integer,
	fecha_otorga date,
	descripcionfinalidad character varying(30),
	diasrestantes integer,
	frecuencia numeric,
	interesdevmormenor numeric,
	interesdevmormayor numeric,
	condiciones character varying(50),
	estacion character varying(30),
	dias_cobro integer,
	prestamodescontado character(2),
	estacion1 character varying(30),
	norenovaciones integer,
	clavegarantia character(3),
	monto_garantia numeric,
	interesanterior numeric,
	devengadovigente numeric,
	devengadovencido numeric,
	primerincumplimiento date,
	fecha_1er_pago date,
	rfc character(16),
	fechavaluaciongarantia date,
	numeroavales integer,
	sujetoidrelacionado integer,
	clasificacioncontable character varying(24),
	tipocobranza character varying(50),
	personajuridica character varying(10),
	reservaidnc numeric,
	diascapital integer,
	diasinteres integer
);


ALTER TYPE public.tcarteracrediticia OWNER TO sistema;

--
-- Name: tcarterafederacion; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcarterafederacion AS (
	sucursal character(4),
	numero_de_socio character varying(15),
	nombre_del_acreditado character varying(82),
	no_de_contrato character varying(18),
	clave_tipoprestamo character varying(3),
	tipo_de_producto character varying(30),
	tipo_de_credito character varying(30),
	fecha_de_otorgamiento date,
	monto_original numeric,
	fecha_de_vencimiento date,
	tasa_ordinaria_nominal_anual numeric,
	tasa_moratoria_nominal_anual numeric,
	no_de_pagos_programados numeric,
	frecuencia integer,
	dias_de_mora integer,
	capital_vigente numeric,
	capital_vencido numeric,
	fecha_cierre date,
	categoria_mora character(10)
);


ALTER TYPE public.tcarterafederacion OWNER TO sistema;

--
-- Name: tcentralriesgo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcentralriesgo AS (
	nombrecaja character varying(80),
	sucid character(4),
	clavesocioint character(15),
	tiposocioid character(20),
	personajuridicaid character(10),
	rfc character(16),
	curp character(20),
	paterno character varying(20),
	materno character varying(20),
	nombre character varying(40),
	fecha_nacimiento date,
	sexo character(15),
	ocupacion character varying(40),
	teldomicilio character varying(20),
	calle character(50),
	numero_ext character varying(15),
	numero_int character varying(15),
	nombrecolonia character varying(50),
	codpostal integer,
	comunidad character varying(50),
	nombreciudadmex character varying(35),
	nombreestadomex character varying(20),
	referenciaprestamo character(18),
	fecha_otorga date,
	montoprestamo numeric,
	desctipoprestamo character(30),
	descripcionedocredito character(30),
	fechaultimopago date,
	saldoprestamo numeric,
	abonosvencidos integer,
	solicitudingresoid integer,
	prestamoid integer,
	nombreconyuge character(80),
	paternoconyugue character(80),
	maternoconyugue character(80),
	rfcconyugue character(16),
	curpconyuge character(20),
	edadconyugue numeric,
	fechanaciconyugue date,
	razonsocialconyugue character(80),
	nombre1 character(80),
	paterno1 character(80),
	materno1 character(80),
	calle1 character(50),
	numero_ext1 character varying(15),
	numero_int1 character varying(15),
	nombrecolonia1 character varying(50),
	codpostal1 integer,
	curp1 character(20),
	rfc1 character(16),
	nombre2 character(80),
	paterno2 character(80),
	materno2 character(80),
	calle2 character(50),
	numero_ext2 character varying(15),
	numero_int2 character varying(15),
	nombrecolonia2 character varying(50),
	codpostal2 integer,
	curp2 character(20),
	rfc2 character(16),
	nombre3 character(80),
	paterno3 character(80),
	materno3 character(80),
	calle3 character(50),
	numero_ext3 character varying(15),
	numero_int3 character varying(15),
	nombrecolonia3 character varying(50),
	codpostal3 integer,
	curp3 character(20),
	rfc3 character(16)
);


ALTER TYPE public.tcentralriesgo OWNER TO sistema;

--
-- Name: tclasificaxbandas; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tclasificaxbandas AS (
	rango character(64),
	nocreditos integer,
	pornocreditos numeric,
	saldo numeric,
	porsaldo numeric,
	intvigente numeric,
	intvencido numeric,
	porrequerido numeric,
	req1 numeric,
	req2 numeric,
	reciprocidad numeric,
	poridnc numeric,
	por2006 numeric
);


ALTER TYPE public.tclasificaxbandas OWNER TO sistema;

--
-- Name: tclasificaxmora; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tclasificaxmora AS (
	rango character(64),
	nocreditos integer,
	pornocreditos numeric,
	saldo numeric,
	porsaldo numeric,
	intvigente numeric,
	intvencido numeric,
	porrequerido numeric,
	req1 numeric,
	req2 numeric
);


ALTER TYPE public.tclasificaxmora OWNER TO sistema;

--
-- Name: tcobrador; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcobrador AS (
	cobradorid integer,
	sujetoid integer,
	paterno character varying(20),
	materno character varying(20),
	nombre character varying(40),
	razonsocial character varying(80)
);


ALTER TYPE public.tcobrador OWNER TO sistema;

--
-- Name: tconcilia; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tconcilia AS (
	fecha date,
	descritipomovibanco character varying(30),
	referenciamovi character(14),
	beneficiario character varying(90),
	debe numeric,
	haber numeric,
	conciliado character(1),
	movibancoid integer
);


ALTER TYPE public.tconcilia OWNER TO sistema;

--
-- Name: tcondonaciones; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tcondonaciones AS (
	usuarioid character(20),
	seriepoliza character(2),
	fechapoliza date,
	socioid integer,
	clavesocioint character(15),
	nombresocio character varying(80),
	grupo character(25),
	referenciaprestamo character(18),
	fecha_otorga date,
	montoprestamo numeric,
	tipoprestamoid character(3),
	diasmora integer,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	ordendeudornormalbonificado numeric,
	ordenacredornormalbonificado numeric,
	ordeninteres numeric,
	intmoranocobact numeric,
	intmoradevnocobres numeric,
	haberes numeric,
	cobradoefectivo numeric,
	claveestadocredito character(3)
);


ALTER TYPE public.tcondonaciones OWNER TO sistema;

--
-- Name: tconspoliza; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tconspoliza AS (
	numero_poliza integer,
	referencia integer
);


ALTER TYPE public.tconspoliza OWNER TO sistema;

--
-- Name: tedobanco; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tedobanco AS (
	fecha date,
	descritipomovibanco character varying(30),
	referenciamovi character(14),
	saldoi numeric,
	debe numeric,
	haber numeric,
	saldof numeric,
	seriepoliza character(2),
	numero_poliza integer,
	tipo_poliza character(1),
	concepto character(50),
	referenciamovipoliza character(8),
	descrimovi character(29),
	idorden integer
);


ALTER TYPE public.tedobanco OWNER TO sistema;

--
-- Name: tinteresdevengadomov; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tinteresdevengadomov AS (
	tipomovimientoid character(2),
	clavesocioint character(18),
	nombresocio character varying(82),
	fecha date,
	interes numeric
);


ALTER TYPE public.tinteresdevengadomov OWNER TO sistema;

--
-- Name: tpolizas; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tpolizas AS (
	polizaid integer,
	numero_poliza integer,
	referencia integer,
	serie character(2),
	fecha date,
	tipo_poliza character(1),
	concepto_poliza character(255)
);


ALTER TYPE public.tpolizas OWNER TO sistema;

--
-- Name: tprecierre; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tprecierre AS (
	clavesocioint character(15),
	referenciaprestamo character(18),
	ejercicio integer,
	periodo integer,
	fechacierre date,
	diasvencidos integer,
	porcentajeaplicado numeric,
	factoraplicado numeric,
	saldoprestamo numeric,
	reservacalculada numeric,
	interesdevengadomenoravencido numeric,
	interesdevengadomayoravencido numeric,
	pagocapitalenperiodo numeric,
	pagointeresenperiodo numeric,
	pagomoratorioenperiodo numeric,
	bonificacionenperiodo numeric,
	bonificacionmorenperiodo numeric,
	noamorvencidas integer,
	saldovencidomernoavencido numeric,
	saldovencidomayoravencido numeric,
	fechaultamorpagada date,
	tipoprestamoid character(3),
	montoprestamo numeric,
	fecha_vencimiento date,
	tantos integer,
	depositogarantia numeric,
	tasanormal numeric,
	tasa_moratoria numeric,
	nombresocio character(82),
	calle character varying(30),
	numero_ext character varying(15),
	colonia character varying(50),
	comunidad character varying(50),
	codpostal integer,
	nombreciudadmex character varying(50),
	ultimoabono date,
	diastraspasoavencida integer,
	ultimoabonointeres date,
	numero_de_amor integer,
	fecha_otorga date,
	descripcionfinalidad character varying(30),
	diasrestantes integer,
	frecuencia numeric,
	interesdevmormenor numeric,
	interesdevmormayor numeric,
	condiciones character varying(50),
	estacion character varying(30),
	dias_cobro integer,
	pagosvencidos integer,
	finalidaddefault character(3),
	saldopromediodelmes numeric,
	interesdevengadomes numeric,
	dias_de_cobro integer,
	meses_de_cobro integer,
	primerincumplimiento date,
	reservaidnc numeric,
	tablareservaid integer
);


ALTER TYPE public.tprecierre OWNER TO sistema;

--
-- Name: treppolizas; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE treppolizas AS (
	polizaid integer,
	referencia integer,
	seriepoliza character(2),
	tipo character(1),
	numero_poliza integer,
	ejercicio integer,
	periodo integer,
	fechapoliza date,
	tipo_poliza character(1),
	clase_poliza character(1),
	diario_agrupador character(3),
	concepto_poliza character varying(255),
	fecha_fin_aceptacion date,
	movipolizaid integer,
	cuentaid character(24),
	referencia_mov character(8),
	tipo_mov character(1),
	debe numeric,
	haber numeric,
	diario_mov character(3),
	identific_descr character(1),
	descripcion character varying(29)
);


ALTER TYPE public.treppolizas OWNER TO sistema;

--
-- Name: tresumencaptacion; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tresumencaptacion AS (
	fechadegeneracion date,
	sucursal character(4),
	desctipoinversion character(30),
	clavesocioint character(18),
	nombresocio character varying(80),
	inversionid integer,
	fechainversion date,
	fechavencimiento date,
	tasainteresnormalinversion numeric,
	plazo integer,
	deposito numeric,
	diasvencimiento integer,
	formapagorendimiento integer,
	intdevmensual numeric,
	intdevacumulado numeric,
	saldototal numeric,
	saldopromedio numeric,
	fechapagoinversion date,
	tipomovimientoid character(2),
	cuentaid character(24),
	localidad integer,
	socioid integer,
	grupo character(25)
);


ALTER TYPE public.tresumencaptacion OWNER TO sistema;

--
-- Name: tsabana; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tsabana AS (
	descripciondenominacion character(10),
	cantidad integer,
	valor numeric
);


ALTER TYPE public.tsabana OWNER TO sistema;

--
-- Name: tsaldosmov; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tsaldosmov AS (
	tipomovimientoid character(2),
	desctipomovimiento character(30),
	saldo numeric
);


ALTER TYPE public.tsaldosmov OWNER TO sistema;

--
-- Name: tscoring; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tscoring AS (
	"no" integer,
	nombre character varying(80),
	montosolicitado numeric,
	genero numeric,
	edad numeric,
	estadocivil numeric,
	tipocasa numeric,
	tiempoendomicilio numeric,
	telefono numeric,
	tiempoennegocio numeric,
	ingresomensual numeric,
	dependienteseconomicos numeric,
	calificacionburo numeric,
	totalscoring numeric,
	avalid integer
);


ALTER TYPE public.tscoring OWNER TO sistema;

--
-- Name: tsociocaja; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE tsociocaja AS (
	socioid integer,
	clavesocioint character(15),
	paterno character varying(20),
	materno character varying(20),
	nombre character varying(40),
	estatus character varying(30)
);


ALTER TYPE public.tsociocaja OWNER TO sistema;

--
-- Name: ttasastipoprestamo; Type: TYPE; Schema: public; Owner: sistema
--

CREATE TYPE ttasastipoprestamo AS (
	tasanormal numeric,
	tasamoratoria numeric
);


ALTER TYPE public.ttasastipoprestamo OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: cartera; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE cartera AS (
	descripcionfinalidad character varying(30),
	desctipoprestamo character(30),
	total numeric,
	menor30 numeric,
	dias1_7 numeric,
	dias8_30 numeric,
	dias31_60 numeric,
	dias61_90 numeric,
	dias91_120 numeric,
	dias121_180 numeric,
	mayor180 numeric
);


ALTER TYPE sucursal1.cartera OWNER TO sistema;

--
-- Name: datoaval; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE datoaval AS (
	nombre character varying,
	domicilio character varying,
	nombreciudadmex character varying(20),
	nombreestadomex character varying(20),
	interes numeric,
	moratorio numeric,
	capital numeric,
	diasint integer,
	montoprestamo numeric,
	fecha_otorga date,
	referenciaprestamo character(18)
);


ALTER TYPE sucursal1.datoaval OWNER TO sistema;

--
-- Name: inversiones; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE inversiones AS (
	clavesocioint character(15),
	nombresocio character varying(80),
	inversionid integer,
	fechainversion date,
	fechavencimiento date,
	tasainteresnormalinversion numeric,
	plazo integer,
	deposito numeric,
	diasvencimiento integer,
	fechapagoanterior date,
	interes numeric
);


ALTER TYPE sucursal1.inversiones OWNER TO sistema;

--
-- Name: movimientos; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE movimientos AS (
	cuentaid character(24),
	serie character(2),
	numero_poliza integer,
	referencia integer,
	fecha date,
	concepto character varying(255),
	saldoinicial numeric,
	debe numeric,
	haber numeric,
	saldofinal numeric
);


ALTER TYPE sucursal1.movimientos OWNER TO sistema;

--
-- Name: prestamoxtipo; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE prestamoxtipo AS (
	essubtotal integer,
	clavesocioint character(15),
	referenciaprestamo character(18),
	montoprestamo numeric,
	saldoprestamo numeric,
	tipoprestamoid character(3),
	fecha_otorga date,
	fecha_vencimiento date,
	nombre character varying(82)
);


ALTER TYPE sucursal1.prestamoxtipo OWNER TO sistema;

--
-- Name: raltasbajas; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE raltasbajas AS (
	clavesocioint character(15),
	nombre character varying(80),
	fechaalta date,
	fechabaja date,
	tipo character(1)
);


ALTER TYPE sucursal1.raltasbajas OWNER TO sistema;

--
-- Name: rantiguedad; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rantiguedad AS (
	menor90 numeric,
	mayor90 numeric
);


ALTER TYPE sucursal1.rantiguedad OWNER TO sistema;

--
-- Name: ravisos; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE ravisos AS (
	avisoid integer,
	tipoavisoid integer,
	prestamoid integer,
	fechaenvio date,
	fechacontestacion date,
	diasatrasoprestamo integer,
	amortizacionesvencidas integer,
	capitalvencido numeric,
	interesvencido numeric,
	observacionaviso text,
	estatusaviso character(1),
	clavesocioint character(15),
	nombresocio character varying(80),
	referenciaprestamo character(18),
	descripciontipoaviso character varying(60)
);


ALTER TYPE sucursal1.ravisos OWNER TO sistema;

--
-- Name: rconsultamov; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rconsultamov AS (
	clavesocioint character(15),
	nombresocio character varying(81),
	saldo1 numeric,
	saldo2 numeric,
	saldo3 numeric,
	saldo4 numeric,
	fecha1 date,
	fecha2 date,
	fecha3 date,
	fecha4 date
);


ALTER TYPE sucursal1.rconsultamov OWNER TO sistema;

--
-- Name: rconvenios; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rconvenios AS (
	clavesocioint character(15),
	referenciaprestamo character(18),
	nombre character(80),
	usuarioid character(20),
	fechaconvenio date,
	lugar character(7)
);


ALTER TYPE sucursal1.rconvenios OWNER TO sistema;

--
-- Name: rcortecaja; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rcortecaja AS (
	folio integer,
	referencia integer,
	serie character(2),
	socioid integer,
	clavesocioint character(15),
	fecha date,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	deposito numeric,
	retiro numeric,
	tipomovimientoid character(2),
	tipoprestamoid character(2)
);


ALTER TYPE sucursal1.rcortecaja OWNER TO sistema;

--
-- Name: redocta; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE redocta AS (
	numamortizacion integer,
	fechadepago date,
	ultimoabono date,
	importeamortizacion numeric,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	total numeric
);


ALTER TYPE sucursal1.redocta OWNER TO sistema;

--
-- Name: restadisticoctas; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE restadisticoctas AS (
	tipo character(3),
	descripcion character(30),
	nosocios integer,
	saldo numeric,
	ordenmov character(1)
);


ALTER TYPE sucursal1.restadisticoctas OWNER TO sistema;

--
-- Name: restadocta; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE restadocta AS (
	fecha date,
	serie character(2),
	nopoliza integer,
	referenciacaja integer,
	monto_prestamo numeric,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	total numeric
);


ALTER TYPE sucursal1.restadocta OWNER TO sistema;

--
-- Name: resumenprestamos; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE resumenprestamos AS (
	sucursal character(4),
	descripcionfinalidad character varying(30),
	referenciaprestamo character(18),
	clavesocioint character(15),
	nombresocio character varying(82),
	fechacierre date,
	saldovencidomenoravencido numeric,
	saldovencidomayoravencido numeric,
	interesdevengadomenoravencido numeric,
	interesdevengadomayoravencido numeric,
	montoprestamo numeric,
	tasanormal numeric,
	numero_de_amor integer,
	fecha_otorga date,
	fecha_vencimiento date,
	ultimoabono date,
	tantos numeric,
	diasmora integer,
	diasporvencer integer
);


ALTER TYPE sucursal1.resumenprestamos OWNER TO sistema;

--
-- Name: ringresoegreso; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE ringresoegreso AS (
	orden character(1),
	cuentaid character(24),
	cuentacaja character(24),
	cuentanombre character(50),
	debe numeric,
	haber numeric
);


ALTER TYPE sucursal1.ringresoegreso OWNER TO sistema;

--
-- Name: rinversiontipo; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rinversiontipo AS (
	clavesocioint character(15),
	referenciainversion integer,
	nombre character varying(80),
	fechainversion date,
	fechavencimiento date,
	depositoinversion numeric,
	tasainteresnormalinversion numeric,
	interes numeric,
	isr numeric
);


ALTER TYPE sucursal1.rinversiontipo OWNER TO sistema;

--
-- Name: rlibromayor; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rlibromayor AS (
	cuentaid character(24),
	cuentanombre character(50),
	periodo integer,
	cargosm numeric,
	abonosm numeric,
	saldo numeric,
	cargosa numeric,
	abonosa numeric
);


ALTER TYPE sucursal1.rlibromayor OWNER TO sistema;

--
-- Name: rmovicaja; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rmovicaja AS (
	movicajaid integer,
	socioid integer,
	tipomovimientoid character(2),
	polizaid integer,
	referenciacaja integer,
	seriecaja character(2),
	movipolizaid integer,
	prestamoid integer,
	estatusmovicaja character(1),
	inversionid integer,
	debe numeric,
	haber numeric
);


ALTER TYPE sucursal1.rmovicaja OWNER TO sistema;

--
-- Name: rmovicaja00; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rmovicaja00 AS (
	movicajaid integer,
	socioid integer,
	tipomovimientoid character(2),
	polizaid integer,
	referenciacaja integer,
	seriecaja character(2),
	movipolizaid integer,
	prestamoid integer,
	estatusmovicaja character(1),
	inversionid integer,
	debe numeric,
	haber numeric,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric
);


ALTER TYPE sucursal1.rmovicaja00 OWNER TO sistema;

--
-- Name: rmovimientoscaja; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rmovimientoscaja AS (
	fechapoliza date,
	seriepoliza character(2),
	numero_poliza integer,
	seriecaja character(2),
	referenciacaja integer,
	desctipomovimiento character(30),
	refmovimiento character(30),
	debe numeric,
	haber numeric,
	tipomovimientoid character(3),
	movicajaid integer
);


ALTER TYPE sucursal1.rmovimientoscaja OWNER TO sistema;

--
-- Name: rmovimientosxfecha; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rmovimientosxfecha AS (
	clavesocioint character(15),
	nombre character varying(80),
	depaa numeric,
	retaa numeric,
	depdv numeric,
	retdv numeric,
	depin numeric,
	retin numeric
);


ALTER TYPE sucursal1.rmovimientosxfecha OWNER TO sistema;

--
-- Name: rpagoprocampo; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rpagoprocampo AS (
	referenciaprestamo character(18),
	nombresocio character varying(80),
	montoprestamo numeric,
	fechaultimopago date
);


ALTER TYPE sucursal1.rpagoprocampo OWNER TO sistema;

--
-- Name: rpavisos; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rpavisos AS (
	clavesocioint character(15),
	nombre character varying(80),
	tipoprestamoid character(3),
	descripciontipoaviso character(60),
	fechaultimoabono date,
	capitalvencido numeric,
	interesvencido numeric,
	saldoprestamo numeric,
	fechaenvio date,
	prestamoid integer
);


ALTER TYPE sucursal1.rpavisos OWNER TO sistema;

--
-- Name: rpermisomodulo; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rpermisomodulo AS (
	permisomoduloid integer,
	clavemodulo character(10),
	usuarioid character(20),
	permiso character(1),
	descripcionmodulos character(80)
);


ALTER TYPE sucursal1.rpermisomodulo OWNER TO sistema;

--
-- Name: rprestamossocio; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rprestamossocio AS (
	refererenciaprestamo character(18),
	fecha_otorga date,
	clavesocioint character(15),
	montoprestamo numeric,
	descripcionedocredito character varying(30)
);


ALTER TYPE sucursal1.rprestamossocio OWNER TO sistema;

--
-- Name: rptmovibanco; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rptmovibanco AS (
	consecutivo integer,
	fechapoliza date,
	referenciamovi character(14),
	descritipomovibanco character(30),
	beneficiario character(45),
	debe numeric,
	haber numeric,
	serie character(2)
);


ALTER TYPE sucursal1.rptmovibanco OWNER TO sistema;

--
-- Name: rptprestamo; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rptprestamo AS (
	referenciaprestamo character(18),
	clavesocioint character(15),
	monto_prestamo numeric,
	saldo_prestamo numeric,
	fecha_otorga date,
	fecha_vencimiento date,
	tasa_normal numeric,
	tasa_moratoria numeric,
	descripcionedocredito character varying(30),
	usuarioid character(20)
);


ALTER TYPE sucursal1.rptprestamo OWNER TO sistema;

--
-- Name: rptsaldosxfecha; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rptsaldosxfecha AS (
	tipomovimientoid character(2),
	desctipomovimiento character(30),
	saldoinicial numeric,
	depositos numeric,
	retiros numeric,
	saldofinal numeric
);


ALTER TYPE sucursal1.rptsaldosxfecha OWNER TO sistema;

--
-- Name: rptxtipomovimiento; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rptxtipomovimiento AS (
	tipomovimientoid character(2),
	serie character(2),
	referencia integer,
	numero_poliza integer,
	fecha date,
	saldoinicial numeric,
	depositos numeric,
	retiros numeric,
	interes numeric,
	saldofinal numeric
);


ALTER TYPE sucursal1.rptxtipomovimiento OWNER TO sistema;

--
-- Name: rrecupera; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rrecupera AS (
	referenciaprestamo character(18),
	clavesocioint character(15),
	nombresocio character varying(80),
	montoprestamo numeric,
	tipoprestamoid character(3),
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric
);


ALTER TYPE sucursal1.rrecupera OWNER TO sistema;

--
-- Name: rsaldofechacorte; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rsaldofechacorte AS (
	prestamoid integer,
	clavesocioint character(15),
	referenciaprestamo character(18),
	nombre character varying(80),
	fecha_otorga date,
	fecha_vencimiento date,
	montoprestamo numeric,
	saldoprest numeric,
	diasatraso numeric,
	amortizacion numeric,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	vencidas numeric
);


ALTER TYPE sucursal1.rsaldofechacorte OWNER TO sistema;

--
-- Name: rsaldos; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE rsaldos AS (
	tipor integer,
	referenciaprestamo character(18),
	clavesocioint character(15),
	nombresocio character varying(80),
	fecha_otorga date,
	montoprestamo numeric,
	saldoprestamo numeric,
	desctipoprestamo character(30),
	tipoprestamoid character(3)
);


ALTER TYPE sucursal1.rsaldos OWNER TO sistema;

--
-- Name: sdomovsocio; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE sdomovsocio AS (
	tiposocio integer,
	clavesocioint character(15),
	nombre character varying(80),
	ultimomovimiento date,
	saldo numeric
);


ALTER TYPE sucursal1.sdomovsocio OWNER TO sistema;

--
-- Name: socioactivo; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE socioactivo AS (
	clavesocioint character(15),
	nombre character varying(80),
	direccion character varying(145),
	estatus integer
);


ALTER TYPE sucursal1.socioactivo OWNER TO sistema;

--
-- Name: socioxtipo; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE socioxtipo AS (
	clavesocioint character(15),
	nombre character varying(80),
	direccion character varying(100),
	colonia character varying(30),
	cp integer,
	comunidad character varying(50),
	nombreciudadmex character varying(20),
	partesocial numeric,
	tiposocioid character(2),
	estatus integer
);


ALTER TYPE sucursal1.socioxtipo OWNER TO sistema;

--
-- Name: tablaamor; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE tablaamor AS (
	numamortizacion integer,
	fechadepago date,
	tasainteres numeric,
	importeamortizacion numeric,
	interesnormal numeric,
	iva numeric,
	saldo_absoluto numeric,
	pagototal numeric
);


ALTER TYPE sucursal1.tablaamor OWNER TO sistema;

--
-- Name: tcalculopago; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE tcalculopago AS (
	prestamoid integer,
	amortizacion numeric,
	vencidas numeric,
	diasint integer,
	capital numeric,
	interes numeric,
	moratorio numeric,
	iva numeric,
	total numeric
);


ALTER TYPE sucursal1.tcalculopago OWNER TO sistema;

--
-- Name: tconspoliza; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE tconspoliza AS (
	numero_poliza integer,
	referencia integer
);


ALTER TYPE sucursal1.tconspoliza OWNER TO sistema;

--
-- Name: tedobanco; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE tedobanco AS (
	fecha date,
	descritipomovibanco character varying(30),
	referenciamovi character(14),
	saldoi numeric,
	debe numeric,
	haber numeric,
	saldof numeric,
	seriepoliza character(2),
	numero_poliza integer,
	tipo_poliza character(1),
	concepto character(50)
);


ALTER TYPE sucursal1.tedobanco OWNER TO sistema;

--
-- Name: tinteresdevengadomov; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE tinteresdevengadomov AS (
	tipomovimientoid character(2),
	clavesocioint character(18),
	nombresocio character varying(82),
	fecha date,
	interes numeric
);


ALTER TYPE sucursal1.tinteresdevengadomov OWNER TO sistema;

--
-- Name: tpolizas; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE tpolizas AS (
	polizaid integer,
	numero_poliza integer,
	referencia integer,
	serie character(2),
	fecha date,
	tipo_poliza character(1),
	concepto_poliza character(255)
);


ALTER TYPE sucursal1.tpolizas OWNER TO sistema;

--
-- Name: treppolizas; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE treppolizas AS (
	polizaid integer,
	referencia integer,
	seriepoliza character(2),
	tipo character(1),
	numero_poliza integer,
	ejercicio integer,
	periodo integer,
	fechapoliza date,
	tipo_poliza character(1),
	clase_poliza character(1),
	diario_agrupador character(3),
	concepto_poliza character varying(255),
	fecha_fin_aceptacion date,
	movipolizaid integer,
	cuentaid character(24),
	referencia_mov character(8),
	tipo_mov character(1),
	debe numeric,
	haber numeric,
	diario_mov character(3),
	identific_descr character(1),
	descripcion character varying(29)
);


ALTER TYPE sucursal1.treppolizas OWNER TO sistema;

--
-- Name: tresumencaptacion; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE tresumencaptacion AS (
	sucursal character(4),
	desctipoinversion character(30),
	clavesocioint character(18),
	nombresocio character varying(80),
	inversionid integer,
	fechainversion date,
	fechavencimiento date,
	tasainteresnormalinversion numeric,
	plazo integer,
	deposito numeric,
	diasvencimiento integer
);


ALTER TYPE sucursal1.tresumencaptacion OWNER TO sistema;

--
-- Name: tsabana; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE tsabana AS (
	descripciondenominacion character(10),
	cantidad integer,
	valor numeric
);


ALTER TYPE sucursal1.tsabana OWNER TO sistema;

--
-- Name: tsaldosmov; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE tsaldosmov AS (
	tipomovimientoid character(2),
	desctipomovimiento character(30),
	saldo numeric
);


ALTER TYPE sucursal1.tsaldosmov OWNER TO sistema;

--
-- Name: tsociocaja; Type: TYPE; Schema: sucursal1; Owner: sistema
--

CREATE TYPE tsociocaja AS (
	socioid integer,
	clavesocioint character(15),
	paterno character varying(20),
	materno character varying(20),
	nombre character varying(40),
	estatus character varying(30)
);


ALTER TYPE sucursal1.tsociocaja OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: ajustecatalogo(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION ajustecatalogo() RETURNS integer
    AS $$
declare

  largo integer;
  r record;
  scat_cuentaid char(24);
  vcuentaid char(24);
  vcat_cuentaid char(24);
  vcuentaini char(1);

begin

--
-- Actualizamos todas las tablas
--
-- Catalogo de cuentas



for r in select cuentaid,cat_cuentaid from catalogo_ctas where substring(cuentaid,2,1) <> '-'

   loop

      largo:= char_length(rtrim(r.cuentaid))-2;

      if largo > 2 then 
         scat_cuentaid:=substring(r.cuentaid,1,largo);
        
         update catalogo_ctas set cat_cuentaid=scat_cuentaid where cuentaid=r.cuentaid and scat_cuentaid in (select cuentaid from catalogo_ctas where cuentaid=scat_cuentaid);
         raise notice ' L %  cuentaid % cat_cuentaid  % ',largo,r.cuentaid,scat_cuentaid;
      else

        raise notice ' Menos L %  cuentaid % cat_cuentaid  % ',largo,r.cuentaid,scat_cuentaid;
        --update catalogo_ctas set cat_cuentaid=null,tipo_cta='C' where cuentaid=r.cuentaid;

      end if;

   end loop;


return 1;
end
$$
    LANGUAGE plpgsql;


ALTER FUNCTION public.ajustecatalogo() OWNER TO sistema;

--
-- Name: ajustecatalogocresur(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION ajustecatalogocresur() RETURNS integer
    AS $$
declare

  largo integer;
  r record;
  scuentaidini char(1);
  vcuentaid1 char(24);
  vcuentaid2 char(24);
  icambiacuentacatalogo integer;

begin

--
-- Actualizamos todas las tablas
--
-- Catalogo de cuentas

for r in select cuentaid,cat_cuentaid from catalogo_ctas where substring(cuentaid,1,1) >  '2' order by cuentaid

   loop

      scuentaidini:=substring(r.cuentaid,1,1);

      if scuentaidini='3' then

        vcuentaid2:='4'||substring(r.cuentaid,2,23);

      end if;

      if scuentaidini='4' then

        vcuentaid2:='5'||substring(r.cuentaid,2,23);

      end if;

      if scuentaidini='5' then

        vcuentaid2:='6'||substring(r.cuentaid,2,23);

      end if;

      if scuentaidini='6' then

        vcuentaid2:='7'||substring(r.cuentaid,2,23);

      end if;

      if scuentaidini='7' then

        vcuentaid2:='8'||substring(r.cuentaid,2,23);

      end if;

      select cambiacuentacatalogo into icambiacuentacatalogo from cambiacuentacatalogo(r.cuentaid,vcuentaid2);

      raise notice ' cuentaid %  cuentaid 2  % ',r.cuentaid,vcuentaid2;
       
   end loop;

return 1;
end
$$
    LANGUAGE plpgsql;


ALTER FUNCTION public.ajustecatalogocresur() OWNER TO sistema;

--
-- Name: alinea(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION alinea(text) RETURNS text
    AS $_$
declare
ptext alias for $1;
plargo int4;
ptext1 text;

begin

  plargo:= char_length(ptext);
  ptext1:= ptext;
  while plargo < 38 loop 
        ptext1:=ptext1||' ';
        plargo:=plargo+1;
  end loop;
  return ptext1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.alinea(text) OWNER TO sistema;

--
-- Name: alineacero(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION alineacero(text) RETURNS text
    AS $_$
declare
ptext alias for $1;
plargo int4;
ptext1 text;

begin

  plargo:= char_length(ptext);
  ptext1:= ptext;
  while plargo < 8 loop 
        ptext1:='0'||ptext1;
        plargo:=plargo+1;
  end loop;
  return ptext1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.alineacero(text) OWNER TO sistema;

--
-- Name: alineap(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION alineap(text) RETURNS text
    AS $_$
declare
ptext alias for $1;
plargo int4;
ptext1 text;

begin

  plargo:= char_length(ptext);
  ptext1:= ptext;
  while plargo < 58 loop 
        ptext1:=ptext1||' ';
        plargo:=plargo+1;
  end loop;
  return ptext1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.alineap(text) OWNER TO sistema;

--
-- Name: alineap1(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION alineap1(text) RETURNS text
    AS $_$
declare
ptext alias for $1;
plargo int4;
ptext1 text;

begin

  plargo:= char_length(ptext);
  ptext1:= ptext;
  while plargo < 31 loop 
        ptext1:=ptext1||' ';
        plargo:=plargo+1;
  end loop;
  return ptext1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.alineap1(text) OWNER TO sistema;

--
-- Name: alineap2(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION alineap2(text) RETURNS text
    AS $_$
declare
ptext alias for $1;
plargo int4;
ptext1 text;

begin

  plargo:= char_length(ptext);
  ptext1:= ptext;
  while plargo < 16 loop 
        ptext1:=ptext1||' ';
        plargo:=plargo+1;
  end loop;
  return ptext1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.alineap2(text) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

SET default_tablespace = '';

SET default_with_oids = false;

--
-- Name: prestamos; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE prestamos (
    prestamoid integer NOT NULL,
    tipoprestamoid character(3) NOT NULL,
    socioid integer NOT NULL,
    clavegarantia character(3) NOT NULL,
    claveestadocredito character(3) NOT NULL,
    usuarioid character(20) NOT NULL,
    clavefinalidad character(3) NOT NULL,
    calculonormalid integer NOT NULL,
    calculomoratorioid integer NOT NULL,
    referenciaprestamo character(18) NOT NULL,
    montoprestamo numeric NOT NULL,
    saldoprestamo numeric NOT NULL,
    numero_de_amor integer NOT NULL,
    fecha_otorga date NOT NULL,
    fecha_vencimiento date NOT NULL,
    tasanormal numeric NOT NULL,
    tasa_moratoria numeric NOT NULL,
    dias_de_cobro integer NOT NULL,
    meses_de_cobro integer NOT NULL,
    dia_mes_cobro integer NOT NULL,
    fecha_1er_pago date NOT NULL,
    monto_garantia numeric NOT NULL,
    fechaultimopago date NOT NULL,
    solicitudprestamoid integer,
    norenovaciones integer,
    formalizado integer,
    condicionid integer,
    clasificacioncreditoid integer DEFAULT 1,
    sujetoid integer,
    tipoacreditadoid integer,
    fechavaluaciongarantia date,
    prestamodescontado character(2) DEFAULT 'NO'::bpchar,
    comision numeric,
    tipocobrocomision integer,
    ahorrocompromiso numeric,
    interesanticipado integer,
    porcentajeredescuento numeric,
    autorizacionburo character(20)
);


ALTER TABLE sucursal1.prestamos OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: allprestamos(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION allprestamos(integer) RETURNS SETOF sucursal1.prestamos
    AS $_$
declare
  r prestamos%rowtype;
  psocioid alias for $1;
begin

    for r in
      select * from prestamos
       where socioid=psocioid and tipoprestamoid<>'P4'
    order by fecha_otorga
    loop
      r.tasanormal:=tasareciprocidad(r.prestamoid);
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.allprestamos(integer) OWNER TO sistema;

--
-- Name: altasbajas(date, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION altasbajas(date, date, character) RETURNS SETOF raltasbajas
    AS $_$
declare
 
 pfechai alias for $1;
 pfechaf alias for $2;
 ptiposocioid alias for $3;
 r raltasbajas%rowtype;

begin

  update socio
     set fechabaja = NULL
   where fechabaja='1900-01-01' or
         fechabaja=fechaalta;

  for r in
    select s.clavesocioint,
           su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
           s.fechaalta,s.fechabaja,
           'A' as tipo
      from socio s,sujeto su
     where (s.fechaalta between pfechai and pfechaf) and
           (s.fechabaja is null or s.fechabaja>s.fechaalta) and
           (ptiposocioid='  ' or s.tiposocioid=ptiposocioid) and
            su.sujetoid = s.sujetoid
   order by s.fechabaja,s.fechaalta         
  loop
    return next r;
  end loop;


  for r in
    select s.clavesocioint,
           su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
           s.fechaalta,s.fechabaja,
           'B' as tipo
      from socio s,sujeto su
     where (s.fechabaja between pfechai and pfechaf) and
           (ptiposocioid='  ' or s.tiposocioid=ptiposocioid) and
            su.sujetoid = s.sujetoid
   order by s.fechabaja,s.fechaalta         
  loop
    return next r;
  end loop;


  for r in
    select s.clavesocioint,
           su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
           s.fechaalta,s.fechabaja,
           'R' as tipo
      from socio s,sujeto su
     where (s.fechaalta between pfechai and pfechaf) and
           (s.fechabaja is not null and s.fechabaja<=s.fechaalta) and
           (ptiposocioid='  ' or s.tiposocioid=ptiposocioid) and
            su.sujetoid = s.sujetoid
   order by s.fechabaja,s.fechaalta         
  loop
    return next r;
  end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.altasbajas(date, date, character) OWNER TO sistema;

--
-- Name: amormaxmin(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION amormaxmin(integer) RETURNS SETOF primer
    AS $_$
declare
  pnosolicitud  alias for $1;
  pmonto  numeric;
  pprimerpago date;
  ptipoprestamoid char(3);
  pabonos    int;
  pdiaprimer   int;
  presultado date;
  amor1 numeric;
  amor2 numeric;
  ptasanormal numeric;
  res primer%rowtype;
  pdias_de_cobro integer;
  pmeses_de_cobro integer;
  pdia_mes_cobro integer;

begin

select montosolicitado, primerpago, tipoprestamoid, abonospropuestos, fecharesultado,dias_de_cobro,meses_de_cobro,dia_mes_cobro 
       into pmonto, pprimerpago, ptipoprestamoid, pabonos, presultado,pdias_de_cobro,pmeses_de_cobro,pdia_mes_cobro
       from solicitudprestamo 
       where nosolicitud = pnosolicitud;

 select tasa_normal into ptasanormal from tipoprestamo where tipoprestamoid=ptipoprestamoid;
       
 pdiaprimer:=cast(substring((pprimerpago),9) as int);

 select min(importeamortizacion),max(importeamortizacion) into amor1, amor2 
 from sptablaamor(pmonto,pprimerpago,ptipoprestamoid,pabonos,pdias_de_cobro,pmeses_de_cobro,pdia_mes_cobro,presultado,ptasanormal);

 res.primer = amor1;
 res.ultimo = amor2;
 return next res;

return; 
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.amormaxmin(integer) OWNER TO sistema;

--
-- Name: analisiscartera(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION analisiscartera(date) RETURNS SETOF tanalisiscartera
    AS $_$
declare
  pfechacierre alias for $1;

  r tanalisiscartera%rowtype;
  fechaprecorte  date;

begin

fechaprecorte:=pfechacierre-cast(date_part('day',pfechacierre) as int);

raise notice ' Fecha Inicial:  %  ',fechaprecorte;

for r in
select
p.prestamoid,
s.clavesocioint,
substring(su.nombre||' '||su.paterno||' '||su.materno,1,119) as nombre,
p.referenciaprestamo,
p.fecha_otorga,
p.montoprestamo,
(case when (pfechacierre-fechaultimapagada(p.prestamoid,pfechacierre))-(case when p.dias_de_cobro > 0 then p.dias_de_cobro else p.meses_de_cobro*30 end) > 0 then (pfechacierre-fechaultimapagada(p.prestamoid,pfechacierre))-(case when p.dias_de_cobro > 0 then p.dias_de_cobro else p.meses_de_cobro*30 end) else 0 end) as dias,
--Categoria_mora
'' as cat_mora,
--saldo_prestamo,
0 as saldo_prestamo,
fechaprecorte as fecha_precorte,
--Categoria_mora2
'' as categoria_mora2,
--saldo_prestamo2
p.montoprestamo-sum(m.haber) as saldo_prestamo2,
pfechacierre as fecha_cierre,
--Sucursal char(4)
(select sucid from empresa where empresaid=1),
tp.desctipoprestamo,
--dias_mora_precierre
0

from prestamos p, tipoprestamo tp,(select prestamoid,polizaid from movicaja union select prestamoid,polizaid from movibanco) as mc, movipolizas m, polizas po, socio s, sujeto su
 where p.fecha_otorga <= pfechacierre and p.claveestadocredito<>'008' and  
       tp.tipoprestamoid = p.tipoprestamoid and
       mc.prestamoid = p.prestamoid and
       m.polizaid = mc.polizaid and
       po.polizaid = mc.polizaid
       and m.cuentaid = tp.cuentaactivo and po.fechapoliza <= pfechacierre
       and p.socioid=s.socioid and s.sujetoid = su.sujetoid
group by p.prestamoid, p.tipoprestamoid,p.montoprestamo,p.fecha_otorga,p.dias_de_cobro,p.meses_de_cobro,
       p.clavefinalidad,p.fecha_vencimiento,p.referenciaprestamo,p.tasanormal,p.tasa_moratoria,p.socioid,s.clavesocioint,su.sujetoid,su.nombre,su.paterno,su.materno,tp.desctipoprestamo
having p.montoprestamo-sum(m.haber) > 0 order by s.clavesocioint
       
loop 

   select (case when diasvencidos = 0 then 'B.VIGENTE' else
   (case when diasvencidos > 0 and diasvencidos <= 89 then 'C.MOROSA' else
   (case when diasvencidos > 89  then 'D.VENCIDA' end) end) end),saldoprestamo,diasvencidos into r.categoria_mora_precierre,r.saldo_prestamo_precierre,r.dias_mora_precierre from precorte where prestamoid=r.prestamoid and fechacierre=fechaprecorte;
   if not found then r.categoria_mora_precierre:='A.NUEVA';

   end if;
   
   if r.dias_mora =0 then
     r.categoria_mora_actual:='B.VIGENTE';
     if  r.categoria_mora_precierre='A.NUEVA' then 
        r.categoria_mora_actual:='A.NUEVA';
     end if;
   else
       if r.dias_mora > 0 and r.dias_mora < 90 then
          r.categoria_mora_actual:='C.MOROSA';

       else 
           if r.dias_mora > 89 then
              r.categoria_mora_actual:='D.VENCIDA';

           end if;
       end if;

   end if;

   select paterno||' '||materno||' '||nombre into r.cobrador from sujeto where sujetoid = (select sujetoid from cobradores natural join carteracobrador where prestamoid=r.prestamoid group by sujetoid);
   
return next r;

end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.analisiscartera(date) OWNER TO sistema;

--
-- Name: antiguedad(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION antiguedad(integer, integer) RETURNS SETOF rantiguedad
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo   alias for $2;
  r rantiguedad%rowtype;
begin

  for r in
    select sum(case when c.fecha_vencimiento-c.fechacierre<91
                    then c.saldoprestamo else 0 end),
           sum(case when c.fecha_vencimiento-c.fechacierre>90
                    then c.saldoprestamo else 0 end)
      from precorte c
     where c.ejercicio=pejercicio and c.periodo=pperiodo
  loop
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.antiguedad(integer, integer) OWNER TO sistema;

--
-- Name: antiguedadc(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION antiguedadc(integer, integer) RETURNS SETOF rantiguedad
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo   alias for $2;
  r rantiguedad%rowtype;
  fmenor90 numeric;
  fmayor90 numeric;
  f record;
  dblink1 text;
  dblink2 text;

begin

  fmenor90:=0;
  fmayor90:=0;


for f in
 select * from sucursales where vigente='S'
 loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='select sum(case when c.fecha_vencimiento-c.fechacierre<91
                    then c.saldoprestamo else 0 end),
           sum(case when c.fecha_vencimiento-c.fechacierre>90
                    then c.saldoprestamo else 0 end)
      from '||f.esquema||'.precorte c
     where c.ejercicio='||to_char(pejercicio,'9999')||' and c.periodo='||to_char(pperiodo,'99');

        for r in
        SELECT * FROM
        dblink(dblink1,dblink2) as t2(menor90 numeric,mayor90 numeric)

  loop
    fmenor90:=fmenor90+coalesce(r.menor90,0);
    fmayor90:=fmayor90+coalesce(r.mayor90,0);
  end loop;


  end loop;

  r.menor90:=fmenor90;
  r.mayor90:=fmayor90;

  return next r;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.antiguedadc(integer, integer) OWNER TO sistema;

--
-- Name: aplicaamortizaciones(character, numeric, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION aplicaamortizaciones(character, numeric, date) RETURNS integer
    AS $_$
declare
 
  preferenciaprestamo alias for $1;
  pabono alias for $2;
  pultimopago alias for $3;
  x record;
  r tablaamor%rowtype;
  amor amortizaciones%rowtype;

  lamortizacionid int4;
  fAbono numeric;
  fAplicar numeric;
  pprestamoid int4;

  fsaldo_absoluto numeric;
begin

  select prestamoid,montoprestamo
    into pprestamoid,fsaldo_absoluto
    from prestamos where referenciaprestamo=preferenciaprestamo;

-- Quitar las aplicaciones para realizarlas de nuevo

  update amortizaciones set abonopagado=0 where prestamoid=pprestamoid;

-- Aplicar el abono correspondiente
 if pabono>0 then
    fAbono := pabono;
    --select prestamoid into pprestamoid from prestamos where referenciaprestamo=preferenciaprestamo;
    for amor in
        select *
          from amortizaciones
         where prestamoid=pprestamoid and importeamortizacion-abonopagado>0
      order by fechadepago
    loop

      fAplicar := amor.importeamortizacion - amor.abonopagado;

      fsaldo_absoluto:=fsaldo_absoluto-amor.importeamortizacion;
      update amortizaciones
         set saldo_absoluto=fsaldo_absoluto
       where amortizacionid=amor.amortizacionid;

      if fAbono>=fAplicar then
        update amortizaciones
           set abonopagado = importeamortizacion,
               ultimoabono = pultimopago,
               claveestadocredito = '002'
         where amortizacionid=amor.amortizacionid;
         fAbono := fAbono - fAplicar;
      else
        if fAbono>0 then
          update amortizaciones
             set abonopagado = abonopagado+fAbono,
                 ultimoabono = pultimopago
           where amortizacionid=amor.amortizacionid;
           fAbono := 0;
        end if;
      end if;
    end loop;
  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.aplicaamortizaciones(character, numeric, date) OWNER TO sistema;

--
-- Name: aplicacapitalpagado(integer, numeric, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION aplicacapitalpagado(integer, numeric, date) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;
  ppagado alias for $2;
  pfechapago alias for $3;

  amor  record;
  fpagado numeric;  
  dfechapoliza date;

begin

  dfechapoliza:=pfechapago;
  fpagado:=ppagado;

  raise notice ' Pago Capital % prestamoid %',fpagado,pprestamoid;

    if fpagado > 0 then
      for amor in 
        select *
          from amortizaciones
         where prestamoid=pprestamoid and importeamortizacion > abonopagado
      order by fechadepago
      loop

        if fpagado > amor.importeamortizacion then
          update amortizaciones set abonopagado=amor.importeamortizacion ,ultimoabono = dfechapoliza
          where amortizacionid=amor.amortizacionid;
          fpagado:=fpagado-(amor.importeamortizacion-amor.abonopagado) ;
          raise notice ' pagado %  % ',fpagado,amor.amortizacionid;
        else
          if fpagado > 0 then
            update amortizaciones set abonopagado=(fpagado+amor.abonopagado), ultimoabono = dfechapoliza
            where amortizacionid=amor.amortizacionid;
            raise notice ' pagado %  % ',fpagado,amor.amortizacionid;
            fpagado:=0;
          end if;
        end if;
      end loop;
    end if;

  return fpagado;

end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.aplicacapitalpagado(integer, numeric, date) OWNER TO sistema;

--
-- Name: aplicafechaamortizaciones(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION aplicafechaamortizaciones(integer) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;
  r record;
  amor  record;
  r1 record;
  fpagado numeric;
  fmontoprestamo numeric;
  finteresnormal numeric;
  fiva numeric;
  ftotalpago numeric;
  dfechaotorga date;
  gdiasanualesprestamo int4;
  iprestamoid int4;
  fAbono numeric;
  fAplicar numeric;
  ftasanormal numeric;
  saplicaiva char(1);
  pultimopago date;

begin

  raise notice ' prestamoid % ',pprestamoid;

  select diasanualesprestamo into gdiasanualesprestamo from empresa where empresaid=1;

  select a.montoprestamo,a.fecha_otorga,a.tasanormal,e.aplicaivaprestamo into fmontoprestamo,dfechaotorga,ftasanormal,saplicaiva from prestamos a, tipoprestamo e where a.prestamoid=pprestamoid and a.tipoprestamoid=e.tipoprestamoid;

  for r1 in select * from amortizaciones where prestamoid = pprestamoid order by fechadepago
    loop

      finteresnormal := round(fmontoprestamo*(r1.fechadepago-dfechaotorga)*ftasanormal/100/gdiasanualesprestamo,0);

      if saplicaiva='S' then
  
         fiva:=finteresnormal * .15;
      else
 
         fiva:= 0;
      end if;

      ftotalpago:=finteresnormal + fiva;

      fmontoprestamo:=fmontoprestamo-r1.importeamortizacion;
      dfechaotorga:=r1.fechadepago;

      update amortizaciones set interesnormal=finteresnormal,iva=fiva,totalpago=ftotalpago,abonopagado=0 where amortizacionid=r1.amortizacionid;


  end loop;

  fpagado:=0;
  iprestamoid:=0;

  for r in select a.montoprestamo,a.fecha_otorga,a.prestamoid,a.tasanormal,c.fechapoliza,d.haber,e.aplicaivaprestamo from prestamos a, movicaja b, polizas c, movipolizas d, tipoprestamo e where a.prestamoid=pprestamoid and a.prestamoid=b.prestamoid and b.polizaid=c.polizaid and b.polizaid=d.polizaid and a.tipoprestamoid=e.tipoprestamoid and d.cuentaid=e.cuentaactivo and d.haber <> 0 order by c.fechapoliza

  loop

     fmontoprestamo:=r.montoprestamo;
     dfechaotorga:=r.fecha_otorga;
     fpagado := fpagado+r.haber;

     raise notice ' prestamoid % fpagado %  fecha % ', r.prestamoid,fpagado,r.fechapoliza ;

     if iprestamoid=0 then
       
     end if;

     select aplicacapitalpagado into fpagado from aplicacapitalpagado(pprestamoid,fpagado,r.fechapoliza);
   
  end loop;

return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.aplicafechaamortizaciones(integer) OWNER TO sistema;

--
-- Name: aplicaide(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION aplicaide(character) RETURNS integer
    AS $_$
declare
 pstipomovimientoid alias for $1;

 iaplica int4;

begin

 iaplica:=0;

 if pstipomovimientoid in ('PA','AM','AF','AA','AI','AO','IN','AP') then
   iaplica:=1;
 end if;

return iaplica;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.aplicaide(character) OWNER TO sistema;

--
-- Name: aplicareserva(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION aplicareserva() RETURNS numeric
    AS $$ 
DECLARE

r record;

BEGIN

  for r in
     select p.precorteid,t.porcentajereserva,
            p.saldoprestamo*t.porcentajereserva as reservacalculada,
            (p.interesdevengadomenoravencido+p.interesdevmormenor)*t.porcentajereserva as reservaidnc,
            t.factordisminucion,t.tablareservaid,p.prestamoid,
            p.diasvencidos,p.finalidaddefault
       from precorte p, tablareserva t
      where p.finalidaddefault=t.finalidaddefault and
            p.diasvencidos>=t.diainicial and
            p.diasvencidos<=t.diafinal

   loop

        update precorte set tablareservaid = r.tablareservaid,
            porcentajeaplicado=r.porcentajereserva,
            reservacalculada=r.reservacalculada,
            reservaidnc=r.reservaidnc,
            factoraplicado=r.factordisminucion
        where precorteid=r.precorteid;

        raise notice ' Prestamoid % ',r.precorteid;

   end loop;
       
RETURN 1; 
END; 
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.aplicareserva() OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: catalogo_ctas; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE catalogo_ctas (
    cuentaid character(24) NOT NULL,
    cat_cuentaid character(24),
    identificacion character(1),
    cuentanombre character(100) NOT NULL,
    tipo_cta character(1),
    estado_cta character(1),
    fecha_estado date,
    fecha_ult_mov date,
    naturaleza character(1),
    digito_agrupador numeric,
    saldo_inic_ejer numeric,
    cargos_acum_ejer numeric,
    abonos_acum_ejer numeric
);


ALTER TABLE sucursal1.catalogo_ctas OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: balanza(character, character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION balanza(character, character, integer, integer) RETURNS SETOF sucursal1.catalogo_ctas
    AS $_$
declare
  pcuentai   alias for $1;
  pcuentaf   alias for $2;
  pejercicio alias for $3;
  pperiodo   alias for $4;
  r catalogo_ctas%rowtype;
  rs catalogo_ctas%rowtype;
  rc record;

  -- Totales debe y haber
  ldebe numeric;
  lhaber numeric;

begin

 ldebe := 0;
 lhaber := 0;

 update catalogo_ctas
    set saldo_inic_ejer=0,
        cargos_acum_ejer =0,
        abonos_acum_ejer=0;

 ----------------------------------------------------
 -- Buscar los saldos iniciales en
 -- los movimientos de polizas
 ---------------------------------------------------- 
 for rc in
   select m.cuentaid,sum(round(m.debe,2))-sum(round(m.haber,2)) as saldoinicial
          from polizas p,movipolizas m
    where ((p.ejercicio<pejercicio) or
           (p.ejercicio=pejercicio and p.periodo<pperiodo)) and
          m.polizaid=p.polizaid        
   group by m.cuentaid
 loop
    update catalogo_ctas
       SET saldo_inic_ejer=coalesce(rc.saldoinicial,0)
     WHERE cuentaid=rc.cuentaid;
 end loop;

 ----------------------------------------------------
 -- Buscar para el ejercicio y periodo
 -- los movimientos de polizas
 ----------------------------------------------------
 for rc in
   select m.cuentaid,sum(round(m.debe,2)) as cargos,sum(round(m.haber,2)) as abonos
     from polizas p,movipolizas m
    where p.ejercicio=pejercicio and p.periodo=pperiodo and
          m.polizaid=p.polizaid        
   group by m.cuentaid
 loop
    update catalogo_ctas
       SET cargos_acum_ejer=coalesce(round(rc.cargos,2),0),
           abonos_acum_ejer=coalesce(round(rc.abonos,2),0)
     WHERE cuentaid=rc.cuentaid;
 end loop;

 ----------------------------------------------------
 -- Acumular los movimientos de manera recursiva
 -- junto con sus cuentas acumulables respectivas
 ----------------------------------------------------
 
 FOR r IN SELECT *
            FROM catalogo_ctas
           WHERE tipo_cta='A' and
                 cuentaid>=pcuentai and
                 cuentaid<=pcuentaf and
                 (saldo_inic_ejer<>0 or
                  cargos_acum_ejer<>0 or
                  abonos_acum_ejer<>0)

 LOOP
   --raise notice 'Procensando cuenta %',r.cuentaid;
   FOR rs IN SELECT * FROM subcuentas(r.cuentaid,0,0,0)
   LOOP
      if rs.tipo_cta='A' then
        ldebe := ldebe + rs.cargos_acum_ejer;
        lhaber := lhaber + rs.abonos_acum_ejer;
      end if;
      RETURN NEXT rs;
   END LOOP;
 END LOOP;

 ----------------------------------------------------
 -- Regresar las cuentas que no tienen movimientos
 -- o saldo inicial cero
 ----------------------------------------------------
 FOR r IN SELECT * FROM catalogo_ctas
           WHERE cuentaid not in
                 (SELECT c.cuentaid
                    FROM catalogo_ctas c
                   WHERE c.cuentaid>=pcuentai and
                        c.cuentaid<=pcuentaf and
                         (c.saldo_inic_ejer<>0 or c.cargos_acum_ejer<>0 or c.abonos_acum_ejer<>0)) and
                 cuentaid>=pcuentai and
                 cuentaid<=pcuentaf
 LOOP
   if r.tipo_cta='A' then
     ldebe := ldebe +  r.cargos_acum_ejer;
     lhaber := lhaber + r.abonos_acum_ejer;
   end if;
   RETURN NEXT r;
 END LOOP; 

 r.cuentaid := 'T';
 r.cuentanombre := 'TOTALES .... ';
 r.cargos_acum_ejer := ldebe;
 r.abonos_acum_ejer := lhaber;
 return next r;

 update catalogo_ctas
    set saldo_inic_ejer=0,
        cargos_acum_ejer =0,
        abonos_acum_ejer=0;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.balanza(character, character, integer, integer) OWNER TO sistema;

--
-- Name: borracuentacatalogo(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION borracuentacatalogo(character) RETURNS integer
    AS $_$
declare
  pcuentaid1 alias for $1;
  j integer;

begin
j:=0;
if exists (select cuentaid from catalogo_ctas where cuentaid=pcuentaid1 
and cuentaid not in (select cuentaid from movipolizas where cuentaid=pcuentaid1)
and cuentaid not in (select cat_cuentaid from catalogo_ctas where cat_cuentaid=pcuentaid1)
and cuentaid not in (select cuentacaja from parametros)
and cuentaid not in (select cuentaactivo                 from tipoprestamo )
and cuentaid not in (select cuentaactivovencida          from tipoprestamo )
and cuentaid not in (select  cuentaintnormal              from tipoprestamo )
and cuentaid not in (select  cuentaintnormalvencida       from tipoprestamo )
and cuentaid not in (select  cuentaintnormalnocob         from tipoprestamo )
and cuentaid not in (select  cuentaintmora                from tipoprestamo )
and cuentaid not in (select  cuentaintmoravencida         from tipoprestamo )
and cuentaid not in (select  cuentaiva                    from tipoprestamo )
and cuentaid not in (select  cuentariesgocred             from tipoprestamo )
and cuentaid not in (select  cuentaordeninteres           from tipoprestamo )
and cuentaid not in (select  cuentaordenaval              from tipoprestamo )
and cuentaid not in (select  cuentaintdevnocobres         from tipoprestamo )
and cuentaid not in (select  cuentariesgocredres          from tipoprestamo )
and cuentaid not in (select  cuentaintmoranocobact        from tipoprestamo )
and cuentaid not in (select  cuentaintmoradevnocobres     from tipoprestamo )
and cuentaid not in (select  ordendeudornormalbonificado  from tipoprestamo )
and cuentaid not in (select  ordenacredornormalbonificado from tipoprestamo )
and cuentaid not in (select  cuentafondorecuperacion      from tipoprestamo )
and cuentaid not in (select  cuentagtosadm                from tipoprestamo )
and cuentaid not in (select  cuentaintnormalresvencida    from tipoprestamo )
and cuentaid not in (select  ordeninteresacreedor         from tipoprestamo )
and cuentaid not in (select  cuentaintnormalresvigente    from tipoprestamo )
and cuentaid not in (select  cuentaordenavalacredor       from tipoprestamo )
and cuentaid not in (select  cuentagarantiadeudor         from tipoprestamo )
and cuentaid not in (select  cuentagarantiaacredor        from tipoprestamo )
and cuentaid not in (select  cuentaprovisioniva           from tipoprestamo )

and cuentaid not in (select  cuentadeposito     from tipomovimiento )
and cuentaid not in (select cuentaretiro        from tipomovimiento )
and cuentaid not in (select cuentaintpagado     from tipomovimiento )
and cuentaid not in (select cuentaintcobrado    from tipomovimiento )
and cuentaid not in (select cuentaivamovimiento from tipomovimiento )
and cuentaid not in (select cuentaisr           from tipomovimiento )
and cuentaid not in (select cuentaordenacredor  from tipomovimiento )
and cuentaid not in (select cuentaordendeudor   from tipomovimiento )
and cuentaid not in (select cuentaprovisionisr  from tipomovimiento )

and cuentaid not in (select cuentariesgocred      from tipoinversion )
and cuentaid not in (select cuentaintinvernocob   from tipoinversion )
and cuentaid not in (select cuentapasivo          from tipoinversion )
and cuentaid not in (select cuentapasivovencida   from tipoinversion )
and cuentaid not in (select cuentaintinver        from tipoinversion )
and cuentaid not in (select cuentaivainver        from tipoinversion )
and cuentaid not in (select cuentaprovisionisr    from tipoinversion)

and cuentaid not in (select depre_activo from depreciacion)
and cuentaid not in (select depre_ctadepre from depreciacion)
and cuentaid not in (select depre_ctagasto from depreciacion)
and cuentaid not in (select depre_ctabaja from depreciacion)


and cuentaid not in (select  cuentaid from bancos)) then

        delete from saldos where cuentaid = pcuentaid1;
        delete from saldosc where cuentaid = pcuentaid1;
        delete from catalogo_ctas where cuentaid = pcuentaid1;
        j:=1;

end if;

return j;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.borracuentacatalogo(character) OWNER TO sistema;

--
-- Name: buscadebes(numeric, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION buscadebes(numeric, date) RETURNS numeric
    AS $_$
declare
  psocioid alias for $1;
  pfecha alias for $2;
  
  r record;

  psaldoprestamo numeric;
  fsubtotal numeric;
  fsaldomov numeric;

begin

    raise notice ' Socio %',psocioid;

    fsubtotal := 0;

    for r in select p.socioid,p.montoprestamo-SUM(case when m.cuentaid=tp.cuentaactivo and po.fechapoliza<=pfecha then m.haber else 0 end) as saldoprestamo from prestamos p left join movicaja mc on p.prestamoid=mc.prestamoid left join polizas po on mc.polizaid = po.polizaid left join movipolizas m on po.polizaid=m.polizaid,tipoprestamo tp where p.socioid=psocioid and p.fecha_otorga <=pfecha and p.claveestadocredito<>'008' and tp.tipoprestamoid = p.tipoprestamoid group by p.socioid,p.montoprestamo

    loop 
       raise notice ' Socio %',r.socioid;

       psaldoprestamo:= COALESCE (r.saldoprestamo, 0 );
         
       fsubtotal := fsubtotal + psaldoprestamo;

    End loop;
            

return fsubtotal;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.buscadebes(numeric, date) OWNER TO sistema;

--
-- Name: buscahaberes(numeric, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION buscahaberes(numeric, date) RETURNS numeric
    AS $_$
declare
  psocioid alias for $1;
  pfecha alias for $2;  
  r tsaldosmov%rowtype;
  g tsaldosmov%rowtype;
  fsubtotal numeric;
  fsaldomov numeric;
 
begin
--raise notice ' Socio %',psocioid;
fsubtotal := 0;

    for r in

      select mc.tipomovimientoid, tm.desctipomovimiento, sum(mp.debe)-sum(mp.haber) as saldo
        from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p
       where mc.socioid=psocioid and
             mp.movipolizaid=mc.movipolizaid and
             tm.tipomovimientoid=mc.tipomovimientoid and
             mc.tipomovimientoid<>'00' and
             mc.tipomovimientoid<>'IN' and        
             p.polizaid = mc.polizaid and
             p.fechapoliza < pfecha+1 and
             tm.aplicasaldo='S'
      group by mc.tipomovimientoid,tm.desctipomovimiento
      order by mc.tipomovimientoid
    loop

    if r.saldo <> 0 then 
            fsubtotal := fsubtotal + r.saldo;
    end if;

    end loop;

    -- Calcular el saldo para la inversion tomando movimientos de la cuenta de pasivo de
    -- la inversion

    for g in
       SELECT m.tipomovimientoid,tm.desctipomovimiento, -sum(debe)+sum(haber) as saldo
         from movicaja m, polizas p,tipoinversion t,movipolizas mp,inversion i,tipomovimiento tm
        where m.socioid=psocioid and m.tipomovimientoid='IN' and p.polizaid=m.polizaid and
              p.fechapoliza < pfecha+1 and
              i.inversionid = m.inversionid and
              t.tipoinversionid=i.tipoinversionid and mp.polizaid=m.polizaid and
              mp.cuentaid = t.cuentapasivo and
              tm.tipomovimientoid=m.tipomovimientoid
      group by m.tipomovimientoid,tm.desctipomovimiento
    loop

    if g.saldo <> 0 then 
        fsubtotal := fsubtotal + g.saldo;
    end if;

    end loop;

return fsubtotal;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.buscahaberes(numeric, date) OWNER TO sistema;

--
-- Name: buscapartesocial(numeric, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION buscapartesocial(numeric, date) RETURNS numeric
    AS $_$
declare
  psocioid alias for $1;
  pfecha alias for $2;
  
  r record;

  fsaldoparte numeric;
 
begin
--raise notice ' Socio %',psocioid;
select sum(mp.debe)-sum(mp.haber) into fsaldoparte
        from movicaja mc, movipolizas mp, polizas p
        where mc.socioid=psocioid and
          mc.tipomovimientoid='PA' and
          mc.polizaid=p.polizaid and
          p.fechapoliza < pfecha+1 and
          mp.movipolizaid=mc.movipolizaid;

        fsaldoparte:=coalesce(fsaldoparte,0);

return fsaldoparte;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.buscapartesocial(numeric, date) OWNER TO sistema;

--
-- Name: buscasaldossocios(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION buscasaldossocios(integer, date) RETURNS SETOF saldossocio
    AS $_$
declare
  psocioid alias for $1;  
  pfecha alias for $2;  
  f saldossocio%rowtype;  
  r tsaldosmov%rowtype;
  g record;
  h record;
  fsubtotal numeric;
  fsaldomov numeric;
  fsaldoparte numeric;
  psaldoprestamo numeric;
  psaldotipomb numeric;
  fsaldoahorro numeric;
  fsaldoctacor numeric;
  fsaldoinver numeric;

begin

for f in 
  select socioid, 0 as haberes, 0 as deberes, 0 as parte from socio where socioid=psocioid
  loop  
  
  fsubtotal := 0;

 for r in

      select mc.tipomovimientoid, tm.desctipomovimiento, sum(mp.debe)-sum(mp.haber) as saldo
        from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p
       where mc.socioid=psocioid and
             mp.movipolizaid=mc.movipolizaid and
             tm.tipomovimientoid=mc.tipomovimientoid and
             mc.tipomovimientoid<>'00' and
             mc.tipomovimientoid<>'IN' and        
             p.polizaid = mc.polizaid and
             p.fechapoliza < pfecha+1 and
             tm.aplicasaldo='S'
      group by mc.tipomovimientoid,tm.desctipomovimiento
      order by mc.tipomovimientoid
    loop

    if r.saldo <> 0 then 
            fsubtotal := fsubtotal + r.saldo;
    end if;

    end loop;

    f.haberes=fsubtotal; 
   
    fsubtotal := 0;

    select sum(mp.debe)-sum(mp.haber) into fsaldoparte
        from movicaja mc, movipolizas mp, polizas p
        where mc.socioid=psocioid and
          mc.tipomovimientoid='PA' and
          mc.polizaid=p.polizaid and
          p.fechapoliza < pfecha+1 and
          mp.movipolizaid=mc.movipolizaid;

    fsaldoparte:=coalesce(fsaldoparte,0);
   
    f.parte:=fsaldoparte;

    raise notice ' voy aqui pase haberes y parte';

 fsubtotal := 0;

    for h in select p.socioid,p.montoprestamo-SUM(case when m.cuentaid=tp.cuentaactivo and po.fechapoliza<=pfecha then m.haber else 0 end) as saldoprestamo from prestamos p left join movicaja mc on p.prestamoid=mc.prestamoid left join polizas po on mc.polizaid = po.polizaid left join movipolizas m on po.polizaid=m.polizaid,tipoprestamo tp where p.socioid=psocioid and p.fecha_otorga <=pfecha and p.claveestadocredito<>'008' and tp.tipoprestamoid = p.tipoprestamoid group by p.socioid,p.montoprestamo

    loop 

       psaldoprestamo:= COALESCE (h.saldoprestamo, 0 );
         
       fsubtotal := fsubtotal + psaldoprestamo;

    End loop;

 f.deberes := fsubtotal;

    --raise notice ' Socio % % % %',psocioid,f.haberes,f.deberes,f.parte;
    return next f;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.buscasaldossocios(integer, date) OWNER TO sistema;

--
-- Name: buscasucursal(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION buscasucursal(character) RETURNS SETOF rbuscasucursal
    AS $_$    
declare  
  r rbuscasucursal%rowtype;
  pclavesocioint alias for $1;
  psucid char(4);

begin

  psucid:=substring(pclavesocioint,1,4);
  for r in
        select rtrim(ltrim(host)),rtrim(ltrim(basededatos)),rtrim(ltrim(esquema)) from sucursales where sucid=psucid
        loop
          return next r;
        end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.buscasucursal(character) OWNER TO sistema;

--
-- Name: buscasucursalid(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION buscasucursalid(integer) RETURNS SETOF rbuscasucursal
    AS $_$    
declare  
  r rbuscasucursal%rowtype;
  psucursalid alias for $1;
  isucursalid integer;
  psucid char(4);
 
begin

  isucursalid:=psucursalid+1;
  
  select sucid into psucid  from sucursales where sucursalid=isucursalid;

  if found then 
    for r in
        select rtrim(ltrim(host)),rtrim(ltrim(basededatos)),rtrim(ltrim(esquema)) from sucursales where sucursalid=isucursalid
        loop
          return next r;
        end loop;
  else
    for r in
        select rtrim(ltrim(host)),rtrim(ltrim(basededatos)),rtrim(ltrim(esquema)) from sucursales where sucid in (select suid from empresa where empresaid=1)
        loop
          return next r;
        end loop;
  end if;
  
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.buscasucursalid(integer) OWNER TO sistema;

--
-- Name: buscasucursalid(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION buscasucursalid(integer, character) RETURNS SETOF rbuscasucursal
    AS $_$    
declare  
  r rbuscasucursal%rowtype;
  psucursalid alias for $1;
  phost alias for $2;
  
  isucursalid integer;

  shost char(40);
  
 
begin
  
  isucursalid:=psucursalid+1;
  select hostremoto into shost  from sucursales where sucursalid=isucursalid;

  raise notice ' % % ',shost,phost;
    
  if found then

    if substring(shost,1,4)=substring(phost,1,4) then
   
      for r in
        select rtrim(ltrim(hostremoto)),rtrim(ltrim(basededatos)),rtrim(ltrim(esquema)) from sucursales where sucursalid=isucursalid
        loop
          return next r;
        end loop;
        
    else
    
      for r in
      
        select rtrim(ltrim(host)),rtrim(ltrim(basededatos)),rtrim(ltrim(esquema)) from sucursales where sucursalid=isucursalid
        loop
          return next r;
        end loop;

    end if;
    
  else

    if substring(shost,1,4)=substring(phost,1,4) then
   
      for r in
        select rtrim(ltrim(hostremoto)),rtrim(ltrim(basededatos)),rtrim(ltrim(esquema)) from sucursales  where sucid in (select sucid from empresa where empresaid=1)
        loop
          return next r;
        end loop;
        
    else
      
      for r in
        select rtrim(ltrim(host)),rtrim(ltrim(basededatos)),rtrim(ltrim(esquema)) from sucursales where sucid in (select sucid from empresa where empresaid=1)
        loop
          return next r;
        end loop;

    end if;     
  end if;
  
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.buscasucursalid(integer, character) OWNER TO sistema;

--
-- Name: cambiaamortizaciones(character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cambiaamortizaciones(character, integer) RETURNS integer
    AS $_$
declare
  preferenciaprestamo alias for $1;
  pamortizaciones  alias for $2;

  r tablaamor%rowtype;

  pmonto numeric;
  psaldoprestamo numeric;
  ppago1 date;
  ptipoprestamoid char(3);
  pperiododias int4;
  pmeses int4;
  pdiames int4;
  pfechaotorga date;
  lprestamoid int4;
  pestadocredito char(3);
  pfechaultimopago date;
  psaldaamortiza int4;
  pamortizacionid int4;
 
begin

--
-- Buscamos datos en el  prestamo
--

  select prestamoid,montoprestamo,fecha_1er_pago,tipoprestamoid,dias_de_cobro,meses_de_cobro,dia_mes_cobro,fecha_otorga,saldoprestamo,claveestadocredito,fechaultimopago into lprestamoid,
    pmonto,ppago1,ptipoprestamoid,pperiododias,pmeses,pdiames,pfechaotorga,psaldoprestamo,pestadocredito,pfechaultimopago from prestamos
   where referenciaprestamo=preferenciaprestamo;   

  delete from amortizaciones where prestamoid=lprestamoid;

  for r in 
    select * from sptablaamor(pmonto,ppago1,ptipoprestamoid,pamortizaciones,pperiododias,pmeses,pdiames,pfechaotorga)
       loop
         select spiamortizacion into pamortizacionid from spiamortizacion(lprestamoid,r.numamortizacion,r.fechadepago,r.importeamortizacion,r.interesnormal,r.saldo_absoluto,pestadocredito,0,0,r.fechadepago);

 --        raise notice '  %  %  % ',r.numamortizacion,r.fechadepago,r.importeamortizacion,r.saldo_absoluto;
       end loop;
   update prestamos set numero_de_amor = pamortizaciones where prestamoid=lprestamoid;
   select saldaamortiza into psaldaamortiza  from saldaamortiza(preferenciaprestamo,pmonto-psaldoprestamo,pfechaultimopago);
return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.cambiaamortizaciones(character, integer) OWNER TO sistema;

--
-- Name: cambiacuentacatalogo(character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cambiacuentacatalogo(character, character) RETURNS integer
    AS $_$
declare
  pcuentaid1 alias for $1;
  pcuentaid2 alias for $2;
 
begin

--
-- Actualizamos todas las tablas
--
-- Catalogo de cuentas

update catalogo_ctas set cuentaid=pcuentaid2 where cuentaid=pcuentaid1 and pcuentaid2 not in (select cuentaid from catalogo_ctas where cuentaid=pcuentaid2);

update catalogo_ctas set cat_cuentaid=pcuentaid2 where cat_cuentaid=pcuentaid1;


-- Movipolizas

update movipolizas set cuentaid=pcuentaid2 where cuentaid=pcuentaid1;


-- Tipo de inversion
update tipoinversion set cuentapasivo=pcuentaid2 where cuentapasivo=pcuentaid1;
update tipoinversion set cuentapasivovencida=pcuentaid2 where cuentapasivovencida=pcuentaid1;
update tipoinversion set cuentaintinver=pcuentaid2 where cuentaintinver=pcuentaid1;
update tipoinversion set cuentaintinvernocob=pcuentaid2 where cuentaintinvernocob=pcuentaid1;
update tipoinversion set cuentariesgocred=pcuentaid2 where cuentariesgocred=pcuentaid1;
update tipoinversion set cuentaivainver=pcuentaid2 where cuentaivainver=pcuentaid1;
update tipoinversion set CuentaProvisionISR=pcuentaid2 where CuentaProvisionISR=pcuentaid1;


-- Tipo prestamo

update tipoprestamo set CuentaActivo=pcuentaid2 where  CuentaActivo=pcuentaid1;
 
update tipoprestamo set CuentaActivoVencida=pcuentaid2 where  CuentaActivoVencida=pcuentaid1;

update tipoprestamo set CuentaIntMora=pcuentaid2 where  CuentaIntMora=pcuentaid1;
 
update tipoprestamo set CuentaIntMoraVencida=pcuentaid2 where  CuentaIntMoraVencida=pcuentaid1; 

update tipoprestamo set CuentaIntNormal=pcuentaid2 where  CuentaIntNormal=pcuentaid1;

update tipoprestamo set CuentaIntNormalNoCob=pcuentaid2 where CuentaIntNormalNoCob=pcuentaid1;  
 
update tipoprestamo set CuentaIntNormalVencida=pcuentaid2 where CuentaIntNormalVencida=pcuentaid1;

update tipoprestamo set CuentaIVA=pcuentaid2 where CuentaIVA=pcuentaid1;

update tipoprestamo set CuentaOrdenAval=pcuentaid2 where CuentaOrdenAval=pcuentaid1;

update tipoprestamo set CuentaOrdenInteres=pcuentaid2 where CuentaOrdenInteres=pcuentaid1;

update tipoprestamo set CuentaRiesgoCred=pcuentaid2 where CuentaRiesgoCred=pcuentaid1;

update tipoprestamo set CuentaIntDevNoCobRes=pcuentaid2 where CuentaIntDevNoCobRes=pcuentaid1;

update tipoprestamo set CuentaRiesgoCredRes=pcuentaid2 where CuentaRiesgoCredRes=pcuentaid1;

update tipoprestamo set CuentaIntMoraNoCobAct=pcuentaid2 where CuentaIntMoraNoCobAct=pcuentaid1;  
 
update tipoprestamo set CuentaIntMoraDevNoCobRes=pcuentaid2 where CuentaIntMoraDevNoCobRes=pcuentaid1;

update tipoprestamo set OrdenDeudorNormalBonificado=pcuentaid2 where OrdenDeudorNormalBonificado=pcuentaid1;   

update tipoprestamo set OrdenAcredorNormalBonificado=pcuentaid2 where OrdenAcredorNormalBonificado=pcuentaid1;   
 
update tipoprestamo set CuentaFondoRecuperacion=pcuentaid2 where CuentaFondoRecuperacion=pcuentaid1;

update tipoprestamo set CuentaGtosAdm=pcuentaid2 where CuentaGtosAdm=pcuentaid1;

update tipoprestamo set cuentaintnormalresvencida=pcuentaid2 where cuentaintnormalresvencida=pcuentaid1;

update tipoprestamo set ordeninteresacreedor=pcuentaid2 where ordeninteresacreedor=pcuentaid1;

update tipoprestamo set CuentaOrdenAvalAcredor=pcuentaid2 where CuentaOrdenAvalAcredor=pcuentaid1;

update tipoprestamo set CuentaGarantiaDeudor=pcuentaid2 where CuentaGarantiaDeudor=pcuentaid1;

update tipoprestamo set CuentaGarantiaAcredor=pcuentaid2 where CuentaGarantiaAcredor=pcuentaid1;

update tipoprestamo set CuentaProvisionIVA=pcuentaid2 where CuentaProvisionIVA=pcuentaid1;

update tipoprestamo set cuentaintnormalresvigente=pcuentaid2 where cuentaintnormalresvigente=pcuentaid1;


-- Tipo movimiento

update tipomovimiento set cuentadeposito=pcuentaid2 where cuentadeposito=pcuentaid1;

update tipomovimiento set cuentaretiro=pcuentaid2 where cuentaretiro=pcuentaid1;

update tipomovimiento set cuentaintpagado=pcuentaid2 where cuentaintpagado=pcuentaid1;

update tipomovimiento set cuentaintcobrado=pcuentaid2 where cuentaintcobrado=pcuentaid1;

update tipomovimiento set cuentaivamovimiento=pcuentaid2 where cuentaivamovimiento=pcuentaid1;

update tipomovimiento set cuentaisr=pcuentaid2 where cuentaisr=pcuentaid1;

update tipomovimiento set CuentaOrdenAcredor=pcuentaid2 where CuentaOrdenAcredor=pcuentaid1;
update tipomovimiento set CuentaOrdenDeudor=pcuentaid2 where CuentaOrdenDeudor=pcuentaid1;
update tipomovimiento set CuentaOrden=pcuentaid2 where  CuentaOrden=pcuentaid1;

update tipomovimiento set cuentaprovisionisr=pcuentaid2 where   cuentaprovisionisr=pcuentaid1;



-- Bancos

update bancos set cuentaid=pcuentaid2 where cuentaid=pcuentaid1;

-- Empresa

update empresa set cuentaid=pcuentaid2 where cuentaid=pcuentaid1;

-- Depreciacion 

update depreciacion set depre_activo=pcuentaid2 where depre_activo=pcuentaid1;

update depreciacion set depre_ctadepre=pcuentaid2 where depre_ctadepre=pcuentaid1;

update depreciacion set depre_ctagasto=pcuentaid2 where depre_ctagasto=pcuentaid1;

update depreciacion set depre_ctabaja=pcuentaid2 where depre_ctabaja=pcuentaid1;

-- saldos

update saldos set cuentaid=pcuentaid2 where cuentaid=pcuentaid1;
update saldosc set cuentaid=pcuentaid2 where cuentaid=pcuentaid1;

--update premovipolizas set cuentaid=pcuentaid2 where cuentaid=pcuentaid1;

-- parametros

update parametros set cuentacaja=pcuentaid2 where cuentacaja=pcuentaid1;

-- SubRango

update subrango set RangoInicial=pcuentaid2 where RangoInicial=pcuentaid1;
update subrango set RangoFinal=pcuentaid2 where RangoFinal=pcuentaid1;

--delete from catalogo_ctas where cuentaid=pcuentaid1;

return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.cambiacuentacatalogo(character, character) OWNER TO sistema;

--
-- Name: cambiafechapoliza(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cambiafechapoliza(integer, date) RETURNS numeric
    AS $_$
declare
  ppolizaid alias for $1;
  pfecha alias for $2;

  pnumeropoliza int4;
  ptipopoliza char(1);
  pejercicio int4;
  pperiodo int4;

begin

  pejercicio:=cast(date_part('year',pfecha) as int4);
  pperiodo:=cast(date_part('month',pfecha) as int4);
  select tipo_poliza into ptipopoliza from polizas where polizaid=ppolizaid;

  select max(numero_poliza) into pnumeropoliza from polizas where periodo=pperiodo and ejercicio=pejercicio and tipo_poliza=ptipopoliza;

  pnumeropoliza:=coalesce(pnumeropoliza,0);
  pnumeropoliza:= pnumeropoliza+1;

  update polizas set fechapoliza = pfecha, numero_poliza=pnumeropoliza, periodo=pperiodo, ejercicio=pejercicio where polizaid=ppolizaid;

  return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cambiafechapoliza(integer, date) OWNER TO sistema;

--
-- Name: cambiamontoprestamo(character, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cambiamontoprestamo(character, numeric) RETURNS integer
    AS $_$
declare
  sref alias for $1;
  fmonto alias for $2;
  i int;
  lprestamoid int4;
  lpolizaid int4;
begin


  select prestamoid into lprestamoid from prestamos where referenciaprestamo=sref;

  delete from amortizaciones where prestamoid=lprestamoid;

  update prestamos set montoprestamo=fmonto,saldoprestamo=fmonto
    where referenciaprestamo=sref;

  select generaramortizaciones(sref,0,fecha_otorga)
    into i
    from prestamos
   where referenciaprestamo=sref;

select polizaid into lpolizaid from movibanco where prestamoid=lprestamoid;

  update movipolizas
     set debe=fmonto
   where polizaid=lpolizaid and
         debe>0;

  update movipolizas
     set haber=fmonto
   where polizaid=lpolizaid and
         haber>0;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cambiamontoprestamo(character, numeric) OWNER TO sistema;

--
-- Name: cambiaprestamosultimoabono(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cambiaprestamosultimoabono() RETURNS integer
    AS $$
declare
  f record;
  pprestamocambiado int4;

begin

--
-- Buscamos datos en el  prestamo
--

for f in

  select referenciaprestamo,numero_de_amor,prestamoid from prestamos
  loop

    select aplicafechaamortizaciones into pprestamocambiado from aplicafechaamortizaciones(f.prestamoid);
    raise notice ' cambie prestamo % ', f.referenciaprestamo;
  end loop;
return 1;
end
$$
    LANGUAGE plpgsql;


ALTER FUNCTION public.cambiaprestamosultimoabono() OWNER TO sistema;

--
-- Name: cambiarreestructurados(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cambiarreestructurados(date) RETURNS integer
    AS $_$
declare
  pfecha alias for $1;
  r record;
  pcambiatipo int4;

begin



for r in 
  select prestamoid,tipoprestamoid,fecha_otorga from prestamos where tipoprestamoid in ('T1','T2','T3','R1','R2','R3','VE') and fecha_otorga <= pfecha

  loop

     raise notice ' Iniciando *';

     if r.tipoprestamoid='T1' then

        select cambiartipo into pcambiatipo from cambiartipo(r.prestamoid,'T1','N10');

     end if;

     if r.tipoprestamoid='T2' then

        select cambiartipo into pcambiatipo from cambiartipo(r.prestamoid,'T2','N10');

     end if;

     if r.tipoprestamoid='T3' then

        select cambiartipo into pcambiatipo from cambiartipo(r.prestamoid,'T3','V10');

     end if;

     if r.tipoprestamoid='R1' then

        select cambiartipo into pcambiatipo from cambiartipo(r.prestamoid,'R1','N10');

     end if;

     if r.tipoprestamoid='R2' then

        select cambiartipo into pcambiatipo from cambiartipo(r.prestamoid,'R2','N10');

     end if;

     if r.tipoprestamoid='R3' then

        select cambiartipo into pcambiatipo from cambiartipo(r.prestamoid,'R3','V10');

     end if;

     raise notice ' Prestamo % -- % ',r.prestamoid,r.tipoprestamoid;


  end loop;

return 1;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cambiarreestructurados(date) OWNER TO sistema;

--
-- Name: cambiartipo(integer, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cambiartipo(integer, character, character) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;
  ptipoactual alias for $2;
  ptiponuevo  alias for $3;

  a tipoprestamo%rowtype;
  n tipoprestamo%rowtype;

begin


  select *
    into a
    from tipoprestamo
   where tipoprestamoid=ptipoactual;

  select *
    into n
    from tipoprestamo
   where tipoprestamoid=ptiponuevo;

    update prestamos
     set tipoprestamoid = ptiponuevo,
         tasanormal= n.tasa_normal,
         tasa_moratoria= n.tasa_mora
   where prestamoid=pprestamoid;


     update movipolizas
        set cuentaid = n.cuentaactivo
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.cuentaactivo;
       
     update movipolizas
        set cuentaid = n.cuentaintnormal
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.cuentaintnormal;

     update movipolizas
        set cuentaid = n.cuentaintmora
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.cuentaintmora;

     update movipolizas
        set cuentaid = n.cuentaiva
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.cuentaiva;

     update movipolizas
        set cuentaid = n.ordendeudornormalbonificado
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.ordendeudornormalbonificado;

     update movipolizas
        set cuentaid = n.ordenacredornormalbonificado
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.ordenacredornormalbonificado;

     update movipolizas
        set cuentaid = n.cuentaactivo
      where polizaid IN (select polizaid from movibanco where prestamoid=pprestamoid) and
            cuentaid = a.cuentaactivo;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cambiartipo(integer, character, character) OWNER TO sistema;

--
-- Name: cambiartipocresur(integer, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cambiartipocresur(integer, character, character) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;
  ptipoactual alias for $2;
  ptiponuevo  alias for $3;

  a tipoprestamo%rowtype;
  n tipoprestamo%rowtype;

begin


  select *
    into a
    from tipoprestamo
   where tipoprestamoid=ptipoactual;

  select *
    into n
    from tipoprestamo
   where tipoprestamoid=ptiponuevo;


-- Ojo ya esta descomentado por lo que tomara las nuevas condiciones del tipo nuevo

   update prestamos
     set tipoprestamoid = ptiponuevo        
   where prestamoid=pprestamoid;

     update movipolizas
        set cuentaid = n.cuentaactivo
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.cuentaactivo;
       
     update movipolizas
        set cuentaid = n.cuentaintnormal
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.cuentaintnormal;

     update movipolizas
        set cuentaid = n.cuentaintmora
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.cuentaintmora;

     update movipolizas
        set cuentaid = n.cuentaiva
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.cuentaiva;

     update movipolizas
        set cuentaid = n.ordendeudornormalbonificado
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.ordendeudornormalbonificado;

     update movipolizas
        set cuentaid = n.ordenacredornormalbonificado
      where polizaid IN (select polizaid from movicaja where prestamoid=pprestamoid) and
            cuentaid = a.ordenacredornormalbonificado;

     update movipolizas
        set cuentaid = n.cuentaactivo
      where polizaid IN (select polizaid from movibanco where prestamoid=pprestamoid) and
            cuentaid = a.cuentaactivo;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cambiartipocresur(integer, character, character) OWNER TO sistema;

--
-- Name: cambiartipoprestamoscresur(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cambiartipoprestamoscresur() RETURNS integer
    AS $$
declare

  largo integer;
  r record;

  vtiponuevo char(3);
  vtipoini char(1);

  stantos      integer;  
  stasa_normal numeric;
  stasa_mora   numeric;
  sdesctipoprestamo  char(30);
  stipomovimientoid char(2); 
  scambiartipocresur integer;

begin

--
-- Actualizamos todas las tablas
--
-- Catalogo de cuentas


for r in select prestamoid,tipoprestamoid from prestamos

   loop

      vtipoini:=substring(r.tipoprestamoid,1,1);

      if vtipoini='A' then

        vtiponuevo:='M'||substring(r.tipoprestamoid,2,1);

      end if;

      if vtipoini='B' then

        vtiponuevo:='N'||substring(r.tipoprestamoid,2,1);

      end if;

      if vtipoini='C' then

        vtiponuevo:='V'||substring(r.tipoprestamoid,2,1);

      end if;

      select cambiartipocresur into scambiartipocresur from cambiartipocresur(r.prestamoid,r.tipoprestamoid,vtiponuevo);

      raise notice ' tipo ant  %  tipo nvo  % ',r.tipoprestamoid,vtiponuevo;

      select tantos,tasa_normal,tasa_mora,desctipoprestamo into stantos,stasa_normal,stasa_mora,sdesctipoprestamo from tipoprestamo where tipoprestamoid=r.tipoprestamoid;

      update tipoprestamo set tantos=stantos,tasa_normal=stasa_normal,tasa_mora=stasa_mora,desctipoprestamo=sdesctipoprestamo where tipoprestamoid = vtiponuevo;

      update solicitudprestamo set tipoprestamoid=vtiponuevo where tipoprestamoid=r.tipoprestamoid;
     
   end loop;


return 1;
end
$$
    LANGUAGE plpgsql;


ALTER FUNCTION public.cambiartipoprestamoscresur() OWNER TO sistema;

--
-- Name: cambiatabla(numeric, date, character, integer, integer, integer, integer, date, numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cambiatabla(numeric, date, character, integer, integer, integer, integer, date, numeric, integer) RETURNS numeric
    AS $_$
declare
  pmonto          alias for $1;
  ppago1          alias for $2;
  ptipoprestamoid alias for $3;
  pnoamor         alias for $4;
  pperiododias    alias for $5;
  pmeses          alias for $6;
  pdiames         alias for $7;
  pfechaotorga    alias for $8;
  ptasanormal     alias for $9;
  pprestamoid     alias for $10;

  fmonto numeric;
  dpago1 date;
  stipoprestamoid char(3);
  inoamor integer;
  iperiododias integer;
  imeses integer;
  idiames integer;
  ffechaotorga date;
  ftasanormal numeric;

  ivalor numeric;
  
  
begin

  ivalor=0;
  select montoprestamo,fecha_1er_pago,tipoprestamoid,numero_de_amor,dias_de_cobro,meses_de_cobro,dia_mes_cobro,fecha_otorga,tasanormal
  into fmonto,dpago1,stipoprestamoid,inoamor,iperiododias,imeses,idiames,ffechaotorga,ftasanormal
  from prestamos where prestamoid=pprestamoid;
  
  if fmonto <> pmonto or dpago1 <> ppago1 or stipoprestamoid <> ptipoprestamoid or inoamor <> pnoamor or iperiododias <> pperiododias
     or imeses <> pmeses or idiames <> pdiames or ffechaotorga <> pfechaotorga or ftasanormal <> ptasanormal then
     ivalor = 100;

  end if;

  -- Validar si no existe el prestamo generar la tabla
  
  if not exists(select prestamoid from prestamos where prestamoid=pprestamoid) then
     ivalor = 100;
  end if;   

  return ivalor;

  end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cambiatabla(numeric, date, character, integer, integer, integer, integer, date, numeric, integer) OWNER TO sistema;

--
-- Name: cancelaministracion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cancelaministracion(integer) RETURNS integer
    AS $_$
declare
  
   pprestamoid       alias for $1;
   r record;
   ispcancelamovimiento integer;
begin

   for r in select * from ministrar where prestamoid=pprestamoid

   loop

     select spcancelamovimiento into ispcancelamovimiento from spcancelamovimiento(r.seriecaja,r.referenciacaja,(select usuarioid from parametros where serie_user=r.seriecaja));
     
   end loop;

   update ministrar set monto=0  where prestamoid=pprestamoid;

   return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cancelaministracion(integer) OWNER TO sistema;

--
-- Name: cancelapoliza(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cancelapoliza(integer) RETURNS integer
    AS $_$
declare
  ppolizaid alias for $1;

  pmovicajaid int4;
  ptipomovimientoid char(2);
  pfechamov date;

  lprestamoid int4;
  fcapital numeric;
  pfechaant date;
  pfecha_otorga date;
  fAbono numeric;
  fAplicar numeric;
  amor record;

  linversionid int4;
  fdeposito numeric;
  fretiroi  numeric;
  fretiroc  numeric;
  scuentapasivo   char(24);
  scuentaintinver char(24);

  pejercicio int4;
  pperiodo int4;


begin

  select ejercicio,periodo
    into pejercicio,pperiodo
    from polizas
   where polizaid = ppolizaid;

   if periodovalido(pejercicio,pperiodo)=0 then
     raise exception 'El periodo % del Ejercicio % se encuentra CERRADO !!!',pperiodo,pejercicio;
   end if;


  select movicajaid,tipomovimientoid,prestamoid,inversionid
    into pmovicajaid,ptipomovimientoid,lprestamoid,linversionid
    from movicaja
   where polizaid=ppolizaid;
 
  if FOUND and ptipomovimientoid<>'00' and ptipomovimientoid<>'IN' then

    --
    -- Movimientos normales en caja
    --
    update movipolizas
       set debe=0,
           haber=0,
           descripcion='CANCELADA'
     where polizaid=ppolizaid;

    update movicaja
       set estatusmovicaja='C'
     where movicajaid=pmovicajaid;

  end if;

  if FOUND and ptipomovimientoid='00' or ptipomovimientoid='IN' then

    select fechapoliza
      into pfechamov
      from polizas
     where polizaid = ppolizaid;

    if ptipomovimientoid='00' then
      --
      -- Movimientos de prestamo
      --

      --
      -- Buscar el abono de capital para el prestamo
      --
      select sum(m.haber)
        into fcapital
        from prestamos p, tipoprestamo tp, movipolizas m
       where p.prestamoid = lprestamoid and
             tp.tipoprestamoid = p.tipoprestamoid and
             m.polizaid = ppolizaid and
             m.cuentaid = tp.cuentaactivo;

      fcapital := coalesce(fcapital,0);

      --
      -- Buscar la fecha de abono anterior que no este cancelado
      --
      select max(p.fechapoliza)
        into pfechaant
        from movicaja m, polizas p
       where m.prestamoid = lprestamoid and
             p.polizaid = m.polizaid and
             p.fechapoliza < pfechamov and
             m.estatusmovicaja<>'C';

      select fecha_otorga
        into pfecha_otorga
        from prestamos
       where prestamoid = lprestamoid;

      pfechaant := coalesce(pfechaant,pfecha_otorga);

      update prestamos
         set saldoprestamo = saldoprestamo + fcapital,
             fechaultimopago = pfechaant,
             claveestadocredito = '001'
       where prestamoid=lprestamoid;

      if fcapital>0 then
        --
        -- Regresar Amortizaciones a su estatus anterior
        --

        fAbono := fcapital;

        for amor in
            select *
              from amortizaciones
             where prestamoid=lprestamoid
          order by fechadepago desc
        loop
        
          fAplicar := amor.abonopagado;
          if fAplicar>0 then
            if fAbono>=fAplicar then
              update amortizaciones
                 set abonopagado = abonopagado - fAplicar,
                     ultimoabono = pfechaant
               where amortizacionid=amor.amortizacionid;
               fAbono := fAbono - fAplicar;
            else
              if fAbono>0 then
                update amortizaciones
                   set abonopagado = abonopagado-fAbono,
                       ultimoabono = pfechaant
                 where amortizacionid=amor.amortizacionid;
                 fAbono := 0;
              end if;
            end if;
          end if;
        end loop;

      end if;

      update polizas
         set concepto_poliza = 'CANCELADO '||CURRENT_DATE||' '||CURRENT_USER
       where polizaid=ppolizaid;

      update movipolizas
         set debe = 0,
             haber = 0,
             descripcion = 'CANCELADO '||CURRENT_DATE||' '||CURRENT_USER
       where polizaid=ppolizaid;

      update movicaja
         set estatusmovicaja='C'
       where movicajaid=pmovicajaid;

    else
      --
      -- Movimientos de inversion
      --

      select t.cuentapasivo, t.cuentaintinver
        into scuentapasivo, scuentaintinver
        from inversion i, tipoinversion t
       where i.inversionid = linversionid and
             t.tipoinversionid = i.tipoinversionid;

      --
      -- Verificar si es retiro o deposito
      --
      select sum(m.debe), sum(m.haber)
        into fretiroc, fdeposito
        from movipolizas m
       where m.polizaid = ppolizaid and
             m.cuentaid = scuentapasivo;

      fretiroc   := coalesce(fretiroc,0);
      fdeposito  := coalesce(fdeposito,0);

      if fdeposito>0 or fretiroc>0 then
        if fdeposito>0 then
          update inversion
             set depositoinversion=depositoinversion-fdeposito
           where inversionid=linversionid;

        else
          update inversion
             set retiroinversion=retiroinversion-fretiroc,
                 fechapagoinversion=fechapagoanterior
           where inversionid=linversionid;
        end if;


        update polizas
           set concepto_poliza = 'CANCELADO '||CURRENT_DATE||' '||CURRENT_USER
         where polizaid=ppolizaid;

        update movipolizas
           set debe = 0,
               haber = 0,
               descripcion = 'CANCELADO '||CURRENT_DATE||' '||CURRENT_USER
         where polizaid=ppolizaid;

        update movicaja
           set estatusmovicaja='C'
         where movicajaid=pmovicajaid;

      else
        -- Se trata de un retiro de interes
        select sum(m.debe)
          into fretiroi
          from movipolizas m
         where m.polizaid = ppolizaid and
               m.cuentaid = scuentaintinver;

        fretiroi := coalesce(fretiroi,0);

        if fretiroi>0 then



          update inversion
             set fechapagoinversion=fechapagoanterior
           where inversionid=linversionid;

          update polizas
             set concepto_poliza = 'CANCELADO '||CURRENT_DATE||' '||CURRENT_USER
           where polizaid=ppolizaid;

          update movipolizas
             set debe = 0,
                 haber = 0,
                 descripcion = 'CANCELADO '||CURRENT_DATE||' '||CURRENT_USER
           where polizaid=ppolizaid;

          update movicaja
             set estatusmovicaja='C'
           where movicajaid=pmovicajaid;

        end if;

      end if;
  
    end if;

  end if;

  if NOT FOUND then
    --
    -- Otro clase de polizas Polizas de banco y polizas comunes
    -- pendiente bancos

    update polizas
       set concepto_poliza = 'CANCELADO '||CURRENT_DATE||' '||CURRENT_USER
     where polizaid=ppolizaid;

    update movipolizas
       set debe = 0,
           haber = 0,
           descripcion = 'CANCELADO '||CURRENT_DATE||' '||CURRENT_USER
     where polizaid=ppolizaid;

  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cancelapoliza(integer) OWNER TO sistema;

--
-- Name: cancelapoliza(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cancelapoliza(integer, character) RETURNS integer
    AS $_$
declare
  ppolizaid alias for $1;
  plogin alias for $2;

  pmovicajaid int4;
  ptipomovimientoid char(2);
  pfechamov date;

  lprestamoid int4;
  fcapital numeric;
  pfechaant date;
  pfecha_otorga date;
  fAbono numeric;
  fAplicar numeric;
  amor record;

  linversionid int4;
  fdeposito numeric;
  fretiroi  numeric;
  fretiroc  numeric;
  scuentapasivo   char(24);
  scuentaintinver char(24);

  pejercicio int4;
  pperiodo int4;


begin

  select ejercicio,periodo
    into pejercicio,pperiodo
    from polizas
   where polizaid = ppolizaid;

   if periodovalido(pejercicio,pperiodo)=0 then
     raise exception 'El periodo % del Ejercicio % se encuentra CERRADO !!!',pperiodo,pejercicio;
   end if;


  select movicajaid,tipomovimientoid,prestamoid,inversionid
    into pmovicajaid,ptipomovimientoid,lprestamoid,linversionid
    from movicaja
   where polizaid=ppolizaid;
 
  if FOUND and ptipomovimientoid<>'00' and ptipomovimientoid<>'IN' then

    --
    -- Movimientos normales en caja
    --
    update polizas
       set concepto_poliza = substr('CANCELADO '||CURRENT_DATE||' '||plogin,1,29)
       where polizaid=ppolizaid;

    update movipolizas
       set debe=0,
           haber=0,
           descripcion=substr('CANCELADO '||CURRENT_DATE||' '||plogin,1,29)
     where polizaid=ppolizaid;

    update movicaja
       set estatusmovicaja='C'
     where movicajaid=pmovicajaid;

  end if;

  if FOUND and ptipomovimientoid='00' or ptipomovimientoid='IN' then

    select fechapoliza
      into pfechamov
      from polizas
     where polizaid = ppolizaid;

    if ptipomovimientoid='00' then
      --
      -- Movimientos de prestamo
      --

      --
      -- Buscar el abono de capital para el prestamo
      --
      select sum(m.haber)
        into fcapital
        from prestamos p, tipoprestamo tp, movipolizas m
       where p.prestamoid = lprestamoid and
             tp.tipoprestamoid = p.tipoprestamoid and
             m.polizaid = ppolizaid and
             m.cuentaid = tp.cuentaactivo;

      fcapital := coalesce(fcapital,0);

      --
      -- Buscar la fecha de abono anterior
      --
      select max(p.fechapoliza)
        into pfechaant
        from movicaja m, polizas p
       where m.prestamoid = lprestamoid and
             p.polizaid = m.polizaid and
             p.fechapoliza < pfechamov;

      select fecha_otorga
        into pfecha_otorga
        from prestamos
       where prestamoid = lprestamoid;

      pfechaant := coalesce(pfechaant,pfecha_otorga);

      update prestamos
         set saldoprestamo = saldoprestamo + fcapital,
             fechaultimopago = pfechaant,
             claveestadocredito = '001'
       where prestamoid=lprestamoid;

      if fcapital>0 then
        --
        -- Regresar Amortizaciones a su estatus anterior
        --

        fAbono := fcapital;

        for amor in
            select *
              from amortizaciones
             where prestamoid=lprestamoid
          order by fechadepago desc
        loop
        
          fAplicar := amor.abonopagado;
          if fAplicar>0 then
            if fAbono>=fAplicar then
              update amortizaciones
                 set abonopagado = abonopagado - fAplicar,
                     ultimoabono = pfechaant
               where amortizacionid=amor.amortizacionid;
               fAbono := fAbono - fAplicar;
            else
              if fAbono>0 then
                update amortizaciones
                   set abonopagado = abonopagado-fAbono,
                       ultimoabono = pfechaant
                 where amortizacionid=amor.amortizacionid;
                 fAbono := 0;
              end if;
            end if;
          end if;
        end loop;

      end if;

      update polizas
         set concepto_poliza = substr('CANCELADO '||CURRENT_DATE||' '||plogin,1,29)
       where polizaid=ppolizaid;

      update movipolizas
         set debe = 0,
             haber = 0,
             descripcion = substr('CANCELADO '||CURRENT_DATE||' '||plogin,1,29)
       where polizaid=ppolizaid;

      update movicaja
         set estatusmovicaja='C'
       where movicajaid=pmovicajaid;

    else
      --
      -- Movimientos de inversion
      --

      select t.cuentapasivo, t.cuentaintinver
        into scuentapasivo, scuentaintinver
        from inversion i, tipoinversion t
       where i.inversionid = linversionid and
             t.tipoinversionid = i.tipoinversionid;

      --
      -- Verificar si es retiro o deposito
      --
      select sum(m.debe), sum(m.haber)
        into fretiroc, fdeposito
        from movipolizas m
       where m.polizaid = ppolizaid and
             m.cuentaid = scuentapasivo;

      fretiroc   := coalesce(fretiroc,0);
      fdeposito  := coalesce(fdeposito,0);

      if fdeposito>0 or fretiroc>0 then
        if fdeposito>0 then
          update inversion
             set depositoinversion=depositoinversion-fdeposito
           where inversionid=linversionid;

        else
          update inversion
             set retiroinversion=retiroinversion-fretiroc,
                 fechapagoinversion=fechapagoanterior
           where inversionid=linversionid;
        end if;


        update polizas
           set concepto_poliza = substr('CANCELADO '||CURRENT_DATE||' '||plogin,1,29)
         where polizaid=ppolizaid;

        update movipolizas
           set debe = 0,
               haber = 0,
               descripcion = substr('CANCELADO '||CURRENT_DATE||' '||plogin,1,29)
         where polizaid=ppolizaid;

        update movicaja
           set estatusmovicaja='C'
         where movicajaid=pmovicajaid;

      else
        -- Se trata de un retiro de interes
        select sum(m.debe)
          into fretiroi
          from movipolizas m
         where m.polizaid = ppolizaid and
               m.cuentaid = scuentaintinver;

        fretiroi := coalesce(fretiroi,0);

        if fretiroi>0 then



          update inversion
             set fechapagoinversion=fechapagoanterior
           where inversionid=linversionid;

          update polizas
             set concepto_poliza = substr('CANCELADO '||CURRENT_DATE||' '||plogin,1,29)
           where polizaid=ppolizaid;

          update movipolizas
             set debe = 0,
                 haber = 0,
                 descripcion = substr('CANCELADO '||CURRENT_DATE||' '||plogin,1,29)
           where polizaid=ppolizaid;

          update movicaja
             set estatusmovicaja='C'
           where movicajaid=pmovicajaid;

        end if;

      end if;
  
    end if;

  end if;

  if NOT FOUND then
    --
    -- Otro clase de polizas Polizas de banco y polizas comunes
    -- pendiente bancos

    update polizas
       set concepto_poliza = substr('CANCELADO '||CURRENT_DATE||' '||plogin,1,29)
     where polizaid=ppolizaid;

    update movipolizas
       set debe = 0,
           haber = 0,
           descripcion = substr('CANCELADO '||CURRENT_DATE||' '||plogin,1,29)
     where polizaid=ppolizaid;

  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cancelapoliza(integer, character) OWNER TO sistema;

--
-- Name: capitalvencido(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION capitalvencido(integer, date) RETURNS double precision
    AS $_$
declare
  lprestamoid alias for $1;
  dfechapago  alias for $2;

  rec record;
  amor record;

  famortizacion numeric;
  fvencidas     numeric;
  idiasint      integer;
  fcapital      numeric;
  finteres      numeric;
  fmoratorio    numeric;
  fiva          numeric;
  ftotal        numeric;

  fmontoprestamo   numeric;
  fsaldoprestamo   numeric;
  dfechaultimopago date;
  ftasanormal      numeric;
  ftasa_moratoria  numeric;
  dfecha_otorga    date;
  dfecha_1er_pago  date;

  fsaldoinsoluto   numeric;

  saplicaiva       char(1);
  sformula text;
  icalculonormalid int4;
  icalculomoratorioid int4;

  finteresminimo numeric;

  itantos int4;
  freciprocidad numeric;

  dultimoabono date;

begin

  famortizacion := 0;
  fvencidas     := 0;
  idiasint      := 0;
  fcapital      := 0;
  finteres      := 0;
  fmoratorio    := 0;
  fiva          := 0;
  ftotal        := 0;

  select interesminimo
    into finteresminimo
    from empresa
   where empresaid=1;
  finteresminimo := coalesce(finteresminimo,0);

  select p.montoprestamo,p.saldoprestamo,p.tasanormal,p.tasa_moratoria,p.fecha_otorga,p.fecha_1er_pago,
         tp.aplicaivaprestamo,p.calculonormalid,p.calculomoratorioid,tp.tantos
    into fmontoprestamo,fsaldoprestamo,ftasanormal,ftasa_moratoria,dfecha_otorga,dfecha_1er_pago,
         saplicaiva,icalculonormalid,icalculomoratorioid,itantos
    from prestamos p, tipoprestamo tp
   where p.prestamoid=lprestamoid and
         tp.tipoprestamoid = p.tipoprestamoid;

   itantos:=coalesce(itantos,1);
   if itantos>0 then
     freciprocidad := fmontoprestamo/itantos;
   else
     freciprocidad := fmontoprestamo;
   end if;

--
-- Validar que el saldo insoluto del prestamo se encuentre calculado correctamente
--
--  select fmontoprestamo-coalesce(sum(capitalpagoprestammo),0)
--    into fsaldoinsoluto
--    from pagoprestamo
--   where prestamoid=lprestamoid;

   fsaldoinsoluto := fsaldoprestamo;

   if fsaldoprestamo<>fsaldoinsoluto then
     raise exception 'Error Saldos, verifique saldos del prestamo ... % %',fsaldoprestamo,fsaldoinsoluto;
   end if;

--
-- Fecha de ultimo pago, donde pago a capital o interes normal
--
  select coalesce(MAX(fechaultimopago),dfecha_otorga)
    into dfechaultimopago
    from prestamos
   where prestamoid=lprestamoid;


   --
   -- Verificar la fecha de ultimo abono
   -- en caso de estar erronea correguirla
   --
   select max(p.fechapoliza)
     into dultimoabono
     from movicaja mc,polizas p, movipolizas m
    where mc.prestamoid = lprestamoid and             
          p.polizaid = mc.polizaid and
          m.movipolizaid = mc.movipolizaid and
          mc.estatusmovicaja='A' and
          mc.tipomovimientoid='00' and
          m.debe+m.haber>0;

   dultimoabono := coalesce(dultimoabono,dfechaultimopago);

--raise notice 'ult. abo. % - ult. pag. %',dultimoabono,dfechaultimopago;
   if dultimoabono>dfechaultimopago then

     dfechaultimopago := dultimoabono;
     update prestamos
        set fechaultimopago = dultimoabono
      where prestamoid = lprestamoid;

   end if;

--
-- Buscar amortizacion actual
--
   select coalesce(SUM(importeamortizacion-abonopagado),0.00)
     into famortizacion
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago=dfechapago and importeamortizacion-abonopagado>0;
    
--
-- Buscar amortizaciones vencidas
--
   select coalesce(SUM(round(importeamortizacion-abonopagado,2)),0.00)
     into fvencidas
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<dfechapago and importeamortizacion-abonopagado>0;

--raise exception ' Vencidas % ',fvencidas;

  idiasint := dfechapago - dfechaultimopago;
  fcapital := round( famortizacion + fvencidas, 2);
  
  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    --idiasint := idiasint + 1;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;


return round(fcapital,2);
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.capitalvencido(integer, date) OWNER TO sistema;

--
-- Name: captaciontotal(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION captaciontotal(date) RETURNS SETOF tresumencaptacion
    AS $_$
declare
  r tresumencaptacion%rowtype;
  pfecha alias for $1;
  psucursal char(4);

  dfechai date;
  idiasanuales int;
  isocioid  int4;

begin

    select diasanualesinversion,sucid into idiasanuales,psucursal
      from empresa where empresaid=1;

    -- Inicio de mes
    dfechai := pfecha - cast(extract(day from pfecha)-1 as integer);
    raise notice 'Fecha inicio de mes %',dfechai;

    for r in
      select * from resumencaptacion(pfecha,psucursal)
    loop
      return next r;
    end loop;

    for r in
      select pfecha,psucursal,t.desctipomovimiento,s.clavesocioint,
             su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
             0 as inversionid, pfecha as fechainversion,
             pfecha+1 as fechavencimiento, t.tasainteres, 1 as plazo,
             sum(mp.debe)-sum(mp.haber) as deposito, 1 as diasvencimiento,
             1 as formapagorendimiento,(case when mc.tipomovimientoid<>'IN' and t.aplicasaldo='S' then intdevengadomensual(s.clavesocioint,pfecha,mc.tipomovimientoid) else 0 end) as  intdevmensual,
        0 as intdevacumulado,
        0 as saldototal,
        0 as saldopromedio,
        pfecha as fechapagoinversion,mc.tipomovimientoid,tm.cuentadeposito,d.ciudadmexid,s.socioid,(select grupo from solicitudingreso where socioid=s.socioid) as grupo
        from movicaja mc, movipolizas mp, polizas p, socio s,
             tipomovimiento t, sujeto su, domicilio d, tipomovimiento tm
       where mc.tipomovimientoid in (select tipomovimientoid from tipomovimiento where tipomovimientoid<>'IN' and aplicasaldo='S') and
             p.polizaid = mc.polizaid and             
             p.fechapoliza<=pfecha and
             mp.movipolizaid=mc.movipolizaid and     
             s.socioid = mc.socioid and
             t.tipomovimientoid = mc.tipomovimientoid and
             su.sujetoid = s.sujetoid and 
             d.sujetoid = su.sujetoid and 
             tm.tipomovimientoid = mc.tipomovimientoid
      group by t.desctipomovimiento,s.clavesocioint,su.nombre,
               su.paterno,su.materno,t.tasainteres,mc.tipomovimientoid,t.aplicasaldo,tm.cuentadeposito,d.ciudadmexid,s.socioid
      having sum(mp.debe)-sum(mp.haber)<>0 or (case when mc.tipomovimientoid<>'IN' and t.aplicasaldo='S' then intdevengadomensual(s.clavesocioint,pfecha,mc.tipomovimientoid) else 0 end) <> 0
    loop
      if r.tipomovimientoid in (select tipomovimientoid from tipomovimiento where tipomovimientoid<>'IN' and aplicasaldo='S') then
         r.saldototal:=r.deposito+r.intdevacumulado;
         select socioid into isocioid from socio where clavesocioint=r.clavesocioint;
         r.saldopromedio := saldopromedio(isocioid,dfechai,pfecha,r.tipomovimientoid);

      end if;
      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.captaciontotal(date) OWNER TO sistema;

--
-- Name: captaciontotalc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION captaciontotalc(date) RETURNS SETOF tresumencaptacion
    AS $_$
declare

  pfecha alias for $1;
  r tresumencaptacion%rowtype;
  f record;
  dblink1 text;
  dblink2 text;

begin


for f in
 select * from sucursales where vigente='S'
 loop

  raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

  dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
  dblink2:='set search_path to public,'||f.esquema||';select * from captaciontotal('||''''||pfecha||''''||');';

  for r in
    select * from
    dblink(dblink1,dblink2) as t(fechadegeneracion date,
    sucursal           char(4),
    desctipoinversion  char(30),
    clavesocioint      char(18),
    nombresocio        varchar(80),
    inversionid        int4,
    fechainversion     date,
    fechavencimiento   date,
    tasainteresnormalinversion numeric,
    plazo              int4,
    deposito           numeric,
    diasvencimiento    int4,
    formapagorendimiento int4,
    intdevmensual      numeric,
    intdevacumulado    numeric,
    saldototal         numeric,
    saldopromedio      numeric,
    fechapagoinversion date,
    tipomovimientoid char(2),
    cuentaid         char(24),
    localidad        integer,
    socioid          int4,
    grupo            char(25))

  loop
    return next r;
  end loop;

end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.captaciontotalc(date) OWNER TO sistema;

--
-- Name: captacnbv(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION captacnbv(date) RETURNS SETOF tcaptacnbv
    AS $_$
declare

  r tcaptacnbv%rowtype;
  pfecha alias for $1;
--  psucursal alias for $2;

  dfechai date;
  idiasanuales int;
  pdiafecha numeric;

begin

    select diasanualesinversion into idiasanuales
      from empresa where empresaid=1;

    -- Inicio de mes
    dfechai := pfecha - cast(extract(day from pfecha)-1 as integer);
    raise notice 'Fecha inicio de mes %',dfechai;

    for r in

 select s.clavesocioint,
        su.nombre||' '||su.paterno||' '||su.materno as nombresocio,t.desctipoinversion,
        mc.inversionid, i.fechainversion, i.fechavencimiento,
        i.tasainteresnormalinversion, t.plazo, sum(mp.haber)-sum(mp.debe) AS deposito,
        (case when i.fechavencimiento-pfecha>0
              then i.fechavencimiento-pfecha
              else 0 end),
        t.plazo as formapagorendimiento,       
        i.tipoinversionid
   from movicaja mc, socio s, polizas p, movipolizas mp, inversion i,
        tipoinversion t,sujeto su
  where mc.inversionid is not null and        
        s.socioid = mc.socioid and        
        p.polizaid = mc.polizaid and        
        p.fechapoliza<pfecha+1 and
        i.inversionid = mc.inversionid and
        i.fechainversion<pfecha+1 and
--        i.fechavencimiento>dfechai-1 and    
        t.tipoinversionid = i.tipoinversionid and
        mp.polizaid =mc.polizaid and
        mp.cuentaid = t.cuentapasivo and
        su.sujetoid = s.sujetoid 
group by s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno, t.desctipoinversion,mc.inversionid, i.fechainversion,i.fechavencimiento,i.tasainteresnormalinversion, t.plazo,i.fechapagoinversion,i.tipoinversionid
having  sum(mp.haber)-sum(mp.debe)<>0       
order by sum(mp.haber)-sum(mp.debe)

    loop
    
      return next r;

    end loop;

 for r in
      select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombresocio,t.desctipomovimiento,
             0 as inversionid, pfecha as fechainversion,
             pfecha+1 as fechavencimiento, t.tasainteres, 1 as plazo,
             sum(mp.debe)-sum(mp.haber) as deposito, 1 as diasvencimiento,
             1 as formapagorendimiento,mc.tipomovimientoid
        from movicaja mc, movipolizas mp, polizas p, socio s,
             tipomovimiento t, sujeto su
       where (mc.tipomovimientoid='AA' or mc.tipomovimientoid='DV' or mc.tipomovimientoid='CU' or mc.tipomovimientoid='AM' or mc.tipomovimientoid='SE'  ) and
             p.polizaid = mc.polizaid and             
             p.fechapoliza<=pfecha and
             mp.movipolizaid=mc.movipolizaid and     
             s.socioid = mc.socioid and
             t.tipomovimientoid = mc.tipomovimientoid and
             su.sujetoid = s.sujetoid
      group by s.clavesocioint,su.nombre,
               su.paterno,su.materno,t.desctipomovimiento,t.tasainteres,mc.tipomovimientoid
      having sum(mp.debe)-sum(mp.haber)<>0
    loop     
      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.captacnbv(date) OWNER TO sistema;

--
-- Name: carteracnbv(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION carteracnbv(date) RETURNS SETOF tcarteracnbv
    AS $_$
declare
  pfecha alias for $1;

  pejercicio int4;
  pperiodo int4;

  r tcarteracnbv%rowtype;

begin

 pperiodo:=cast(date_part('month',pfecha) as int);
 pejercicio:=cast(date_part('year',pfecha) as int);

for r in 

select s.clavesocioint,pr.referenciaprestamo,p.ejercicio,p.periodo, 
                        p.fechacierre,p.diasvencidos,p.porcentajeaplicado,
                        p.factoraplicado,p.saldoprestamo,p.reservacalculada,
                        p.interesdevengadomenoravencido,                    
                        p.interesdevengadomayoravencido,p.pagocapitalenperiodo,
                        p.pagointeresenperiodo,p.pagomoratorioenperiodo,       
                        p.bonificacionintenperiodo,p.bonificacionmorenperiodo, 
                        p.noamorvencidas,p.saldovencidomenoravencido,          
                        p.saldovencidomayoravencido,p.fechaultamorpagada,      
                        finalidaddefault(pr.tipoprestamoid),p.montoprestamo,pr.fecha_vencimiento, 
                        t.tantos,                                                    
                        0 as depositogarantia, 
                        pr.tasanormal,pr.tasa_moratoria,                             
                        su.nombre||' '||su.paterno||' '|| su.materno AS nombresocio, 
                        d.calle,d.numero_ext,d.colonia,d.comunidad,d.codpostal,      
                        c.nombreciudadmex,p.ultimoabono,p.diastraspasoavencida,      
                        p.ultimoabonointeres,pr.numero_de_amor,pr.fecha_otorga,      
                        f.descripcionfinalidad,                                      
                        (case when p.fecha_vencimiento>p.fechacierre and             
                                   p.saldoprestamo>0                                 
                              then p.fecha_vencimiento-p.fechacierre                 
                              else 0 end) as diasrestantes,                          
          round((pr.fecha_vencimiento-pr.fecha_otorga)/(pr.numero_de_amor*0.1/0.1)), 
                        interesdevmormenor,interesdevmormayor, 
                        (case when pr.numero_de_amor > 1 then 'Pago periodico' else  
                        'Pago Unico' end) as condicionpago,                          
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid not in ('T1','T2','T3','R1','R2','R3') then 'Normal' else                     
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid not in ('T1','T2','T3','R1','R2','R3') then 'Normal' else                      
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('T1','T2','T3') then 'Reestructurado' else                                
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('T1','T2','T3') then 'Reestructurado ' else                                
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('R1','R2','R3') then 'Renovado' else                                      
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('R1','R2','R3') then 'Renovado' end) end) end) end) end) end) as estacion,pr.dias_de_cobro,pr.prestamodescontado,                         
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid not in ('T1','T2','T3','R1','R2','R3') then 'Vigente' else                    
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid not in ('T1','T2','T3','R1','R2','R3') then 'Vencido' else                     
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('T1','T2','T3') then 'Vigente' else                                
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('T1','T2','T3') then 'Vencido' else                                 
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('R1','R2','R3') then 'Vigente' else                                
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('R1','R2','R3') then 'Vencido' end) end) end) end) end) end) as estacion1,pr.norenovaciones,pr.clavegarantia,pr.monto_garantia,devengadoanterior(p.prestamoid,pfecha),(case when  p.diasvencidos <= p.diastraspasoavencida then interesdevengadomenoravencido+interesdevmormenor else 0 end) as devengadovigente,(case when  p.diasvencidos > p.diastraspasoavencida then interesdevengadomenoravencido+interesdevmormenor else 0 end) as devengadovencido, buscapartesocial(pr.socioid,pfecha) as parte from precorte p,prestamos pr,socio s,tipoprestamo t, sujeto su,    
                        domicilio d, ciudadesmex c, finalidades f                     
                  where p.ejercicio=pejercicio and p.periodo=pperiodo and                         
                        pr.prestamoid=p.prestamoid and s.socioid=pr.socioid and      
                        t.tipoprestamoid = pr.tipoprestamoid and                     
                        su.sujetoid=s.sujetoid and d.sujetoid=s.sujetoid and         
                        c.ciudadmexid = d.ciudadmexid and                            
                        f.clavefinalidad=p.clavefinalidad                            
              order by p.diasvencidos,s.clavesocioint

 loop
   return next r;
 end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.carteracnbv(date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: carteracomunidadfecha; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE carteracomunidadfecha (
    carteraid integer NOT NULL,
    fechadegeneracion date,
    prestamoid integer,
    clavesocioint character(15),
    grupo character(25),
    referenciaprestamo character(18),
    tipoprestamo character(3),
    nombre character varying(80),
    direccion character varying(80),
    colonia character varying(80),
    telefono character varying(20),
    comunidad character varying(60),
    rfc character(16),
    curp character(20),
    sexo character(3),
    totalingresos numeric,
    ocupacion character varying(60),
    finalidaddefault character varying(30),
    finalidadcredito character varying(30),
    fecha_otorga date,
    fecha_vencimiento date,
    fecha_ultimopago date,
    fecha_nacimiento date,
    mesesavencer numeric,
    montoprestamo numeric,
    saldoprest numeric,
    cantidadpagada numeric,
    diasatraso integer,
    amortizacion numeric,
    capital numeric,
    interes numeric,
    moratorio numeric,
    iva numeric,
    vencidas integer,
    caval1 character(15),
    nombreaval1 character varying(80),
    direccionaval1 character varying(130),
    caval2 character(15),
    nombreaval2 character varying(80),
    direccionaval2 character varying(130),
    caval3 character(15),
    nombreaval3 character varying(80),
    direccionaval3 character varying(130),
    caval4 character(15),
    nombreaval4 character varying(80),
    direccionaval4 character varying(130),
    promotorid character(20)
);


ALTER TABLE sucursal1.carteracomunidadfecha OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: carteracomunidadfechac(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION carteracomunidadfechac(date) RETURNS SETOF sucursal1.carteracomunidadfecha
    AS $_$
declare
  pfecha alias for $1;

  r carteracomunidadfecha%rowtype;
  f record;
  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
        dblink2:='set search_path to public,'||f.esquema||';select * from carteracomunidadfecha where fechadegeneracion='||''''||pfecha||''''||';' ;

--        raise notice 'dblink % % ',dblink1,dblink2;

        for r in
        SELECT * FROM
        dblink(dblink1,dblink2) as
               t2(
 carteraid            int4,
 fechadegeneracion    date,
 prestamoid           int4,
 clavesocioint        character(15),
 grupo                character(25),
 referenciaprestamo   character(18),
 tipoprestamo         character(3),
 nombre               character varying(80),
 direccion            character varying(80),
 colonia              character varying(80),
 telefono             character varying(20),
 comunidad            character varying(60),
 rfc                  character(16),
 curp                 character(20),
 sexo                 character(3),
 totalingresos        numeric,
 ocupacion            character varying(60),
 finalidaddefault     character varying(30),
 finalidadcredito     character varying(30),
 fecha_otorga         date,
 fecha_vencimiento    date,
 fecha_ultimopago     date,
 fecha_nacimiento     date,
 mesesavencer         numeric,
 montoprestamo        numeric,
 saldoprest           numeric,
 cantidadpagada       numeric,
 diasatraso           integer,
 amortizacion         numeric,
 capital              numeric,
 interes              numeric,
 moratorio            numeric,
 iva                  numeric,
 vencidas             integer,
 caval1               character(15),
 nombreaval1          character varying(80),
 direccionaval1       character varying(130),
 caval2               character(15),
 nombreaval2          character varying(80),
 direccionaval2       character varying(130),
 caval3               character(15),
 nombreaval3          character varying(80),
 direccionaval3       character varying(130),
 caval4               character(15),
 nombreaval4          character varying(80),
 direccionaval4       character varying(130),
 promotorid           character(20)
)

 loop
   return next r;
 end loop;

 end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.carteracomunidadfechac(date) OWNER TO sistema;

--
-- Name: carteracrediticiac(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION carteracrediticiac(integer, integer) RETURNS SETOF tcarteracrediticia
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo   alias for $2;

  r tcarteracrediticia%rowtype;

 f record;
  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop

  raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

  dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
  dblink2:='set search_path to public,'||f.esquema||';
     select s.clavesocioint,pr.referenciaprestamo,p.ejercicio,p.periodo,p.fechacierre,
            p.diasvencidos,p.porcentajeaplicado,p.factoraplicado,p.saldoprestamo,
            p.reservacalculada,p.interesdevengadomenoravencido,
            p.interesdevengadomayoravencido,p.pagocapitalenperiodo,
            p.pagointeresenperiodo,p.pagomoratorioenperiodo,
            p.bonificacionintenperiodo,p.bonificacionmorenperiodo,
            p.noamorvencidas,p.saldovencidomenoravencido,p.saldovencidomayoravencido,
            p.fechaultamorpagada,finalidaddefault(pr.tipoprestamoid),p.montoprestamo,pr.fecha_vencimiento,
            t.tantos,p.depositogarantia,
            pr.tasanormal,pr.tasa_moratoria,
            fnombresocio(su.nombre,su.paterno,su.materno) AS nombresocio,
            d.calle,d.numero_ext,d.colonia,d.comunidad,d.codpostal,c.nombreciudadmex,
            p.ultimoabono,p.diastraspasoavencida,p.ultimoabonointeres,
            pr.numero_de_amor, pr.fecha_otorga, f.descripcionfinalidad,
            (case when p.fecha_vencimiento>p.fechacierre and
                       p.saldoprestamo>0
                  then p.fecha_vencimiento-p.fechacierre
                  else 0 end) as diasrestantes,
            (case when p.dias_de_cobro > 0 then p.dias_de_cobro else p.meses_de_cobro*30 end),
            interesdevmormenor,interesdevmormayor,
                        (case when pr.numero_de_amor > 1 then '||''''||'Pagos periodicos de principal e intereses'||''''||' else '||''''||'Pago Unico de principal e intereses '||''''||' end) as condicionpago,
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid not in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||','||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Normal'||''''||' else
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid not in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||','||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Normal'||''''||' else
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||') then '||''''||'Reestructurado'||''''||' else
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||') then '||''''||'Reestructurado'||''''||' else
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Renovado'||''''||' else
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Renovado'||''''||' end) end) end) end) end) end) as estacion,(case when p.dias_de_cobro > 0 then p.dias_de_cobro else p.meses_de_cobro*30 end),pr.prestamodescontado,
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid not in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||','||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Vigente'||''''||' else
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid not in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||','||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Vencido'||''''||' else
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||') then '||''''||'Vigente'||''''||' else
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||') then '||''''||'Vencido'||''''||' else
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Vigente'||''''||' else
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Vencido'||''''||' end) end) end) end) end) end) as estacion1,pr.norenovaciones,pr.clavegarantia,pr.monto_garantia,devengadoanterior(p.prestamoid,p.fechacierre) as interesanterior,(case when  p.diasvencidos <= p.diastraspasoavencida then interesdevengadomenoravencido+interesdevmormenor else 0 end) as devengadovigente,
                        (case when  p.diasvencidos > p.diastraspasoavencida then interesdevengadomenoravencido+interesdevmormenor else 0 end) as devengadovencido,p.primerincumplimiento,pr.fecha_1er_pago,
                        su.rfc,
                        pr.fechavaluaciongarantia,
                        (select coalesce(count(avalid),0) from avales where prestamoid=p.prestamoid) as numeroavales,
                        pr.sujetoid as sujetoidrelacionado,
                        t.cuentaactivo as clasificacioncontable,(case when p.pagosvencidos = 0 then '||''''||'Sin pagos vencidos'||''''||' else (case when p.pagosvencidos = 1 then '||''''||'Con pagos vencidos'||''''||' else '||''''||'Cobranza administrativa'||''''||' end) end),(case when si.personajuridicaid = 0 then '||''''||'FISICA'||''''||' else  '||''''||'MORAL'||''''||' end),p.reservaidnc,p.diascapital,p.diasinteres

      from precorte p,prestamos pr,socio s,tipoprestamo t, sujeto su, solicitudingreso si, domicilio d,
           ciudadesmex c, finalidades f
     where p.ejercicio='||pejercicio||' and p.periodo='||pperiodo||' and pr.prestamoid=p.prestamoid and
           s.socioid=pr.socioid and t.tipoprestamoid = pr.tipoprestamoid and
           su.sujetoid=s.sujetoid and s.socioid=si.socioid and d.sujetoid=s.sujetoid and
           c.ciudadmexid = d.ciudadmexid and f.clavefinalidad=p.clavefinalidad
  order by p.diasvencidos,s.clavesocioint;';

  for r in
   select * from
    dblink(dblink1,dblink2) as 
t (
 clavesocioint      char(15),
 referenciaprestamo char(18),
 ejercicio          int4,
 periodo            int4,
 fechacierre        date,
 diasvencidos       int4,
 porcentajeaplicado numeric,
 factoraplicado     numeric,
 saldoprestamo      numeric,
 reservacalculada   numeric,
 interesdevengadomenoravencido numeric,
 interesdevengadomayoravencido numeric,
 pagocapitalenperiodo numeric,
 pagointeresenperiodo numeric,
 pagomoratorioenperiodo numeric,
 bonificacionenperiodo numeric,
 bonificacionmorenperiodo numeric,
 noamorvencidas     int4,
 saldovencidomernoavencido numeric,
 saldovencidomayoravencido numeric,
 fechaultamorpagada date,
 desctipoprestamo   char(30),
 montoprestamo      numeric,
 fecha_vencimiento  date,
 tantos             int4,
 depositogarantia   numeric,
 tasanormal         numeric,
 tasa_moratoria     numeric,
 nombresocio        char(82),
 calle              varchar(30),
 numero_ext         varchar(15),
 colonia            varchar(50),
 comunidad          varchar(50),
 codpostal          int4,
 nombreciudadmex    varchar(50),
 ultimoabono        date,
 diastraspasoavencida int4,
 ultimoabonointeres   date,
 numero_de_amor       int4,
 fecha_otorga         date,
 descripcionfinalidad varchar(30),
 diasrestantes        int4,
 frecuencia           numeric,
 interesdevmormenor   numeric,
 interesdevmormayor   numeric,
 condiciones         varchar(50),
 estacion            varchar(30),
 dias_cobro          int4,
 prestamodescontado  char(2),
 estacion1            varchar(30),
 norenovaciones       int4,
 clavegarantia        char(3),
 monto_garantia        numeric,
 interesanterior      numeric,
 devengadovigente     numeric,
 devengadovencido     numeric,
 primerincumplimiento date,
 fecha_1er_pago date, rfc    character(16),
 fechavaluaciongarantia date,
 numeroavales   integer,
 sujetoidrelacionado integer,
 clasificacioncontable varchar(24),
 tipocobranza varchar(50),
 personajuridica varchar(10),reservaidnc numeric,
 diascapital integer,
 diasinteres integer)

  loop

    return next r;

  end loop;


end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.carteracrediticiac(integer, integer) OWNER TO sistema;

--
-- Name: carterafederacion(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION carterafederacion(date) RETURNS SETOF tcarterafederacion
    AS $_$
declare
  pfechacierre alias for $1;

  r tcarterafederacion%rowtype;


  pejercicio integer;
  pperiodo  integer;
  fReserva numeric;
  fReservaint numeric;
  fEstimada numeric;
  fReserva100 numeric;
  prorratea numeric;

begin


 pejercicio:=date_part('year',pfechacierre);
 pperiodo:=date_part('month',pfechacierre);

select saldoinicialperiodo+cargosdelperiodo-abonosdelperiodo into fReserva from saldos where ejercicio=pejercicio and periodo=pperiodo and cuentaid='1303';

fReserva:=coalesce(fReserva,0);
fReserva:=fReserva*-1; 

select coalesce(sum(reservaidnc),0),coalesce(sum(reservacalculada),0) into fReservaint,fEstimada from precorte where ejercicio=pejercicio and periodo=pperiodo;
        
fReserva100:=fReservaint+fEstimada;
if fReserva100 <> 0 then 
        prorratea:=fReserva/fReserva100;
else
        prorratea:=0;
end if;

raise notice ' Prorratea %  %  %  %  % ',prorratea,fReservaint,fEstimada,fReserva,fReserva100;

for r in
select





--Sucursal 
(select sucid from empresa where empresaid=1),
--Numero_de_Socio 
s.clavesocioint,
--Nombre_del_Acreditado 
fnombresocio(su.nombre,su.paterno,su.materno),
--No_de_Contrato
pr.referenciaprestamo,
--tepoprestamoid
pr.tipoprestamoid,
--Tipo_de_Producto
t.desctipoprestamo,
--Tipo_de_Credito 
finalidaddefault(pr.tipoprestamoid),
--Condiciones_de_pago 
--ok--(case when pr.numero_de_amor > 1 then 'Pago periodico' else 'Pago Unico'end),
--Fecha_de_Otorgamiento 
pr.fecha_otorga,
--Monto_Original 
pr.montoprestamo,
--Fecha_de_Vencimiento 
pr.fecha_vencimiento,
--Tasa_ordinaria_nominal_anual 
pr.tasanormal,
--Tasa_Moratoria_nominal_anual
pr.tasa_moratoria,
--No_de_Pagos_Programados 
pr.numero_de_amor,
--Frecuencia 
--round((pr.fecha_vencimiento-pr.fecha_otorga)/(pr.numero_de_amor*0.1/0.1)),
p.dias_de_cobro,



--Dias_de_mora 
p.diasvencidos,
--Capital_vigente 
p.saldovencidomenoravencido,
--Capital_vencido 
p.saldovencidomayoravencido,
--Intereses_devengados_no_cobrados_vigente 
--ok--(case when  p.diasvencidos <= p.diastraspasoavencida then interesdevengadomenoravencido else 0 end),
--Intereses_devengados_no_cobrados_vigente_mora
--ok--(case when  p.diasvencidos <= p.diastraspasoavencida then interesdevmormenor else 0 end),
--Intereses_devengados_no_cobrados_vencido 
--ok--(case when  p.diasvencidos > p.diastraspasoavencida then interesdevengadomenoravencido else 0 end),
--Intereses_devengados_no_cobrados_vencido_mora
--ok--(case when  p.diasvencidos > p.diastraspasoavencida then interesdevmormenor else 0 end),
--Intereses_devengados_no_cobrados_Cuentas_orden 
--ok--round(p.interesdevengadomayoravencido,2),
--Intereses_devengados_no_cobrados_Cuentas_orden_mora 
--ok--round(interesdevmormayor,2),
--Saldo_Promedio
--ok--p.saldopromediodelmes,
--Interes_del_Mes
--ok--p.interesdevengadomes+p.pagointeresenperiodo,
--REQ_EPRC_SIN_INT_CAVE 
--ok--round(p.reservacalculada,2),
--REQ_EPRC_INT CAVE 
--ok--round(p.reservaidnc,2),
--EPRC_creada_sin_int_CAVE 
--ok--round(p.reservacalculada*prorratea,2),
--EPRC_INT_CAVE
--ok--0,
--Insuficiencia_req_EPRC
--ok--round(p.reservacalculada-(p.reservacalculada*prorratea),2),
--Microcredito
--ok--'NO',
--Zona_marginada
--ok--p.zonamarginada,
--Municipio_del_acreditado 
--ok--c.nombreciudadmex,
--Poblacion_o_ranchera_del_acreditado 
--ok--c.nombreciudadmex,
--Valor_garantia_hipotecaria
--ok--0,
--Debidamente_formalizada 
--ok--'',
--Libre_de_Gravamenes 
--ok--'',
--Asegurado_a_favor_de_la_Sociedad 
--ok--'',
--Avaluo_actualizado 
--ok--'',
--Deposito_en_Garantia_Resguardo 
--ok--pr.monto_garantia,
--CREDITO_REDESCONTADO 
--ok--pr.prestamodescontado,
--Institucion_fuente_de_recursos
--ok--'FIRA',
--Por_Garantia_efectiva_contratada 
--ok--coalesce(pr.porcentajeredescuento,0),
--Parte_cubierta_con_garantia_contratada 
--ok--p.saldoprestamo*(coalesce(pr.porcentajeredescuento,0)/100),
--Parte_cubierta_con_67_de_deposito 
--ok--0,
--Parte_cubierta_con_EPRC_creada 
--ok--round(p.reservacalculada*prorratea,2),
--Parte_expuesta_neta_EPRC
--ok--round(p.saldoprestamo-(p.reservacalculada*prorratea),2),
--Fecha_UltimoPago_de_Capital 
--ok--p.ultimoabono,
--Fecha_Ultimo_Pago_de_Interes
--ok--p.ultimoabonointeres,
--Monto_Ultimo_Pago_de_Capital
--ok--p.pagocapitalenperiodo,
--Monto_ult_pago_Interes_Vigente_vencido 
--ok--p.pagointeresenperiodo,
--ok--(case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid not in ('T1','T2','T3','R1','R2','R3') then 'Vigente' else
--ok--(case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid not in ('T1','T2','T3','R1','R2','R3') then 'Vencido' else
--ok--(case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('T1','T2','T3') then 'Vigente' else (case when p.diasvencidos > --p.diastraspasoavencida and p.tipoprestamoid in ('T1','T2','T3') then 'Vencido' else
--ok--(case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('R1','R2','R3') then 'Vigente' else
--ok--(case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('R1','R2','R3') then 'Vencido' end)
--ok--end) end) end) end) end),
--Renovado_reestructurado_normal
--ok--(case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid not in ('T1','T2','T3','R1','R2','R3') then 'Normal' else
           --ok--(case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid  not in ('T1','T2','T3','R1','R2','R3') then 'Normal' else
           --ok--(case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('T1','T2','T3') then 'Reestructurado' else
           --ok--(case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('T1','T2','T3') then 'Reestructurado' else
           --ok--(case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('R1','R2','R3') then 'Renovado' else
           --ok--(case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('R1','R2','R3') then 'Renovado'end) end) end) end) end) end),
--Num_de_reestructuras 
--ok--pr.norenovaciones,
-- Fecha_cierre
p.fechacierre,
--Categoria_mora
(case when p.diasvencidos = 0 then 'Vigente' else
(case when p.diasvencidos > 0 and p.diasvencidos <= 89 then 'Moroso' else
(case when p.diasvencidos > 89  then 'Vencido' end) end) end)



from precorte p,prestamos pr,socio s,tipoprestamo t, sujeto su,domicilio d,
           ciudadesmex c, finalidades f, colonia cl
     where p.fechacierre=pfechacierre and pr.prestamoid=p.prestamoid and
           s.socioid=pr.socioid and t.tipoprestamoid = pr.tipoprestamoid and
           su.sujetoid=s.sujetoid and d.sujetoid=s.sujetoid and
           c.ciudadmexid = d.ciudadmexid and f.clavefinalidad=p.clavefinalidad and d.coloniaid = cl.coloniaid 
  order by p.diasvencidos,s.clavesocioint

loop 

--if r.CREDITO_REDESCONTADO = 'RD' then

   --r.Institucion_fuente_de_recursos:= 'FIRA';
   --r.Por_Garantia_efectiva_contratada := .50;
   --r.Parte_cubierta_con_garantia_contratada :=round((r.Capital_vigente+r.Capital_vencido)/2,2);

--end if;

return next r;

end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.carterafederacion(date) OWNER TO sistema;

--
-- Name: carterafederacionc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION carterafederacionc(date) RETURNS SETOF tcarterafederacion
    AS $_$
declare
  pfechacierre alias for $1;

  r tcarterafederacion%rowtype;

 f record;

  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
        dblink2:='set search_path to public,'||f.esquema||';select * from  carterafederacion('||''''||to_char(pfechacierre,'yyyy-mm-dd')||''''||');';
        for r in
        SELECT * FROM
        dblink(dblink1,
               dblink2) as
               t2(
Sucursal char(4),
Numero_de_Socio character varying(15),
Nombre_del_Acreditado character varying(82),
No_de_Contrato character varying(18),
Clave_tipoprestamo character varying(3),
Tipo_de_Producto character varying(30),
Tipo_de_Credito character varying(30),
--Condiciones_de_pago character varying(50),
Fecha_de_Otorgamiento date,
Monto_Original numeric,
Fecha_de_Vencimiento date,
Tasa_ordinaria_nominal_anual numeric,
Tasa_Moratoria_nominal_anual numeric,
No_de_Pagos_Programados numeric,
Frecuencia integer,
Dias_de_mora integer,
Capital_vigente numeric,
Capital_vencido numeric,
--Intereses_devengados_no_cobrados_vigente numeric,
--Intereses_devengados_no_cobrados_vigente_mora numeric,
--Intereses_devengados_no_cobrados_vencido numeric,
--Intereses_devengados_no_cobrados_vencido_mora numeric,
--Intereses_devengados_no_cobrados_Cuentas_orden numeric,
--Intereses_devengados_no_cobrados_Cuentas_orden_mora numeric,
--Saldo_Promedio numeric,
--Interes_del_Mes numeric,
--REQ_EPRC_SIN_INT_CAVE numeric,
--REQ_EPRC_INT_CAVE numeric, 
--EPRC_creada_sin_int_CAVE numeric,
--EPRC_INT_CAVE numeric,
--Insuficiencia_req_EPRC numeric,
--Microcredito char(2),
--Zona_marginada char(2),
--Municipio_del_acreditado character varying(80),
--Poblacion_o_ranchera_del_acreditado  character varying(80),
--Valor_garantia_hipotecaria numeric,
--Debidamente_formalizada char(2),
--Libre_de_Gravamenes char(2), 
--Asegurado_a_favor_de_la_Sociedad char(2),
--Avaluo_actualizado char(2),
--Deposito_en_Garantia_Resguardo numeric,
--CREDITO_REDESCONTADO char(2),
--Institucion_fuente_de_recursos character varying(50),
--Por_Garantia_efectiva_contratada numeric,
--Parte_cubierta_con_garantia_contratada numeric,
--Parte_cubierta_con_67_de_deposito numeric,
--Parte_cubierta_con_EPRC_creada numeric,
--Parte_expuesta_neta_EPRC numeric,
--Fecha_UltimoPago_de_Capital date,
--Fecha_Ultimo_Pago_de_Interes date,
--Monto_Ultimo_Pago_de_Capital numeric,
--Monto_ult_pago_Interes_Vigente_vencido numeric,
--Vigente_vencido character varying(20),
--Renovado_reestructurado_normal character varying(20),
--Num_de_reestructuras integer,
Fecha_cierre date,
Categoria_mora char(10)

  )
  loop

    return next r;

  end loop;

end loop;
 
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.carterafederacionc(date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: saldos; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE saldos (
    saldoid integer NOT NULL,
    cuentaid character(24) NOT NULL,
    ejercicio integer NOT NULL,
    periodo integer NOT NULL,
    saldoinicialperiodo numeric NOT NULL,
    cargosdelperiodo numeric NOT NULL,
    abonosdelperiodo numeric NOT NULL
);


ALTER TABLE sucursal1.saldos OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: cbalanza(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cbalanza() RETURNS SETOF sucursal1.saldos
    AS $$
declare
  r saldos%rowtype;
begin

 for r in

   SELECT * FROM
        dblink('host=dolores.dnsalias.org dbname=reforma2 user=sistema','select * from sucursal1.saldos') as
               t2(saldoid int4, 
  CuentaID CHAR(24), 
  ejercicio INTEGER, 
  periodo INTEGER, 
  saldoinicialperiodo NUMERIC, 
  cargosdelperiodo NUMERIC, 
  abonosdelperiodo numeric)

 loop
   return next r;
 end loop;


 for r in

   SELECT * FROM
        dblink('host=snfelipe.dnsalias.org dbname=snfelipe user=sistema','select * from sucursal2.saldos') as
               t1(saldoid int4, 
  CuentaID CHAR(24), 
  ejercicio INTEGER, 
  periodo INTEGER, 
  saldoinicialperiodo NUMERIC, 
  cargosdelperiodo NUMERIC, 
  abonosdelperiodo numeric)

 loop
   return next r;
 end loop;


return;
end
$$
    LANGUAGE plpgsql;


ALTER FUNCTION public.cbalanza() OWNER TO sistema;

--
-- Name: cbalanza(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cbalanza(integer, integer) RETURNS SETOF sucursal1.saldos
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo   alias for $2;

  r saldos%rowtype;
  f record;
  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
        dblink2:='select * from '||f.esquema||'.saldos where ejercicio='||to_char(pejercicio,9999)||' and periodo='||to_char(pperiodo,99);

--        raise notice 'dblink % % ',dblink1,dblink2;

        for r in
        SELECT * FROM
        dblink(dblink1,dblink2) as
               t2(saldoid int4, 
  CuentaID CHAR(24), 
  ejercicio INTEGER, 
  periodo INTEGER, 
  saldoinicialperiodo NUMERIC, 
  cargosdelperiodo NUMERIC, 
  abonosdelperiodo numeric)

 loop
   return next r;
 end loop;

 end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cbalanza(integer, integer) OWNER TO sistema;

--
-- Name: centra(character varying, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION centra(character varying, integer) RETURNS character varying
    AS $_$
declare

  scadena alias for $1;
  i       alias for $2;
  stmp varchar;
  j int;
begin

  stmp := rtrim(scadena);
  j:=length(stmp);
  stmp := lpad('',(i-j)/2,' ')||stmp;

return stmp;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.centra(character varying, integer) OWNER TO sistema;

--
-- Name: checa_conexion(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION checa_conexion(text) RETURNS integer
    AS $_$
declare
 
  i integer;

begin

  i:=0;

  begin

    select count(*)
    into i
    from dblink_connect($1);
    return 1;

  EXCEPTION

    when others then return 0;

  end;

return 0;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.checa_conexion(text) OWNER TO sistema;

--
-- Name: checaprecierre(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION checaprecierre(date) RETURNS integer
    AS $_$
declare

  pfecha alias for $1;
  pprestamoid int4;
  r record;
  ptotaldebe numeric;
  ptotaldebe2 numeric;
  pcuentaactivo char(24);

begin

for r in 
select prestamoid,referenciaprestamo,montoprestamo,fecha_otorga,tipoprestamoid from prestamos where fecha_otorga <= pfecha and claveestadocredito <>'008' order by fecha_otorga
   loop
      select prestamoid into pprestamoid from movibanco where prestamoid=r.prestamoid;
      select cuentaactivo into pcuentaactivo from tipoprestamo where tipoprestamoid=r.tipoprestamoid;

      if pprestamoid is null then
         select prestamoid into pprestamoid from movicaja where prestamoid=r.prestamoid and estatusmovicaja ='A';
         if pprestamoid is null then
            raise notice ' Prestamoid no encontrado %  % % %',r.prestamoid,r.referenciaprestamo,r.montoprestamo,r.fecha_otorga;
         end if;
      else
         select prestamoid into pprestamoid from movicaja where prestamoid=r.prestamoid and estatusmovicaja ='A' and tipomovimientoid='RM';
         if pprestamoid is not null then
            raise notice ' Prestamoid encontrado en cheque y rm %  % % %',r.prestamoid,r.referenciaprestamo,r.montoprestamo,r.fecha_otorga;
         end if;
         
      end if;

      select sum(debe) into ptotaldebe from movipolizas where cuentaid=pcuentaactivo and polizaid in (select mc.polizaid from movicaja mc, polizas po where mc.polizaid=po.polizaid and mc.prestamoid=r.prestamoid and po.fechapoliza <=pfecha);

      select sum(debe) into ptotaldebe2 from movipolizas where cuentaid=pcuentaactivo and polizaid in (select mc.polizaid from movibanco mc, polizas po where mc.polizaid=po.polizaid and mc.prestamoid=r.prestamoid and po.fechapoliza <=pfecha);

      if ptotaldebe+ptotaldebe2 <> r.montoprestamo then 

         raise notice ' Prestamoid con diferencia en activo % % % % %',r.prestamoid,r.referenciaprestamo,r.montoprestamo,ptotaldebe,r.fecha_otorga;

      end if;

   end loop;
   

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.checaprecierre(date) OWNER TO sistema;

--
-- Name: cierreanual(character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cierreanual(character, character, date) RETURNS integer
    AS $_$
declare
  pcuentaid alias for $1;
  pserie alias for $2;
  pfecha alias for $3;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  iejercicio int;
  iperiodo int;

  resultado numeric;

  r saldos%rowtype;

  fsaldo numeric;

begin

  iejercicio := cast(date_part('year',pfecha) as int);
  iperiodo := cast(date_part('month',pfecha) as int);
  iperiodo := iperiodo+1;

  update periodo set estatus='A'
   where ejercicio=iejercicio and periodo=iperiodo;

  delete from movipolizas where polizaid in
    (select polizaid from polizas where fechapoliza=pfecha and tipo='X');

  delete from polizas where fechapoliza=pfecha and tipo='X';

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'X',pserie,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,pserie,'X',pnumero_poliza,cast(date_part('year',pfecha) as int),iperiodo,' ',pfecha,'D',' ',' ','Poliza de Cierre del Ejercicio',pfecha);


  resultado :=0;

  
  for r in
    select 1,s.cuentaid,s.ejercicio,12,sum(s.saldoinicialperiodo),
           sum(s.cargosdelperiodo),sum(s.abonosdelperiodo)
      from saldos s, catalogo_ctas c
     where s.ejercicio=iejercicio and
           s.periodo=12 and
           c.cuentaid=s.cuentaid and
           c.tipo_cta='A' and
           (substr(c.cuentaid,1,1)='5' or substr(c.cuentaid,1,1)='6')
   group by s.cuentaid,s.ejercicio
   order by s.cuentaid

  loop
    -- Detalle de la poliza

   raise notice 'Cerrando %',r.cuentaid;

   fsaldo:=r.saldoinicialperiodo+r.cargosdelperiodo-r.abonosdelperiodo;
    
   if fsaldo<>0 then
     if fsaldo<0 then
       select *
         into pmovipolizaid
         from spimovipoliza(ppolizaid,r.cuentaid,' ','C',-1*fsaldo,0,' ',' ','Cierre Ejercicio');
     else
       select *
         into pmovipolizaid
         from spimovipoliza(ppolizaid,r.cuentaid,' ','A',0,fsaldo,' ',' ','Cierre Ejercicio');
     end if;

   end if;

   resultado:=resultado+fsaldo;

  end loop;

  raise notice 'Resultado = %',resultado;

  if resultado>0 then
   raise notice 'Cargandolo';
   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,pcuentaid,' ','C',abs(resultado),0,' ',' ','Cierre Anual');
  else
   raise notice 'Abonandolo';
   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,pcuentaid,' ','A',0,abs(resultado),' ',' ','Cierre Anual');

  end if;

  update periodo set estatus='C'
   where ejercicio=iejercicio and periodo=iperiodo;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cierreanual(character, character, date) OWNER TO sistema;

--
-- Name: clasificaxamor(date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION clasificaxamor(date, character) RETURNS SETOF tclasificaxmora
    AS $_$
declare

pfecha alias for $1;
pconsolida alias for $2;

r tclasificaxmora%rowtype;
a record;

lnocreditos numeric;
fsaldo numeric;


begin


if pconsolida='N' then

  select sum(saldoprestamo),count(*)
    into fsaldo,lnocreditos
    from precorte 
   where fechacierre=pfecha and
   saldoprestamo>0 and clavefinalidad='001';

  lnocreditos:=lnocreditos/1.00;

raise notice 'nocreditos %',lnocreditos;

  for a in

select sum(case when p.noamorvencidas=0
                then 1
                else 0 end) as a1,
       round(sum(case when p.noamorvencidas=0
                then 1
                else 0 end)/(lnocreditos/1.00),4) as a2,
       sum(case when p.noamorvencidas=0
                then p.saldoprestamo
                else 0 end) as a3,
       round(sum(case when p.noamorvencidas=0
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as a4,
       sum(case when p.noamorvencidas=0
                then p.interesdevengadomenoravencido
                else 0 end) as a5,
       sum(case when p.noamorvencidas=0
                then p.interesdevengadomayoravencido
                else 0 end) as a6,


       sum(case when p.noamorvencidas=1
                then 1
                else 0 end) as b1,
       round(sum(case when p.noamorvencidas=1
                then 1
                else 0 end)/lnocreditos,4) as b2,
       sum(case when p.noamorvencidas=1
                then p.saldoprestamo
                else 0 end) as b3,
       round(sum(case when p.noamorvencidas=1
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as b4,
       sum(case when p.noamorvencidas=1
                then p.interesdevengadomenoravencido
                else 0 end) as b5,
       sum(case when p.noamorvencidas=1
                then p.interesdevengadomayoravencido
                else 0 end) as b6,


       sum(case when p.noamorvencidas=2
                then 1
                else 0 end) as c1,
       round(sum(case when p.noamorvencidas=2
                then 1
                else 0 end)/lnocreditos,4) as c2,
       sum(case when p.noamorvencidas=2
                then p.saldoprestamo
                else 0 end) as c3,
       round(sum(case when p.noamorvencidas=2
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as c4,
       sum(case when p.noamorvencidas=2
                then p.interesdevengadomenoravencido
                else 0 end) as c5,
       sum(case when p.noamorvencidas=2
                then p.interesdevengadomayoravencido
                else 0 end) as c6,


       sum(case when p.noamorvencidas=3
                then 1
                else 0 end) as d1,
       round(sum(case when p.noamorvencidas=3
                then 1
                else 0 end)/lnocreditos,4) as d2,
       sum(case when p.noamorvencidas=3
                then p.saldoprestamo
                else 0 end) as d3,
       round(sum(case when p.noamorvencidas=3
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as d4,
       sum(case when p.noamorvencidas=3
                then p.interesdevengadomenoravencido
                else 0 end) as d5,
       sum(case when p.noamorvencidas=3
                then p.interesdevengadomayoravencido
                else 0 end) as d6,


       sum(case when p.noamorvencidas=4
                then 1
                else 0 end) as e1,
       round(sum(case when p.noamorvencidas=4
                then 1
                else 0 end)/lnocreditos,4) as e2,
       sum(case when p.noamorvencidas=4
                then p.saldoprestamo
                else 0 end) as e3,
       round(sum(case when p.noamorvencidas=4
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as e4,
       sum(case when p.noamorvencidas=4
                then p.interesdevengadomenoravencido
                else 0 end) as e5,
       sum(case when p.noamorvencidas=4
                then p.interesdevengadomayoravencido
                else 0 end) as e6,

       sum(case when p.noamorvencidas=5
                then 1
                else 0 end) as f1,
       round(sum(case when p.noamorvencidas=5
                then 1
                else 0 end)/lnocreditos,4) as f2,
       sum(case when p.noamorvencidas=5
                then p.saldoprestamo
                else 0 end) as f3,
       round(sum(case when p.noamorvencidas=5
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as f4,
       sum(case when p.noamorvencidas=5
                then p.interesdevengadomenoravencido
                else 0 end) as f5,
       sum(case when p.noamorvencidas=5
                then p.interesdevengadomayoravencido
                else 0 end) as f6,

       sum(case when p.noamorvencidas=6
                then 1
                else 0 end) as g1,
       round(sum(case when p.noamorvencidas=6
                then 1
                else 0 end)/lnocreditos,4) as g2,
       sum(case when p.noamorvencidas=6
                then p.saldoprestamo
                else 0 end) as g3,
       round(sum(case when p.noamorvencidas=6
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as g4,
       sum(case when p.noamorvencidas=6
                then p.interesdevengadomenoravencido
                else 0 end) as g5,
       sum(case when p.noamorvencidas=6
                then p.interesdevengadomayoravencido
                else 0 end) as g6,


       sum(case when p.noamorvencidas=7
                then 1
                else 0 end) as h1,
       round(sum(case when p.noamorvencidas=7
                then 1
                else 0 end)/lnocreditos,4) as h2,
       sum(case when p.noamorvencidas=7
                then p.saldoprestamo
                else 0 end) as h3,
       round(sum(case when p.noamorvencidas=7
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as h4,
       sum(case when p.noamorvencidas=7
                then p.interesdevengadomenoravencido
                else 0 end) as h5,
       sum(case when p.noamorvencidas=7
                then p.interesdevengadomayoravencido
                else 0 end) as h6,

       sum(case when p.noamorvencidas>7
                then 1
                else 0 end) as i1,
       round(sum(case when p.noamorvencidas>7
                then 1
                else 0 end)/lnocreditos,4) as i2,
       sum(case when p.noamorvencidas>7
                then p.saldoprestamo
                else 0 end) as i3,
       round(sum(case when p.noamorvencidas>7
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as i4,
       sum(case when p.noamorvencidas>7
                then p.interesdevengadomenoravencido
                else 0 end) as i5,
       sum(case when p.noamorvencidas>7
                then p.interesdevengadomayoravencido
                else 0 end) as i6


from precorte p
where p.fechacierre=pfecha and
      p.saldoprestamo>0 and p.clavefinalidad='001'


  loop

    r.rango:='0';
    r.nocreditos := a.a1;
    r.pornocreditos :=  a.a2;
    r.saldo := a.a3;
    r.porsaldo := a.a4;
    r.intvigente := a.a5;
    r.intvencido := a.a6;
    r.porrequerido := 0.05;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;

    r.rango:='1';
    r.nocreditos := a.b1;
    r.pornocreditos := a.b2;
    r.saldo := a.b3;
    r.porsaldo := a.b4;
    r.intvigente := a.b5;
    r.intvencido := a.b6;
    r.porrequerido := 0.15;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;

    r.rango:='2';
    r.nocreditos := a.c1;
    r.pornocreditos := a.c2;
    r.saldo := a.c3;
    r.porsaldo := a.c4;
    r.intvigente := a.c5;
    r.intvencido := a.c6;
    r.porrequerido := 0.30;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;    

    r.rango:='3';
    r.nocreditos := a.d1;
    r.pornocreditos := a.d2;
    r.saldo := a.d3;
    r.porsaldo := a.d4;
    r.intvigente := a.d5;
    r.intvencido := a.d6;
    r.porrequerido := 0.40;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;



    r.rango:='4';
    r.nocreditos := a.e1;
    r.pornocreditos := a.e2;
    r.saldo := a.e3;
    r.porsaldo := a.e4;
    r.intvigente := a.e5;
    r.intvencido := a.e6;
    r.porrequerido := 0.60;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;


    r.rango:='5';
    r.nocreditos := a.f1;
    r.pornocreditos := a.f2;
    r.saldo := a.f3;
    r.porsaldo := a.f4;
    r.intvigente := a.f5;
    r.intvencido := a.f6;
    r.porrequerido := 0.75;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;


    r.rango:='6';
    r.nocreditos := a.g1;
    r.pornocreditos := a.g2;
    r.saldo := a.g3;
    r.porsaldo := a.g4;
    r.intvigente := a.g5;
    r.intvencido := a.g6;
    r.porrequerido := 0.85;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;

    r.rango:='7';
    r.nocreditos := a.h1;
    r.pornocreditos := a.h2;
    r.saldo := a.h3;
    r.porsaldo := a.h4;
    r.intvigente := a.h5;
    r.intvencido := a.h6;
    r.porrequerido := 0.95;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;

    r.rango:='8 o mas';
     r.nocreditos := a.i1;
    r.pornocreditos := a.i2;
    r.saldo := a.i3;
    r.porsaldo := a.i4;
    r.intvigente := a.i5;
    r.intvencido := a.i6;
    r.porrequerido := 1.00;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;


  end loop;

else


  select sum(saldoprestamo),count(*)
    into fsaldo,lnocreditos
    from precorteconsolidado( cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int))
   where fechacierre=pfecha and
   saldoprestamo>0 and upper(descripcionfinalidad)=upper('Crdito Comercial');

  lnocreditos:=lnocreditos/1.00;

raise notice 'nocreditos %',lnocreditos;

  for a in

select sum(case when p.noamorvencidas=0
                then 1
                else 0 end) as a1,
       round(sum(case when p.noamorvencidas=0
                then 1
                else 0 end)/(lnocreditos/1.00),4) as a2,
       sum(case when p.noamorvencidas=0
                then p.saldoprestamo
                else 0 end) as a3,
       round(sum(case when p.noamorvencidas=0
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as a4,
       sum(case when p.noamorvencidas=0
                then p.interesdevengadomenoravencido
                else 0 end) as a5,
       sum(case when p.noamorvencidas=0
                then p.interesdevengadomayoravencido
                else 0 end) as a6,


       sum(case when p.noamorvencidas=1
                then 1
                else 0 end) as b1,
       round(sum(case when p.noamorvencidas=1
                then 1
                else 0 end)/lnocreditos,4) as b2,
       sum(case when p.noamorvencidas=1
                then p.saldoprestamo
                else 0 end) as b3,
       round(sum(case when p.noamorvencidas=1
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as b4,
       sum(case when p.noamorvencidas=1
                then p.interesdevengadomenoravencido
                else 0 end) as b5,
       sum(case when p.noamorvencidas=1
                then p.interesdevengadomayoravencido
                else 0 end) as b6,


       sum(case when p.noamorvencidas=2
                then 1
                else 0 end) as c1,
       round(sum(case when p.noamorvencidas=2
                then 1
                else 0 end)/lnocreditos,4) as c2,
       sum(case when p.noamorvencidas=2
                then p.saldoprestamo
                else 0 end) as c3,
       round(sum(case when p.noamorvencidas=2
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as c4,
       sum(case when p.noamorvencidas=2
                then p.interesdevengadomenoravencido
                else 0 end) as c5,
       sum(case when p.noamorvencidas=2
                then p.interesdevengadomayoravencido
                else 0 end) as c6,


       sum(case when p.noamorvencidas=3
                then 1
                else 0 end) as d1,
       round(sum(case when p.noamorvencidas=3
                then 1
                else 0 end)/lnocreditos,4) as d2,
       sum(case when p.noamorvencidas=3
                then p.saldoprestamo
                else 0 end) as d3,
       round(sum(case when p.noamorvencidas=3
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as d4,
       sum(case when p.noamorvencidas=3
                then p.interesdevengadomenoravencido
                else 0 end) as d5,
       sum(case when p.noamorvencidas=3
                then p.interesdevengadomayoravencido
                else 0 end) as d6,


       sum(case when p.noamorvencidas=4
                then 1
                else 0 end) as e1,
       round(sum(case when p.noamorvencidas=4
                then 1
                else 0 end)/lnocreditos,4) as e2,
       sum(case when p.noamorvencidas=4
                then p.saldoprestamo
                else 0 end) as e3,
       round(sum(case when p.noamorvencidas=4
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as e4,
       sum(case when p.noamorvencidas=4
                then p.interesdevengadomenoravencido
                else 0 end) as e5,
       sum(case when p.noamorvencidas=4
                then p.interesdevengadomayoravencido
                else 0 end) as e6,

       sum(case when p.noamorvencidas=5
                then 1
                else 0 end) as f1,
       round(sum(case when p.noamorvencidas=5
                then 1
                else 0 end)/lnocreditos,4) as f2,
       sum(case when p.noamorvencidas=5
                then p.saldoprestamo
                else 0 end) as f3,
       round(sum(case when p.noamorvencidas=5
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as f4,
       sum(case when p.noamorvencidas=5
                then p.interesdevengadomenoravencido
                else 0 end) as f5,
       sum(case when p.noamorvencidas=5
                then p.interesdevengadomayoravencido
                else 0 end) as f6,

       sum(case when p.noamorvencidas=6
                then 1
                else 0 end) as g1,
       round(sum(case when p.noamorvencidas=6
                then 1
                else 0 end)/lnocreditos,4) as g2,
       sum(case when p.noamorvencidas=6
                then p.saldoprestamo
                else 0 end) as g3,
       round(sum(case when p.noamorvencidas=6
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as g4,
       sum(case when p.noamorvencidas=6
                then p.interesdevengadomenoravencido
                else 0 end) as g5,
       sum(case when p.noamorvencidas=6
                then p.interesdevengadomayoravencido
                else 0 end) as g6,


       sum(case when p.noamorvencidas=7
                then 1
                else 0 end) as h1,
       round(sum(case when p.noamorvencidas=7
                then 1
                else 0 end)/lnocreditos,4) as h2,
       sum(case when p.noamorvencidas=7
                then p.saldoprestamo
                else 0 end) as h3,
       round(sum(case when p.noamorvencidas=7
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as h4,
       sum(case when p.noamorvencidas=7
                then p.interesdevengadomenoravencido
                else 0 end) as h5,
       sum(case when p.noamorvencidas=7
                then p.interesdevengadomayoravencido
                else 0 end) as h6,

       sum(case when p.noamorvencidas>7
                then 1
                else 0 end) as i1,
       round(sum(case when p.noamorvencidas>7
                then 1
                else 0 end)/lnocreditos,4) as i2,
       sum(case when p.noamorvencidas>7
                then p.saldoprestamo
                else 0 end) as i3,
       round(sum(case when p.noamorvencidas>7
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as i4,
       sum(case when p.noamorvencidas>7
                then p.interesdevengadomenoravencido
                else 0 end) as i5,
       sum(case when p.noamorvencidas>7
                then p.interesdevengadomayoravencido
                else 0 end) as i6


from precorteconsolidado( cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int)) p
where p.fechacierre=pfecha and
      p.saldoprestamo>0 and upper(p.descripcionfinalidad)=upper('Crdito Comercial')


  loop

    r.rango:='0';
    r.nocreditos := a.a1;
    r.pornocreditos :=  a.a2;
    r.saldo := a.a3;
    r.porsaldo := a.a4;
    r.intvigente := a.a5;
    r.intvencido := a.a6;
    r.porrequerido := 0.05;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;

    r.rango:='1';
    r.nocreditos := a.b1;
    r.pornocreditos := a.b2;
    r.saldo := a.b3;
    r.porsaldo := a.b4;
    r.intvigente := a.b5;
    r.intvencido := a.b6;
    r.porrequerido := 0.15;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;

    r.rango:='2';
    r.nocreditos := a.c1;
    r.pornocreditos := a.c2;
    r.saldo := a.c3;
    r.porsaldo := a.c4;
    r.intvigente := a.c5;
    r.intvencido := a.c6;
    r.porrequerido := 0.30;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;    

    r.rango:='3';
    r.nocreditos := a.d1;
    r.pornocreditos := a.d2;
    r.saldo := a.d3;
    r.porsaldo := a.d4;
    r.intvigente := a.d5;
    r.intvencido := a.d6;
    r.porrequerido := 0.40;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;



    r.rango:='4';
    r.nocreditos := a.e1;
    r.pornocreditos := a.e2;
    r.saldo := a.e3;
    r.porsaldo := a.e4;
    r.intvigente := a.e5;
    r.intvencido := a.e6;
    r.porrequerido := 0.60;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;


    r.rango:='5';
    r.nocreditos := a.f1;
    r.pornocreditos := a.f2;
    r.saldo := a.f3;
    r.porsaldo := a.f4;
    r.intvigente := a.f5;
    r.intvencido := a.f6;
    r.porrequerido := 0.75;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;


    r.rango:='6';
    r.nocreditos := a.g1;
    r.pornocreditos := a.g2;
    r.saldo := a.g3;
    r.porsaldo := a.g4;
    r.intvigente := a.g5;
    r.intvencido := a.g6;
    r.porrequerido := 0.85;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;

    r.rango:='7';
    r.nocreditos := a.h1;
    r.pornocreditos := a.h2;
    r.saldo := a.h3;
    r.porsaldo := a.h4;
    r.intvigente := a.h5;
    r.intvencido := a.h6;
    r.porrequerido := 0.95;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;

    r.rango:='8 o mas';
     r.nocreditos := a.i1;
    r.pornocreditos := a.i2;
    r.saldo := a.i3;
    r.porsaldo := a.i4;
    r.intvigente := a.i5;
    r.intvencido := a.i6;
    r.porrequerido := 1.00;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;


  end loop;


end if;

return;

END;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.clasificaxamor(date, character) OWNER TO sistema;

--
-- Name: clasificaxmora(date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION clasificaxmora(date, character) RETURNS SETOF tclasificaxmora
    AS $_$
declare

pfecha alias for $1;
pconsolida alias for $2;

r tclasificaxmora%rowtype;
a record;

lnocreditos numeric;
fsaldo numeric;


begin


if pconsolida='N' then

  select sum(saldoprestamo),count(*)
    into fsaldo,lnocreditos
    from precorte
   where fechacierre=pfecha and
         saldoprestamo>0 and clavefinalidad<>'001';

  lnocreditos:=lnocreditos/1.00;
  fsaldo:=fsaldo/1.00;

raise notice 'nocreditos %  Saldo %',lnocreditos,fsaldo;

  for a in

select sum(case when p.diasvencidos=0
                then 1
                else 0 end) as a1,
       round(sum(case when p.diasvencidos=0
                then 1
                else 0 end)/(lnocreditos/1.00),6) as a2,
       sum(case when p.diasvencidos=0
                then p.saldoprestamo
                else 0 end) as a3,
       round(sum(case when p.diasvencidos=0
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as a4,
       sum(case when p.diasvencidos=0
                then p.interesdevengadomenoravencido
                else 0 end) as a5,
       sum(case when p.diasvencidos=0
                then p.interesdevengadomayoravencido
                else 0 end) as a6,


       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then 1
                else 0 end) as b1,
       round(sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then 1
                else 0 end)/lnocreditos,6) as b2,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo
                else 0 end) as b3,
       round(sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as b4,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.interesdevengadomenoravencido
                else 0 end) as b5,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.interesdevengadomayoravencido
                else 0 end) as b6,


       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then 1
                else 0 end) as c1,
       round(sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then 1
                else 0 end)/lnocreditos,6) as c2,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo
                else 0 end) as c3,
       round(sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as c4,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.interesdevengadomenoravencido
                else 0 end) as c5,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.interesdevengadomayoravencido
                else 0 end) as c6,


       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then 1
                else 0 end) as d1,
       round(sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then 1
                else 0 end)/lnocreditos,6) as d2,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo
                else 0 end) as d3,
       round(sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as d4,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.interesdevengadomenoravencido
                else 0 end) as d5,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.interesdevengadomayoravencido
                else 0 end) as d6,


       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then 1
                else 0 end) as e1,
       round(sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then 1
                else 0 end)/lnocreditos,6) as e2,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo
                else 0 end) as e3,
       round(sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as e4,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.interesdevengadomenoravencido
                else 0 end) as e5,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.interesdevengadomayoravencido
                else 0 end) as e6,

       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then 1
                else 0 end) as f1,
       round(sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then 1
                else 0 end)/lnocreditos,6) as f2,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo
                else 0 end) as f3,
       round(sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as f4,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.interesdevengadomenoravencido
                else 0 end) as f5,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.interesdevengadomayoravencido
                else 0 end) as f6,

       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then 1
                else 0 end) as g1,
       round(sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then 1
                else 0 end)/lnocreditos,6) as g2,
       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.saldoprestamo
                else 0 end) as g3,
       round(sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as g4,
       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.interesdevengadomenoravencido
                else 0 end) as g5,
       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.interesdevengadomayoravencido
                else 0 end) as g6,


       sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then 1
                else 0 end) as h1,
       round(sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then 1
                else 0 end)/lnocreditos,6) as h2,
       sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then p.saldoprestamo
                else 0 end) as h3,
       round(sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as h4,
       sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then p.interesdevengadomenoravencido
                else 0 end) as h5,
       sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then p.interesdevengadomayoravencido
                else 0 end) as h6,

       sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then 1
                else 0 end) as i1,
       round(sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then 1
                else 0 end)/lnocreditos,6) as i2,
       sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then p.saldoprestamo
                else 0 end) as i3,
       round(sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as i4,
       sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then p.interesdevengadomenoravencido
                else 0 end) as i5,
       sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then p.interesdevengadomayoravencido
                else 0 end) as i6,

       sum(case when p.diasvencidos>365
                then 1
                else 0 end) as j1,
       round(sum(case when p.diasvencidos>365
                then 1
                else 0 end)/lnocreditos,6) as j2,
       sum(case when p.diasvencidos>365
                then p.saldoprestamo
                else 0 end) as j3,
       round(sum(case when p.diasvencidos>365
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as j4,
       sum(case when p.diasvencidos>365
                then p.interesdevengadomenoravencido
                else 0 end) as j5,
       sum(case when p.diasvencidos>365
                then p.interesdevengadomayoravencido
                else 0 end) as j6

from precorte p
where p.fechacierre=pfecha and
      p.saldoprestamo>0 and clavefinalidad <> '001'


  loop

    r.rango:='0 dias';
    r.nocreditos := a.a1;
    r.pornocreditos :=  a.a2;
    r.saldo := a.a3;
    r.porsaldo := a.a4;
    r.intvigente := a.a5;
    r.intvencido := a.a6;
    r.porrequerido := 0.01;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;

    r.rango:='1-7  dias';
    r.nocreditos := a.b1;
    r.pornocreditos := a.b2;
    r.saldo := a.b3;
    r.porsaldo := a.b4;
    r.intvigente := a.b5;
    r.intvencido := a.b6;
    r.porrequerido := 0.04;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;

    r.rango:='8-30 dias';
    r.nocreditos := a.c1;
    r.pornocreditos := a.c2;
    r.saldo := a.c3;
    r.porsaldo := a.c4;
    r.intvigente := a.c5;
    r.intvencido := a.c6;
    r.porrequerido := 0.15;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;    

    r.rango:='31-60 dias';
    r.nocreditos := a.d1;
    r.pornocreditos := a.d2;
    r.saldo := a.d3;
    r.porsaldo := a.d4;
    r.intvigente := a.d5;
    r.intvencido := a.d6;
    r.porrequerido := 0.30;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;



    r.rango:='61-90 dias';
    r.nocreditos := a.e1;
    r.pornocreditos := a.e2;
    r.saldo := a.e3;
    r.porsaldo := a.e4;
    r.intvigente := a.e5;
    r.intvencido := a.e6;
    r.porrequerido := 0.40;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;


    r.rango:='91-120 dias';
    r.nocreditos := a.f1;
    r.pornocreditos := a.f2;
    r.saldo := a.f3;
    r.porsaldo := a.f4;
    r.intvigente := a.f5;
    r.intvencido := a.f6;
    r.porrequerido := 0.60;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;


    r.rango:='121-180 dias';
    r.nocreditos := a.g1;
    r.pornocreditos := a.g2;
    r.saldo := a.g3;
    r.porsaldo := a.g4;
    r.intvigente := a.g5;
    r.intvencido := a.g6;
    r.porrequerido := 0.75;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;

    r.rango:='181-270 dias';
    r.nocreditos := a.h1;
    r.pornocreditos := a.h2;
    r.saldo := a.h3;
    r.porsaldo := a.h4;
    r.intvigente := a.h5;
    r.intvencido := a.h6;
    r.porrequerido := 0.85;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;

    r.rango:='271-365 dias';
     r.nocreditos := a.i1;
    r.pornocreditos := a.i2;
    r.saldo := a.i3;
    r.porsaldo := a.i4;
    r.intvigente := a.i5;
    r.intvencido := a.i6;
    r.porrequerido := 0.95;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;

    r.rango:='>365 dias';
    r.nocreditos := a.j1;
    r.pornocreditos := a.j2;
    r.saldo := a.j3;
    r.porsaldo := a.j4;
    r.intvigente := a.j5;
    r.intvencido := a.j6;
    r.porrequerido := 1.00;
    r.req1 := r.saldo;
    r.req2 := r.intvencido;
    return next r;
  end loop;


else



  select sum(saldoprestamo),count(*)
    into fsaldo,lnocreditos
    from precorteconsolidado( cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int))
   where fechacierre=pfecha and
         saldoprestamo>0 and upper(descripcionfinalidad)<>upper('Crdito Comercial');

  lnocreditos:=lnocreditos/1.00;
  fsaldo:=fsaldo/1.00;

raise notice 'nocreditos %  Saldo %',lnocreditos,fsaldo;

  for a in

select sum(case when p.diasvencidos=0
                then 1
                else 0 end) as a1,
       round(sum(case when p.diasvencidos=0
                then 1
                else 0 end)/(lnocreditos/1.00),6) as a2,
       sum(case when p.diasvencidos=0
                then p.saldoprestamo
                else 0 end) as a3,
       round(sum(case when p.diasvencidos=0
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as a4,
       sum(case when p.diasvencidos=0
                then p.interesdevengadomenoravencido
                else 0 end) as a5,
       sum(case when p.diasvencidos=0
                then p.interesdevengadomayoravencido
                else 0 end) as a6,


       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then 1
                else 0 end) as b1,
       round(sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then 1
                else 0 end)/lnocreditos,6) as b2,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo
                else 0 end) as b3,
       round(sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as b4,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.interesdevengadomenoravencido
                else 0 end) as b5,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.interesdevengadomayoravencido
                else 0 end) as b6,


       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then 1
                else 0 end) as c1,
       round(sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then 1
                else 0 end)/lnocreditos,6) as c2,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo
                else 0 end) as c3,
       round(sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as c4,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.interesdevengadomenoravencido
                else 0 end) as c5,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.interesdevengadomayoravencido
                else 0 end) as c6,


       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then 1
                else 0 end) as d1,
       round(sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then 1
                else 0 end)/lnocreditos,6) as d2,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo
                else 0 end) as d3,
       round(sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as d4,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.interesdevengadomenoravencido
                else 0 end) as d5,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.interesdevengadomayoravencido
                else 0 end) as d6,


       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then 1
                else 0 end) as e1,
       round(sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then 1
                else 0 end)/lnocreditos,6) as e2,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo
                else 0 end) as e3,
       round(sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as e4,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.interesdevengadomenoravencido
                else 0 end) as e5,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.interesdevengadomayoravencido
                else 0 end) as e6,

       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then 1
                else 0 end) as f1,
       round(sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then 1
                else 0 end)/lnocreditos,6) as f2,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo
                else 0 end) as f3,
       round(sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as f4,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.interesdevengadomenoravencido
                else 0 end) as f5,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.interesdevengadomayoravencido
                else 0 end) as f6,

       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then 1
                else 0 end) as g1,
       round(sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then 1
                else 0 end)/lnocreditos,6) as g2,
       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.saldoprestamo
                else 0 end) as g3,
       round(sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as g4,
       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.interesdevengadomenoravencido
                else 0 end) as g5,
       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.interesdevengadomayoravencido
                else 0 end) as g6,


       sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then 1
                else 0 end) as h1,
       round(sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then 1
                else 0 end)/lnocreditos,6) as h2,
       sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then p.saldoprestamo
                else 0 end) as h3,
       round(sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as h4,
       sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then p.interesdevengadomenoravencido
                else 0 end) as h5,
       sum(case when p.diasvencidos>180 and p.diasvencidos<271
                then p.interesdevengadomayoravencido
                else 0 end) as h6,

       sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then 1
                else 0 end) as i1,
       round(sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then 1
                else 0 end)/lnocreditos,6) as i2,
       sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then p.saldoprestamo
                else 0 end) as i3,
       round(sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as i4,
       sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then p.interesdevengadomenoravencido
                else 0 end) as i5,
       sum(case when p.diasvencidos>270 and p.diasvencidos<366
                then p.interesdevengadomayoravencido
                else 0 end) as i6,

       sum(case when p.diasvencidos>365
                then 1
                else 0 end) as j1,
       round(sum(case when p.diasvencidos>365
                then 1
                else 0 end)/lnocreditos,6) as j2,
       sum(case when p.diasvencidos>365
                then p.saldoprestamo
                else 0 end) as j3,
       round(sum(case when p.diasvencidos>365
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as j4,
       sum(case when p.diasvencidos>365
                then p.interesdevengadomenoravencido
                else 0 end) as j5,
       sum(case when p.diasvencidos>365
                then p.interesdevengadomayoravencido
                else 0 end) as j6

from precorteconsolidado( cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int)) p
where p.fechacierre=pfecha and
      p.saldoprestamo>0 and upper(descripcionfinalidad)<>upper('Crdito Comercial')


  loop

    r.rango:='0 dias';
    r.nocreditos := a.a1;
    r.pornocreditos :=  a.a2;
    r.saldo := a.a3;
    r.porsaldo := a.a4;
    r.intvigente := a.a5;
    r.intvencido := a.a6;
    r.porrequerido := 0.01;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;

    r.rango:='1-7  dias';
    r.nocreditos := a.b1;
    r.pornocreditos := a.b2;
    r.saldo := a.b3;
    r.porsaldo := a.b4;
    r.intvigente := a.b5;
    r.intvencido := a.b6;
    r.porrequerido := 0.04;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;

    r.rango:='8-30 dias';
    r.nocreditos := a.c1;
    r.pornocreditos := a.c2;
    r.saldo := a.c3;
    r.porsaldo := a.c4;
    r.intvigente := a.c5;
    r.intvencido := a.c6;
    r.porrequerido := 0.15;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;    

    r.rango:='31-60 dias';
    r.nocreditos := a.d1;
    r.pornocreditos := a.d2;
    r.saldo := a.d3;
    r.porsaldo := a.d4;
    r.intvigente := a.d5;
    r.intvencido := a.d6;
    r.porrequerido := 0.30;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;



    r.rango:='61-90 dias';
    r.nocreditos := a.e1;
    r.pornocreditos := a.e2;
    r.saldo := a.e3;
    r.porsaldo := a.e4;
    r.intvigente := a.e5;
    r.intvencido := a.e6;
    r.porrequerido := 0.40;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := 0.00;
    return next r;


    r.rango:='91-120 dias';
    r.nocreditos := a.f1;
    r.pornocreditos := a.f2;
    r.saldo := a.f3;
    r.porsaldo := a.f4;
    r.intvigente := a.f5;
    r.intvencido := a.f6;
    r.porrequerido := 0.60;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;


    r.rango:='121-180 dias';
    r.nocreditos := a.g1;
    r.pornocreditos := a.g2;
    r.saldo := a.g3;
    r.porsaldo := a.g4;
    r.intvigente := a.g5;
    r.intvencido := a.g6;
    r.porrequerido := 0.75;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;

    r.rango:='181-270 dias';
    r.nocreditos := a.h1;
    r.pornocreditos := a.h2;
    r.saldo := a.h3;
    r.porsaldo := a.h4;
    r.intvigente := a.h5;
    r.intvencido := a.h6;
    r.porrequerido := 0.85;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;

    r.rango:='271-365 dias';
     r.nocreditos := a.i1;
    r.pornocreditos := a.i2;
    r.saldo := a.i3;
    r.porsaldo := a.i4;
    r.intvigente := a.i5;
    r.intvencido := a.i6;
    r.porrequerido := 0.95;
    r.req1 := (r.saldo+r.intvigente)*r.porrequerido;
    r.req2 := r.intvencido;
    return next r;

    r.rango:='>365 dias';
    r.nocreditos := a.j1;
    r.pornocreditos := a.j2;
    r.saldo := a.j3;
    r.porsaldo := a.j4;
    r.intvigente := a.j5;
    r.intvencido := a.j6;
    r.porrequerido := 1.00;
    r.req1 := r.saldo;
    r.req2 := r.intvencido;
    return next r;
  end loop;



end if;

return;

END;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.clasificaxmora(date, character) OWNER TO sistema;

--
-- Name: clasificaxtipofinalidad(date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION clasificaxtipofinalidad(date, character, character) RETURNS SETOF tclasificaxbandas
    AS $_$
declare

pfecha alias for $1;
pclavefinalidad alias for $2;
pconsolida alias for $3;

r tclasificaxbandas%rowtype;
a record;

lnocreditos numeric;
fsaldo numeric;

sdescripcionfinalidad char(30);
fporrequerido numeric;


begin

sdescripcionfinalidad:=pclavefinalidad;

raise notice 'finalidad %  %',pclavefinalidad,sdescripcionfinalidad;

lnocreditos :=1;
fsaldo :=1;
fporrequerido:= .34;


if pconsolida='N' then


raise notice 'Sucursal nocreditos %  Saldo %',lnocreditos,fsaldo;

  for a in

select sum(case when p.diasvencidos=0
                then 1
                else 0 end) as a1,
       round(sum(case when p.diasvencidos=0
                then 1
                else 0 end)/(lnocreditos/1.00),6) as a2,
       sum(case when p.diasvencidos=0
                then p.saldoprestamo
                else 0 end) as a3,
       round(sum(case when p.diasvencidos=0
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as a4,
       sum(case when p.diasvencidos=0
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as a5,
       sum(case when p.diasvencidos=0
                then p.interesdevengadomayoravencido
                else 0 end) as a6,
       sum(case when p.diasvencidos=0
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as a7,
       sum(case when p.diasvencidos=0
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as a8,


--

       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then 1
                else 0 end) as b1,
       round(sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then 1
                else 0 end)/lnocreditos,6) as b2,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo
                else 0 end) as b3,
       round(sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as b4,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as b5,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.interesdevengadomayoravencido
                else 0 end) as b6,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as b7,
      sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as b8,

--

       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then 1
                else 0 end) as c1,
       round(sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then 1
                else 0 end)/lnocreditos,6) as c2,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo
                else 0 end) as c3,
       round(sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as c4,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as c5,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.interesdevengadomayoravencido
                else 0 end) as c6,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as c7,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as c8,

      

--

       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then 1
                else 0 end) as d1,
       round(sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then 1
                else 0 end)/lnocreditos,6) as d2,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo
                else 0 end) as d3,
       round(sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as d4,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as d5,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.interesdevengadomayoravencido
                else 0 end) as d6,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as d7,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as d8,

--

       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then 1
                else 0 end) as e1,
       round(sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then 1
                else 0 end)/lnocreditos,6) as e2,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo
                else 0 end) as e3,
       round(sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as e4,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as e5,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.interesdevengadomayoravencido
                else 0 end) as e6,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as e7,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as e8,

--
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then 1
                else 0 end) as f1,
       round(sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then 1
                else 0 end)/lnocreditos,6) as f2,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo
                else 0 end) as f3,
       round(sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as f4,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as f5,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.interesdevengadomayoravencido
                else 0 end) as f6,

       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as f7,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as f8,

--

       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then 1
                else 0 end) as g1,
       round(sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then 1
                else 0 end)/lnocreditos,6) as g2,
       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then p.saldoprestamo
                else 0 end) as g3,
       round(sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as g4,
       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as g5,
       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then p.interesdevengadomayoravencido
                else 0 end) as g6,

       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as g7,
       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as g8,

--

       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then 1
                else 0 end) as h1,
       round(sum(case when p.diasvencidos>151 and p.diasvencidos<211
                then 1
                else 0 end)/lnocreditos,6) as h2,
       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then p.saldoprestamo
                else 0 end) as h3,
       round(sum(case when p.diasvencidos>151 and p.diasvencidos<211
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as h4,
       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as h5,
       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then p.interesdevengadomayoravencido
                else 0 end) as h6,
       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as h7,
       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as h8,

--

       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then 1
                else 0 end) as i1,
       round(sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then 1
                else 0 end)/lnocreditos,6) as i2,
       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then p.saldoprestamo
                else 0 end) as i3,
       round(sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as i4,
       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as i5,
       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then p.interesdevengadomayoravencido
                else 0 end) as i6,
       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as i7,
       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as i8,

       sum(case when p.diasvencidos>365
                then 1
                else 0 end) as j1,
       round(sum(case when p.diasvencidos>365
                then 1
                else 0 end)/lnocreditos,6) as j2,
       sum(case when p.diasvencidos>365
                then p.saldoprestamo
                else 0 end) as j3,
       round(sum(case when p.diasvencidos>365
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as j4,
       sum(case when p.diasvencidos>365
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as j5,
       sum(case when p.diasvencidos>365
                then p.interesdevengadomayoravencido
                else 0 end) as j6,
       sum(case when p.diasvencidos>365
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as j7,
       sum(case when p.diasvencidos>365
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as j8

from precorte p, tipoprestamo t
where p.fechacierre=pfecha and p.tipoprestamoid=t.tipoprestamoid and 
      p.saldoprestamo>0 and  t.clavefinalidad = pclavefinalidad 

  loop

    r.rango:='0 dias';
    r.nocreditos := a.a1;
    r.pornocreditos :=  a.a2;
    r.saldo := a.a3;
    r.porsaldo := a.a4;
    r.intvigente := a.a5;
    r.intvencido := a.a6;
    r.porrequerido := .01;
    r.req1 := a.a8;
    r.req2 := 0.00;
    r.reciprocidad := a.a7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='1-7  dias';
    r.nocreditos := a.b1;
    r.pornocreditos := a.b2;
    r.saldo := a.b3;
    r.porsaldo := a.b4;
    r.intvigente := a.b5;
    r.intvencido := a.b6;
    r.porrequerido := .04;
    r.req1 := a.b8;
    r.req2 := 0.00;
    r.reciprocidad := a.b7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='8-30 dias';
    r.nocreditos := a.c1;
    r.pornocreditos := a.c2;
    r.saldo := a.c3;
    r.porsaldo := a.c4;
    r.intvigente := a.c5;
    r.intvencido := a.c6;
    r.porrequerido := 0.15;
    r.req1 := a.c8;
    r.req2 := 0.00;
    r.reciprocidad := a.c7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;    

    r.rango:='31-60 dias';
    r.nocreditos := a.d1;
    r.pornocreditos := a.d2;
    r.saldo := a.d3;
    r.porsaldo := a.d4;
    r.intvigente := a.d5;
    r.intvencido := a.d6;
    r.porrequerido := 0.30;
    r.req1 := a.d8;
    r.req2 := 0.00;
    r.reciprocidad := a.d7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='61-90 dias';
    r.nocreditos := a.e1;
    r.pornocreditos := a.e2;
    r.saldo := a.e3;
    r.porsaldo := a.e4;
    r.intvigente := a.e5;
    r.intvencido := a.e6;
    r.porrequerido := 0.50;
    r.req1 := a.e8;
    r.req2 := 0.00;
    r.reciprocidad := a.e7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;


    r.rango:='91-120 dias';
    r.nocreditos := a.f1;
    r.pornocreditos := a.f2;
    r.saldo := a.f3;
    r.porsaldo := a.f4;
    r.intvigente := a.f5;
    r.intvencido := a.f6;
    r.porrequerido := 0.75;
    r.req1 := a.f8;
    r.req2 := r.intvencido;
    r.reciprocidad := a.f7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='121-150 dias';
    r.nocreditos := a.g1;
    r.pornocreditos := a.g2;
    r.saldo := a.g3;
    r.porsaldo := a.g4;
    r.intvigente := a.g5;
    r.intvencido := a.g6;
    r.porrequerido := 0.90;
    r.req1 := a.g8;
    r.req2 := r.intvencido;
    r.reciprocidad := a.g7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='150-180 dias';
    r.nocreditos := a.h1;
    r.pornocreditos := a.h2;
    r.saldo := a.h3;
    r.porsaldo := a.h4;
    r.intvigente := a.h5;
    r.intvencido := a.h6;
    r.porrequerido := 0.90;
    r.req1 := a.h8;
    r.req2 := r.intvencido;
    r.reciprocidad := a.h7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='181-365 dias';
    r.nocreditos := a.i1;
    r.pornocreditos := a.i2;
    r.saldo := a.i3;
    r.porsaldo := a.i4;
    r.intvigente := a.i5;
    r.intvencido := a.i6;
    r.porrequerido := 1.00;
    r.req1 := a.i8;
    r.req2 := r.intvencido;
    r.reciprocidad := a.i7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='>365 dias';
    r.nocreditos := a.j1;
    r.pornocreditos := a.j2;
    r.saldo := a.j3;
    r.porsaldo := a.j4;
    r.intvigente := a.j5;
    r.intvencido := a.j6;
    r.porrequerido := 1.00;
    r.req1 := a.j8;
    r.req2 := r.intvencido;
    r.reciprocidad := a.j7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;
  end loop;


else

raise notice 'Consolidado nocreditos %  Saldo %',lnocreditos,fsaldo;

for a in

select sum(case when p.diasvencidos=0
                then 1
                else 0 end) as a1,
       round(sum(case when p.diasvencidos=0
                then 1
                else 0 end)/(lnocreditos/1.00),6) as a2,
       sum(case when p.diasvencidos=0
                then p.saldoprestamo
                else 0 end) as a3,
       round(sum(case when p.diasvencidos=0
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as a4,
       sum(case when p.diasvencidos=0
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as a5,
       sum(case when p.diasvencidos=0
                then p.interesdevengadomayoravencido
                else 0 end) as a6,
       sum(case when p.diasvencidos=0
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as a7,
       sum(case when p.diasvencidos=0
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as a8,

       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then 1
                else 0 end) as b1,
       round(sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then 1
                else 0 end)/lnocreditos,6) as b2,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo
                else 0 end) as b3,
       round(sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as b4,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as b5,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.interesdevengadomayoravencido
                else 0 end) as b6,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as b7,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as b8,



       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then 1
                else 0 end) as c1,
       round(sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then 1
                else 0 end)/lnocreditos,6) as c2,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo
                else 0 end) as c3,
       round(sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as c4,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as c5,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.interesdevengadomayoravencido
                else 0 end) as c6,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as c7,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as c8,

       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then 1
                else 0 end) as d1,
       round(sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then 1
                else 0 end)/lnocreditos,6) as d2,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo
                else 0 end) as d3,
       round(sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as d4,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as d5,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.interesdevengadomayoravencido
                else 0 end) as d6,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as d7,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as d8,

 
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then 1
                else 0 end) as e1,
       round(sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then 1
                else 0 end)/lnocreditos,6) as e2,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo
                else 0 end) as e3,
       round(sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as e4,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as e5,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.interesdevengadomayoravencido
                else 0 end) as e6,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as e7,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as e8,

       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then 1
                else 0 end) as f1,
       round(sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then 1
                else 0 end)/lnocreditos,6) as f2,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo
                else 0 end) as f3,
       round(sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as f4,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as f5,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.interesdevengadomayoravencido
                else 0 end) as f6,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as f7,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as f8,


       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then 1
                else 0 end) as g1,
       round(sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then 1
                else 0 end)/lnocreditos,6) as g2,
       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then p.saldoprestamo
                else 0 end) as g3,
       round(sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as g4,
       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as g5,
       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then p.interesdevengadomayoravencido
                else 0 end) as g6,
       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as g7,
       sum(case when p.diasvencidos>120 and p.diasvencidos<151
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as g8,


       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then 1
                else 0 end) as h1,
       round(sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then 1
                else 0 end)/lnocreditos,6) as h2,
       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then p.saldoprestamo
                else 0 end) as h3,
       round(sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as h4,
       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as h5,
       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then p.interesdevengadomayoravencido
                else 0 end) as h6,
       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as h7,
       sum(case when p.diasvencidos>150 and p.diasvencidos<211
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as h8,


       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then 1
                else 0 end) as i1,
       round(sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then 1
                else 0 end)/lnocreditos,6) as i2,
       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then p.saldoprestamo
                else 0 end) as i3,
       round(sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as i4,
       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as i5,
       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then p.interesdevengadomayoravencido
                else 0 end) as i6,

       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as i7,
       sum(case when p.diasvencidos>210 and p.diasvencidos<366
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as i8,


       sum(case when p.diasvencidos>365
                then 1
                else 0 end) as j1,
       round(sum(case when p.diasvencidos>365
                then 1
                else 0 end)/lnocreditos,6) as j2,
       sum(case when p.diasvencidos>365
                then p.saldoprestamo
                else 0 end) as j3,
       round(sum(case when p.diasvencidos>365
                then p.saldoprestamo
                else 0 end)/fsaldo,6) as j4,
       sum(case when p.diasvencidos>365
                then p.interesdevengadomenoravencido+p.interesdevmormenor
                else 0 end) as j5,
       sum(case when p.diasvencidos>365
                then p.interesdevengadomayoravencido
                else 0 end) as j6,
       sum(case when p.diasvencidos>365
                then (case when p.depositogarantia >0 then p.depositogarantia else 0 end)
                else 0 end) as j7,
       sum(case when p.diasvencidos>365
                then p.saldoprestamo*p.porcentajeaplicado else 0 end) as j8

from precorteconsolidado( cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int)) p
where p.saldoprestamo>0 and p.finalidaddefault=sdescripcionfinalidad 

  loop

    raise notice ' reciprocidad % %',a.a7,a.a8;

    r.rango:='0 dias';
    r.nocreditos := a.a1;
    r.pornocreditos :=  a.a2;
    r.saldo := a.a3;
    r.porsaldo := a.a4;
    r.intvigente := a.a5;
    r.intvencido := a.a6;
    r.porrequerido := 0.01;
    r.req1 := a.a8;
    r.req2 := 0.00;
    r.reciprocidad := a.a7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='1-7  dias';
    r.nocreditos := a.b1;
    r.pornocreditos := a.b2;
    r.saldo := a.b3;
    r.porsaldo := a.b4;
    r.intvigente := a.b5;
    r.intvencido := a.b6;
    r.porrequerido := 0.04;
    r.req1 := a.b8;
    r.req2 := 0.00;
    r.reciprocidad := a.b7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='8-30 dias';
    r.nocreditos := a.c1;
    r.pornocreditos := a.c2;
    r.saldo := a.c3;
    r.porsaldo := a.c4;
    r.intvigente := a.c5;
    r.intvencido := a.c6;
    r.porrequerido := 0.15;
    r.req1 := a.c8;
    r.req2 := 0.00;
    r.reciprocidad := a.c7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;    

    r.rango:='31-60 dias';
    r.nocreditos := a.d1;
    r.pornocreditos := a.d2;
    r.saldo := a.d3;
    r.porsaldo := a.d4;
    r.intvigente := a.d5;
    r.intvencido := a.d6;
    r.porrequerido := 0.30;
    r.req1 := a.d8;
    r.req2 := 0.00;
    r.reciprocidad := a.d7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;



    r.rango:='61-90 dias';
    r.nocreditos := a.e1;
    r.pornocreditos := a.e2;
    r.saldo := a.e3;
    r.porsaldo := a.e4;
    r.intvigente := a.e5;
    r.intvencido := a.e6;
    r.porrequerido := 0.50;
    r.req1 := a.e8;
    r.req2 := 0.00;
    r.reciprocidad := a.e7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;


    r.rango:='91-120 dias';
    r.nocreditos := a.f1;
    r.pornocreditos := a.f2;
    r.saldo := a.f3;
    r.porsaldo := a.f4;
    r.intvigente := a.f5;
    r.intvencido := a.f6;
    r.porrequerido := 0.75;
    r.req1 := a.f8;
    r.req2 := r.intvencido;
    r.reciprocidad := a.f7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;


    r.rango:='121-150 dias';
    r.nocreditos := a.g1;
    r.pornocreditos := a.g2;
    r.saldo := a.g3;
    r.porsaldo := a.g4;
    r.intvigente := a.g5;
    r.intvencido := a.g6;
    r.porrequerido := 0.90;
    r.req1 := a.g8;
    r.req2 := r.intvencido;
    r.reciprocidad := a.g7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='151-180 dias';
    r.nocreditos := a.h1;
    r.pornocreditos := a.h2;
    r.saldo := a.h3;
    r.porsaldo := a.h4;
    r.intvigente := a.h5;
    r.intvencido := a.h6;
    r.porrequerido := 0.90;
    r.req1 := a.h8;
    r.req2 := r.intvencido;
    r.reciprocidad := a.h7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='181-365 dias';
     r.nocreditos := a.i1;
    r.pornocreditos := a.i2;
    r.saldo := a.i3;
    r.porsaldo := a.i4;
    r.intvigente := a.i5;
    r.intvencido := a.i6;
    r.porrequerido := 1.00;
    r.req1 := a.i8;
    r.req2 := r.intvencido;
    r.reciprocidad := a.i7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;

    r.rango:='>365 dias';
    r.nocreditos := a.j1;
    r.pornocreditos := a.j2;
    r.saldo := a.j3;
    r.porsaldo := a.j4;
    r.intvigente := a.j5;
    r.intvencido := a.j6;
    r.porrequerido := 1.00;
    r.req1 := a.j8;
    r.req2 := r.intvencido;
    r.reciprocidad := a.j7;
    r.poridnc := fporrequerido;
    r.por2006 := fporrequerido;
    return next r;
  end loop;



end if;

return;

END;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.clasificaxtipofinalidad(date, character, character) OWNER TO sistema;

--
-- Name: claveusuarios(character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION claveusuarios(character, character) RETURNS integer
    AS $_$
declare

pclave1 alias for $1;
pclave2 alias for $2;

r record;
susuarioid char(20);

begin

      update usuarios set usuarioid=pclave1 where usuarioid=pclave2;
      update usuarios set usu_usuarioid=pclave1 where usu_usuarioid=pclave2;
      update parametros set usuarioid=pclave1 where usuarioid=pclave2;
      update permisosmodulos set usuarioid=pclave1 where usuarioid=pclave2;    
      update solicitudingreso set usuarioid=pclave1 where usuarioid=pclave2;
      update prestamos set usuarioid=pclave1 where usuarioid=pclave2;
      update logpoliza set usuarioid=pclave1 where usuarioid=pclave2;
      update solicitudprestamo set usuarioid=pclave1 where usuarioid=pclave2;
      update convenio set usuarioid=pclave1 where usuarioid=pclave2;
      update tablon set usuarioid=pclave1 where usuarioid=pclave2;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.claveusuarios(character, character) OWNER TO sistema;

--
-- Name: cletra(numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cletra(numeric) RETURNS character varying
    AS $_$
declare

ptotal  alias for $1;

total numeric;
total1 numeric;
cent2  numeric;
cent   numeric;
cent1  char(2);
mil    numeric;
millon numeric;
millones numeric;
sav    numeric;
unit   numeric;
deci   numeric;
centi  numeric;
factor numeric;
sav1   numeric;
depesos numeric;
lletra  varchar;
letras varchar;

begin

   total := ptotal;

   total1:= total;
   total := trunc(total);
   cent2 := total1 - total;
   cent  := cent2*100;
   cent1 := '00';

   if total=0 then 
      lletra := 'CERO PESOS';
      return 'CERO PESOS';
   end if;

   mil:=0;
   millon:=0;
   millones:=0;
   depesos:=0;
   sav:=1;
   unit:=1;
   deci:=1;
   centi:=1;
   factor:=1;
   sav1:=1;
   letras:=' ';
   
   while total > 0 loop 
      if total > 1999999 then
         depesos  := 1;
         factor   := 1000000;
         millones := 1;
         millon   := 0;
      else
         if total > 999999 then
            depesos := 1;
            factor  := 1000000;
            millon  := 1;
         else
            if total > 999 then
               factor := 1000;
               mil    := 1;
            else
               factor := 1;
               mil := 0;
            end if;
         end if;
      end if;

      sav := total;

      total := trunc(total/factor);
      sav  := sav-(total*factor);
      if sav <> 0 then
         depesos := 0;
      end if;

      centi:=TRUNC(total/100);

      if centi = 0 then
         letras := rtrim(letras)||'   ';
      end if;
      if centi = 1 then
         if total = 100 then
            letras := rtrim(letras)||' CIEN';
         else
            letras := rtrim(letras)||' CIENTO';
         end if;
      end if;
      if centi = 2 then
         letras := rtrim(letras)||' DOSCIENTOS';
      end if;
      if centi = 3 then
         letras := rtrim(letras)||' TRESCIENTOS';
      end if;
      if centi = 4 then
         letras := rtrim(letras)||' CUATROCIENTOS';
      end if;
      if centi = 5 then
         letras := rtrim(letras)||' QUINIENTOS';
      end if;
      if centi = 6 then
         letras := rtrim(letras)||' SEISCIENTOS';
      end if;
      if centi = 7 then
         letras := rtrim(letras)||' SETECIENTOS';
      end if;
      if centi = 8 then
         letras := rtrim(letras)||' OCHOCIENTOS';
      end if;
      if centi = 9 then
         letras := rtrim(letras)||' NOVECIENTOS';
      end if;
  
      total:=total - (centi*100);
      deci :=trunc(total/10);
      unit :=total-(deci*10);

      if total >= 30 then
         if deci = 3 then
            letras := rtrim(letras)||' TREINTA';
         end if;
         if deci = 4 then
            letras := rtrim(letras)||' CUARENTA';
         end if;
         if deci = 5 then
            letras := rtrim(letras)||' CINCUENTA';
         end if;
         if deci = 6 then
            letras := rtrim(letras)||' SESENTA';
         end if;
         if deci = 7 then
            letras := rtrim(letras)||' SETENTA';
         end if;
         if deci = 8 then
            letras := rtrim(letras)||' OCHENTA';
         end if;
         if deci = 9 then
            letras := rtrim(letras)||' NOVENTA';
         end if;
         if unit > 0 then
            letras := rtrim(letras)||' Y';
         end if;
      else
         unit := total;
      end if;
  
      if unit = 0 then
         letras := rtrim(letras)||' ';
      end if; 
      if unit = 1 then
         letras := rtrim(letras)||' UN';
      end if;
      if unit = 2 then
         letras := rtrim(letras)||' DOS';
      end if;
      if unit = 3 then
         letras := rtrim(letras)||' TRES';
      end if;
      if unit = 4 then
         letras := rtrim(letras)||' CUATRO';
      end if;
      if unit = 5 then
         letras := rtrim(letras)||' CINCO';
      end if;
      if unit = 6 then
         letras := rtrim(letras)||' SEIS';
      end if;
      if unit = 7 then
         letras := rtrim(letras)||' SIETE';
      end if;
      if unit = 8 then
         letras := rtrim(letras)||' OCHO';
      end if;
      if unit = 9 then
         letras := rtrim(letras)||' NUEVE';
      end if;
      if unit = 10 then
         letras := rtrim(letras)||' DIEZ';
      end if;
      if unit = 11 then
         letras := rtrim(letras)||' ONCE';
      end if;
      if unit = 12 then
         letras := rtrim(letras)||' DOCE';
      end if;
      if unit = 13 then
         letras := rtrim(letras)||' TRECE';
      end if;
      if unit = 14 then
         letras := rtrim(letras)||' CATORCE';
      end if;
      if unit = 15 then
         letras := rtrim(letras)||' QUINCE';
      end if;
      if unit = 16 then
         letras := rtrim(letras)||' DIECISEIS';
      end if;
      if unit = 17 then
         letras := rtrim(letras)||' DIECISIETE';
      end if;
      if unit = 18 then
         letras := rtrim(letras)||' DIECIOCHO';
      end if;
      if unit = 19 then
         letras := rtrim(letras)||' DIECINUEVE';
      end if;
      if unit = 20 then
         letras := rtrim(letras)||' VEINTE';
      end if;
      if unit = 21 then
         letras := rtrim(letras)||' VEINTIUN';
      end if;
      if unit = 22 then
         letras := rtrim(letras)||' VEINTIDOS';
      end if;
      if unit = 23 then
         letras := rtrim(letras)||' VEINTITRES';
      end if;
      if unit = 24 then
         letras := rtrim(letras)||' VEINTICUATRO';
      end if;
      if unit = 25 then
         letras := rtrim(letras)||' VEINTICINCO';
      end if;
      if unit = 26 then
         letras := rtrim(letras)||' VEINTISEIS';
      end if;
      if unit = 27 then
         letras := rtrim(letras)||' VEINTISIETE';
      end if;
      if unit = 28 then
         letras := rtrim(letras)||' VEINTIOCHO';
      end if;
      if unit = 29 then
         letras := rtrim(letras)||' VEINTINUEVE';
      end if;
      if millones=1 then
         letras := rtrim(letras)||' MILLONES';
         millones := 0;
      else
         if millon=1 then
            letras := rtrim(letras)||' MILLON';
            millon := 0;
         else
            if mil=1 then
               letras := rtrim(letras)||' MIL';
               mil := 0;
            end if;
         end if;
      end if;
      total:=sav;
   end loop;

   if cent=0 then
      cent1:='00';
   else
      --cent1:=cast(cent as char(2));
      cent1:=ltrim(rtrim(to_char(cent,'00')));
   end if;
   if depesos=1 then
      letras := rtrim(letras)||' DE PESOS '||cent1||'/100 M.N.';
   else
      letras := rtrim(letras)||' PESOS '||cent1||'/100 M.N.';
   end if;

   lletra := '('||ltrim(letras)||')';

return lletra;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cletra(numeric) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: monedas; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE monedas (
    monedaid character(2) NOT NULL,
    monedavalor numeric NOT NULL,
    monedadescri character varying(30) NOT NULL
);


ALTER TABLE sucursal1.monedas OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: cmonedas(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cmonedas() RETURNS SETOF sucursal1.monedas
    AS $$
declare
  r monedas%rowtype;
begin

 for r in

   SELECT * FROM
        dblink('host=snfelipe.dnsalias.org dbname=snfelipe user=sistema','select * from sucursal2.monedas') as
               t1(monedaid char(2),monedavalor numeric,monedadescri varchar(30))
        ,
        dblink('host=dolores.dnsalias.org dbname=reforma2 user=sistema','select * from sucursal1.monedas') as
               t2(monedaid char(2),monedavalor numeric,monedadescri varchar(30))
 loop
   return next r;
 end loop;

return;
end
$$
    LANGUAGE plpgsql;


ALTER FUNCTION public.cmonedas() OWNER TO sistema;

--
-- Name: colnoespe(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION colnoespe() RETURNS integer
    AS $$
declare
  r record;
  i int4;
begin

  i:=0;
  for r in

select ciudadmexid
from ciudadesmex

  loop

insert into colonia(ciudadmexid,nombrecolonia) values (r.ciudadmexid,'NO ESPECIFICADA');

  end loop;
return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.colnoespe() OWNER TO sistema;

--
-- Name: coloniaclaveconapo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION coloniaclaveconapo(integer) RETURNS integer
    AS $_$
declare

pestadomex alias for $1;

r record;

pclavemunicipio char(4);
pclaveestado char(4);
pclaveconapo char(10);

j integer;

begin

j:=0;
for r in select coloniaid,ciudadmexid,'%'||ltrim(rtrim(substring(nombrecolonia,1,40)))||'%' as nombrecolonia from colonia where ciudadmexid in ( select ciudadmexid from ciudadesmex where estadomexid = pestadomex)

   loop

      select clavemunicipio,claveestado into pclavemunicipio,pclaveestado from comunidadconapo cp, ciudadesmex cd where cp.claveconapo=cd.claveconapo and cd.ciudadmexid=r.ciudadmexid;

      --raise notice 'select claveconapo,nombre from comunidadconapo where claveestado= % and clavemunicipio= % and nombre like % ',pclaveestado,pclavemunicipio,r.nombrecolonia;

      select max(claveconapo) into pclaveconapo from comunidadconapo where claveestado=pclaveestado and clavemunicipio=pclavemunicipio and nombre like r.nombrecolonia;

      if pclaveconapo is not null then 

        update colonia set claveconapo=pclaveconapo  where coloniaid= r.coloniaid;

        --raise notice ' Encontre % %  % ',r.nombrecolonia,r.coloniaid,pclaveconapo;

        j=j+1;

      end if ;
      
   end loop;

return j;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.coloniaclaveconapo(integer) OWNER TO sistema;

--
-- Name: conciliabanco(character, date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION conciliabanco(character, date, date) RETURNS SETOF tconcilia
    AS $_$
declare

  pno_cuenta   alias for $1;
  pfechai      alias for $2;
  pfechaf      alias for $3;

  r tconcilia%rowtype;


begin

    for r in

select p.fechapoliza, t.descritipomovibanco, m.referenciamovi, m.beneficiario, 
       mp.debe, mp.haber,
       m.conciliado, m.movibancoid
  from movibanco m, polizas p, movipolizas mp, tipomovibanco t
 where m.no_cuenta=pno_cuenta and
       p.polizaid = m.polizaid and
       p.fechapoliza between pfechai and pfechaf and
       mp.polizaid = p.polizaid and
       mp.movipolizaid = m.movipolizaid and
       t.tipomovibancoid = m.tipomovibancoid
order by p.fechapoliza       
     
    loop

      return next r;

    end loop;
   

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.conciliabanco(character, date, date) OWNER TO sistema;

--
-- Name: consistencia(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION consistencia(character) RETURNS integer
    AS $_$
declare

  preferenciaprestamo alias for $1;

  lmonto numeric;
  lamor  numeric;

  iValido int4;
begin


  SELECT p.montoprestamo,sum(a.importeamortizacion)
    into lmonto,lamor
    from prestamos p, amortizaciones a
   where a.prestamoid=p.prestamoid and p.referenciaprestamo=preferenciaprestamo
group by montoprestamo;

  lmonto := coalesce(lmonto,0);
  lamor := coalesce(lamor,0);

  if lmonto<>lamor then
    iValido := 0;
  else
    iValido := 1;
  end if;


return iValido;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.consistencia(character) OWNER TO sistema;

--
-- Name: consolidabalanza(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION consolidabalanza() RETURNS SETOF sucursal1.catalogo_ctas
    AS $_$
declare

--  pejercicio alias for $1;
--  pperiodo   alias for $2;
  r catalogo_ctas%rowtype;

  -- Totales debe y haber
  ldebe numeric;
  lhaber numeric;

begin

  ldebe := 0;
  lhaber := 0;

  for r in
    select c.cuentaid,c.cat_cuentaid,c.identificacion,c.cuentanombre,c.tipo_cta,c.estado_cta,c.fecha_estado,c.fecha_ult_mov,c.naturaleza,c.digito_agrupador,sum(b.saldoinicialperiodo) as saldo_inic_ejer, sum(b.cargosdelperiodo) as cargos_acum_ejer,sum(b.abonosdelperiodo) as abonos_acum_ejer
    from catalogo_ctas c, cbalanza() as b
    where b.cuentaid=c.cuentaid
  group by c.cuentaid,c.cat_cuentaid,c.identificacion,c.cuentanombre,c.tipo_cta,c.estado_cta,c.fecha_estado,c.fecha_ult_mov,c.naturaleza,c.digito_agrupador
  loop
      if r.tipo_cta='A' then
        ldebe := ldebe + r.cargos_acum_ejer;
        lhaber := lhaber + r.abonos_acum_ejer;
      end if;

    return next r;
  end loop;


 r.cuentaid := 'T';
 r.cuentanombre := 'TOTALES .... ';
 r.cargos_acum_ejer := ldebe;
 r.abonos_acum_ejer := lhaber;
 return next r;

return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.consolidabalanza() OWNER TO sistema;

--
-- Name: consolidabalanza(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION consolidabalanza(integer, integer) RETURNS SETOF sucursal1.catalogo_ctas
    AS $_$
declare

  pejercicio alias for $1;
  pperiodo   alias for $2;
  r catalogo_ctas%rowtype;

  -- Totales debe y haber
  ldebe numeric;
  lhaber numeric;

begin

  ldebe := 0;
  lhaber := 0;

  for r in
    select c.cuentaid,c.cat_cuentaid,c.identificacion,c.cuentanombre,c.tipo_cta,c.estado_cta,c.fecha_estado,c.fecha_ult_mov,c.naturaleza,c.digito_agrupador,sum(b.saldoinicialperiodo) as saldo_inic_ejer, sum(b.cargosdelperiodo) as cargos_acum_ejer,sum(b.abonosdelperiodo) as abonos_acum_ejer
    from catalogo_ctas c, cbalanza(pejercicio,pperiodo) as b
    where b.cuentaid=c.cuentaid
  group by c.cuentaid,c.cat_cuentaid,c.identificacion,c.cuentanombre,c.tipo_cta,c.estado_cta,c.fecha_estado,c.fecha_ult_mov,c.naturaleza,c.digito_agrupador
  loop
      if r.tipo_cta='A' then
        ldebe := ldebe + r.cargos_acum_ejer;
        lhaber := lhaber + r.abonos_acum_ejer;
      end if;

    return next r;
  end loop;


 r.cuentaid := 'T';
 r.cuentanombre := 'TOTALES .... ';
 r.cargos_acum_ejer := ldebe;
 r.abonos_acum_ejer := lhaber;
 return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.consolidabalanza(integer, integer) OWNER TO sistema;

--
-- Name: consultamovd(character, character, character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION consultamovd(character, character, character, character, date) RETURNS SETOF rconsultamov
    AS $_$
declare

  ptm1          alias for $1;
  ptm2          alias for $2;
  ptm3          alias for $3;
  ptm4          alias for $4;
  pfecha        alias for $5;

  r rconsultamov%rowtype;
  l record;

  fsaldo1 numeric;
  fsaldo2 numeric;
  fsaldo3 numeric;
  fsaldo4 numeric;

  dfecha1 date;
  dfecha2 date;
  dfecha3 date;
  dfecha4 date;

  ftsaldo1 numeric;
  ftsaldo2 numeric;
  ftsaldo3 numeric;
  ftsaldo4 numeric;

begin

  ftsaldo1 := 0;
  ftsaldo2 := 0;
  ftsaldo3 := 0;
  ftsaldo4 := 0;

    for l in
      select s.clavesocioint,
             su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
             s.socioid
        from socio s, sujeto su
       where su.sujetoid = s.sujetoid
    loop

      raise notice 'Procesando %',l.clavesocioint;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo1,dfecha1
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm1 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.fechapoliza<=pfecha;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo2,dfecha2
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm2 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.fechapoliza<=pfecha;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo3,dfecha3
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm3 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.fechapoliza<=pfecha;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo4,dfecha4
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm4 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.fechapoliza<=pfecha;


        r.clavesocioint := l.clavesocioint;
        r.nombresocio := l.nombresocio;
        r.saldo1 := coalesce(fsaldo1,0.00);
        r.saldo2 := coalesce(fsaldo2,0.00);
        r.saldo3 := coalesce(fsaldo3,0.00);
        r.saldo4 := coalesce(fsaldo4,0.00);
        r.fecha1 := dfecha1;
        r.fecha2 := dfecha2;
        r.fecha3 := dfecha3;
        r.fecha4 := dfecha4;

        ftsaldo1 := ftsaldo1 + r.saldo1;
        ftsaldo2 := ftsaldo2 + r.saldo2;
        ftsaldo3 := ftsaldo3 + r.saldo3;
        ftsaldo4 := ftsaldo4 + r.saldo4;
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.consultamovd(character, character, character, character, date) OWNER TO sistema;

--
-- Name: consultamovdc(character, character, character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION consultamovdc(character, character, character, character, date) RETURNS SETOF rconsultamov
    AS $_$
declare

  ptm1          alias for $1;
  ptm2          alias for $2;
  ptm3          alias for $3;
  ptm4          alias for $4;
  pfecha        alias for $5;

  r rconsultamov%rowtype;

  ftsaldo1 numeric;
  ftsaldo2 numeric;
  ftsaldo3 numeric;
  ftsaldo4 numeric;

  f record;
  dblink1 text;
  dblink2 text;
begin

  ftsaldo1 := 0;
  ftsaldo2 := 0;
  ftsaldo3 := 0;
  ftsaldo4 := 0;

for f in
 select * from sucursales where vigente='S'
 loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||';
        select * from consultamovd('||''''||ptm1||''''||','||
                                       ''''||ptm2||''''||','||
                                       ''''||ptm3||''''||','||
                                       ''''||ptm4||''''||','||
                                       ''''||to_char(pfecha,'yyyy-mm-dd')||''''||');';

  for r in
    select * from
    dblink(dblink1,dblink2) as
    t ( clavesocioint           char(15),
        nombresocio             varchar(81),
        saldo1                  numeric,
        saldo2                  numeric,
        saldo3                  numeric,
        saldo4                  numeric,
        fecha1                  date,
        fecha2                  date,
        fecha3                  date,
        fecha4                  date)
  loop

        ftsaldo1 := ftsaldo1 + r.saldo1;
        ftsaldo2 := ftsaldo2 + r.saldo2;
        ftsaldo3 := ftsaldo3 + r.saldo3;
        ftsaldo4 := ftsaldo4 + r.saldo4;

    return next r;
  end loop;

  end loop;

    r.clavesocioint := 'Z';
    r.nombresocio := 'TOTALES';
    r.saldo1 := ftsaldo1;
    r.saldo2 := ftsaldo2;
    r.saldo3 := ftsaldo3;
    r.saldo4 := ftsaldo4;
    return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.consultamovdc(character, character, character, character, date) OWNER TO sistema;

--
-- Name: consultasocio(character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION consultasocio(character, date) RETURNS text
    AS $_$
declare

  pclavesocioint alias for $1;
  pfecha alias for $2;

  tipocasa integer;
  tipocasas char(10);
  estadocivil text;

  psucursal char(10);
  pnombrecaja char(80);
  prfccaja char(20);
  pdireccioncaja char(100);
  psucid char(4);

  l record;
  x record;
  pformato text;
  ptexto text;
  pmes int;
  psmes varchar;
  pdia char(2);
  pano char(4);
  conyuge1 int;
  conyuge text;  
  --r pdatoaval%rowtype;
  pdebes numeric;
  phaberes numeric;
  psocioid int;
  pcuentaactivo char(24);
  psaldoprestamo numeric;
  pclaveaval char(15);
  i integer;


begin

-- Datos de la empresa y sucursal
  select nombrecaja, rfccaja, direccioncaja,sucid
    into pnombrecaja, prfccaja, pdireccioncaja, psucid
    from empresa;

  pnombrecaja := coalesce(pnombrecaja,' ');
  prfccaja := coalesce(prfccaja,' ');  
  pdireccioncaja := coalesce(pdireccioncaja,' ');
  psucid := coalesce(psucid,' ');

  select (current_schemas(false))[2]
    into psucursal;

-- Obtener socio
  select socioid 
    into psocioid
    from socio
   where clavesocioint = pclavesocioint;

  select soi.tipocasaid,soi.estadocivilid
    into tipocasa,estadocivil
    from socio so, solicitudingreso soi
   where so.socioid = psocioid and
         so.socioid = soi.socioid; 


-- Determinar Tipo de Casa  
  if tipocasa=0 then
	--CASA RENTADA
	tipocasas:='Rentada';
  end if;
  
  if tipocasa=1 then
	--CASA PROPIA
	tipocasas:='Propia';
  end if;	
  
  if tipocasa=2 then
	--CASA FAMILIAR
	tipocasas:='Familiar';
  end if;	  


--Determinar Estado Civil
  if rtrim(estadocivil)='0' then
	--SOLTERO
	estadocivil:='Soltero';
  end if;
  
  if rtrim(estadocivil)='1' then
	--CASADO
	estadocivil:='Casado';
  end if;	
  
  if rtrim(estadocivil)='2' then
	--DIVORCIADO
	estadocivil:='Divorciado';
  end if;	    
  
  if rtrim(estadocivil)='3' then
	--VIUDO
	estadocivil:='Viudo';
  end if;	
  
  if rtrim(estadocivil)='4' then
	--UNION LIBRE
	estadocivil:='Union Libre';
  end if;	  


-- Nombre del conyuge
  select soi.conyugeid
    into conyuge1
    from socio so ,solicitudingreso soi
   where so.socioid = psocioid and 
         soi.socioid = so.socioid;

  conyuge1:=coalesce(conyuge1,0);
  raise notice 'ConyugeID==%',conyuge1;

  if conyuge1 is not null and conyuge1 > 0 then
     select rtrim(nombre)||' '||rtrim(paterno)||' '||rtrim(materno)
       into conyuge
       from sujeto
      where sujetoid = conyuge1;
  else
     conyuge:='';
  end if;  
  conyuge:=coalesce(conyuge,'');

  raise notice 'Conyuge %',conyuge;


-- Fecha de Corte  
  pmes:=cast(date_part('month',pfecha) as int);
  pdia:=cast(date_part('day',pfecha) as char(2));
  pano:=cast(date_part('year',pfecha) as char(4));

  if pmes=1 then
    psmes := 'Enero     ';
  end if;
  if pmes=2 then
    psmes := 'Febrero   ';
  end if;
  if pmes=3 then
    psmes := 'Marzo     ';
  end if;
  if pmes=4 then
    psmes := 'Abril     ';
  end if;
  if pmes=5 then
    psmes := 'Mayo      ';
  end if;
  if pmes=6 then
    psmes := 'Junio     ';
  end if;
  if pmes=7 then
    psmes := 'Julio     ';
  end if;
  if pmes=8 then
    psmes := 'Agosto    ';
  end if;
  if pmes=9 then
    psmes := 'Septiembre';
  end if;
  if pmes=10 then
    psmes := 'Octubre   ';
  end if;
  if pmes=11 then
    psmes := 'Noviembre ';
  end if;
  if pmes=12 then
    psmes := 'Diciembre ';
  end if;

  psmes := rtrim(psmes);


-- Formato de Datos del Socio
  select 
         
         chr(10)||chr(13)||
         'Suc. '||psucid||psucursal||lpad('GENERALES DEL SOCIO',length('GENERALES DEL SOCIO')+
             (74-length('GENERALES DEL SOCIO'))/2,' ')||lpad('Fecha :  ',35,' ')||pdia||'/'||
         substr(psmes,1,3)||'/'||pano||chr(10)||chr(13)||
        '   Socio No. : '||so.clavesocioint||chr(10)||chr(13)||
        '   Nombre    : '||alineap(su.nombre||' '||su.paterno||' '||su.materno)||'  '||
        'R.F.C.     : '||su.rfc||chr(13)||chr(10)||
        '   Domicilio : '||alineap(rtrim(d.calle)||'  '||rtrim(d.numero_ext))||'  '||
        'Telefono   : '||d.teldomicilio||chr(13)||chr(10)||
        '   Colonia   : '||alineap(co.nombrecolonia)||'  '||'Codigo Pos.: '||d.codpostal||
        chr(13)||chr(10)||'   Comunidad: '||alineap(d.comunidad||'  Ciudad:'||c.nombreciudadmex)||
        '  '||'Estado     : '||
        rtrim(es.nombreestadomex)||chr(13)||chr(10)||
        '   Casa      : '||alineap(coalesce(tipocasas,''))||'  '||'Ocupacion  : '||rtrim(coalesce(soi.ocupacion,''))||
         chr(13)||chr(10)||
	'   Antiguedad: '||alineap(coalesce(soi.tiempovivirendomicilio,''))||'  '||'Edo. Civil : '||coalesce(estadocivil,'')||
	 chr(13)||chr(10)||
	'   Conyuge   : '||conyuge||chr(13)||chr(10)

    into ptexto
    from socio so, sujeto su,domicilio d, solicitudingreso soi,ciudadesmex c,estadosmex es, colonia co
   where so.socioid = psocioid and
         so.sujetoid = su.sujetoid and 
         su.sujetoid = d.sujetoid and
         so.socioid = soi.socioid and
         d.ciudadmexid = c.ciudadmexid and
         es.estadomexid = c.estadomexid and
         d.coloniaid = co.coloniaid;

  ptexto := coalesce(ptexto,' ');

  pformato := ptexto;

--raise notice '%',pformato;

  select '   Empresa donde trabaja : '||sop.empresatrabaja||chr(10)||chr(13)||
	 '   Domicilio : '||alineap(rtrim(d.calle)||'  '||rtrim(d.numero_ext))||'  '||
         'Telefono   : '||d.teldomicilio||chr(13)||chr(10)||
         '   Colonia   : '||alineap(d.colonia)||'  '||'Codigo Pos.: '||d.codpostal||
         chr(13)||chr(10)||'   Comunidad: '||alineap(d.comunidad)||
	 ' Ciudad    : '||alineap(c.nombreciudadmex)||'  '||'Estado     : '||
         rtrim(es.nombreestadomex)||chr(13)||chr(10)||
         chr(13)||chr(10)||
         lpad('  INFORMACION ECONOMICA DEL SOCIO  ',53,'=')||lpad('=',37,'=')||chr(10)||chr(13)||
	 chr(13)||chr(10)||	 
	 '   Ingresos Mensuales:'||to_char(sop.totalingresos-sop.otrosingresos,'99,999,999.99')||
         lpad('Gastos Mensuales: ',57,' ')||
         to_char(sop.totaldeudas-sop.otrosgastos,'99,999,999.99')||chr(10)||chr(13)||
	 '   Otros Ingresos    :'||to_char(sop.otrosingresos,'99,999,999.99')||
         lpad('Fecha de Alta   : ',57,' ')||to_char(so.fechaalta,'dd/mm/yyyy')||chr(10)||chr(13)||
	 '   Valor estimado de propiedades:'||to_char(sop.valorpropiedades,'99,999,999.99')||
         lpad('Deudas fuera de la Cooperativa: ',46,' ')||
         to_char(sop.otrosgastos,'99,999,999.99')||chr(10)||chr(13)||chr(13)||chr(10)

    into ptexto
    from socio so, domicilio d, solicitudprestamo sop,ciudadesmex c,estadosmex es
   where so.socioid = psocioid and
         sop.socioid = so.socioid and
         sop.domicilioid = d.domicilioid and
         d.ciudadmexid = c.ciudadmexid and
         es.estadomexid = c.estadomexid;

  if ptexto IS NOT NULL then
     pformato := pformato||ptexto;
  end if;


  pformato := pformato||lpad('  SALDOS DEL SOCIO  ',45,'=')||lpad('=',45,'=')||chr(10)||chr(13);

  --Saldos
  i:=0;
  for l in
      select * from spssaldosmovf(psocioid,pfecha)
   loop
         ptexto := rpad(l.desctipomovimiento,20,' ')||' '||
                   to_char(l.saldo,'$999,999.99')||' ';
         pformato := pformato||ptexto;
         if i= 3 then
                pformato := pformato||chr(13)||chr(10);
                i:=0;
         end if;
   end loop;


  pformato := pformato||chr(13)||chr(10)||
              lpad('  PRESTAMOS  ',42,'=')||lpad('=',48,'=')||chr(10)||chr(13);


  --Prestamos
  for l in
      select * from spsprestamos(psocioid)
   loop

      for x in
          select * from spscalculopago(l.prestamoid)
       loop

          ptexto:= chr(13)||chr(10)||
                   ' Prestamo             :  '||l.tipoprestamoid||'  '||l.referenciaprestamo||
                   ' Monto               :  '||to_char(l.montoprestamo,'99,999,999.99')||
                   chr(13)||chr(10)||
                   ' Fecha de Otorgamiento:  '||to_char(l.fecha_otorga,'dd-mm-yyyy')||
                   ' Fecha de Vencimiento:  '||to_char(l.fecha_vencimiento,'dd-mm-yyyy')||
                   chr(13)||chr(10)||
                   ' Saldo del Prestamo   :  '||to_char(l.saldoprestamo,'9999,999.99')||
                   ' Ultimo movimiento    :  '||to_char(l.fechaultimopago,'dd-mm-yyyy')||
                   chr(13)||chr(10)||
                   ' Capital :'||to_char(x.capital,'$9999,999.99')||
                   ' I. normal :'||to_char(x.interes,'$9999,999.99')||
                   ' I. moratorio :  '||to_char(x.moratorio,'$9999,999.99')||   
                   ' TOTAL : '||to_char((x.capital+x.interes+x.moratorio),'$99999,999.99')||
                   chr(13)||chr(10);

           ptexto := coalesce(ptexto,' ');

           pformato := pformato||ptexto;

       end loop;

      i:= 0;
      for x in
          select a.socioid,rtrim(su.nombre)||' '||rtrim(su.paterno)||' '||rtrim(su.materno) as aval,
                 rtrim(d.calle)||' '||rtrim(d.numero_ext)||' '||rtrim(d.comunidad) as domicilio,
	         d.teldomicilio as telefono	         
            from avales a, sujeto su, domicilio d
           where a.prestamoid = l.prestamoid and
                 a.sujetoid = su.sujetoid and
	         su.sujetoid = d.sujetoid
       loop


           if i = 0 then
              pformato := pformato||chr(10)||chr(13)||'  AVAL(ES): '||
                          chr(10)||chr(13)||'No. SOCIO    NOMBRE                         DOMICILIO      '||chr(10)||chr(13);
              i := 1;
            end if;

            select clavesocioint into pclaveaval
              from socio
             where socioid = x.socioid;

            pclaveaval := coalesce(pclaveaval,'Sin clave      ');

            select sum(saldoprestamo) into pdebes
              from socio so, prestamos p
             where so.socioid = x.socioid and
                   p.socioid = so.socioid;

            pdebes := coalesce(pdebes,0);

            select sum(saldo) into phaberes
              from spssaldosmovf(x.socioid,pfecha);

            phaberes := coalesce(phaberes,0);

            ptexto:= substr(pclaveaval,1,15)||' '||substr(alineap1(x.aval),1,25)||' '||
                     substr(alineap1(x.domicilio),1,50)||' '||substr(alineap2(x.telefono),1,12)|| chr(10)||chr(13)||'Haberes:'||
                     to_char(phaberes,'9999,999.99')||' Deberes:'||to_char(pdebes,'9999,999.99')||
                     chr(10)||chr(13);

            ptexto := coalesce(ptexto,' ');

            pformato := pformato||ptexto||chr(10)||chr(13);

       end loop;
    
   end loop;


  -- AVALADOS
   i := 0;
   for x in
          select p.socioid, rtrim(su.nombre)||' '||rtrim(su.paterno)||' '||rtrim(su.materno) as aval,
                 rtrim(d.calle)||' '||rtrim(d.numero_ext)||' '||rtrim(d.comunidad) as domicilio,
	         d.teldomicilio as telefono	        
            from avales a, prestamos p, socio s, sujeto su, domicilio d
           where a.socioid = psocioid and
                 a.prestamoid=p.prestamoid and 
                 p.socioid = s.socioid and
                 s.sujetoid = su.sujetoid and
	         su.sujetoid = d.sujetoid
       loop

            if i = 0 then
              pformato := pformato||chr(10)||chr(13)||'  AVALADOS: '||
                          chr(10)||chr(13)||'No. SOCIO    NOMBRE                         DOMICILIO                  '||chr(10)||chr(13);
              i := 1;
            end if;

            select clavesocioint into pclaveaval
              from socio
             where socioid = x.socioid;

            pclaveaval := coalesce(pclaveaval,'Sin clave      ');

            select sum(saldoprestamo) into pdebes
              from socio so, prestamos p
             where so.socioid = x.socioid and
                   p.socioid = so.socioid;

            pdebes := coalesce(pdebes,0);

            select sum(saldo) into phaberes
              from spssaldosmovf(x.socioid,pfecha);

            phaberes := coalesce(phaberes,0);

            ptexto:= substr(pclaveaval,1,14)||' '||substr(alineap1(x.aval),1,30)||' '||
                     substr(alineap1(x.domicilio),1,50)||' '||substr(alineap2(x.telefono),1,12)|| chr(10)||chr(13)||'Haberes:'||
                     to_char(phaberes,'99999,999.99')||' Deberes:'||to_char(pdebes,'99999,999.99')||
                     chr(10)||chr(13);

            ptexto := coalesce(ptexto,' ');

            pformato := pformato||ptexto||chr(10)||chr(13);

       end loop;


return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.consultasocio(character, date) OWNER TO sistema;

--
-- Name: corregirreciprocidadprecorte(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION corregirreciprocidadprecorte(date) RETURNS numeric
    AS $_$
declare

pfecha alias for $1;

sumaprestamos numeric;
reciprocidad numeric;
sumadeposito numeric;
sumareciprocidad numeric;

r record;
f record;

begin

update precorte set depositogarantia=0 where fechacierre=pfecha;
sumadeposito :=0;
sumareciprocidad:=0;

for r in select socioid,sum(deposito) as deposito from captaciontotal where fechadegeneracion=pfecha and tipomovimientoid in ('AA','P3') group by socioid order by socioid
loop
    
    select sum(saldoprestamo) into sumaprestamos from precorte where prestamoid in (select prestamoid from prestamos where socioid=r.socioid) and fechacierre=pfecha ;

    sumaprestamos:=coalesce(sumaprestamos,0);   
    sumadeposito := sumadeposito +r.deposito;

    for f in select p.precorteid,p.saldoprestamo,pr.socioid,p.prestamoid from precorte p, prestamos pr where p.fechacierre=pfecha and p.saldoprestamo>0 and p.prestamoid=pr.prestamoid and socioid=r.socioid

       loop

         reciprocidad:=trunc(f.saldoprestamo*r.deposito/sumaprestamos);
         reciprocidad:=coalesce(reciprocidad,0);

         --if r.socioid=213 then
         --    raise notice ' % AA % Sdo. Pres % reciprocidad %  saldo % ',r.socioid,r.deposito,sumaprestamos,reciprocidad,f.saldoprestamo;
         --end if;

         update precorte set depositogarantia=reciprocidad where precorteid=f.precorteid;
         sumareciprocidad:= sumareciprocidad+reciprocidad;
         update prestamos set monto_garantia=reciprocidad where prestamoid=f.prestamoid;

       end loop;

end loop;
raise notice ' % ',sumareciprocidad;

return sumadeposito;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.corregirreciprocidadprecorte(date) OWNER TO sistema;

--
-- Name: corrigefrecuencia(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION corrigefrecuencia() RETURNS numeric
    AS $$
declare

iprestamos numeric;
fechaanterior date;

idias integer;
idias2 integer;

r record;

begin

iprestamos:=0;

for r in 

select  prestamoid,numero_de_amor,(select max(numamortizacion) from amortizaciones where prestamoid = prestamos.prestamoid) as numpagos,dias_de_cobro,meses_de_cobro,dia_mes_cobro,fecha_1er_pago,fecha_otorga,fecha_vencimiento from prestamos where numero_de_amor <> (select max(numamortizacion) from amortizaciones where prestamoid = prestamos.prestamoid) and (select max(numamortizacion) from amortizaciones where prestamoid = prestamos.prestamoid) > 0

loop

  select fechadepago into fechaanterior from amortizaciones where numamortizacion=r.numpagos-1 and prestamoid=r.prestamoid;

  fechaanterior:=coalesce(fechaanterior,r.fecha_otorga);

  idias2:=r.fecha_vencimiento-fechaanterior;
  idias :=trunc((r.fecha_vencimiento-r.fecha_otorga)/r.numpagos);
  if idias = idias2 then 
     update prestamos set numero_de_amor=r.numpagos,dias_de_cobro=idias where prestamoid=r.prestamoid;
  else
     update prestamos set numero_de_amor=r.numpagos where prestamoid=r.prestamoid;
  end if;
  raise notice ' Prestamo id %  ',r.prestamoid;
  iprestamos:=iprestamos+1;

end loop;


for r in 

select  prestamoid,numero_de_amor,dias_de_cobro,trunc((fecha_vencimiento-fecha_otorga)/numero_de_amor),meses_de_cobro,dia_mes_cobro,fecha_1er_pago,fecha_otorga,fecha_vencimiento from prestamos where dias_de_cobro >0 and dias_de_cobro > trunc((fecha_vencimiento-fecha_otorga)/numero_de_amor)+5

loop

  idias :=trunc((r.fecha_vencimiento-r.fecha_otorga)/r.numero_de_amor);
 
  update prestamos set dias_de_cobro=idias where prestamoid=r.prestamoid;
 
  raise notice ' Prestamo id-II % ',r.prestamoid;
  iprestamos:=iprestamos+1;

end loop;

for r in 

select  prestamoid,numero_de_amor,dias_de_cobro,meses_de_cobro,dia_mes_cobro,fecha_1er_pago,fecha_otorga,fecha_vencimiento from prestamos where numero_de_amor=1
loop

  idias :=trunc((r.fecha_vencimiento-r.fecha_otorga)/r.numero_de_amor);
 
  update prestamos set dias_de_cobro=idias, meses_de_cobro=0, dia_mes_cobro=0 where prestamoid=r.prestamoid;
 
  raise notice ' Prestamo id-II % ',r.prestamoid;
  iprestamos:=iprestamos+1;

end loop;

return iprestamos;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.corrigefrecuencia() OWNER TO sistema;

--
-- Name: corrigeperiodo(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION corrigeperiodo() RETURNS integer
    AS $$
declare
  f record;
  ppolizacambiada int4;

begin

--
-- Buscamos datos en el  prestamo
--

for f in 
  select polizaid,fechapoliza from polizas
  loop

    select cambiafechapoliza into ppolizacambiada from cambiafechapoliza(f.polizaid,f.fechapoliza);
    raise notice ' cambie poliza % ', f.polizaid;
  end loop;
return 1;
end
$$
    LANGUAGE plpgsql;


ALTER FUNCTION public.corrigeperiodo() OWNER TO sistema;

--
-- Name: corrigetp(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION corrigetp() RETURNS integer
    AS $$
declare

  r record;
  l integer;
begin

  for r in

select mc.prestamoid, t.tipoprestamoid, t.cuentaactivo, p.tipoprestamoid as tiponuevo,
        (select cuentaactivo 
           from tipoprestamo 
          where tipoprestamoid=p.tipoprestamoid) as cuentaactivon, p.referenciaprestamo
  from movicaja mc, movipolizas m, tipoprestamo t, prestamos p
 where m.polizaid = mc.polizaid and
       t.cuentaactivo = m.cuentaid and
       p.prestamoid = mc.prestamoid
group by mc.prestamoid, t.tipoprestamoid, t.cuentaactivo, p.tipoprestamoid,
        (select cuentaactivo 
           from tipoprestamo 
          where tipoprestamoid=p.tipoprestamoid), p.referenciaprestamo    
having t.tipoprestamoid<>p.tipoprestamoid
  loop
    select cambiartipo(r.prestamoid,r.tipoprestamoid,r.tiponuevo)
      into l;
  end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.corrigetp() OWNER TO sistema;

--
-- Name: corrigueconsistencia(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION corrigueconsistencia(character) RETURNS integer
    AS $_$
declare
 
  preferenciaprestamo alias for $1;
  x record;
  r tablaamor%rowtype;

  lamortizacionid int4;
begin

  for x in

select p.*,s.clavesocioint,
       (select sum(importeamortizacion) from amortizaciones where amortizaciones.prestamoid=p.prestamoid) as amor,ultimoabono(p.prestamoid),
       totalabonos(p.prestamoid)
from prestamos p, socio s
where s.socioid = p.socioid
having (select sum(importeamortizacion) from amortizaciones where amortizaciones.prestamoid=p.prestamoid) is null
order by s.clavesocioint

  loop
    if x.montoprestamo=x.saldoprestamo then
      for r in
        select * from sptablaamor(x.montoprestamo,x.fecha_1er_pago,x.tipoprestamoid,x.numero_de_amor,x.dias_de_cobro,x.meses_de_cobro,x.dia_mes_cobro,x.fecha_otorga)
      loop
         select * into lamortizacionid from spiamortizacion(x.prestamoid,r.numamortizacion,r.fechadepago,r.importeamortizacion,r.interesnormal,r.saldo_absoluto,'001',r.interesnormal,0,x.fecha_otorga);
      end loop;
      
    else

       select * into lamortizacionid from generaramortizaciones(x.referenciaprestamo,x.totalabonos,x.ultimoabono);
    end if;

  end loop;


return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.corrigueconsistencia(character) OWNER TO sistema;

--
-- Name: corriguecuentas(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION corriguecuentas() RETURNS integer
    AS $$
declare
  r record;


begin

    for r in

   select p.polizaid,p.fechapoliza,p.numero_poliza,mc.seriecaja,p.seriepoliza,pa.cuentacaja
  from movicaja mc, polizas p, parametros pa
 where p.polizaid = mc.polizaid and
       pa.serie_user = p.seriepoliza and
       (select count(*) from movipolizas 
         where movipolizas.polizaid = p.polizaid and
               movipolizas.cuentaid = pa.cuentacaja)=0  

    loop
      update movipolizas
         set cuentaid = r.cuentacaja
       where polizaid = r.polizaid;

    end loop;
return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.corriguecuentas() OWNER TO sistema;

--
-- Name: corriguedevengamiento(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION corriguedevengamiento(date) RETURNS integer
    AS $_$
declare
  dfecha alias for $1;
begin

  update movicaja
     set formapagoid='CH',
         cheque=efectivo,
         efectivo=0.00
   where fechahora between dfecha + interval '0 hours' and dfecha + interval '23:59:59' and
         seriecaja='ZA';
         

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.corriguedevengamiento(date) OWNER TO sistema;

--
-- Name: corriguefechavenc(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION corriguefechavenc() RETURNS integer
    AS $$
declare
 
  r record;
  x record;

begin

  for r in

    select p.prestamoid,p.fecha_otorga,p.fecha_vencimiento,
           max(a.fechadepago) as fechavenc
      from prestamos p, amortizaciones a
     where a.prestamoid=p.prestamoid
     group by p.prestamoid,p.fecha_otorga,p.fecha_vencimiento 
--    having p.fecha_vencimiento<>max(a.fechadepago)
--  order by p.fecha_vencimiento

  loop

    update prestamos
       set fecha_vencimiento=r.fechavenc
    where prestamoid=r.prestamoid;

    update precorte
       set fecha_vencimiento=r.fechavenc
     where prestamoid=r.prestamoid;

  end loop;

  for x in
    select prestamoid,fecha_vencimiento
      from prestamos
  loop

    update precorte
       set fecha_vencimiento=r.fecha_vencimiento
     where prestamoid=r.prestamoid;

  end loop;

return 1;
end;
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.corriguefechavenc() OWNER TO sistema;

--
-- Name: corriguerm(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION corriguerm() RETURNS integer
    AS $$
declare
  r record;

begin

    for r in

select ( select x.cuentaid from movipolizas x where x.polizaid=m.polizaid and x.debe>0),
       ( select x.movipolizaid from movipolizas x where x.polizaid=m.polizaid and x.debe>0) as movipolizaid,
       descripcion, m.polizaid, p.referenciaprestamo, t.cuentaactivo
  from movipolizas m, prestamos p, tipoprestamo t
 where movipolizaid in (select movipolizaid from movicaja where tipomovimientoid='RM') and
       p.referenciaprestamo = m.descripcion and
       t.tipoprestamoid = p.tipoprestamoid
having ( select x.cuentaid from movipolizas x where x.polizaid=m.polizaid and x.debe>0)<>t.cuentaactivo       

    loop
      update movipolizas
         set cuentaid = r.cuentaactivo
       where movipolizaid =r.movipolizaid and
             debe>0;
    end loop;

    for r in
select mc.movicajaid, mc.tipomovimientoid, p.prestamoid, 
       descripcion, m.polizaid, p.referenciaprestamo, t.cuentaactivo,
       mc.socioid,p.socioid
  from movipolizas m, prestamos p, tipoprestamo t, movicaja mc
 where m.movipolizaid in (select movipolizaid from movicaja where tipomovimientoid='RM') and
       p.referenciaprestamo = m.descripcion and
       t.tipoprestamoid = p.tipoprestamoid and
       mc.polizaid = m.polizaid and
       mc.socioid=p.socioid

    loop
      update movicaja
         set prestamoid = r.prestamoid
       where movicajaid = r.movicajaid;
    end loop;



return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.corriguerm() OWNER TO sistema;

--
-- Name: corriguesocio(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION corriguesocio() RETURNS integer
    AS $$
declare
  r record;

  i int4;
  l int4;
  j int4;
  k int4;
begin

    for r in
      select * from dato
    loop
      select solicitudingresoid
        into l
        from solicitudingreso
       where socioid = r.socioid;

      update solicitudingreso
         set observaciones=r.historial
       where solicitudingresoid=l;

      -- Crear beneficiario anterior
      if r.representanteid is not null then
        select socioid
          into k
          from socio
         where sujetoid=r.representanteid;

        if FOUND then
          select * into j
            from spirelacion(0,l,r.representanteid,k,'Rep.',0.00,0,0,1);
        else
          select * into j
            from spirelacion(0,l,r.representanteid,NULL,'Rep.',0.00,0,0,1);
        end if;
      end if;
    end loop;
return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.corriguesocio() OWNER TO sistema;

--
-- Name: cortecaja(character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cortecaja(character, date, integer) RETURNS SETOF rcortecaja
    AS $_$
declare
 pserie alias for $1;
 pfecha alias for $2;
 presumido alias for $3;
 r rcortecaja%rowtype;
 l record;
 i int;

 fcapital numeric;
 fnormal numeric;
 fmoratorio numeric;
 fiva numeric;
 fcobranza numeric;

 tipomovimiento char;
 
begin
 -------------------------------------------
 -- Movimientos de deposito retiro en caja
 -------------------------------------------

 for r in

   select m.referenciacaja as folio,p.numero_poliza,m.seriecaja as serie,m.socioid,s.clavesocioint,
          p.fechapoliza as fecha, 0 as capital, 0 as interes, 0 as moratorio, 0 as iva,
          mp.debe as deposito, mp.haber as retiro, m.tipomovimientoid, ' ' as tipoprestamoid, 0 as cobranza
     from movicaja m, polizas p, movipolizas mp, socio s, parametros pa
    where (m.seriecaja = pserie or pserie=' ') and
          p.polizaid = m.polizaid and
          p.fechapoliza = pfecha and
          mp.movipolizaid = m.movipolizaid and
          mp.polizaid = p.polizaid and
          pa.serie_user = m.seriecaja and 
          mp.cuentaid = pa.cuentacaja and 
          s.socioid = m.socioid and 
          m.tipomovimientoid <> 'IN' and
          m.tipomovimientoid <> '00' and
          m.tipomovimientoid <> 'CO'
 order by m.referenciacaja

 loop
  -- Movimientos normales en Caja   
   return next r;
 end loop;

 -------------------------------------------
 -- Movimientos     CO
 -------------------------------------------

for l in

   select distinct(m.movicajaid),m.referenciacaja as folio,p.numero_poliza as referencia ,m.seriecaja as serie,m.socioid,s.clavesocioint,
          p.fechapoliza as fecha, 0 as capital, 0 as interes, 0 as moratorio, 0 as iva,
          mp.debe as retiro, mp.haber as deposito, m.tipomovimientoid, ' ' as tipoprestamoid
     from movicaja m, polizas p, movipolizas mp, socio s, parametros pa
    where (m.seriecaja = pserie or pserie=' ') and
          p.polizaid = m.polizaid and
          p.fechapoliza = pfecha and
          mp.cuentaid = '4-09-02-08-01-  -' and
          mp.polizaid = p.polizaid and
          pa.serie_user = m.seriecaja and 
          --mp.cuentaid = pa.cuentacaja and 
          s.socioid = m.socioid and 
          m.tipomovimientoid = 'CO' 
 order by m.referenciacaja


 loop
   r.folio := l.folio;
   r.referencia := l.referencia;
   r.serie := l.serie;
   r.socioid := l.socioid;
   r.clavesocioint := l.clavesocioint;
   r.fecha := l.fecha;
   r.capital := 0;
   r.interes := 0;
   r.moratorio := 0;
   r.iva := 0;
   r.deposito := l.deposito;
   r.retiro := l.retiro;
   r.tipomovimientoid := l.tipomovimientoid;
   r.tipoprestamoid = l.tipoprestamoid;
   r.cobranza = 0;


   return next r;
 end loop;
 
 -------------------------------------------
 -- Movimientos Prestamos    00
 -------------------------------------------


for l in

   select m.referenciacaja as folio,p.numero_poliza as referencia,m.seriecaja as serie,m.socioid,
          s.clavesocioint,
          p.fechapoliza as fecha, 0 as capital, 0 as interes, 0 as moratorio, 0 as iva,
          0 as deposito, 0 as retiro, m.tipomovimientoid, 0 as cobranza, p.polizaid,
          t.cuentaactivo,t.cuentaintnormal,t.cuentaintmora,t.cuentaiva, pr.tipoprestamoid,t.cuentafondorecuperacion
     from movicaja m, polizas p, movipolizas mp,socio s, prestamos pr, tipoprestamo t
    where (m.seriecaja = pserie or pserie=' ') and
          p.polizaid = m.polizaid and
          p.fechapoliza = pfecha and
          mp.polizaid = p.polizaid and
          mp.movipolizaid = m.movipolizaid and
          s.socioid = m.socioid and
          m.tipomovimientoid='00' and
          pr.prestamoid = m.prestamoid and
          t.tipoprestamoid = pr.tipoprestamoid
 order by m.referenciacaja

 loop 
   -- Movimientos capital
   fcapital := 0;
   fnormal := 0;
   fmoratorio := 0;
   fiva := 0;

   select sum(coalesce(haber,0)) into fcapital
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentaactivo;
   select sum(coalesce(haber,0)) into fnormal
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentaintnormal;

   select sum(coalesce(haber,0)) into fmoratorio
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentaintmora;

   select sum(coalesce(haber,0)) into fiva
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentaiva;

   select sum(coalesce(haber,0)) into fcobranza
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentafondorecuperacion;

   -- Formar renglon
   r.folio := l.folio;
   r.referencia := l.referencia;
   r.serie := l.serie;
   r.socioid := l.socioid;
   r.clavesocioint := l.clavesocioint;
   r.fecha := l.fecha;
   r.capital := fcapital;
   r.interes := fnormal;
   r.moratorio := fmoratorio;
   r.iva := fiva;
   r.deposito := 0;
   r.retiro := 0;
   r.tipomovimientoid := l.tipomovimientoid;
   r.tipoprestamoid := l.tipoprestamoid;
   r.cobranza := fcobranza;

   return next r;
 end loop;


 ---------------------------------------
 -- Movimientos Inversiones  IN
 ---------------------------------------
for l in
   select m.referenciacaja as folio,p.numero_poliza as referencia,m.seriecaja as serie,
          m.socioid,s.clavesocioint,p.fechapoliza as fecha,
          0 as capital, 0 as interes, 0 as moratorio, 0 as iva,0 as deposito, 0 as retiro,
          m.tipomovimientoid, p.polizaid, t.cuentaintinver,t.cuentaivainver,t.cuentapasivo,t.cuentariesgocred,0 as cobranza
     from movicaja m, polizas p, movipolizas mp, socio s, inversion ix, tipoinversion t, parametros pa
    where (m.seriecaja = pserie or pserie=' ') and 
          p.polizaid = m.polizaid and
          p.fechapoliza = pfecha and
          mp.polizaid = p.polizaid and
          pa.serie_user = m.seriecaja and 
          mp.cuentaid = pa.cuentacaja and         
          s.socioid = m.socioid and
          m.tipomovimientoid='IN' and
          ix.inversionid = m.inversionid and
          t.tipoinversionid = ix.tipoinversionid
group by m.referenciacaja,p.numero_poliza,m.seriecaja,
          m.socioid,s.clavesocioint,p.fechapoliza,
          m.tipomovimientoid, p.polizaid, t.cuentaintinver,t.cuentaivainver,t.cuentapasivo,t.cuentariesgocred
   order by m.referenciacaja

 loop 
   -- Movimientos capital

   fnormal := 0;
   fmoratorio := 0;
   fiva := 0;
   fcapital := 0;

   select coalesce(haber-debe,0) into fcapital
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentapasivo;

   select coalesce(SUM(haber-debe),0) into fnormal
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentaintinver;

   select coalesce(SUM(haber-debe),0) into fiva
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentariesgocred;

   -- Formar renglon
   r.folio := l.folio;
   r.referencia := l.referencia;
   r.serie := l.serie;
   r.socioid := l.socioid;
   r.clavesocioint := l.clavesocioint;
   r.fecha := l.fecha;
   r.capital := 0;
   r.interes := fnormal;
   r.moratorio := fmoratorio;
   r.iva := fiva;
   if fcapital>0 then
     r.deposito := fcapital;
     r.retiro := 0;
   else
     r.deposito := 0;
     r.retiro := -1*fcapital;
   end if;
   r.tipomovimientoid := l.tipomovimientoid;
   r.cobranza :=0;
   return next r;
 end loop;

return;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cortecaja(character, date, integer) OWNER TO sistema;

--
-- Name: cortecajac(character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cortecajac(character, date, integer) RETURNS SETOF rcortecaja
    AS $_$
declare
 pserie alias for $1;
 pfecha alias for $2;
 presumido alias for $3;
 r rcortecaja%rowtype;
 f record;
 dblink1 text;
 dblink2 text;

begin
 for f in
   SELECT *from sucursales where vigente='S'
 loop
     raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

     dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
     dblink2:='set search_path to public,'||f.esquema||'; select * from cortecaja('||''''||pserie||''''||',
     '||''''||to_char(pfecha,'yyyy-mm-dd')||''''||','||''''||presumido||''''||');';
     for r in
      SELECT * FROM
        dblink(dblink1,dblink2) as t2 (folio int, referencia int, serie char(2), socioid int, clavesocioint char(15),
                                       fecha date, capital numeric, interes numeric, moratorio numeric, iva numeric,
                                       deposito numeric, retiro numeric, tipomovimientoid char(2),tipoprestamoid char(2),
                                       cobranza numeric)


     loop
       return next r;
     end loop;

 end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cortecajac(character, date, integer) OWNER TO sistema;

--
-- Name: cortecajapdf(character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cortecajapdf(character, date, integer) RETURNS SETOF rcortecajapdf
    AS $_$
declare
 pserie alias for $1;
 pfecha alias for $2;
 presumido alias for $3;
 r rcortecajapdf%rowtype;
 l record;
 i int;

 fcapital numeric;
 fnormal numeric;
 fmoratorio numeric;
 fiva numeric;
 fcobranza numeric;

 tipomovimiento char;
 
begin
 -------------------------------------------
 -- Movimientos de deposito retiro en caja
 -------------------------------------------

 for r in

   select m.referenciacaja as folio,p.numero_poliza,m.seriecaja as serie,m.socioid,s.clavesocioint,
          p.fechapoliza as fecha, 0 as capital, 0 as interes, 0 as moratorio, 0 as iva,
          mp.debe as deposito, mp.haber as retiro, m.tipomovimientoid, ' ' as tipoprestamoid, 0 as cobranza
     from movicaja m, polizas p, movipolizas mp, socio s, parametros pa
    where (m.seriecaja = pserie or pserie=' ') and
          p.polizaid = m.polizaid and
          p.fechapoliza = pfecha and
          mp.movipolizaid = m.movipolizaid and
          mp.polizaid = p.polizaid and
          pa.serie_user = m.seriecaja and 
          mp.cuentaid = pa.cuentacaja and 
          s.socioid = m.socioid and 
          m.tipomovimientoid <> 'IN' and
          m.tipomovimientoid <> '00' and
          m.tipomovimientoid <> 'CO'
 order by m.referenciacaja

 loop
  -- Movimientos normales en Caja   
   return next r;
 end loop;

 -------------------------------------------
 -- Movimientos     CO
 -------------------------------------------

for l in

   select distinct(m.movicajaid),m.referenciacaja as folio,p.numero_poliza as referencia ,m.seriecaja as serie,m.socioid,s.clavesocioint,
          p.fechapoliza as fecha, 0 as capital, 0 as interes, 0 as moratorio, 0 as iva,
          mp.debe as retiro, mp.haber as deposito, m.tipomovimientoid, ' ' as tipoprestamoid
     from movicaja m, polizas p, movipolizas mp, socio s, parametros pa
    where (m.seriecaja = pserie or pserie=' ') and
          p.polizaid = m.polizaid and
          p.fechapoliza = pfecha and
          mp.cuentaid = '4-09-02-08-01-  -' and
          mp.polizaid = p.polizaid and
          pa.serie_user = m.seriecaja and 
          --mp.cuentaid = pa.cuentacaja and 
          s.socioid = m.socioid and 
          m.tipomovimientoid = 'CO' 
 order by m.referenciacaja


 loop
   r.folio := l.folio;
   r.referencia := l.referencia;
   r.serie := l.serie;
   r.socioid := l.socioid;
   r.clavesocioint := l.clavesocioint;
   r.fecha := l.fecha;
   r.capital := 0;
   r.interes := 0;
   r.moratorio := 0;
   r.iva := 0;
   r.deposito := l.deposito;
   r.retiro := l.retiro;
   r.tipomovimientoid := l.tipomovimientoid;
   r.tipoprestamoid = l.tipoprestamoid;
   r.cobranza = 0;


   return next r;
 end loop;
 
 -------------------------------------------
 -- Movimientos Prestamos    00
 -------------------------------------------


for l in

   select m.referenciacaja as folio,p.numero_poliza as referencia,m.seriecaja as serie,m.socioid,
          s.clavesocioint,
          p.fechapoliza as fecha, 0 as capital, 0 as interes, 0 as moratorio, 0 as iva,
          0 as deposito, 0 as retiro, m.tipomovimientoid, 0 as cobranza, p.polizaid,
          t.cuentaactivo,t.cuentaintnormal,t.cuentaintmora,t.cuentaiva, pr.tipoprestamoid,t.cuentafondorecuperacion
     from movicaja m, polizas p, movipolizas mp,socio s, prestamos pr, tipoprestamo t
    where (m.seriecaja = pserie or pserie=' ') and
          p.polizaid = m.polizaid and
          p.fechapoliza = pfecha and
          mp.polizaid = p.polizaid and
          mp.movipolizaid = m.movipolizaid and
          s.socioid = m.socioid and
          m.tipomovimientoid='00' and
          pr.prestamoid = m.prestamoid and
          t.tipoprestamoid = pr.tipoprestamoid
 order by m.referenciacaja

 loop 
   -- Movimientos capital
   fcapital := 0;
   fnormal := 0;
   fmoratorio := 0;
   fiva := 0;

   select sum(coalesce(haber,0)) into fcapital
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentaactivo;
   select sum(coalesce(haber,0)) into fnormal
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentaintnormal;

   select sum(coalesce(haber,0)) into fmoratorio
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentaintmora;

   select sum(coalesce(haber,0)) into fiva
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentaiva;

   select sum(coalesce(haber,0)) into fcobranza
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentafondorecuperacion;

   -- Formar renglon
   r.folio := l.folio;
   r.referencia := l.referencia;
   r.serie := l.serie;
   r.socioid := l.socioid;
   r.clavesocioint := l.clavesocioint;
   r.fecha := l.fecha;
   r.capital := fcapital;
   r.interes := fnormal;
   r.moratorio := fmoratorio;
   r.iva := fiva;
   r.deposito := 0;
   r.retiro := 0;
   r.tipomovimientoid := l.tipomovimientoid;
   r.tipoprestamoid := l.tipoprestamoid;
   r.cobranza := fcobranza;

   return next r;
 end loop;


 ---------------------------------------
 -- Movimientos Inversiones  IN
 ---------------------------------------
for l in
   select m.referenciacaja as folio,p.numero_poliza as referencia,m.seriecaja as serie,
          m.socioid,s.clavesocioint,p.fechapoliza as fecha,
          0 as capital, 0 as interes, 0 as moratorio, 0 as iva,0 as deposito, 0 as retiro,
          m.tipomovimientoid, p.polizaid, t.cuentaintinver,t.cuentaivainver,t.cuentapasivo,t.cuentariesgocred,0 as cobranza
     from movicaja m, polizas p, movipolizas mp, socio s, inversion ix, tipoinversion t, parametros pa
    where (m.seriecaja = pserie or pserie=' ') and 
          p.polizaid = m.polizaid and
          p.fechapoliza = pfecha and
          mp.polizaid = p.polizaid and
          pa.serie_user = m.seriecaja and 
          mp.cuentaid = pa.cuentacaja and         
          s.socioid = m.socioid and
          m.tipomovimientoid='IN' and
          ix.inversionid = m.inversionid and
          t.tipoinversionid = ix.tipoinversionid
group by m.referenciacaja,p.numero_poliza,m.seriecaja,
          m.socioid,s.clavesocioint,p.fechapoliza,
          m.tipomovimientoid, p.polizaid, t.cuentaintinver,t.cuentaivainver,t.cuentapasivo,t.cuentariesgocred
   order by m.referenciacaja

 loop 
   -- Movimientos capital

   fnormal := 0;
   fmoratorio := 0;
   fiva := 0;
   fcapital := 0;

   select coalesce(haber-debe,0) into fcapital
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentapasivo;

   select coalesce(SUM(haber-debe),0) into fnormal
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentaintinver;

   select coalesce(SUM(haber-debe),0) into fiva
     from movipolizas
    where polizaid = l.polizaid and
          cuentaid = l.cuentariesgocred;

   -- Formar renglon
   r.folio := l.folio;
   r.referencia := l.referencia;
   r.serie := l.serie;
   r.socioid := l.socioid;
   r.clavesocioint := l.clavesocioint;
   r.fecha := l.fecha;
   r.capital := 0;
   r.interes := fnormal;
   r.moratorio := fmoratorio;
   r.iva := fiva;
   if fcapital>0 then
     r.deposito := fcapital;
     r.retiro := 0;
   else
     r.deposito := 0;
     r.retiro := -1*fcapital;
   end if;
   r.tipomovimientoid := l.tipomovimientoid;
   r.cobranza :=0;
   return next r;
 end loop;

return;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cortecajapdf(character, date, integer) OWNER TO sistema;

--
-- Name: cortecajapdfc(character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cortecajapdfc(character, date, integer) RETURNS SETOF rcortecajapdf
    AS $_$
declare
 pserie alias for $1;
 pfecha alias for $2;
 presumido alias for $3;
 r rcortecajapdf%rowtype;
 f record;
 dblink1 text;
 dblink2 text;

begin
 for f in
   SELECT *from sucursales where vigente='S'
 loop
     raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

     dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
     dblink2:='set search_path to public,'||f.esquema||'; select * from cortecajapdf('||''''||pserie||''''||',
     '||''''||to_char(pfecha,'yyyy-mm-dd')||''''||','||''''||presumido||''''||');';
     for r in
      SELECT * FROM
        dblink(dblink1,dblink2) as t2 (folio int, referencia int, serie char(2), socioid int, clavesocioint char(15),
                                       fecha date, capital numeric, interes numeric, moratorio numeric, iva numeric,
                                       deposito numeric, retiro numeric, tipomovimientoid char(2),tipoprestamoid char(2),
                                       cobranza numeric)


     loop
       return next r;
     end loop;

 end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cortecajapdfc(character, date, integer) OWNER TO sistema;

--
-- Name: cuadrada(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION cuadrada(integer) RETURNS integer
    AS $_$
declare
 
 ppolizaid alias for $1;
 ldebe numeric;
 lhaber numeric;
begin

 select sum(debe),sum(haber)
   into ldebe,lhaber
   from movipolizas
  where polizaid = ppolizaid;

  ldebe := coalesce(ldebe,0);
  lhaber := coalesce(lhaber,0);

  if ldebe<>lhaber then
    return 0;
  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.cuadrada(integer) OWNER TO sistema;

--
-- Name: dblink(text, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink(text, text) RETURNS SETOF record
    AS '$libdir/dblink', 'dblink_record'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink(text, text) OWNER TO sistema;

--
-- Name: dblink(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink(text) RETURNS SETOF record
    AS '$libdir/dblink', 'dblink_record'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink(text) OWNER TO sistema;

--
-- Name: dblink_build_sql_delete(text, int2vector, integer, text[]); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_build_sql_delete(text, int2vector, integer, text[]) RETURNS text
    AS '$libdir/dblink', 'dblink_build_sql_delete'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_build_sql_delete(text, int2vector, integer, text[]) OWNER TO sistema;

--
-- Name: dblink_build_sql_insert(text, int2vector, integer, text[], text[]); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_build_sql_insert(text, int2vector, integer, text[], text[]) RETURNS text
    AS '$libdir/dblink', 'dblink_build_sql_insert'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_build_sql_insert(text, int2vector, integer, text[], text[]) OWNER TO sistema;

--
-- Name: dblink_build_sql_update(text, int2vector, integer, text[], text[]); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_build_sql_update(text, int2vector, integer, text[], text[]) RETURNS text
    AS '$libdir/dblink', 'dblink_build_sql_update'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_build_sql_update(text, int2vector, integer, text[], text[]) OWNER TO sistema;

--
-- Name: dblink_close(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_close(text) RETURNS text
    AS '$libdir/dblink', 'dblink_close'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_close(text) OWNER TO sistema;

--
-- Name: dblink_close(text, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_close(text, text) RETURNS text
    AS '$libdir/dblink', 'dblink_close'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_close(text, text) OWNER TO sistema;

--
-- Name: dblink_connect(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_connect(text) RETURNS text
    AS '$libdir/dblink', 'dblink_connect'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_connect(text) OWNER TO sistema;

--
-- Name: dblink_connect(text, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_connect(text, text) RETURNS text
    AS '$libdir/dblink', 'dblink_connect'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_connect(text, text) OWNER TO sistema;

--
-- Name: dblink_current_query(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_current_query() RETURNS text
    AS '$libdir/dblink', 'dblink_current_query'
    LANGUAGE c;


ALTER FUNCTION public.dblink_current_query() OWNER TO sistema;

--
-- Name: dblink_disconnect(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_disconnect() RETURNS text
    AS '$libdir/dblink', 'dblink_disconnect'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_disconnect() OWNER TO sistema;

--
-- Name: dblink_disconnect(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_disconnect(text) RETURNS text
    AS '$libdir/dblink', 'dblink_disconnect'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_disconnect(text) OWNER TO sistema;

--
-- Name: dblink_exec(text, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_exec(text, text) RETURNS text
    AS '$libdir/dblink', 'dblink_exec'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_exec(text, text) OWNER TO sistema;

--
-- Name: dblink_exec(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_exec(text) RETURNS text
    AS '$libdir/dblink', 'dblink_exec'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_exec(text) OWNER TO sistema;

--
-- Name: dblink_fetch(text, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_fetch(text, integer) RETURNS SETOF record
    AS '$libdir/dblink', 'dblink_fetch'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_fetch(text, integer) OWNER TO sistema;

--
-- Name: dblink_fetch(text, text, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_fetch(text, text, integer) RETURNS SETOF record
    AS '$libdir/dblink', 'dblink_fetch'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_fetch(text, text, integer) OWNER TO sistema;

--
-- Name: dblink_get_pkey(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_get_pkey(text) RETURNS SETOF dblink_pkey_results
    AS '$libdir/dblink', 'dblink_get_pkey'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_get_pkey(text) OWNER TO sistema;

--
-- Name: dblink_open(text, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_open(text, text) RETURNS text
    AS '$libdir/dblink', 'dblink_open'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_open(text, text) OWNER TO sistema;

--
-- Name: dblink_open(text, text, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION dblink_open(text, text, text) RETURNS text
    AS '$libdir/dblink', 'dblink_open'
    LANGUAGE c STRICT;


ALTER FUNCTION public.dblink_open(text, text, text) OWNER TO sistema;

--
-- Name: depositomov(character, date, numeric, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION depositomov(character, date, numeric, character, character, character) RETURNS integer
    AS $_$
declare
--
-- Parametros
--
  pclavesocioint alias for $1;
  pfecha alias for $2;
  psaldo alias for $3;
  ptipomovimientoid alias for $4;
  sserie_user alias for $5;
  scuentacaja alias for $6;
  scuentadeposito char(24);

  lsocioid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;
begin

--
-- **** OJO poner la serie y cuenta de caja correspondiente ****
--
--
-- Tomaremos el saldo inicial como un deposito
--

-- Buscamos la cuenta de deposito y el socio

  select cuentadeposito into scuentadeposito
   from tipomovimiento where tipomovimientoid=ptipomovimientoid;

  select socioid into lsocioid
   from socio
  where clavesocioint = pclavesocioint;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',sserie_user,'A');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipoliza(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','Saldo Inicial',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','C',psaldo,0,' ',' ','Movimiento del dia');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentadeposito,' ','A',0,psaldo,' ',' ','movimiento del dia');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

  select *
    into pmovicajaid
   from spimovicaja(lsocioid,ptipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL);

return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.depositomov(character, date, numeric, character, character, character) OWNER TO sistema;

--
-- Name: depositomovahorro(character, date, numeric, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION depositomovahorro(character, date, numeric, character, character, integer) RETURNS integer
    AS $_$
declare

--
-- Parametros
--
  pclavesocioint alias for $1;
  pfecha alias for $2;
  psaldo alias for $3;
  ptipomovimientoid alias for $4;
  sserie_user alias for $5;
  pprestamoid alias for $6;
  
  scuentadeposito char(24);
  scuentacaja char(24);

  lsocioid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;

begin

-- Buscamos la cuenta de deposito y el socio

  select cuentadeposito into scuentadeposito
   from tipomovimiento where tipomovimientoid=ptipomovimientoid;

  select socioid into lsocioid
   from socio
  where clavesocioint = pclavesocioint;

  select cuentacaja into scuentacaja from parametros where serie_user=sserie_user;
  
--
-- Dar de alta la poliza contable
--

  raise notice ' cuentas : % % ',scuentacaja,scuentadeposito;

  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',sserie_user,'A');

-- Encabezado de la poliza

  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','Saldo Inicial',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','C',psaldo,0,' ',' ','Movimiento del dia');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentadeposito,' ','A',0,psaldo,' ',' ','movimiento del dia');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

  select *
    into pmovicajaid
   from spimovicajaseguro(lsocioid,ptipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL);

   
return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.depositomovahorro(character, date, numeric, character, character, integer) OWNER TO sistema;

--
-- Name: depositomovministrar(character, date, numeric, character, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION depositomovministrar(character, date, numeric, character, character, character, integer) RETURNS integer
    AS $_$
declare
--
-- Parametros
--
  pclavesocioint alias for $1;
  pfecha alias for $2;
  psaldo alias for $3;
  ptipomovimientoid alias for $4;
  sserie_user alias for $5;
  scuentacaja alias for $6;
  pprestamoid alias for $7;
  
  scuentadeposito char(24);

  lsocioid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;
begin

--
-- **** OJO poner la serie y cuenta de caja correspondiente ****
--
--
-- Tomaremos el saldo inicial como un deposito
--

-- Buscamos la cuenta de deposito y el socio

  select cuentadeposito into scuentadeposito
   from tipomovimiento where tipomovimientoid=ptipomovimientoid;

  select socioid into lsocioid
   from socio
  where clavesocioint = pclavesocioint;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',sserie_user,'A');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','Saldo Inicial',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','C',psaldo,0,' ',' ','Movimiento del dia');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentadeposito,' ','A',0,psaldo,' ',' ','movimiento del dia');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

  select *
    into pmovicajaid
   from spimovicajaministrar(lsocioid,ptipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL);

   insert into ministrar(tipomovimientoid,fechaministracion,monto,prestamoid,polizaid,movibancoid,referenciacaja,seriecaja)
   values(ptipomovimientoid,pfecha,psaldo,pprestamoid,ppolizaid,NULL,lreferenciacaja,sserie_user);

   
return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.depositomovministrar(character, date, numeric, character, character, character, integer) OWNER TO sistema;

--
-- Name: depositomovseguro(character, date, numeric, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION depositomovseguro(character, date, numeric, character, character, character) RETURNS integer
    AS $_$
declare
--
-- Parametros
--
  pclavesocioint alias for $1;
  pfecha alias for $2;
  psaldo alias for $3;
  ptipomovimientoid alias for $4;
  sserie_user alias for $5;
  scuentacaja alias for $6;
  scuentadeposito char(24);

  lsocioid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;
begin

--
-- **** OJO poner la serie y cuenta de caja correspondiente ****
--
--
-- Tomaremos el saldo inicial como un deposito
--

-- Buscamos la cuenta de deposito y el socio

  select cuentadeposito into scuentadeposito
   from tipomovimiento where tipomovimientoid=ptipomovimientoid;

  select socioid into lsocioid
   from socio
  where clavesocioint = pclavesocioint;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',sserie_user,'A');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','Saldo Inicial',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','C',psaldo,0,' ',' ','Movimiento del dia');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentadeposito,' ','A',0,psaldo,' ',' ','movimiento del dia');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

  select *
    into pmovicajaid
   from spimovicajaseguro(lsocioid,ptipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL);

return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.depositomovseguro(character, date, numeric, character, character, character) OWNER TO sistema;

--
-- Name: depositosefectivo(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION depositosefectivo(integer, date) RETURNS numeric
    AS $_$
declare
 lsocioid alias for $1;
 dfecha alias for $2;

 fdepositos numeric;

 dfechai date;
begin

 dfechai:= dfecha - (cast(extract(day from dfecha) as integer) -1);

 select sum(efectivo)
   into fdepositos
   from movicaja
  where socioid=lsocioid and
        tipomovimientoid in ('PA','AM','AF','AA','AI','AO','IN','AP') and
        fechahora between dfechai + interval '0 hours' and dfecha + interval '23:59:59' and
        movimiento='D' and formapagoid='EF' and seriecaja<>'ZA';

 fdepositos:=coalesce(fdepositos,0.00);
 if fdepositos<0.00 then
   fdepositos:=0.00;
 end if;

return fdepositos;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.depositosefectivo(integer, date) OWNER TO sistema;

--
-- Name: deppromedio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION deppromedio(integer) RETURNS numeric
    AS $_$ 
DECLARE

  lsocioid alias for $1;
  fpromedio numeric;
  dfechai date;
  dfechaf date;
  dias int4;

BEGIN

  fpromedio:=0;

  select min(p.fechapoliza) into dfechai from movicaja mc, polizas p where mc.socioid=lsocioid and mc.tipomovimientoid in (select tipomovimientoid from tipomovimiento where (aplicasaldo='S' and tasainteres >0) or tipomovimientoid='IN') and mc.polizaid=p.polizaid and p.tipo <> 'W' and p.fechapoliza < current_date ;
  
  select max(p.fechapoliza) into dfechaf from movicaja mc, polizas p where mc.socioid=lsocioid and mc.tipomovimientoid in (select tipomovimientoid from tipomovimiento where (aplicasaldo='S' and tasainteres >0) or tipomovimientoid='IN') and mc.polizaid=p.polizaid and p.tipo <> 'W' and p.fechapoliza < current_date ;

SELECT SUM(round((case when p.fechapoliza<dfechai then
             (mp.debe)*(dfechaf-dfechai) else 0 end),2)) +
       SUM(round(case when p.fechapoliza>dfechai-1 then
             (mp.debe)*(dfechaf-p.fechapoliza) else 0 end,2))
  INTO fpromedio
  FROM ( select ml.socioid, ml.tipomovimientoid, ml.polizaid,
                ml.referenciacaja, ml.seriecaja, ml.movipolizaid
           from movicaja ml
          where ml.socioid=lsocioid and
                ml.tipomovimientoid in (select tipomovimientoid from tipomovimiento where (aplicasaldo='S' and tasainteres >0) or tipomovimientoid='IN')
       GROUP BY ml.socioid, ml.tipomovimientoid, ml.polizaid,
                ml.referenciacaja, ml.seriecaja, ml.movipolizaid ) as m,
       polizas p, movipolizas mp, tipomovimiento t, socio s
 WHERE m.socioid=lsocioid and
       m.tipomovimientoid in (select tipomovimientoid from tipomovimiento where (aplicasaldo='S' and tasainteres >0) or tipomovimientoid='IN') and
       p.polizaid = m.polizaid and
       p.fechapoliza between '01-01-1900' and dfechaf and
       mp.polizaid = p.polizaid and
       mp.movipolizaid = m.movipolizaid and
       t.tipomovimientoid = m.tipomovimientoid and
       t.tasainteres > 0 and 
       s.socioid = m.socioid and 
       (s.estatussocio=1 or s.estatussocio=3 or fechabaja > dfechaf);  

  fpromedio:=coalesce(fpromedio,0);
  dias :=(dfechaf-dfechai);

  raise notice ' % % ',fpromedio,dias;

  if dias <> 0 then 
      RETURN round(fpromedio/(dfechaf-dfechai),2);
  else
      RETURN 0;
  end if;

END; 
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.deppromedio(integer) OWNER TO sistema;

--
-- Name: depreciacionfiscal(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION depreciacionfiscal(date, date) RETURNS SETOF rdepreciacion
    AS $_$
declare
  pfechainpcprimeramitad alias for $1;
  pfecha		 alias for $2;
  r 			 rdepreciacion%rowtype;
  pinpcprimeramitad      numeric;
  pmes 			 int;
  pano 			 int; 
  depmensual             numeric;
SaldoXDep 		 numeric;
begin
  pmes:=cast(date_part('month',pfechainpcprimeramitad) as int);
  pano:=cast(date_part('year',pfechainpcprimeramitad) as int); 
  select inpc into pinpcprimeramitad from inpc where ano = pano and mes = pmes;
  for r in
    select activoid,activoclave,activodescripcion,valormercado,feciniciodepfiscal,0,0,0,0,0,0,0,0 
from activos
  loop
    r.inpcprimeramitad := pinpcprimeramitad;
    pmes:=cast(date_part('month',r.feciniciodepfiscal) as int);
    pano:=cast(date_part('year',r.feciniciodepfiscal) as int); 

    select inpc into r.inpcadquiscion from inpc where ano = pano and mes = pmes; 
    r.FactDeprec := trunc(r.inpcprimeramitad/r.inpcadquiscion,4);

  select (case when 
               (case when pfecha<feciniciodepconta 
               then 0
               else 
               trunc((pfecha-feciniciodepconta)/30,0)end)
               >(100/((activotasaconta/100)/12*100)) 
         then 0
         else 
         trunc(activo_valor/(100/((activotasaconta/100)/12*100)),2)*(case when (case when pfecha<feciniciodepconta then 0
        else trunc((pfecha-feciniciodepconta)/30,0) end)<1 then 0 else 1 end ) end) into depmensual from activos where activoid=r.activoid;

    r.DeprecActEjerc := (depmensual * 12)*r.FactDeprec;
    r.FactSaldo := trunc(r.inpcprimeramitad/r.inpcadquiscion,4);

select  r.valormercado - (case when (case when pfecha<feciniciodepconta then 0
                     else trunc((pfecha-feciniciodepconta)/30,0) end)>(100/((activotasaconta/100)/12*100)) 
           then activo_valor
           else (case when pfecha<feciniciodepconta then 0
        else trunc((pfecha-feciniciodepconta)/30,0) end)*(case when (case when pfecha<feciniciodepconta then 0
                   else trunc((pfecha-feciniciodepconta)/30,0) end)>(100/((activotasaconta/100)/12*100)) then 0
             else 
   trunc(activo_valor/(100/((activotasaconta/100)/12*100)),2)*(case when (case when pfecha<feciniciodepconta then 0
        else trunc((pfecha-feciniciodepconta)/30,0) end)<1 then 0 else 1 end ) end)
           end) into SaldoXDep
from activos where activoid=r.activoid;


    r.SaldoXDeduc := SaldoXDep * r.FactSaldo;
    r.DeprecActulizada := r.DeprecActEjerc*.5;




   return next r;
  end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.depreciacionfiscal(date, date) OWNER TO sistema;

--
-- Name: depuraavales(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION depuraavales() RETURNS integer
    AS $$
declare
  r record;
  a record;
begin

 for r in
   select prestamoid,sujetoid,count(*),max(avalid) as avalid
     from avales
 group by prestamoid,sujetoid having count(*)>1
 loop
   delete from avales
    where prestamoid=r.prestamoid and
          sujetoid=r.sujetoid and
          avalid<>r.avalid;
 end loop;


 for r in
   select solicitudprestamoid,sujetoid,count(*),max(avalid) as avalid
     from avales
 group by solicitudprestamoid,sujetoid having count(*)>1
 loop
   delete from avales
    where solicitudprestamoid=r.solicitudprestamoid and
          sujetoid=r.sujetoid and
          avalid<>r.avalid;
 end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.depuraavales() OWNER TO sistema;

--
-- Name: depurabeneficiario(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION depurabeneficiario() RETURNS integer
    AS $$
declare
  r record;
begin

 for r in
   select inversionid,sujetoid,count(*),max(beneficiarioid) as beneficiarioid
     from beneficiario
 group by inversionid,sujetoid having count(*)>1
 loop
   delete from beneficiario
    where inversionid=r.inversionid and
          sujetoid=r.sujetoid and
          beneficiarioid<>r.beneficiarioid;
 end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.depurabeneficiario() OWNER TO sistema;

--
-- Name: depuraprestamo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION depuraprestamo(integer) RETURNS integer
    AS $_$
declare
  lprestamoid alias for $1;
begin

--  delete from logpoliza
--    where polizaid in (select polizaid from movicaja where prestamoid=lprestamoid);

--  delete from movipolizas
--    where polizaid in (select polizaid from movicaja where prestamoid=lprestamoid);

--  delete from movicaja where prestamoid=lprestamoid;
  
--  delete from polizas where polizaid not in (select polizaid from movipolizas group by polizaid);

  delete from avales where prestamoid=lprestamoid;
  delete from amortizaciones where prestamoid=lprestamoid;
  delete from prestamos where prestamoid=lprestamoid;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.depuraprestamo(integer) OWNER TO sistema;

--
-- Name: depurarelacion(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION depurarelacion() RETURNS integer
    AS $$
declare
  r record;
begin

 for r in
   select solicitudingresoid,sujetoid,count(*),max(relacionid) as relacionid
     from relacion
 group by solicitudingresoid,sujetoid having count(*)>1
 loop
   delete from relacion
    where solicitudingresoid=r.solicitudingresoid and
          sujetoid=r.sujetoid and
          relacionid<>r.relacionid;
 end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.depurarelacion() OWNER TO sistema;

--
-- Name: devengaahorro(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION devengaahorro(date, date) RETURNS integer
    AS $_$
declare
  pfecha1 alias for $1;
  pfecha2 alias for $2;

  r record;

  sserie_user char(2);

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  scuentacaja char(24);
  lmovicajaid int4;

  iperiodo1 int4;
  iano1 int4;
  iperiodo2 int4;
  iano2 int4;

  finteres numeric;

  gdiasanualesmov int4;
begin

  select diasanualesmov
    into gdiasanualesmov
    from empresa
   where empresaid=1;
  
  pnumero_poliza := 0;
  preferencia := 0;

  finteres := 0;

-- Por el momento nadamas tomo el 1er caso donde no hay devengamientos anteriores
-- pendiente terminar programcin


  sserie_user := 'ZA';

  select cuentacaja
    into scuentacaja
    from parametros
   where serie_user = sserie_user;

  delete from movicaja where polizaid in (select polizaid
                                            from polizas
                                           where fechapoliza =pfecha2 and
                                                 tipo='T');
  delete from movipolizas where polizaid in
   (select polizaid from polizas where fechapoliza=pfecha2 and tipo='T');

  delete from logpoliza where polizaid in (select polizaid from polizas where fechapoliza=pfecha2 and tipo='T');

  delete from polizas where fechapoliza=pfecha2 and tipo='T';

  delete from movicaja where polizaid in (select polizaid
                                            from polizas
                                           where fechapoliza =pfecha2+1 and tipo='W');

  delete from logpoliza where polizaid in (select polizaid from polizas where fechapoliza=pfecha2+1 and tipo='W');

  delete from movipolizas where polizaid in
   (select polizaid from polizas where fechapoliza=pfecha2+1 and tipo='W');


  delete from polizas where fechapoliza=pfecha2 and tipo='W';
 
      select coalesce(max(referenciacaja),0)
        into lreferenciacaja
        from movicaja
       where seriecaja = sserie_user;

  iperiodo1 := cast(date_part('month',pfecha2) as int);
  iano1 := cast(date_part('year',pfecha2) as int);
  iperiodo2 := cast(date_part('month',pfecha2+1) as int);
  iano2 := cast(date_part('year',pfecha2+1) as int);


  -- Poliza Global del Interes Devengado

  for r in
select m1.tipomovimientoid,t.cuentadeposito, t.cuentaintpagado, t.cuentaintcobrado,
       t.cuentaisr,sum(m1.interes) as interes,sum(m1.isr) as isr
FROM (SELECT m0.socioid,m0.tipomovimientoid,
       SUM(round(m0.sdopromedio*(pfecha2-pfecha1)*t0.tasainteres/100/gdiasanualesmov,2)) as interes,
        0 as isr

  FROM (SELECT s.SOCIOID,t.tipomovimientoid,
          saldopromedio(s.SOCIOID,pfecha1,pfecha2,t.tipomovimientoid) as sdopromedio
          FROM socio s,tipomovimiento t
         WHERE t.tasainteres>0) m0,tipomovimiento t0
  WHERE t0.tipomovimientoid=m0.tipomovimientoid         
GROUP BY m0.socioid,m0.tipomovimientoid) as m1, tipomovimiento t
 WHERE t.tipomovimientoid = m1.tipomovimientoid
GROUP BY m1.tipomovimientoid,t.cuentadeposito, t.cuentaintpagado, t.cuentaintcobrado,t.cuentaisr

  loop

      --
      -- Dar de alta la poliza contable T
      --

      -- Encabezado de la poliza
      select * 
        into ppolizaid
        from spipolizasfecha(preferencia,sserie_user,'T',pnumero_poliza,
                             iano1,
                             iperiodo1,
                             ' ',pfecha2,'D',' ',' ',
                             'Interes a Movimiento '||r.tipomovimientoid,pfecha2);


insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)
    values(ppolizaid,r.cuentaintcobrado,' ','A',0,r.interes-r.isr,'  ',' ','Int. Devengado '||r.tipomovimientoid);

insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)
    values(ppolizaid,r.cuentaisr,' ','A',0,r.isr,'  ',' ','Int. Devengado '||r.tipomovimientoid);

insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)
    values(ppolizaid,r.cuentaintpagado,' ','C',r.interes,0,'  ',' ','Int. Devengado '||r.tipomovimientoid);

  end loop;

  -- Realizar las polizas por cada socio
  for r in

SELECT m0.socioid,m0.tipomovimientoid,t.cuentadeposito, t.cuentaintpagado, t.cuentaintcobrado, t.cuentaisr,
       SUM(round(m0.sdopromedio*(pfecha2-pfecha1)*t.tasainteres/100/gdiasanualesmov,2)) as interes, 0 as isr

  FROM (SELECT s.SOCIOID,t.tipomovimientoid,
          saldopromedio(s.SOCIOID,pfecha1,pfecha2,t.tipomovimientoid) as sdopromedio
          FROM socio s,tipomovimiento t
         WHERE t.tasainteres>0) m0,tipomovimiento t
  WHERE t.tipomovimientoid=m0.tipomovimientoid         
GROUP BY m0.socioid,m0.tipomovimientoid,t.cuentadeposito, t.cuentaintpagado, t.cuentaintcobrado, t.cuentaisr

  loop

    raise notice 'Procesando socioid=%',r.socioid;
    if r.interes>0 then
      --
      -- Dar de alta la poliza contable W
      --

      -- Encabezado de la poliza
      select * 
        into ppolizaid
        from spipolizasfecha(preferencia,sserie_user,'W',pnumero_poliza,
                             iano2,
                             iperiodo2,
                             ' ',pfecha2+1,'D',' ',' ',
                             'Interes a Movimiento '||r.tipomovimientoid,pfecha2+1);

      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,r.cuentadeposito,' ','A',0,r.interes-r.isr,' ',' ','Int. Devengado '||r.tipomovimientoid);

      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,r.cuentaintcobrado,' ','C',r.interes-r.isr,0,' ',' ','Int. Devengado '||r.tipomovimientoid);

      -- Realizar el movimiento de caja

      lreferenciacaja := lreferenciacaja+1;   

      insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,estatusmovicaja,inversionid)
      values (r.socioid,r.tipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL);

    end if;
  end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.devengaahorro(date, date) OWNER TO sistema;

--
-- Name: devengaahorro(date, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION devengaahorro(date, date, integer) RETURNS integer
    AS $_$
declare
  pfecha1 alias for $1;
  pfecha2 alias for $2;
  pcapitaliza alias for $3;
 
  r record;

  sserie_user char(2);

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  scuentacaja char(24);
  lmovicajaid int4;

  iperiodo1 int4;
  iano1 int4;
  iperiodo2 int4;
  iano2 int4;

  finteres numeric;

  gdiasanualesmov int4;
begin

  select diasanualesmov
    into gdiasanualesmov
    from empresa
   where empresaid=1;
  
  pnumero_poliza := 0;
  preferencia := 0;

  finteres := 0;

-- Por el momento nadamas tomo el 1er caso donde no hay devengamientos anteriores
-- pendiente terminar programcion


  sserie_user := 'ZA';

  select cuentacaja
    into scuentacaja
    from parametros
   where serie_user = sserie_user;

  delete from movicaja where polizaid in (select polizaid
                                            from polizas
                                           where fechapoliza =pfecha2 and
                                                 tipo='T');
  delete from movipolizas where polizaid in
   (select polizaid from polizas where fechapoliza=pfecha2 and tipo='T');

  delete from logpoliza where polizaid in (select polizaid from polizas where fechapoliza=pfecha2 and tipo='T');

  delete from polizas where fechapoliza=pfecha2 and tipo='T';

  delete from movicaja where polizaid in (select polizaid
                                            from polizas
                                           where fechapoliza =pfecha2+1 and tipo='W');

  delete from logpoliza where polizaid in (select polizaid from polizas where fechapoliza=pfecha2+1 and tipo='W');

  delete from movipolizas where polizaid in
   (select polizaid from polizas where fechapoliza=pfecha2+1 and tipo='W');


  delete from polizas where fechapoliza=pfecha2 and tipo='W';
 
      select coalesce(max(referenciacaja),0)
        into lreferenciacaja
        from movicaja
       where seriecaja = sserie_user;

  iperiodo1 := cast(date_part('month',pfecha2) as int);
  iano1 := cast(date_part('year',pfecha2) as int);
  iperiodo2 := cast(date_part('month',pfecha2+1) as int);
  iano2 := cast(date_part('year',pfecha2+1) as int);


  -- Poliza Global del Interes Devengado

  for r in
select m1.tipomovimientoid,t.cuentadeposito, t.cuentaintpagado, t.cuentaintcobrado,
       t.cuentaisr,sum(m1.interes) as interes,sum(m1.isr) as isr
FROM (SELECT m0.socioid,m0.tipomovimientoid,
       SUM(round(m0.sdopromedio*(pfecha2-pfecha1)*t0.tasainteres/100/gdiasanualesmov,2)) as interes,
        0 as isr

  FROM (SELECT s.SOCIOID,t.tipomovimientoid,
          saldopromedio(s.SOCIOID,pfecha1,pfecha2,t.tipomovimientoid) as sdopromedio
          FROM socio s,tipomovimiento t
         WHERE t.tasainteres>0) m0,tipomovimiento t0
  WHERE t0.tipomovimientoid=m0.tipomovimientoid         
GROUP BY m0.socioid,m0.tipomovimientoid) as m1, tipomovimiento t
 WHERE t.tipomovimientoid = m1.tipomovimientoid
GROUP BY m1.tipomovimientoid,t.cuentadeposito, t.cuentaintpagado, t.cuentaintcobrado,t.cuentaisr

  loop

      --
      -- Dar de alta la poliza contable T
      --

      -- Encabezado de la poliza
      select * 
        into ppolizaid
        from spipolizasfecha(preferencia,sserie_user,'T',pnumero_poliza,
                             iano1,
                             iperiodo1,
                             ' ',pfecha2,'D',' ',' ',
                             'Interes a Movimiento '||r.tipomovimientoid,pfecha2);


insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)
    values(ppolizaid,r.cuentaintcobrado,' ','A',0,r.interes-r.isr,'  ',' ','Int. Devengado '||r.tipomovimientoid);

insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)
    values(ppolizaid,r.cuentaisr,' ','A',0,r.isr,'  ',' ','Int. Devengado '||r.tipomovimientoid);

insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)
    values(ppolizaid,r.cuentaintpagado,' ','C',r.interes,0,'  ',' ','Int. Devengado '||r.tipomovimientoid);

  end loop;

  -- Realizar las polizas por cada socio
  for r in

SELECT m0.socioid,m0.tipomovimientoid,t.cuentadeposito, t.cuentaintpagado, t.cuentaintcobrado, t.cuentaisr,
       SUM(round(m0.sdopromedio*(pfecha2-pfecha1)*t.tasainteres/100/gdiasanualesmov,2)) as interes, 0 as isr

  FROM (SELECT s.SOCIOID,t.tipomovimientoid,
          saldopromedio(s.SOCIOID,pfecha1,pfecha2,t.tipomovimientoid) as sdopromedio
          FROM socio s,tipomovimiento t
         WHERE t.tasainteres>0) m0,tipomovimiento t
  WHERE t.tipomovimientoid=m0.tipomovimientoid         
GROUP BY m0.socioid,m0.tipomovimientoid,t.cuentadeposito, t.cuentaintpagado, t.cuentaintcobrado, t.cuentaisr

  loop

    raise notice 'Procesando socioid=%',r.socioid;
    if r.interes>0 then
      --
      -- Dar de alta la poliza contable W
      --

      -- Encabezado de la poliza
      select * 
        into ppolizaid
        from spipolizasfecha(preferencia,sserie_user,'W',pnumero_poliza,
                             iano2,
                             iperiodo2,
                             ' ',pfecha2+1,'D',' ',' ',
                             'Interes a Movimiento '||r.tipomovimientoid,pfecha2+1);

      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,r.cuentadeposito,' ','A',0,r.interes-r.isr,' ',' ','Int. Devengado '||r.tipomovimientoid);

      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,r.cuentaintcobrado,' ','C',r.interes-r.isr,0,' ',' ','Int. Devengado '||r.tipomovimientoid);

      -- Realizar el movimiento de caja

      lreferenciacaja := lreferenciacaja+1;   

      insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,estatusmovicaja,inversionid)
      values (r.socioid,r.tipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL);

    end if;
  end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.devengaahorro(date, date, integer) OWNER TO sistema;

--
-- Name: devengadoanterior(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION devengadoanterior(integer, date) RETURNS numeric
    AS $_$
declare

  pprestamoid alias for $1;
  pfecha alias for $2;        
  psumaanterior numeric;
  pperiodo int;
  pperiodoant int;
  pejercicio int;
  pejercicioant int;

begin
  
  pejercicio:=cast(date_part('year',pfecha) as int4);
  pperiodo:=cast(date_part('month',pfecha) as int4);
  pperiodoant:=pperiodo -1;
  pejercicioant:= pejercicio;

  if pperiodoant = 0 then
        pperiodoant := 12;
        pejercicioant := pejercicio-1;
  end if;

--  raise notice ' % % prestamoid % ',pperiodoant,pejercicioant,pprestamoid;

  select coalesce(interesdevengadomenoravencido,0)+coalesce(interesdevengadomayoravencido,0)+coalesce(interesdevmormenor,0)+coalesce(interesdevmormayor,0) into psumaanterior from precorte where prestamoid=pprestamoid and ejercicio=pejercicioant and periodo=pperiodoant;

  psumaanterior := coalesce(psumaanterior,0);

return psumaanterior;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.devengadoanterior(integer, date) OWNER TO sistema;

--
-- Name: devengadoperiodo(integer, date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION devengadoperiodo(integer, date, date) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;
  pfechacorte alias for $2;
  pfechaant   alias for $3;
  finteres1 numeric;
  finteres2 numeric;
 
begin


select interesdevengadomenoravencido+interesdevmormenor into finteres1 from precorte where fechacierre=pfechacorte and prestamoid=pprestamoid;
finteres1:=coalesce(finteres1,0);

select interesdevengadomenoravencido+interesdevmormenor into finteres2 from precorte where fechacierre=pfechaant  and prestamoid=pprestamoid;
finteres2:=coalesce(finteres2,0);

finteres1:=finteres1-finteres2;

return finteres1;

END;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.devengadoperiodo(integer, date, date) OWNER TO sistema;

--
-- Name: devengaintereses(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION devengaintereses(date, date) RETURNS integer
    AS $_$
declare
  pfecha1 alias for $1;
  pfecha2 alias for $2;

  r record;
  r1 record;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  scuentaid char(24);
  debehaber1 numeric;
  debehaber2 numeric;
  debehaber21 numeric;
  debehaber3 numeric;
  debehaber4 numeric;
  debehaber5 numeric;

  sserie_user char(2);

  bprimer bool;
  diniciadevengamiento date;

begin

  select iniciadevengamiento
    into diniciadevengamiento
    from empresa;

  if pfecha2=diniciadevengamiento then
    bprimer:=true;
  else
    bprimer:=false;
  end if;
  
  sserie_user := 'ZA';

-- 
-- Borrar poliza del mismo da, serie y tipo=V
--

  delete from logpoliza where polizaid in (select polizaid from polizas where seriepoliza=sserie_user and tipo='V' and fechapoliza=pfecha1);

  delete from movipolizas where polizaid in (select polizaid from polizas where seriepoliza=sserie_user and tipo='V' and fechapoliza=pfecha1);

  delete from polizas where seriepoliza=sserie_user and tipo='V' and fechapoliza=pfecha1;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha1) as int),cast(date_part('month',pfecha1) as int),'V',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'V',pnumero_poliza,cast(date_part('year',pfecha1) as int),cast(date_part('month',pfecha1) as int),' ',pfecha1,'D',' ',' ','Devenga Intereses',pfecha1);

  for r in

select p.tipoprestamoid,t.cuentaactivo,t.cuentaactivovencida,t.cuentaintdevnocobres,
       t.cuentaintnormalnocob,t.cuentaordeninteres,t.ordeninteresacreedor,
       t.cuentaintnormal,t.cuentaintmora,t.cuentaintnormalresvencida,
       t.cuentaintnormalvencida,t.cuentaintmoravencida,t.cuentaintnormalresvigente,
       sum((case when p.diasvencidos <= t.diastraspasoavencida
                 then p.saldoprestamo else 0 end)) as A, 
       sum((case when p.diasvencidos > t.diastraspasoavencida
                 then p.saldoprestamo else 0 end)) as B, 
       sum((case when p.diasvencidos <= t.diastraspasoavencida
                 then p.interesdevengadomenoravencido+p.interesdevmormenor else 0 end)) as C,
       sum((case when p.diasvencidos > t.diastraspasoavencida
                 then p.interesdevengadomenoravencido+p.interesdevmormenor else 0 end)) as CC,
       sum((case when p.diasvencidos <= t.diastraspasoavencida
                 then p.interesdevengadomayoravencido+p.interesdevmormayor else 0 end)) as D,
       sum((case when p.diasvencidos > t.diastraspasoavencida
                 then p.interesdevengadomayoravencido+p.interesdevmormayor else 0 end)) as DD,       
       sum((case when p.diasvencidos > t.diastraspasoavencida
                 then p.pagointeresenperiodo else 0 end)) as interes,
       sum((case when p.diasvencidos > t.diastraspasoavencida
                 then p.pagomoratorioenperiodo else 0 end)) as moratorio
  from precorte p, tipoprestamo t
 where p.fechacierre = pfecha1 and
       t.tipoprestamoid = p.tipoprestamoid 
group by p.tipoprestamoid,t.cuentaactivo,t.cuentaactivovencida,t.cuentaintdevnocobres,
       t.cuentaintnormalnocob,t.cuentaordeninteres,t.ordeninteresacreedor,
       t.cuentaintnormal,t.cuentaintmora,t.cuentaintnormalresvencida,
       t.cuentaintnormalvencida,t.cuentaintmoravencida,t.cuentaintnormalresvigente
  loop

    for r1 in
  select t.tipoprestamoid,
       sum((case when p.diasvencidos <= t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.saldoprestamo else 0 end)) as A1, 
       sum((case when p.diasvencidos > t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.saldoprestamo else 0 end)) as B1, 
       sum((case when p.diasvencidos <= t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.interesdevengadomenoravencido+p.interesdevmormenor else 0 end)) as C1,
       sum((case when p.diasvencidos > t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.interesdevengadomenoravencido+p.interesdevmormenor else 0 end)) as CC1,
       sum((case when p.diasvencidos <= t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.interesdevengadomayoravencido+p.interesdevmormayor else 0 end)) as D1,
       sum((case when p.diasvencidos > t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.interesdevengadomayoravencido+p.interesdevmormayor else 0 end)) as DD1,       
       sum((case when p.diasvencidos > t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.pagointeresenperiodo else 0 end)) as interes1,
       sum((case when p.diasvencidos > t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.pagomoratorioenperiodo else 0 end)) as moratorio1
  from tipoprestamo t left join precorte p on t.tipoprestamoid=p.tipoprestamoid
 where t.tipoprestamoid=r.tipoprestamoid
group by t.tipoprestamoid  

    loop

      -- 1era Parte
      if bprimer then
        debehaber1 := r.b;
      else
        debehaber1 := r.b-r1.b1;
      end if;

      if debehaber1<>0 then
      if debehaber1>0 then
        scuentaid := r.cuentaactivovencida;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','C',debehaber1,0,' ',' ',
                             'Trasp. activo vig. a vencida');
        scuentaid := r.cuentaactivo;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,debehaber1,' ',' ',
                             'Disminuir la cartera vigente');
      else
        scuentaid := r.cuentaactivo;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','C',abs(debehaber1),0,' ',
                             ' ','Trasp. activo vig. a vencida');
        scuentaid := r.cuentaactivovencida;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,abs(debehaber1),' ',
                             ' ','Disminuir la cartera vigente');
      end if;
      end if;

      -- 2da Parte
      if bprimer then
        debehaber2 := r.c;
        debehaber21 := r.cc;
      else
        debehaber2 := r.c-r1.c1;
        debehaber21 := r.cc-r1.cc1;
      end if;

      if debehaber2<>0 then
      if debehaber2>0 then
        scuentaid := r.cuentaintdevnocobres;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','C',debehaber2,0,' ',' ',
                             'Activo int. dev. no cobrados');
        scuentaid := r.cuentaintnormalnocob;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,debehaber2,' ',' ',
                             'Ingreso int. dev. no cobrados'); 
      else
        scuentaid := r.cuentaintnormalnocob;        
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','C',abs(debehaber2),0,' ',
               ' ','Activo int. dev. no cobrados');
        scuentaid := r.cuentaintdevnocobres;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,abs(debehaber2),' ',
               ' ','Ingreso int. dev. no cobrados'); 
      end if;
      end if;

      if debehaber21<>0 then
        if debehaber21>0 then
          scuentaid := r.cuentaintnormalvencida;
          select *
            into pmovipolizaid
           from spimovipoliza(ppolizaid,scuentaid,' ','C',debehaber21,0,' ',' ',
                             'Orden int. dev. cartera venc.');
 	   scuentaid := r.CuentaIntNormalResVigente;
        
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,debehaber21,' ',' ',
                             'Orden int. dev. cartera venc.');         
        else 

	  scuentaid := r.CuentaIntNormalResVigente;
          
          select *
            into pmovipolizaid
            from spimovipoliza(ppolizaid,scuentaid,' ','C',abs(debehaber21),0,' ',
               ' ','Orden int. dev. cartera venc.');
          --scuentaid := r.cuentaintdevnocobres;  Esta cuenta estaba mal
          scuentaid := r.cuentaintnormalvencida;
          select *
            into pmovipolizaid
            from spimovipoliza(ppolizaid,scuentaid,' ','A',0,abs(debehaber21),' ',
               ' ','Orden int. dev. cartera venc.'); 
        end if;

      end if;

      -- 3era Parte

      if bprimer then
        debehaber3 := r.d + r.dd;
      else
        debehaber3 := r.d + r.dd - r1.d1 - r1.dd1;
      end if;

      if debehaber3<>0 then
      if debehaber3>0 then
        scuentaid := r.cuentaordeninteres;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','C',debehaber3,0,' ',' ',
                             'CuentaOrdenInteres');
        scuentaid := r.ordeninteresacreedor;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,debehaber3,' ',' ',
                             'OrdenInteresAcreedor'); 
      else
        scuentaid := r.ordeninteresacreedor;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','C',abs(debehaber3),0,' ',
               ' ','OrdenInteresAcreedor');
        scuentaid := r.cuentaordeninteres;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,abs(debehaber3),' ',
               ' ','CuentaOrdenInteres'); 
      end if;
      end if;
      
      debehaber4 := r.interes;
      debehaber5 := r.moratorio;

      if debehaber4>0 then
        scuentaid := r.cuentaintnormal;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','C',debehaber4,0,' ',' ',
                             'CuentaIntNormal');
      end if;
      if debehaber5>0 then
        scuentaid := r.cuentaintmora;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','C',debehaber5,0,' ',' ',
                             'CuentaIntMora');
      end if;
      if debehaber4>0 then
        scuentaid := r.cuentaintnormalresvencida;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,debehaber4,
               ' ',' ','cuentaintnormalresvencida'); 
      end if;
      if debehaber5>0 then
        scuentaid := r.cuentaintmoravencida;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,debehaber5,
               ' ',' ','cuentaintmroavencida'); 
      end if;

    end loop;
  end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.devengaintereses(date, date) OWNER TO sistema;

--
-- Name: devengainversion(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION devengainversion(date) RETURNS integer
    AS $_$
declare
  pfecha1 alias for $1;

  r record;

  sserie_user char(2);

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;


  --pultimodevengamiento date;
begin

  sserie_user := 'ZA';

  delete from movipolizas where polizaid in
   (select polizaid from polizas where fechapoliza=pfecha1 and tipo='U');
  delete from polizas where fechapoliza=pfecha1 and tipo='U';

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha1) as int),cast(date_part('month',pfecha1) as int),'U',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'U',pnumero_poliza,cast(date_part('year',pfecha1) as int),cast(date_part('month',pfecha1) as int),' ',pfecha1,'D',' ',' ','Devenga Intereses Inversiones',pfecha1);


  -- Realizarlo
  for r in 
    select tipoinversionid,cuentapasivo,cuentaintinvernocob,sum(interesdevengado) as interes
      from (
      select i.inversionid,s.clavesocioint, t.cuentapasivo, t.cuentaintinvernocob, t.tipoinversionid,
       MAX(case when mp.cuentaid=t.cuentaintinver
               then (case when p.fechapoliza<pfecha1
                          then p.fechapoliza
                          else i.fechainversion end)
               else i.fechainversion end) as fechainicial,
       ( pfecha1 -
       COALESCE(MAX(case when mp.cuentaid=t.cuentaintinver
               then (case when p.fechapoliza<pfecha1
                          then p.fechapoliza
                          else i.fechainversion end)
               else i.fechainversion end),i.fechainversion))*i.tasainteresnormalinversion/100/365*i.Depositoinversion
               as InteresDevengado              
  from inversion i, movicaja m, polizas p, movipolizas mp, tipoinversion t, socio s
 where i.fechainversion<pfecha1 and
       m.inversionid = i.inversionid and
       p.polizaid = m.polizaid and
       p.fechapoliza <= pfecha1 and
       t.tipoinversionid = i.tipoinversionid and
       mp.polizaid = p.polizaid and
       s.socioid = i.socioid
group by i.inversionid,s.clavesocioint,i.fechainversion,i.tasainteresnormalinversion,i.depositoinversion,
         t.tipoinversionid, t.cuentapasivo,t.cuentaintinvernocob
having SUM((case when mp.cuentaid=t.cuentapasivo
                 then mp.haber-mp.debe
                 else 0 end))>0 
           ) as t
    group by tipoinversionid,cuentapasivo,cuentaintinvernocob

  loop  
    select *
      into pmovipolizaid
      from spimovipoliza(ppolizaid,r.cuentaintinvernocob,' ','C',r.interes,0,' ',' ','Int. Devengado No Pagado '||r.tipoinversionid);
    select *
      into pmovipolizaid
      from spimovipoliza(ppolizaid,r.cuentapasivo,' ','A',0,r.interes,' ',' ','Int. Devengado No Pagado '||r.tipoinversionid);

  end loop;

return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.devengainversion(date) OWNER TO sistema;

--
-- Name: devengainversion(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION devengainversion(date, date) RETURNS integer
    AS $_$
declare
  pfecha1 alias for $1;
  pfecha2 alias for $2;

  r record;
  r1 record;

  sserie_user char(2);

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;
  pperiodoactual int4;
  pperiodoanterior int4;

  finteresanterior numeric;
  finteresacumulado numeric;
  fpagadodev numeric;

  gdiasanualesinversion int4;
  diniciadevengamiento date;
  ssucid character(4);

begin

  select diasanualesinversion,iniciadevengainversion,sucid
    into gdiasanualesinversion,diniciadevengamiento,ssucid
    from empresa
   where empresaid=1;   

-- Por el momento nadamas tomo el 1er caso donde no hay devengamientos anteriores
-- pendiente terminar programcin
-- Se modifico para el devengamiento del mes anterior y actual 28/09/2005

  sserie_user := 'ZA';
  pperiodoactual := cast(date_part('month',pfecha1) as int);
  pperiodoanterior := cast(date_part('month',pfecha2) as int);


  delete from movipolizas where polizaid in
   (select polizaid from polizas where fechapoliza=pfecha1 and tipo='U');
  delete from polizas where fechapoliza=pfecha1 and tipo='U';

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha1) as int),cast(date_part('month',pfecha1) as int),'U',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'U',pnumero_poliza,cast(date_part('year',pfecha1) as int),cast(date_part('month',pfecha1) as int),' ',pfecha1,'D',' ',' ','Devenga Intereses Inversiones',pfecha1);

  -- Realizarlo

  -- Periodo Actual

   for r in 
    select ct.fechadegeneracion,t.cuentapasivo,t.cuentapasivovencida,t.cuentaintinvernocob,sum(ct.intdevmensual) as interes, sum(ct.intdevacumulado) as interesacumulado
  from inversion i, tipoinversion t, captaciontotal ct
 where ct.fechadegeneracion=pfecha1 and
       ct.sucursal=ssucid and 
       ct.inversionid = i.inversionid and       
       t.tipoinversionid = i.tipoinversionid
    group by ct.fechadegeneracion,t.cuentapasivo,t.cuentapasivovencida,t.cuentaintinvernocob

   loop

     -- Periodo anterior
     finteresanterior:=0;
          
     if pfecha2 > diniciadevengamiento then

        select sum(ct.intdevmensual) as interes, sum(ct.intdevacumulado) as interesacumulado into finteresanterior,finteresacumulado
        from inversion i, tipoinversion t, captaciontotal ct
        where ct.fechadegeneracion=pfecha2 and
          ct.sucursal=ssucid and 
          ct.inversionid = i.inversionid and       
          t.tipoinversionid = i.tipoinversionid
          and t.cuentapasivo = r.cuentapasivo
          group by ct.fechadegeneracion,t.cuentapasivo,t.cuentapasivovencida,t.cuentaintinvernocob;

        finteresanterior:=coalesce(finteresanterior,0);
        finteresacumulado:=coalesce(finteresacumulado,0);

        raise notice 'Procesando caso 1 tipoinversionid  %  %  %',finteresacumulado,r.interes,r.interesacumulado;

        fpagadodev:= finteresacumulado+r.interes-r.interesacumulado;
        
        select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,r.cuentaintinvernocob,' ','A',0,fpagadodev,' ',' ','Int. Devengado Pag 1 ');

        select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,r.cuentapasivovencida,' ','C',fpagadodev,0,' ',' ','Int. Devengado Pag 1 ');


        raise notice 'Procesando caso 3 tipoinversionid  %  %',finteresanterior,r.interes;

        select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,r.cuentaintinvernocob,' ','C',r.interes,0,' ',' ','Int. Devengado No Pag 3 ');

        select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,r.cuentapasivovencida,' ','A',0,r.interes,' ',' ','Int. Devengado No Pag 3 ');


     else

       if pfecha2 = diniciadevengamiento then

               raise notice 'Procesando caso 2 tipoinversionid  %  %',finteresanterior,r.interes;

               select *
               into pmovipolizaid
               from spimovipoliza(ppolizaid,r.cuentaintinvernocob,' ','C',r.interesacumulado,0,' ',' ','Int. Dev No Pagado Inicial ');

               select *
               into pmovipolizaid
               from spimovipoliza(ppolizaid,r.cuentapasivovencida,' ','A',0,r.interesacumulado,' ',' ','Int. Dev No Pagado Inicial ');

     

       end if;

     end if;

   end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.devengainversion(date, date) OWNER TO sistema;

--
-- Name: devengamovsocio(character, character, date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION devengamovsocio(character, character, date, date) RETURNS numeric
    AS $_$
declare
  pclavesocioint alias for $1;
  ptipomovimientoid alias for $2;
  pfecha1 alias for $3;
  pfecha2 alias for $4;

  r record;

  finteres numeric;
  lsocioid int4;
  gdiasanualesmov int4;
begin

    select diasanualesmov
      into gdiasanualesmov
      from empresa
     where empresaid=1;

  select socioid into lsocioid
    from socio where clavesocioint=pclavesocioint;


SELECT SUM(round((case when p.fechapoliza<pfecha1 then
             mp.haber-mp.debe else 0 end)*(pfecha2-pfecha1)*t.tasainteres/100/gdiasanualesmov,2)) +
       SUM(round(case when p.fechapoliza>pfecha1-1 then
              mp.haber*(pfecha2-p.fechapoliza)*t.tasainteres/100/gdiasanualesmov
            else 0 end,2)) -
       SUM(round(case when p.fechapoliza>pfecha1-1 then
               mp.debe*(pfecha2-p.fechapoliza)*t.tasainteres/100/gdiasanualesmov
             else 0 end,2)) as interes
  into finteres
  FROM movicajag m, polizas p, movipolizas mp, tipomovimiento t
 WHERE p.fechapoliza between '01-01-1900' and pfecha2 and
       mp.polizaid = p.polizaid and
       (mp.cuentaid = t.cuentadeposito or mp.cuentaid=t.cuentaretiro) and
       m.polizaid = p.polizaid and
       m.tipomovimientoid=ptipomovimientoid and    
       t.tipomovimientoid = m.tipomovimientoid and
       t.tasainteres > 0 and m.socioid=lsocioid;

  finteres := coalesce(finteres,0);

return finteres;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.devengamovsocio(character, character, date, date) OWNER TO sistema;

--
-- Name: diario(character, character, date, date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION diario(character, character, date, date, character, character) RETURNS SETOF sucursal1.catalogo_ctas
    AS $_$
declare
  pcuentai    alias for $1;
  pcuentaf    alias for $2;
  pfechai     alias for $3;
  pfechaf     alias for $4;
  psoloconmov alias for $5;
  pserie      alias for $6;
  r catalogo_ctas%rowtype;
  ldebe  numeric;
  lhaber numeric;
begin

   ldebe :=0;
   lhaber :=0;

   if pserie='  ' then
     -- Solo tomar los movicaja
     for r in

       select c.cuentaid,c.cat_cuentaid,c.identificacion,c.cuentanombre,c.tipo_cta,c.estado_cta,
              c.fecha_estado,c.fecha_ult_mov,c.naturaleza,c.digito_agrupador,
              0 as saldo_inic_ejer,sum(m.debe) as cargos_acum_ejer,sum(m.haber) as abonos_acum_ejer
         from polizas p, movipolizas m, catalogo_ctas c
        where p.fechapoliza between pfechai and pfechaf and
              m.polizaid=p.polizaid and m.cuentaid=c.cuentaid and 
              exists ( select polizaid from movicaja where movicaja.polizaid = p.polizaid)
     group by c.cuentaid,c.cat_cuentaid,c.identificacion,c.cuentanombre,c.tipo_cta,c.estado_cta,
              c.fecha_estado,c.fecha_ult_mov,c.naturaleza,c.digito_agrupador
     loop
       ldebe := ldebe + r.cargos_acum_ejer;
       lhaber := lhaber + r.abonos_acum_ejer;
       return next r;
     end loop;

     if psoloconmov='N' then
       for r in
         select cx.cuentaid,cx.cat_cuentaid,cx.identificacion,cx.cuentanombre,cx.tipo_cta,cx.estado_cta,
            cx.fecha_estado,cx.fecha_ult_mov,cx.naturaleza,cx.digito_agrupador,
              0 as saldo_inic_ejer,0 as cargos_acum_ejer,0 as abonos_acum_ejer
         from catalogo_ctas cx
         where not exists (select c.cuentaid
                           from polizas p, movipolizas m, catalogo_ctas c
                          where c.cuentaid>=pcuentai and c.cuentaid<=pcuentaf and
                                p.fechapoliza between pfechai and pfechaf and
                                m.polizaid=p.polizaid and m.cuentaid=c.cuentaid and
                                c.cuentaid=cx.cuentaid and
                                (pserie='  ' or p.seriepoliza=pserie)
                       group by c.cuentaid) and
             cx.tipo_cta='A' and
             cx.cuentaid>=pcuentai and cx.cuentaid<=pcuentaf
       loop
         return next r;
       end loop;    
     end if;
   else
     for r in
       select c.cuentaid,c.cat_cuentaid,c.identificacion,c.cuentanombre,c.tipo_cta,c.estado_cta,
              c.fecha_estado,c.fecha_ult_mov,c.naturaleza,c.digito_agrupador,
              0 as saldo_inic_ejer,sum(m.debe) as cargos_acum_ejer,sum(m.haber) as abonos_acum_ejer
         from polizas p, movipolizas m, catalogo_ctas c
        where c.cuentaid>=pcuentai and c.cuentaid<=pcuentaf and
              p.fechapoliza between pfechai and pfechaf and
              m.polizaid=p.polizaid and m.cuentaid=c.cuentaid and
              (pserie='  ' or p.seriepoliza=pserie)
        group by c.cuentaid,c.cat_cuentaid,c.identificacion,c.cuentanombre,c.tipo_cta,c.estado_cta,
              c.fecha_estado,c.fecha_ult_mov,c.naturaleza,c.digito_agrupador
     loop
       ldebe := ldebe + r.cargos_acum_ejer;
       lhaber := lhaber + r.abonos_acum_ejer;
       return next r;
     end loop;

     if psoloconmov='N' then
       for r in
         select cx.cuentaid,cx.cat_cuentaid,cx.identificacion,cx.cuentanombre,cx.tipo_cta,cx.estado_cta,
            cx.fecha_estado,cx.fecha_ult_mov,cx.naturaleza,cx.digito_agrupador,
              0 as saldo_inic_ejer,0 as cargos_acum_ejer,0 as abonos_acum_ejer
         from catalogo_ctas cx
         where not exists (select c.cuentaid
                           from polizas p, movipolizas m, catalogo_ctas c
                          where c.cuentaid>=pcuentai and c.cuentaid<=pcuentaf and
                                p.fechapoliza between pfechai and pfechaf and
                                m.polizaid=p.polizaid and m.cuentaid=c.cuentaid and
                                c.cuentaid=cx.cuentaid and
                                (pserie='  ' or p.seriepoliza=pserie)
                       group by c.cuentaid) and
             cx.tipo_cta='A' and
             cx.cuentaid>=pcuentai and cx.cuentaid<=pcuentaf
       loop
         return next r;
       end loop;    
     end if;
   end if;



   r.cuentaid := '9999999999';
   r.cuentanombre := 'TOTALES .... ';
   r.cargos_acum_ejer := ldebe;
   r.abonos_acum_ejer := lhaber;
   return next r;
  
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.diario(character, character, date, date, character, character) OWNER TO sistema;

--
-- Name: diasatrasocapital(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION diasatrasocapital(integer, date) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;
  phastafecha alias for $2;
  pdias int4;
  pfecha date;
begin

  select min(a.fechadepago)
    into pfecha
    from amortizaciones a
   where a.prestamoid=pprestamoid and
         a.fechadepago<phastafecha and
         a.importeamortizacion-a.abonopagado>0;

  pdias := phastafecha-coalesce(pfecha,phastafecha);
  if pdias<0 then
    pdias := 0;
  end if;

return pdias;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.diasatrasocapital(integer, date) OWNER TO sistema;

--
-- Name: diasatrasocapitalneg(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION diasatrasocapitalneg(integer, date) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;
  phastafecha alias for $2;
  pdias int4;
  pfecha date;
  pnumamortizacion int4;
  r record;

begin

  select min(a.fechadepago)
    into pfecha
    from amortizaciones a
   where a.prestamoid=pprestamoid and
         a.fechadepago<phastafecha and
         a.importeamortizacion-a.abonopagado>0;

  pdias := phastafecha-coalesce(pfecha,phastafecha);

  if pdias=0 then

    select min(a.fechadepago)
     into pfecha
     from amortizaciones a
     where a.prestamoid=pprestamoid and
         a.abonopagado=0;

    pdias := phastafecha-coalesce(pfecha,phastafecha);
    
  end if;

return pdias;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.diasatrasocapitalneg(integer, date) OWNER TO sistema;

--
-- Name: diasfecha(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION diasfecha(date, date) RETURNS integer
    AS $_$
declare
   pfecha alias for $1;
   pfecha2 alias for $2;

begin

   return pfecha2-pfecha;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.diasfecha(date, date) OWNER TO sistema;

--
-- Name: diasintactual(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION diasintactual(integer) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;

  idias int4;

begin
  idias:=0;
  if pprestamoid is not null then
    select diasint into idias from spscalculopago(pprestamoid);
  end if;
 
return idias;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.diasintactual(integer) OWNER TO sistema;

--
-- Name: editartabla(integer, numeric, numeric, integer, numeric, numeric, integer, numeric, numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION editartabla(integer, numeric, numeric, integer, numeric, numeric, integer, numeric, numeric, integer) RETURNS numeric
    AS $_$
declare
  pprestamoid  alias for $1;
  pnumero1     alias for $2;
  pimporte1    alias for $3;
  pdias1       alias for $4;
  pnumero2     alias for $5;
  pimporte2    alias for $6;
  pdias2       alias for $7;
  pnumero3     alias for $8;
  pimporte3    alias for $9;
  pdias3       alias for $10;

  fvalor numeric;
  fmontoprestamo numeric;
  fmontoamortiza numeric;
  ftasanormal numeric;
  j integer;
  h integer;
  finteres numeric;
  fiva numeric;
  fsaldoinsoluto numeric;
  ppago1 date;
  pfechadepago date;
  piva numeric;
  ptotalpago numeric;
  pahorro numeric;
  pseguro numeric;
  ptipoprestamoid char(3);
  giva numeric;
  gdiasanualesprestamo integer;
  saplicaivaprestamo char(1);
  icalculonormalid integer;
  dfechai date;
    
begin

  fvalor:=0;
  j:=1 ;
  
  select montoprestamo,tasanormal,fecha_1er_pago,fecha_otorga,tipoprestamoid into fmontoprestamo,ftasanormal,ppago1,dfechai,ptipoprestamoid from prestamos where prestamoid=pprestamoid;


  select iva,diasanualesprestamo
    into gIVA,gdiasanualesprestamo
    from empresa
   where empresaid=1;
   
   select aplicaivaprestamo,calculonormalid
    into  saplicaivaprestamo,icalculonormalid
    from tipoprestamo
   where tipoprestamoid=ptipoprestamoid;
   
   pfechadepago:=dfechai;

   fsaldoinsoluto:=fmontoprestamo;
  
   fmontoamortiza:=(pnumero1*pimporte1)+(pnumero2*pimporte2)+(pnumero3*pimporte3);

   raise notice ' % %',fmontoamortiza,fmontoprestamo;
   
   if fmontoamortiza=fmontoprestamo then

     delete from amortizaciones where prestamoid=pprestamoid;

     h:=1; 
     while h <= pnumero1
       loop


          pahorro:=0;
          pseguro:=0;
          
          dfechai:=pfechadepago;
          pfechadepago:=pfechadepago+pdias1;
          
          if icalculonormalid<>4 then     
             finteres := round(fsaldoinsoluto*(pfechadepago-dfechai)*ftasanormal/100/gdiasanualesprestamo,2);
          else 
             finteres := round(pmontoprestamo*(pfechadepago-dfechai)*ftasanormal/100/gdiasanualesprestamo,2);
          end if;
          
          if saplicaivaprestamo='S' then
             piva := round(finteres*gIVA,2);
          else
             piva := 0;
          end if;
          
          fsaldoinsoluto:=fsaldoinsoluto-pimporte1;
          
          insert into amortizaciones(prestamoid,numamortizacion,fechadepago,importeamortizacion,interesnormal,saldo_absoluto,interespagado,abonopagado,ultimoabono,claveestadocredito,iva,totalpago,ahorro,seguro)
    values( pprestamoid,
            j,
            pfechadepago,
            pimporte1,
            finteres,
            fsaldoinsoluto,
            0,
            0,
            pfechadepago,
            '001',
            piva,
            ptotalpago,pahorro,pseguro);

            j:=j+1;
            h:=h+1;
          
            
            fvalor:=fvalor+pimporte1;
            
      end loop;


      -- Segundo Ciclo

      h:=1; 
      while h <= pnumero2
       loop


          pahorro:=0;
          pseguro:=0;
   
          dfechai:=pfechadepago;
          pfechadepago:=pfechadepago+pdias2;

          --raise notice '% - % ',pfechadepago,dfechai;
          if icalculonormalid<>4 then     
             finteres := round(fsaldoinsoluto*(pfechadepago-dfechai)*ftasanormal/100/gdiasanualesprestamo,2);
          else 
             finteres := round(pmontoprestamo*(pfechadepago-dfechai)*ftasanormal/100/gdiasanualesprestamo,2);
          end if;
          
          if saplicaivaprestamo='S' then
             piva := round(finteres*gIVA,2);
          else
             piva := 0;
          end if;
          
          fsaldoinsoluto:=fsaldoinsoluto-pimporte2;
          
          insert into amortizaciones(prestamoid,numamortizacion,fechadepago,importeamortizacion,interesnormal,saldo_absoluto,interespagado,abonopagado,ultimoabono,claveestadocredito,iva,totalpago,ahorro,seguro)
    values( pprestamoid,
            j,
            pfechadepago,
            pimporte2,
            finteres,
            fsaldoinsoluto,
            0,
            0,
            pfechadepago,
            '001',
            piva,
            ptotalpago,pahorro,pseguro);

            j:=j+1;
            h:=h+1;
         
            fvalor:=fvalor+pimporte2;
            
      end loop;

       -- Tercer Ciclo

      h:=1; 
      while h <= pnumero3
       loop


          pahorro:=0;
          pseguro:=0;

           dfechai:=pfechadepago;       
           pfechadepago:=pfechadepago+pdias3;
        
          if icalculonormalid<>4 then     
             finteres := round(fsaldoinsoluto*(pfechadepago-dfechai)*ftasanormal/100/gdiasanualesprestamo,2);
          else 
             finteres := round(pmontoprestamo*(pfechadepago-dfechai)*ftasanormal/100/gdiasanualesprestamo,2);
          end if;
          
          if saplicaivaprestamo='S' then
             piva := round(finteres*gIVA,2);
          else
             piva := 0;
          end if;

          fsaldoinsoluto:=fsaldoinsoluto-pimporte3;
  
          insert into amortizaciones(prestamoid,numamortizacion,fechadepago,importeamortizacion,interesnormal,saldo_absoluto,interespagado,abonopagado,ultimoabono,claveestadocredito,iva,totalpago,ahorro,seguro)
    values( pprestamoid,
            j,
            pfechadepago,
            pimporte3,
            finteres,
            fsaldoinsoluto,
            0,
            0,
            pfechadepago,
            '001',
            piva,
            ptotalpago,pahorro,pseguro);

            j:=j+1;
            h:=h+1;
           
            fvalor:=fvalor+pimporte3;
            
      end loop;
     

      update prestamos set fecha_vencimiento= pfechadepago where prestamoid=pprestamoid;
      
  end if;

  return fvalor;

  end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.editartabla(integer, numeric, numeric, integer, numeric, numeric, integer, numeric, numeric, integer) OWNER TO sistema;

--
-- Name: edobanco(character, date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION edobanco(character, date, date) RETURNS SETOF tedobanco
    AS $_$
declare
  pno_cuenta   alias for $1;
  pfechai      alias for $2;
  pfechaf      alias for $3;

  r tedobanco%rowtype;

  dfecha_inicio date;
  fsaldoinicial numeric;
  fmovs numeric;

  fcargos numeric;
  fabonos numeric;
  idorden integer;
  sworden integer;

begin

   sworden := 0;
   fcargos := 0;
   fabonos := 0;
 
    select saldo_inicial,fecha_inicio
      into fsaldoinicial,dfecha_inicio
      from bancos
     where no_cuenta = pno_cuenta;

    select sum(m.debe-m.haber)
      into fmovs
      from bancos b, polizas p, movipolizas m
     where b.no_cuenta=pno_cuenta and
           p.fechapoliza between dfecha_inicio+1 and pfechai-1 and
           m.polizaid = p.polizaid and
           m.cuentaid = b.cuentaid;

    fmovs := coalesce(fmovs,0);
    fsaldoinicial := fsaldoinicial + fmovs;

    r.descritipomovibanco := 'Saldo Inicial ....';
    r.saldof := round(fsaldoinicial,2);
    r.idorden :=0;
    return next r;

    for r in

      select p.fechapoliza, 
             coalesce((select substr(max(movibanco.beneficiario),1,30)
                from movibanco, tipomovibanco tm
                where movibanco.no_cuenta=b.no_cuenta and
                      movibanco.polizaid=p.polizaid and
                      tm.tipomovibancoid=movibanco.tipomovibancoid),'Poliza') as descritipomovibanco,
             coalesce((select max(movibanco.referenciamovi)
                from movibanco 
               where movibanco.no_cuenta=b.no_cuenta and
                     movibanco.polizaid=p.polizaid),' ') as referenciamovi,
             0 as saldoi, m.debe, m.haber,0 as saldof, p.seriepoliza, p.numero_poliza, p.tipo_poliza, substr(p.concepto_poliza,1,50),m.referencia_mov as referenciamovipoliza,m.descripcion as descrimovi
        from polizas p, movipolizas m, bancos b
       where b.no_cuenta = pno_cuenta and             
             p.fechapoliza between pfechai and pfechaf and
             m.polizaid = p.polizaid and
             m.cuentaid = b.cuentaid 
    order by p.fechapoliza
     
    loop

    
      r.idorden :=1;
      r.saldoi := round(fsaldoinicial,2);
      r.saldof := round(fsaldoinicial + r.debe - r.haber,2);

      if r.referenciamovipoliza <> '' then
        r.referenciamovi=r.referenciamovipoliza;
      end if;

      fcargos := fcargos + r.debe;
      fabonos := fabonos + r.haber;

      return next r;

    end loop;
   

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.edobanco(character, date, date) OWNER TO sistema;

--
-- Name: edocuenta(character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION edocuenta(character, date) RETURNS SETOF restadocta
    AS $_$
declare
  preferenciaprestamo alias for $1;
  pfechacorte         alias for $2;

  r restadocta%rowtype;

  fimporte    numeric;
  fcapital    numeric;
  finteres    numeric;
  fmoratorio  numeric;
  fiva        numeric;
  ftotal      numeric;

  l record;

  pprestamoid int4;

  dfechapoliza date;
  sseriepoliza char(2);
  lnumero_poliza int4;
  lreferenciamovi int4;
  fmontoprestamo numeric;

  dfecha_otorga date;
  fsaldoinicial numeric;
begin

  select prestamoid,montoprestamo into pprestamoid,fsaldoinicial
   from prestamos where referenciaprestamo=preferenciaprestamo;

  fimporte    :=0;
  fcapital    :=0;
  finteres    :=0;
  fmoratorio  :=0;
  fiva        :=0;
  ftotal      :=0;


  select p.fechapoliza,p.seriepoliza,p.numero_poliza,
         0,mp.haber 
    into dfechapoliza, sseriepoliza, lnumero_poliza,
         lreferenciamovi, fmontoprestamo
    from movibanco m,polizas p, movipolizas mp
   where m.prestamoid=pprestamoid and
         p.polizaid=m.polizaid and
         mp.movipolizaid=m.movipolizaid;
  if FOUND then
    --r.fecha := dfechapoliza;
    --r.serie := sseriepoliza;
    --r.nopoliza := lnumero_poliza;
    --r.referenciacaja := lreferenciamovi;
    --r.monto_prestamo := fmontoprestamo;
    --return next r;
  else

    select p.fechapoliza,p.seriepoliza,p.numero_poliza,
           m.referenciacaja,mp.haber
      into dfechapoliza, sseriepoliza, lnumero_poliza,
           lreferenciamovi, fmontoprestamo
      from movicaja m,polizas p, movipolizas mp
     where m.prestamoid=pprestamoid and
           p.polizaid=m.polizaid and
           mp.movipolizaid=m.movipolizaid and
           mp.haber>0;

    if FOUND then
      --r.fecha := dfechapoliza;
      --r.serie := sseriepoliza;
      --r.nopoliza := lnumero_poliza;
      --r.referenciacaja := lreferenciamovi;
      --r.monto_prestamo := fmontoprestamo;
      --return next r;
    else
      -- Regresar el monto por que no se encontro el movimiento
      -- ni en bancos ni en movicaja
      select montoprestamo,fecha_otorga
        into fmontoprestamo,dfecha_otorga
        from prestamos
       where referenciaprestamo=preferenciaprestamo;             

      --r.fecha := dfecha_otorga;
      --r.serie := 'Z';
      --r.nopoliza := 0;
      --r.referenciacaja := 0;
      --r.monto_prestamo := fmontoprestamo;
      --return next r;

    end if;


  end if;

  for l in
    select p.fechapoliza,p.seriepoliza,p.numero_poliza,
           m.referenciacaja,
           m.polizaid,t.cuentaactivo,t.cuentaintnormal,t.cuentaintmora,t.cuentaiva
      from movicaja m, prestamos pr, tipoprestamo t, polizas p
     where m.prestamoid = pprestamoid and
           pr.prestamoid =  m.prestamoid and
           t.tipoprestamoid = pr.tipoprestamoid and
           p.polizaid = m.polizaid and
           p.fechapoliza < pfechacorte+1
   order by p.fechapoliza
           
  loop

    select coalesce(sum(haber-debe),0) into fcapital
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentaactivo and debe=0;
    select coalesce(sum(haber-debe),0) into finteres
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentaintnormal;
    select coalesce(sum(haber-debe),0) into fmoratorio
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentaintmora;
    select coalesce(sum(haber-debe),0) into fiva
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentaiva;

    if fcapital+finteres+fmoratorio+fiva <> 0 then 

       r.fecha := l.fechapoliza;
       r.serie := l.seriepoliza;
       r.nopoliza := l.numero_poliza;
       r.referenciacaja := l.referenciacaja;
       r.monto_prestamo := 0;
       r.capital := coalesce(fcapital,0);
       r.interes := coalesce(finteres,0);
       r.moratorio := coalesce(fmoratorio,0);
       r.iva := coalesce(fiva,0);
       r.total := r.capital + r.interes + r.moratorio + r.iva;
       r.saldoinicial := fsaldoinicial;
       r.saldofinal := fsaldoinicial-r.capital;
       fsaldoinicial:= fsaldoinicial-r.capital;

       return next r;

    end if;
    
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.edocuenta(character, date) OWNER TO sistema;

--
-- Name: edocuenta(character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION edocuenta(character, character, date) RETURNS SETOF restadocta
    AS $_$
declare
  pclavesocioint      alias for $1;
  preferenciaprestamo alias for $2;
  pfechacorte         alias for $3;

  r restadocta%rowtype;

  fimporte    numeric;
  fcapital    numeric;
  finteres    numeric;
  fmoratorio  numeric;
  fiva        numeric;
  ftotal      numeric;

  l record;

  pprestamoid int4;

  dfechapoliza date;
  sseriepoliza char(2);
  lnumero_poliza int4;
  lreferenciamovi int4;
  fmontoprestamo numeric;

  dfecha_otorga date;
begin

  select prestamoid into pprestamoid
   from prestamos where referenciaprestamo=preferenciaprestamo;

  fimporte    :=0;
  fcapital    :=0;
  finteres    :=0;
  fmoratorio  :=0;
  fiva        :=0;
  ftotal      :=0;

raise notice 'Prestamoid = %',pprestamoid;

  select p.fechapoliza,p.seriepoliza,p.numero_poliza,
         cast(substr(referenciamovi,4) as int4),mp.haber
    into dfechapoliza, sseriepoliza, lnumero_poliza,
         lreferenciamovi, fmontoprestamo
    from movibanco m,polizas p, movipolizas mp, tipoprestamo t, prestamos pr
   where pr.prestamoid=pprestamoid and
         m.prestamoid=pprestamoid and
         p.polizaid=m.polizaid and
         mp.polizaid=p.polizaid and
         t.tipoprestamoid=pr.tipoprestamoid and
         mp.cuentaid = t.cuentaactivo and
         mp.haber>0;

  if FOUND then
    r.fecha := dfechapoliza;
    r.serie := sseriepoliza;
    r.nopoliza := lnumero_poliza;
    r.referenciacaja := lreferenciamovi;
    r.monto_prestamo := fmontoprestamo;
    return next r;
  else

    select p.fechapoliza,p.seriepoliza,p.numero_poliza,
           m.referenciacaja,mp.haber
      into dfechapoliza, sseriepoliza, lnumero_poliza,
           lreferenciamovi, fmontoprestamo
      from movicaja m,polizas p, movipolizas mp
     where m.prestamoid=pprestamoid and
           p.polizaid=m.polizaid and
           mp.movipolizaid=m.movipolizaid and
           mp.haber>0;

    if FOUND then
      r.fecha := dfechapoliza;
      r.serie := sseriepoliza;
      r.nopoliza := lnumero_poliza;
      r.referenciacaja := lreferenciamovi;
      r.monto_prestamo := fmontoprestamo;
      return next r;
    else
      -- Regresar el monto por que no se encontro el movimiento
      -- ni en bancos ni en movicaja
      select montoprestamo,fecha_otorga
        into fmontoprestamo,dfecha_otorga
        from prestamos
       where referenciaprestamo=preferenciaprestamo;             

      r.fecha := dfecha_otorga;
      r.serie := 'Z';
      r.nopoliza := 0;
      r.referenciacaja := 0;
      r.monto_prestamo := fmontoprestamo;
      return next r;

    end if;


  end if;



  for l in
    select p.fechapoliza,p.seriepoliza,p.numero_poliza,
           m.referenciacaja,
           m.polizaid,t.cuentaactivo,t.cuentaintnormal,t.cuentaintmora,t.cuentaiva
      from movicaja m, prestamos pr, tipoprestamo t, polizas p
     where m.prestamoid = pprestamoid and
           pr.prestamoid =  m.prestamoid and
           t.tipoprestamoid = pr.tipoprestamoid and
           p.polizaid = m.polizaid and
           p.fechapoliza < pfechacorte+1
    order by p.fechapoliza
           
  loop

    select sum(coalesce(haber-debe,0)) into fcapital
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentaactivo and debe=0;
    select sum(coalesce(haber-debe,0)) into finteres
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentaintnormal;
    select sum(coalesce(haber-debe,0)) into fmoratorio
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentaintmora;
    select sum(coalesce(haber-debe,0)) into fiva
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentaiva;

    r.fecha := l.fechapoliza;
    r.serie := l.seriepoliza;
    r.nopoliza := l.numero_poliza;
    r.referenciacaja := l.referenciacaja;
    r.monto_prestamo := 0;
    r.capital := coalesce(fcapital,0);
    r.interes := coalesce(finteres,0);
    r.moratorio := coalesce(fmoratorio,0);
    r.iva := coalesce(fiva,0);
    r.total := r.capital + r.interes + r.moratorio + r.iva;

    return next r;
    
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.edocuenta(character, character, date) OWNER TO sistema;

--
-- Name: eliminapolizaimportada(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION eliminapolizaimportada(integer) RETURNS integer
    AS $_$
declare
  ppolizaid alias for $1;

  pmovicajaid int4;
 
  pejercicio int4;
  pperiodo int4;

begin

  select ejercicio,periodo
    into pejercicio,pperiodo
    from polizas
   where polizaid = ppolizaid;

   if periodovalido(pejercicio,pperiodo)=0 then
     raise exception 'El periodo % del Ejercicio % se encuentra CERRADO !!!',pperiodo,pejercicio;
   end if;

  select movicajaid
    into pmovicajaid
    from movicaja
   where polizaid=ppolizaid;
 
  if not FOUND then

    delete from movibanco where polizaid=ppolizaid;
    delete from movipolizas where polizaid=ppolizaid;
    delete from logpoliza where polizaid=ppolizaid;
    delete from polizas where polizaid=ppolizaid;

  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.eliminapolizaimportada(integer) OWNER TO sistema;

--
-- Name: encabezado(text, text, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION encabezado(text, text, integer) RETURNS text
    AS $_$
declare

 stitulo alias for $1;
 sorden  alias for $2;
 inopag  alias for $3;

 stexto text;

begin

 select chr(18)||nombrecaja||'    Suc. '||sucid||nombresucursal||chr(13)||chr(10)||
        'REPORTE :'||stitulo||chr(13)||chr(10)||
        'Ordenado por : '||sorden||' Fecha de Impresin: '||to_char(current_timestamp,'dd-mm-yyyy hh:mi')||'    Num. de Pag.: '||to_char(inopag,'999')||chr(13)||chr(10)
   into stexto
        
   from empresa
  where empresaid=1;


return stexto;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.encabezado(text, text, integer) OWNER TO sistema;

--
-- Name: esgarantia(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION esgarantia(integer) RETURNS integer
    AS $_$
declare

  pinversionid alias for $1;

  lsocioid int4;
  fmonto numeric;

  fmontoinversion numeric;
  fmontoprestamos numeric;

  preturn int;

begin

  select socioid,depositoinversion
    into lsocioid,fmonto
    from inversion
   where inversionid=pinversionid;

  select sum(montoprestamo)
    into fmontoprestamos
    from prestamos
   where socioid=lsocioid and
         claveestadocredito<>'002' and
         claveestadocredito<>'008' and
         clavegarantia='07 ';

  fmontoprestamos:=coalesce(fmontoprestamos,0);
raise notice 'Prestamos %',fmontoprestamos;

  select sum(depositoinversion-retiroinversion)
    into fmontoinversion
    from inversion
   where socioid=lsocioid and
         retiroinversion=0;

  fmontoinversion:=coalesce(fmontoinversion,0);
  raise notice 'Inversion %',fmontoinversion;

  preturn:=0;
  if fmontoinversion>0 and fmontoinversion>0 and fmontoprestamos>0 then
    if fmontoinversion-fmonto<fmontoprestamos then
      preturn := 1;
    else
      preturn := 0;
    end if;
  end if;

return preturn;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.esgarantia(integer) OWNER TO sistema;

--
-- Name: estadistico(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION estadistico(integer) RETURNS SETOF restadistico
    AS $_$
declare

  r restadistico%rowtype;
  psocioid alias for $1;

  m record;

  inoprestamos int4;
  dfechaultprestamo date;
  icumplimiento int4;
  sobservacion char(255);
begin

  inoprestamos :=0;

  select fecha_otorga
    into dfechaultprestamo
    from prestamos
   where socioid=psocioid;

  icumplimiento := 0;


  for m in

select prestamoid,fecha_otorga,fecha_vencimiento,fechaultimopago,claveestadocredito
  from prestamos
 where socioid=psocioid

  loop

    inoprestamos:=inoprestamos+1;

    if m.claveestadocredito='002' and icumplimiento=0 then
      if m.fechaultimopago>m.fecha_vencimiento then
        icumplimiento:=1;
      end if;
    end if;
    if m.claveestadocredito not in ('002','008') then
      icumplimiento:=2;
    end if;
    
  end loop;

  r.noprestamos := inoprestamos;
  r.fechaultprestamo := dfechaultprestamo;
  r.cumplimiento := icumplimiento;
  r.observacion  := '  ';

  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.estadistico(integer) OWNER TO sistema;

--
-- Name: estadisticoporsexo(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION estadisticoporsexo(date) RETURNS SETOF restadisticoporsexo
    AS $_$
declare  
  r restadisticoporsexo%rowtype;
  pfechac alias for $1;

  f record;

begin

   for r in

     select e.sucid,substring(e.nombrecaja,1,80),sum((case when si.sexo = 1 then 1 else 0 end)) as  mujer,sum((case when si.sexo <> 1 then 1 else 0 end)) as  hombre, '--' as tipomovimientoid, 'SOCIOS TOTALES REGISTRADOS' from empresa e, socio s, solicitudingreso si where (s.estatussocio=1 or s.estatussocio=3 or fechabaja > pfechac) and fechaalta <= pfechac  and s.socioid=si.socioid group by e.sucid,substring(e.nombrecaja,1,80)
  
   loop
        return next r;
   end loop;

   for r in

   select e.sucid,substring(e.nombrecaja,1,80),sum((case when si.sexo = 1 then 1 else 0 end)) as  mujer,sum((case when si.sexo = 0 then 1 else 0 end)) as  hombre,sd.tipomovimientoid,tm.desctipomovimiento from empresa e, solicitudingreso si, socio s,

        (select mc.socioid,mc.tipomovimientoid,sum(mp.debe)-sum(mp.haber) as saldo, 0 as saldoprestamo ,0 as prestamoid from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p, solicitudingreso si where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid not in ('00','AP','CI','IV','IP') and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' and mc.socioid=si.socioid group by mc.socioid,mc.tipomovimientoid having sum(mp.debe)-sum(mp.haber) > 0 union 
        
         select p.socioid,'00' as tipomovimientoid,0 as saldo,p.montoprestamo-SUM(case when m.cuentaid=tp.cuentaactivo and po.fechapoliza<pfechac+1 then m.haber else 0 end) as saldoprestamo,p.prestamoid from prestamos p left join movicaja mc on p.prestamoid=mc.prestamoid left join polizas po on mc.polizaid = po.polizaid left join movipolizas m on po.polizaid=m.polizaid,tipoprestamo tp where p.fecha_otorga < pfechac+1 and p.claveestadocredito<>'008' and tp.tipoprestamoid = p.tipoprestamoid group by p.socioid,p.montoprestamo,p.prestamoid) sd, tipomovimiento tm

        where s.socioid=si.socioid and s.socioid=sd.socioid and sd.tipomovimientoid=tm.tipomovimientoid

        group by e.sucid,e.nombrecaja,sd.tipomovimientoid,tm.desctipomovimiento 

        loop
             return next r;
        end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.estadisticoporsexo(date) OWNER TO sistema;

--
-- Name: estadisticoporsexoc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION estadisticoporsexoc(date) RETURNS SETOF restadisticoporsexo
    AS $_$
declare  
  r restadisticoporsexo%rowtype;
  pfechai alias for $1;
--  pfechaf alias for $2;

-- contador numeric;

begin

 raise notice 'Conectando sucursal polo 1';
 -- Etzatlan
 for r in
   SELECT * FROM
        dblink('host=localhost dbname=polo1 user=sistema',
               'set search_path to public,sucursal1;select * from estadisticoporsexo('||''''||pfechai||''''||');') as
               t2(
  sucid          char(4),
 nombrecaja     varchar(80),
 mujer          integer,
 hombre         integer,
 tipomov        char(2),
 desctipomov    char(30))

 loop
   return next r;
 end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.estadisticoporsexoc(date) OWNER TO sistema;

--
-- Name: estadocivil(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION estadocivil(integer) RETURNS text
    AS $_$
declare
pestadocivil alias for $1;

ptexto text;

begin
  
  if pestadocivil=0 then
    ptexto := 'SOLTERO(A)    ';
  end if;
  if pestadocivil=1 then
    ptexto := 'CASADO(A)   ';
  end if;
    if pestadocivil=2 then
    ptexto := 'DIVORCIADO(A)     ';
  end if;
  if pestadocivil=3 then
    ptexto := 'VIUDO(A) ';
  end if;
  if pestadocivil=4 then
    ptexto := 'UNION LIBRE    ';
  end if;

  return ptexto;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.estadocivil(integer) OWNER TO sistema;

--
-- Name: estadocuenta(character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION estadocuenta(character, character, date) RETURNS SETOF redocta
    AS $_$
declare
  pclavesocioint      alias for $1;
  preferenciaprestamo alias for $2;
  pfechacorte         alias for $3;

  r redocta%rowtype;

  fimporte    numeric;
  fcapital    numeric;
  finteres    numeric;
  fmoratorio  numeric;
  fiva        numeric;
  ftotal      numeric;


  pprestamoid int4;
begin

  select prestamoid into pprestamoid
   from prestamos where referenciaprestamo=preferenciaprestamo;

  fimporte    :=0;
  fcapital    :=0;
  finteres    :=0;
  fmoratorio  :=0;
  fiva        :=0;
  ftotal      :=0;


  for r in
select 0 as numamortizacion, po.fechapoliza as fechadepago, po.fechapoliza as ultimoabono,
        0 as importeamortizacion,
       (select coalesce(sum(haber),0)
          from movipolizas 
         where movipolizas.polizaid=mc.polizaid and 
               movipolizas.cuentaid = tp.cuentaactivo) as capital,
       (select coalesce(sum(haber),0)
          from movipolizas 
         where movipolizas.polizaid=mc.polizaid and 
               movipolizas.cuentaid = tp.cuentaintnormal) as interes,
      (select coalesce(sum(haber),0)
          from movipolizas 
         where movipolizas.polizaid=mc.polizaid and 
               movipolizas.cuentaid = tp.cuentaintmora) as moratorio,               
      (select coalesce(sum(haber),0)
          from movipolizas 
         where movipolizas.polizaid=mc.polizaid and 
               movipolizas.cuentaid = tp.cuentaiva) as iva,
       0 as total
  from movicaja mc, prestamos p, polizas po, tipoprestamo tp
 where mc.prestamoid=pprestamoid and
       p.prestamoid = mc.prestamoid and
       tp.tipoprestamoid = p.tipoprestamoid and
       po.polizaid = mc.polizaid
order by po.fechapoliza

  loop
    r.total := r.capital + r.interes + r.moratorio + r.iva;

    fcapital    :=fcapital   +r.capital;
    finteres    :=finteres   +r.interes;
    fmoratorio  :=fmoratorio +r.moratorio;           
    fiva        :=fiva       +r.iva;                 
    ftotal      :=ftotal     +r.total;     
    if ftotal>0 then
      return next r;
    end if;
  end loop;


  for r in
    select a.numamortizacion,a.fechadepago as fechadepago, a.fechadepago as ultimoabono,a.importeamortizacion, 
          0 as capital, 0 as interes, 0 as moratorio, 0 as iva, 0 as total
      from prestamos p, amortizaciones a
     where p.referenciaprestamo=preferenciaprestamo and
           a.prestamoid = p.prestamoid
   order by a.numamortizacion
  loop
    fimporte    :=fimporte   +r.importeamortizacion; 
          
    return next r;
  end loop;

  r.importeamortizacion :=fimporte   ;
  r.capital             :=fcapital   ;
  r.interes             :=finteres  ; 
  r.moratorio           :=fmoratorio ;           
  r.iva                 :=fiva       ;                 
  r.total               :=ftotal     ;

  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.estadocuenta(character, character, date) OWNER TO sistema;

--
-- Name: estadocuentainversion(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION estadocuentainversion(integer, date) RETURNS SETOF redoctainversion
    AS $_$
declare
  pinversionid  alias for $1;
  pfechacorte   alias for $2;

  r redoctainversion%rowtype;

  fimporte    numeric;
  fcapital    numeric;
  finteres    numeric;
  fisr        numeric;
  ftotal      numeric;
  dvencimiento date;
  fdepositoinversion numeric;
  dfechaproxpago date;
  isocioid  integer;

begin

  fimporte    :=0;
  fcapital    :=0;
  finteres    :=0;
  fisr        :=0; 
  ftotal      :=0;

  select depositoinversion,fechavencimiento,fechapagoinversion+30,socioid into fdepositoinversion,dvencimiento,dfechaproxpago,isocioid from inversion where inversionid=pinversionid;

  for r in
       select '',i.inversionid,s.clavesocioint,po.fechapoliza,

       (select coalesce(sum(haber-debe),0)
          from movipolizas 
         where movipolizas.polizaid=mc.polizaid and 
               movipolizas.cuentaid = ti.cuentapasivo) as capital,
       (select coalesce(sum(debe),0)
          from movipolizas 
         where movipolizas.polizaid=mc.polizaid and 
               movipolizas.cuentaid = ti.cuentaintinver) as interes,
       (select coalesce(sum(haber),0)
          from movipolizas 
         where movipolizas.polizaid=mc.polizaid and 
               movipolizas.cuentaid = ti.cuentariesgocred) as isr,
       null,null,null
  from movicaja mc, inversion i, polizas po, tipoinversion ti, socio s
 where mc.inversionid=pinversionid and
       i.inversionid = mc.inversionid and
       ti.tipoinversionid = i.tipoinversionid and
       po.polizaid = mc.polizaid and 
       i.socioid=s.socioid

 order by po.fechapoliza,mc.polizaid

  loop
       
    r.tipomov   :='MOVIM';
    fcapital    :=fcapital   +r.capital;
    finteres    :=finteres   +r.interes;
    fisr        :=fisr       +r.isr;
    ftotal      :=r.capital + r.interes + r.isr;

    if ftotal<>0 then
      return next r;
    end if;

  end loop;

  if fcapital > 0 then
      r.tipomov :='PINTE';
      r.capital :=0;
      r.interes :=0;
      r.isr     :=0;
      r.proxfechainteres:=dfechaproxpago;
      select isrinversionmes into r.proxisr from isrinversionmes(pinversionid);
      select round(interesgeneradoinversion,2) into r.proxinteres from interesgeneradoinversion(pinversionid); 
      --r.proxfechainteres:=dfechaproxpago;
      return next r;

  end if;

  r.tipomov             :='TOTAL';
  r.capital             :=fcapital   ;
  r.interes             :=finteres  ;    
  r.isr                 :=fisr;

  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.estadocuentainversion(integer, date) OWNER TO sistema;

--
-- Name: estatusconoceclientec(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION estatusconoceclientec(character) RETURNS SETOF rstatusconocecliente
    AS $_$
declare
 tipo alias for $1;

 r rstatusconocecliente%rowtype;
 f record;
 dblink1 text;
 dblink2 text;

begin
 for f in
   SELECT *from sucursales where vigente='S'   
 loop
     raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

     dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
     dblink2:='set search_path to public,'||f.esquema||'; select trim(clavesocioint) from socio s,conoceatucliente c where s.socioid=c.socioid and c.estatus='''||tipo||''';';
     for r in
      SELECT * FROM
        dblink(dblink1,dblink2) as t2 (socioid char(15))
     loop
       return next r;
     end loop;
 end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.estatusconoceclientec(character) OWNER TO sistema;

--
-- Name: existeciudad(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION existeciudad(integer) RETURNS integer
    AS $_$
declare
  pciudadmexid alias for $1;
  pciudadmexidn int4;
begin

  select ciudadmexid into pciudadmexidn from ciudadesmex where ciudadmexid=pciudadmexid;
  
  pciudadmexidn:= coalesce(pciudadmexidn,14);

return pciudadmexidn;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.existeciudad(integer) OWNER TO sistema;

--
-- Name: faplicapagos(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION faplicapagos() RETURNS integer
    AS $$
declare
  r record;
  i int4;
begin

  for r in
SELECT p.prestamoid,p.referenciaprestamo,p.montoprestamo-p.saldoprestamo as totalpagado,
       sum(a.abonopagado),max(a.ultimoabono) as ultimoabono
 FROM prestamos p, amortizaciones a
WHERE a.prestamoid=p.prestamoid
group by p.prestamoid,p.referenciaprestamo,p.montoprestamo,p.saldoprestamo
having p.montoprestamo-p.saldoprestamo<>sum(a.abonopagado)
 loop

   delete from amortizaciones where prestamoid = r.prestamoid;
   select * into i
     from generaramortizaciones(r.referenciaprestamo,r.totalpagado,r.ultimoabono); 

 end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.faplicapagos() OWNER TO sistema;

--
-- Name: fcolonia(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fcolonia() RETURNS integer
    AS $$
declare
  r colonia%rowtype;

  lciudadmexid int4;
begin


    for r in
      select * from colonia order by coloniaid
    loop

      select c.ciudadmexid
        into lciudadmexid
        from ciudadesmex c, cptmp cp
       where cp.d_asenta = r.nombrecolonia and
             c.nombreciudadmex = cp.d_ciudad and
             c.estadomexid = to_number(cp.c_estado,'99');

      update colonia
         set ciudadmexid = lciudadmexid
       where coloniaid=r.coloniaid;

      raise notice 'Actualizando %',r.coloniaid;

    end loop;


return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fcolonia() OWNER TO sistema;

--
-- Name: fdepre(integer, date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fdepre(integer, date, date) RETURNS numeric
    AS $_$
declare
  pactivoid alias for $1;
  pfecha1 alias for $2;
  pfecha2 alias for $3;

  udi1 numeric;
  udi2 numeric;

  factivo_valor numeric;
  fdepacum numeric;
  dfeciniciodepfiscal date;

  fdepact numeric;

begin

  select valor into udi1 from udis where fecha=pfecha1;

  if pfecha2<'31-05-2006' then
    select valor into udi2 from udis where fecha='31-05-2006';

    select (case when (case when '2006-05-31'<feciniciodepfiscal then 0
                     else meses(feciniciodepfiscal,'2006-05-31') end)>(100/((activotasaconta/100)/12*100)) 
           then activo_valor
           else (case when '2006-05-31'<feciniciodepfiscal then 0
        else meses(feciniciodepfiscal,'2006-05-31') end)*(case when (case when '2006-05-31'<feciniciodepfiscal then 0
                   else meses(feciniciodepfiscal,'2006-05-31') end)>(100/((activotasaconta/100)/12*100)) then 0
             else 
   trunc(activo_valor/(100/((activotasaconta/100)/12*100)),2)*(case when (case when '2006-05-31'<feciniciodepfiscal then 0
        else meses(feciniciodepfiscal,'2006-05-31') end)<1 then 0 else 1 end ) end)
           end), activo, feciniciodepfiscal 
      into fdepacum,factivo_valor, dfeciniciodepfiscal
      from activos, udis
     where activoid = pactivoid and
           fecha = feciniciodepfiscal;

-- Tomamos el valor del activo a la fecha del 31 de mayo - la depreciacin acumulada
     factivo_valor := factivo_valor - fdepacum;

  else
    select valor into udi2 from udis where fecha=pfecha2;
    select activo_valor
      into factivo_valor
      from activos
     where activoid=pactivoid;

  end if;

  if udi1<=udi2 then
    return 0;
  end if; 

--  if dfeciniciodepfiscal<'01-05-2006' then
--    dfeciniciodepfiscal := '31-05-2006';
--  end if;
        

  select
        (case when (case when pfecha1<feciniciodepfiscal then 0
                   else meses(feciniciodepfiscal,pfecha1) end)>(100/((activotasaconta/100)/12*100)) then 0
             else 
         trunc(activo_valor/(100/((activotasaconta/100)/12*100)),2)*(case when (case when pfecha1<feciniciodepfiscal then 0
        else meses(feciniciodepfiscal,pfecha1) end)<1 then 0 else 1 end ) end)*(udi(pfecha1)/udi(pfecha2)-1) as depmensual062006

  into fdepact
  from activos
 where activoid=pactivoid;

return fdepact;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fdepre(integer, date, date) OWNER TO sistema;

--
-- Name: fechabalance(integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fechabalance(integer, integer, integer, integer) RETURNS SETOF rrpbalance
    AS $_$
declare

  pejercicio   alias for $1;
  pperiodo     alias for $2;
  pconsolidado alias for $3;
  pmiles       alias for $4;

  sconsolida char(1);
  r rrpbalance%rowtype;

  daytab numeric[2][12]:=array[[31,28,31,30,31,30,31,31,30,31,30,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31]];
  mestab varchar[13]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE',
                            'DICIEMBRE'];

  pfecha date;

begin

  select cast(to_char(pejercicio,'9999')||'-'||trim(to_char(pperiodo,'99'))||'-'||trim(to_char(daytab[1][pperiodo],'99')) as date)
    into pfecha;

  raise notice 'Fecha %',pfecha;
 
  -- Pendiente validar ao bisiesto
  if pconsolidado=1 then
   r.rubro1:='BALANCE GENERAL CONSOLIDADO AL'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
   else
   r.rubro1:='BALANCE GENERAL AL'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  end if;
 -- r.rubro2:=NULL;
 -- r.t1 := NULL;
 -- r.t2 := NULL;
 -- r.t3 := NULL;
 -- r.t4 := NULL;
  return next r;  

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fechabalance(integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: fechacambios(integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fechacambios(integer, integer, integer, integer) RETURNS SETOF rrpbalance
    AS $_$
declare

  pejercicio   alias for $1;
  pperiodo     alias for $2;
  pconsolidado alias for $3;
  pmiles       alias for $4;

  sconsolida char(1);
  r rrpbalance%rowtype;

  daytab numeric[2][12]:=array[[31,28,31,30,31,30,31,31,30,31,30,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31]];
  mestab varchar[13]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE',
                            'DICIEMBRE'];

  pfecha date;

begin

  select cast(to_char(pejercicio,'9999')||'-'||trim(to_char(pperiodo,'99'))||'-'||trim(to_char(daytab[1][pperiodo],'99')) as date)
    into pfecha;

  raise notice 'Fecha %',pfecha;
 
  -- Pendiente validar ao bisiesto
  if pconsolidado=1 then
   r.rubro1:='ESTADO DE VARIACIONES EN EL CAPITAL CONSOLIDADO DEL 01 DE ENERO AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
   else
   r.rubro1:='ESTADO DE VARIACIONES EN EL CAPITAL DEL 01 DE ENERO AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  end if;
 -- r.rubro2:=NULL;
 -- r.t1 := NULL;
 -- r.t2 := NULL;
 -- r.t3 := NULL;
 -- r.t4 := NULL;
  return next r;  

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fechacambios(integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: fechacobroiva(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fechacobroiva() RETURNS date
    AS $$
declare

  dfechacobroiva date;

begin

  select fechacobroiva
    into dfechacobroiva
    from empresa
   where empresaid=1;

return dfechacobroiva;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fechacobroiva() OWNER TO sistema;

--
-- Name: fechaletra(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fechaletra(date) RETURNS text
    AS $_$
declare
pfecha alias for $1;

ptexto text;

pmes char(2);
pdia char(2);
pano char(4);
psmes text;

begin

  pmes:=cast(date_part('month',pfecha) as char(2));
  pdia:=cast(date_part('day',pfecha) as char(2));
  pano:=cast(date_part('year',pfecha) as char(4));

  if pmes=1 then
    psmes := 'Enero     ';
  end if;
  if pmes=2 then
    psmes := 'Febrero   ';
  end if;
  if pmes=3 then
    psmes := 'Marzo     ';
  end if;
  if pmes=4 then
    psmes := 'Abril     ';
  end if;
  if pmes=5 then
    psmes := 'Mayo      ';
  end if;
  if pmes=6 then
    psmes := 'Junio     ';
  end if;
  if pmes=7 then
    psmes := 'Julio     ';
  end if;
  if pmes=8 then
    psmes := 'Agosto    ';
  end if;
  if pmes=9 then
    psmes := 'Septiembre';
  end if;
  if pmes=10 then
    psmes := 'Octubre   ';
  end if;
  if pmes=11 then
    psmes := 'Noviembre ';
  end if;
  if pmes=12 then
    psmes := 'Diciembre ';
  end if;

  ptexto:=pdia||' DE '||rtrim(upper(psmes))||' DE '||pano;


  return ptexto;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fechaletra(date) OWNER TO sistema;

--
-- Name: fecharesultados(integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fecharesultados(integer, integer, integer, integer) RETURNS SETOF rrpedores
    AS $_$
declare

  pejercicio   alias for $1;
  pperiodo     alias for $2;
  pconsolidado alias for $3;
  pmiles       alias for $4;

  sconsolida char(1);
  r rrpedores%rowtype;

  daytab numeric[2][12]:=array[[31,28,31,30,31,30,31,31,30,31,30,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31]];
  mestab varchar[12]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE'];
begin

-- Pendiente validar ao bisiesto
  r.rubro1:='DEL 01 DE ENERO AL'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  r.rubro2:='DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  
  if pmiles=1 then
    r.rubro3:='(CIFRAS EN MILES DE PESOS)';
  else
    r.rubro3:='(CIFRAS EN PESOS)';
  end if;
  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fecharesultados(integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: fechaultimapagada(integer, numeric, date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fechaultimapagada(integer, numeric, date, date) RETURNS date
    AS $_$
declare
  pprestamoid alias for $1;
  ppagado alias for $2;
  pfechacorte alias for $3;
  dfecha_1er_pago alias for $4;

  r record;
  dfecha date;
  faplicado numeric;

begin

    select fecha_otorga
      into dfecha
      from prestamos
     where prestamoid=pprestamoid;

  if dfecha_1er_pago<pfechacorte then

    if ppagado>0 then
      faplicado := ppagado;
      for r in
        select numamortizacion,importeamortizacion,fechadepago
          from amortizaciones
         where prestamoid=pprestamoid
        order by fechadepago
      loop
        if faplicado>=r.importeamortizacion then
          faplicado := faplicado - r.importeamortizacion;
          if r.fechadepago<=pfechacorte then
            dfecha := r.fechadepago;
--          else
--            dfecha := pfechacorte;
--            exit;
          end if;
        else         
          exit;
        end if;
      end loop;
  
    end if;

  --else
  --  dfecha := pfechacorte;
  end if;

  --if dfecha>pfechacorte then
  --  return pfechacorte;
  --end if;


return dfecha;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fechaultimapagada(integer, numeric, date, date) OWNER TO sistema;

--
-- Name: fechaultimapagada(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fechaultimapagada(integer, date) RETURNS date
    AS $_$
declare
  pprestamoid alias for $1;
  pfechacorte alias for $2;
 
  r record;
  dfecha date;
  faplicado numeric;
  finteres numeric;
  fcapital numeric;
 
begin

  select fecha_otorga
      into dfecha
      from prestamos
  where prestamoid=pprestamoid;

  select sum(case when m.cuentaid=t.cuentaactivo then m.haber else 0 end) as capital into fcapital from movicaja mc, movipolizas m, polizas p, prestamos pr,  tipoprestamo t where mc.prestamoid=pprestamoid and mc.tipomovimientoid='00' and pr.prestamoid = mc.prestamoid and t.tipoprestamoid = pr.tipoprestamoid and m.polizaid = mc.polizaid and m.polizaid=p.polizaid and p.fechapoliza <= pfechacorte;

  fcapital:=coalesce(fcapital,0);

  faplicado := fcapital;
  for r in
        select numamortizacion,importeamortizacion,fechadepago,interesnormal
          from amortizaciones
         where prestamoid=pprestamoid
        order by fechadepago
      loop
        if faplicado>=r.importeamortizacion then
          faplicado := faplicado - r.importeamortizacion;
          if r.fechadepago<=pfechacorte then
            dfecha := r.fechadepago;
          end if;
       end if;
  end loop;
  
return dfecha;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fechaultimapagada(integer, date) OWNER TO sistema;

--
-- Name: fechaultimoabono(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fechaultimoabono(integer) RETURNS date
    AS $_$
declare

lprestamoid alias for $1;
dultimoabono  date;
dfechaotorga  date;

begin

  select fecha_otorga into dfechaotorga from prestamos where prestamoid=lprestamoid;

  select max(p.fechapoliza)
     into dultimoabono
     from movicaja mc,polizas p, movipolizas m
    where mc.prestamoid = lprestamoid and             
          p.polizaid = mc.polizaid and
          m.movipolizaid = mc.movipolizaid and
          mc.estatusmovicaja='A' and
          mc.tipomovimientoid='00' and
          m.debe+m.haber>0;

   dultimoabono := coalesce(dultimoabono,dfechaotorga);

return dultimoabono;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fechaultimoabono(integer) OWNER TO sistema;

--
-- Name: fillavales(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fillavales(integer) RETURNS integer
    AS $_$
declare
  lprestamoid alias for $1;

  lsolicitudprestamoid int4;
begin

  select solicitudprestamoid into lsolicitudprestamoid
   from prestamos
   where prestamoid = lprestamoid;

  update avales
     set prestamoid = lprestamoid
   where solicitudprestamoid= lsolicitudprestamoid;


return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fillavales(integer) OWNER TO sistema;

--
-- Name: fillcolonias(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fillcolonias() RETURNS integer
    AS $$
declare
 
  r record;

begin

  for r in
    select c.ciudadmexid
      from ciudadesmex c
  group by c.ciudadmexid
    having (select count(co.*) 
              from colonia co 
             where co.ciudadmexid=c.ciudadmexid) =0


  loop
    insert into colonia(ciudadmexid,nombrecolonia)
     values (r.ciudadmexid,'NO ESPECIFICADA');
  end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fillcolonias() OWNER TO sistema;

--
-- Name: fillpermisos(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fillpermisos() RETURNS integer
    AS $$
declare
 
  x record;
  r record;
  i int4;
begin

  for x in
    select usuarioid from usuarios
  loop
    for r in
      select clavemodulo from modulos
       where clavemodulo not in (select clavemodulo
                                   from permisosmodulos
                                  where usuarioid=x.usuarioid)
    loop
      -- Insertar modulos faltantes al usuario
      select spipermisomodulo(r.clavemodulo,x.usuarioid,'N') into i;
    end loop;
  end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fillpermisos() OWNER TO sistema;

--
-- Name: fillsociopa(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fillsociopa() RETURNS integer
    AS $$
declare
  r record;


begin

    for r in

select p.polizaid, s.clavesocioint
  from polizas p, socio s, movicaja mo
 where exists (select m.polizaid from movicaja m where m.tipomovimientoid='PA' and  m.polizaid=p.polizaid) and
       mo.polizaid = p.polizaid and
       s.socioid = mo.socioid

    loop
      update polizas
         set concepto_poliza = '  Parte Social '||r.clavesocioint
       where polizaid=r.polizaid;

      update movipolizas
         set descripcion = 'Parte Social '||r.clavesocioint
       where polizaid=r.polizaid;
    
    end loop;
return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fillsociopa() OWNER TO sistema;

--
-- Name: finalidaddefault(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION finalidaddefault(character) RETURNS character
    AS $_$
declare

  ptipoprestamoid alias for $1;
  pdesctipoprestamo char(30);

begin

  select f.descripcionfinalidad into pdesctipoprestamo from tipoprestamo tp, finalidades f where tp.clavefinalidad=f.clavefinalidad and tp.tipoprestamoid=ptipoprestamoid;

  pdesctipoprestamo := coalesce(pdesctipoprestamo,'CONSUMO');

return pdesctipoprestamo;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.finalidaddefault(character) OWNER TO sistema;

--
-- Name: fnombresocio(text, text, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fnombresocio(text, text, text) RETURNS text
    AS $_$
declare
  pnombre  alias for $1;
  ppaterno alias for $2;
  pmaterno alias for $3;

  stext text;

begin

  stext:=pnombre||' '||ppaterno||' '||pmaterno;

return stext;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fnombresocio(text, text, text) OWNER TO sistema;

--
-- Name: formatocertificado(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatocertificado(integer) RETURNS text
    AS $_$
declare
  pinversionid alias for $1;

  pformato text;
  ptexto   text;

begin



   pformato := chr(27)||'E'||
               chr(18)||'Normal'||chr(13)||chr(10)||
               chr(27)||chr(71)||'Normal Negrita'||chr(13)||chr(10)||
               chr(27)||chr(72)||'Normal'||chr(13)||chr(10)||
               chr(15)||'Condensada'||chr(13)||chr(10)||
               chr(27)||chr(71)||'Condensada Negrita'||chr(13)||chr(10)||
               chr(27)||chr(72)||'Condensada'||chr(13)||chr(10)||
               chr(27)||'E'||chr(27)||'(s12HHello World'||chr(27)||'E'||
               chr(18)||'Normal'||chr(13)||chr(10);
      


return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatocertificado(integer) OWNER TO sistema;

--
-- Name: formatocheque(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatocheque(integer) RETURNS text
    AS $_$
declare
  pmovibancoid alias for $1;

  pformato text;
  ptexto   text;

  pmes int;
  psmes varchar;
  pdia char(2);
  pano char(4);

  dfecha date;
  pcuenta char(15);
  pbanco char(25);

  fmonto numeric;

  r record;

  ldebe  numeric;
  lhaber numeric;
  i integer;
  j integer;
begin

  select p.fechapoliza,m.no_cuenta into dfecha,pcuenta
    from movibanco m, polizas p
   where m.movibancoid = pmovibancoid and
         p.polizaid = m.polizaid;

  select haber 
    into fmonto
    from movibanco mb, movipolizas mp
   where mb.movibancoid = pmovibancoid and
         mp.movipolizaid = mb.movipolizaid;

  select b.banco into pbanco
    from bancos b, movibanco mb
   where mb.movibancoid = pmovibancoid and
         b.no_cuenta=mb.no_cuenta;
   
--  pbanco:=rtrim(pbanco);   

  pmes:=cast(date_part('month',dfecha) as int);
  pdia:=cast(date_part('day',dfecha) as char(2));
  pano:=cast(date_part('year',dfecha) as char(4));

  if pmes=1 then
    psmes := 'Enero     ';
  end if;
  if pmes=2 then
    psmes := 'Febrero   ';
  end if;
  if pmes=3 then
    psmes := 'Marzo     ';
  end if;
  if pmes=4 then
    psmes := 'Abril     ';
  end if;
  if pmes=5 then
    psmes := 'Mayo      ';
  end if;
  if pmes=6 then
    psmes := 'Junio     ';
  end if;
  if pmes=7 then
    psmes := 'Julio     ';
  end if;
  if pmes=8 then
    psmes := 'Agosto    ';
  end if;
  if pmes=9 then
    psmes := 'Septiembre';
  end if;
  if pmes=10 then
    psmes := 'Octubre   ';
  end if;
  if pmes=11 then
    psmes := 'Noviembre ';
  end if;
  if pmes=12 then
    psmes := 'Diciembre ';
  end if;

--- Banamex

 if rtrim(pbanco)='BANAMEX' then

  raise notice 'Formato Banamex';
  select chr(15)||chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         lpad(pdia||' de '||rtrim(psmes)||' del '||pano,110,' ')||chr(13)||chr(10)||
         chr(10)||chr(13)||
         rpad('                       '||m.beneficiario,90,' ')||'                   '||to_char(fmonto,'99,999,999.99')||
         chr(10)||chr(13)||chr(10)||chr(13)||
         rtrim(rpad('                       *'||cletra(fmonto),105,' '))||'**'||chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         '            Fecha: '||pdia||' de '||RTRIM(psmes)||' de '||pano||chr(13)||chr(10)||	 
         '         Concepto: '||substr(m.concepto,1, ( case when strpos(m.concepto,'Tasa')-1>0
                                                   then strpos(m.concepto,'Tasa')-1
                                                   else length(m.concepto) end ))||chr(13)||chr(10)||
         '           Cheque: '||m.referenciamovi||'  Poliza: '||ltrim(to_char(p.numero_poliza,'999999'))||chr(13)||chr(10)
    into pformato
    from movibanco m, polizas p
   where m.movibancoid = pmovibancoid and
         p.polizaid = m.polizaid;

   for i in 1..4
   loop
     pformato := pformato||chr(13)||chr(10);
   end loop;


   ptexto := '';
   ldebe  := 0;
   lhaber := 0;
   i := 0;

   for r in
     select c.cuentaid,c.cuentanombre,mp.debe,mp.haber
       from movibanco m, movipolizas mp, catalogo_ctas c
      where m.movibancoid = pmovibancoid and
            mp.polizaid = m.polizaid  and
            c.cuentaid = mp.cuentaid
   loop
     
     if r.haber=0 then
  	ptexto := ptexto||'          '||rpad(r.cuentaid,20,' ')||'  '||rpad(r.cuentanombre,51,' ')||'              '||to_char(r.debe,'9,999,999,999.99')||chr(13)||chr(10);
     else
  	ptexto := ptexto||'          '||rpad(r.cuentaid,20,' ')||'  '||rpad(r.cuentanombre,51,' ')||'                                '||to_char(r.haber,'9,999,999,999.99')||chr(13)||chr(10);
     end if;


     ldebe := ldebe + r.debe;
     lhaber := lhaber + r.haber;

     i := i+1;
   end loop;

   i := i-2;
   for j in 0..6-i
   loop
     ptexto := ptexto||chr(13)||chr(10);
   end loop;

   ptexto := ptexto||lpad(to_char(ldebe,'9,999,999,999.99'),115,'  ')||to_char(lhaber,'9,999,999,999.99')||chr(13)||chr(10)||
	     chr(13)||chr(10)||
             chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||	
             chr(13)||chr(10);

   pformato := pformato||ptexto;
 end if;
 
 
--- Bancomer

 if rtrim(pbanco)='BANCOMER' then

  raise notice 'Formato Bancomer';
  select chr(15)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||
         lpad(pdia||' de '||rtrim(psmes)||' del '||pano,111,' ')||chr(13)||chr(10)||
         chr(10)||chr(13)||chr(10)||chr(13)||    
         rpad('                       '||m.beneficiario,90,' ')||'                                                       '||to_char(fmonto,'99,999,999.99')||
         chr(13)||chr(10)||chr(10)||chr(13)|| 
         rtrim(rpad('                       ---'||cletra(fmonto),105,' '))||'---'||chr(13)||chr(10)||
         chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
         chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
	 chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||
         '             Fecha: '||pdia||' de '||RTRIM(psmes)||' de '||pano||chr(13)||chr(10)||	 
         '          Concepto: '||substr(m.concepto,1, ( case when strpos(m.concepto,'Tasa')-1>0
                                                   then strpos(m.concepto,'Tasa')-1
                                                   else length(m.concepto) end ))||chr(13)||chr(10)||
         '           Cheque: '||m.referenciamovi||'  Poliza: '||ltrim(to_char(p.numero_poliza,'999999'))||chr(13)||chr(10)
    into pformato
    from movibanco m, polizas p
   where m.movibancoid = pmovibancoid and
         p.polizaid = m.polizaid;

   for i in 1..6
   loop
     pformato := pformato||chr(13)||chr(10);
   end loop;


   ptexto := '';
   ldebe  := 0;
   lhaber := 0;
   i := 0;

   for r in
     select c.cuentaid,c.cuentanombre,mp.debe,mp.haber
       from movibanco m, movipolizas mp, catalogo_ctas c
      where m.movibancoid = pmovibancoid and
            mp.polizaid = m.polizaid  and
            c.cuentaid = mp.cuentaid
   loop
     
     if r.haber=0 then
  	ptexto := ptexto||'          '||rpad(r.cuentaid,30,' ')||'  '||rpad(r.cuentanombre,51,' ')||'                          '||to_char(r.debe,'9,999,999,999.99')||chr(13)||chr(10);
     else
  	ptexto := ptexto||'          '||rpad(r.cuentaid,30,' ')||'  '||rpad(r.cuentanombre,51,' ')||'                                              '||to_char(r.haber,'9,999,999,999.99')||chr(13)||chr(10);
     end if;


     ldebe := ldebe + r.debe;
     lhaber := lhaber + r.haber;

     i := i+1;
   end loop;

   i := i-2;
   for j in 0..29-i
   loop
     ptexto := ptexto||chr(13)||chr(10);
   end loop;

   ptexto := ptexto||lpad(to_char(ldebe,'9,999,999,999.99'),139,' ')||'   '||to_char(lhaber,'9,999,999,999.99')||
   chr(13)||chr(10)||
   chr(13)||chr(10)||
   chr(13)||chr(10);

   pformato := pformato||ptexto;
 end if; 
 

--- BANORTE

 if rtrim(pbanco)='BANORTE' then

  raise notice 'Formato BANORTE';
  select chr(15)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||
         lpad(pdia||' de '||rtrim(psmes)||' del '||pano,100,' ')||chr(13)||chr(10)||
         chr(10)||chr(13)||
         rpad('                       '||m.beneficiario,90,' ')||'        '||to_char(fmonto,'99,999,999.99')||
         chr(13)||chr(10)||
         rtrim(rpad('                       ---'||cletra(fmonto),105,' '))||'---'||chr(13)||chr(10)||
         chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
         chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
         '             Fecha: '||pdia||' de '||RTRIM(psmes)||' de '||pano||chr(13)||chr(10)||	 
         '          Concepto: '||substr(m.concepto,1, ( case when strpos(m.concepto,'Tasa')-1>0
                                                   then strpos(m.concepto,'Tasa')-1
                                                   else length(m.concepto) end ))||chr(13)||chr(10)||
         '            Cheque: '||m.referenciamovi||'  Poliza: '||ltrim(to_char(p.numero_poliza,'999999'))||chr(13)||chr(10)
    into pformato
    from movibanco m, polizas p
   where m.movibancoid = pmovibancoid and
         p.polizaid = m.polizaid;

   for i in 1..5
   loop
     pformato := pformato||chr(13)||chr(10);
   end loop;


   ptexto := '';
   ldebe  := 0;
   lhaber := 0;
   i := 0;

   for r in
     select c.cuentaid,c.cuentanombre,mp.debe,mp.haber
       from movibanco m, movipolizas mp, catalogo_ctas c
      where m.movibancoid = pmovibancoid and
            mp.polizaid = m.polizaid  and
            c.cuentaid = mp.cuentaid
   loop
     
     if r.haber=0 then
  	ptexto := ptexto||'          '||rpad(r.cuentaid,20,' ')||'  '||rpad(r.cuentanombre,51,' ')||'                  '||to_char(r.debe,'9,999,999,999.99')||chr(13)||chr(10);
     else
  	ptexto := ptexto||'          '||rpad(r.cuentaid,20,' ')||'  '||rpad(r.cuentanombre,51,' ')||'                                   '||to_char(r.haber,'9,999,999,999.99')||chr(13)||chr(10);
     end if;


     ldebe := ldebe + r.debe;
     lhaber := lhaber + r.haber;

     i := i+1;
   end loop;

   i := i-2;
   for j in 0..29-i
   loop
     ptexto := ptexto||chr(13)||chr(10);
   end loop;

   ptexto := ptexto||lpad(to_char(ldebe,'9,999,999,999.99'),118,' ')||to_char(lhaber,'9,999,999,999.99')||chr(13)||chr(10);

   pformato := pformato||ptexto;

 end if;  
 

--- HSBC

 if rtrim(pbanco)='HSBC' then

  raise notice 'Formato HSBC';
  select chr(15)||chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         lpad(pdia||' de '||rtrim(psmes)||' del '||pano,110,' ')||chr(13)||chr(10)||
         chr(10)||chr(13)||
         rpad('                       '||m.beneficiario,90,' ')||'                   '||to_char(fmonto,'99,999,999.99')||
         chr(13)||chr(10)||chr(10)||chr(13)|| 
         rtrim(rpad('                       *'||cletra(fmonto),105,' '))||'**'||chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(13)||chr(10)||
         chr(10)||chr(13)||
         chr(13)||chr(10)||
         chr(10)||chr(13)|| 
         chr(10)||chr(13)||
         '             Fecha: '||pdia||' de '||RTRIM(psmes)||' de '||pano||chr(13)||chr(10)||	 
         '          Concepto: '||substr(m.concepto,1, ( case when strpos(m.concepto,'Tasa')-1>0
                                                   then strpos(m.concepto,'Tasa')-1
                                                   else length(m.concepto) end ))||chr(13)||chr(10)||
         '            Cheque: '||m.referenciamovi||'  Poliza: '||ltrim(to_char(p.numero_poliza,'999999'))||chr(13)||chr(10)
    into pformato
    from movibanco m, polizas p
   where m.movibancoid = pmovibancoid and
         p.polizaid = m.polizaid;

   for i in 1..4
   loop
     pformato := pformato||chr(13)||chr(10);
   end loop;


   ptexto := '';
   ldebe  := 0;
   lhaber := 0;
   i := 0;

   for r in
     select c.cuentaid,c.cuentanombre,mp.debe,mp.haber
       from movibanco m, movipolizas mp, catalogo_ctas c
      where m.movibancoid = pmovibancoid and
            mp.polizaid = m.polizaid  and
            c.cuentaid = mp.cuentaid
   loop
     
     if r.haber=0 then
  	ptexto := ptexto||'          '||rpad(r.cuentaid,20,' ')||'  '||rpad(r.cuentanombre,51,' ')||'              '||to_char(r.debe,'9,999,999,999.99')||chr(13)||chr(10);
     else
  	ptexto := ptexto||'          '||rpad(r.cuentaid,20,' ')||'  '||rpad(r.cuentanombre,51,' ')||'                                '||to_char(r.haber,'9,999,999,999.99')||chr(13)||chr(10);
     end if;


     ldebe := ldebe + r.debe;
     lhaber := lhaber + r.haber;

     i := i+1;
   end loop;

   i := i-2;
   for j in 0..6-i
   loop
     ptexto := ptexto||chr(13)||chr(10);
   end loop;

   ptexto := ptexto||lpad(to_char(ldebe,'9,999,999,999.99'),115,' ')||to_char(lhaber,'9,999,999,999.99')||
             chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||
	     chr(13)||chr(10)||	     
             chr(13)||chr(10);

   pformato := pformato||ptexto;
 end if;  
 

return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatocheque(integer) OWNER TO sistema;

--
-- Name: formatocheque2(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatocheque2(integer) RETURNS text
    AS $_$
declare
  pmovibancoid alias for $1;

  pformato text;
  ptexto   text;

  pmes int;
  psmes varchar;
  pdia char(2);
  pano char(4);

  dfecha date;

  fmonto numeric;

  r record;

  ldebe  numeric;
  lhaber numeric;
  i integer;
  j integer;
begin

  select p.fechapoliza into dfecha
    from movibanco m, polizas p
   where m.movibancoid = pmovibancoid and
         p.polizaid = m.polizaid;

  select haber 
    into fmonto
    from movibanco mb, movipolizas mp
   where mb.movibancoid = pmovibancoid and
         mp.movipolizaid = mb.movipolizaid;

  pmes:=cast(date_part('month',dfecha) as int);
  pdia:=cast(date_part('day',dfecha) as char(2));
  pano:=cast(date_part('year',dfecha) as char(4));

  if pmes=1 then
    psmes := 'Enero     ';
  end if;
  if pmes=2 then
    psmes := 'Febrero   ';
  end if;
  if pmes=3 then
    psmes := 'Marzo     ';
  end if;
  if pmes=4 then
    psmes := 'Abril     ';
  end if;
  if pmes=5 then
    psmes := 'Mayo      ';
  end if;
  if pmes=6 then
    psmes := 'Junio     ';
  end if;
  if pmes=7 then
    psmes := 'Julio     ';
  end if;
  if pmes=8 then
    psmes := 'Agosto    ';
  end if;
  if pmes=9 then
    psmes := 'Septiembre';
  end if;
  if pmes=10 then
    psmes := 'Octubre   ';
  end if;
  if pmes=11 then
    psmes := 'Noviembre ';
  end if;
  if pmes=12 then
    psmes := 'Diciembre ';
  end if;

  select chr(15)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
                lpad(pdia||' de '||rtrim(psmes)||' de '||pano,105,' ')||chr(13)||chr(10)||
         chr(13)||chr(10)||
         rpad('                           '||m.beneficiario,80,' ')||''||to_char(fmonto,'99,999,999.99')||
         chr(13)||chr(10)||chr(13)||chr(10)||
         rpad('              '||cletra(fmonto),105,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
         '            '||substr(m.concepto,1, ( case when strpos(m.concepto,'Tasa')-1>0
                                                   then strpos(m.concepto,'Tasa')-1
                                                   else length(m.concepto) end ))||chr(13)||chr(10)||
         '            '||substr(m.concepto,strpos(m.concepto,'Tasa'))||chr(13)||chr(10)||
         '            '||pdia||' de '||psmes||' de '||pano||chr(13)||chr(10)||
         '            Cheque: '||m.referenciamovi||'  Poliza: '||to_char(p.numero_poliza,'999999')||chr(13)||chr(10)
    into pformato
    from movibanco m, polizas p
   where m.movibancoid = pmovibancoid and
         p.polizaid = m.polizaid;


   for i in 1..2
   loop
     pformato := pformato||chr(13)||chr(10);
   end loop;


   ptexto := '';
   ldebe  := 0;
   lhaber := 0;
   i := 0;

   for r in
     select c.cuentaid,c.cuentanombre,mp.debe,mp.haber
       from movibanco m, movipolizas mp, catalogo_ctas c
      where m.movibancoid = pmovibancoid and
            mp.polizaid = m.polizaid  and
            c.cuentaid = mp.cuentaid
   loop

     ptexto := ptexto||'             '||rpad(r.cuentaid,20,' ')||'    '||rpad(r.cuentanombre,61,' ')||to_char(r.debe,'9,999,999,999.99')||to_char(r.haber,'9,999,999,999.99')||chr(13)||chr(10);


     ldebe := ldebe + r.debe;
     lhaber := lhaber + r.haber;

     i := i+1;
   end loop;

   i := i-2;
   for j in 0..4-i
   loop
     ptexto := ptexto||chr(13)||chr(10);
   end loop;

   ptexto := ptexto||' '||chr(13)||chr(10)||lpad(to_char(ldebe,'9,999,999,999.99'),114,' ')||to_char(lhaber,'9,999,999,999.99')|| chr(13)||chr(10);

   pformato := pformato||ptexto;


return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatocheque2(integer) OWNER TO sistema;

--
-- Name: formatoinversion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatoinversion(integer) RETURNS text
    AS $_$
declare
  pinversionid alias for $1;
  pformato text;
  pbeneficiario text;
  ptexto text;
  sizq text;
  sizq2 text;

  snombrebeneficiario varchar; 
  sdomiciliobeneficiario varchar; 
  scomunidadbeneficiario  varchar;
  stelefonobeneficiario varchar; 
  snosociobeneficiario varchar;
  sporcentaje varchar;
  sclavesocioint char(15);
  idias int4;
  fisr numeric;

  pmes1        int;
  psmes1       varchar;
  pdia1        char(2);
  pano1        char(4);
  pfechainversion date;

  j int;

  m record;
begin

  sizq:='          ';
  sizq2:='                    ';

  snombrebeneficiario := '';  
  sdomiciliobeneficiario := ''; 
  scomunidadbeneficiario := '';
  stelefonobeneficiario := '';
  snosociobeneficiario := '';
  sporcentaje:='';

  j := 0;
  for m in

  select b.socioid,b.porcentajebeneficiario,
         s.nombre,s.paterno,s.materno,s.sujetoid,
         d.calle,d.numero_ext,d.colonia,d.teldomicilio
    from beneficiario b, sujeto s, domicilio d, inversion i 
   where i.inversionid=pinversionid and
         b.inversionid = i.inversionid and
         s.sujetoid = b.sujetoid and
         d.sujetoid = s.sujetoid

   loop

     if j<2 then
      -- Verificar si es socio
      if m.socioid IS NOT NULL then
        select clavesocioint
          into sclavesocioint
         from socio
         where socioid=m.socioid;
        snosociobeneficiario:=snosociobeneficiario||rpad(sclavesocioint,45,' ');
      else

        -- Cuando la referencia no es socio
       snosociobeneficiario:= snosociobeneficiario||rpad(to_char(m.sujetoid,'000000'),45,' ');
      end if;

      snombrebeneficiario:=snombrebeneficiario||rpad(' NOMBRE: '||m.nombre||' '||m.paterno||' '||m.materno,45,' ');
      sdomiciliobeneficiario:=sdomiciliobeneficiario||rpad(' DOMICILIO: '||'Calle '||m.calle||' No. '||m.numero_ext,45,' ');
      scomunidadbeneficiario:=scomunidadbeneficiario||rpad(' Col. '||m.colonia,45,' ');
      stelefonobeneficiario:=stelefonobeneficiario||rpad(' TELFONO: '||m.teldomicilio,45,' ');
     sporcentaje:=sporcentaje||rpad(' PORCENTAJE: '||to_char(m.porcentajebeneficiario,'999.99%'),45,' ');

     end if;

     j:=j+1;
  

  end loop;
select i.fechavencimiento-i.fechainversion
into idias
from inversion i
where i.inversionid=pinversionid;

fisr:=0;
select isrinversion(i.depositoinversion,idias,i.socioid,i.fechavencimiento)
into fisr
from inversion i
where i.inversionid=pinversionid;

--raise notice 'Dias %  ISR %',idias,fisr;

select fechainversion
  into pfechainversion
  from inversion
where  inversionid=pinversionid; 

pmes1:=cast(date_part('month',pfechainversion) as int);
pdia1:=cast(date_part('day',pfechainversion) as char(2));
pano1:=cast(date_part('year',pfechainversion) as char(4));

if pmes1=1 then
   psmes1:= 'ENERO     ';
end if;
if pmes1=2 then
   psmes1:= 'FEBRERO   ';
end if;
if pmes1=3 then
   psmes1:= 'MARZO     ';
end if;
if pmes1=4 then
   psmes1:= 'ABRIL     ';
end if;
if pmes1=5 then
   psmes1:= 'MAYO      ';
end if;
if pmes1=6 then
   psmes1:= 'JUNIO     ';
end if;
if pmes1=7 then
   psmes1:= 'MAYO      ';
end if;
if pmes1=8 then
   psmes1:= 'AGOSTO    ';
end if;
if pmes1=9 then
   psmes1:= 'SEPTIEMBRE';
end if;
if pmes1=10 then
   psmes1:= 'OCTUBRE   ';
end if;
if pmes1=11 then
   psmes1:= 'NOVIMBRE  ';
end if;
if pmes1=12 then
   psmes1:= 'DICIEMBRE ';
end if;



pformato := '';
           --chr(13)||chr(10)||
           -- chr(13)||chr(10);

SELECT
chr(27)||'(10U'||CHR(27)||CHR(38)||CHR(107)||CHR(50)||CHR(83)||
chr(27)||'(19U'||
chr(27)||'(s+4B'||
chr(13)||chr(10)||
'                                                                                                           Pgina 1 de 2'||chr(13)||chr(10)||
chr(13)||chr(10)||
'CONTRATO DE DEPSITO A PLAZO  FIJO  DE VALORES EN ADMINISTRACIN, QUE CELEBRAN POR UNA PARTE LA, A QUIEN  EN LO SUCESIVO'||chr(13)||chr(10)||
'SE  LE  DENOMINARA  "EL  DEPOSITARIO";  Y POR OTRA  PARTE  EL SEOR(A), A QUIEN  EN LO  SUCESIVO  SE LE  DENOMINARA  "EL'||chr(13)||chr(10)||
'DEPOSITANTE" Y AMBOS COMO  "LAS PARTES"; QUIENES  MANIFIESTAN SU VOLUNTAD Y CONFORMIDAD DE SUJETAR EL PRESENTE  CONTRATO'||chr(13)||chr(10)||
'AL TENOR DE LAS SIGUIENTES DECLARACIONES Y CLAUSULAS.'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'                                              D E C L A R A C I O N E S'||chr(13)||chr(10)||
chr(13)||chr(10)||
'I.-	Declara el "Depositario":'||chr(13)||chr(10)||
'      a)  Ser  una  sociedad  cooperativa  de  ahorro y prstamo, debida y legalmente  constituida  conforme a la ley de'||chr(13)||chr(10)||
'          sociedades cooperativas.'||chr(13)||chr(10)||
'      b)  Que cuenta  con la organizacin  necesaria y los  elementos  humanos,  tcnicos y jurdicos  suficientes  para'||chr(13)||chr(10)||
'          desarrollar las actividades materia de este contrato.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'II.-	Declara el "Depositante":'||chr(13)||chr(10)||
'      a)  Ser  mexicano(a), mayor de edad, contar con capacidad jurdica para contratar y obligarse.'||chr(13)||chr(10)||
'      b)  Ser socio activo de la: , con el nmero: '||s.clavesocioint|| chr(13)||chr(10)||
chr(13)||chr(10)||
'III.-	Declaran las "Partes":'||chr(13)||chr(10)||
'      a)  Que es su deseo celebrar el presente contrato de depsito a plazo fijo de valores en administracin, y sujetar'||chr(13)||chr(10)||
'          su voluntad a las siguientes:'||chr(13)||chr(10)||
chr(13)||chr(10)||
'________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                                                     CLUSULAS'||chr(13)||chr(10)||
chr(13)||chr(10)||
'PRIMERA.- "El Depositante" entrega a "El Depositario", para su  custodia y administracin  la cantidad '||to_char(i.depositoinversion,'$999,999,999.99')||chr(13)||chr(10)||
rpad(cletra(i.depositoinversion),86,' ')||'  de, de acuerdo a los estatutos y'||chr(13)||chr(10)||
'reglamentos debidamente autorizados por los rganos de administracin de la Cooperativa.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'SEGUNDA.- "El Depositante" acepta que "El Depositario" administre las cantidades otorgadas en depsito,  manifestando su'||chr(13)||chr(10)||
'consentimiento para que dichos numerarios sean colocados, va prstamos a los socios integrantes de la Cooperativa, bajo'||chr(13)||chr(10)||
'las normas establecidas en los estatutos y reglamentos de crdito previamente aprobados.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'TERCERA.- "Las Partes",  acuerdan que  "El Depositante",  no podr  efectuar  retiros totales o parciales, del capital o'||chr(13)||chr(10)||
'intereses devengados, antes de la fecha de vencimiento del contrato.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'CUARTA.- "El Depositario" se compromete a devolver a "El Depositante", la cantidad  entregada en depsito ms el inters'||chr(13)||chr(10)||
'que se hubiera  generado  por la aplicacin de la  tasa de inters  del'||to_char(i.tasainteresnormalinversion,'999%')||' Anual neto, al  termino  de la vigencia del'||chr(13)||chr(10)||
'presente  contrato, quedando  condicionada su  entrega al aviso que  deber  realizar "El Depositante" ya  sea en  forma'||chr(13)||chr(10)||
'personal,  va  telefnica  al nmero,  o  por  escrito,  dicha   notificacin  deber  realizarse  con  cinco  das  de'||chr(13)||chr(10)||
'anticipacin a la fecha de vencimiento.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'QUINTA.- "Las Partes", acuerdan que el presente  contrato de depsito a plazo  fijo de valores en administracin  tendr'||chr(13)||chr(10)|| 
'una duracin de'||to_char(i.fechavencimiento-i.fechainversion,'999') ||' das comenzando a surtir sus efectos el da '||to_char(i.fechainversion,'dd/mm/yyyy')||' venciendo el da '||to_char(i.fechavencimiento,'dd/mm/yyyy')||',  por lo que a la'||chr(13)||chr(10)|| 
'fecha de  vencimiento, siempre y cuando hubiese  cumplido con el aviso  correspondiente "El  Depositante" podr  retirar'||chr(13)||chr(10)|| 
'total o parcialmente su depsito.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'SEXTA.- "El Depositante" otorga su voluntad para  que en el caso de no dar el aviso a que refiere la clusula cuarta,  o'||chr(13)||chr(10)||
'bien  no  comparezca ante "El Depositario" a solicitar el retiro de su  depsito, dicha cantidad se REINVERTIRA en forma'||chr(13)||chr(10)||
'automtica,  a  la  tasa  de  inters  vigente,  a  la  fecha  de  vencimiento  del  presente  contrato, y por  el plazo'||chr(13)||chr(10)||
'originalmente pactado.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'SEPTIMA.- "Las Partes", acuerdan  que en caso de que el vencimiento  del  presente  contrato resulte ser da inhbil, es'||chr(13)||chr(10)||
'decir, que  la  fecha  de  vencimiento sea da domingo, o los que la ley marca  como  inhbiles o que la Cooperativa  no'||chr(13)||chr(10)||
'labore, se podr realizar el retiro correspondiente del depsito y sus accesorios, al da siguiente hbil a dicha fecha.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'OCTAVA.- "Las Partes",  acuerdan  que la nica  persona  facultada para  retirar  el  depsito o sus  accesorios  es "El'||chr(13)||chr(10)||
'Depositante" con excepcin de lo estipulado en la clusula siguiente.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                                                                                                           Pgina 2 de 2'||chr(13)||chr(10)||
chr(13)||chr(10)||
'________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'NOVENA.- "El  Depositario"  se  obliga  en  caso  de  fallecimiento  de  "El  Depositante"  a  entregar  las  cantidades'||chr(13)||chr(10)|| 
'correspondientes  del depsito y sus  accesorios a la o las personas, por l designadas en el presente  documento, en la'||chr(13)||chr(10)||
'proporcin que l mismo establece.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'BENEFICIARIOS:'||chr(13)||chr(10)||
chr(13)||chr(10)||
snombrebeneficiario||chr(13)||chr(10)||
sdomiciliobeneficiario||chr(13)||chr(10)||
scomunidadbeneficiario||chr(13)||chr(10)||
stelefonobeneficiario||chr(13)||chr(10)||
sporcentaje||chr(13)||chr(10)||
chr(13)||chr(10)||
'LEIDO QUE FUE EL PRESENTE CONTRATO, ESTANDO CONCIENTES DEL ALCANCE LEGAL A QUE "LAS PARTES" SE OBLIGAN, FIRMAN AL CALCE'||chr(13)||chr(10)||
'POR DUPLICADO, LOS QUE EN EL INTERVINIERON.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'CD. GUZMAN, JAL. a '||pdia1||'/'||rtrim(psmes1)||'/'||pano1|| 
chr(13)||chr(10)||
'________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                                              "E L   D E P O S I T A R I O"'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                                      ________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                                              "E L   D E P O S I T A N T E"                                                     '||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                                      ________________________________________________'||chr(13)||chr(10)||

chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||

'Sucursal:    '||em.nombresucursal||chr(13)||chr(10)|| 
'Operado por: '||chr(13)||chr(10)|| 
'Folio:       '||i.referenciainversion||chr(13)||chr(10)




into ptexto
FROM socio s, sujeto su, domicilio d, ciudadesmex c, estadosmex e, empresa em, inversion i, tipoinversion t
WHERE i.inversionid=pinversionid and
      t.tipoinversionid = i.tipoinversionid and
      i.socioid = s.socioid and
      su.sujetoid = s.sujetoid and
      d.sujetoid = s.sujetoid and
      c.ciudadmexid = d.ciudadmexid and
      e.estadomexid = c.estadomexid and
      em.empresaid=1;
     

  pformato := pformato||ptexto||chr(12)||chr(13)||chr(27)||chr(69);

return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatoinversion(integer) OWNER TO sistema;

--
-- Name: formatopagare(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatopagare(integer, integer) RETURNS text
    AS $_$
declare
    pprestamoid alias for $1;
    pnoformato  alias for $2;
    pformato text;


    ptexto1 text;
    ptexto2 text;
    ptexto3 text;
    ptexto4 text;

    total                numeric;
    pnumamortizacion     numeric;
    pfechadepago         date;
    psaldo_absoluto      numeric;
    pimporteamortizacion numeric;
    pinteresnormal       numeric;
    ptotal               numeric;

    minamor              int4;
    maxamor              int4; 

    sclavesocioint text;

    i int;

    fvalor1 numeric;
    fvalor2 numeric;
   
--DECLARA  VARIABLES


    snosocioaval varchar;
    snombreaval  varchar;
    sdomicilioaval varchar;
    scomunidad   varchar;
    scomunidad2 varchar;
    stelefonoaval varchar;
    sfirmaaval varchar;

        
    r record;
    rr record;
    x record;

    stextoa text;

    savales text;

    pmes        int;
    psmes       varchar;
    pdia        char(2);
    pano        char(4);

    pmes2        int;
    psmes2       varchar;
    pdia2        char(2);
    pano2        char(4);
   
    pmes1        int;
    psmes1       varchar;
    pdia1        char(2);
    pano1        char(4);
    sfecha_1er_pago  date;
    sfecha_vencimiento date;


begin

  sclavesocioint :='';
  snosocioaval := '';
  snombreaval  := '';
  sdomicilioaval := '';
  scomunidad := '';
  scomunidad2 :='';
  stelefonoaval :='';
  sfirmaaval :='';

 select fecha_1er_pago,fecha_vencimiento
   from prestamos
   into sfecha_1er_pago,sfecha_vencimiento
  where prestamoid = pprestamoid; 



pmes1:=cast(date_part('month',sfecha_vencimiento) as int);
pdia1:=cast(date_part('day',sfecha_vencimiento) as char(2));
pano1:=cast(date_part('year',sfecha_vencimiento) as char(4));

if pmes1=1 then
   psmes1:= 'ENERO     ';
end if;
if pmes1=2 then
   psmes1:= 'FEBRERO   ';
end if;
if pmes1=3 then
   psmes1:= 'MARZO     ';
end if;
if pmes1=4 then
   psmes1:= 'ABRIL     ';
end if;
if pmes1=5 then
   psmes1:= 'MAYO      ';
end if;
if pmes1=6 then
   psmes1:= 'JUNIO     ';
end if;
if pmes1=7 then
   psmes1:= 'MAYO      ';
end if;
if pmes1=8 then
   psmes1:= 'AGOSTO    ';
end if;
if pmes1=9 then
   psmes1:= 'SEPTIEMBRE';
end if;
if pmes1=10 then
   psmes1:= 'OCTUBRE   ';
end if;
if pmes1=11 then
   psmes1:= 'NOVIMBRE  ';
end if;
if pmes1=12 then
   psmes1:= 'DICIEMBRE ';
end if;

pmes:=cast(date_part('month',sfecha_1er_pago) as int);
pdia:=cast(date_part('day',sfecha_1er_pago) as char(2));
pano:=cast(date_part('year',sfecha_1er_pago) as char(4));

if pmes=1 then
   psmes:= 'ENERO     ';
end if;
if pmes=2 then
   psmes:= 'FEBRERO   ';
end if;
if pmes=3 then
   psmes:= 'MARZO     ';
end if;
if pmes=4 then
   psmes:= 'ABRIL     ';
end if;
if pmes=5 then
   psmes:= 'MAYO      ';
end if;
if pmes=6 then
   psmes:= 'JUNIO     ';
end if;
if pmes=7 then
   psmes:= 'MAYO      ';
end if;
if pmes=8 then
   psmes:= 'AGOSTO    ';
end if;
if pmes=9 then
   psmes:= 'SEPTIEMBRE';
end if;
if pmes=10 then
   psmes:= 'OCTUBRE   ';
end if;
if pmes=11 then
   psmes:= 'NOVIMBRE  ';
end if;
if pmes=12 then
   psmes:= 'DICIEMBRE ';
end if;



pmes2:=cast(date_part('month',CURRENT_DATE) as int);
pdia2:=cast(date_part('day',CURRENT_DATE) as char(2));
pano2:=cast(date_part('year',CURRENT_DATE) as char(4));

if pmes2=1 then
   psmes2:= 'ENERO     ';
end if;
if pmes2=2 then
   psmes2:= 'FEBRERO   ';
end if;
if pmes2=3 then
   psmes2:= 'MARZO     ';
end if;
if pmes2=4 then
   psmes2:= 'ABRIL     ';
end if;
if pmes2=5 then
   psmes2:= 'MAYO      ';
end if;
if pmes2=6 then
   psmes2:= 'JUNIO     ';
end if;
if pmes2=7 then
   psmes2:= 'MAYO      ';
end if;
if pmes2=8 then
   psmes2:= 'AGOSTO    ';
end if;
if pmes2=9 then
   psmes2:= 'SEPTIEMBRE';
end if;
if pmes2=10 then
   psmes2:= 'OCTUBRE   ';
end if;
if pmes2=11 then
   psmes2:= 'NOVIMBRE  ';
end if;
if pmes2=12 then
   psmes2:= 'DICIEMBRE ';
end if;


i:=0;

  for r in
   select a.socioid,
          s.nombre,s.paterno,s.materno,d.calle,d.numero_ext,
          co.nombrecolonia,d.comunidad,s.sujetoid,d.teldomicilio
    from avales a,sujeto s,domicilio d, colonia co
   where a.prestamoid = pprestamoid and
         s.sujetoid = a.sujetoid and
         d.sujetoid = a.sujetoid and
         co.coloniaid = d.coloniaid 
   order by a.noaval
  loop

    if i<3 then
      -- Verificar si es socio
      if r.socioid IS NOT NULL then
        select clavesocioint
          into sclavesocioint
          from socio
         where socioid=r.socioid;
        snosocioaval:=snosocioaval||rpad(sclavesocioint,45,' ');
      else
        -- Cuando el aval es socio
         snosocioaval:=snosocioaval||rpad(to_char(r.sujetoid,'000000'),45,' ');
      end if;

      snombreaval:=snombreaval||rpad('Nombre: '||r.nombre||' '||r.paterno||' '||r.materno,45,' ');
      sdomicilioaval:=sdomicilioaval||rpad('Domicilio: '||r.calle||' '||r.numero_ext,45,' ');
      scomunidad:=scomunidad||rpad('Colonia: '||r.nombrecolonia,45,' ');
      scomunidad2:=scomunidad2||rpad('Comunidad: '||r.comunidad,45,' ');
      stelefonoaval:=stelefonoaval||rpad('Tel: '||r.teldomicilio,45,' ');
      sfirmaaval:=sfirmaaval||rpad('Firma_____________________',45,' '); 

    end if;
    i:=i+1;
  end loop;

  select trunc(montoprestamo/numero_de_amor)
     into fvalor2
     from prestamos
    where prestamoid=pprestamoid;

   select montoprestamo-(fvalor2*(numero_de_amor-1))
     into fvalor1
     from prestamos
    where prestamoid=pprestamoid;




 pformato := chr(15)||chr(13)||chr(10)||
             chr(13)||chr(10);

 if pnoformato=1 then

 


select
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                                                              P A G A R E'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
rpad('SUCURSAL: '||e.nombresucursal,80,' ')||rpad('No. SOCIO: '||s.clavesocioint,30,' ')||'No. CREDITO: '||p.referenciaprestamo||chr(13)||chr(10)||
chr(13)||chr(10)||
'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'POR EL  PRESENTE PAGAR DECLARO (AMOS) DEBER Y ME (NOS) OBLIGO (AMOS) A PAGAR  INDOCNDICIONALMENTE A LA ORDEN DE  COOPERATIVA DEL'||chr(13)||chr(10)||
'SUR DE  JALISCO, S.C. DE R.L. DE C.V. EN EL DOMICILIO DE SUS  OFICINAS UBICADAS EN:  EFRAIN BUEN  ROSTRO NO. 44,  FRACCIONAMIENTO'||chr(13)||chr(10)||
'SAN  PEDRO  DE  ESTA  CIUDAD  O  EN  CUALQUIERA  DE  SUS  OFICINAS,  LA  CANTIDAD  DE:    '||to_char(p.montoprestamo,'$999,999,999.99')||chr(13)||chr(10)||
rpad(cletra(p.montoprestamo),75,' ')||'  VALOR RECIBIDO A MI ENTERA SATISFACCIN. LA CANTIDAD'||chr(13)||chr(10)||
'ADECUADA DEVENGAR UN INTERES ORDINARIO DEL '||to_char(p.tasanormal,'99%')||' MENSUAL APLICADO SOBRE SALDOS INSOLUTOS, PAGADEROS CONJUNTAMENTE CON EL CAPITAL,'||chr(13)||chr(10)||
'EL (LOS) SUSCRIPTOR (ES) SE OBLIGA (N) A CUBRIR LA CANTIDAD SEALADA MAS SUS ACCESORIOS FINANCIEROS  MEDIANTE '||p.numero_de_amor||' PAGOS  SUCESIVOS'||chr(13)||chr(10)||
'POR LA CANTIDAD DE '||to_char(fvalor2,'$999,999.99')||' CADA UNO, EL PRIMERO DE ELLOS  PRECISAMENTE EL DA '||pdia||' DE '||psmes||' DEL '||pano||' Y UN LTIMO  PAGO POR'||chr(13)||chr(10)||
'LA CANTIDAD  DE '||to_char(fvalor1,'$999,999.99')||', EL DA '||pdia1||' DE '||psmes1||' DEL '||pano1||'. PARA EL CASO DE MORA POR EL  INCUMPLIMIENTO O ATRAZO DE  ALGUNO O'||chr(13)||chr(10)||
'ALGUNOS  DE  LOS  VENCIMIENTOS  PACTADOS,  LAS  PARTES   EXPRESAMENTE  PACTAN  QUE  APARTIR DEL  VENCIMIENTO O  ATRASO  DEL  PAGO'||chr(13)||chr(10)||
'CORRESPONDIENTE, ESTE  GENER UN  INTERS  MORATORIO EL CUAL SER CALCULADO A RAZN DE  ADICIONAR A LA TASA DE INTERS  ORDINARIO'||chr(13)||chr(10)||
'MENSUAL SEALADA POR ESTE PAGAR, TRES PUNTOS  PORCENTUALES, LA CUAL SE APLICAR SOBRE EL MONTO DE LA  AMORTIZACIN NO CUBIERTA Y'||chr(13)||chr(10)||
'DURANTE TODO EL TIEMPO QUE PAREZCA  INSOLUTA. LAS PARTES  EXPRESAMENTE  PACTAN QUE LA FALTA DE PAGO  OPORTUNO DE UNO O MS ABONOS'||chr(13)||chr(10)||
'SER  MOTIVO SUFICIENTE PARA QUE EL  BENFICIARIO PUEDA DAR POR VENCIDOS  ANTICIPADAMENTE LOS ABONOS  RESTANTES Y POR CONSECUENCIA'||chr(13)||chr(10)||
'HACER EXIGIBLE, EN ESTA O  CUALQUIER PLAZA, EL PAGO DEL SALDO TOTAL MS SUS ACCESORIOS FINANCIEROS.'||chr(13)||chr(10)||
'EL SUSCRIPTOR FACULTA A COOPERATIVA REGIONAL DEL SUR DE JALISCO, S.C. DE R.L. DE C.V. A EFECTUAR CARGOS, EN SU CUENTA DE DEPOSITO'||chr(13)||chr(10)||
'DE AHORRO APERTURA CON COOPERATIVA REGIONAL DEL SUR DE JALISCO, S.C. DE R.L. DE C.V. NO. '||s.clavesocioint||' POR LOS MONTOS Y LAS FECHAS'||chr(13)||chr(10)||
'CORRESPONDIENTES A CADA UNA DE LAS AMORTIZACIONES  PACTADAS EN ESTE  PAGAR, POR LO QUE EL SUSCRIPTOR  SE OBLIGA A  EFECTUAR  LOS'||chr(13)||chr(10)||
'DEPSITOS  NECESARIOS  PARA EL PAGO DE CADA UNA DE LAS  AMORTIZACIONES, A MAS TARDAR DEL DA DE LA FECHA  PACTADA O EN SU CASO EL'||chr(13)||chr(10)||
'DA HBIL INMEDIATO SIGIENTE.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'LOS OBLIGADOS  FACULTAN COOPERATIVA  REGIONAL DEL SUR DE JALISCO, S.C. DE R.L. DE C.V. PARA QUE EN  CASO DE MORA O INCUMPLIMIENTO'||chr(13)||chr(10)||
'EN  EL PAGO DE  UNO O MAS  ABONOS, APLIQUE  CUALQUIER SALDO  QUE EXISTIERA EN  CUENTAS DE DEPSITOS DE  APERTURAS EN  COOPERATIVA'||chr(13)||chr(10)||
'REGIONAL  DEL SUR DE  JALISCO, S.C. DE R.L. DE C.V., A FAVOR DE  CUALQUIERA DE LOS  OBLIGADOS, COMO PAGO TOTAL O  PARCIAL DE ESTE'||chr(13)||chr(10)||
'PAGAR.'||chr(13)||chr(10)||
'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'                                                    ACEPTANTE (S) U OBLIGADOS (S)'||chr(13)||chr(10)||
'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'                            NOMBRE: '||su.nombre||' '||su.paterno||' '||su.materno ||chr(13)||chr(10)||
'                            DOMICILIO: '||'CALLE '||rtrim(d.calle)||' No. '||rtrim(numero_ext)||' Col: '||rtrim(co.nombrecolonia)||' '||chr(13)||chr(10)||
'                            CIUDAD: '||rtrim(c.nombreciudadmex)||chr(13)||chr(10)||
'                            ESTADO: '||rtrim(nombreestadomex)||chr(13)||chr(10)||
'                            TEL: '||d.teldomicilio||chr(13)||chr(10)||              
'                            FIRMA ACEPTANTE U OBLIGADO:_____________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'                                                       AVAL O DEUDOR SOLIDARIO'||chr(13)||chr(10)||
'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'  '||snombreaval||chr(13)||chr(10)||
'  '||sdomicilioaval||chr(13)||chr(10)||
'  '||scomunidad||chr(13)||chr(10)||
'  '||scomunidad2||chr(13)||chr(10)||
'  '||stelefonoaval||chr(13)||chr(10)||
'  '||sfirmaaval||chr(13)||chr(10)||
chr(13)||chr(10)||
'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||

chr(13)||chr(10)||
chr(13)||chr(10)||



chr(13)||chr(10)



into ptexto1

from prestamos p, empresa e, socio s, sujeto su, domicilio d, colonia co,
     ciudadesmex c, estadosmex es

where p.prestamoid = pprestamoid and
      p.socioid = s.socioid and
      s.sujetoid = su.sujetoid and
      su.sujetoid = d.sujetoid and
      d.coloniaid = co.coloniaid and
      co.ciudadmexid = c.ciudadmexid and
      c.estadomexid = c.estadomexid and
      e.empresaid = 1;

  pformato := trim(pformato)||ptexto1;  
     
end if;



 if pnoformato=2 then

select
'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'                                                            P A G A R E'||chr(13)||chr(10)||
chr(13)||chr(10)||
lpad('IMPORTE DE ESTE PAGARE: '||to_char(p.montoprestamo,'$999,999,999.99'),120,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
lpad('VENCE EL DA '||pdia1||' DE '||psmes1||' DEL '||pano1,120,' ')||chr(13)||chr(10)||
'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'Por el presente  PAGARE declaro deber y me obligo a pagar INCONDICIONALMENTE y sin protesto, a la orden de la COOPERATIVA REGIONAL'||chr(13)||chr(10)||
'DEL SUR DE JALISCO, S.C. DE  R.L.DE  C.V.'||chr(13)||chr(10)||
'La cantidad de '||to_char(p.montoprestamo,'$999,999,999.99')||'     '||cletra(p.montoprestamo)||chr(13)||chr(10)||  
chr(13)||chr(10)||
'Valor que he recibido a mi entera satisfaccin, me obligo a pagar en '||p.numero_de_amor||' abonos MENSUALES de '||to_char(p.montoprestamo/p.numero_de_amor,'$999,999.99')||' cada  uno, mas el interes '||chr(13)||chr(10)||
'ordinario a razn del '||to_char(p.tasanormal,'999%')||' Mensual sobre saldos insolutos. Dichas amortizaciones seran a  partir del '||pdia||' DE '||psmes||' DEL '||pano||chr(13)||chr(10)||
chr(13)||chr(10)||
'El calculo se  efectuar utilizando el procedimiento de das naturales transcurridos con divisor de 360 (trecientos sesenta) das.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'Para  el caso de este  pagar deba ser  cubierto en dos o ms  amortizaciones:  La  falta  de pago  oportuno de  cualquiera de las'||chr(13)||chr(10)||
'amortizaciones pactadas har exigible anticipadamente el importe insoluto de esta Pagar, en cuyo caso, apartir del incumplimineto,'||chr(13)||chr(10)||
'se cubrir con el ahorro y/o inversin depositado en la cuenta del aceptante u obligado.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'El Aceptante u Obligado faculta a la: '||chr(13)||chr(10)||
'COOPERATIVA REGIONAL DEL SUR DE JALISCO, S.C. DE R.L. DE C.V.'||chr(13)||chr(10)||
'a descontar o endosar en  cualquiera de sus formas el presente Pagar.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'En caso  de  contoversia judicial, las  partes se someten a la  jurisdiccin y competencia de  los juzgados de CD. GUZMAN, JALISCO.'||chr(13)||chr(10)||
'Renunciando expresamente a cualquiera otra  competencia que le corresponde en  razon  de  su domicilio.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'CD. GUZMAN, JAL. A '||pdia2||' de '||psmes2||' de '||pano2||chr(13)||chr(10)||
chr(13)||chr(10)||
'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
'                                                  NOMBRE Y FIRMA DEL ACEPTANTE U OBLIGADO'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'Socio:     '||su.nombre||' '||su.paterno||' '||su.materno ||chr(13)||chr(10)||
'Direccin: '||'CALLE '||rtrim(d.calle)||' No. '||rtrim(numero_ext)||chr(13)||chr(10)||
'Colonia:   '||rtrim(co.nombrecolonia)||' '||chr(13)||chr(10)||
'Ciudad:    '||rtrim(c.nombreciudadmex)||chr(13)||chr(10)||
'Estado:    '||rtrim(nombreestadomex)||chr(13)||chr(10)||
'Tel:       '||d.teldomicilio||chr(13)||chr(10)||              
lpad('_______________________________________',120,' ')||chr(13)||chr(10)||
lpad('Firma                                  ',120,' ')||chr(13)||chr(10)||
chr(13)||chr(10)

into ptexto2

from prestamos p, empresa e, socio s, sujeto su, domicilio d, colonia co, ciudadesmex c,      estadosmex es
where p.prestamoid = pprestamoid and
      p.socioid = s.socioid and
      s.sujetoid = su.sujetoid and
      su.sujetoid = d.sujetoid and
      d.coloniaid = co.coloniaid and
      co.ciudadmexid = c.ciudadmexid and
      c.estadomexid = c.estadomexid and
      e.empresaid = 1;


 pformato := trim(pformato)||ptexto2;
 end if;


-- if pnoformato=3 then

--select
--  chr(13)||chr(10)||

--chr(13)||chr(10)
  

--into ptexto3

--from prestamos p, ciudadesmex c, domicilio d,  sujeto su, socio s, colonia co,
--     empresa e, estadosmex es, solicitudingreso si, tipoprestamo tp

--where p.prestamoid = pprestamoid and
--      p.socioid = s.socioid and
--      s.sujetoid = su.sujetoid and
--      su.sujetoid = d.sujetoid and
--      d.coloniaid = co.coloniaid and
--      co.ciudadmexid = c.ciudadmexid and
--      s.socioid = si.socioid and
--      p.tipoprestamoid = tp.tipoprestamoid and
--      e.empresaid = 1;

 
-- pformato := trim(pformato)||ptexto3;
--  end if;


--  if pnoformato=4 then

--   select
--espaizq||'                                        CONTRATO DE CREDITO GRUPAL (PRODUCTIVO)'||chr(13)||chr(10)||
--chr(13)||chr(10)

--into ptexto4
--from prestamos p, empresa e, socio s, sujeto su, domicilio d, colonia co,
--     ciudadesmex c, solicitudingreso si
--where p.prestamoid = pprestamoid and
--      p.socioid = s.socioid and
--      s.sujetoid = su.sujetoid and
--      su.sujetoid = d.sujetoid and
--      d.coloniaid = co.coloniaid and
--      co.ciudadmexid = c.ciudadmexid and
--      s.socioid = si.socioid and
--      e.empresaid = 1;

 
--  pformato := trim(pformato)||ptexto4;
--   end if;


return  pformato; 
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatopagare(integer, integer) OWNER TO sistema;

--
-- Name: formatopoliza(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatopoliza(integer) RETURNS text
    AS $_$
declare
  ppolizaid alias for $1;

  pformato text;
  ppoliza text;
  ptexto text;
  ldebe  numeric;
  lhaber numeric;
  x integer;
  i integer;
  usuario varchar;
  r record;

  poliza2 text;

  mestab varchar[12]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE'];
begin
pformato:=' ';


select 
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
chr(10)||chr(13)||
'                    Poliza de '||(case when tipo_poliza = 'D' then           'Diario '
                              else (case when tipo_poliza = 'E' then   'Egreso '
                                else(case when tipo_poliza = 'I' then  'Ingreso'
                                  else                                   'Orden  '
                                  end)
                                end)
                             end)
||'        '||concepto_poliza||chr(10)||chr(13)||
'                    Fecha : '||to_char(fechapoliza,'dd-mm-yyyy')||chr(10)||chr(13)||

     into ppoliza  
     from polizas
    where polizaid=ppolizaid;
 pformato:=pformato||ppoliza||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13);

  ptexto :='';
  ldebe  := 0;
  lhaber := 0;
  i := 0;



 for r in
     select c.cuentaid,c.cuentanombre,mp.debe,mp.haber
       from movipolizas mp, catalogo_ctas c
      where mp.polizaid = ppolizaid  and
            c.cuentaid = mp.cuentaid
  loop

     if r.haber=0 then
        ptexto := ptexto||'      '||rpad(r.cuentaid,20,' ')||'       '||rpad(r.cuentanombre,51,' ')||'       '||to_char(r.debe,'$9,999,999.99')||chr(13)||chr(10);
     else
        ptexto := ptexto||'      '||rpad(r.cuentaid,20,' ')||'       '||rpad(r.cuentanombre,51,' ')||'                         '||to_char(r.haber,'$9,999,999.99')||chr(13)||chr(10);
     end if;


    ldebe := ldebe + r.debe;
    lhaber := lhaber + r.haber;
     i := i+1;
   end loop;

   pformato:=pformato||ptexto||chr(10)||chr(13);

  i:=12-i;

  for x in 1..i
    loop
      pformato := pformato||chr(13)||chr(10);
    end loop;

  usuario :='';
  select
 
'                                                                               T O T A L : ' ||
to_char(ldebe,'$9,999,999.99')||'    '||to_char(lhaber,'$9,999,999.99')||
chr(10)||chr(13)||
'      '||

rtrim(s.nombre)||'     JOSEFINA           '||p.numero_poliza||chr(10)||chr(13)||chr(10)||chr(13)
  into usuario
  from polizas p, usuarios u, sujeto s , parametros pa
  where  p.polizaid=ppolizaid and
       p.seriepoliza = pa.serie_user and
       pa.usuarioid =u.usuarioid and
       u.sujetoid = s.sujetoid;

pformato:=pformato||usuario;


 
return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatopoliza(integer) OWNER TO sistema;

--
-- Name: formatoprocampo(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatoprocampo(integer, integer) RETURNS text
    AS $_$
declare
  pprocampoid alias for $1;
  pnoformato  alias for $2;

  pformato text;
  ptexto1 text;
  ptexto2 text;
  ptexto3 text;
  ptexto4 text;

  pmes int;
  psmes varchar;
  pdia char(2);
  pano char(4);

  pmesa int;
  psmesa varchar;
  pdiaa char(2);
  panoa char(4);


  sdomicilio varchar;


  i int;

  sclavesocioint char(15);

  dfecha_otorga date;
dfecha_otorgaa date;
  r record;
begin

  select fecha_vencimiento into dfecha_otorga
    from procampo
   where procampoid=pprocampoid;

 select fecha_otorga into dfecha_otorgaa
    from procampo
   where procampoid=pprocampoid;

  pmes:=cast(date_part('month',dfecha_otorga) as int);
  pdia:=cast(date_part('day',dfecha_otorga) as char(2));
  pano:=cast(date_part('year',dfecha_otorga) as char(4));

  pmesa:=cast(date_part('month',dfecha_otorgaa) as int);
  pdiaa:=cast(date_part('day',dfecha_otorgaa) as char(2));
  panoa:=cast(date_part('year',dfecha_otorgaa) as char(4));

  if pmes=1 then
    psmes := 'Enero     ';
  end if;
  if pmes=2 then
    psmes := 'Febrero   ';
  end if;
  if pmes=3 then
    psmes := 'Marzo     ';
  end if;
  if pmes=4 then
    psmes := 'Abril     ';
  end if;
  if pmes=5 then
    psmes := 'Mayo      ';
  end if;
  if pmes=6 then
    psmes := 'Junio     ';
  end if;
  if pmes=7 then
    psmes := 'Julio     ';
  end if;
  if pmes=8 then
    psmes := 'Agosto    ';
  end if;
  if pmes=9 then
    psmes := 'Septiembre';
  end if;
  if pmes=10 then
    psmes := 'Octubre   ';
  end if;
  if pmes=11 then
    psmes := 'Noviembre ';
  end if;
  if pmes=12 then
    psmes := 'Diciembre ';
  end if;

  psmes := rtrim(psmes);


 if pmesa=1 then
    psmesa := 'Enero     ';
  end if;
  if pmesa=2 then
    psmesa := 'Febrero   ';
  end if;
  if pmesa=3 then
    psmesa := 'Marzo     ';
  end if;
  if pmesa=4 then
    psmesa := 'Abril     ';
  end if;
  if pmesa=5 then
    psmesa := 'Mayo      ';
  end if;
  if pmesa=6 then
    psmesa := 'Junio     ';
  end if;
  if pmesa=7 then
    psmesa := 'Julio     ';
  end if;
  if pmesa=8 then
    psmesa := 'Agosto    ';
  end if;
  if pmesa=9 then
    psmesa := 'Septiembre';
  end if;
  if pmesa=10 then
    psmesa := 'Octubre   ';
  end if;
  if pmesa=11 then
    psmesa := 'Noviembre ';
  end if;
  if pmesa=12 then
    psmesa := 'Diciembre ';
  end if;

  psmesa := rtrim(psmesa);



  select rtrim(d.calle)||' No. '||rtrim(d.numero_ext)||' Col. '||rtrim(d.colonia)
    into sdomicilio
    from procampo p, domicilio d
   where p.procampoid = pprocampoid and
         d.sujetoid = p.sujetoid;



  pformato := chr(15)||chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10);


  if pnoformato=1 then

   select '                        '||pdia||' '||psmes||' '||pano||'                         '||to_char(p.montoprestamo,'99,999,999.99')||chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        '                   '||pdia||' '||psmes||' '||pano||'                            '||to_char(p.montoprestamo,'99,999,999.99')||chr(13)||chr(10)||'           '||                                  cletra(p.montoprestamo)||chr(13)||chr(10)||chr(13)||chr(10)||'    '||     
                           to_char(p.montoprestamo,'99,999,999.99')||'                                                                     '||
        to_char(p.tasanormal/12,'99.99')||chr(13)||chr(10)||chr(13)||chr(10)||'                                                                        '||
        to_char(p.tasa_moratoria,'99.99')||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||'                                      '||                                                      
        pdiaa||'               '||psmesa||'                                 6'||chr(13)||chr(10)||
        '                                                                                '||to_char(p.sujetoid,'999999')||chr(13)||chr(10)||chr(13)||chr(10)||
        '           '||trim(su.nombre)||' '||trim(su.paterno)||' '||trim(su.materno)||chr(13)||chr(10)||chr(13)||chr(10)||
        '           '||d.calle||'  '||d.numero_ext||' '||d.colonia||'  '||c.nombreciudadmex||','||e.nombreestadomex||chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)
    into ptexto1
    from procampo p, sujeto su,domicilio d,ciudadesmex c,estadosmex e
   where p.procampoid=pprocampoid and
         su.sujetoid = p.sujetoid and
         d.sujetoid= p.sujetoid and
         c.ciudadmexid = d.ciudadmexid and
         e.estadomexid = c.estadomexid;

     pformato := trim(pformato)||ptexto1;
  end if;


return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatoprocampo(integer, integer) OWNER TO sistema;

--
-- Name: formatosolicitud(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatosolicitud(integer) RETURNS text
    AS $_$
declare

  psolicitudin alias for $1;

  pformato text;
  ptexto text;
  pavales text;
  piepagina text;
  i int;
  r record;
  m record;
  pmes int4;
  psmes varchar;

  pdia char(2);
  pano char(2);

  sclavesocioint char(15);
  scomunidad varchar;

  snosocioreferencia varchar;
  snombrereferencia varchar;
  sdomicilioreferencia varchar;
  scomunidadreferencia varchar;
  scomunidadreferencia2 varchar; 
  sparentescoreferencia varchar;

  snosociobeneficiario varchar;
  snombrebeneficiario varchar; 
  sdomiciliobeneficiario varchar; 
  scomunidadbeneficiario varchar;
  scomunidadbeneficiario2 varchar;
  sporcentajebeneficiario varchar;
  sparentescobeneficiario varchar;
  eciudadcaja varchar;

  snombreconyuge varchar;
  nacconyuge date;
  stiposocioid char(2);
  dfechasolicitud date;  

begin
  snosocioreferencia := '';
  snombrereferencia := '';
  sdomicilioreferencia := '';
  scomunidadreferencia := '';
  scomunidadreferencia2 := ''; 
  sparentescoreferencia := '';
  
 i:=0;
  for r in
   select re.socioid, re.parentesco, re.esreferenciapersonal, 
          s.nombre,s.paterno,s.materno,
          d.calle,d.numero_ext, s.sujetoid, co.nombrecolonia
          --d.colonia
          --d.comunidad,
    from relacion re, sujeto s, domicilio d, solicitudingreso si, colonia co
   where si.solicitudingresoid = psolicitudin and
         re.solicitudingresoid = si.solicitudingresoid and
         s.sujetoid = re.sujetoid and
         d.sujetoid = re.sujetoid and
         d.coloniaid = co.coloniaid and
         re.esreferenciapersonal = 1
   order by re.relacionid

loop 
    if i<3 then
      -- Verificar si es socio
      if r.socioid IS NOT NULL then
        select clavesocioint
          into sclavesocioint
          from socio
         where socioid=r.socioid;
        snosocioreferencia:=snosocioreferencia||rpad(sclavesocioint,42,' ');
      else
        -- Cuando la referencia no  es socio
       snosocioreferencia:=snosocioreferencia||rpad(to_char(r.sujetoid,'000000'),42,' ');
      end if;
      snombrereferencia:=snombrereferencia||rpad('Nom. '||r.nombre||' '||r.paterno||' '||r.materno,42,' ');
      sdomicilioreferencia:=sdomicilioreferencia||rpad('Dom. '||'Calle '||r.calle||' No. '||r.numero_ext,42,' ');
      scomunidadreferencia:=scomunidadreferencia||rpad('Col. '||r.nombrecolonia,42,' ');
      --scomunidadreferencia:=scomunidadreferencia||rpad('Col. '||r.colonia,42,' ');
      sparentescoreferencia:=sparentescoreferencia||rpad('Parentesco: '||r.parentesco,42,' ');
      end if;
    i:=i+1;
  end loop;

  snosociobeneficiario := '';
  snombrebeneficiario:='';
  sdomiciliobeneficiario:='';
  scomunidadbeneficiario:='';
  sporcentajebeneficiario:='';
  sparentescobeneficiario:='';

-- Buscar al beneficiario

i:=0;
  for m in
   select re.socioid, re.parentesco, re.esbenficiario, s.sujetoid,
          s.nombre, s.paterno, s.materno
          --, d.calle, d.numero_ext, co.nombrecolonia,d.comunidad, re.porcentaje,
    from relacion re, sujeto s, solicitudingreso si
           --domicilio d, 
           --, colonia co 
   where si.solicitudingresoid = psolicitudin and
         re.solicitudingresoid = si.solicitudingresoid and
         s.sujetoid = re.sujetoid and
	-- co.coloniaid = d.coloniaid and
        -- d.sujetoid = re.sujetoid and
         re.esbenficiario=1
   order by re.relacionid
  loop 
    if i<3 then
      -- Verificar si es socio
      if m.socioid IS NOT NULL then
        select clavesocioint
          into sclavesocioint
          from socio
         where socioid=m.socioid;
        snosociobeneficiario:=snosociobeneficiario||rpad(sclavesocioint,45,' ');
      else
        -- Cuando la referencia no es socio
       snosociobeneficiario:= snosociobeneficiario||rpad(to_char(m.sujetoid,'000000'),45,' ');
      end if;

      snombrebeneficiario:=snombrebeneficiario||rpad('Nom: '||m.nombre||' '||m.paterno||' '||m.materno,45,' ');
      sparentescobeneficiario:=sparentescobeneficiario||rpad('Parentesco: '||rtrim(m.parentesco),45,' ');
--       sdomiciliobeneficiario:=sdomiciliobeneficiario||rpad('Dom: '||m.calle||' No. '||m.numero_ext,45,' ');
--      scomunidadbeneficiario:=scomunidadbeneficiario||rpad('Col. '||m.colonia,45,' ');
--      sporcentajebeneficiario:=sporcentajebeneficiario||rpad('Porcentaje '||to_char(m.porcentaje,'999%'),45,' ');
     end if;
    i:=i+1;
   end loop;

  select ciudadcaja into eciudadcaja from empresa;


   select su.nombre||' '||su.paterno||' '||su.materno
     into snombreconyuge
     from solicitudingreso si, sujeto su
    where si.solicitudingresoid = psolicitudin and
          su.sujetoid = si.conyugeid and
          si.conyugeid is not null;

   select fecha_nacimiento into nacconyuge 
from solicitudingreso si, sujeto su
    where si.solicitudingresoid = psolicitudin and
          su.sujetoid = si.conyugeid and
          si.conyugeid is not null;

select si.fechasolicitud 
into dfechasolicitud
from solicitudingreso si
 where si.solicitudingresoid = psolicitudin;
  
  psmes:='';
  pmes:=cast(date_part('month',dfechasolicitud) as int);
  pdia:=cast(date_part('day',dfechasolicitud) as char(2));
  pano:=cast(date_part('year',dfechasolicitud)-2000 as char(2));

  if pmes=1 then
    psmes := 'Enero     ';
  end if;
  if pmes=2 then
    psmes := 'Febrero   ';
  end if;
  if pmes=3 then
    psmes := 'Marzo     ';
  end if;
  if pmes=4 then
    psmes := 'Abril     ';
  end if;
  if pmes=5 then
    psmes := 'Mayo      ';
  end if;
  if pmes=6 then
    psmes := 'Junio     ';
  end if;
  if pmes=7 then
    psmes := 'Julio     ';
  end if;
  if pmes=8 then
    psmes := 'Agosto    ';
  end if;
  if pmes=9 then
    psmes := 'Septiembre';
  end if;
  if pmes=10 then
    psmes := 'Octubre   ';
  end if;
  if pmes=11 then
    psmes := 'Noviembre ';
  end if;
  if pmes=12 then
    psmes := 'Diciembre ';
  end if;



SELECT
--chr(15)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                                          COOPERATIVA YOLOMECATL, S.C. DE R.L. DE C.V. '||chr(10)||chr(13)||
'Solicitud de Ingreso No: '||si.nosolicitud||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'      Nombre:        '||su.nombre||' '||su.paterno||' '||su.materno||
'      No Sol.: '||si.solicitudingresoid||'  Socio: '||s.clavesocioint||
chr(13)||chr(10)||
'      Domicilio:     '||d.calle||' '||d.numero_ext||' Col '||rtrim(co.nombrecolonia)||', '||rtrim(d.comunidad)||', '||rtrim(c.nombreciudadmex)||
chr(13)||chr(10)||
'      Telefono.:     '||d.teldomicilio||'      Lugar y fecha de Nacimiento: '||rtrim(c.nombreciudadmex)||'  '||to_char(su.fecha_nacimiento,'dd-mm-yyyy')||
chr(13)||chr(10)||
'      Estado Civil:  '||
(case when  si.estadocivilid = 0 then                'SOLTERO(A)   '
else ( case when si.estadocivilid = 1 then           'CASADO(A)    '
      else ( case when si.estadocivilid = 2 then     'DIVORCIADO(A)' 
          else ( case when si.estadocivilid = 3 then 'VIUDO(A)     '
             else                                    'UNION LIBRE  '
               end) 
          end)
      end)          
end)
||
'      Regimen Conyugal: '||
(case when  si.regimenmatrimonial = 0 then                'NO APLICA   '
else ( case when si.regimenmatrimonial = 1 then           'BIENES SEPARADOS    '
      else ( case when si.regimenmatrimonial = 2 then     'BIENES MANCOMUNADOS' 
      end)          
end)          
end)||
chr(13)||chr(10)||
'      Ocupacin:     '||coalesce(si.ocupacion,'')||'       Puesto: '||rtrim(si.profesion)||'              Ingreso Ordinario:_________'||
chr(13)||chr(10)||
'      Tipo Casa:     '||(case when si.tipocasaid = 0 then       'RENTADA '
else ( case when si.tipocasaid = 1 then 'PROPIA  '
      else                              'FAMILIAR'
    end)
 end)||
'      Tiempo de vivir en mismo domicilio: '||rtrim(coalesce(si.tiempovivirendomicilio,''))||' aos.         Ingreso Familiar:_________'||chr(13)||chr(10)||
'      -------------------------------------------------------------------------------------'||chr(13)||chr(10)||
'      Cajas populares a las que pertenece o ha pertenecido'||

(case when  si.perteneceaotracaja = 0 then                ': Ninguna   '
else ( case when si.perteneceaotracaja= 1 then            ': SI    Cual: '||si.otracaja
	end)
end)||
chr(13)||chr(10)||
'      Nombre del Conyugue: '||coalesce(snombreconyuge,'')||chr(13)||chr(10)||
'      Fecha de Nacimiento: '||coalesce(to_char(nacconyuge,'DD-MM-YYYY'),'')||chr(13)||chr(10)||
'      Familiares cercanos que no vivan en el mismo domicilio y puedan ser consultados:'||chr(13)||chr(10)||
'      -------------------------------------------------------------------------------------'||chr(13)||chr(10)||
  '      '||snombrereferencia||chr(13)||chr(10)||
  '      '||sdomicilioreferencia||chr(13)||chr(10)||
  '      '||scomunidadreferencia||chr(13)||chr(10)||
  '      '||sparentescoreferencia||chr(13)||chr(10)||
'      -------------------------------------------------------------------------------------'||chr(13)||chr(10)||
'      Por la presente solicito mi ingreso a esta Cooperativa y me comprometo a conocer '||chr(13)||chr(10)||
'      y cumplir sus Estatutos, Reglamentos y las enmiendas que se les hagan.'||
chr(13)||chr(10)||
 '      -------------------------------------------------------------------------------------'||chr(13)||chr(10)||
 '      En caso de mi fallecimiento nombro heredero de mis haberes en esta caja a:'||chr(13)||chr(10)||chr(13)||chr(10)||
 '      '||snombrebeneficiario||chr(13)||chr(10)||
 '      '||sparentescobeneficiario||chr(13)||chr(10)||chr(13)||chr(10)||

 '                        '||rtrim(eciudadcaja)||', a '||to_char(si.fechasolicitud,'dd')||' de '||rtrim(psmes)||' de '||to_char(si.fechasolicitud,'yyyy')||

chr(13)||chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||
'                                             _________________________________'||chr(13)||chr(10)||
'                                                    FIRMA DEL SOLICITANTE'
||chr(13)||chr(10)||chr(13)||chr(10)||
'      Me consta que los datos asentados en esta solicitud son verdicos:'||
chr(13)||chr(10)||
chr(13)||chr(10)||
'      Socio: '||substring(snosocioreferencia,1,10)||
chr(13)||chr(10)




INTO  ptexto
FROM  socio s, sujeto su, domicilio d, ciudadesmex c, estadosmex e,
      empresa em, solicitudingreso si, colonia co
WHERE si.solicitudingresoid = psolicitudin and
      su.sujetoid = si.sujetoid and
      d.sujetoid = si.sujetoid and
      c.ciudadmexid = d.ciudadmexid and
      e.estadomexid = c.estadomexid and
      d.coloniaid = co.coloniaid and
      co.ciudadmexid = c.ciudadmexid and
      em.empresaid=1;
       
--pformato:=ptexto||chr(12)||chr(13);


select 
'      Nombre: '||coalesce(su.nombre,'')||' '||coalesce(su.paterno,'')||' '||coalesce(su.materno,'')||
chr(13)||chr(10)||
'      Domicilio: '||rtrim(coalesce(d.calle,''))||' '||rtrim(coalesce(d.numero_ext,''))||' '||rtrim(coalesce(d.colonia,''))||
chr(13)||chr(10)||
'      Telfono: '||rtrim(coalesce(d.teldomicilio,''))||' '||coalesce(substring(sparentescoreferencia,1,20),'')
into pavales
from sujeto su, socio so, domicilio d where 
 so.clavesocioint=substring(snosocioreferencia,1,10) and
 su.sujetoid=so.sujetoid and
 d.sujetoid=su.sujetoid;


select 
chr(13)||chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||
'                                             _________________________________'||
chr(13)||chr(10)||
'                                                   FIRMA DEL REPRESENTANTE'||
chr(13)||chr(10)||
'      OBSERVACIONES:'||
chr(13)||chr(10)||
'      _______________________________________________________________________________________________________________________'||
chr(13)||chr(10)||
'      _______________________________________________________________________________________________________________________'||
chr(13)||chr(10)||
'      _______________________________________________________________________________________________________________________'||
chr(13)||chr(10)||chr(13)||chr(10)||
'      El consejo de Administracin _______________ esta solicitud el da ________ de _______________ del __________ '||
chr(13)||chr(10)||
'      quedando asentada en el acta No. ____________ '
||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                   ________________________________                                       ________________________________ '||
chr(13)||chr(10)||
'                             PRESIDENTE                                                             SECRETARIO'||
chr(13)||chr(10)
into piepagina
from sujeto su, socio so, domicilio d where 
 so.clavesocioint=substring(snosocioreferencia,1,10) and
 su.sujetoid=so.sujetoid and
 d.sujetoid=su.sujetoid;


       pformato:=ptexto||coalesce(pavales,'')||coalesce(piepagina,'');
--     pformato:=ptexto||pavales||chr(27)||chr(69);


return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatosolicitud(integer) OWNER TO sistema;

--
-- Name: formatosolicitudinfantil(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatosolicitudinfantil(integer) RETURNS text
    AS $_$
declare

  psolicitudin alias for $1;

  pformato text;
  ptexto text;
  sciudadnaci varchar;
  sestadonaci varchar;
  pmes int;
  psmes varchar;
  pdia char(2);
  pano char(4);

  pmes1 int;
  psmes1 varchar;
  pdia1 char(2);
  pano1 char(4);
  pfechasolicitud date;

  stiposocioid text;
  pisq text;

 begin

  pisq:='                    ';
select c.nombreciudadmex, e.nombreestadomex
  into sciudadnaci,sestadonaci 
  from solicitudingreso si,  ciudadesmex c, estadosmex e
 where si.solicitudingresoid=psolicitudin and
       si.ciudadmexid = c.ciudadmexid and
       c.estadomexid = e.estadomexid;

select fechasolicitud
  into pfechasolicitud
  from solicitudingreso
 where solicitudingresoid = psolicitudin;

pmes1:=cast(date_part('month',pfechasolicitud) as int);
pdia1:=cast(date_part('day',pfechasolicitud) as char(2));
pano1:=cast(date_part('year',pfechasolicitud) as char(4));

if pmes1=1 then
   psmes1:= 'ENERO     ';
end if;
if pmes1=2 then
   psmes1:= 'FEBRERO   ';
end if;
if pmes1=3 then
   psmes1:= 'MARZO     ';
end if;
if pmes1=4 then
   psmes1:= 'ABRIL     ';
end if;
if pmes1=5 then
   psmes1:= 'MAYO      ';
end if;
if pmes1=6 then
   psmes1:= 'JUNIO     ';
end if;
if pmes1=7 then
   psmes1:= 'MAYO      ';
end if;
if pmes1=8 then
   psmes1:= 'AGOSTO    ';
end if;
if pmes1=9 then
   psmes1:= 'SEPTIEMBRE';
end if;
if pmes1=10 then
   psmes1:= 'OCTUBRE   ';
end if;
if pmes1=11 then
   psmes1:= 'NOVIMBRE  ';
end if;
if pmes1=12 then
   psmes1:= 'DICIEMBRE ';
end if; 




pmes:=cast(date_part('month',CURRENT_DATE) as int);
pdia:=cast(date_part('day',CURRENT_DATE) as char(2));
pano:=cast(date_part('year',CURRENT_DATE) as char(4));

if pmes=1 then
   psmes:= 'ENERO     ';
end if;
if pmes=2 then
   psmes:= 'FEBRERO   ';
end if;
if pmes=3 then
   psmes:= 'MARZO     ';
end if;
if pmes=4 then
   psmes:= 'ABRIL     ';
end if;
if pmes=5 then
   psmes:= 'MAYO      ';
end if;
if pmes=6 then
   psmes:= 'JUNIO     ';
end if;
if pmes=7 then
   psmes:= 'MAYO      ';
end if;
if pmes=8 then
   psmes:= 'AGOSTO    ';
end if;
if pmes=9 then
   psmes:= 'SEPTIEMBRE';
end if;
if pmes=10 then
   psmes:= 'OCTUBRE   ';
end if;
if pmes=11 then
   psmes:= 'NOVIMBRE  ';
end if;
if pmes=12 then
   psmes:= 'DICIEMBRE ';
end if;



-- Determinar el tipo de Solicitud

-- Aqui ponemos el filtro para si es infantil

select tiposocioid
  into stiposocioid
  from solicitudingreso
 where solicitudingresoid=psolicitudin;


pformato:='';

-- Si se trata de un infantil formamos el formato

if stiposocioid='01' then



SELECT chr(27)||'(10U'||CHR(27)||CHR(38)||CHR(107)||CHR(50)||CHR(83)||
       chr(27)||'(19U'||
       chr(27)||'(s+4B'||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'|                            COOPERATIVA REGIONAL DEL SUR DE JALISCO S.C. DE R.L. DE C.V.'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'                                              SOLICITUD DE ADMICION'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'                                                 MENORES DE EDAD'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||lpad('No. '||s.clavesocioint,105,' ')||chr(13)||chr(10)||
--chr(13)||chr(10)||
pisq||'Nombre:    '||su.nombre||' '||su.paterno||' '||su.materno ||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||rpad('Domicilio: '||rtrim(d.calle)||' '||rtrim(d.numero_ext)||', INT. '||rtrim(d.numero_int),62,' ')||'     Colonia: '||rtrim(co.nombrecolonia)||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Entre las Calles: _______________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||rpad('Lugar:     '||rtrim(d.comunidad)||',  '||rtrim(c.nombreciudadmex),75,' ')||'  C.P. '||to_char(d.codpostal,'99999')||' Tel: '||rtrim(d.teldomicilio)||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||rpad('Tiempo de vivir en el mismo domicilio:  ',50,' ')||coalesce(si.tiempovivirendomicilio,'')||'  Ocupacion: '||coalesce(si.ocupacion,'')||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Lugar y  Fecha de Nacimiento:  '||rtrim(sciudadnaci)||', '||rtrim(sestadonaci)||',  '||to_char(su.fecha_nacimiento,'dd-mm-yyyy')||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Nombre del Padre o Tutor: _______________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Nombre de la Madre: _____________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Cooperativas u Organizaciones a las que pretenece o ha pertenecido: '||si.otracaja||chr(13)||chr(10)||
--chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Por la presente me comprometo a:'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   a) Conocer y cumplir sus  Estatutos, Reglamentos y las enmiendas que se hagan, y'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   b) Ahorrar, al menos, $20.00 (Veinte pesos 00/100 M.N.) cada mes.'||chr(13)||chr(10)||
chr(13)||chr(10)||
--chr(13)||chr(10)||
pisq||lpad('Ciudad Guzman, Jalisco, a '||pdia||' de '||psmes||' del ao '||pano,105,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'     ______________________________________                   ______________________________________'||chr(13)||chr(10)||
pisq||'                  Firma del Solicitante                                           Firma del Tutor'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Me consta que los datos asentados en la solicitud son verdicos'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Nombre y Nm. del Socio '||s.clavesocioint||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Fecha: '||pdia1||' de '||psmes1||' del  '||pano1||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||lpad('Firma del socio que lo representa _____________________________________',105,' ')||chr(13)||chr(10)||
--chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'El Comit de Admisin ________________________________________  esta solicitud del  da  '||pdia1||' de '||psmes1||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||lpad('Del ao '||pano1||' quedando asentado  en el  Acta No. '||si.nosolicitud,105,' ')||chr(13)||chr(10)|| 
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'          _________________________________                   _________________________________'||chr(13)||chr(10)||
pisq||'                      Persidente                                          Secretario'||chr(13)||chr(10)||
chr(13)||chr(10)

INTO  ptexto
FROM  socio s, sujeto su, domicilio d, ciudadesmex c, estadosmex e, empresa em, 
      solicitudingreso si, colonia co
WHERE si.solicitudingresoid=psolicitudin and
      s.socioid = si.socioid and
      su.sujetoid = s.sujetoid and
      d.sujetoid = s.sujetoid and
      co.coloniaid = d.coloniaid and
      c.ciudadmexid = d.ciudadmexid and
      e.estadomexid = c.estadomexid and
      em.empresaid=1;

 --    pformato:=ptexto||chr(12)||chr(13);
      pformato:=ptexto||chr(12)||chr(13)||chr(27)||chr(69);

end if;


return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatosolicitudinfantil(integer) OWNER TO sistema;

--
-- Name: formatosolicitudmoral(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatosolicitudmoral(integer) RETURNS text
    AS $_$
declare

  psolicitudin alias for $1;

  pformato text;
  ptexto text;

  pmes int;
  psmes varchar;
  pdia char(2);
  pano char(4);

  srepresentantenombre text;
  srepresentanteparentesco text;
  srepresentantedomicilio text;
  srepresentanterfc text;
  srepresentantecurp text;
  srepresentantecolonia text;
  srepresentantecp int;
  srepresentantemunicipio text;
  
  y record;

  pmes1 int;
  psmes1 varchar;
  pdia1 char(2);
  pano1 char(4);
  pfechasolicitud date;

  pisq text;


begin

  pisq:='                    ';

select fechasolicitud
  into pfechasolicitud
  from solicitudingreso
 where solicitudingresoid = psolicitudin;

pmes1:=cast(date_part('month',pfechasolicitud) as int);
pdia1:=cast(date_part('day',pfechasolicitud) as char(2));
pano1:=cast(date_part('year',pfechasolicitud) as char(4));

if pmes1=1 then
   psmes1:= 'ENERO     ';
end if;
if pmes1=2 then
   psmes1:= 'FEBRERO   ';
end if;
if pmes1=3 then
   psmes1:= 'MARZO     ';
end if;
if pmes1=4 then
   psmes1:= 'ABRIL     ';
end if;
if pmes1=5 then
   psmes1:= 'MAYO      ';
end if;
if pmes1=6 then
   psmes1:= 'JUNIO     ';
end if;
if pmes1=7 then
   psmes1:= 'MAYO      ';
end if;
if pmes1=8 then
   psmes1:= 'AGOSTO    ';
end if;
if pmes1=9 then
   psmes1:= 'SEPTIEMBRE';
end if;
if pmes1=10 then
   psmes1:= 'OCTUBRE   ';
end if;
if pmes1=11 then
   psmes1:= 'NOVIMBRE  ';
end if;
if pmes1=12 then
   psmes1:= 'DICIEMBRE ';
end if; 


pmes:=cast(date_part('month',CURRENT_DATE) as int);
pdia:=cast(date_part('day',CURRENT_DATE) as char(2));
pano:=cast(date_part('year',CURRENT_DATE) as char(4));

if pmes=1 then
   psmes:= 'ENERO     ';
end if;
if pmes=2 then
   psmes:= 'FEBRERO   ';
end if;
if pmes=3 then
   psmes:= 'MARZO     ';
end if;
if pmes=4 then
   psmes:= 'ABRIL     ';
end if;
if pmes=5 then
   psmes:= 'MAYO      ';
end if;
if pmes=6 then
   psmes:= 'JUNIO     ';
end if;
if pmes=7 then
   psmes:= 'MAYO      ';
end if;
if pmes=8 then
   psmes:= 'AGOSTO    ';
end if;
if pmes=9 then
   psmes:= 'SEPTIEMBRE';
end if;
if pmes=10 then
   psmes:= 'OCTUBRE   ';
end if;
if pmes=11 then
   psmes:= 'NOVIMBRE  ';
end if;
if pmes=12 then
   psmes:= 'DICIEMBRE ';
end if;




 srepresentantenombre:='';
 srepresentanteparentesco:='';
 srepresentantedomicilio:='';
 srepresentanterfc:='';
 srepresentantecurp:='';
 srepresentantecolonia:='';
 --srepresentantecp:='';
 srepresentantemunicipio:='';

  for y in

   select re.socioid, s.nombre,s.paterno,s.materno,d.calle,d.numero_ext,d.numero_int,
          co.nombrecolonia,d.comunidad,d.teldomicilio, re.parentesco, d.teldomicilio,
          s.rfc,s.curp,d.codpostal,c.nombreciudadmex

    from relacion re,sujeto s,domicilio d, colonia co, solicitudingreso si,
         ciudadesmex c

   where si.solicitudingresoid=psolicitudin and
         re.solicitudingresoid =si.solicitudingresoid and
         s.sujetoid = re.sujetoid and
         d.coloniaid = co.coloniaid and
         d.sujetoid = re.sujetoid and
         d.ciudadmexid=c.ciudadmexid and
         re.esrepresentante  = 1
   order by re.relacionid
  loop

    srepresentantenombre:=srepresentantenombre||'  '||rpad(y.nombre||' '||y.paterno||' '||y.materno,80,' ');
    srepresentanterfc:=srepresentanterfc||y.rfc;
    srepresentantecurp:=srepresentantecurp||y.curp;
    srepresentanteparentesco:=srepresentanteparentesco||y.parentesco;
    srepresentantedomicilio:=srepresentantedomicilio||rtrim(y.calle)||' '||rtrim(y.numero_ext)||', Int.'||rtrim(y.numero_int);
    srepresentantecolonia:=srepresentantecolonia||rtrim(y.nombrecolonia);
    srepresentantecp:=srepresentantecp||y.codpostal;
    srepresentantemunicipio:=srepresentantemunicipio||rtrim(coalesce(y.comunidad,''))||', '||y.nombreciudadmex;


  end loop;




SELECT
chr(27)||'(10U'||CHR(27)||CHR(38)||CHR(107)||CHR(50)||CHR(83)||
       chr(27)||'(19U'||
       chr(27)||'(s+4B'||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'                              COOPERATIVA REGIONAL DEL SUR DE JALISCO S.C. DE R.L. DE C.V.'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'                                                SOLICITUD DE ADMICION'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'                                                  PERSONAS MORALES'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||lpad('No. '||s.clavesocioint,105,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||rpad('Nombre:    '||su.nombre||' '||su.paterno||' '||su.materno,65,' ')||'R.F.C: '||coalesce(su.rfc,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Domicilio: '||rtrim(d.calle)||' '||rtrim(d.numero_ext)||', INT. '||rtrim(d.numero_int)||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||rpad('Colonia:   '||rtrim(co.nombrecolonia),10,' ')||'  C.P. '||to_char(d.codpostal,'99999')||'            Tel: '||rtrim(d.teldomicilio)||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||rpad('Municipio:     '||rtrim(d.comunidad)||',  '||rtrim(c.nombreciudadmex),65,' ')||'Estado: '||e.nombreestadomex||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||rpad('Representante Legal: '||srepresentantenombre,65,' ')||'R.F.C.: '||srepresentanterfc||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||rpad('CURP: '||srepresentantecurp,15,' ')||'Domicilio '||srepresentantedomicilio||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||rpad('Col. '||srepresentantecolonia,30,' ')||rpad('C.P. '||coalesce(srepresentantecp,0),10,' ')||'Municipio: '||srepresentantemunicipio||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'GIRO:      Agropecuario ( )      Industrial ( )      Comercio ( )      Servicio ( )      Otros ( )'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||rpad('Actividad Especifica:  '||coalesce(si.ocupacion,''),60,' ')||'Antiguedad: _________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Principales Accionistas: ________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Apoderados: _____________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Administradores: ________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Promedio de  Ingresos Ordinarios: $ ____________________________  Cada: _________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Cooperativas u Organizaciones a las que pretenece o ha pertenecido: '||si.otracaja||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Referencias Comerciales:'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'1) Nombre :   __________________________________________________  Actividad: ____________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   Domicilio: _______________________________________________________________  Tel. _____________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'2) Nombre :   __________________________________________________  Actividad: ____________________________' ||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   Domicilio: _______________________________________________________________  Tel. _____________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'3) Nombre :   __________________________________________________  Actividad: ____________________________' ||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   Domicilio: _______________________________________________________________  Tel. _____________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Por la  presente nos comprometemos a:'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   a) Conocer y cumplir sus Estatutos, Reglamentos y las enmiendas que se nos hagan'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   b) Cubrir cuanto antes el valor de una parte social, y'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   c) Ahorrar, al menos, $50.00 (Cincuenta pesos 00/100 M.N.) cada mes.'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Se anexa la documentacin que acontinuacin listamos para que se  integre nuestro expediente:'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   a) Copia de Alta de Hacienda a de la Cdula del Registro Federal de Contribuyentes'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   b) Comprobante de Domicilio'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   c) copia de Escritura Constitutiva'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   d) Copia de  los  Poderes y  modificaciones en su caso'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'   e) Identificaciones del Representante Legal'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||lpad('Ciudad Guzmn, Jalisco, a '||pdia||' de '||psmes||' del ao '||pano,105,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'                                                            ___________________________________'||chr(13)||chr(10)||
pisq||'                                                               Firma del Representante Legal'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Me consta que los datos asentados en la solicitud son verdicos'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Nombre y Nm. del Socio '||s.clavesocioint||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'Fecha: '||pdia1||' de '||psmes1||' del  '||pano1||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||lpad('Firma del socio que lo representa _____________________________________',105,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
pisq||'_________________________________________________________________________________________________________'||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'El Comit de Admisin ________________________________________  esta solicitud del  da  '||pdia1||' de '||psmes1||chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||lpad('Del ao '||pano1||' quedando asentado  en el  Acta No. '||si.nosolicitud,105,' ')||chr(13)||chr(10)|| 
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
pisq||'          ___________________________________               ___________________________________'||chr(13)||chr(10)||
pisq||'                      Persidente                                          Secretario'||chr(13)||chr(10)||
chr(13)||chr(10)



INTO  ptexto
FROM  socio s, sujeto su, domicilio d, ciudadesmex c, estadosmex e, empresa em, 
      solicitudingreso si, colonia co
WHERE si.solicitudingresoid=psolicitudin and
      s.socioid = si.socioid and
      su.sujetoid = s.sujetoid and
      d.sujetoid = s.sujetoid and
      co.coloniaid = d.coloniaid and
      c.ciudadmexid = d.ciudadmexid and
      e.estadomexid = c.estadomexid and
      em.empresaid=1;

 --    pformato:=ptexto||chr(12)||chr(13);
      pformato:=ptexto||chr(12)||chr(13)||chr(27)||chr(69);



return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatosolicitudmoral(integer) OWNER TO sistema;

--
-- Name: formatovale(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION formatovale(integer) RETURNS text
    AS $_$
declare
  pmovibancoid alias for $1;

  pformato text;
  ptexto   text;

  pmes int;
  psmes varchar;
  pdia char(2);
  pano char(4);

  dfecha date;

  fmonto numeric;

  r record;

  ldebe  numeric;
  lhaber numeric;
  i integer;
  j integer;

  psolicitudp int4;
  lprestamoid int4;
begin

  select p.fechapoliza, m.prestamoid into dfecha,lprestamoid
    from movibanco m, polizas p
   where m.movibancoid = pmovibancoid and
         p.polizaid = m.polizaid;

  select solicitudprestamoid into psolicitudp
    from prestamos
   where prestamoid=lprestamoid;

  select haber 
    into fmonto
    from movibanco mb, movipolizas mp
   where mb.movibancoid = pmovibancoid and
         mp.movipolizaid = mb.movipolizaid;

  pmes:=cast(date_part('month',dfecha) as int);
  pdia:=cast(date_part('day',dfecha) as char(2));
  pano:=cast(date_part('year',dfecha) as char(4));

  if pmes=1 then
    psmes := 'Enero     ';
  end if;
  if pmes=2 then
    psmes := 'Febrero   ';
  end if;
  if pmes=3 then
    psmes := 'Marzo     ';
  end if;
  if pmes=4 then
    psmes := 'Abril     ';
  end if;
  if pmes=5 then
    psmes := 'Mayo      ';
  end if;
  if pmes=6 then
    psmes := 'Junio     ';
  end if;
  if pmes=7 then
    psmes := 'Julio     ';
  end if;
  if pmes=8 then
    psmes := 'Agosto    ';
  end if;
  if pmes=9 then
    psmes := 'Septiembre';
  end if;
  if pmes=10 then
    psmes := 'Octubre   ';
  end if;
  if pmes=11 then
    psmes := 'Noviembre ';
  end if;
  if pmes=12 then
    psmes := 'Diciembre ';
  end if;

  select chr(15)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
'                                                                                 San Felipe Gto. a '||pdia||' de '||rtrim(psmes)||' de '||pano||chr(13)||chr(10)||
         chr(13)||chr(10)||
         rpad('                           '||m.beneficiario,80,' ')||'                   '||to_char(fmonto,'99,999,999.99')||
         chr(13)||chr(10)||chr(13)||chr(10)||
         rpad('              '||cletra(fmonto),105,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
' '||substr(m.concepto,1,( case when strpos(m.concepto,'Tasa')-1>0
                                                   then strpos(m.concepto,'Tasa')-1
                                                   else length(m.concepto) end ))||
chr(13)||chr(10)||
substr(m.concepto,strpos(m.concepto,' Tasa'))||' '||pdia||' de '||psmes||' de '||pano||'Cheque: '||m.referenciamovi||'  Poliza: '||to_char(p.numero_poliza,'999999')||chr(13)||chr(10)
    into pformato
    from movibanco m, polizas p
   where m.movibancoid = pmovibancoid and
         p.polizaid = m.polizaid;


   for i in 1..2
   loop
     pformato := pformato||chr(13)||chr(10);
   end loop;


   ptexto := '';
   ldebe  := 0;
   lhaber := 0;
   i := 0;

   for r in
     select c.cuentaid,c.cuentanombre,mp.debe,mp.haber
       from movibanco m, movipolizas mp, catalogo_ctas c
      where m.movibancoid = pmovibancoid and
            mp.polizaid = m.polizaid  and
            c.cuentaid = mp.cuentaid
   loop

     ptexto := ptexto||rpad(r.cuentaid,20,' ')||'    '||rpad(r.cuentanombre,61,' ')||'   '||to_char(r.debe,'9,999,999,999.99')||to_char(r.haber,'9,999,999,999.99')||chr(13)||chr(10);
     ldebe := ldebe + r.debe;
     lhaber := lhaber + r.haber;
     i := i+1;
   end loop;


   ptexto := ptexto||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||'                                                                                        '||to_char(ldebe,'9,999,999,999.99')||to_char(lhaber,'9,999,999,999.99')||chr(13)||chr(10);

   pformato := pformato||ptexto;


--calcular saldos
select '                  '||to_char(sum(debe)-sum(haber),'99,999,999.99')into ptexto 
from solicitudprestamo sop,socio so,movicaja mc, movipolizas mp
where sop.socioid = so.socioid and
      so.socioid = mc.socioid and
      mc.movipolizaid = mp.movipolizaid and
      mc.tipomovimientoid = 'PA' and
      sop.solicitudprestamoid = psolicitudp;
pformato := pformato||ptexto;

if ptexto <>  ' ' then
	pformato := pformato||ptexto;
else
ptexto :='                             0';
	pformato := pformato||ptexto;
end if;


select '                                                   '||to_char(sum(debe)-sum(haber),'99,999,999.99')||chr(13)||chr(10) into ptexto 
from solicitudprestamo sop,socio so,movicaja mc, movipolizas mp
where sop.socioid = so.socioid and
      so.socioid = mc.socioid and
      mc.movipolizaid = mp.movipolizaid and
      mc.tipomovimientoid = 'AA' and
      sop.solicitudprestamoid = psolicitudp;

if ptexto <>  ' ' then
	pformato := pformato||ptexto;
else
ptexto :='                                                          0';
	pformato := pformato||ptexto;
end if;

select chr(13)||chr(10)||'                             '||to_char(sum(debe)-sum(haber),'99,999,999.99') into ptexto 
from solicitudprestamo sop,socio so,movicaja mc, movipolizas mp
where sop.socioid = so.socioid and
      so.socioid = mc.socioid and
      mc.movipolizaid = mp.movipolizaid and
      mc.tipomovimientoid = 'RG' and
      sop.solicitudprestamoid = psolicitudp;

return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.formatovale(integer) OWNER TO sistema;

--
-- Name: fsaldocalculado(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fsaldocalculado(integer) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;
  fsaldo numeric;
begin


select p.montoprestamo-sum(m.haber)
  into fsaldo
  from prestamos p, tipoprestamo tp, movicaja mc, movipolizas m
 where p.prestamoid = pprestamoid and
       tp.tipoprestamoid = p.tipoprestamoid and
       mc.prestamoid = p.prestamoid and
       m.polizaid = mc.polizaid and
       m.cuentaid = tp.cuentaactivo
group by p.saldoprestamo,p.montoprestamo
having p.saldoprestamo<>p.montoprestamo-sum(m.haber);

  fsaldo := coalesce(fsaldo,0);

return fsaldo;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fsaldocalculado(integer) OWNER TO sistema;

--
-- Name: fudi(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION fudi(date, date) RETURNS numeric
    AS $_$
declare
  pfecha1 alias for $1;
  pfecha2 alias for $2;

  udi1 numeric;
  udi2 numeric;
begin



  select valor into udi1 from udis where fecha=pfecha1;
  if pfecha2<'31-05-2006' then
    select valor into udi2 from udis where fecha='31-05-2006';
  else
    select valor into udi2 from udis where fecha=pfecha2;
  end if;

  if udi1<=udi2 then
    return 0;
  else
    return (udi1/udi2)-1;
  end if; 


end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.fudi(date, date) OWNER TO sistema;

--
-- Name: generacaptaciontotal(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generacaptaciontotal(date) RETURNS integer
    AS $_$
declare  

  pfechac alias for $1;
  r record; 

begin

  delete from captaciontotal where fechadegeneracion=pfechac;

  insert into captaciontotal(fechadegeneracion,	sucursal,desctipoinversion,clavesocioint,nombresocio,inversionid,fechainversion, fechavencimiento, tasainteresnormalinversion,	plazo,	deposito,diasvencimiento,formapagorendimiento,intdevmensual,intdevacumulado,saldototal,	saldopromedio,	fechapagoinversion,tipomovimientoid, cuentaid,localidad,socioid,grupo )

  select * from captaciontotalc(pfechac);

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generacaptaciontotal(date) OWNER TO sistema;

--
-- Name: generalavado(date, date, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generalavado(date, date, numeric) RETURNS integer
    AS $_$
declare

  pfechai alias for $1;
  pfechaf alias for $2;
  pmonto  alias for $3;

  r record;
  psucid char(4);

  pCNBVlavadoid           char(10);
  pORGANO_SUPERVISOR      char(6);
  pCLAVE_DEL_SUJETO_OBLIGADO char(6); 
  pLOCALIDAD               char(8);
  pSUCURSAL                char(8);
  pENTIDAD_RFC             char(13);
  pENTIDAD_CURP            char(20);

begin

  select sucid into psucid from empresa where empresaid=1;

  select cnbvlavadoid,organo_supervisor,clave_del_sujeto_obligado,localidad,clavesucursal,entidad_rfc,entidad_curp into pcnbvlavadoid,porgano_supervisor,pclave_del_sujeto_obligado,plocalidad,psucursal,pentidad_rfc,pentidad_curp from cnbvlavado where sucid=psucid;

  if not exists ( select operacionlavadoid from operacionlavado where fechainicial<=pfechai and  fechafinal >= pfechaf) then 

          insert into operacionlavado (fechainicial , fechafinal , tipooperacioninicial , tipo_de_reporte , periodo_del_reporte , folio , organo_supervisor , clave_del_sujeto_obligado , localidad , sucursal , tipo_de_operacion , instrumento_monetario , numero_de_cuenta , monto , moneda , fecha_de_la_operacion , fecha_de_deteccion , nacionalidad , tipodepersona , razonsocial , nombre , apellido_paterno , apellido_materno , rfc , curp , fnacimientoconstitucion , domicilio , colonia , ciudadopoblacion , telefono , actividadeconomica , agenteseg_nombre , agenteseg_paterno , agenteseg_materno , entidad_rfc , entidad_curp , cta_persona_relacionada , numero_per_relacionada , clavedelsujetoobligado , personarel_nombre , personarel_paterno , personarel_materno , descripcion_operacion , razones_inusual_preopupante , reportarautoridad)

          select
  --fechainicial            date,
  pfechai,
  --fechafinal              date,
  pfechaf,
  --tipooperacioninicial    char(1)
  '0', 
  --TIPO_DE_REPORTE         char(1),
  '0',
  --PERIODO_DEL_REPORTE     char(8),
  to_char(pfechaf,'yyyymmdd'),
  --FOLIO                   integer,
  1,
  --ORGANO_SUPERVISOR       char(6),
  pORGANO_SUPERVISOR,
  --CLAVE_DEL_SUJETO_OBLIGADO char(6),
  pCLAVE_DEL_SUJETO_OBLIGADO,
  pLOCALIDAD,
  pSUCURSAL,
  --TIPO_DE_OPERACIoN       char(2),
  '01',
  --INSTRUMENTO_MONETARIO   char(2),
  '01',
  --NUMERO_DE_CUENTA        char(16),
  s.clavesocioint,
  --MONTO                   numeric,
  mp.haber+mp.debe as monto,  
  --MONEDA                  char(3),
  'MNX',
  --FECHA_DE_LA_OPERACIoN   char(8),
  to_char(po.fechapoliza,'yyyymmdd'),
  --FECHA_DE_DETECCION      char(8),
  to_char(pfechaf,'yyyymmdd'),  
  --NACIONALIDAD            char(1),
  '1',
  --TIPODEPERSONA           char(1),
  (case when si.personajuridicaid = 1 then '2' else '1' end) as  tipodepersona,
  --RAZONSOCIALO            char(60),
  su.razonsocial,
  --NOMBRE                  char(60),
  su.nombre,
  --APELLIDO_PATERNO        char(60),
  su.paterno,
  --APELLIDO_MATERNO        char(60),
  su.materno,
  --RFC                     char(13),
  substring(su.rfc,1,13),
  --CURP                    char(20),
  su.curp,
  --FNACIMIENTOCONSTITUCION char(8),
   to_char(su.fecha_nacimiento,'yyyymmdd'),
  --DOMICILIO               char(60),
  d.calle||' '||d.numero_ext as domicilio,
  --COLoNIA                 char(30),
  c.nombrecolonia,
  --CIUDADOPOBLACION        char(8),
  --to_char(cm.ciudadmexid,'999999'),
  '',
  --TELEFONO                char(40),
  d.teldomicilio,
  --ACTIVIDADECONOMICA      char(7),
  --cc.actividad,
  '',
  --AGENTESEG_NOMBRE        char(60),
  '',
  --AGENTESEG_PATERNO       char(60),
  '',
  --AGENTESEG_MATERNO       char(60),
  '',
  pENTIDAD_RFC,
  pENTIDAD_CURP,  
  --CTA_PERSONA_RELACIONADA
  1,
  --NUMERO_PER_RELACIONADA
  '',
  --CLAVEDELSUJETOOBLIGADO  char(6),
  pCLAVE_DEL_SUJETO_OBLIGADO,
  --PERSONAREL_NOMBRE       char(30),
  '',
  --PERSONAREL_PATERNO      char(30),
  '',
  --PERSONAREL_MATERNO      char(30),
  '',
  --Descripcion_operacion   text,
  '',
  --RAZONES_inusual_preopupante text,
  '',
  --reportarautoridad       char(1)
  'N'

          from socio s, sujeto su, conoceatucliente cc, domicilio d, solicitudingreso si,
               movicaja m, polizas po, movipolizas mp, tipomovimiento tm, colonia c, ciudadesmex cm
         where m.socioid = s.socioid and
               su.sujetoid = s.sujetoid and
               su.sujetoid = cc.sujetoid and
               su.sujetoid = si.sujetoid and 
               d.sujetoid = s.sujetoid and
               c.coloniaid = d.coloniaid and
               cm.ciudadmexid=d.ciudadmexid and      
               m.tipomovimientoid in ( 'AA','CU','IN','00','RM') and
               m.efectivo=1 and
               tm.tipomovimientoid = m.tipomovimientoid and
               po.polizaid = m.polizaid and
               po.fechapoliza between pfechai and pfechaf and
               mp.polizaid = po.polizaid and
               mp.cuentaid = tm.cuentadeposito and 
               (mp.haber>pmonto or mp.debe>pmonto)

        order by s.clavesocioint,po.fechapoliza ;

end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generalavado(date, date, numeric) OWNER TO sistema;

--
-- Name: generalavado(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generalavado(integer) RETURNS integer
    AS $_$ 
declare 
 
  pmovicajaid alias for $1; 
 
  r record; 
  psucid char(4);
  preferenciacaja  integer;
  pseriecaja       char(2);
 
  pCNBVlavadoid           char(10); 
  pORGANO_SUPERVISOR      char(6); 
  pCLAVE_DEL_SUJETO_OBLIGADO char(6);  
  pLOCALIDAD               char(8); 
  pSUCURSAL                char(8); 
  pENTIDAD_RFC             char(13); 
  pENTIDAD_CURP            char(20); 
 
begin 
 
  select sucid into psucid from empresa where empresaid=1;
  
  select referenciacaja,seriecaja into preferenciacaja,pseriecaja from movicaja where movicajaid=pmovicajaid;
 
  select cnbvlavadoid,organo_supervisor,clave_del_sujeto_obligado,localidad,clavesucursal,entidad_rfc,entidad_curp into pcnbvlavadoid,porgano_supervisor,pclave_del_sujeto_obligado,plocalidad,psucursal,pentidad_rfc,pentidad_curp from cnbvlavado where sucid=psucid;

  if not exists (select movicajaid from operacionlavado where movicajaid=pmovicajaid) then
 
        insert into operacionlavado (fechainicial , fechafinal , tipooperacioninicial , tipo_de_reporte , periodo_del_reporte , folio , organo_supervisor , clave_del_sujeto_obligado , localidad , sucursal , tipo_de_operacion , instrumento_monetario , numero_de_cuenta , monto , moneda , fecha_de_la_operacion , fecha_de_deteccion , nacionalidad , tipodepersona , razonsocial , nombre , apellido_paterno , apellido_materno , rfc , curp , fnacimientoconstitucion , domicilio , colonia , ciudadopoblacion , telefono , actividadeconomica , agenteseg_nombre , agenteseg_paterno , agenteseg_materno , entidad_rfc , entidad_curp , cta_persona_relacionada , numero_per_relacionada , clavedelsujetoobligado , personarel_nombre , personarel_paterno , personarel_materno , descripcion_operacion , razones_inusual_preopupante , reportarautoridad,movicajaid) 
 
        select 
  --fechainicial            date, 
  po.fechapoliza, 
  --fechafinal              date, 
  po.fechapoliza, 
  --tipooperacioninicial    char(1) 
  '0',  
  --TIPO_DE_REPORTE         char(1), 
  '0', 
  --PERIODO_DEL_REPORTE     char(8), 
  to_char(po.fechapoliza,'yyyymmdd'), 
  --FOLIO                   integer, 
  1, 
  --ORGANO_SUPERVISOR       char(6), 
  pORGANO_SUPERVISOR, 
  --CLAVE_DEL_SUJETO_OBLIGADO char(6), 
  pCLAVE_DEL_SUJETO_OBLIGADO, 
  pLOCALIDAD, 
  pSUCURSAL, 
  --TIPO_DE_OPERACIoN       char(2), 
  '01', 
  --INSTRUMENTO_MONETARIO   char(2), 
  '01', 
  --NUMERO_DE_CUENTA        char(16), 
  s.clavesocioint, 
  --MONTO                   numeric, 
  (select coalesce(round(sum(valor),2),0) from sabana where referenciacaja =preferenciacaja and seriecaja=pseriecaja and entradasalida=0) as monto,   
  --MONEDA                  char(3), 
  'MNX', 
  --FECHA_DE_LA_OPERACIoN   char(8), 
  to_char(al.fecha_operacion,'yyyymmdd'), 
  --FECHA_DE_DETECCION      char(8), 
  to_char(al.fecha_deteccion,'yyyymmdd'),   
  --NACIONALIDAD            char(1), 
  '1', 
  --TIPODEPERSONA           char(1), 
  (case when si.personajuridicaid = 1 then '2' else '1' end) as  tipodepersona, 
  --RAZONSOCIALO            char(60), 
  su.razonsocial, 
  --NOMBRE                  char(60), 
  su.nombre, 
  --APELLIDO_PATERNO        char(60), 
  su.paterno, 
  --APELLIDO_MATERNO        char(60), 
  su.materno, 
  --RFC                     char(13), 
  substring(su.rfc,1,13), 
  --CURP                    char(20), 
  su.curp, 
  --FNACIMIENTOCONSTITUCION char(8), 
   to_char(su.fecha_nacimiento,'yyyymmdd'), 
  --DOMICILIO               char(60), 
  d.calle||' '||d.numero_ext as domicilio, 
  --COLoNIA                 char(30), 
  c.nombrecolonia, 
  --CIUDADOPOBLACION        char(8), 
  --to_char(cm.ciudadmexid,'999999'), 
  '', 
  --TELEFONO                char(40), 
  d.teldomicilio, 
  --ACTIVIDADECONOMICA      char(7), 
  --cc.actividad, 
  '', 
  --AGENTESEG_NOMBRE        char(60), 
  '', 
  --AGENTESEG_PATERNO       char(60), 
  '', 
  --AGENTESEG_MATERNO       char(60), 
  '', 
  pENTIDAD_RFC, 
  pENTIDAD_CURP,   
  --CTA_PERSONA_RELACIONADA 
  1, 
  --NUMERO_PER_RELACIONADA 
  '', 
  --CLAVEDELSUJETOOBLIGADO  char(6), 
  pCLAVE_DEL_SUJETO_OBLIGADO, 
  --PERSONAREL_NOMBRE       char(30), 
  '', 
  --PERSONAREL_PATERNO      char(30), 
  '', 
  --PERSONAREL_MATERNO      char(30), 
  '', 
  --Descripcion_operacion   text, 
  al.observaciones, 
  --RAZONES_inusual_preopupante text, 
  '', 
  --reportarautoridad       char(1) 
  'N',
  pmovicajaid
 
          from movicaja m, socio s, sujeto su, conoceatucliente cc, domicilio d, solicitudingreso si, colonia c, ciudadesmex cm, polizas po, alertasprevencion al
         where m.referenciacaja = preferenciacaja and m.seriecaja=pseriecaja and           
               m.socioid = s.socioid and 
               su.sujetoid = s.sujetoid and 
               su.sujetoid = cc.sujetoid and 
               su.sujetoid = si.sujetoid and  
               d.sujetoid = s.sujetoid and 
               c.coloniaid = d.coloniaid and 
               cm.ciudadmexid=d.ciudadmexid and
               po.polizaid = m.polizaid and
               al.movicajaid = m.movicajaid;
                     
   end if;     
 
return 1; 
end 
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generalavado(integer) OWNER TO sistema;

--
-- Name: generalsocios(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generalsocios(date) RETURNS SETOF rgeneralsocios
    AS $_$
declare

  r rgeneralsocios%rowtype;
  pfechac alias for $1;

  f record;

begin

    for r in

        select

        s.clavesocioint,
        si.grupo,
        s.tiposocioid,
        (case when si.personajuridicaid= 0 then 'FISICA' else 'MORAL' end) as  personajuridica, 
        ltrim(su.nombre)||' '||ltrim(su.paterno)||' '||ltrim(su.materno),
        (select sucid from empresa where empresaid=1) as sucursal,
        d.calle||d.numero_ext as direccion,
        col.nombrecolonia,
        d.comunidad,
        cd.nombreciudadmex,
        --claveestadoconapo character varying(10),
        (select substring(claveconapo,1,2) from comunidadconapo where claveconapo=ce.comunidadconapo) ,
        --clavemunicipioconapo character varying(10),
        ' '||(select substring(claveconapo,3,3) from comunidadconapo where claveconapo=ce.comunidadconapo),
        --clavelocalidadconapo char(10),
        (select claveconapo from comunidadconapo where claveconapo=ce.comunidadconapo),
        (select nombremun from comunidadconapo where claveconapo=ce.comunidadconapo),
        --localidadconapo character varying(50),
        (select nombre from comunidadconapo where claveconapo=ce.comunidadconapo),        
        sum(sd.PA) as parteadicional,
        sum(sd.PB) as partesocial,
        sum(sd.P3) as partep3,
        si.profesion,
        si.ocupacion,
        (case when si.sexo= 0 then 'Masculino' else 'Femenino' end) as  sexo,
        su.fecha_nacimiento,
        estadocivil(si.estadocivilid) as estadocivil,
        s.fechaalta,
        (select poblacion from comunidadconapo where claveconapo=ce.comunidadconapo),
        (select marginacion from comunidadconapo where claveconapo=ce.comunidadconapo),
        ce.poblacionindigena,
        sum(sd.ahorro) as saldoahorro,
        (select max(p.fechapoliza) from movicaja mc, polizas p where mc.socioid=s.socioid and mc.tipomovimientoid in
        ('AO','AC','AA','AF','AP') and mc.polizaid=p.polizaid and p.tipo <> 'W' and p.fechapoliza < pfechac+1 ),
        sum(sd.plazofijo) as plazofijo,
        (select max(p.fechapoliza) from movicaja mc, polizas p where mc.socioid=s.socioid and mc.tipomovimientoid ='IN' and mc.polizaid=p.polizaid and p.fechapoliza < pfechac+1 ),
trunc((pfechac-su.fecha_nacimiento)/365) as edad

        from socio s, sujeto  su, solicitudingreso si, domicilio d, colonia col, ciudadesmex cd, conoceatucliente ce,

        (select mc.socioid, sum(mp.debe)-sum(mp.haber) as PA,0 as PB,0 as P3, 0 as ahorro, 0 as plazofijo, 0 as prestamo, 0 as prestamoid from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid='PA' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1  group by mc.socioid  union 

        select mc.socioid,0 as PA, sum(mp.debe)-sum(mp.haber) as PB,0 as P3,0 as ahorro, 0 as plazofijo,0 as prestamo,0 as prestamoid from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid='PB' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid union

 select mc.socioid,0 as PA,0 as PB , sum(mp.debe)-sum(mp.haber) as P3,0 as ahorro, 0 as plazofijo,0 as prestamo,0 as prestamoid from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid='P3' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid union

        select mc.socioid,0 as PA,0 as PB,0 as P3,sum(mp.debe)-sum(mp.haber) as ahorro,0 as plazofijo,0 as prestamo,0 as prestamoid from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid in ('AO','AC','AA','AF','AP') and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid union

        select mc.socioid,0 as PA,0 as PB,0 as P3,0 as ahorro,sum(mp.haber)-sum(mp.debe) as plazofijo,0 as prestamo,0 as prestamoid from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mc.polizaid=mp.polizaid and mp.cuentaid=tm.cuentadeposito and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid='IN' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid) sd

        where s.fechaalta < pfechac+1 and  s.sujetoid=su.sujetoid and s.socioid=si.socioid and s.socioid=sd.socioid and d.sujetoid=su.sujetoid and d.coloniaid=col.coloniaid and col.ciudadmexid=cd.ciudadmexid and su.sujetoid = ce.sujetoid  
 
        group by  s.clavesocioint,si.grupo,s.tiposocioid,si.personajuridicaid,ltrim(su.nombre)||' '||ltrim(su.paterno)||' '||ltrim(su.materno),s.fechaalta,col.coloniaid,d.calle,d.numero_ext,d.comunidad,col.nombrecolonia,cd.nombreciudadmex,si.profesion,si.ocupacion,su.fecha_nacimiento,s.socioid,si.sexo,si.estadocivilid,si.profesion,ce.poblacionindigena,ce.comunidadconapo order by s.clavesocioint

        loop
            
            return next r;

        end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generalsocios(date) OWNER TO sistema;

--
-- Name: generalsociosc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generalsociosc(date) RETURNS SETOF rgeneralsocios
    AS $_$
declare

  r rgeneralsocios%rowtype;

  pfechai alias for $1;
  f record;

  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
        dblink2:='set search_path to public,'||f.esquema||';select * from  generalsocios('||''''||pfechai||''''||');';

--        raise notice 'dblink % % ',dblink1,dblink2;

        for r in
        SELECT * FROM
        dblink(dblink1,dblink2) as
               t2(
        clavesocioint character(15),
        grupo character(25),
        tiposocioid character(2),
        personajuridica character(10),
	nombre character varying(80),
	sucursal character(4),        
        direccion character varying(80),
        colonia character varying(50),
        comunidadmigrada character varying(50),
        ciudadsepomex  character varying(50),       
        claveestadoconapo character varying(10),
        clavemunicipioconapo character varying(10),
        clavelocalidadconapo char(10),
        municipioconapo character varying(100),
        localidadconapo character varying(100),
        Parte_Social_PA numeric,
        Parte_Adicional_PB numeric,
        Parte_P3 numeric,
        profesion character varying(40),
        ocupacion character varying(40),
        sexo character(15),
        fecha_nacimiento date,
        estado_civil character(15),
        fechaingreso date,
        numerohabitantes integer,
	GRADO_DE_MARGINACIoN character(15),
        POBLACIoN_INDiGENA char(2),
        SALDO_PROMEDIO_AHORRO numeric,
        fechaultimoahorro date,
        SALDO_PROMEDIO_inver numeric,
        fechaultimoinversion date,
	edad integer)

        loop
                return next r;
        end loop;

 end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generalsociosc(date) OWNER TO sistema;

--
-- Name: generaramortizaciones(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generaramortizaciones(character) RETURNS integer
    AS $_$
declare
 
  preferenciaprestamo alias for $1;
  x record;
  r tablaamor%rowtype;

  lamortizacionid int4;
begin

  for x in
    select * from prestamos where referenciaprestamo=preferenciaprestamo
  loop
      for r in
        select * from
           sptablaamor(x.montoprestamo,x.fecha_1er_pago,x.tipoprestamoid,x.numero_de_amor,
                       x.dias_de_cobro,x.meses_de_cobro,x.dia_mes_cobro,x.fecha_otorga)
      loop
         select * into lamortizacionid
           from spiamortizacion(x.prestamoid,r.numamortizacion,r.fechadepago,r.importeamortizacion,
                                r.interesnormal,r.saldo_absoluto,'001',r.interesnormal,0,x.fecha_otorga);
      end loop;
      
  end loop;


return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.generaramortizaciones(character) OWNER TO sistema;

--
-- Name: generaramortizaciones(character, numeric, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generaramortizaciones(character, numeric, date) RETURNS integer
    AS $_$
declare
 
  preferenciaprestamo alias for $1;
  pabono alias for $2;
  pultimopago alias for $3;
  x record;
  r tablaamor%rowtype;
  amor amortizaciones%rowtype;

  lamortizacionid int4;
  fAbono numeric;
  fAplicar numeric;
  pprestamoid int4;
begin

  select prestamoid into pprestamoid from prestamos where referenciaprestamo=preferenciaprestamo;
  delete from amortizaciones where prestamoid=pprestamoid;

  for x in
    select * from prestamos where referenciaprestamo=preferenciaprestamo
  loop
      for r in
        select * from
           sptablaamor(x.montoprestamo,x.fecha_1er_pago,x.tipoprestamoid,x.numero_de_amor,
                       x.dias_de_cobro,x.meses_de_cobro,x.dia_mes_cobro,x.fecha_otorga,x.tasanormal)
      loop
         select * into lamortizacionid
           from spiamortizacion(x.prestamoid,r.numamortizacion,r.fechadepago,r.importeamortizacion,
                                r.interesnormal,r.saldo_absoluto,'001',0,0,x.fecha_otorga,r.iva,r.pagototal);
      end loop;
      
  end loop;

 if pabono>0 then
    fAbono := pabono;
    --select prestamoid into pprestamoid from prestamos where referenciaprestamo=preferenciaprestamo;
    for amor in
        select *
          from amortizaciones
         where prestamoid=pprestamoid and importeamortizacion-abonopagado>0
      order by fechadepago
    loop

      fAplicar := amor.importeamortizacion - amor.abonopagado;

      if fAbono>=fAplicar then
        update amortizaciones
           set abonopagado = importeamortizacion,
               ultimoabono = pultimopago,
               claveestadocredito = '002'
         where amortizacionid=amor.amortizacionid;
         fAbono := fAbono - fAplicar;
      else
        if fAbono>0 then
          update amortizaciones
             set abonopagado = abonopagado+fAbono,
                 ultimoabono = pultimopago
           where amortizacionid=amor.amortizacionid;
           fAbono := 0;
        end if;
      end if;
    end loop;
  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generaramortizaciones(character, numeric, date) OWNER TO sistema;

--
-- Name: generarfc(character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generarfc(character, character, character, character) RETURNS character
    AS $_$
declare
  ppaterno alias for $1;
  pmaterno alias for $2;
  pnombre  alias for $3;
  pfecha alias for $4;
  plargo integer;
  cvocal integer;
  dospaterno char(2);
  cletra char(1);

begin

  cvocal:=2;
  plargo:= char_length(ppaterno);
  while cvocal <= plargo loop
     cletra:= substring(upper(ppaterno),cvocal,1);
     if cletra = 'A' or cletra = 'E' or cletra = 'I' or cletra = 'O' or cletra = 'U' then
        cvocal:= plargo +1;
     else
        cletra:= substring(upper(ppaterno),2,1);
     end if;
     cvocal:=cvocal+1;
  end loop;
  
 return substring(upper(ppaterno),1,1)||cletra||substring(upper(pmaterno),1,1)||substring(upper(pnombre),1,1)||substr(pfecha,9,2)||substr(pfecha,4,2)||substr(pfecha,1,2);

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generarfc(character, character, character, character) OWNER TO sistema;

--
-- Name: generasaldos(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generasaldos(integer, integer) RETURNS integer
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo alias for $2;
  
begin
 
delete from saldos where periodo=pperiodo and ejercicio=pejercicio; 

insert into saldos (saldoid,ejercicio,periodo,cuentaid,saldoinicialperiodo,cargosdelperiodo,abonosdelperiodo)
select nextval('saldos_saldoid_seq'),pejercicio,pperiodo,b.cuentaid,b.saldo_inic_ejer,b.cargos_acum_ejer,b.abonos_acum_ejer from (select cuentaid,sum(saldo_inic_ejer) as saldo_inic_ejer,sum(cargos_acum_ejer) as cargos_acum_ejer,sum(abonos_acum_ejer) as abonos_acum_ejer from balanza('1-  -  -  -  -  -       ','999999999999999',pejercicio,pperiodo) where cuentaid<>'T' group by cuentaid) as b;

update periodo set estatus='C' where ejercicio=pejercicio and periodo=pperiodo;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generasaldos(integer, integer) OWNER TO sistema;

--
-- Name: generasocio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generasocio(integer) RETURNS integer
    AS $_$
declare

  lnosolicitud alias for $1;
  sclavesocioint char(15);
  lsocioid int4;

  lsujetoid int4;
  stiposocioid char(2);
  lsolicitudingresoid int4;
  fsocioid int4;
begin
  select coalesce(socioid,0)
    into fsocioid
    from solicitudingreso
   where nosolicitud=lnosolicitud;

  if fsocioid=0 then

    select sujetoid,tiposocioid,solicitudingresoid
      into lsujetoid,stiposocioid,lsolicitudingresoid
      from solicitudingreso
     where nosolicitud=lnosolicitud;

    if stiposocioid='01' then
      select nextsociom()
        into sclavesocioint;
    else
      select nextsocio()
        into sclavesocioint;
    end if;

    -- Insertar el socio
    select * into lsocioid from
     spisocio(lsocioid,lsujetoid,stiposocioid,sclavesocioint,CURRENT_DATE,NULL,1,lsolicitudingresoid);

    update solicitudingreso
       set socioid=lsocioid
     where nosolicitud=lnosolicitud;
  else
    lsocioid := fsocioid;
  end if;
return lsocioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generasocio(integer) OWNER TO sistema;

--
-- Name: generasocio(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generasocio(integer, character) RETURNS integer
    AS $_$
declare

  lnosolicitud alias for $1;
  pclavesocioint alias for $2;
  sclavesocioint char(15);
  lsocioid int4;

  lsujetoid int4;
  stiposocioid char(2);
  lsolicitudingresoid int4;
  fsocioid int4;

  sgenerasocio char(1);

  stmp varchar;
begin

  select generasocio into sgenerasocio
   from empresa where empresaid=1;

if sgenerasocio='S' then

  select coalesce(socioid,0)
    into fsocioid
    from solicitudingreso
   where nosolicitud=lnosolicitud;

  raise notice 'SocioID %',fsocioid;

  if fsocioid=0 then

    raise notice 'Empieza la generacion ';

    select sujetoid,tiposocioid,solicitudingresoid
      into lsujetoid,stiposocioid,lsolicitudingresoid
      from solicitudingreso
     where nosolicitud=lnosolicitud;

     if stiposocioid='01' then
       select nextsociom()
         into sclavesocioint;
     else
       raise notice 'Generando socio ...';
       select nextsocio()
         into sclavesocioint;
     end if;

     -- Insertar el socio
     select * into lsocioid from
       spisocio(lsocioid,lsujetoid,stiposocioid,sclavesocioint,
                CURRENT_DATE,NULL,1,lsolicitudingresoid,NULL);

     update solicitudingreso
        set socioid=lsocioid
      where nosolicitud=lnosolicitud;
  else
      lsocioid := fsocioid;
  end if;
else

  stmp := ltrim(rtrim(pclavesocioint));  
  if char_length(stmp)>8 then

    -- No lo genera automaticamente
    select coalesce(max(socioid),0)
      into fsocioid
      from socio
     where clavesocioint=pclavesocioint;

    if fsocioid=0 then
      select sujetoid,tiposocioid,solicitudingresoid
        into lsujetoid,stiposocioid,lsolicitudingresoid
        from solicitudingreso
       where nosolicitud=lnosolicitud;


      -- Insertar el socio
       select * into lsocioid from
         spisocio(lsocioid,lsujetoid,stiposocioid,pclavesocioint,
                  CURRENT_DATE,NULL,1,lsolicitudingresoid,NULL);

       update solicitudingreso
          set socioid=lsocioid
        where nosolicitud=lnosolicitud; 

    else
      raise exception 'La clave % ya existe asignada a otro socio!',pclavesocioint;
    end if;
  else
    raise exception 'La clave % proporcionada es incorrecta!',pclavesocioint;
  end if;

end if;




return lsocioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generasocio(integer, character) OWNER TO sistema;

--
-- Name: generasociocp(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION generasociocp(integer, character) RETURNS integer
    AS $_$
declare

  lnosolicitud alias for $1;
  pclavesocioint alias for $2;
  sclavesocioint char(15);
  lsocioid int4;

  lsujetoid int4;
  stiposocioid char(2);
  lsolicitudingresoid int4;
  fsocioid int4;

  sgenerasocio char(1);

  stmp varchar;
begin

  select generasocio
    into sgenerasocio
    from empresa where empresaid=1;

if sgenerasocio='S' then

  select coalesce(socioid,0)
    into fsocioid
    from solicitudingreso
   where nosolicitud=lnosolicitud;

  if fsocioid=0 then

    select sujetoid,tiposocioid,solicitudingresoid
      into lsujetoid,stiposocioid,lsolicitudingresoid
      from solicitudingreso
     where nosolicitud=lnosolicitud;

    select nextsocio()
      into sclavesocioint;

     -- Insertar el socio
     select * into lsocioid from
       spisocio(lsocioid,lsujetoid,stiposocioid,sclavesocioint,
                CURRENT_DATE,NULL,1,lsolicitudingresoid);

     update solicitudingreso
        set socioid=lsocioid
      where nosolicitud=lnosolicitud;

  else
      lsocioid := fsocioid;
  end if;


end if;


return lsocioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.generasociocp(integer, character) OWNER TO sistema;

--
-- Name: historialprestamo(character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION historialprestamo(character, character, date) RETURNS SETOF rhistoricoabono
    AS $_$
declare
  pclavesocioint alias for $1;
  preferenciaprestamo alias for $2;
  pfecha alias for $3;
  r rhistoricoabono%rowtype;
begin
  for r in
select m.referenciacaja,m.seriecaja,po.numero_poliza,m.tipomovimientoid,po.fechapoliza,
       po.concepto_poliza,c.cuentanombre, mp.debe, mp.haber
  from movicaja m, polizas po, movipolizas mp, prestamos p, catalogo_ctas c
 where p.referenciaprestamo=preferenciaprestamo and
       m.prestamoid=p.prestamoid and
       po.polizaid=m.polizaid and
       mp.polizaid=po.polizaid and
       c.cuentaid=mp.cuentaid and
       po.fechapoliza<=pfecha
order by po.fechapoliza  
  loop
    return next r;
  end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.historialprestamo(character, character, date) OWNER TO sistema;

--
-- Name: historicodefault(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION historicodefault(integer) RETURNS text
    AS $_$
declare
  pclave alias for $1;
  stexto text;
begin

  select historico
    into stexto
    from empresa
   where empresaid=1;

return stexto;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.historicodefault(integer) OWNER TO sistema;

--
-- Name: ide(integer, date, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION ide(integer, date, numeric) RETURNS numeric
    AS $_$
declare
 lsocioid alias for $1;
 dfecha alias for $2;
 fdeposito alias for $3;

 iaplicar int4;
 iano int4;
 imes int4;
 fefectivo numeric;

 iide int4;
 fmontoide numeric;
 fide numeric;

begin

 select ide,montoide
   into iide,fmontoide
   from empresa
  where empresaid=1;

 iano:=date_part('year',dfecha);
 imes:= date_part('month',dfecha);

 iaplicar:=0;

 select sum(efectivo)
   into fefectivo
   from movicaja
  where socioid=lsocioid and
        tipomovimientoid in ('PA','AM','AF','AA','AI','AO','IN','AP') and
        date_part('year',fechahora)=iano and
        date_part('month',fechahora)=imes and
        movimiento='D' and seriecaja<>'ZA';

  fide:=0;
  fefectivo:=coalesce(fefectivo,0.00);

  if iide=1 and fefectivo+fdeposito>fmontoide then

    if fefectivo>fmontoide then
      fide:=round(fdeposito*0.02,2);
    else
      fide:=round((fefectivo+fdeposito-fmontoide)*0.02,2);
    end if;

  end if;

return fide;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.ide(integer, date, numeric) OWNER TO sistema;

--
-- Name: iderecaudado(integer, date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION iderecaudado(integer, date, date) RETURNS numeric
    AS $_$
declare
  psocioid alias for $1;
  pfechai alias for $2;
  pfechaf alias for $3;

  fiderecaudado numeric;
begin

  select sum(mp.haber)
    into fiderecaudado
    from movicaja mc, movipolizas mp, tipomovimiento t
   where mc.socioid = psocioid  and
         mc.fechahora between pfechai + interval '0 hours' and pfechaf + interval '23:59:59' and
         mp.polizaid = mc.polizaid and
         mc.tipomovimientoid in ('PA','AM','AF','AA','AI','AO','IN','AP') and
         t.tipomovimientoid = mc.tipomovimientoid and
         mp.cuentaid = t.cuentaivamovimiento;
   fiderecaudado:=coalesce(fiderecaudado,0);

return fiderecaudado;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.iderecaudado(integer, date, date) OWNER TO sistema;

--
-- Name: ideretenido(character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION ideretenido(character, date) RETURNS numeric
    AS $_$
declare
 sserie alias for $1;
 dfecha alias for $2;

 fideretenido numeric;

begin

 select sum(mp.haber)
   into fideretenido
   from movicaja mc, movipolizas mp, tipomovimiento t
  where (mc.seriecaja=sserie or sserie='  ') and
        mc.fechahora between dfecha + interval '0 hours' and dfecha + interval '23:59:59' and
        mp.polizaid = mc.polizaid and
        t.tipomovimientoid= mc.tipomovimientoid and
        t.tipomovimientoid in ('PA','AM','AF','AA','AI','AO','IN','AP') and
        mp.cuentaid=t.cuentaivamovimiento;

 fideretenido:=coalesce(fideretenido,0.00);

return fideretenido;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.ideretenido(character, date) OWNER TO sistema;

--
-- Name: imp_alapalabra(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION imp_alapalabra() RETURNS integer
    AS $$
declare

  i int4;
  l int4;
  s int4;
  d int4;
  lsocioid int4;

  r record;

  scuentaabono char(24);
  scuentacargo char(24);

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;

  sclavesocioint char(15);

  lsujetoid int4;
begin

 select cuentadeposito
   into scuentaabono
   from tipomovimiento
  where tipomovimientoid='AP';

 scuentacargo:='2-03-04-01-  -  -       ';

 -- Insertar socios

 for r in
   select paterno,materno,nombre,cantidad,municipio,localidad
     from apalabra
    where cantidad>0
 loop

-- Verificar si ya existe el sujeto

   select MIN(sujetoid) into lsujetoid
    from sujeto
   where upper(rtrim(paterno))=upper(rtrim(r.paterno)) and
         upper(rtrim(materno))=upper(rtrim(r.materno)) and
         upper(rtrim(nombre))=upper(rtrim(r.nombre));

   lsujetoid := coalesce(lsujetoid,0);

   if lsujetoid=0 then
     select * into s from
       spisujeto(r.paterno,r.materno,r.nombre,'.','.',1,current_date,'.');

     select * into d from
       spidomicilio(9,s,'.','.','.',r.localidad,1,r.municipio,'.');
   else
     s:=lsujetoid;
   end if;

   select socioid
     into lsocioid
     from socio
    where sujetoid=lsujetoid;

   if NOT FOUND then

     select * into i from
       spisolicitudingreso(0,CURRENT_DATE,CURRENT_DATE,
                           NULL,s,9,0,0,
                           ' ',' ',0,0,NULL,
                           0,' ',0,
                           0,0,' ',' ',
                           ' ',NULL,'supervisor','supervisor',
                           current_date,'02',' ');

     select * into lsocioid from
       generasociocp(nosolicitudi(i),'');
   
     raise notice 'Insertando % %',i,lsocioid;

   end if;

   select clavesocioint
     into sclavesocioint
     from socio
    where socioid=lsocioid;

   -- Insertar movimientos de caja
   
   --
   -- Dar de alta la poliza contable
   --

  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',CURRENT_DATE) as int),cast(date_part('month',CURRENT_DATE) as int),'K','ZA','D');

  -- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipoliza(preferencia,'ZA','K',pnumero_poliza,cast(date_part('year',CURRENT_DATE) as int),cast(date_part('month',CURRENT_DATE) as int),' ',CURRENT_DATE,'D',' ',' ',substr(sclavesocioint,1,12)||' '||r.paterno||' '||r.materno||' '||r.nombre,CURRENT_DATE);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacargo,' ','C',r.cantidad,0,' ',' ',substr(substr(sclavesocioint,1,12)||' '||r.paterno||' '||r.materno||' '||r.nombre,1,29));

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentaabono,' ','A',0,r.cantidad,' ',' ',substr(substr(sclavesocioint,1,12)||' '||r.paterno||' '||r.materno||' '||r.nombre,1,29));

   -- Movimiento de caja

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = 'ZA';

   lreferenciacaja := lreferenciacaja+1;   

   select *
     into pmovicajaid
     from spimovicaja(lsocioid,'AP',ppolizaid,lreferenciacaja,'ZA',pmovipolizaid,NULL,'A',NULL);


 end loop;

 delete from apalabra;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.imp_alapalabra() OWNER TO sistema;

--
-- Name: imp_movimiento(character, character varying, character, date, numeric, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION imp_movimiento(character, character varying, character, date, numeric, character) RETURNS integer
    AS $_$
declare

  sclavesocioint alias for $1;
  sref alias for $2;
  stipomovimientoid alias for $3;
  xfecha alias for $4;
  fimporte alias for $5;
  sserie alias for $6;

  lsocioid int4;

  scuentaabono char(24);
  scuentacargo char(24);

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;


  dfecha date;
begin

  dfecha:=current_date;
--dfecha:=xfecha;


 select socioid
   into lsocioid
   from socio
  where clavesocioint=sclavesocioint;

  if NOT FOUND then
    --raise exception 'La clave % no existe !!!',sclavesocioint;
    -- regresar 0 para que no truene
    return 0;
  end if;

 select cuentacaja
   into scuentacargo
   from parametros
  where serie_user=sserie;

 select cuentadeposito
   into scuentaabono
   from tipomovimiento
  where tipomovimientoid=stipomovimientoid;



  raise notice 'SocioID==%',lsocioid;

   -- Insertar movimientos de caja
   
   --
   -- Dar de alta la poliza contable
   --

  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',dfecha) as int),cast(date_part('month',dfecha) as int),'K',sserie,'D');

  -- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipoliza(preferencia,sserie,'K',pnumero_poliza,cast(date_part('year',dfecha) as int),cast(date_part('month',dfecha) as int),' ',dfecha,'D',' ',' ','Mov. Importado socio: '||sclavesocioint,dfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacargo,' ','C',fimporte,0,' ',' ','A la Palabra '||sclavesocioint);

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentaabono,' ','A',0,fimporte,' ',' ','A la Palabra '||sclavesocioint);

   -- Movimiento de caja

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie;

   lreferenciacaja := lreferenciacaja+1;   
 
   select *
     into pmovicajaid
     from spimovicaja(lsocioid,stipomovimientoid,ppolizaid,lreferenciacaja,sserie,pmovipolizaid,NULL,'A',NULL,NULL,0.00);


return pmovicajaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.imp_movimiento(character, character varying, character, date, numeric, character) OWNER TO sistema;

--
-- Name: imp_pagoprestamo(character, character, numeric, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION imp_pagoprestamo(character, character, numeric, date, character) RETURNS integer
    AS $_$
declare

  sclavesocioint alias for $1;
  sref alias for $2;
  fimporte alias for $3;
  dfecha alias for $4;
  sserie_user alias for $5;

  lsocioid int4;
  lprestamoid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;


  r tcalculopago%rowtype; 

  psaldoactual numeric;

  fcapital numeric;
  finteres numeric;
  fmoratorio numeric;
  fiva numeric;
  ftotal numeric;
  fAbono numeric;
  fAplicar numeric;

  scuentaactivo char(24);
  scuentaintnormal char(24);
  scuentaiva char(24);
  scuentaintmora char(24);
  scuentacaja char(24);

  stipoprestamoid char(3);

  amor record;

  sreferenciaprestamo char(18);
  fsaldop numeric;

begin

 select socioid
   into lsocioid
   from socio
  where clavesocioint=sclavesocioint;

 select prestamoid,saldoprestamo,tipoprestamoid,referenciaprestamo,saldoprestamo
   into lprestamoid,psaldoactual,stipoprestamoid,sreferenciaprestamo,fsaldop
   from prestamos
  where referenciaprestamo=sref;

 select cuentacaja
   into scuentacaja
   from parametros
  where serie_user=sserie_user;


--
-- Calcular el pago a la fecha que pasan como parametro
--

  fcapital := 0;
  finteres := 0;
  fmoratorio := 0;
  fiva := 0;
  ftotal := 0;
  
  fAbono:=fimporte;

raise notice 'prestamoid= %, fecha= %',lprestamoid,dfecha;

  for r in
    select * from spscalculopagod(lprestamoid,dfecha)
  loop
    raise notice 'Calculando pago...';
    if r.iva>0 and fAbono>r.iva then
      fiva:=r.iva;
      fAbono:=fAbono-fiva;
    end if;
    if r.moratorio>0 and fAbono>r.moratorio then
      fmoratorio:=r.moratorio;
      fAbono:=fAbono-fmoratorio;
    end if;
    if r.interes>0 and fAbono>=r.interes then
      finteres:=r.interes;
      fAbono:=fAbono-finteres;
    end if;
    if r.capital>=0 and fAbono>0 then
      fcapital:=fAbono;
      fAbono:=0;
    end if;
    ftotal:=fcapital+finteres+fmoratorio+fiva;
  end loop;

--
-- Actualizar tabla de prestamos, disminuir el saldo del prestamo y
-- actualizar fecha de ultimo pago, importante ya que a partir de ahi calculamos
-- el interes normal
--


  if fcapital>0 and fcapital<fsaldop then
    update prestamos
       set saldoprestamo = saldoprestamo - fcapital,
           fechaultimopago = dfecha,
           claveestadocredito = '001'
     where referenciaprestamo = sref;

  else
    if fcapital=fsaldop then
      update prestamos
         set saldoprestamo = saldoprestamo - fCapital,
             fechaultimopago = dfecha,
             claveestadocredito = '002'
       where referenciaprestamo = sref;
    else
      raise exception 'Error Saldos, Socio: %  Prestamo: %  Saldo Actual: %  Abono: %',
             sclavesocioint, sreferenciaprestamo, fsaldop, fcapital;
    end if;
  end if;



--
-- Buscamos cuentas contables para el tipo de prestamo anterior
--
  
  select cuentaactivo,cuentaintnormal,cuentaiva,cuentaintmora
    into scuentaactivo,scuentaintnormal,scuentaiva,scuentaintmora
    from tipoprestamo
   where tipoprestamoid = stipoprestamoid;


--
-- Actualizar tabla de amortizaciones del prestamo
--

  fAbono:=fcapital;
  if fAbono>0 then
    for amor in
        select *
          from amortizaciones
         where prestamoid=lprestamoid
      order by fechadepago
    loop

      fAplicar := amor.importeamortizacion - amor.abonopagado;

      if fAbono>=fAplicar then
        update amortizaciones
           set abonopagado = importeamortizacion,
               ultimoabono = dfecha
         where amortizacionid=amor.amortizacionid;
         fAbono := fAbono - fAplicar;
      else
        if fAbono>0 then
          update amortizaciones
             set abonopagado = abonopagado+fAbono,
                 ultimoabono = dfecha
           where amortizacionid=amor.amortizacionid;
           fAbono := 0;
        end if;
      end if;
    end loop;
  end if;


--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',dfecha) as int),cast(date_part('month',dfecha) as int),'A',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',dfecha) as int),cast(date_part('month',dfecha) as int),' ',dfecha,'D',' ',' ','Abono Prestamo',dfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','C',fcapital+finteres+fmoratorio+fiva,0,' ',' ','Pago de '||sref);

   if fcapital>0 then
     select * 
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaactivo,' ','A',0,fcapital,' ',' ','Capital '||sref);
   end if;

   if finteres>0 then
     select *
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaintnormal,' ','A',0,finteres,' ',' ','Interes '||sref);
   end if;

   if fmoratorio>0 then
     select *
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaintmora,' ','A',0,fmoratorio,' ',' ','Moratorio '||sref);
   end if;

   if fiva>0 then
     select *
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaiva,' ','A',0,fiva,' ',' ','IVA '||sref);
   end if;


   -- Movimiento de caja

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

   select *
     into pmovicajaid
     from spimovicaja(lsocioid,'00',ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,lprestamoid,'A',NULL);




return pmovicajaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.imp_pagoprestamo(character, character, numeric, date, character) OWNER TO sistema;

--
-- Name: imp_pagoprestamo(character, character, numeric, date, character, numeric, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION imp_pagoprestamo(character, character, numeric, date, character, numeric, integer, character) RETURNS integer
    AS $_$
declare

  sclavesocioint alias for $1;
  sref alias for $2;
  fimporte alias for $3;
  dfecha alias for $4;
  pclaveahorro  alias for $5;
  pahorro alias for $6;
  pcontratoid alias for $7;
  sserie_user alias for $8;
  
  lsocioid int4;
  lprestamoid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;


  r tcalculopago%rowtype; 

  psaldoactual numeric;

  fcapital numeric;
  finteres numeric;
  fmoratorio numeric;
  fiva numeric;
  ftotal numeric;
  fAbono numeric;
  fAplicar numeric;

  scuentaactivo char(24);
  scuentaintnormal char(24);
  scuentaiva char(24);
  scuentaintmora char(24);
  scuentacaja char(24);

  stipoprestamoid char(3);

  amor record;

  sreferenciaprestamo char(18);
  fsaldop numeric;
  idepositomovseguro integer;

begin

 select socioid
   into lsocioid
   from socio
  where clavesocioint=sclavesocioint;

 select prestamoid,saldoprestamo,tipoprestamoid,referenciaprestamo,saldoprestamo
   into lprestamoid,psaldoactual,stipoprestamoid,sreferenciaprestamo,fsaldop
   from prestamos
  where referenciaprestamo=sref;

 select cuentacaja
   into scuentacaja
   from parametros
  where serie_user=sserie_user;

--
-- Calcular el pago a la fecha que pasan como parametro
--

  fcapital := 0;
  finteres := 0;
  fmoratorio := 0;
  fiva := 0;
  ftotal := 0;
  
  fAbono:=fimporte;

  raise notice 'prestamoid= %, fecha= %',lprestamoid,dfecha;

  for r in
    select * from spscalculopagod(lprestamoid,dfecha)
  loop
    raise notice 'Calculando pago...';
    if r.iva>0 and fAbono>r.iva then
      fiva:=r.iva;
      fAbono:=fAbono-fiva;
    end if;
    if r.moratorio>0 and fAbono>r.moratorio then
      fmoratorio:=r.moratorio;
      fAbono:=fAbono-fmoratorio;
    end if;
    if r.interes>0 and fAbono>=r.interes then
      finteres:=r.interes;
      fAbono:=fAbono-finteres;
    end if;
    if r.capital>=0 and fAbono>0 then
      fcapital:=fAbono;
      fAbono:=0;
    end if;
    ftotal:=fcapital+finteres+fmoratorio+fiva;
  end loop;

--
-- Actualizar tabla de prestamos, disminuir el saldo del prestamo y
-- actualizar fecha de ultimo pago, importante ya que a partir de ahi calculamos
-- el interes normal
--


  if fcapital>0 and fcapital<fsaldop then
    update prestamos
       set saldoprestamo = saldoprestamo - fcapital,
           fechaultimopago = dfecha,
           claveestadocredito = '001'
     where referenciaprestamo = sref;

  else
    if fcapital=fsaldop then
      update prestamos
         set saldoprestamo = saldoprestamo - fCapital,
             fechaultimopago = dfecha,
             claveestadocredito = '002'
       where referenciaprestamo = sref;
    else
      raise exception 'Error Saldos, Socio: %  Prestamo: %  Saldo Actual: %  Abono: %',
             sclavesocioint, sreferenciaprestamo, fsaldop, fcapital;
    end if;
  end if;



--
-- Buscamos cuentas contables para el tipo de prestamo anterior
--
  
  select cuentaactivo,cuentaintnormal,cuentaiva,cuentaintmora
    into scuentaactivo,scuentaintnormal,scuentaiva,scuentaintmora
    from tipoprestamo
   where tipoprestamoid = stipoprestamoid;


--
-- Actualizar tabla de amortizaciones del prestamo
--

  fAbono:=fcapital;
  if fAbono>0 then
    for amor in
        select *
          from amortizaciones
         where prestamoid=lprestamoid
      order by fechadepago
    loop

      fAplicar := amor.importeamortizacion - amor.abonopagado;

      if fAbono>=fAplicar then
        update amortizaciones
           set abonopagado = importeamortizacion,
               ultimoabono = dfecha
         where amortizacionid=amor.amortizacionid;
         fAbono := fAbono - fAplicar;
      else
        if fAbono>0 then
          update amortizaciones
             set abonopagado = abonopagado+fAbono,
                 ultimoabono = dfecha
           where amortizacionid=amor.amortizacionid;
           fAbono := 0;
        end if;
      end if;
    end loop;
  end if;


--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',dfecha) as int),cast(date_part('month',dfecha) as int),'A',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',dfecha) as int),cast(date_part('month',dfecha) as int),' ',dfecha,'D',' ',' ','Abono Prestamo',dfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','C',fcapital+finteres+fmoratorio+fiva,0,' ',' ','Pago de '||sref);

   if fcapital>0 then
     select * 
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaactivo,' ','A',0,fcapital,' ',' ','Capital '||sref);
   end if;

   if finteres>0 then
     select *
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaintnormal,' ','A',0,finteres,' ',' ','Interes '||sref);
   end if;

   if fmoratorio>0 then
     select *
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaintmora,' ','A',0,fmoratorio,' ',' ','Moratorio '||sref);
   end if;

   if fiva>0 then
     select *
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaiva,' ','A',0,fiva,' ',' ','IVA '||sref);
   end if;


   -- Movimiento de caja

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

   lreferenciacaja := lreferenciacaja+1;   

   select *
     into pmovicajaid
     from spimovicaja(lsocioid,'00',ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,lprestamoid,'A',NULL,NULL,0);


   -- Depositar el ahorro

   
   
   select depositomovahorro into idepositomovseguro from depositomovahorro(sclavesocioint,dfecha,pahorro,pclaveahorro,sserie_user,null); 

return pmovicajaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.imp_pagoprestamo(character, character, numeric, date, character, numeric, integer, character) OWNER TO sistema;

--
-- Name: impinversion(integer, character, numeric, date, numeric, character, character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION impinversion(integer, character, numeric, date, numeric, character, character, character, date) RETURNS integer
    AS $_$
declare

-- Parametros

  psocioid                       alias for $1;
  ptipoinversionid               alias for $2;
  pdepositoinversion             alias for $3;
  pfechainversion                alias for $4;
  ptasainteresnormalinversion    alias for $5;
  preinversionautomatica         alias for $6;
  pserie                         alias for $7;
  pcuentacaja                    alias for $8;
  pfechavencimiento              alias for $9;


  pinversionid  int4;
  scuentapasivo char(24);
  iplazo int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;


begin

--
-- Buscar parametros en tipoinversion
--
  select cuentapasivo,plazo into scuentapasivo,iplazo
    from tipoinversion
   where tipoinversionid=ptipoinversionid;

--
-- Insertar inversion
--
  select * into pinversionid
    from spiinversion(psocioid,
                      ptipoinversionid,
                      1,
                      pserie,
                      pdepositoinversion,
                      0,
                      0,
                      pfechainversion,
                      pfechavencimiento,
                      pfechainversion,
                      0,
                      ptasainteresnormalinversion,
                      0,
                      pfechainversion,
                      pfechainversion,
                      preinversionautomatica);

--
-- Dar de alta la poliza
--

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza( cast(date_part('year',pfechainversion) as int),
                    cast(date_part('month',pfechainversion) as int),'D',pserie,'A');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,pserie,'A',pnumero_poliza,
        cast(date_part('year',pfechainversion) as int),
        cast(date_part('month',pfechainversion) as int),' ',
        pfechainversion,'D',' ',' ','Migracin Inicial',pfechainversion);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,pcuentacaja,' ','C',pdepositoinversion,0,' ',' ','Caja Migracin Inicial');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentapasivo,' ','A',0,pdepositoinversion,' ',' ','Pasivo Inversin');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = pserie;

  lreferenciacaja := lreferenciacaja+1;   

 select *
   into pmovicajaid
   from spimovicaja(psocioid,'IN',ppolizaid,lreferenciacaja,pserie,pmovipolizaid,NULL,'A',pinversionid);

return 1;

end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.impinversion(integer, character, numeric, date, numeric, character, character, character, date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: polizas; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE polizas (
    polizaid integer NOT NULL,
    referencia integer NOT NULL,
    seriepoliza character(2) NOT NULL,
    tipo character(1) NOT NULL,
    numero_poliza integer NOT NULL,
    ejercicio integer NOT NULL,
    periodo integer NOT NULL,
    fechapoliza date,
    tipo_poliza character(1) NOT NULL,
    clase_poliza character(1),
    diario_agrupador character(3),
    concepto_poliza character varying(255),
    fecha_fin_aceptacion date
);


ALTER TABLE sucursal1.polizas OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: importarpolizas(character, date, date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION importarpolizas(character, date, date, character, character) RETURNS SETOF sucursal1.polizas
    AS $_$
declare
  psucursalid alias for $1;
  pfecha1 alias for $2;
  pfecha2 alias for $3;
  pseriepoliza alias for $4;
  ptipo_poliza alias for $5;

  po polizas%rowtype;
  mp movipolizas%rowtype;
  mb movibanco%rowtype;

  phost char(30);
  pdb char(20);
  psucursal char(20);
  ppassword char(20);
  pcondiciontipo varchar(30);
  swprestamoid integer;
  lpolizaid int4;
  ipolizaeliminada integer;
  pnumero_poliza int4;
  preferencia int4;

  itraspasacatalogo_ctas integer;
  itraspasabancos integer;

begin

  swprestamoid=0;

  if ptipo_poliza='T' then
    pcondiciontipo := ' and 1=1 ';
  else
    pcondiciontipo := ' and tipo_poliza='||''''||ptipo_poliza||'''';
  end if;

  --raise notice 'c %',pcondiciontipo;

  select host,basededatos,esquema,passworddb into phost,pdb,psucursal,ppassword from sucursales where basededatos=psucursalid;

  --Primero traspasamos las cuentas contables y el catalogo de bancos

  select traspasacatalogo_ctas into itraspasacatalogo_ctas from traspasacatalogo_ctas(phost,pdb,psucursal);

  select traspasabancos into itraspasabancos from traspasabancos(phost,pdb,psucursal);


  for po in
  select polizaid,referencia,seriepoliza,tipo,numero_poliza,ejercicio,periodo,fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,concepto_poliza,fecha_fin_aceptacion  from dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password='||''''||ppassword||'''','set search_path to public,'||''''||psucursal||''''||'; select polizaid,referencia,seriepoliza,tipo,numero_poliza,ejercicio,periodo,fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,concepto_poliza,fecha_fin_aceptacion from polizas where fechapoliza>='||''''||pfecha1||''''||' and fechapoliza<='||''''||pfecha2||''''||' and seriepoliza='||''''||pseriepoliza||''''||pcondiciontipo||' and polizaid not in (select polizaid from movicaja where polizaid=polizas.polizaid );')  as t(
  polizaid  integer,
  referencia integer,
  seriepoliza character(2),
  tipo character(1),
  numero_poliza integer,
  ejercicio integer,
  periodo   integer,
  fechapoliza  date,
  tipo_poliza  character(1),
  clase_poliza character(1),
  diario_agrupador character(3),
  concepto_poliza  varchar(255), 
  fecha_fin_aceptacion date)

  loop

    swprestamoid:=0;

    for mb in
 
    select movibancoid,tipomovibancoid,prestamoid,no_cuenta,polizaid,consecutivo,serie,referenciamovi,concepto,beneficiario,conciliado,fecha_pen,postfechado,movipolizaid,procampoid
    from dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password='||''''||ppassword||'''','set search_path to public,'||''''||psucursal||''''||'; select movibancoid,tipomovibancoid,prestamoid,no_cuenta,polizaid,consecutivo,serie,referenciamovi,concepto,beneficiario,conciliado,fecha_pen,postfechado,movipolizaid,procampoid from movibanco where polizaid='||po.polizaid||' ;')  as t0(
                   movibancoid     integer,
                   tipomovibancoid character(2),
                   prestamoid      integer, 
                   no_cuenta       character(15),
                   polizaid        integer,
                   consecutivo     integer,
                   serie           character(2),
                   referenciamovi  character(14),
                   concepto        varchar(255),
                   beneficiario    varchar(45),
                   conciliado      character(1),
                   fecha_pen       date,
                   postfechado     character(1),
                   movipolizaid    integer, 
                   procampoid      integer)
                                     
     loop

         if mb.prestamoid is not null then
            swprestamoid:=1;
         else    
            swprestamoid:=2;

            select *
            into pnumero_poliza,preferencia
            from rconspoliza(cast(date_part('year',po.fechapoliza) as int),cast(date_part('month',po.fechapoliza) as int),po.tipo_poliza,po.seriepoliza,po.tipo);

            raise notice 'Numero_Polizaid= %',pnumero_poliza;

            insert into polizas(referencia,seriepoliza,tipo,numero_poliza,ejercicio,periodo,fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,concepto_poliza,fecha_fin_aceptacion) values(preferencia,po.seriepoliza,po.tipo,pnumero_poliza,po.ejercicio,po.periodo,po.fechapoliza,po.tipo_poliza,po.clase_poliza,po.diario_agrupador,po.concepto_poliza,po.fecha_fin_aceptacion);


            lpolizaid:=currval('polizas_polizaid_seq');
            raise notice 'Polizaid= %',lpolizaid;


            insert into movibanco(tipomovibancoid,prestamoid,no_cuenta,polizaid,consecutivo,serie,referenciamovi,concepto,beneficiario,conciliado,fecha_pen,postfechado,movipolizaid,procampoid) values(mb.tipomovibancoid,mb.prestamoid,mb.no_cuenta,lpolizaid,mb.consecutivo,mb.serie,mb.referenciamovi,mb.concepto,mb.beneficiario,mb.conciliado,mb.fecha_pen,mb.postfechado,null,mb.procampoid);

         end if;       

    end loop;

    if swprestamoid <>1 then

      if swprestamoid = 0 then


         select *
            into pnumero_poliza,preferencia
            from rconspoliza(cast(date_part('year',po.fechapoliza) as int),cast(date_part('month',po.fechapoliza) as int),po.tipo_poliza,po.seriepoliza,po.tipo);


         insert into polizas(referencia,seriepoliza,tipo,numero_poliza,ejercicio,periodo,fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,concepto_poliza,fecha_fin_aceptacion) values(preferencia,po.seriepoliza,po.tipo,pnumero_poliza,po.ejercicio,po.periodo,po.fechapoliza,po.tipo_poliza,po.clase_poliza,po.diario_agrupador,po.concepto_poliza,po.fecha_fin_aceptacion);

         lpolizaid:=currval('polizas_polizaid_seq');
         raise notice 'Polizaid= %',lpolizaid;

      end if;

      for mp in
      select movipolizaid,polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion
      from dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password='||''''||ppassword||'''','set search_path to public,'||''''||psucursal||''''||'; select movipolizaid,polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion from movipolizas where polizaid='||po.polizaid||' order by polizaid;')  as t1(movipolizaid integer,
                  polizaid integer,
                  cuentaid character(24),
                  referencia_mov  character(8),
                  tipo_mov character(1),
                  debe numeric,
                  haber numeric,
                  diario_mov character(3),
                  identific_descr character(1),
                  descripcion  character varying(29))

       loop

         insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion) values(lpolizaid,mp.cuentaid,mp.referencia_mov,mp.tipo_mov,mp.debe,mp.haber,mp.diario_mov,mp.identific_descr,mp.descripcion);
         --raise notice ' Movipoliza  %  %  % ', mp.cuentaid,mp.debe,mp.haber;

       end loop;

       select eliminapolizaimportada into ipolizaeliminada 
        from dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password='||''''||ppassword||'''','set search_path to public,'||''''||psucursal||''''||'; select eliminapolizaimportada from eliminapolizaimportada('||po.polizaid||');')  as t3(eliminapolizaimportada integer);

       return next po;

    end if;

  end loop;

return ;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.importarpolizas(character, date, date, character, character) OWNER TO sistema;

--
-- Name: importarunapoliza(character, character, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION importarunapoliza(character, character, character, character, integer) RETURNS SETOF sucursal1.polizas
    AS $_$
declare
  
  phost alias for $1;
  pdb alias for $2;
  psucursal alias for $3;
  ppassword alias for $4;
  ppolizaid alias for $5;

  r record;
  po polizas%rowtype;
  mp movipolizas%rowtype;
  mb movibanco%rowtype;

  swprestamoid integer;
  lpolizaid int4;
  ipolizaeliminada integer;
  pnumero_poliza int4;
  preferencia int4;


begin

  swprestamoid:=0;

  --select eliminapolizaimportada into ipolizaeliminada from eliminapolizaimportada(ppolizaid);
  --raise notice 'c %',pcondiciontipo;

  for po in
  select polizaid,referencia,seriepoliza,tipo,numero_poliza,ejercicio,periodo,fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,concepto_poliza,fecha_fin_aceptacion  from dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password='||''''||ppassword||'''','set search_path to public,'||''''||psucursal||''''||'; select polizaid,referencia,seriepoliza,tipo,numero_poliza,ejercicio,periodo,fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,concepto_poliza,fecha_fin_aceptacion from polizas where polizaid='||''''||ppolizaid||''''||' and polizaid not in (select polizaid from movicaja where polizaid=polizas.polizaid );')  as t(
  polizaid  integer,
  referencia integer,
  seriepoliza character(2),
  tipo character(1),
  numero_poliza integer,
  ejercicio integer,
  periodo   integer,
  fechapoliza  date,
  tipo_poliza  character(1),
  clase_poliza character(1),
  diario_agrupador character(3),
  concepto_poliza  varchar(255), 
  fecha_fin_aceptacion date)

  loop

    swprestamoid:=0;

    for mb in
 
    select movibancoid,tipomovibancoid,prestamoid,no_cuenta,polizaid,consecutivo,serie,referenciamovi,concepto,beneficiario,conciliado,fecha_pen,postfechado,movipolizaid,procampoid
    from dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password='||''''||ppassword||'''','set search_path to public,'||''''||psucursal||''''||'; select movibancoid,tipomovibancoid,prestamoid,no_cuenta,polizaid,consecutivo,serie,referenciamovi,concepto,beneficiario,conciliado,fecha_pen,postfechado,movipolizaid,procampoid from movibanco where polizaid='||po.polizaid||' ;')  as t0(
                   movibancoid     integer,
                   tipomovibancoid character(2),
                   prestamoid      integer, 
                   no_cuenta       character(15),
                   polizaid        integer,
                   consecutivo     integer,
                   serie           character(2),
                   referenciamovi  character(14),
                   concepto        varchar(255),
                   beneficiario    varchar(45),
                   conciliado      character(1),
                   fecha_pen       date,
                   postfechado     character(1),
                   movipolizaid    integer, 
                   procampoid      integer)
                                     
     loop

         if mb.prestamoid is not null then
            swprestamoid:=1;
         else    
            swprestamoid:=2;

            select *
            into pnumero_poliza,preferencia
            from rconspoliza(cast(date_part('year',po.fechapoliza) as int),cast(date_part('month',po.fechapoliza) as int),po.tipo_poliza,po.seriepoliza,po.tipo);

            raise notice 'Numero_Polizaid= %',pnumero_poliza;

            insert into polizas(referencia,seriepoliza,tipo,numero_poliza,ejercicio,periodo,fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,concepto_poliza,fecha_fin_aceptacion) values(preferencia,po.seriepoliza,po.tipo,pnumero_poliza,po.ejercicio,po.periodo,po.fechapoliza,po.tipo_poliza,po.clase_poliza,po.diario_agrupador,po.concepto_poliza,po.fecha_fin_aceptacion);


            lpolizaid:=currval('polizas_polizaid_seq');
            raise notice 'Polizaid= %',lpolizaid;


            insert into movibanco(tipomovibancoid,prestamoid,no_cuenta,polizaid,consecutivo,serie,referenciamovi,concepto,beneficiario,conciliado,fecha_pen,postfechado,movipolizaid,procampoid) values(mb.tipomovibancoid,mb.prestamoid,mb.no_cuenta,lpolizaid,mb.consecutivo,mb.serie,mb.referenciamovi,mb.concepto,mb.beneficiario,mb.conciliado,mb.fecha_pen,mb.postfechado,null,mb.procampoid);

         end if;       

    end loop;

    if swprestamoid <>1 then

      if swprestamoid = 0 then


         select *
            into pnumero_poliza,preferencia
            from rconspoliza(cast(date_part('year',po.fechapoliza) as int),cast(date_part('month',po.fechapoliza) as int),po.tipo_poliza,po.seriepoliza,po.tipo);


         insert into polizas(referencia,seriepoliza,tipo,numero_poliza,ejercicio,periodo,fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,concepto_poliza,fecha_fin_aceptacion) values(preferencia,po.seriepoliza,po.tipo,pnumero_poliza,po.ejercicio,po.periodo,po.fechapoliza,po.tipo_poliza,po.clase_poliza,po.diario_agrupador,po.concepto_poliza,po.fecha_fin_aceptacion);

         lpolizaid:=currval('polizas_polizaid_seq');
         raise notice 'Polizaid= %',lpolizaid;

      end if;

      for mp in
      select movipolizaid,polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion
      from dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password='||''''||ppassword||'''','set search_path to public,'||''''||psucursal||''''||'; select movipolizaid,polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion from movipolizas where polizaid='||po.polizaid||' order by polizaid;')  as t1(movipolizaid integer,
                  polizaid integer,
                  cuentaid character(24),
                  referencia_mov  character(8),
                  tipo_mov character(1),
                  debe numeric,
                  haber numeric,
                  diario_mov character(3),
                  identific_descr character(1),
                  descripcion  character varying(29))

       loop

         insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion) values(lpolizaid,mp.cuentaid,mp.referencia_mov,mp.tipo_mov,mp.debe,mp.haber,mp.diario_mov,mp.identific_descr,mp.descripcion);
         --raise notice ' Movipoliza  %  %  % ', mp.cuentaid,mp.debe,mp.haber;

       end loop;

       select eliminapolizaimportada into ipolizaeliminada
        from dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password='||''''||ppassword||'''','set search_path to public,'||''''||psucursal||''''||'; select eliminapolizaimportada from eliminapolizaimportada('||po.polizaid||');')  as t3(eliminapolizaimportada integer);

       return next po;

    end if;

  end loop;

return ;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.importarunapoliza(character, character, character, character, integer) OWNER TO sistema;

--
-- Name: imprimesolicitudp(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION imprimesolicitudp(integer) RETURNS text
    AS $_$
declare

  psolicitudp alias for $1;
  pformato text;
  ptexto text;
  dfecha_otorga date;
  pmes int;
  tipocasa text;
  estadocivil text;
  psmes varchar;
  pdia char(2);
  pano char(4);
  conyuge1 int;
  conyuge text;  
  r pdatoaval%rowtype;
  monto numeric;
  tipo char(3);
  abonos int;
  resultado date;  
  socioinv int;
  tipoprestamoid char(3);
  descprestamo char(30);
  tasanormal numeric;
  clavefina char(3);
  descfina char(30);
  periodopago int;
  periodo char(15);
  amor1 numeric;
  amor2 numeric;
  paval text;
  padomicilio text;
  patelefono text;
  psocioid int;
  pdebes numeric;
  phaberes numeric;
  pclaveaval char(15);
  dprimerpago date;
  pdiaprimer int;
  diascobro int;
  partesocial numeric;
  ahorro numeric;
  ctacorriente numeric;
  plazofijo numeric;
  creditos numeric;
  nreciprocidad numeric;
  presolucionid int;
  presolucion text;
  pcantidad1 text;
  pcantidad2 text;  
  i int;
  j int;
  sclaveaval varchar;
begin

  select soi.tipocasaid,soi.estadocivilid,sop.periodopagoid,sop.resolucionid
    into tipocasa,estadocivil,periodopago,presolucionid
    from solicitudprestamo sop, socio so, solicitudingreso soi
   where sop.socioid = so.socioid and
         so.socioid = soi.socioid and
         sop.solicitudprestamoid = psolicitudp; 

-- Determinar Tipo de Casa  
  if rtrim(tipocasa)='0' then
	--CASA RENTADA
	tipocasa:='Rentada';
  end if;
  
  if rtrim(tipocasa)='1' then
	--CASA PROPIA
	tipocasa:='Propia';
  end if;	
  
  if rtrim(tipocasa)='2' then
	--CASA FAMILIAR
	tipocasa:='Familiar';
  end if;	  
  
--Determinar Estado Civil
  if rtrim(estadocivil)='0' then
	--SOLTERO
	estadocivil:='Soltero';
  end if;
  
  if rtrim(estadocivil)='1' then
	--CASADO
	estadocivil:='Casado';
  end if;	
  
  if rtrim(estadocivil)='2' then
	--DIVORCIADO
	estadocivil:='Divorciado';
  end if;	    
  
  if rtrim(estadocivil)='3' then
	--VIUDO
	estadocivil:='Viudo';
  end if;	
  
  if rtrim(estadocivil)='4' then
	--UNION LIBRE
	estadocivil:='Union Libre';
  end if;	      
    
-- Determinar Periodo de Pago
  if rtrim(periodopago)=0 then
	--PAGO MENSUAL
	periodo:='Mensuales';
	diascobro:=30;
  end if;
  
  if rtrim(periodopago)=1 then
	--PAGO QUINCENAL
	periodo:='Quincenales';
	diascobro:=15;
  end if;	
  
  if rtrim(periodopago)=2 then
	--PAGO SEMANAL
	periodo:='Semanales';
	diascobro:=7;
  end if;	    
  
-- Nombre del conyuge
  select soi.conyugeid
    into conyuge1
    from solicitudprestamo sop ,solicitudingreso soi
   where sop.socioid = soi.socioid and 
--         sop.sujetoid = soi.sujetoid  and
         sop.solicitudprestamoid = psolicitudp;

  if conyuge1 is not null then
     select rtrim(nombre)||' '||rtrim(paterno)||' '||rtrim(materno)
       into conyuge
       from sujeto
      where sujetoid = conyuge1;
  else
     conyuge:='  ';
  end if;  


-- Determinar Resolucion
  if rtrim(presolucionid)=0 then
	--PENDIENTE
	presolucion:='APROBADA ( )   RECHAZADA ( )   PENDIENTE (X) ';
  end if;
  
  if rtrim(presolucionid)=1 then
	--RECHAZADO
	presolucion:='APROBADA ( )   RECHAZADA (X)   PENDIENTE ( ) ';
  end if;  

  if rtrim(presolucionid)=2 then
	--AUTORIZADO
	presolucion:='APROBADA (X)   RECHAZADA ( )   PENDIENTE ( ) ';
  end if;

-- Calcular Saldos

  select sum(debe)-sum(haber) 
    into partesocial
    from solicitudprestamo sop,socio so,movicaja mc, movipolizas mp
   where sop.solicitudprestamoid = psolicitudp and
         sop.socioid = so.socioid and
         so.socioid = mc.socioid and
	 mc.tipomovimientoid = 'PA' and
         mc.movipolizaid = mp.movipolizaid;

  partesocial:=coalesce(partesocial,0);

  select sum(debe)-sum(haber)
    into ahorro 
    from solicitudprestamo sop,socio so,movicaja mc, movipolizas mp
   where sop.solicitudprestamoid = psolicitudp and
         sop.socioid = so.socioid and
         so.socioid = mc.socioid and
	 mc.tipomovimientoid = 'AA' and
         mc.movipolizaid = mp.movipolizaid;

  ahorro:=coalesce(ahorro,0);

 select sum(debe)-sum(haber)
    into nreciprocidad
    from solicitudprestamo sop,socio so,movicaja mc, movipolizas mp
   where sop.solicitudprestamoid = psolicitudp and
         sop.socioid = so.socioid and
         so.socioid = mc.socioid and
         mc.tipomovimientoid = 'AG' and
         mc.movipolizaid = mp.movipolizaid;
  
  nreciprocidad:=coalesce(nreciprocidad,0);

  select sum(debe)-sum(haber)
    into ctacorriente
    from solicitudprestamo sop,socio so,movicaja mc, movipolizas mp
   where sop.solicitudprestamoid = psolicitudp and
         sop.socioid = so.socioid and
         so.socioid = mc.socioid and
         mc.tipomovimientoid = 'CU' and
         mc.movipolizaid = mp.movipolizaid;
  
  ctacorriente:=coalesce(ctacorriente,0);
  
  select so.socioid into socioinv   
    from solicitudprestamo sop,socio so
   where sop.solicitudprestamoid = psolicitudp and
         sop.socioid = so.socioid;
 
  select sum(depositoinversion)
    into plazofijo
    from spsinversiones(socioinv);
    
  plazofijo:=coalesce(plazofijo,0);  

  select sum(saldoprestamo)
    into creditos
    from solicitudprestamo sop,socio so, prestamos p
   where sop.solicitudprestamoid = psolicitudp and
         sop.socioid = so.socioid and
         so.socioid = p.socioid;
	 
  if ahorro is null then
     creditos:=0;
  end if;  	 

  creditos:=coalesce(creditos,0);

-- Datos del prestamo
  select tp.tipoprestamoid,tp.desctipoprestamo,tp.tasa_normal,
         fina.clavefinalidad,fina.descripcionfinalidad
    into tipoprestamoid,descprestamo,tasanormal,clavefina,descfina
    from solicitudprestamo sop,tipoprestamo tp, finalidades fina,tipo_garantia tg
   where sop.tipoprestamoid = tp.tipoprestamoid and
         sop.clavefinalidad = fina.clavefinalidad and
         sop.clavegarantia = tg.clavegarantia and
         sop.solicitudprestamoid = psolicitudp;

-- Fecha de Solicitud
  select sop.fechasolicitud,sop.primerpago into dfecha_otorga,dprimerpago
    from solicitudprestamo sop 
   where sop.solicitudprestamoid = psolicitudp;
  
  pmes:=cast(date_part('month',dfecha_otorga) as int);
  pdia:=cast(date_part('day',dfecha_otorga) as char(2));
  pano:=cast(date_part('year',dfecha_otorga) as char(4));

  if pmes=1 then
    psmes := 'Enero     ';
  end if;
  if pmes=2 then
    psmes := 'Febrero   ';
  end if;
  if pmes=3 then
    psmes := 'Marzo     ';
  end if;
  if pmes=4 then
    psmes := 'Abril     ';
  end if;
  if pmes=5 then
    psmes := 'Mayo      ';
  end if;
  if pmes=6 then
    psmes := 'Junio     ';
  end if;
  if pmes=7 then
    psmes := 'Julio     ';
  end if;
  if pmes=8 then
    psmes := 'Agosto    ';
  end if;
  if pmes=9 then
    psmes := 'Septiembre';
  end if;
  if pmes=10 then
    psmes := 'Octubre   ';
  end if;
  if pmes=11 then
    psmes := 'Noviembre ';
  end if;
  if pmes=12 then
    psmes := 'Diciembre ';
  end if;

  psmes := rtrim(psmes);

-- Importe de Amortizaciones
  select sop.montosolicitado into monto 
    from solicitudprestamo sop 
   where sop.solicitudprestamoid = psolicitudp; 

  select sop.abonospropuestos into abonos 
  from solicitudprestamo sop 
  where sop.solicitudprestamoid = psolicitudp;
  
  select sop.fecharesultado into resultado
    from solicitudprestamo sop  
   where sop.solicitudprestamoid = psolicitudp;

  pdiaprimer:=cast(date_part('day',dprimerpago) as int);

  select min(importeamortizacion),max(importeamortizacion) into amor1,amor2
    from sptablaamor(monto,dprimerpago,tipoprestamoid,abonos,0,1,pdiaprimer,resultado);
    
  if abonos = 1 then
     pcantidad1 := 'Cantidad          : '||to_char(monto,'99,999,999.99')||'  A pagar en un Abono de '||to_char(amor1,'999,999.99')||'.'||chr(10)||chr(13);
     pcantidad2 := ' '||chr(10)||chr(13);
  else
     if abonos = 2 then
        pcantidad1 := 'Cantidad          : '||to_char(monto,'99,999,999.99')||'  A pagar en un Abono Mensual de: '||to_char(amor1,'99,999,999.99')||chr(10)||chr(13);
        pcantidad2 := lpad('Y un abono final de: ',68)||to_char(amor2,'99,999,999.99')||chr(10)||chr(13);     
     else
        pcantidad1 := 'Cantidad          : '||to_char(monto,'99,999,999.99')||'  A pagar en '||to_char(abonos-1,'999')||' Abonos '||periodo||' de: '||to_char(amor1,'99,999,999.99')||' cada uno'||chr(10)||chr(13);
        pcantidad2 := lpad('Y un abono final de: ',73)||to_char(amor2,'99,999,999.99')||chr(10)||chr(13);
     end if;	
  end if;

 sclaveaval := '';


--  raise notice 'Amor1: %  Amor2=%',amor1,amor2;

-- Formato de Solicitud
  select 
         chr(15)||chr(13)||
         '                                             COOPERATIVA YOLOMECATL, S.C. DE R.L. DE C.V. '||chr(10)||chr(13)||
         'Solicitud de Prestamo No: '||sop.nosolicitud||'                                                                                       Socio No.: '||so.clavesocioint||chr(10)||chr(13)||
	 '                                                                                                                  Fecha    :  '||pdia||'/'||substr(psmes,1,3)||'/'||pano||chr(10)||chr(13)||
	 '========================================================================================================================================='||chr(10)||chr(13)|| 
	 'Nombre    : '||alineap(su.nombre||' '||su.paterno||' '||su.materno)||'  '||'R.F.C.     : '||su.rfc||chr(13)||chr(10)||
	 'Domicilio : '||alineap(rtrim(d.calle)||'  '||rtrim(d.numero_ext))||'  '||'Telefono   : '||d.teldomicilio||chr(13)||chr(10)||
         'Colonia   : '||alineap(co.nombrecolonia)||'  '||'Codigo Pos.: '||d.codpostal||chr(13)||chr(10)||
	 'Ciudad    : '||alineap(c.nombreciudadmex)||'  '||'Estado     : '||rtrim(es.nombreestadomex)||chr(13)||chr(10)||
	 'Casa      : '||alineap(tipocasa)||'  '||'Ocupacion  : '||rtrim(soi.ocupacion)||chr(13)||chr(10)||
	 'Antiguedad: '||alineap(soi.tiempovivirendomicilio)||'  '||'Edo. Civil : '||estadocivil||chr(13)||chr(10)||
	 chr(13)||chr(10)||chr(13)||
	 'Conyuge   : '||conyuge||chr(13)||chr(10)||
         chr(13)||chr(10)||
	 '==========================================================  SALDOS DEL SOCIO  ==========================================================='||chr(10)||chr(13)|| 	 
	 chr(13)||chr(10)||
	 alineap('H a b e r e s')||'                  '||'D e b e s'||chr(10)||chr(13)||
	 'Ahorro        : '||alineap(to_char(ahorro,'99,999,999,999.99'))||'  Creditos:'||to_char(creditos,'99,999,999,999.99')||chr(10)||chr(13)||
	 'Reciprocidad  : '||alineap(to_char(nreciprocidad,'99,999,999,999.99'))||chr(10)||chr(13)||
         'Parte Social  : '||alineap(to_char(partesocial,'99,999,999,999.99'))||chr(10)||chr(13)||
	 'Cta. Corriente: '||alineap(to_char(ctacorriente,'99,999,999,999.99'))||chr(10)||chr(13)||
	 'Plazo fijo    : '||alineap(to_char(plazofijo,'99,999,999,999.99'))||chr(10)||chr(13)||
	
	 '======================================================  PRESTAMO Y FORMA DE PAGO  ======================================================='||chr(10)||chr(13)|| 	 
	 chr(13)||chr(10)||
       	 'Prestamo          : '||alineap(rtrim(tipoprestamoid)||'  '||rtrim(descprestamo))||' '||'Finalidad: '||rtrim(clavefina)||'  '||descfina||chr(10)||chr(13)||
--	 'Cantidad          : '||to_char(sop.montosolicitado,'99,999,999.99')||'  A pagar en: '||to_char(abonos-1,'999')||' Abonos '||periodo||' de '||to_char(amor1,'999,999.99')||' cada uno.'||chr(10)||chr(13)||
--	 'Y un pago final de: '||to_char(amor2,'99,999,999.99')||chr(10)||chr(13)|| 
         pcantidad1||
	 pcantidad2||
	 chr(13)||chr(10)||
	 '==================================================  INFORMACION ECONOMICA DEL SOCIO  ===================================================='||chr(10)||chr(13)|| 	 
	 chr(13)||chr(10)||	 
	 'Ingresos Mensuales:'||alineap(to_char(sop.totalingresos-sop.otrosingresos,'99,999,999.99'))||'  '||'Gastos Mensuales: '||to_char(sop.totaldeudas-sop.otrosgastos,'99,999,999.99')||chr(10)||chr(13)||
	 'Otros Ingresos    :'||alineap(to_char(sop.otrosingresos,'99,999,999.99'))||'  '||'Fecha de Alta   : '||to_char(so.fechaalta,'dd/mm/yyyy')||chr(10)||chr(13)||
	 'Valor estimado de propiedades:'||alinea(to_char(sop.valorpropiedades,'99,999,999.99'))||' '||'          Deudas fuera de la Cooperativa: '||to_char(sop.otrosgastos,'99,999,999.99')||chr(10)||chr(13)||
	 'El cumplimiento de su ahorro ha sido: __Bueno  __Regular  __Malo'||chr(10)||chr(13)||
	 chr(13)||chr(10)||
	 '===============================================================  AVALES  ================================================================'||chr(10)||chr(13)|| 	 
	 chr(13)||chr(10)||	 	 
	 'AVAL           NOMBRE                         DOMICILIO                      TELEFONO           HABERES          DEBES'||chr(10)||chr(13)
    into ptexto
    from solicitudprestamo sop, socio so, sujeto su,domicilio d,
         solicitudingreso soi,ciudadesmex c,estadosmex es, colonia co
   where sop.socioid = so.socioid and
         so.sujetoid = su.sujetoid and 
         su.sujetoid = d.sujetoid and
         co.coloniaid = d.coloniaid and
         so.socioid= soi.socioid and
         d.ciudadmexid = c.ciudadmexid and
         es.estadomexid = c.estadomexid and
         sop.solicitudprestamoid = psolicitudp;

  pformato := ptexto;
	 
-- Avales

i :=0;

for r in
 
	 select rtrim(s.nombre)||' '||rtrim(s.paterno)||' '||rtrim(s.materno) as aval,
          rtrim(d.calle)||' '||rtrim(d.numero_ext) as domicilio,
          d.teldomicilio as telefono,
          a.socioid as socioid,
          '               ' as claveaval
    from avales a,sujeto s,domicilio d
   where a.solicitudprestamoid =  psolicitudp and
         s.sujetoid = a.sujetoid and
         d.sujetoid = a.sujetoid
  order by a.noaval

	 
loop

 if i<3 then
      -- Verificar si es socio
      if r.socioid IS NOT NULL then
        select clavesocioint
          into sclaveaval
          from socio
         where socioid=r.socioid;

      else
        sclaveaval:=r.claveaval;
      end if;

    end if;


  select sum(debe)-sum(haber) into phaberes
    from socio so,movicaja mc, movipolizas mp
   where so.socioid = mc.socioid and
         mc.movipolizaid = mp.movipolizaid and
         mc.tipomovimientoid <> '00' and
         so.socioid = r.socioid;	 

  phaberes:=coalesce(phaberes,0);

  select sum(saldoprestamo) into pdebes
    from socio so, prestamos p
   where so.socioid = p.socioid and
         so.socioid = r.socioid;
	 
  pdebes:=coalesce(pdebes,0);


  ptexto :=substr(sclaveaval,1,14)||' '||substr(alineap1(r.aval),1,30)||' '||substr(alineap1(r.domicilio),1,30)||' '||substr(alineap2(r.telefono),1,15)||'   '||to_char(phaberes,'99,999,999.99')||'  '||to_char(pdebes,'99,999,999.99')||chr(10)||chr(13);

  pformato := pformato||ptexto; 
  i := i+1;
  
end loop;	 
    
  for j in 1..4-i
  loop
    pformato:= pformato||chr(13)||chr(10);
  end loop;
  
    select 'Firma del Socio ___________________'||chr(10)||chr(13)|| 	 
	   chr(13)||chr(10)||
	   '==================================================  RESOLUCION DEL COMITE DE CREDITO  ==================================================='||chr(10)||chr(13)|| 	 
	   chr(13)||chr(10)||	 	 
	   'APROBADA___   RECHAZADA___   PENDIENTE___'||chr(10)||chr(13)|| 	 
--	   presolucion||chr(10)||chr(13)|| 	 
	   chr(13)||chr(10)||	 	 	 
	   'BAJO LAS SIGUIENTES CONDICIONES: '||chr(10)||chr(13)|| 	 
	   '_________________________________________________________________________________________________________________________________________'||chr(10)||chr(13)|| 	 	   
	   '_________________________________________________________________________________________________________________________________________'||chr(10)||chr(13)|| 	 	   
	   '_________________________________________________________________________________________________________________________________________'||chr(10)||chr(13)|| 	 	   
	   '_________________________________________________________________________________________________________________________________________'||chr(10)||chr(13)|| 	 	   
	   'FECHA DE RESOLUCION: '||to_char(sop.fecharesultado,'dd/mm/yyyy')||'                                 ACTA No.: ___                                  ENTERADO: _______________'||chr(10)||chr(13)|| 
	   chr(10)||chr(13)|| 	 
	   '_______________________________                     _______________________________                     _______________________________'||chr(10)||chr(13)||
	   '          PRESIDENTE                                          SECRETARIO                                          1ER. VOCAL       '||chr(10)||chr(13)||
	   chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
	   '_______________________________                     _______________________________                     _______________________________'||chr(10)||chr(13)||
	   '            GERENTE                                           2D0. VOCAL                                          3ER. VOCAL       '||chr(10)||chr(13)||	 
	   chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)  
    into ptexto
    from solicitudprestamo sop
   where sop.solicitudprestamoid = psolicitudp;	  

  pformato := pformato||ptexto; 

return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.imprimesolicitudp(integer) OWNER TO sistema;

--
-- Name: imprimesolicitudp(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION imprimesolicitudp(integer, integer) RETURNS text
    AS $_$
declare

  psolicitudp alias for $1;
  pformato from $2;
  pformato text;
  ptexto text;
  dfecha_otorga date;
  pmes int;
  tipocasa text;
  estadocivil text;
  psmes varchar;
  pdia char(2);
  pano char(4);
  conyuge int;
  r int;
  monto numeric;
  fechaotorga date;
  tipo char(3);
  abonos int;
  entrega date;  
  pdias int;
  socioinv int;

begin

  select sop.fechasolicitud into dfecha_otorga 
  from solicitudprestamo sop 
  where sop.solicitudprestamoid = psolicitudp;
  pmes:=cast(date_part('month',dfecha_otorga) as int);
  pdia:=cast(date_part('day',dfecha_otorga) as char(2));
  pano:=cast(date_part('year',dfecha_otorga) as char(4));

  if pmes=1 then
    psmes := 'Enero     ';
  end if;
  if pmes=2 then
    psmes := 'Febrero   ';
  end if;
  if pmes=3 then
    psmes := 'Marzo     ';
  end if;
  if pmes=4 then
    psmes := 'Abril     ';
  end if;
  if pmes=5 then
    psmes := 'Mayo      ';
  end if;
  if pmes=6 then
    psmes := 'Junio     ';
  end if;
  if pmes=7 then
    psmes := 'Julio     ';
  end if;
  if pmes=8 then
    psmes := 'Agosto    ';
  end if;
  if pmes=9 then
    psmes := 'Septiembre';
  end if;
  if pmes=10 then
    psmes := 'Octubre   ';
  end if;
  if pmes=11 then
    psmes := 'Noviembre ';
  end if;
  if pmes=12 then
    psmes := 'Diciembre ';
  end if;
psmes := rtrim(psmes);

select 
chr(15)||chr(13)||chr(10)||
chr(13)||chr(10)||chr(13)||
chr(10)||chr(13)||chr(10)||
chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||chr(13)||
chr(10)||chr(13)||chr(10)||
'                                                                                                   '||pdia||'  '||psmes||'  '||pano||
chr(13)||chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||sop.nosoliciud||chr(13)||chr(10)||
chr(13)||chr(10)||chr(13)||chr(10)||
'                '||so.clavesocioint||'                   '||su.nombre||' '||su.paterno||' '||su.materno||chr(13)||chr(10)||
'                '||d.calle||'  '||d.numero_int||' '||d.numero_ext||' '||d.colonia||' '
||chr(13)||chr(10)||chr(13)||chr(10)||'   '||c.nombreciudadmex||
chr(13)||chr(10)||chr(13)||chr(10)
||'     '||d.teldomicilio into ptexto
from solicitudprestamo sop, socio so, sujeto su,domicilio d, domicilio de,solicitudingreso soi,ciudadesmex c,estadosmex es
where sop.socioid = so.socioid and
      so.sujetoid = su.sujetoid and 
      su.sujetoid = d.sujetoid and
      sop.domicilioid = de.domicilioid and
      so.socioid= soi.socioid and
      d.ciudadmexid = c.ciudadmexid and
      es.estadomexid = c.estadomexid and
      sop.solicitudprestamoid = psolicitudp;


pformato := ptexto;
--est parte es para el tipo de casa

select soi.tipocasaid into tipocasa
from solicitudprestamo sop, socio so, solicitudingreso soi
where sop.socioid = so.socioid and
      so.socioid= soi.socioid and
      sop.solicitudprestamoid = psolicitudp;

if rtrim(tipocasa)='0' then
	--CASA RENTADA
select '                                                X                                                           '||soi.tiempovivirendomicilio into ptexto
from solicitudprestamo sop, solicitudingreso soi
where sop.socioid = soi.socioid and
      sop.solicitudprestamoid = psolicitudp;
end if;

if rtrim(tipocasa)='1' then
	--CASA propia
select '                        X                                                                   '||soi.tiempovivirendomicilio  into ptexto
from solicitudprestamo sop, solicitudingreso soi
where sop.socioid = soi.socioid and
      sop.solicitudprestamoid = psolicitudp;
end if;

if rtrim(tipocasa)='2' then
	--casa familiar
select '                                                         X                                             '||soi.tiempovivirendomicilio into ptexto
from solicitudprestamo sop, solicitudingreso soi
where sop.socioid = soi.socioid and
      sop.solicitudprestamoid = psolicitudp;
end if;

pformato := pformato||ptexto;

select  chr(13)||chr(10)||'           '||soi.ocupacion||'                                                                        '||sop.empresatrabaja||
chr(13)||chr(10)||'            '||de.calle||' '||de.numero_int||' '||de.numero_ext||' '||de.colonia||' '||c.nombreciudadmex||'  '||es.nombreestadomex||'                                                 '||de.teldomicilio||chr(13)||chr(10)into ptexto
from solicitudprestamo sop, socio so, sujeto su,domicilio de,solicitudingreso soi,ciudadesmex
 c,estadosmex es
where sop.socioid = so.socioid and
      so.sujetoid = su.sujetoid and 
      sop.domicilioid = de.domicilioid and
      so.socioid= soi.socioid and
      de.ciudadmexid = c.ciudadmexid and
      es.estadomexid = c.estadomexid and
      sop.solicitudprestamoid = psolicitudp;
pformato := pformato||ptexto;

--determinar el estado civil
select soi.estadocivilid into estadocivil 
from solicitudprestamo sop, solicitudingreso soi
where  sop.socioid = soi.socioid and
       sop.solicitudprestamoid = psolicitudp; 

if rtrim(estadocivil)='0' then
	--soltero
	ptexto := chr(13)||chr(10)||'                 soltero(a)';
end if;
if rtrim(estadocivil)='1' then
	--casado
	ptexto := chr(13)||chr(10)||'                 casado(a)';
end if;
if rtrim(estadocivil)='2' then
	--divorciado
	ptexto := chr(13)||chr(10)||chr(13)||chr(10)||'                 divorciado(a)';
end if;
if rtrim(estadocivil)='3' then
	--viudo
	ptexto := chr(13)||chr(10)||'                 viudo(a)';
end if;
if rtrim(estadocivil)='4' then
	--union libre
	ptexto := chr(13)||chr(10)||chr(13)||chr(10)||'                 union libre';
end if;
pformato := pformato||ptexto;

select soi.conyugeid  into conyuge 
from solicitudprestamo sop ,solicitudingreso soi
where sop.socioid = soi.socioid and 
      sop.sujetoid = soi.sujetoid  and
      sop.solicitudprestamoid = psolicitudp;

if conyuge <> null then
select con.nombre||' '||con.paterno||' '||con.materno into ptexto
from sujeto
where sujetoid = conyuge;
pformato := pformato||ptexto;
end if;

select chr(13)||chr(10)||chr(13)||chr(10)||'                          '||so.fechaalta||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
'          '||to_char(sop.sueldo,'99,999,999.99')||       '                 MES                                '||to_char(sop.gastosordinarios,'99,999,999.99')||'           MES'||chr(13)||chr(10)||
'          '||to_char(sop.sueldoconyuge,'99,999,999.99')||'                 MES                                '||to_char(sop.otrosgastos,'99,999,999.99')     ||'           MES'||chr(13)||chr(10)||
'          '||to_char(sop.otrosingresos,'99,999,999.99')||'                 MES                                '||to_char(sop.otrosabonos,'99,999,999.99')     ||'           MES'||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
'              '||to_char(sop.totalingresos,'99,999,999.99')||'                                                    '||to_char(sop.totalegresos,'99,999,999.99')||chr(13)||chr(10)||chr(13)||chr(10)||
'                         '||to_char(sop.valorpropiedades,'99,999,999.99')||chr(13)||chr(10)||
'                  '||to_char(sop.capacidadpago,'99,999,999.99')||chr(13)||chr(10)
into ptexto 
from socio so, solicitudprestamo sop
where sop.socioid = so.socioid and
sop.solicitudprestamoid = psolicitudp;
pformato := pformato||ptexto;


--calcular saldos
ptexto :='                             0';
pformato := pformato||ptexto;

select '                                                   '||to_char(sum(debe)-sum(haber),'99,999,999.99')||chr(13)||chr(10) into ptexto 
from solicitudprestamo sop,socio so,movicaja mc, movipolizas mp
where sop.socioid = so.socioid and
      so.socioid = mc.socioid and
      mc.movipolizaid = mp.movipolizaid and
      mc.tipomovimientoid = 'AA' and
      sop.solicitudprestamoid = psolicitudp;

if ptexto <>  ' ' then
	pformato := pformato||ptexto;
else
ptexto :='                                                          0';
	pformato := pformato||ptexto;
end if;

select chr(13)||chr(10)||'                             '||to_char(sum(debe)-sum(haber),'99,999,999.99') into ptexto 
from solicitudprestamo sop,socio so,movicaja mc, movipolizas mp
where sop.socioid = so.socioid and
      so.socioid = mc.socioid and
      mc.movipolizaid = mp.movipolizaid and
      mc.tipomovimientoid = 'RG' and
      sop.solicitudprestamoid = psolicitudp;

if ptexto <> ' ' then

         pformato := pformato||ptexto;
else
	ptexto := chr(13)||chr(10)||'                                   0';	
	pformato := pformato||ptexto;
end if;

select so.socioid into socioinv   
from solicitudprestamo sop,socio so
where sop.socioid = so.socioid and
      sop.solicitudprestamoid = psolicitudp;

SELECT '                                                 '||
to_char(sum(depositoinversion),'99,999,999.99') into ptexto 
FROM spsinversiones(socioinv);

if ptexto <> ' ' then
	pformato := pformato||ptexto;
else
ptexto := '                                              0';
	pformato := pformato||ptexto;
end if;

select chr(13)||chr(10)||chr(13)||chr(10)||'                               '||to_char(sum(saldoprestamo),'99,999,999.99')into ptexto 
from solicitudprestamo sop,socio so, prestamos p
where sop.socioid = so.socioid and
so.socioid = p.socioid and
sop.solicitudprestamoid = psolicitudp;

if ptexto <> ' ' then
        
	pformato := pformato||ptexto;
else
	ptexto := '                                      0';
	pformato := pformato||ptexto;
end if; 


select    '                                                  '||to_char(sum(debe)-sum(haber),'99,999,999.99') into ptexto 
from solicitudprestamo sop,socio so,movicaja mc, movipolizas mp
where sop.socioid = so.socioid and
      so.socioid = mc.socioid and
      mc.movipolizaid = mp.movipolizaid and
      mc.tipomovimientoid = 'DV' and
      sop.solicitudprestamoid = psolicitudp;

if ptexto <> ' ' then
	pformato := pformato||ptexto;
else
ptexto := '                                                 0';
	pformato := pformato||ptexto;
end if;


select chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||'                 '||to_char(sop.totaldeudas,'99,999,999.99')||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
'                              '||to_char(sop.montosolicitado,'99,999,999.99')||'              '||cletra(sop.montosolicitado)||chr(13)||chr(10)||
'             '||tp.tipoprestamoid||'                 '||to_char(tp.tasa_normal,'99.99')||'             '||sop.abonospropuestos into ptexto
from solicitudprestamo sop,tipoprestamo tp, finalidades fina,tipo_garantia tg
where
sop.tipoprestamoid = tp.tipoprestamoid and
sop.clavefinalidad = fina.clavefinalidad and
sop.clavegarantia = tg.clavegarantia and
sop.solicitudprestamoid = psolicitudp;

	pformato := pformato||ptexto;

select sop.periodopagoid into ptexto
from solicitudprestamo sop
where sop.solicitudprestamoid = psolicitudp;

if ptexto <> '0' then
  ptexto := '                     X                ';
else
  ptexto := '                                     X';
end if;
	pformato := pformato||ptexto;

  select sop.primerpago into dfecha_otorga 
  from solicitudprestamo sop 
  where sop.solicitudprestamoid = psolicitudp;
  pmes:=cast(date_part('month',dfecha_otorga) as int);
  pdias:=cast(date_part('day',dfecha_otorga) as int);
  
  select sop.montosolicitado into monto 
  from solicitudprestamo sop 
  where sop.solicitudprestamoid = psolicitudp;
  
select sop.tipoprestamoid into tipo 
from solicitudprestamo sop
where sop.solicitudprestamoid = psolicitudp;
  

  select sop.abonospropuestos into abonos 
  from solicitudprestamo sop 
  where sop.solicitudprestamoid = psolicitudp;
  
     select sop.fechaentrega into entrega 
 from solicitudprestamo sop  where sop.solicitudprestamoid = psolicitudp;

select '             '||max(pagototal) into ptexto  from
           sptablaamor(monto,dfecha_otorga,tipo,abonos,r,pmes,pdias,entrega);
pformato := pformato||ptexto;

select chr(13)||chr(10)||chr(13)||chr(10)||'                                                       '||fina.descripcionfinalidad into ptexto 
from solicitudprestamo sop,finalidades fina
where sop.clavefinalidad = fina.clavefinalidad and
sop.solicitudprestamoid = psolicitudp;
pformato := pformato||ptexto;


select chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||'                                                                                     '||sop.usuarioid into ptexto 
from solicitudprestamo sop
where sop.solicitudprestamoid = psolicitudp;
pformato := pformato||ptexto;


return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.imprimesolicitudp(integer, integer) OWNER TO sistema;

--
-- Name: imprimesolicitudp2(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION imprimesolicitudp2(integer) RETURNS text
    AS $_$
declare

  psolicitudp alias for $1;
  pformato text;
  ptexto text;
  dfecha_otorga date;
  pmes int;
  pdia char(2);
  psmes varchar;
  pano char(4);
  r int;
  monto numeric;
  fechaotorga date;
  tipo char(3);
  abonos int;
  entrega date;  
  pdias int;
  pagottl numeric;

begin
 select sop.primerpago into dfecha_otorga 
  from solicitudprestamo sop 
  where sop.solicitudprestamoid = psolicitudp;
  pmes:=cast(date_part('month',dfecha_otorga) as int);
  pdias:=cast(date_part('day',dfecha_otorga) as int);
  
  select sop.montosolicitado into monto 
  from solicitudprestamo sop 
  where sop.solicitudprestamoid = psolicitudp;
  
select sop.tipoprestamoid into tipo 
from solicitudprestamo sop
where sop.solicitudprestamoid = psolicitudp;
  

  select sop.abonospropuestos into abonos 
  from solicitudprestamo sop 
  where sop.solicitudprestamoid = psolicitudp;
  
     select sop.fechaentrega into entrega 
 from solicitudprestamo sop  where sop.solicitudprestamoid = psolicitudp;
select '             '||max(importeamortizacion) into pagottl  from
           sptablaamor(monto,dfecha_otorga,tipo,abonos,r,pmes,pdias,entrega);

  
  pagottl := coalesce(pagottl,0);




  --raise exception 'El formato sera impreso.';

  pformato := chr(15)||
              chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10)||
              chr(13)||chr(10);
 select '                                                                     '||
        to_char(p.montosolicitado,'99,999,999.99')||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        '                               '||to_char(p.montosolicitado,'99,999,999.99')||
        chr(13)||chr(10)||
        '     '||cletra(p.montosolicitado)||
        chr(13)||chr(10)||
        '                                                                       '||
        to_char(p.abonospropuestos,'999')||
        chr(13)||chr(10)||
        '       mensuales'||'                          '||
        to_char(pagottl,'999,999.99')||chr(13)||chr(10)||
        chr(13)||chr(10)||
        '                        '||to_char(p.tasanormal/12,'99.99')||
        chr(13)||chr(10)||
        '                                                           '||
        to_char(2,'999')||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        '                        '||
        to_char(p.tasamoratorio/12,'99.99')||chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        '                                                                       '||
        s.clavesocioint||chr(13)||chr(10)||
        chr(13)||chr(10)||
        '                '||trim(su.nombre)||' '||trim(su.paterno)||' '||trim(su.materno)||chr(13)||chr(10)||
        '                '||d.calle||'  '||d.numero_ext||' '||(case when colo.nombrecolonia = 'NO ESPECIFICADA' then d.comunidad else colo.nombrecolonia end)||chr(13)||chr(10)||
        '                '||c.nombreciudadmex||','||e.nombreestadomex||chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)||
        chr(13)||chr(10)
    into ptexto
    from solicitudprestamo p,socio s,sujeto su,domicilio d,ciudadesmex c,estadosmex e,colonia colo
   where p.solicitudprestamoid=psolicitudp and
         s.socioid = p.socioid and
         su.sujetoid = s.sujetoid and
         d.sujetoid= s.sujetoid and
         c.ciudadmexid = d.ciudadmexid and
         e.estadomexid = c.estadomexid
         and d.coloniaid = colo.coloniaid;



pformato := pformato||ptexto;	
return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.imprimesolicitudp2(integer) OWNER TO sistema;

--
-- Name: ingresoegreso(date, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION ingresoegreso(date, date, character) RETURNS SETOF ringresoegreso
    AS $_$
declare 
  pfechai     alias for $1;
  pfechaf     alias for $2;
  pserie      alias for $3;
  r ringresoegreso%rowtype;
  fdebe  numeric;
  fhaber numeric;
begin

  for r in
SELECT ' ', m.cuentaid, pa.cuentacaja, c.cuentanombre,
       sum(m.debe), sum(m.haber)
  FROM polizas p, movipolizas m, catalogo_ctas c, parametros pa
 WHERE p.fechapoliza between pfechai and pfechaf and
       m.polizaid = p.polizaid and 
       (pserie='  ' or p.seriepoliza=pserie) and
       c.cuentaid = m.cuentaid and
       pa.serie_user = p.seriepoliza and
       substr(c.cuentaid,1,1)<>'7' and
       exists (select polizaid from movicaja
                where tipomovimientoid<>'RE' and polizaid=p.polizaid) 
GROUP BY m.cuentaid, pa.cuentacaja, c.cuentanombre

  loop
    if r.debe=0 or r.haber=0 then
      if r.cuentaid=r.cuentacaja then
        if r.debe>0 then
          r.orden:='A';
          return next r;
        end if;
        if r.haber>0 then
          r.orden:='C';
          return next r;          
        end if;
      else
        if r.debe>0 then
          r.orden:='D';
          return next r;
        end if;
        if r.haber>0 then
          r.orden:='B';
          return next r;
        end if;
      end if;
    else

      if r.cuentaid=r.cuentacaja then

        fdebe:=r.debe;
        fhaber:=r.haber;

        r.orden:='A';
        r.debe:=fdebe;
        r.haber:=0;
        return next r;

        r.orden:='C';
        r.debe:=0;
        r.haber:=fhaber;
        return next r;

      else

        fdebe:=r.debe;
        fhaber:=r.haber;

        r.orden:='D';
        r.debe:=fdebe;
        r.haber:=0;
        return next r;

        r.orden:='B';
        r.debe:=0;
        r.haber:=fhaber;
        return next r;

      end if;
    end if;
  end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.ingresoegreso(date, date, character) OWNER TO sistema;

--
-- Name: instr(character varying, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION instr(character varying, character varying) RETURNS integer
    AS $_$ 
DECLARE 
  pos integer; 
BEGIN 
  pos:= instr($1,$2,1); 
RETURN pos; 
END; 
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.instr(character varying, character varying) OWNER TO sistema;

--
-- Name: instr(character varying, character varying, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION instr(character varying, character varying, integer) RETURNS integer
    AS $_$ 
DECLARE 
  string ALIAS FOR $1; 
  string_to_search ALIAS FOR $2; 
  beg_index ALIAS FOR $3; 
  pos integer NOT NULL DEFAULT 0; 
  temp_str VARCHAR; 
  beg INTEGER; 
  length INTEGER; 
  ss_length INTEGER; 
BEGIN 
  IF beg_index > 0 THEN
     temp_str := substring(string FROM beg_index); 
     pos := position(string_to_search IN temp_str);

    IF pos = 0 THEN
       RETURN 0; 
    ELSE 
       RETURN pos + beg_index - 1; 
    END IF; 
  ELSE 
    ss_length := char_length(string_to_search); 
    length := char_length(string); 
    beg := length + beg_index - ss_length + 2;

    WHILE beg > 0 LOOP 
      temp_str := substring(string FROM beg FOR ss_length); 
      pos := position(string_to_search IN temp_str);

      IF pos > 0 THEN 
         RETURN beg; 
      END IF;

      beg := beg - 1; 
    END LOOP; 
    
    RETURN 0; 
  END IF; 
END; 
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.instr(character varying, character varying, integer) OWNER TO sistema;

--
-- Name: instr(character varying, character varying, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION instr(character varying, character varying, integer, integer) RETURNS integer
    AS $_$ 
DECLARE 
  string ALIAS FOR $1; 
  string_to_search ALIAS FOR $2; 
  beg_index ALIAS FOR $3; 
  occur_index ALIAS FOR $4; 
  pos integer NOT NULL DEFAULT 0; 
  occur_number INTEGER NOT NULL DEFAULT 0; 
  temp_str VARCHAR; 
  beg INTEGER; 
  i INTEGER; 
  length INTEGER; 
  ss_length INTEGER; 
BEGIN 
  IF beg_index > 0 THEN 
     beg := beg_index; 
     temp_str := substring(string FROM beg_index);

     FOR i IN 1..occur_index LOOP 
         pos := position(string_to_search IN temp_str);

         IF i = 1 THEN 
            beg := beg + pos - 1; 
         ELSE 
            beg := beg + pos; 
         END IF;

         temp_str := substring(string FROM beg + 1); 
     END LOOP;

     IF pos = 0 THEN 
        RETURN 0; 
     ELSE 
        RETURN beg; 
     END IF; 
  ELSE 
     ss_length := char_length(string_to_search); 
     length := char_length(string); 
     beg := length + beg_index - ss_length + 2;

     WHILE beg > 0 LOOP 
           temp_str := substring(string FROM beg FOR ss_length); 
           pos := position(string_to_search IN temp_str);

           IF pos > 0 THEN 
              occur_number := occur_number + 1;

              IF occur_number = occur_index THEN 
                 RETURN beg; 
              END IF; 
           END IF;

           beg := beg - 1; 
     END LOOP;

     RETURN 0; 
  END IF; 
END; 
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.instr(character varying, character varying, integer, integer) OWNER TO sistema;

--
-- Name: intdevengadomensual(character, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION intdevengadomensual(character, date, character) RETURNS numeric
    AS $_$
declare

  pclavesocioint alias for $1;
  pfecha alias for $2;
  ptipomovimientoid alias for $3;
  
  psocioid int4;
  interesdev numeric;
  interescal numeric;
  pdiasmes int4;
  pisr numeric;
  ptasainteres numeric;
  psaldopromedio numeric;
  gdiasanualesmov int;
  pfecha1 date;

begin

  select socioid into psocioid from socio where clavesocioint=pclavesocioint;
  select tasainteres into ptasainteres from tipomovimiento where tipomovimientoid=ptipomovimientoid;

  select diasanualesmov into gdiasanualesmov from empresa where empresaid=1;
  
  select sum(mp.debe-mp.haber) into interesdev from polizas p, movicaja mc, movipolizas mp where p.tipo='W' and p.fechapoliza=pfecha+1 and mc.socioid=psocioid and mc.tipomovimientoid=ptipomovimientoid and mc.polizaid=p.polizaid and mc.movipolizaid=mp.movipolizaid;

  interesdev:=coalesce(interesdev,0);

  if interesdev = 0 then 

        pdiasmes:=cast(date_part('day',pfecha) as int4);

--        raise notice ' Interes % %',interesdev,pdiasmes;

        pfecha1:=pfecha-pdiasmes;

        psaldopromedio:=saldopromedio(psocioid,pfecha1,pfecha,ptipomovimientoid);
        interescal:=round(psaldopromedio*(pfecha-pfecha1)*ptasainteres/100/gdiasanualesmov,2);
        pisr:=round(isrinversion(psaldopromedio,(pfecha-pfecha1),psocioid,pfecha),2);
        interesdev:= interescal - pisr;

  end if ;

 -- raise notice ' Interes %',interesdev;

return interesdev;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.intdevengadomensual(character, date, character) OWNER TO sistema;

--
-- Name: interesactual(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesactual(integer) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;

  finteres numeric;

begin

  finteres:=0;
  if pprestamoid is not null then
    select interes into finteres from spscalculopago(pprestamoid);
  end if;
 
return finteres;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.interesactual(integer) OWNER TO sistema;

--
-- Name: interesalahorro(integer, date, date, character, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesalahorro(integer, date, date, character, numeric) RETURNS numeric
    AS $_$
declare
  lsocioid alias for $1;
  pfechai alias for $2;
  pfechaf alias for $3;
  ptipomovimientoid alias for $4;
  ftasa alias for $5;

  r record;

  fsaldoinicial numeric;
  finteres numeric;
  fi numeric;
  dfecha date;

  ftotal numeric;

  gdiasanualesmov int4;
begin

    select diasanualesmov
      into gdiasanualesmov
      from empresa
     where empresaid=1;

    fsaldoinicial := 0;
    fi :=0;
    finteres := 0;
    ftotal := 0;
    dfecha := '1900-01-01';

    for r in

SELECT p.fechapoliza as fecha,
       mp.haber as depositos, mp.debe as retiros
  FROM movicaja m, polizas p, movipolizas mp, tipomovimiento t
 WHERE m.socioid = lsocioid and
       m.tipomovimientoid = ptipomovimientoid and
       p.polizaid = m.polizaid and
       p.fechapoliza<=pfechaf and
       mp.polizaid = p.polizaid and
       t.tipomovimientoid = m.tipomovimientoid and
       (mp.cuentaid = t.cuentadeposito or mp.cuentaid=t.cuentaretiro)
order by p.fechapoliza               

    loop

      if r.fecha<pfechai then
        fsaldoinicial := fsaldoinicial + r.depositos - r.retiros + fi;
        if dfecha='1900-01-01' then
          dfecha := r.fecha;
        else
          fi := fsaldoinicial*(r.fecha-dfecha)*ftasa/100/gdiasanualesmov;
          dfecha := r.fecha;
        end if;        
      else
        if dfecha='1900-01-01' then
          dfecha := r.fecha;
          finteres := 0;
        else
          finteres := fsaldoinicial*(r.fecha-dfecha)*ftasa/100/gdiasanualesmov;
          dfecha := r.fecha;
        end if;

        fsaldoinicial := fsaldoinicial + r.depositos - r.retiros + finteres;
        ftotal := ftotal + finteres;

      end if;

    end loop;

return round(coalesce(ftotal,0),2);
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.interesalahorro(integer, date, date, character, numeric) OWNER TO sistema;

--
-- Name: interesdevengado(integer, date, date, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesdevengado(integer, date, date, numeric) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;
  pfechacorte alias for $2;
  dfecha      alias for $3;
  fsaldoinsoluto alias for $4;

  dfecha_otorga date;
  dfechaf date;
  idiastraspasoavencida int4;
  fmontoprestamo numeric;
  ftasanormal numeric;
  ftasareciprocidad numeric;
  finteres numeric;
  itantos int4;
  idias   int4;
  icalculonormalid int4;

  sformula text;
  rec record;

begin

  finteres:=0;

    select p.montoprestamo,p.tasanormal,p.fecha_otorga,tp.tantos,p.calculonormalid,tp.diastraspasoavencida
      into fmontoprestamo,ftasanormal,dfecha_otorga,itantos,icalculonormalid,idiastraspasoavencida
      from prestamos p, tipoprestamo tp
     where p.prestamoid = pprestamoid and
           tp.tipoprestamoid = p.tipoprestamoid;

  --raise exception 'Fecha %',dfecha;

  if dfecha<pfechacorte then
    --if pfechacorte-dfecha>idiastraspasoavencida then
    --  dfechaf := dfecha+idiastraspasoavencida;
    --else
    --  dfechaf := pfechacorte;
    --end if;
    dfechaf := pfechacorte;

    --raise exception 'Fecha Final para calculo de interes %',dfechaf;

    -- Calcular interes devengado hasta la fecha final

    ftasareciprocidad := tasareciprocidad(fmontoprestamo,fsaldoinsoluto,dfecha_otorga,itantos);
    if ftasareciprocidad<ftasanormal then
      ftasanormal := ftasareciprocidad;
    end if;

    idias := dfechaf - dfecha;

    --raise exception 'Saldo Insoluto %   Tasa %  Dias %',fsaldoinsoluto,ftasanormal,idias;


    finteres := fsaldoinsoluto*idias*((ftasanormal/100)/360);
    if round(finteres,2)-trunc(round(finteres,2))>=0.50 then
      finteres := round(trunc(finteres)+1,2);
    else
      finteres := round(trunc(finteres),2);
    end if;


--    update calculo
--       set saldoinsoluto = fsaldoinsoluto,
--           dias = idias,
--           tasaintnormal = ftasanormal,
--           tasaintmoratorio = 0
--     where calculoid=icalculonormalid;
--
--    SELECT formula into sformula from calculo where calculoid=icalculonormalid;
--
--    for rec in execute
--      'SELECT round(' || sformula || ',2) as interes FROM calculo where calculoid='||icalculonormalid
--    loop
--      if round(rec.interes,2)-trunc(round(rec.interes,2))>=0.50 then
--        finteres := round(trunc(rec.interes)+1,2);
--      else
--        finteres := round(trunc(rec.interes),2);
--      end if;
--    end loop;

  end if;

return finteres;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.interesdevengado(integer, date, date, numeric) OWNER TO sistema;

--
-- Name: interesdevengado(integer, date, date, numeric, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesdevengado(integer, date, date, numeric, character) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;
  pfechacorte alias for $2;
  dfecha      alias for $3;
  fsaldoinsoluto alias for $4;
  pmenorvencido alias for $5;

  dfecha_otorga date;
  dfechaf date;
  idiastraspasoavencida int4;
  fmontoprestamo numeric;
  ftasanormal numeric;
  ftasareciprocidad numeric;
  finteres numeric;
  itantos int4;
  idias   int4;
  icalculonormalid int4;

  sformula text;
  rec record;

  saplica char(1);
begin

   select aplicareciprocidad
     into saplica
     from empresa
    where empresaid=1;

   finteres:=0; 

    select p.montoprestamo,p.tasanormal,p.fecha_otorga,tp.tantos,
           p.calculonormalid,tp.diastraspasoavencida
      into fmontoprestamo,ftasanormal,dfecha_otorga,itantos,
           icalculonormalid,idiastraspasoavencida
      from prestamos p, tipoprestamo tp
     where p.prestamoid = pprestamoid and
           tp.tipoprestamoid = p.tipoprestamoid;

--   if saplica='N' then
--      return ftasanormal;
--   end if;

  --raise exception 'Fecha %',dfecha;

  if dfecha<pfechacorte then

    dfechaf := pfechacorte;

    --raise exception 'Fecha Final para calculo de interes %',dfechaf;

    -- Calcular interes devengado hasta la fecha final
     
    if saplica='S' then
      ftasareciprocidad := tasareciprocidad(fmontoprestamo,fsaldoinsoluto,dfecha_otorga,itantos);

      if ftasareciprocidad<ftasanormal then
        ftasanormal := ftasareciprocidad;
      end if;
    --else
    
    end if;

    if pmenorvencido='S' then
      idias := dfechaf - dfecha;
      if idias<1 then
        finteres := 0;
        return finteres;
      end if;
      if idias>idiastraspasoavencida then
        idias := idiastraspasoavencida;
      end if;
    else
      idias := dfechaf - dfecha - idiastraspasoavencida;
      if idias<1 then
        finteres := 0;
        return finteres;
      end if;
    end if;

    --raise notice 'Interes Devengado Saldo Insoluto %   Tasa %  Dias %',fsaldoinsoluto,ftasanormal,idias;

    finteres := fsaldoinsoluto*idias*((ftasanormal/100)/360);
    if round(finteres,2)-trunc(round(finteres,2))>=0.50 then
      finteres := round(trunc(finteres)+1,2);
    else
      finteres := round(trunc(finteres),2);
    end if;


  end if;

return finteres;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.interesdevengado(integer, date, date, numeric, character) OWNER TO sistema;

--
-- Name: interesdevengadomenor(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesdevengadomenor(integer, date) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;
  pfechacorte alias for $2;

  dfecha_otorga date;
  dfecha date;
  dfechaf date;
  idiastraspasoavencida int4;
  fmontoprestamo numeric;
  fsaldoinsoluto numeric;
  ftasanormal numeric;
  ftasareciprocidad numeric;
  finteres numeric;
  itantos int4;
  idias   int4;
  icalculonormalid int4;

  sformula text;
  rec record;

begin
  finteres:=0;

  -- Buscar la fecha de ultimo pago
  select coalesce((select MAX(po.fechapoliza)
                   from movicaja mc, polizas po, movipolizas mp
                  where mc.prestamoid = p.prestamoid and
                        po.polizaid = mc.polizaid and
                        po.fechapoliza < pfechacorte and
                        mp.polizaid = po.polizaid and
                        mp.cuentaid = tp.cuentaactivo),p.fecha_otorga),
         tp.diastraspasoavencida
    into dfecha,idiastraspasoavencida
    from prestamos p, tipoprestamo tp
   where p.prestamoid = pprestamoid and
         tp.tipoprestamoid = p.tipoprestamoid;

  if dfecha<pfechacorte then
    if pfechacorte-dfecha>idiastraspasoavencida then
      dfechaf := dfecha+idiastraspasoavencida;
    else
      dfechaf := pfechacorte;
    end if;

    -- Calcular el Saldo Insoluto a la fecha de corte
    select p.montoprestamo,
           p.montoprestamo - coalesce(( select sum(m.haber)
                      from movicaja mc, polizas po, movipolizas m
                     where mc.prestamoid = p.prestamoid and
                           po.polizaid = mc.polizaid and
                           po.fechapoliza < pfechacorte and
                           m.polizaid = po.polizaid and
                           m.cuentaid = tp.cuentaintmora ),0),
           p.tasanormal,p.fecha_otorga,tp.tantos,p.calculonormalid
      into fmontoprestamo,fsaldoinsoluto,ftasanormal,dfecha_otorga,itantos,icalculonormalid
      from prestamos p, tipoprestamo tp
     where p.prestamoid = pprestamoid and
           tp.tipoprestamoid = p.tipoprestamoid;


    -- Calcular interes devengado hasta la fecha final

    ftasareciprocidad := tasareciprocidad(fmontoprestamo,fsaldoinsoluto,dfecha_otorga,itantos);
    if ftasareciprocidad<ftasanormal then
      ftasanormal := ftasareciprocidad;
    end if;

    idias := dfechaf - dfecha;

    update calculo
       set saldoinsoluto = fsaldoinsoluto,
           dias = idias,
           tasaintnormal = ftasanormal,
           tasaintmoratorio = 0
     where calculoid=icalculonormalid;

    SELECT formula into sformula from calculo where calculoid=icalculonormalid;

    for rec in execute
      'SELECT round(' || sformula || ',2) as interes FROM calculo where calculoid='||icalculonormalid
    loop
      if round(rec.interes,2)-trunc(round(rec.interes,2))>=0.50 then
        finteres := round(trunc(rec.interes)+1,2);
      else
        finteres := round(trunc(rec.interes),2);
      end if;
    end loop;

  end if;

return finteres;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.interesdevengadomenor(integer, date) OWNER TO sistema;

--
-- Name: interesdevengadoprecorte(integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesdevengadoprecorte(integer, integer, integer) RETURNS numeric
    AS $_$ 
DECLARE

  pprestamoid alias for $1;
  pejercicio alias for $2;
  pperiodo alias for $3;
  fpromedio numeric;
  periodoant integer;
  ejercicioant integer;
  saldoanterior numeric;
  saldoactual numeric;

BEGIN

  fpromedio:= 0;

  if pperiodo = 1 then

    periodoant := 12;
    ejercicioant := pejercicio-1;
  
  else

    periodoant := pperiodo-1;
    ejercicioant := pejercicio;

  end if;

  select interesdevengadomenoravencido+interesdevmormenor into saldoanterior from precorte where prestamoid=pprestamoid and ejercicio=ejercicioant and periodo=periodoant;
  saldoanterior:= coalesce(saldoanterior,0);
  
  select interesdevengadomenoravencido+interesdevmormenor into saldoactual from precorte where prestamoid=pprestamoid and ejercicio=pejercicio and periodo=pperiodo;
  saldoactual:= coalesce(saldoactual,0);

  fpromedio:= (saldoactual-saldoanterior);
  
  fpromedio:=coalesce(fpromedio,0);

RETURN fpromedio; 
END; 
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.interesdevengadoprecorte(integer, integer, integer) OWNER TO sistema;

--
-- Name: interesdevmoratorio(integer, date, date, numeric, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesdevmoratorio(integer, date, date, numeric, character) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;
  pfechacorte alias for $2;
  dfecha      alias for $3;
  fsaldoinsoluto alias for $4;
  pmenorvencido alias for $5;

  fpagado numeric;
  fmoratorio numeric;
  fmormenor numeric;
  fmormayor numeric;
  ftasamoratorio numeric;
  r amortizaciones%rowtype;
  idiastraspasoavencida int4;
  sclaveestadocredito char(3);
begin

  --raise notice 'Procesando PrestamoID=%',pprestamoid;

  fmoratorio := 0;
  fmormenor := 0;
  fmormayor := 0;

  select p.montoprestamo-fsaldoinsoluto,p.tasa_moratoria,t.diastraspasoavencida,
         p.claveestadocredito
    into fpagado,ftasamoratorio,idiastraspasoavencida,sclaveestadocredito
    from prestamos p, tipoprestamo t
   where p.prestamoid = pprestamoid and
         t.tipoprestamoid = p.tipoprestamoid;


  -- Calcular solo para los prestamos vigentes
  if sclaveestadocredito='001' then
  -- Recorrer amortizaciones para ver cuales son las no cubiertas
  -- ya vencidas
  for r in
    select * from amortizaciones
     where prestamoid=pprestamoid
    order by fechadepago
  loop
    if fpagado<r.importeamortizacion then
      if r.fechadepago<pfechacorte then
        -- Calcular moratorio
        if pmenorvencido='S' and pfechacorte-r.fechadepago-30<idiastraspasoavencida then
          if pfechacorte-r.fechadepago-30>0 then
            fmormenor := fmormenor+r.importeamortizacion*(pfechacorte-r.fechadepago-30)*ftasamoratorio/100/360;
          end if;
        else
          if pmenorvencido='N' and pfechacorte-r.fechadepago-30>=idiastraspasoavencida then
            if pfechacorte-r.fechadepago-30>0 then
              fmormayor := fmormayor+r.importeamortizacion*(pfechacorte-r.fechadepago-30)*ftasamoratorio/100/360;
            end if;
          end if;
        end if;
      else
        exit;
      end if;
    else
      fpagado := fpagado - r.importeamortizacion;
    end if;
    
  end loop;

  if pmenorvencido='S' then
    fmoratorio:=coalesce(fmormenor,0);
  else
    fmoratorio:=coalesce(fmormayor,0);
  end if;

  end if;

return fmoratorio;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.interesdevmoratorio(integer, date, date, numeric, character) OWNER TO sistema;

--
-- Name: interesgeneradoinversion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesgeneradoinversion(integer) RETURNS numeric
    AS $_$
declare
  pinversionid alias for $1;

  rec record;
  fdepositoinversion numeric;
  dfechainversion date;
  dfechavencimiento date;
  ftasainteresnormalinversion numeric;
  dfechapagoinversion date;

  iperiodo numeric;
  pdias integer;
  idias integer;

  finteres numeric;
  pcalculoid int4;
  sformula text;
  itiporeinversion integer;

begin

  finteres:=0;

  select depositoinversion,fechainversion,fechavencimiento,tasainteresnormalinversion,ti.calculoid,noderenovaciones,fechapagoinversion
  into fdepositoinversion,dfechainversion,dfechavencimiento,ftasainteresnormalinversion,pcalculoid,itiporeinversion,dfechapagoinversion
  from inversion i, tipoinversion ti where i.inversionid=pinversionid and i.tipoinversionid=ti.tipoinversionid; 

 select periodopagoinversion into pdias from empresa where empresaid=1;

  if itiporeinversion = 3 then

    idias :=current_date-dfechapagoinversion;
   
    --raise notice ' Dias %  Periodo % ',idias,iperiodo;
   
   update calculo
    set saldoinsoluto = fdepositoinversion,
      dias = idias,
      tasaintnormal = ftasainteresnormalinversion
    where calculoid = pcalculoid;

    SELECT formula into sformula from calculo where calculoid=pcalculoid;

    for rec in execute
        'SELECT ' || sformula || ' as interes FROM calculo where calculoid='||pcalculoid
     loop
        finteres := round(rec.interes,2);
     end loop;

  else
    finteres:=0;
  end if;

  return finteres;
  
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.interesgeneradoinversion(integer) OWNER TO sistema;

--
-- Name: interesgeneradoinversionvencimiento(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesgeneradoinversionvencimiento(integer) RETURNS numeric
    AS $_$
declare
  pinversionid alias for $1;

  rec record;
  fdepositoinversion numeric;
  dfechainversion date;
  dfechavencimiento date;
  ftasainteresnormalinversion numeric;
  dfechapagoinversion date;

  iperiodo numeric;
  pdias integer;

  finteres numeric;
  finterespagado numeric;

  pcalculoid int4;
  sformula text;
  itiporeinversion integer;

begin

  finteres:=0;

  select depositoinversion,fechainversion,fechavencimiento,tasainteresnormalinversion,ti.calculoid,noderenovaciones,fechapagoinversion
  into fdepositoinversion,dfechainversion,dfechavencimiento,ftasainteresnormalinversion,pcalculoid,itiporeinversion,dfechapagoinversion
  from inversion i, tipoinversion ti where i.inversionid=pinversionid and i.tipoinversionid=ti.tipoinversionid;
 
  pdias :=current_date-dfechapagoinversion;
   
    update calculo
    set saldoinsoluto = fdepositoinversion,
      dias = pdias,
      tasaintnormal = ftasainteresnormalinversion
    where calculoid = pcalculoid;

    SELECT formula into sformula from calculo where calculoid=pcalculoid;

    for rec in execute
        'SELECT ' || sformula || ' as interes FROM calculo where calculoid='||pcalculoid
     loop
        finteres := round(rec.interes,2);
     end loop;

    finteres := coalesce(finteres,0);

  return finteres;
  
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.interesgeneradoinversionvencimiento(integer) OWNER TO sistema;

--
-- Name: interesinversion(numeric, numeric, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesinversion(numeric, numeric, integer, integer) RETURNS numeric
    AS $_$
declare
  pmonto alias for $1;
  ptasa  alias for $2;
  pcalculoid alias for $3;
  pdias alias for $4;

  sformula text;
  rec record;
  finteres numeric;

  pinteresanual numeric;
  pisranual numeric;
  ptasabruta numeric;
  ptasaisr numeric;

 
begin

  finteres:=0;

  if pcalculoid=4 then

      pinteresanual := pmonto * ptasa / 100;
      pisranual := pinteresanual*1.3889*.28;
      ptasabruta := (pinteresanual+pisranual)/pmonto;
      ptasaisr := ptasabruta * .28;
      finteres := pmonto * (ptasabruta / 360) * pdias;
      raise notice ' fisr % ftasab % tasaisr % finteres % pmonto % dias % ',pisranual,ptasabruta,ptasaisr,finteres,pmonto,pdias;

  else 
     update calculo
     set saldoinsoluto = pmonto,
         dias = pdias,
         tasaintnormal = ptasa
     where calculoid = pcalculoid;

     SELECT formula into sformula from calculo where calculoid=pcalculoid;

     for rec in execute
        'SELECT ' || sformula || ' as interes FROM calculo where calculoid='||pcalculoid
     loop
        finteres := round(rec.interes,2);
     end loop;
  End if;

return finteres;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.interesinversion(numeric, numeric, integer, integer) OWNER TO sistema;

--
-- Name: interesinversionpagado(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION interesinversionpagado(integer) RETURNS numeric
    AS $_$
declare
  pinversionid  alias for $1;

  finteres    numeric;

begin

  finteres    :=0;

  select sum((select coalesce(sum(debe),0) from movipolizas
  where movipolizas.polizaid=mc.polizaid and  movipolizas.cuentaid = ti.cuentaintinver))  into finteres
  from movicaja mc, inversion i, tipoinversion ti where mc.inversionid=pinversionid
  and i.inversionid = mc.inversionid and ti.tipoinversionid = i.tipoinversionid;

  finteres := coalesce(finteres,0);
return finteres;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.interesinversionpagado(integer) OWNER TO sistema;

--
-- Name: inversionesxfecha(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION inversionesxfecha(date) RETURNS SETOF inversiones
    AS $_$
declare
  r inversiones%rowtype;
  pfecha alias for $1;
  gdiasanualesinversion int4;
begin

  select diasanualesinversion
    into gdiasanualesinversion
    from empresa;

    for r in

select s.clavesocioint, su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
        i.inversionid, i.fechainversion,i.fechavencimiento,i.tasainteresnormalinversion, t.plazo, SUM((case when mp.cuentaid=t.cuentapasivo
                 then mp.haber-mp.debe
                 else 0 end)) AS deposito,
( pfecha -
       COALESCE(MAX(case when mp.cuentaid=t.cuentaintinver
               then (case when p.fechapoliza<pfecha
                          then p.fechapoliza
                          else i.fechainversion end)
               else i.fechainversion end),i.fechainversion))
,
       i.fechapagoanterior,
( pfecha -
       COALESCE(MAX(case when mp.cuentaid=t.cuentaintinver
               then (case when p.fechapoliza<pfecha
                          then p.fechapoliza
                          else i.fechainversion end)
               else i.fechainversion end),i.fechainversion))*i.tasainteresnormalinversion/100/gdiasanualesinversion*SUM((case when mp.cuentaid=t.cuentapasivo
                 then mp.haber-mp.debe
                 else 0 end)),i.tipoinversionid,i.socioid,' '
   from socio s, polizas p, movicaja m, movipolizas mp, inversion i, tipoinversion t,sujeto su
  where i.fechainversion<=pfecha and
       m.inversionid = i.inversionid and
       p.polizaid = m.polizaid and
       p.fechapoliza <= pfecha and
       t.tipoinversionid = i.tipoinversionid and
       mp.polizaid = p.polizaid and
       s.socioid = i.socioid and
       su.sujetoid = s.sujetoid
group by s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno, i.inversionid, i.fechainversion,i.fechavencimiento,i.tasainteresnormalinversion, t.plazo, i.fechapagoanterior, i.depositoinversion,i.tipoinversionid,i.socioid
having SUM((case when mp.cuentaid=t.cuentapasivo
                 then mp.haber-mp.debe
                 else 0 end))>0 
order by sum(mp.haber)-sum(mp.debe)

    loop
      select grupo into r.grupo from solicitudingreso where socioid=r.socioid;
      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.inversionesxfecha(date) OWNER TO sistema;

--
-- Name: inversionesxfechac(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION inversionesxfechac(date) RETURNS SETOF inversiones
    AS $_$
declare
  r inversiones%rowtype;
  pfecha alias for $1;
  f record;
  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||';select * from inversionesxfecha('||''''||to_char(pfecha,'yyyy-mm-dd')||''''||');';

  for r in
    select * from
    dblink(dblink1,dblink2) as
    t ( clavesocioint      char(15),
        nombresocio        varchar(80),
        inversionid        int4,
        fechainversion     date,
        fechavencimiento   date,
        tasainteresnormalinversion numeric,
        plazo              int4,
        deposito           numeric,
        diasvencimiento    int4,
        fechapagoanterior  date,
        interes            numeric,
        tipoinversionid    char(3),
        socioid            integer,
        grupo character(25))
  loop
    return next r;
  end loop;

end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.inversionesxfechac(date) OWNER TO sistema;

--
-- Name: inversionesxtipo(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION inversionesxtipo(date) RETURNS SETOF inversionesxtipo
    AS $_$
declare
  r inversionesxtipo%rowtype;
  pfecha alias for $1;
  gdiasanualesinversion int4;
begin

  select diasanualesinversion
    into gdiasanualesinversion
    from empresa;

    for r in

select i.tipoinversionid,t.cuentapasivo,s.clavesocioint, su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
        i.inversionid, i.fechainversion,i.fechavencimiento,i.tasainteresnormalinversion, t.plazo, SUM((case when mp.cuentaid=t.cuentapasivo
                 then mp.haber-mp.debe
                 else 0 end)) AS deposito,
( pfecha -
       COALESCE(MAX(case when mp.cuentaid=t.cuentaintinver
               then (case when p.fechapoliza<pfecha
                          then p.fechapoliza
                          else i.fechainversion end)
               else i.fechainversion end),i.fechainversion))
,
       i.fechapagoanterior,
( pfecha -
       COALESCE(MAX(case when mp.cuentaid=t.cuentaintinver
               then (case when p.fechapoliza<pfecha
                          then p.fechapoliza
                          else i.fechainversion end)
               else i.fechainversion end),i.fechainversion))*i.tasainteresnormalinversion/100/gdiasanualesinversion*SUM((case when mp.cuentaid=t.cuentapasivo
                 then mp.haber-mp.debe
                 else 0 end))


   from socio s, polizas p, movicaja m, movipolizas mp, inversion i, tipoinversion t,sujeto su
  where i.fechainversion<=pfecha and
       m.inversionid = i.inversionid and
       p.polizaid = m.polizaid and
       p.fechapoliza <= pfecha and
       t.tipoinversionid = i.tipoinversionid and
       mp.polizaid = p.polizaid and
       s.socioid = i.socioid and
       su.sujetoid = s.sujetoid
group by i.tipoinversionid,t.cuentapasivo,s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno, i.inversionid, i.fechainversion,i.fechavencimiento,i.tasainteresnormalinversion, t.plazo, i.fechapagoanterior, i.depositoinversion
having SUM((case when mp.cuentaid=t.cuentapasivo
                 then mp.haber-mp.debe
                 else 0 end))>0 
order by sum(mp.haber)-sum(mp.debe)

    loop
      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.inversionesxtipo(date) OWNER TO sistema;

--
-- Name: inversionmenor(date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION inversionmenor(date, integer) RETURNS numeric
    AS $_$
declare
  pfecha alias for $1;
  idias alias for $2;
  ltotal numeric;
begin

  ltotal := 0;
  select sum(deposito)
    into ltotal
    from inversionesxfecha(pfecha)
   where diasvencimiento<=idias;

  ltotal:=coalesce(ltotal,0);

return ltotal;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.inversionmenor(date, integer) OWNER TO sistema;

--
-- Name: inversionmenorc(date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION inversionmenorc(date, integer) RETURNS numeric
    AS $_$
declare
  pfecha alias for $1;
  idias  alias for $2;
  ltotal numeric;

  r record;
  f record;
  dblink1 text;
  dblink2 text;


begin

ltotal:=0;

for f in
 select * from sucursales where vigente='S'
 loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
        dblink2:='set search_path to public,'||f.esquema||';select * from inversionmenor('||''''||to_char(pfecha,'yyyy-mm-dd')||''''||','||to_char(idias,'99999')||');';

        raise notice 'dblink % %',dblink1,dblink2;
  for r in
   select * from
    dblink(dblink1,dblink2) as t2(total numeric)

  loop
    ltotal:=ltotal+coalesce(r.total,0);

  end loop;

end loop;

return ltotal;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.inversionmenorc(date, integer) OWNER TO sistema;

--
-- Name: is_password(text, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION is_password(text, text) RETURNS boolean
    AS $_$
DECLARE
	pass TEXT;
	salt TEXT;
	new  TEXT;
BEGIN
    SELECT INTO pass contrasenia FROM usuarios WHERE usuarioid=$1;
	IF FOUND THEN		
		IF pass = $2
			THEN RETURN 't';
		END IF;
	END IF;
	RETURN 'f';
END;$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.is_password(text, text) OWNER TO sistema;

--
-- Name: isrinversion(numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION isrinversion(numeric, integer) RETURNS numeric
    AS $_$
declare
  pmonto alias for $1;
  pdias alias for $2;

  fisr numeric;
  pinversionexenta numeric;
  pporcentajeinversion numeric;

  gdiasanualesinversion int4;
begin

  select diasanualesinversion
    into gdiasanualesinversion
    from empresa
   where empresaid=1;

  select inversionexenta,porcentajeisrinversion
    into  pinversionexenta,pporcentajeinversion from empresa;

  if pmonto > pinversionexenta then
        -- Calculo inversion Reforma 
        fisr=round((pmonto-pinversionexenta)*pporcentajeinversion/gdiasanualesinversion*pdias,2);
        -- Calculo inversion calero
        --fisr=round(pmonto*pporcentajeinversion/gdiasanualesinversion*pdias,2);
  else
        fisr=0;
  end if;

  return fisr;
  
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.isrinversion(numeric, integer) OWNER TO sistema;

--
-- Name: isrinversion(numeric, integer, integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION isrinversion(numeric, integer, integer, date) RETURNS numeric
    AS $_$
declare
  pmonto alias for $1;
  pdias alias for $2;
  psocio alias for $3;
  pfecha alias for $4;

  fisr numeric;
  pinversionexenta numeric;
  pporcentajeinversion numeric;
  phaberes numeric;
  gdiasanualesinversion int4;

begin

 select diasanualesinversion
    into gdiasanualesinversion
    from empresa
   where empresaid=1;

  select inversionexenta,porcentajeisrinversion
    into  pinversionexenta,pporcentajeinversion from empresa;
    
  if pmonto > pinversionexenta then
        -- Calculo inversion Reforma 
        fisr=round((pmonto-pinversionexenta)*pporcentajeinversion/gdiasanualesinversion*pdias,2);
        -- Calculo inversion calero
        --fisr=round(pmonto*pporcentajeinversion/gdiasanualesinversion*pdias,2);
  else
        fisr=0;
  end if;

  return fisr;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.isrinversion(numeric, integer, integer, date) OWNER TO sistema;

--
-- Name: isrinversionahorro(numeric, integer, integer, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION isrinversionahorro(numeric, integer, integer, date, integer) RETURNS numeric
    AS $_$
declare
  pmonto alias for $1;
  pdias alias for $2;
  psocio alias for $3;
  pfecha alias for $4;
  pdevenga alias for $5;

  fisr numeric;
  pinversionexenta numeric;
  pporcentajeinversion numeric;
  phaberes numeric;
  fsaldoahorro numeric;
  fsaldoctacor numeric;
  fsaldoinver numeric;

begin

  select inversionexenta,porcentajeisrinversion into  pinversionexenta,pporcentajeinversion from empresa;

  select sum(mp.debe)-sum(mp.haber) into fsaldoahorro
        from movicaja mc, movipolizas mp
        where mc.socioid=psocio and
          mc.tipomovimientoid='AA' and
          mp.movipolizaid=mc.movipolizaid;
         fsaldoahorro:=coalesce(fsaldoahorro,0);

  select sum(mp.debe)-sum(mp.haber) into fsaldoctacor
        from movicaja mc, movipolizas mp
        where mc.socioid=psocio and
          mc.tipomovimientoid='CU' and
          mp.movipolizaid=mc.movipolizaid;
         fsaldoctacor:=coalesce(fsaldoctacor,0);

  select sum(mp.debe)-sum(mp.haber) into fsaldoinver
        from movicaja mc, movipolizas mp
        where mc.socioid=psocio and
          mc.tipomovimientoid='IN' and
          mp.movipolizaid=mc.movipolizaid;
         fsaldoinver:=coalesce(fsaldoinver,0);

  --select buscahaberes(psocio,pfecha) into phaberes;

  phaberes=fsaldoahorro+fsaldoctacor+fsaldoinver;

  if phaberes > pinversionexenta then
        fisr=round((pmonto)*pporcentajeinversion/365*pdias,2);
  else
        fisr=0;
  end if;
  return fisr;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.isrinversionahorro(numeric, integer, integer, date, integer) OWNER TO sistema;

--
-- Name: isrinversionmes(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION isrinversionmes(integer) RETURNS numeric
    AS $_$
declare

  pinversionid alias for $1;

  pdias integer;
  fisr numeric;
  pinversionexenta numeric;
  pporcentajeinversion numeric;
  phaberes numeric;
  gdiasanualesinversion int4;

  fdepositoinversion numeric;
  dfechainversion date;
  dfechavencimiento date;
  ftasainteresnormalinversion numeric;
  dfechapagoinversion date;

  iperiodo numeric;
  idias integer;
  pcalculoid int4;
  itiporeinversion integer;

begin


  select depositoinversion,fechainversion,fechavencimiento,tasainteresnormalinversion,ti.calculoid,noderenovaciones,i.fechapagoinversion into fdepositoinversion,dfechainversion,dfechavencimiento,ftasainteresnormalinversion,pcalculoid,itiporeinversion,dfechapagoinversion  from inversion i, tipoinversion ti where i.inversionid=pinversionid and i.tipoinversionid=ti.tipoinversionid;

  if itiporeinversion = 3 then 

    select inversionexenta,porcentajeisrinversion,diasanualesinversion,periodopagoinversion
      into  pinversionexenta,pporcentajeinversion,gdiasanualesinversion,pdias from empresa where empresaid=1;

    dfechapagoinversion:=coalesce(dfechapagoinversion,dfechainversion);
    pdias :=current_date - dfechapagoinversion;
   
    if fdepositoinversion > pinversionexenta then
      fisr=round((fdepositoinversion-pinversionexenta)*pporcentajeinversion/gdiasanualesinversion*pdias,2);
    else
      fisr=0;
    end if;

  else
    fisr=0;
  end if;

  return fisr;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.isrinversionmes(integer) OWNER TO sistema;

--
-- Name: isrinversionretenido(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION isrinversionretenido(integer) RETURNS numeric
    AS $_$
declare
  pinversionid  alias for $1;

  fisr    numeric;

begin

  fisr    :=0;

  select sum((select coalesce(sum(debe),0) from movipolizas
  where movipolizas.polizaid=mc.polizaid and  movipolizas.cuentaid = ti.cuentariesgocred))  into fisr
  from movicaja mc, inversion i, tipoinversion ti where mc.inversionid=pinversionid
  and i.inversionid = mc.inversionid and ti.tipoinversionid = i.inversionid;

  fisr := coalesce(fisr,0);


return fisr;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.isrinversionretenido(integer) OWNER TO sistema;

--
-- Name: isrinversionvencimiento(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION isrinversionvencimiento(integer) RETURNS numeric
    AS $_$
declare

  pinversionid alias for $1;

  pdias integer;
  fisr numeric;
  pinversionexenta numeric;
  pporcentajeinversion numeric;
  phaberes numeric;
  gdiasanualesinversion int4;

  fdepositoinversion numeric;
  dfechainversion date;
  dfechavencimiento date;
  ftasainteresnormalinversion numeric;
  dfechapagoinversion date;

  iperiodo numeric;
  idias integer;
  pcalculoid int4;
  itiporeinversion integer;

begin

  select depositoinversion,fechainversion,fechavencimiento,tasainteresnormalinversion,ti.calculoid,noderenovaciones,fechapagoinversion
  into fdepositoinversion,dfechainversion,dfechavencimiento,ftasainteresnormalinversion,pcalculoid,itiporeinversion,dfechapagoinversion
  from inversion i, tipoinversion ti where i.inversionid=pinversionid and i.tipoinversionid=ti.tipoinversionid;

    select inversionexenta,porcentajeisrinversion,diasanualesinversion,periodopagoinversion
      into  pinversionexenta,pporcentajeinversion,gdiasanualesinversion,pdias from empresa where empresaid=1;

    pdias :=dfechavencimiento-dfechapagoinversion;

    if fdepositoinversion > pinversionexenta then
      fisr=round((fdepositoinversion-pinversionexenta)*pporcentajeinversion/gdiasanualesinversion*pdias,2);
    else
      fisr=0;
    end if;

  return fisr;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.isrinversionvencimiento(integer) OWNER TO sistema;

--
-- Name: ivaactual(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION ivaactual(integer) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;

  fiva numeric;

begin
  fiva:=0;
  if pprestamoid is not null then
    select iva into fiva from spscalculopago(pprestamoid);
  end if;
 
return fiva;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.ivaactual(integer) OWNER TO sistema;

--
-- Name: libromayor(integer, integer, integer, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION libromayor(integer, integer, integer, character, character) RETURNS SETOF rlibromayor
    AS $_$
declare
  pejercicio alias for $1;
  pperiodoi  alias for $2;
  pperiodof  alias for $3;
  pcuentai   alias for $4;
  pcuentaf   alias for $5;

  r rlibromayor%rowtype;
  mr record;

  scuentaid char(24);
  fcargosa numeric;
  fabonosa numeric;
  fsaldo numeric;
begin

  scuentaid:='';
  fcargosa:=0;
  fabonosa:=0;
  fsaldo:=0;

  for mr in
select p.periodo, m.cuentaid, c.cuentanombre,
       sum(m.debe) as cargosm, sum(m.haber) as abonosm
  from polizas p, movipolizas m, catalogo_ctas c
 where p.ejercicio=pejercicio and
       p.periodo>=pperiodoi and p.periodo<=pperiodof and
       m.polizaid=p.polizaid and
       m.cuentaid>=pcuentai and m.cuentaid<=pcuentaf and
       c.cuentaid=m.cuentaid
group by p.periodo,m.cuentaid,c.cuentanombre
order by m.cuentaid,p.periodo

  loop
    if scuentaid='' then

      scuentaid := mr.cuentaid;
      fcargosa  := coalesce(mr.cargosm,0);
      fabonosa  := coalesce(mr.abonosm,0);

      select sum(debe-haber)
        into fsaldo
        from polizas p, movipolizas m
       where (p.ejercicio<pejercicio or
               (p.ejercicio=pejercicio and p.periodo<pperiodoi)) and
             m.polizaid=p.polizaid and
             m.cuentaid=mr.cuentaid;

raise notice 'saldo === %',fsaldo;

      fsaldo := coalesce(fsaldo,0);
      fsaldo := fsaldo+mr.cargosm-mr.abonosm;

      r.cuentaid := mr.cuentaid;
      r.cuentanombre := mr.cuentanombre;
      r.periodo := mr.periodo;
      r.cargosm := coalesce(mr.cargosm,0);
      r.abonosm := coalesce(mr.abonosm,0);
      r.saldo   := fsaldo;
      r.cargosa := fcargosa;
      r.abonosa := fabonosa;

      return next r;
    else

      if scuentaid=mr.cuentaid then
        fcargosa  := fcargosa + mr.cargosm;
        fabonosa  := fabonosa + mr.abonosm;

        fsaldo := fsaldo+mr.cargosm-mr.abonosm;

        r.cuentaid := mr.cuentaid;
        r.cuentanombre := mr.cuentanombre;
        r.periodo := mr.periodo;
        r.cargosm := mr.cargosm;
        r.abonosm := mr.abonosm;
        r.saldo   := fsaldo;
        r.cargosa := fcargosa;
        r.abonosa := fabonosa;

        return next r;

      else
        scuentaid := mr.cuentaid;
        fcargosa  := mr.cargosm;
        fabonosa  := mr.abonosm;

      select sum(debe-haber)
        into fsaldo
        from polizas p, movipolizas m
       where (p.ejercicio<pejercicio or
               (p.ejercicio=pejercicio and p.periodo<pperiodoi)) and
             m.polizaid=p.polizaid and
             m.cuentaid=mr.cuentaid;

        fsaldo := coalesce(fsaldo,0)+mr.cargosm-mr.abonosm;

        r.cuentaid := mr.cuentaid;
        r.cuentanombre := mr.cuentanombre;
        r.periodo := mr.periodo;
        r.cargosm := mr.cargosm;
        r.abonosm := mr.abonosm;
        r.saldo   := fsaldo;
        r.cargosa := fcargosa;
        r.abonosa := fabonosa;

        return next r;

      end if;


    end if;

  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.libromayor(integer, integer, integer, character, character) OWNER TO sistema;

--
-- Name: libromayorc(integer, integer, integer, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION libromayorc(integer, integer, integer, character, character) RETURNS SETOF rlibromayor
    AS $_$
declare
  pejercicio alias for $1;
  pperiodoi  alias for $2;
  pperiodof  alias for $3;
  pcuentai   alias for $4;
  pcuentaf   alias for $5;

  r rlibromayor%rowtype;

 f record;
  dblink1 text;
  dblink2 text;
begin

for f in
 select * from sucursales where vigente='S'
 loop

  raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

  dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
  dblink2:='set search_path to public,'||f.esquema||';select * from libromayor('||pejercicio||','||pperiodoi||','||pperiodof||','||''''||pcuentai||''''||','||''''||pcuentaf||''''||');';

  for r in
    select * from
    dblink(dblink1,dblink2) as
    t ( cuentaid             char(24),
        cuentanombre         char(50),
        periodo              int4,
        cargosm              numeric,
        abonosm              numeric,
        saldo                numeric,
        cargosa              numeric,
        abonosa              numeric )

  loop
    r.cuentanombre = '';
    return next r;
  end loop;

  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.libromayorc(integer, integer, integer, character, character) OWNER TO sistema;

--
-- Name: llenaconoceatucliente(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION llenaconoceatucliente() RETURNS integer
    AS $$
declare
r record;

pactividad             char(100);
ppoblacionindigena     char(2);
pcomunidadconapo       char(10);
j integer;

begin

j:=0;
for r in select s.sujetoid,s.socioid,d.coloniaid from socio s, sujeto su, domicilio d where s.sujetoid=su.sujetoid and su.sujetoid=d.sujetoid 
   loop
      if not exists (select sujetoid from conoceatucliente where sujetoid=r.sujetoid) then

         insert into conoceatucliente(sujetoid,socioid,comunidadconapo,poblacionindigena) values(r.sujetoid,r.socioid,pcomunidadconapo,'NO');
         j:=j+1;       

         raise notice ' %  % ',r.socioid,pcomunidadconapo;
       
      end if;

   end loop;

return j;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.llenaconoceatucliente() OWNER TO sistema;

--
-- Name: login(character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION "login"(character, character) RETURNS integer
    AS $_$
declare
  plogin      alias for $1;
  ppasssword  alias for $2;

  spassword   varchar;
begin

  select contrasenia
    into spassword
    from usuarios
   where usuarioid=plogin;

   spassword := coalesce(spassword,'');

  if ltrim(rtrim(spassword))=ltrim(rtrim(ppasssword)) then
    return 1; 
  end if;

return 0;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public."login"(character, character) OWNER TO sistema;

--
-- Name: meses(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION meses(date, date) RETURNS integer
    AS $_$
declare
  pfechai alias for $1;
  pfechaf alias for $2;

  i int4;

  dfecha date;
begin

  dfecha:=pfechai;
  i:=0;


  if dfecha<pfechaf then
  loop
    dfecha:= dfecha + interval '1 month';
    if dfecha>pfechaf then
      if i=0 and date_part('month',pfechai)<>date_part('month',pfechaf) and pfechaf>pfechai then
        i:=1;
      end if;
      exit;
    end if;
    i:=i+1;
  end loop;
  end if;

return i;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.meses(date, date) OWNER TO sistema;

--
-- Name: migra_ai(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION migra_ai() RETURNS integer
    AS $$
declare


  scuentadeposito char(24);
  scuentaretiro char(24);
  scuentacaja char(24);

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;

  r record;

  sserie char(2);

  dfecha date;

begin

 dfecha:=CURRENT_DATE;

 select cuentacaja
   into scuentacaja
   from parametros
  where serie_user='XA';

 select cuentadeposito
   into scuentadeposito
   from tipomovimiento
  where tipomovimientoid='AA';

 select cuentaretiro
   into scuentaretiro
   from tipomovimiento
  where tipomovimientoid='IA';

  sserie:='XA';

for r in

select mc.socioid,mc.tipomovimientoid, tm.desctipomovimiento,
       sum(mp.debe)-sum(mp.haber) as saldo
   from movicaja mc, movipolizas mp, tipomovimiento tm
  where mc.tipomovimientoid='IA' and
        mp.movipolizaid=mc.movipolizaid and
        tm.tipomovimientoid=mc.tipomovimientoid and
        mc.tipomovimientoid<>'00' and
        mc.tipomovimientoid<>'IN' and
        tm.aplicasaldo='S'
 group by mc.socioid,mc.tipomovimientoid,tm.desctipomovimiento
 having sum(mp.debe)-sum(mp.haber)>0
 order by mc.socioid,mc.tipomovimientoid 

loop

   raise notice 'Procesando %',r.socioid;

   --
   -- Realizar retiro de IA
   --

  select *
    into pnumero_poliza,preferencia
    from rconspoliza(cast(date_part('year',dfecha) as int),cast(date_part('month',dfecha) as int),'S',sserie,'D');

  -- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipoliza(preferencia,sserie,'S',pnumero_poliza,cast(date_part('year',dfecha) as int),cast(date_part('month',dfecha) as int),' ',dfecha,'D',' ',' ','Mov. de traspaso',dfecha);

  -- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','C',0,r.saldo,' ',' ','Traspaso AI');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentaretiro,' ','A',r.saldo,0,' ',' ','Traspaso AI');

   -- Movimiento de caja

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie;

   lreferenciacaja := lreferenciacaja+1;   

   select *
     into pmovicajaid
     from spimovicaja(r.socioid,'IA',ppolizaid,lreferenciacaja,sserie,pmovipolizaid,NULL,'A',NULL);



   --
   -- Realizar deposito a AA
   --

  select *
    into pnumero_poliza,preferencia
    from rconspoliza(cast(date_part('year',dfecha) as int),cast(date_part('month',dfecha) as int),'S',sserie,'D');

  -- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipoliza(preferencia,sserie,'S',pnumero_poliza,cast(date_part('year',dfecha) as int),cast(date_part('month',dfecha) as int),' ',dfecha,'D',' ',' ','Movimiento de Traspaso',dfecha);

   -- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','C',r.saldo,0,' ',' ','Traspaso AI');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentadeposito,' ','A',0,r.saldo,' ',' ','Traspaso AI');

   -- Movimiento de caja

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie;

   lreferenciacaja := lreferenciacaja+1;   

   select *
     into pmovicajaid
     from spimovicaja(r.socioid,'AA',ppolizaid,lreferenciacaja,sserie,pmovipolizaid,NULL,'A',NULL);




end loop;


return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.migra_ai() OWNER TO sistema;

--
-- Name: migrasocios(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION migrasocios() RETURNS integer
    AS $$
declare
  r record;
  l int4;
  i int4;
begin
    l:=1;
    for r in
      select s.*,su.*,d.*
        from socio s, sujeto su, domicilio d
       where su.sujetoid = s.sujetoid and
             d.sujetoid = s.sujetoid
     order by s.clavesocioint
    loop
      select * into i from
       spisolicitudingreso(l,r.fechaalta,r.fechaalta,
                           r.socioid,r.sujetoid,r.ciudadmexid,0,0,
                           ' ',' ',0,0,NULL,
                           0,' ',0,
                           0,0,' ',' ',
                           ' ',NULL,'supervisor','supervisor',
                           current_date,r.tiposocioid,' ');
      update socio
         set solicitudingresoid=i
       where socioid=r.socioid;

      update solicitudingreso
         set socioid=r.socioid
       where solicitudingresoid=i;

      l=l+1;
    end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.migrasocios() OWNER TO sistema;

--
-- Name: moratorioactual(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION moratorioactual(integer) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;

  finteres numeric;

begin
  finteres:=0;
  if pprestamoid is not null then
    select moratorio into finteres from spscalculopago(pprestamoid);
  end if;
 
return finteres;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.moratorioactual(integer) OWNER TO sistema;

--
-- Name: movimientos(character, character, date, date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION movimientos(character, character, date, date, character, character) RETURNS SETOF movimientos
    AS $_$
declare
  pcuentai    alias for $1;
  pcuentaf    alias for $2;
  pfechai     alias for $3;
  pfechaf     alias for $4;
  psoloconmov alias for $5;
  pacumulaporfecha alias for $6;

  r movimientos%rowtype;
  s movimientos%rowtype;

  rc record;

  a record;

  lsaldoinicial numeric;
  ldebe  numeric;
  lhaber numeric;

  scuentaid char(24);
  bfound bool;
begin

  ldebe :=0;
  lhaber :=0;
  scuentaid := ' '; 

  if pacumulaporfecha='N' then
     bfound:=false;
     for r in

SELECT m.cuentaid,p.seriepoliza as serie,p.numero_poliza,
       referenciapoliza(p.polizaid) as referencia,
       p.fechapoliza as fecha,m.descripcion as concepto,
       0 AS saldoinicial,m.debe,m.haber,0 as saldofinal,
       p.tipo_poliza
  FROM polizas p, movipolizas m
 WHERE p.fechapoliza BETWEEN pfechai AND pfechaf AND
       m.polizaid = p.polizaid AND
       m.cuentaid>=pcuentai AND m.cuentaid<=pcuentaf
ORDER BY m.cuentaid,p.fechapoliza,p.seriepoliza,p.numero_poliza

     loop
       bfound:=true;      
       if scuentaid<>r.cuentaid then
         if scuentaid<>'  ' then
           s.cuentaid := scuentaid;
           s.serie := 'AA';
           s.numero_poliza := -1;

           select sum(m.debe)-sum(m.haber)
             into lsaldoinicial
             from polizas p, movipolizas m
            where p.fechapoliza < pfechai and
                  m.polizaid = p.polizaid and
                  m.cuentaid = scuentaid;

           lsaldoinicial := coalesce(lsaldoinicial,0);
           s.saldoinicial := lsaldoinicial;
           s.debe := ldebe;
           s.haber := lhaber;
           s.saldofinal := lsaldoinicial + ldebe - lhaber;
           s.fecha := '2000-01-01';

           return next s;
         end if;
         scuentaid := r.cuentaid;
         ldebe := 0;
         lhaber := 0;
       end if;


       ldebe := ldebe + r.debe;
       lhaber := lhaber + r.haber;
       return next r;

     end loop;


     if not bfound then
       scuentaid := pcuentai;
     end if;

     s.cuentaid := scuentaid;
     s.serie := 'AA';
     s.numero_poliza := -1;
     s.fecha := '2000-01-01';      
     select sum(m.debe)-sum(m.haber)
       into lsaldoinicial
       from polizas p, movipolizas m
      where p.fechapoliza < pfechai and
            m.polizaid = p.polizaid and
            m.cuentaid = scuentaid;

     lsaldoinicial := coalesce(lsaldoinicial,0);
     s.saldoinicial := lsaldoinicial;
     s.debe := ldebe;
     s.haber := lhaber;
     s.saldofinal := lsaldoinicial + ldebe - lhaber;

     return next s;


     if pcuentai<>pcuentaf then

     for rc in
       select c.cuentaid
         from catalogo_ctas c
        where c.cuentaid>=pcuentai AND c.cuentaid<=pcuentaf AND
              c.cuentaid not in (
                SELECT m.cuentaid
                  FROM polizas p, movipolizas m
                 WHERE p.fechapoliza BETWEEN pfechai AND pfechaf AND
                       m.polizaid = p.polizaid AND
                       m.cuentaid>=pcuentai AND m.cuentaid<=pcuentaf
                GROUP BY m.cuentaid
              ) AND
              c.tipo_cta='A'
     loop

       s.cuentaid := rc.cuentaid;
       s.serie := 'AA';
       s.numero_poliza := -1;
       s.fecha := '2000-01-01';

     select sum(m.debe)-sum(m.haber)
       into lsaldoinicial
       from polizas p, movipolizas m
      where p.fechapoliza < pfechai and
            m.polizaid = p.polizaid and
            m.cuentaid = rc.cuentaid;
  
       lsaldoinicial := coalesce(lsaldoinicial,0);
       s.saldoinicial := lsaldoinicial;
       s.debe := 0;
       s.haber := 0;
       s.saldofinal := lsaldoinicial;
       if lsaldoinicial>0 then
         return next s;
       end if;
     end loop;

     end if;



  else


     bfound:=false;
     for a in

SELECT m.cuentaid,p.fechapoliza as fecha,SUM(m.debe) as debe,SUM(m.haber) as haber
  FROM polizas p, movipolizas m
 WHERE p.fechapoliza BETWEEN pfechai AND pfechaf AND
       m.polizaid = p.polizaid AND
       m.cuentaid>=pcuentai AND m.cuentaid<=pcuentaf
GROUP BY m.cuentaid,p.fechapoliza
ORDER BY m.cuentaid,p.fechapoliza

     loop
       bfound:=true; 
       if scuentaid<>a.cuentaid then
         if scuentaid<>'  ' then
           s.cuentaid := scuentaid;
           s.serie := 'AA';
           s.numero_poliza := -1;

           select sum(m.debe)-sum(m.haber)
             into lsaldoinicial
             from polizas p, movipolizas m
            where p.fechapoliza < pfechai and
                  m.polizaid = p.polizaid and
                  m.cuentaid = scuentaid;

           lsaldoinicial := coalesce(lsaldoinicial,0);
           s.saldoinicial := lsaldoinicial;
           s.debe := ldebe;
           s.haber := lhaber;
           s.saldofinal := lsaldoinicial + ldebe - lhaber;
           s.fecha := '2000-01-01';

           return next s;
         end if;
         scuentaid := a.cuentaid;
         ldebe := 0;
         lhaber := 0;
       end if;

       r.cuentaid := a.cuentaid;
       r.serie := 'ZZ';
       r.fecha := a.fecha;
       r.debe := a.debe;
       r.haber := a.haber;
       ldebe := ldebe + a.debe;
       lhaber := lhaber + a.haber;
       return next r;

     end loop;

     if not bfound then
       s.cuentaid := pcuentai;
       scuentaid := pcuentai;
     else
       s.cuentaid := scuentaid;
     end if;

     s.serie := 'AA';
     s.numero_poliza := -1;
     s.fecha := '2000-01-01';      
     select sum(m.debe)-sum(m.haber)
       into lsaldoinicial
       from polizas p, movipolizas m
      where p.fechapoliza < pfechai and
            m.polizaid = p.polizaid and
            m.cuentaid = scuentaid;

     lsaldoinicial := coalesce(lsaldoinicial,0);
     s.saldoinicial := lsaldoinicial;
     s.debe := ldebe;
     s.haber := lhaber;
     s.saldofinal := lsaldoinicial + ldebe - lhaber;

     return next s;

  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.movimientos(character, character, date, date, character, character) OWNER TO sistema;

--
-- Name: movimientosc(character, character, date, date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION movimientosc(character, character, date, date, character, character) RETURNS SETOF movimientos
    AS $_$
declare
  pcuentai    alias for $1;
  pcuentaf    alias for $2;
  pfechai     alias for $3;
  pfechaf     alias for $4;
  psoloconmov alias for $5;
  pacumulaporfecha alias for $6;

  r movimientos%rowtype;

  f record;
  dblink1 text;
  dblink2 text;

begin

raise notice 'Conectando sucursal';

for f in
 select * from sucursales where vigente='S'
 loop

  raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

  dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
  dblink2:='set search_path to public,'||f.esquema||'; select * from movimientos('||''''||pcuentai||''''||',
                              '||''''||pcuentaf||''''||',
                              '||''''||pfechai||''''||',
                              '||''''||pfechaf||''''||',
                              '||''''||psoloconmov||''''||',
                              '||''''||pacumulaporfecha||''''||');';

  for r in
    select * from
    dblink(dblink1,dblink2) as
    t (cuentaid                char(24),
       serie                   char(7),
       numero_poliza           int4,
       referencia              int4,
       fecha                   date,
       concepto                varchar(255),
       saldoinicial            numeric,
       debe                    numeric,
       haber                   numeric,
       saldofinal              numeric,
       tipo_poliza             char(1))

    loop
      return next r;
    end loop;

 end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.movimientosc(character, character, date, date, character, character) OWNER TO sistema;

--
-- Name: movimientoscaja(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION movimientoscaja(character) RETURNS SETOF rmovimientoscaja
    AS $_$
declare
  r rmovimientoscaja%rowtype;
  pclavesocioint alias for $1;

  l record;

 fcapital numeric;
 fnormal numeric;
 fmoratorio numeric;
 fiva numeric;

begin

    for r in
      select p.fechapoliza,p.seriepoliza,p.numero_poliza,mc.seriecaja,mc.referenciacaja,
             t.desctipomovimiento,refmovimiento(mc.prestamoid,mc.inversionid),m.debe,m.haber,
             t.tipomovimientoid,mc.movicajaid
        from movicaja mc,polizas p, movipolizas m,tipomovimiento t, socio s
       where s.clavesocioint = pclavesocioint and
             mc.socioid = s.socioid and
             p.polizaid = mc.polizaid and
             m.movipolizaid = mc.movipolizaid and
             t.tipomovimientoid = mc.tipomovimientoid
    order by p.fechapoliza

    loop
      if r.tipomovimientoid<>'00' then
        return next r;
      else

        fcapital := 0;
        fnormal := 0;
        fmoratorio := 0;
        fiva := 0;

        for l in
          select m.polizaid,t.cuentaactivo,t.cuentaintnormal,t.cuentaintmora,t.cuentaiva
            from movicaja m, prestamos pr, tipoprestamo t
           where m.movicajaid = r.movicajaid and
                 pr.prestamoid =  m.prestamoid and
                 t.tipoprestamoid = pr.tipoprestamoid
                 
        loop

          select sum(coalesce(haber-debe,0)) into fcapital
            from movipolizas
           where polizaid = l.polizaid and
                 cuentaid = l.cuentaactivo and debe=0;
          select sum(coalesce(haber-debe,0)) into fnormal
            from movipolizas
           where polizaid = l.polizaid and
                 cuentaid = l.cuentaintnormal;
          select sum(coalesce(haber-debe,0)) into fmoratorio
            from movipolizas
           where polizaid = l.polizaid and
                 cuentaid = l.cuentaintmora;
          select sum(coalesce(haber-debe,0)) into fiva
            from movipolizas
           where polizaid = l.polizaid and
                 cuentaid = l.cuentaiva;
           
        end loop;

        if fcapital<>0 then
          r.desctipomovimiento:='Abono Capital';
          r.debe := fcapital;
          r.haber := 0;
          return next r;
        end if;
        if fnormal<>0 then
          r.desctipomovimiento:='Int. Normal';
          r.debe := fnormal;
          r.haber := 0;
          return next r;
        end if;
        if fmoratorio<>0 then
          r.desctipomovimiento:='Int. Morat.';
          r.debe := fmoratorio;
          r.haber := 0;
          return next r;
        end if;
        if fiva<>0 then
          r.desctipomovimiento:='IVA';
          r.debe := fiva;
          r.haber := 0;
          return next r;
        end if;

      end if;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.movimientoscaja(character) OWNER TO sistema;

--
-- Name: movimientoscaja(character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION movimientoscaja(character, character) RETURNS SETOF rmovimientoscaja
    AS $_$
declare
  r rmovimientoscaja%rowtype;
  pclavesocioint alias for $1;
  ptipomovimientoid alias for $2;

  l record;

 fcapital numeric;
 fnormal numeric;
 fmoratorio numeric;
 fiva numeric;

begin

    for r in
      select p.fechapoliza,p.seriepoliza,p.numero_poliza,mc.seriecaja,mc.referenciacaja,
             t.desctipomovimiento,refmovimiento(mc.prestamoid,mc.inversionid),m.debe,m.haber,
             t.tipomovimientoid,mc.movicajaid
        from movicaja mc,polizas p, movipolizas m,tipomovimiento t, socio s
       where s.clavesocioint = pclavesocioint and
             mc.socioid = s.socioid and
             p.polizaid = mc.polizaid and
             m.movipolizaid = mc.movipolizaid and
             (ptipomovimientoid='  ' or mc.tipomovimientoid=ptipomovimientoid) and
             t.tipomovimientoid = mc.tipomovimientoid 
    order by p.fechapoliza

    loop
      if r.tipomovimientoid<>'00' then
        return next r;
      else

        fcapital := 0;
        fnormal := 0;
        fmoratorio := 0;
        fiva := 0;

        for l in
          select m.polizaid,t.cuentaactivo,t.cuentaintnormal,t.cuentaintmora,t.cuentaiva
            from movicaja m, prestamos pr, tipoprestamo t
           where m.movicajaid = r.movicajaid and
                 pr.prestamoid =  m.prestamoid and
                 t.tipoprestamoid = pr.tipoprestamoid
                 
        loop

          select sum(coalesce(haber-debe,0)) into fcapital
            from movipolizas
           where polizaid = l.polizaid and
                 cuentaid = l.cuentaactivo and debe=0;
          select sum(coalesce(haber-debe,0)) into fnormal
            from movipolizas
           where polizaid = l.polizaid and
                 cuentaid = l.cuentaintnormal;
          select sum(coalesce(haber-debe,0)) into fmoratorio
            from movipolizas
           where polizaid = l.polizaid and
                 cuentaid = l.cuentaintmora;
          select sum(coalesce(haber-debe,0)) into fiva
            from movipolizas
           where polizaid = l.polizaid and
                 cuentaid = l.cuentaiva;
           
        end loop;

        if fcapital<>0 then
          r.desctipomovimiento:='Abono Capital';
          r.debe := fcapital;
          r.haber := 0;
          return next r;
        end if;
        if fnormal<>0 then
          r.desctipomovimiento:='Int. Normal';
          r.debe := fnormal;
          r.haber := 0;
          return next r;
        end if;
        if fmoratorio<>0 then
          r.desctipomovimiento:='Int. Morat.';
          r.debe := fmoratorio;
          r.haber := 0;
          return next r;
        end if;
        if fiva<>0 then
          r.desctipomovimiento:='IVA';
          r.debe := fiva;
          r.haber := 0;
          return next r;
        end if;

      end if;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.movimientoscaja(character, character) OWNER TO sistema;

--
-- Name: movinicial(character, date, numeric, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION movinicial(character, date, numeric, character) RETURNS integer
    AS $_$
declare
--
-- Parametros
--
  pclavesocioint alias for $1;
  pfecha alias for $2;
  psaldo alias for $3;
  ptipomovimientoid alias for $4;


  sserie_user char(2);
  scuentacaja char(24);
  scuentadeposito char(24);

  lsocioid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;
begin

--
-- **** OJO poner la serie y cuenta de caja correspondiente ****
--
  sserie_user := 'Z';
  scuentacaja := '800101       ';

--
-- Tomaremos el saldo inicial como un deposito
--

-- Buscamos la cuenta de deposito y el socio

  select cuentadeposito into scuentadeposito
   from tipomovimiento where tipomovimientoid=ptipomovimientoid;

  select socioid into lsocioid
   from socio
  where clavesocioint = pclavesocioint;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',sserie_user,'A');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','Saldo Inicial',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','C',psaldo,0,' ',' ','Caja Saldo Inicial');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentadeposito,' ','A',0,psaldo,' ',' ','Caja Saldo Inicial');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

  select *
    into pmovicajaid
   from spimovicaja(lsocioid,ptipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL);

return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.movinicial(character, date, numeric, character) OWNER TO sistema;

--
-- Name: nextprestamo(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nextprestamo() RETURNS character
    AS $$
declare
  snextprestamo char(7);
  lconsecutivo int4;
begin

  select cast(max(substr(referenciaprestamo,1,6)) as int4)
    into lconsecutivo
    from prestamos
   where substr(referenciaprestamo,7,1)='-';

  lconsecutivo := coalesce(lconsecutivo+1,1);


  snextprestamo:=trim(to_char(lconsecutivo,'000000-'));

return snextprestamo;
end;
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nextprestamo() OWNER TO sistema;

--
-- Name: nextprocampo(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nextprocampo() RETURNS character
    AS $$
declare
  snextprestamo char(7);
  lconsecutivo int4;
begin

  select cast(max(substr(referenciaprestamo,1,6)) as int4)
    into lconsecutivo
    from procampo;

  lconsecutivo := coalesce(lconsecutivo+1,1);


  snextprestamo:=trim(to_char(lconsecutivo,'000000-'));

return snextprestamo;
end;
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nextprocampo() OWNER TO sistema;

--
-- Name: nextreferencia(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nextreferencia(character) RETURNS integer
    AS $_$
declare
  pseriecaja alias for $1;
  lfolio int4;
begin

   select max(referenciacaja) into lfolio
    from movicaja where seriecaja=pseriecaja;

   lfolio := coalesce(lfolio,0)+1;

return lfolio;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nextreferencia(character) OWNER TO sistema;

--
-- Name: nextsocio(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nextsocio() RETURNS character
    AS $$
declare
  lsocioid int4;
  lsocio int4;
  snextsocio char(15);
  smaxsocio char(15);
  ssucid char(4);
begin

  select sucid into ssucid from empresa where empresaid=1;
  
  select MAX(cast(substr(trim(both '-' from clavesocioint),5,5) as int4))+1
    into lsocioid
    from socio
   where tiposocioid='02' and
         substr(clavesocioint,1,4)=ssucid;

  lsocioid = coalesce(lsocioid,1);

  snextsocio:=trim(ssucid)||trim(to_char(lsocioid,'00000')||'-02');

return snextsocio;
end;
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nextsocio() OWNER TO sistema;

--
-- Name: nextsociocp(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nextsociocp() RETURNS character
    AS $$
declare
  lsocioid int4;
  snextsocio char(15);
begin

  select cast(max(substr(clavesocioint,5,5)) as int4)+1
   into lsocioid
   from socio
  where substr(clavesocioint,11,2)='CP';

  lsocioid = coalesce(lsocioid,1);

  select sucid into snextsocio from empresa;

  snextsocio:=trim(snextsocio)||trim(to_char(lsocioid,'00000'))||'-CP';

return snextsocio;
end;
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nextsociocp() OWNER TO sistema;

--
-- Name: nextsociom(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nextsociom() RETURNS character
    AS $$
declare
  lsocioid int4;
  snextsocio char(15);
  lsocio int4;
  ssucid char(4);
begin

  select sucid into ssucid from empresa where empresaid=1;
  
  select MAX(cast(substr(trim(both '-' from clavesocioint),5,5) as int4))+1
    into lsocioid
    from socio
   where tiposocioid='01' and
         substr(clavesocioint,1,4)=ssucid;

  lsocioid = coalesce(lsocioid,1);

  snextsocio:=trim(ssucid)||trim(to_char(lsocioid,'00000')||'-01');

return snextsocio;
end;
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nextsociom() OWNER TO sistema;

--
-- Name: nextsolicitudingreso(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nextsolicitudingreso() RETURNS integer
    AS $$
declare 
  lnosolicitud int4;
begin

  select max(coalesce(nosolicitud,0)+1)
    into lnosolicitud
    from solicitudingreso;

  lnosolicitud:=coalesce(lnosolicitud,1);

return lnosolicitud;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nextsolicitudingreso() OWNER TO sistema;

--
-- Name: nextsolicitudprestamo(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nextsolicitudprestamo() RETURNS integer
    AS $$
declare 
  lnosolicitud int4;
begin

  select max(coalesce(nosolicitud,0)+1)
    into lnosolicitud
    from solicitudprestamo;

  lnosolicitud:=coalesce(lnosolicitud,1);

return lnosolicitud;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nextsolicitudprestamo() OWNER TO sistema;

--
-- Name: nivelestudios(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nivelestudios(integer) RETURNS text
    AS $_$
declare
pnivelestudios alias for $1;

ptexto text;

begin
  
  if pnivelestudios=0 then
    ptexto := 'NINGUNO';
  end if;
  if pnivelestudios=1 then
    ptexto := 'PRIMARIA';
  end if;
    if pnivelestudios=2 then
    ptexto := 'SECUNDARIA';
  end if;
  if pnivelestudios=3 then
    ptexto := 'PREPARATORIA';
  end if;
  if pnivelestudios=4 then
    ptexto := 'LICENCIATURA';
  end if;
  if pnivelestudios=5 then
    ptexto := 'DOCTORADO';
  end if;
  if pnivelestudios=6 then
    ptexto := 'MAESTRIA';
  end if;


  return ptexto;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nivelestudios(integer) OWNER TO sistema;

--
-- Name: nombreusuario(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nombreusuario(character) RETURNS character varying
    AS $_$
declare
  pserie alias for $1;
  pnombre varchar;
begin

  select su.nombre||' '||su.paterno||' '||su.materno
    into pnombre
    from parametros p, usuarios u, sujeto su
   where p.serie_user=pserie and
         u.usuarioid=p.usuarioid and
         su.sujetoid=u.sujetoid;

  pnombre:=coalesce(pnombre,' ');

return pnombre;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nombreusuario(character) OWNER TO sistema;

--
-- Name: nopagareinversion(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nopagareinversion() RETURNS integer
    AS $$
declare

  lnopagare int4;

  linversionid int4;

begin

  select max(inversionid)
    into linversionid
    from inversion;

  select max(referenciainversion)+1
    into lnopagare
    from inversion
   where inversionid=linversionid;

  lnopagare:=coalesce(lnopagare,1);

return lnopagare;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nopagareinversion() OWNER TO sistema;

--
-- Name: nosolicitudi(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nosolicitudi(integer) RETURNS integer
    AS $_$
declare

  psolicitudingresoid alias for $1;
  lnosolicitud int4;

begin

  select nosolicitud
    into lnosolicitud
    from solicitudingreso
   where solicitudingresoid=psolicitudingresoid;

return lnosolicitud;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nosolicitudi(integer) OWNER TO sistema;

--
-- Name: nosolicitudp(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION nosolicitudp(integer) RETURNS integer
    AS $_$
declare

  psolicitudprestamoid alias for $1;
  lnosolicitud int4;

begin

  select nosolicitud
    into lnosolicitud
    from solicitudprestamo
   where solicitudprestamoid=psolicitudprestamoid;

return lnosolicitud;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.nosolicitudp(integer) OWNER TO sistema;

--
-- Name: numerausuarios(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION numerausuarios() RETURNS character
    AS $$
declare
  lsujetoid int4;

begin

  update sujeto set sujetoid=sujetoid-2057 where sujetoid > 2057;
  update domicilio set sujetoid=sujetoid-2057 where sujetoid > 2057;
  update domicilio set domicilioid=domicilioid-2057 where domicilioid > 2057;
  update usuarios set sujetoid=sujetoid-2057 where sujetoid > 2057;

return 1;
end;
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.numerausuarios() OWNER TO sistema;

--
-- Name: ordenavales(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION ordenavales() RETURNS integer
    AS $$
declare

  r record;
  l record;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;
  sserie_user char(2);

  scuentadeudor char(24);
  scuentaacredor char(24);
  pfecha date;

  lsujetoid int4;

  fcantidad1 numeric;
  fcantidad2 numeric;
  fcantidad3 numeric;

  i int4;
  noavales int4;
begin

  sserie_user := 'ZA';
  pfecha:='2006-05-31';

  for r in
select p.prestamoid, p.tipoprestamoid, p.saldoprestamo, pr.referenciaprestamo
  from precorte p, prestamos pr
 where p.saldoprestamo>0 and
--       a.prestamoid=p.prestamoid and
       p.fechacierre=pfecha and
       pr.prestamoid=p.prestamoid
group by p.prestamoid, p.tipoprestamoid, p.saldoprestamo, pr.referenciaprestamo
order by p.prestamoid
  loop


  select count(*) into noavales from avales where prestamoid=r.prestamoid;

  noavales:=coalesce(noavales,0);

if noavales>0 then

raise notice 'Procesando %',r.referenciaprestamo;

  select cuentaordenaval,cuentaordenavalacredor
    into scuentadeudor,scuentaacredor
    from tipoprestamo
   where tipoprestamoid=r.tipoprestamoid;

    if noavales=1 then

  select sujetoid
    into lsujetoid
    from avales where prestamoid=r.prestamoid;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'M',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'M',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentadeudor,' ','C',r.saldoprestamo,0,' ',' ', to_char(lsujetoid,'999999')||r.referenciaprestamo);

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentaacredor,' ','A',0,r.saldoprestamo,' ',' ', to_char(lsujetoid,'999999')||r.referenciaprestamo);


    end if;


      if noavales=2 then

       
        fcantidad2:=trunc(r.saldoprestamo/2);
        fcantidad1:=r.saldoprestamo-fcantidad2;

        i:=1;
        for l in
          select sujetoid from avales where prestamoid=r.prestamoid
        loop
          if i=1 then

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'M',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'M',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentadeudor,' ','C',fcantidad1,0,' ',' ', to_char(l.sujetoid,'999999')||r.referenciaprestamo);

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentaacredor,' ','A',0,fcantidad1,' ',' ', to_char(l.sujetoid,'999999')||r.referenciaprestamo);

          else

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'M',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'M',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentadeudor,' ','C',fcantidad2,0,' ',' ', to_char(l.sujetoid,'999999')||r.referenciaprestamo);

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentaacredor,' ','A',0,fcantidad2,' ',' ', to_char(l.sujetoid,'999999')||r.referenciaprestamo);

          end if;
        end loop;

   end if;


   if noavales=3 then

        fcantidad3:=trunc(r.saldoprestamo/3);
        fcantidad2:=trunc(r.saldoprestamo/3);
        fcantidad1:=r.saldoprestamo-fcantidad2-fcantidad3;

        i:=1;
        for l in
          select sujetoid from avales where prestamoid=r.prestamoid
        loop
          if i=1 then

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'M',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'M',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentadeudor,' ','C',fcantidad1,0,' ',' ', to_char(l.sujetoid,'999999')||r.referenciaprestamo);

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentaacredor,' ','A',0,fcantidad1,' ',' ', to_char(l.sujetoid,'999999')||r.referenciaprestamo);

          else

if i=2 then
--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'M',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'M',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentadeudor,' ','C',fcantidad2,0,' ',' ', to_char(l.sujetoid,'999999')||r.referenciaprestamo);

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentaacredor,' ','A',0,fcantidad2,' ',' ', to_char(l.sujetoid,'999999')||r.referenciaprestamo);

else

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'M',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'M',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','',pfecha);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentadeudor,' ','C',fcantidad3,0,' ',' ', to_char(l.sujetoid,'999999')||r.referenciaprestamo);

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentaacredor,' ','A',0,fcantidad3,' ',' ', to_char(l.sujetoid,'999999')||r.referenciaprestamo);


   end if;


          end if;
        end loop;
    end if;

else
  raise notice '% no tiene avales',r.referenciaprestamo;

end if;



  end loop;




return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.ordenavales() OWNER TO sistema;

--
-- Name: pagoprocampo(integer, date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION pagoprocampo(integer, date, character, character) RETURNS integer
    AS $_$
declare
  pprocampoid  alias for $1;
  pfecha       alias for $2;
  pcuentacaja  alias for $3;
  pserie       alias for $4;

  scuentaactivo char(24);
  ftotal  numeric;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  pejercicio int4;
  pperiodo int4;

  sreferenciaprestamo char(18);

  fsaldoprestamo numeric;
begin

  select p.montoprestamo,t.cuentaactivo,p.referenciaprestamo,p.saldoprestamo
    into ftotal,scuentaactivo,sreferenciaprestamo,fsaldoprestamo
    from procampo p, tipoprestamo t
   where p.procampoid=pprocampoid and
         t.tipoprestamoid=p.tipoprestamoid;

  if fsaldoprestamo=0 then
    raise exception 'El prestamo ya se encuentra PAGADO.';
  end if;


  update procampo
     set saldoprestamo=0,
         fechaultimopago=pfecha
   where procampoid=pprocampoid;
    

  pejercicio := cast(date_part('year',pfecha) as int);
  pperiodo := cast(date_part('month',pfecha) as int);

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(pejercicio,pperiodo,'Q',pserie,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,pserie,'Q',pnumero_poliza,pejercicio,pperiodo,' ',pfecha,'D',' ',' ','Pago '||sreferenciaprestamo,pfecha);

  select *
    into pmovipolizaid
    from spimovipoliza(ppolizaid,pcuentacaja,' ','C',ftotal,0,' ',' ','Pago '||sreferenciaprestamo);

  select *
    into pmovipolizaid
    from spimovipoliza(ppolizaid,scuentaactivo,' ','A',0,ftotal,' ',' ','Pago '||sreferenciaprestamo);



return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.pagoprocampo(integer, date, character, character) OWNER TO sistema;

--
-- Name: pagpromedio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION pagpromedio(integer) RETURNS numeric
    AS $_$ 
DECLARE

  lsocioid alias for $1;
  fpromedio numeric;
  dfechai date;
  dfechaf date;
  dias int4;

BEGIN

  fpromedio:=0;

  select min(p.fechapoliza) into dfechai from movicaja mc, polizas p where mc.socioid=lsocioid and mc.tipomovimientoid='00' and mc.polizaid=p.polizaid and p.tipo <> 'W' and p.fechapoliza < current_date ;
  
  select max(p.fechapoliza) into dfechaf from movicaja mc, polizas p where mc.socioid=lsocioid and mc.tipomovimientoid='00' and mc.polizaid=p.polizaid and p.tipo <> 'W' and p.fechapoliza < current_date ;

SELECT SUM(round((case when p.fechapoliza<dfechai then
             (mp.debe)*(dfechaf-dfechai) else 0 end),2)) +
       SUM(round(case when p.fechapoliza>dfechai-1 then
             (mp.debe)*(dfechaf-p.fechapoliza) else 0 end,2))
  INTO fpromedio
  FROM ( select ml.socioid, ml.tipomovimientoid, ml.polizaid,
                ml.referenciacaja, ml.seriecaja, ml.movipolizaid
           from movicaja ml
          where ml.socioid=lsocioid and
                ml.tipomovimientoid = '00'
       GROUP BY ml.socioid, ml.tipomovimientoid, ml.polizaid,
                ml.referenciacaja, ml.seriecaja, ml.movipolizaid ) as m,
       polizas p, movipolizas mp, tipomovimiento t, socio s
 WHERE m.socioid=lsocioid and
       m.tipomovimientoid = '00' and
       p.polizaid = m.polizaid and
       p.fechapoliza between '01-01-1900' and dfechaf and
       mp.polizaid = p.polizaid and
       mp.movipolizaid = m.movipolizaid and
       t.tipomovimientoid = m.tipomovimientoid and
       s.socioid = m.socioid and 
       (s.estatussocio=1 or s.estatussocio=3 or fechabaja > dfechaf);  

  fpromedio:=coalesce(fpromedio,0);
  dias :=(dfechaf-dfechai);

  raise notice ' % % ',fpromedio,dias;

  if dias <> 0 then 
      RETURN round(fpromedio/(dfechaf-dfechai),2);
  else
      RETURN 0;
  end if;

END; 
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.pagpromedio(integer) OWNER TO sistema;

--
-- Name: periodovalido(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION periodovalido(integer, integer) RETURNS integer
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo   alias for $2;
  pok int4;
  sestatus char(1);
begin

  select estatus
    into sestatus
    from periodo
   where ejercicio=pejercicio and
         periodo=pperiodo;

  -- estatus A Abierto C Cerrado
  if sestatus='A' then
    pok := 1;
  else
    pok := 0;
  end if;

return pok;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.periodovalido(integer, integer) OWNER TO sistema;

--
-- Name: plpgsql_call_handler(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION plpgsql_call_handler() RETURNS language_handler
    AS '$libdir/plpgsql', 'plpgsql_call_handler'
    LANGUAGE c;


ALTER FUNCTION public.plpgsql_call_handler() OWNER TO sistema;

--
-- Name: polizacierre(integer, integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION polizacierre(integer, integer, date) RETURNS integer
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo   alias for $2;
  pfecha     alias for $3;

  c saldos%rowtype;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  fsaldo numeric;
  scuentaid2 char(24);
begin

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(pejercicio,pperiodo,'A','Z','D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipoliza(preferencia,'Z','A',pnumero_poliza,pejercicio,pperiodo,' ',pfecha,'D',' ',' ','Poliza de Cierre',pfecha);

  for c in
    select max(saldoid),cuentaid,ejercicio,periodo,sum(saldoinicialperiodo),sum(cargosdelperiodo),sum(abonosdelperiodo)
      from cbalanza(pejercicio,pperiodo)
     where cuentaid in (select cuentaid1 from ctasconsolida)
  group by cuentaid,ejercicio,periodo
  loop
    select cuentaid2 into scuentaid2
      from ctasconsolida
     where cuentaid1=c.cuentaid;

    fsaldo := c.saldoinicialperiodo+c.cargosdelperiodo-c.abonosdelperiodo;
    if fsaldo<>0 then
      select *
       into pmovipolizaid
       from spimovipoliza(ppolizaid,c.cuentaid,' ','A',0,fsaldo,' ',' ','Poliza Cierre');

      select *
       into pmovipolizaid
       from spimovipoliza(ppolizaid,scuentaid2,' ','C',fsaldo,0,' ',' ','Poliza Cierre');
    end if;

  end loop;

return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.polizacierre(integer, integer, date) OWNER TO sistema;

--
-- Name: polizacierre(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION polizacierre(date) RETURNS integer
    AS $_$
declare
--  pejercicio alias for $1;
--  pperiodo   alias for $2;
  pfecha     alias for $1;

  c saldos%rowtype;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  pejercicio int4;
  pperiodo int4;

  fsaldo numeric;
  scuentaid2 char(24);
begin


  pejercicio := cast(date_part('year',pfecha) as int);
  pperiodo := cast(date_part('month',pfecha) as int);

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(pejercicio,pperiodo,'A','Z','D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,'Z','A',pnumero_poliza,pejercicio,pperiodo,' ',pfecha,'D',' ',' ','Poliza de Cierre',pfecha);

  for c in
    select max(saldoid),cuentaid,ejercicio,periodo,sum(saldoinicialperiodo),sum(cargosdelperiodo),sum(abonosdelperiodo)
      from cbalanza(pejercicio,pperiodo)
     where cuentaid in (select cuentaid1 from ctasconsolida)
  group by cuentaid,ejercicio,periodo
  loop
    select cuentaid2 into scuentaid2
      from ctasconsolida
     where cuentaid1=c.cuentaid;

    fsaldo := c.saldoinicialperiodo+c.cargosdelperiodo-c.abonosdelperiodo;
    if fsaldo<>0 then
      select *
       into pmovipolizaid
       from spimovipoliza(ppolizaid,c.cuentaid,' ','A',0,fsaldo,' ',' ','Poliza Cierre');

      select *
       into pmovipolizaid
       from spimovipoliza(ppolizaid,scuentaid2,' ','C',fsaldo,0,' ',' ','Poliza Cierre');
    end if;

  end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.polizacierre(date) OWNER TO sistema;

--
-- Name: precierre(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION precierre(date) RETURNS integer
    AS $_$
declare
  pfechacorte alias for $1;

  iejercicio int4;
  iperiodo   int4;

  iprocesado int4;

  r record;
  i record;
  dcorte date;

  finteresdevengado numeric;
  finteresdevengadomenor numeric;
  fdevengadomayor numeric;
  fsaldovencidomen numeric;
  fsaldovencidomay numeric;
  idias int4;

  finteresdevmormenor numeric;
  finteresdevmormayor numeric;

  inoamorvencidas int4;

  scuentar char(24);

  stomaintervalo char(1);
  igeneracaptaciontotal integer;

  periododemenos integer;
  ifrecuencia integer;

begin

  select tomaintervalo
    into stomaintervalo
    from empresa
   where empresaid=1;

  select cuentadeposito
    into scuentar
    from tipomovimiento
   where tipomovimientoid='RG';

  dcorte := pfechacorte + 1;
  iejercicio := cast(date_part('year',pfechacorte) as int);
  iperiodo := cast(date_part('month',pfechacorte) as int);

  delete from precorte where ejercicio=iejercicio and periodo=iperiodo;   

  -- Validar que no se corra mas de una vez
  select count(*)
    into iprocesado
    from precorte
   where ejercicio = iejercicio and
         periodo = iperiodo;

  iprocesado := coalesce(iprocesado,0);
  if iprocesado>0 then
    raise exception 'La informacion para el ejercicio % y periodo % ya fue procesada anteriormente.',iejercicio,iperiodo;
  end if;

  insert into
  precorte (prestamoid,ejercicio,periodo,fechacierre,saldoprestamo,
            diasvencidos,
            interesdevengadomenoravencido,interesdevengadomayoravencido,
            pagocapitalenperiodo,pagointeresenperiodo,pagomoratorioenperiodo,
            bonificacionintenperiodo,bonificacionmorenperiodo,noamorvencidas,
            saldovencidomenoravencido,saldovencidomayoravencido,
            fechaultamorpagada,tipoprestamoid,montoprestamo,clavefinalidad,tasanormal,
            tasa_moratoria,ultimoabono,diastraspasoavencida,fecha_vencimiento,
            ultimoabonointeres,interesdevmormenor,interesdevmormayor,dias_de_cobro,meses_de_cobro,frecuencia,finalidaddefault,fecha_otorga,estatusvive,depositogarantia)

select p.prestamoid,
       iejercicio as ejercicio,
       iperiodo as periodo,
       pfechacorte as fechacierre,
       p.montoprestamo-SUM(case when m.cuentaid=tp.cuentaactivo and
                                     po.fechapoliza<dcorte
                                then m.haber else 0 end) as saldoprestamo,
       0 as diasvencidos,
       0 as interesdevengadomenoravencido,
       0 as interesdevengadomayoravencido,

       SUM(case when m.cuentaid=tp.cuentaactivo and
                     po.periodo=iperiodo and po.ejercicio=iejercicio 
                then m.haber else 0 end) as pagocapitalenperiodo,
       SUM(case when m.cuentaid=tp.cuentaintnormal and
                     po.ejercicio=iejercicio and po.periodo=iperiodo 
                then m.haber else 0 end) as pagointeresenperiodo,
       SUM(case when m.cuentaid=tp.cuentaintmora and
                     po.ejercicio=iejercicio and po.periodo=iperiodo 
                then m.haber else 0 end) as pagomoratorioenperiodo,       
       SUM(case when m.cuentaid=tp.ordendeudornormalbonificado and
                     po.ejercicio=iejercicio and po.periodo=iperiodo 
                then m.haber else 0 end) as bonificacionintenperiodo, 
       SUM(case when m.cuentaid=tp.ordenacredornormalbonificado and
                     po.ejercicio=iejercicio and po.periodo=iperiodo 
                then m.haber else 0 end) as bonificacionmorenperiodo,                
                
       0 as noamorvencidas,
       0 as saldovencidomayoravencido,
       0 as saldovencidomenoravencido,
       
       fechaultimapagada(p.prestamoid,pfechacorte)as fechaultamorpagada,
       
       p.tipoprestamoid,p.montoprestamo,p.clavefinalidad,p.tasanormal,p.tasa_moratoria,
       MAX(case when m.cuentaid=tp.cuentaactivo and po.fechapoliza<dcorte
                then po.fechapoliza else p.fecha_otorga end),
       tp.diastraspasoavencida,
       p.fecha_vencimiento,
       MAX(case when m.cuentaid=tp.cuentaintnormal and po.fechapoliza<dcorte
                then po.fechapoliza else (case when m.cuentaid=tp.cuentaactivo and
                                                       po.fechapoliza<dcorte
                then po.fechapoliza else p.fecha_otorga end) end),
       0 as interesdevmormenor,
       0 as interesdevmormayor,p.dias_de_cobro,p.meses_de_cobro,(case when p.fecha_1er_pago > fechaultimapagada(p.prestamoid,pfechacorte) then p.fecha_1er_pago-p.fecha_otorga else (case when p.dias_de_cobro > 0 then p.dias_de_cobro else p.meses_de_cobro*30 end) end),tp.clavefinalidad,p.fecha_otorga,0 as estatusvive,p.monto_garantia

    from prestamos p left join movicaja mc on p.prestamoid=mc.prestamoid 
                     left join polizas po on mc.polizaid = po.polizaid
                     left join movipolizas m on po.polizaid=m.polizaid, 
         tipoprestamo tp
   where p.fecha_otorga <= pfechacorte and
         p.claveestadocredito<>'008' and 
         tp.tipoprestamoid = p.tipoprestamoid
group by p.prestamoid, p.tipoprestamoid,p.montoprestamo,
         p.clavefinalidad,p.tasanormal,p.tasa_moratoria,
         p.fecha_1er_pago,tp.diastraspasoavencida,p.fecha_vencimiento,p.dias_de_cobro,p.meses_de_cobro,tp.clavefinalidad,p.fecha_otorga,p.monto_garantia                
   order by prestamoid;

   for r in
     select p.precorteid,p.saldoprestamo,p.fechaultamorpagada,p.prestamoid,
            p.ultimoabono,p.diastraspasoavencida,p.ultimoabonointeres
       from precorte p
      where p.fechacierre=pfechacorte

   loop

     -- Clasificacion de interes devengado

     finteresdevengadomenor := 0;
     fdevengadomayor := 0;

     --raise notice 'ultima amortizacion  %  %  %',r.prestamoid,r.fechaultamorpagada,periododemenos;

     if r.saldoprestamo>0 then

       if pfechacorte-r.ultimoabonointeres>0 then

         --
         -- Interes Normal y Moratorio
         --

         finteresdevengadomenor := interesdevengado(r.prestamoid,pfechacorte,r.ultimoabonointeres,r.saldoprestamo,'S');

         if pfechacorte-r.fechaultamorpagada-periododemenos>0 and r.saldoprestamo>0 then

           
             finteresdevmormenor := interesdevmoratorio(r.prestamoid,pfechacorte,r.ultimoabonointeres,r.saldoprestamo,'S');
             finteresdevmormenor := 0;

         else
           finteresdevmormenor:=0;
         end if;

         if pfechacorte-r.ultimoabonointeres>r.diastraspasoavencida then
 
           fdevengadomayor := interesdevengado(r.prestamoid,pfechacorte,r.ultimoabonointeres,r.saldoprestamo,'N');

           if pfechacorte-r.fechaultamorpagada-periododemenos>0 and r.saldoprestamo>0 then

             finteresdevmormayor := interesdevmoratorio(r.prestamoid,pfechacorte,r.ultimoabonointeres,r.saldoprestamo,'N');
             finteresdevmormayor := 0;
           else
             finteresdevmormayor := 0;
           end if;
         end if;

       end if;

     end if;

     update precorte
        set interesdevengadomenoravencido=finteresdevengadomenor,
            interesdevengadomayoravencido=fdevengadomayor,           
            interesdevmormenor = finteresdevmormenor,
            interesdevmormayor = finteresdevmormayor
      where precorteid=r.precorteid;

      finteresdevmormenor:=0;
      finteresdevmormayor:=0;

        
   end loop;
   
   delete from precorte  where fechacierre=pfechacorte and saldoprestamo=0 and interesdevengadomenoravencido=0 and interesdevengadomayoravencido=0 and pagocapitalenperiodo=0 and pagointeresenperiodo=0 and pagomoratorioenperiodo=0 and saldovencidomenoravencido=0 and saldovencidomayoravencido=0;
   
   update precorte set saldopromediodelmes=saldopromedioprecorte(precorte.prestamoid,precorte.ejercicio,precorte.periodo);

   update precorte set interesdevengadomes=interesdevengadoprecorte(precorte.prestamoid,precorte.ejercicio,precorte.periodo); 

   update precorte set primerincumplimiento=fechaultamorpagada+frecuencia where fechacierre=pfechacorte;

   -- Dias vencidos capital

   update precorte set diascapital = (case when (fechacierre-fechaultamorpagada)-frecuencia > 0 then (fechacierre-fechaultamorpagada)-frecuencia else 0 end), diasinteres=0  where fechacierre=pfechacorte;

   --and primerincumplimiento > (fecha_otorga+frecuencia);

   -- Los que no han pagado nada dias capital

   --update precorte set diascapital = (case when (fechacierre-fechaultamorpagada) > 0 then (fechacierre-fechaultamorpagada) else 0 end) where fechacierre=pfechacorte and primerincumplimiento <= (fecha_otorga+frecuencia);

   -- Dias de interes vencido

   -- Los dias de interes interes vencidos

   update precorte set diasinteres = (case when (fechaultamorpagada-ultimoabonointeres)-frecuencia > 0 then (fechaultamorpagada-ultimoabonointeres)-frecuencia else 0 end), estatusvive=3 where fechacierre=pfechacorte ;

   -- Asignar a los dias vencido lo que se mayor interes o capital para los que no van adelantados.

   update precorte set diasvencidos = (case when diasinteres > diascapital and (fechaultamorpagada-ultimoabonointeres)>frecuencia and diascapital > 0  then diasinteres else diascapital end) where fechacierre=pfechacorte;

   -- Los etiquetados como renovados y reestructurados

   update precorte set diasvencidos=diasvencidos+diastraspasoavencida
     where fechacierre=pfechacorte and  tipoprestamoid
     in ('I1','T1','T2','T3','R1','R2','R3');

   -- Borrar el moratorio devengado de los que no tienen atraso

   update precorte
     set interesdevmormenor=0,interesdevmormayor=0
     where fechacierre=pfechacorte and diasvencidos=0;
   
   update precorte set saldovencidomenoravencido=saldoprestamo, saldovencidomayoravencido=0 where fechacierre=pfechacorte and diasvencidos<=diastraspasoavencida;

   update precorte set saldovencidomenoravencido=0,saldovencidomayoravencido=saldoprestamo where fechacierre=pfechacorte and diasvencidos>diastraspasoavencida ;

   update precorte set pagosvencidos = (select (case when diasvencidos=0 then 0 else (case when diasvencidos>0 and diasvencidos<=diastraspasoavencida then 1 else 2 end) end)) where fechacierre=pfechacorte;

   -- Asignar porcentaje de reserva

   for r in
     select p.precorteid,t.porcentajereserva,
            p.saldoprestamo*t.porcentajereserva as reservacalculada,
            (p.interesdevengadomenoravencido+p.interesdevmormenor)*t.porcentajereserva as reservaidnc,
            t.factordisminucion,t.tablareservaid,p.prestamoid,
            p.diasvencidos,p.finalidaddefault
       from precorte p, tablareserva t
      where p.fechacierre=pfechacorte and p.finalidaddefault=t.finalidaddefault and
            p.diasvencidos>=t.diainicial and
            p.diasvencidos<=t.diafinal

   loop

        update precorte set tablareservaid = r.tablareservaid,
            porcentajeaplicado=r.porcentajereserva,
            reservacalculada=r.reservacalculada,
            reservaidnc=r.reservaidnc,
            factoraplicado=r.factordisminucion
        where precorteid=r.precorteid;

   end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.precierre(date) OWNER TO sistema;

--
-- Name: precorteconsolidado(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION precorteconsolidado(integer, integer) RETURNS SETOF tprecierre
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo   alias for $2;

  r tprecierre%rowtype;
  f record;
  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||';
            select s.clavesocioint,pr.referenciaprestamo,p.ejercicio,p.periodo,p.fechacierre,
            p.diasvencidos,p.porcentajeaplicado,p.factoraplicado,p.saldoprestamo,
            p.reservacalculada,p.interesdevengadomenoravencido,
            p.interesdevengadomayoravencido,p.pagocapitalenperiodo,
            p.pagointeresenperiodo,p.pagomoratorioenperiodo,
            p.bonificacionintenperiodo,p.bonificacionmorenperiodo,
            p.noamorvencidas,p.saldovencidomenoravencido,p.saldovencidomayoravencido,
            p.fechaultamorpagada,p.tipoprestamoid,p.montoprestamo,pr.fecha_vencimiento,
            t.tantos,
            (case when t.tantos>0 then p.montoprestamo/t.tantos else 0 end)
            as depositogarantia,
            pr.tasanormal,pr.tasa_moratoria,
            fnombresocio(su.nombre,su.paterno,su.materno) AS nombresocio,
            d.calle,d.numero_ext,d.colonia,d.comunidad,d.codpostal,c.nombreciudadmex,
            p.ultimoabono,p.diastraspasoavencida,p.ultimoabonointeres,
            pr.numero_de_amor, pr.fecha_otorga, finalidaddefault(pr.tipoprestamoid),
            (case when p.fecha_vencimiento>p.fechacierre and
                       p.saldoprestamo>0
                  then p.fecha_vencimiento-p.fechacierre
                  else 0 end) as diasrestantes,
            round((pr.fecha_vencimiento-pr.fecha_otorga)/(pr.numero_de_amor*0.1/0.1)),
            interesdevmormenor,interesdevmormayor,
                        (case when pr.numero_de_amor > 1 then '||''''||'Pago periodico de principal e intereses '||''''||' else '||''''||'Pago Unico de principal e intereses '||''''||' end) as condicionpago,
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid not in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||','||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Normal vigente'||''''||' else
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid not in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||','||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Normal Vencido'||''''||' else
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||') then '||''''||'Reestructurado Vigente'||''''||' else
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'T1'||''''||','||''''||'T2'||''''||','||''''||'T3'||''''||') then '||''''||'Reestructurado Vencido'||''''||' else
                        (case when p.diasvencidos <= p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Renovado Vigente'||''''||' else
                        (case when p.diasvencidos > p.diastraspasoavencida and p.tipoprestamoid in ('||''''||'R1'||''''||','||''''||'R2'||''''||','||''''||'R3'||''''||') then '||''''||'Renovado Vencido'||''''||' end) end) end) end) end) end) as estacion,pr.dias_de_cobro,p. pagosvencidos,p.finalidaddefault,p.saldopromediodelmes,p.interesdevengadomes,p.dias_de_cobro,p.meses_de_cobro,p.primerincumplimiento,p.reservaidnc,p.tablareservaid 
      from precorte p,prestamos pr,socio s,tipoprestamo t, sujeto su,domicilio d,
           ciudadesmex c, finalidades f
     where p.ejercicio='||to_char(pejercicio,'9999')||' and p.periodo='||to_char(pperiodo,'99')||' and pr.prestamoid=p.prestamoid and
           s.socioid=pr.socioid and t.tipoprestamoid = pr.tipoprestamoid and
           su.sujetoid=s.sujetoid and d.sujetoid=s.sujetoid and
           c.ciudadmexid = d.ciudadmexid and f.clavefinalidad=p.clavefinalidad
  order by p.diasvencidos,s.clavesocioint;';

  --raise notice 'dblink % %',dblink1,dblink2;


  for r in
   select * from
    dblink(dblink1,dblink2) as 
t (
 clavesocioint      char(15),
 referenciaprestamo char(18),
 ejercicio          int4,
 periodo            int4,
 fechacierre        date,
 diasvencidos       int4,
 porcentajeaplicado numeric,
 factoraplicado     numeric,
 saldoprestamo      numeric,
 reservacalculada   numeric,
 interesdevengadomenoravencido numeric,
 interesdevengadomayoravencido numeric,
 pagocapitalenperiodo numeric,
 pagointeresenperiodo numeric,
 pagomoratorioenperiodo numeric,
 bonificacionenperiodo numeric,
 bonificacionmorenperiodo numeric,
 noamorvencidas     int4,
 saldovencidomernoavencido numeric,
 saldovencidomayoravencido numeric,
 fechaultamorpagada date,
 tipoprestamoid     char(3),
 montoprestamo      numeric,
 fecha_vencimiento  date,
 tantos             int4,
 depositogarantia   numeric,
 tasanormal         numeric,
 tasa_moratoria     numeric,
 nombresocio        char(82),
 calle              varchar(30),
 numero_ext         varchar(15),
 colonia            varchar(50),
 comunidad          varchar(50),
 codpostal          int4,
 nombreciudadmex    varchar(50),
 ultimoabono        date,
 diastraspasoavencida int4,
 ultimoabonointeres   date,
 numero_de_amor       int4,
 fecha_otorga         date,
 descripcionfinalidad varchar(30),
 diasrestantes        int4,
 frecuencia           numeric,
 interesdevmormenor   numeric,
 interesdevmormayor   numeric,
 condiciones         varchar(50),
 estacion            varchar(30),
 dias_cobro          int4,
 pagosvencidos integer,
 finalidaddefault char(3),
 saldopromediodelmes numeric,
 interesdevengadomes numeric,
 dias_de_cobro integer,
 meses_de_cobro integer,
 primerincumplimiento   date,
 reservaidnc numeric,
 tablareservaid int4 )

  loop
    return next r;

  end loop;

end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.precorteconsolidado(integer, integer) OWNER TO sistema;

--
-- Name: presprocampo(date, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION presprocampo(date, date, integer) RETURNS SETOF rsaldospprocampo
    AS $_$
declare

  pfechai     alias for $1;
  pfechaf     alias for $2;
  pestatus    alias for $3;
 
  r rsaldospprocampo%rowtype;

  lmonto numeric;
  lsaldo numeric;

begin

  lmonto  :=0;
  lsaldo  :=0;
 
    for r in
      select p.referenciaprestamo,
             su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
             p.fecha_otorga,p.montoprestamo,p.saldoprestamo,
             tp.desctipoprestamo,p.tipoprestamoid
        from procampo p, sujeto su, tipoprestamo tp
       where p.fecha_otorga between pfechai and pfechaf and
             (pestatus=0 or (pestatus=1 and p.saldoprestamo=0) or
             (pestatus=2 and p.saldoprestamo>0)) and
             su.sujetoid = p.sujetoid and
             tp.tipoprestamoid = p.tipoprestamoid
       order by p.fecha_otorga,p.tipoprestamoid
    loop

        lmonto := lmonto + r.montoprestamo;
        lsaldo := lsaldo + r.saldoprestamo;
  
        return next r;
    end loop;

   r.referenciaprestamo:= ' ';
   r.nombresocio := 'Total de prestamos:';
   r.montoprestamo := lmonto;
   r.saldoprestamo := lsaldo;
   r.desctipoprestamo := '  ';
   r.tipoprestamoid := '  ';
   return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.presprocampo(date, date, integer) OWNER TO sistema;

--
-- Name: prestamoentregado(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION prestamoentregado(integer) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;

  irepetido int4;

begin


     select count(p.*) into irepetido
       from movibanco m, polizas p
      where m.prestamoid = pprestamoid and
            p.polizaid=m.polizaid and
            substr(p.concepto_poliza,1,9)<>'CANCELADO';

     irepetido:=coalesce(irepetido,0);
     if irepetido>0 then
       return 1;
     end if;

     select count(p.*) into irepetido
       from movicaja m, polizas p
      where m.prestamoid=pprestamoid and
            m.tipomovimientoid='RM' and
            p.polizaid=m.polizaid and
            substr(p.concepto_poliza,1,9)<>'CANCELADO';

     irepetido:=coalesce(irepetido,0);

     if irepetido>0 then
       return 1;
     end if;

return 0;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.prestamoentregado(integer) OWNER TO sistema;

--
-- Name: prestamosconsaldo(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION prestamosconsaldo(date) RETURNS integer
    AS $_$
declare
  pfecha alias for $1;
  
  ltotal numeric;
begin

  ltotal := 0;
  select count(*)
    into ltotal
    from precorte
   where fechacierre=pfecha and saldoprestamo>0;

  ltotal:=coalesce(ltotal,0);

return ltotal;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.prestamosconsaldo(date) OWNER TO sistema;

--
-- Name: prestamosconsaldoc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION prestamosconsaldoc(date) RETURNS integer
    AS $_$
declare
  pfecha alias for $1;
  ltotal numeric;

  r record;
  f record;
  dblink1 text;
  dblink2 text;

begin

ltotal:=0;

for f in
 select * from sucursales where vigente='S'
 loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||';select count(*) from precorte where fechacierre='||''''||to_char(pfecha,'yyyy-mm-dd')||''''||' and saldoprestamo>0;';

        raise notice 'dblink % %',dblink1,dblink2;

        for r in
           select * from dblink(dblink1,dblink2) as t2(total int4)

        loop
            ltotal:=ltotal+coalesce(r.total,0);

        end loop;

end loop;

return ltotal;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.prestamosconsaldoc(date) OWNER TO sistema;

--
-- Name: prestamosrelacionados(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION prestamosrelacionados(date) RETURNS SETOF rprestamosrelacionados
    AS $_$
declare  
  r rprestamosrelacionados%rowtype;
  pfechac alias for $1;
  psaldoprestamo1 numeric;
  psaldoprestamo2 numeric;
  psaldoprestamo3 numeric;
  psaldoprestamo4 numeric;
  psaldoprestamo5 numeric;
  psaldoprestamo6 numeric;
  psaldoprestamo7 numeric;
  psaldoprestamo8 numeric;
  psaldoprestamo9 numeric;
  psaldoprestamo10 numeric;
  psaldoprestamo11 numeric;
  pnumprestamos numeric;

begin

    for r in

        select s.socioid,s.clavesocioint,ltrim(su.paterno)||' '||ltrim(su.materno)||' '||ltrim(su.nombre),d.colonia,d.codpostal,
sum(sd.parte) as partesocial,sum(sd.cuenta) as cuentacorriente,sum(sd.ahorrosedesol) as ahorrosedesol, sum(sd.ahorroordinario) as ahorroordinario,sum(sd.plazofijo) as plazofijo,sum(sd.otros) as otrohaberes,0 as credifacil,0 as confianza, 0 as credihogar, 0 as automatico,0 as renovado, 0 as ordinario,0 as  reestructurado, 0 as  extraordinario, 0 as  alapalabracint, 0 as alapalabrasint,0 as otros, 0 as totalprestamos, '  ' as tipoprestamo  from socio s, sujeto  su, domicilio d,

        (select mc.socioid, sum(mp.debe)-sum(mp.haber) as cuenta,0 as parte, 0 as ahorrosedesol, 0 as ahorroordinario, 0 as plazofijo, 0 as otros from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid= 'CU' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid  union 

select mc.socioid, 0 as cuenta,sum(mp.debe)-sum(mp.haber) as parte, 0 as ahorrosedesol, 0 as ahorroordinario, 0 as plazofijo, 0 as otros from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid= 'PA' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid union

select mc.socioid, 0 as cuenta,0 as parte, sum(mp.debe)-sum(mp.haber) as ahorrosedesol, 0 as ahorroordinario, 0 as plazofijo, 0 as otros from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid= 'SE' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac and tm.aplicasaldo='S' group by mc.socioid union

select mc.socioid, 0 as cuenta,0 as parte, 0 as ahorrosedesol, sum(mp.debe)-sum(mp.haber) as ahorroordinario, 0 as plazofijo, 0 as otros from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid= 'AA' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid union

select mc.socioid, 0 as cuenta,0 as parte, 0 as ahorrosedesol,0 as ahorroordinario, sum(mp.debe)-sum(mp.haber) as plazofijo, 0 as otros from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid= 'IN' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid union

select mc.socioid, 0 as cuenta,0 as parte, 0 as ahorrosedesol,0 as ahorroordinario, 0 as plazofijo, sum(mp.debe)-sum(mp.haber) as otros from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid<> 'CU' and mc.tipomovimientoid<> 'PA' and mc.tipomovimientoid<> 'SE'  and mc.tipomovimientoid<> 'AA' and mc.tipomovimientoid<> 'IN' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid ) sd

        where s.clavesocioint in (






s.tiposocioid <> '01' and  s.sujetoid=su.sujetoid and su.sujetoid=d.sujetoid and s.socioid=sd.socioid
        group by  s.socioid,s.clavesocioint,ltrim(su.paterno)||' '||ltrim(su.materno)||' '||ltrim(su.nombre),d.colonia,d.codpostal order by s.clavesocioint

        loop

            select coalesce(count(prestamoid),0) into pnumprestamos from prestamos where socioid=r.socioid and fecha_otorga  <= pfechac and claveestadocredito <> '008';

            if pnumprestamos > 0 then

                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo1 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid ='A2';

                r.credifacil:=psaldoprestamo1;
                raise notice 'Voy aqui % -- %',r.socioid,pnumprestamos;
                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo2 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid ='B2';

                r.confianza:=psaldoprestamo2;

                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo3 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid ='C2';
                r.credihogar:=psaldoprestamo3;

                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo4 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid ='N2';
                r.automatico:=psaldoprestamo4;

                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo5 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid ='R2';

                r.renovado:=psaldoprestamo5;

                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo6 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid ='S2';
                r.ordinario:=psaldoprestamo6;

                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo7 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid ='T2';
                r.reestructurado:=psaldoprestamo7;

                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo8 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid ='V2';
                r.extraordinario :=psaldoprestamo8;

                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo9 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid ='X1';
                r.alapalabracint:=psaldoprestamo9;

                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo10 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid ='X2';

                r.alapalabrasint:=psaldoprestamo10;

                select coalesce(sum(p.saldoprestamo),0) into psaldoprestamo11 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid and pr.socioid=r.socioid and p.tipoprestamoid <>'A2'  and p.tipoprestamoid <>'B2' and p.tipoprestamoid <>'C2' and p.tipoprestamoid <>'N2' and p.tipoprestamoid <>'R2' and p.tipoprestamoid <>'S2' and p.tipoprestamoid <>'T2' and p.tipoprestamoid <>'V2' and p.tipoprestamoid <>'X1' and p.tipoprestamoid <>'X2';
                r.otros:=psaldoprestamo11;

                r.totalprestamos := psaldoprestamo1+psaldoprestamo2+psaldoprestamo3+psaldoprestamo4+psaldoprestamo5+psaldoprestamo6+psaldoprestamo7+psaldoprestamo8+psaldoprestamo9+psaldoprestamo10+psaldoprestamo11;

            end if;

            return next r;
        end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.prestamosrelacionados(date) OWNER TO sistema;

--
-- Name: promedioactivo(integer, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION promedioactivo(integer, integer, character) RETURNS numeric
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo   alias for $2;
  pactivo    alias for $3;
  r record;
  fpromedio numeric;
  f record;
  dblink1 text;
  dblink2 text;

begin

fpromedio:=0;

for f in
 select * from sucursales where vigente='S'
 loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='select avg(saldoinicialperiodo+cargosdelperiodo-abonosdelperiodo) from '||f.esquema||'.saldos c where c.ejercicio='||to_char(pejercicio,'9999')||' and c.periodo<='||to_char(pperiodo,'99')||' and c.cuentaid='||''''||pactivo||'''';
  for r in
   select * from
    dblink(dblink1,dblink2) as t2(promedio numeric)

  loop
    fpromedio:=fpromedio+coalesce(r.promedio,0);    
  end loop;

 
end loop;

return fpromedio;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.promedioactivo(integer, integer, character) OWNER TO sistema;

--
-- Name: promediocuenta(character, date, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION promediocuenta(character, date, date, character) RETURNS numeric
    AS $_$
declare
  pcuentaid alias for $1;
  tsaldo numeric;
  pfechai alias for $2;
  pfechaf alias for $3;
  sconsolida alias for $4;

  pdias int4;
  pfechacontrol date;
  i int4;
  lsaldo numeric;
  f record;
  r record;
  
  iperiodo integer;
  iejercicio integer;
  fperiodo integer;
  fejercicio integer;

  tsaldo1 numeric;
  tsaldo2 numeric;

begin

pfechacontrol := pfechai;
lsaldo := 0;
pdias := 0;
i:=0;
tsaldo := 0;

iperiodo := (cast(extract(month from pfechai) as integer));
iejercicio := (cast(extract(year from pfechai) as integer));

fperiodo := (cast(extract(month from pfechaf) as integer));
fejercicio := (cast(extract(year from pfechaf) as integer));

pdias := (cast(extract(day from pfechaf) as integer));

while i<pdias loop

       if sconsolida = 'S' then

         select saldoinicialperiodo+cargosdelperiodo-abonosdelperiodo
         into  tsaldo1
         from saldosc
        where ejercicio=iejercicio and
         periodo=iperiodo and
         cuentaid=pcuentaid;

          select saldoinicialperiodo+cargosdelperiodo-abonosdelperiodo
         into  tsaldo2
         from saldosc
        where ejercicio=fejercicio and
         periodo=fperiodo and 
        cuentaid=pcuentaid;

         tsaldo:=(tsaldo1+tsaldo2 )/2;
 
        else

	        SELECT SUM(debe)-SUM(haber) into lsaldo
	        FROM polizas p, movipolizas m
	        WHERE p.fechapoliza <= pfechacontrol and
	        m.polizaid = p.polizaid AND m.cuentaid=pcuentaid;

	        lsaldo := coalesce(lsaldo,0);
		tsaldo := tsaldo+lsaldo;

        end if;

        i:=i+1;
        pfechacontrol:= pfechacontrol+1;

end loop;

tsaldo := tsaldo/pdias;
return tsaldo;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.promediocuenta(character, date, date, character) OWNER TO sistema;

--
-- Name: promocion_vigente(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION promocion_vigente(character) RETURNS integer
    AS $_$
declare
 ptipomovimientoid alias for $1;
 lfechainicial date;
 lfechafinal date;
 lfechaactual date;
begin

 select fechainicial,fechafinal
   into lfechainicial,lfechafinal
   from tipopromocion
  where tipomovimientoid = ptipomovimientoid;

select substr(now(),0,11) into lfechaactual as fechaactual;

  if lfechaactual between lfechainicial and lfechafinal  then
    return 1;
  end if;

return 0;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.promocion_vigente(character) OWNER TO sistema;

--
-- Name: prorrateareciprocidad(date, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION prorrateareciprocidad(date, numeric) RETURNS numeric
    AS $_$
declare

  dfecha alias for $1;
  freciprocidad alias for $2;

  fprorrateo numeric;
  freservacalculada numeric;
  freservareal numeric;
begin

  select saldocuenta('1-06-  -  -  -  -  ',
                     cast(date_part('year', dfecha) as int),
                     cast(date_part('month', dfecha) as int)) into freservareal;

  select sum(reservacalculada)
    into freservacalculada
    from precorte
   where fechacierre=dfecha;

  fprorrateo:=freservareal*freciprocidad/freservacalculada;

return round(fprorrateo);
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.prorrateareciprocidad(date, numeric) OWNER TO sistema;

--
-- Name: rcoeficiente(date, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rcoeficiente(date, integer, integer) RETURNS SETOF rrcoeficiente
    AS $_$

  DECLARE

  pfechaf   alias for $1;
  pconsolidado alias for $2;
  pmiles       alias for $3;
  
  r rrcoeficiente%rowtype;
  sconsolida char(1);
  dfechai date;

 
  iperiodo int;
  iejercicio int;


  daytab numeric[2][13]:=array[[31,28,31,30,31,30,31,31,30,31,30,31,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31,31]];
  
  mestab varchar[13]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE',
                            'DICIEMBRE'];


  ftitulosalvencimiento numeric;
  finversionmenor30 numeric;
  fbancos numeric;
  b numeric;

  fprestamosbancarios numeric;
  fdepositoplazomenor30 numeric;
  fdepositoexigibilidad numeric;
  fdepositocortoplazo numeric;


  fbancosprom numeric;
  ftitulosalvencimientoprom numeric;
  fdepositoplazomenor30prom numeric;
  fdepositoexigibilidadprom numeric;
  fprestamosbancariosprom numeric;
  a numeric;

  fcoeficiente numeric;

begin

  ftitulosalvencimientoprom := 0;
  fbancosprom := 0;
  fdepositoplazomenor30prom := 0;
  fdepositoexigibilidadprom := 0;
  fprestamosbancariosprom := 0;


  -- Inicio de mes

  dfechai := pfechaf - (cast(extract(day from pfechaf) as integer) -1);
  raise notice 'Fecha inicio de mes %',dfechai;

  iejercicio:=date_part('year',pfechaf);
  iperiodo:=date_part('month',pfechaf);

   if pconsolidado=1 then
    r.concepto1:='CONSOLIDADO COEFICIENTE DE LIQUIDEZ';
    sconsolida:='S';
  else
    r.concepto1:='SUCURSAL COEFICIENTE DE LIQUIDEZ';
    sconsolida:='N';
  end if;
  return next r;


-- Calculo de B

  ftitulosalvencimiento := abs(saldocuenta('1201',iejercicio,iperiodo,sconsolida))+
                           abs(saldocuenta('1204',iejercicio,iperiodo,sconsolida));   --4

 -- ftitulosalvencimientoprom := round(promedioinversionesvalores(pfechaf),0);

  ftitulosalvencimientoprom := ftitulosalvencimiento;

  finversionmenor30 := ftitulosalvencimiento;   

  fbancos := saldocuenta('1102',iejercicio,iperiodo,sconsolida);                       -- 3
--  fbancosprom := round(promediobancos(pfechaf),0);
  fbancosprom := fbancos;

  b := fbancos +  finversionmenor30;                                                     -- B  ( 3+4 )


-- Calculo de A
    select saldoinsoluto into fprestamosbancarios from prestamobancario where fechavencimiento - pfechaf <= 30;       -- 2
     fprestamosbancarios := coalesce(fprestamosbancarios,0);
    fprestamosbancariosprom := fprestamosbancarios;

 if sconsolida='S' 
  then

  select round(sum(deposito+interes),2)
    into fdepositoplazomenor30
    from inversionesxfechac(pfechaf) where fechavencimiento - pfechaf <= 30;


  else
  select round(sum(deposito+interes),2)
    into fdepositoplazomenor30
    from inversionesxfecha(pfechaf) where fechavencimiento - pfechaf <= 30;

  
  end if;


   --  fdepositoplazomenor30prom := round(promedioinversiones(pfechaf),2);

  fdepositoplazomenor30 := fdepositoplazomenor30;

  fdepositoplazomenor30prom := fdepositoplazomenor30;

  fdepositoexigibilidad := abs(saldocuenta('2101',iejercicio,iperiodo,sconsolida));

   -- fdepositoexigibilidadprom := round(promediodepositos(pfechaf),0);

  fdepositoexigibilidadprom := fdepositoexigibilidad;

  fdepositocortoplazo :=  fdepositoplazomenor30 + fdepositoexigibilidad;                 -- 1

  a :=  fdepositocortoplazo + fprestamosbancarios;                                      -- A  ( 1+2 )


  fcoeficiente := 100*b/a;





   --  -- Pendiente validar ao bisiesto
 if pconsolidado=1 
  then
   r.concepto1:='Coeficiente de Liquidez al'||to_char(daytab[1][iperiodo],'99')||' de '||mestab[iperiodo]||' de'||to_char(iejercicio,'9999');
  else
   r.concepto1:='Coeficiente de Liquidez al'||to_char(daytab[1][iperiodo],'99')||' de '||mestab[iperiodo]||' de'||to_char(iejercicio,'9999');
  end if; 
  r.concepto2 := null;
  r.concepto3 := null;
  r.a:=NULL;
  r.b:=NULL;
  return next r;

 
  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  if pmiles=1 
  then
     r.concepto1:='(Cifras en miles de pesos)';
     r.a := NULL;
     r.b := NULL;
     return next r;     
  else
     r.concepto1:='(Cifras en pesos)';
     r.a := NULL;
     r.b := NULL;
     return next r;
  end if;
 
    r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;
  
  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;
  
  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;
  
  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;
  
  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;
  
  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  r.concepto1:='Coeficiente de Liquidez (B/A) 2/';
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := fcoeficiente;
  r.b := NULL;
  return next r;

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  r.concepto1:='A. Total Pasivos de Corto Plazo (1+2)';
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := a;
  r.b := fdepositoexigibilidadprom + fdepositoplazomenor30prom+fprestamosbancariosprom;
  return next r;

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  r.concepto1 := NULL;
  r.concepto2:='1.Depositos de corto plazo y titulos emitidos ';
  r.concepto3 := null;
  r.a := fdepositocortoplazo;
  r.b := fdepositoexigibilidadprom + fdepositoplazomenor30prom;
  return next r;   

  r.concepto1 := NULL;
  r.concepto2 := NULL;
  r.concepto3:='De exigibilidad inmediata ';
  r.a := fdepositoexigibilidad;
  r.b := fdepositoexigibilidadprom;
  return next r;   

  r.concepto1 := NULL;
  r.concepto2 := NULL;
  r.concepto3:='Depositos a plazo (menor a 30 dias)';
  r.a := fdepositoplazomenor30;
  r.b := fdepositoplazomenor30prom;
  return next r;   

  r.concepto1 := NULL;
  r.concepto2 := NULL;
  r.concepto3:='Titulos de credito emitidos (plazo menor de 30 dias) 3/';
  r.a:= 0;
  r.b := 0;
  return next r;   

  r.concepto1 := NULL;
  r.concepto2:='2. Prestamos bancarios y de otros organismos';
  r.concepto3 := NULL;
  r.a := fprestamosbancarios;
  r.b := fprestamosbancarios;
  return next r;   

  r.concepto1 := NULL;
  r.concepto2 := NULL;
  r.concepto3:='De corto plazo (menor a 30 dias)';
  r.a:= fprestamosbancarios;
  r.b := fprestamosbancarios;
  return next r; 

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;


  r.concepto1:='B. Total activos liquidos de corto plazo (3 + 4)';
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := b;
  r.b := ftitulosalvencimientoprom + fbancosprom;
  return next r;  

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a := NULL;
  r.b := NULL;
  return next r;

  r.concepto1 := NULL;
  r.concepto2:='3.Cuentas de cheques';
  r.concepto3 := null;
  r.a := fbancos;
  r.b := fbancosprom;
  return next r; 

  r.concepto1 := NULL;
  r.concepto2:='4.Inversiones en valores con vencimiento menor a 30 dias 4/';
  r.concepto3 := null;
  r.a := finversionmenor30;
  r.b := ftitulosalvencimientoprom;
  return next r; 

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3:='Titulos por negociar 5/';
  r.a:= finversionmenor30;
  r.b := ftitulosalvencimientoprom;
  return next r; 

  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3:='Titulos disponibles para la venta 5/';
  r.a:= 0;
  r.b := 0;
  return next r; 
  
  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3:='Titulos conservados al vencimiento 5/';
  r.a:= 0;
  r.b := 0;
  return next r; 

  r.concepto1 := NULL;
  r.concepto2 := null;  
  r.concepto3:='Inversiones en valores con vencimiento menor a 30 dias sin desagregacion 6/';
  r.a:= 0;
  r.b := 0;
  return next r; 
 
  r.concepto1 := NULL;
  r.concepto2 := null;
  r.concepto3 := null;
  r.a:=NULL;
  r.b:=NULL;
  return next r;
  
return ;

END
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.rcoeficiente(date, integer, integer) OWNER TO sistema;

--
-- Name: rconspoliza(integer, integer, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rconspoliza(integer, integer, character, character, character) RETURNS SETOF tconspoliza
    AS $_$
declare
  r tconspoliza%rowtype;
  pejercicio alias for $1;
  pperiodo alias for $2;
  ptipo_poliza alias for $3;
  pserie alias for $4;
  ptipo alias for $5;
  
  lnumero int4;
  lreferencia int4;
begin

  select max(numero_poliza)+1
    into lnumero
    from polizas
   where ejercicio=pejercicio and
         periodo=pperiodo and
         tipo_poliza=ptipo_poliza;

  select max(referencia)+1
    into lreferencia
    from polizas
   where seriepoliza=pserie and tipo=ptipo;

    r.numero_poliza = coalesce(lnumero,1);
    r.referencia = coalesce(lreferencia,1);
    return next r;
   
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.rconspoliza(integer, integer, character, character, character) OWNER TO sistema;

--
-- Name: rconvenios(character, character, date, date, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rconvenios(character, character, date, date, character, character, integer) RETURNS SETOF rconvenios
    AS $_$
declare
  r rconvenios%rowtype;
  psocioinicial alias for $1;
  psociofinal   alias for $2;
  pfechainicial alias for $3;
  pfechafinal   alias for $4;
  pvigente      alias for $5;
  pusuarioid    alias for $6;

begin

    for r in
      select s.clavesocioint, p.referenciaprestamo,
             su.nombre||' '||su.paterno||' '|| su.materno as nombre,c.usuarioid,c.fechaconvenio,
             (case when c.lugar=1 then 'Oficina' else 'Visita ' end) as lugar
        from convenio c, prestamos p, socio s, sujeto su
       where c.fechaconvenio between pfechainicial and pfechafinal and
             (pvigente='T' or c.vigente=pvigente) and
             (pusuarioid='<TODOS>' or c.usuarioid=pusuarioid) and
             p.prestamoid = c.prestamoid and
             s.socioid = p.socioid and
             s.clavesocioint>=psocioinicial and s.clavesocioint<=psociofinal and
             su.sujetoid = s.sujetoid
    loop
      
      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.rconvenios(character, character, date, date, character, character, integer) OWNER TO sistema;

--
-- Name: reasignar(character, integer, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reasignar(character, integer, date, character) RETURNS integer
    AS $_$
declare
  pseriei alias for $1;
  pfolioi alias for $2;
  pfecha  alias for $3;
  pserief alias for $4;

  lfoliof int4;

  lmovicajaid int4;
  lpolizaid int4;

  pnumero_poliza int4;
  preferencia int4;

  pcuentacajaant char(24);
  pcuentacajanue char(24);

begin

  select cuentacaja
    into pcuentacajaant
    from parametros
   where serie_user = pseriei;

  select cuentacaja
    into pcuentacajanue
    from parametros
   where serie_user = pserief;

  select m.movicajaid,m.polizaid
    into lmovicajaid,lpolizaid
    from movicaja m, polizas p
   where seriecaja=pseriei and
         referenciacaja=pfolioi and
         p.polizaid = m.polizaid and
         p.fechapoliza = pfecha;
         
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',pserief,'A');

  select coalesce(max(referenciacaja),0)
     into lfoliof
     from movicaja
    where seriecaja = pserief;

  lfoliof := lfoliof+1; 
 
  update movicaja
     set seriecaja = pserief,
         referenciacaja = lfoliof
   where movicajaid = lmovicajaid;

  update polizas
     set seriepoliza = pserief,
         numero_poliza = pnumero_poliza,
         referencia = preferencia
   where polizaid=lpolizaid;

  update movipolizas
     set cuentaid = pcuentacajanue
   where polizaid = lpolizaid and
         cuentaid = pcuentacajaant;
  

return lfoliof;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reasignar(character, integer, date, character) OWNER TO sistema;

--
-- Name: recalculasaldo(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION recalculasaldo(character) RETURNS integer
    AS $_$
declare
  pno_cuenta   alias for $1;

  fsaldoinicial numeric;
  fmovs numeric;
  dfecha_inicio date;
begin

    select saldo_inicial,fecha_inicio
      into fsaldoinicial,dfecha_inicio
      from bancos
     where no_cuenta = pno_cuenta;


    select sum(m.debe-m.haber)
      into fmovs
      from bancos b, polizas p, movipolizas m
     where b.no_cuenta=pno_cuenta and
           p.fechapoliza between dfecha_inicio+1 and CURRENT_DATE and
           m.polizaid = p.polizaid and
           m.cuentaid = b.cuentaid;

    fmovs := coalesce(fmovs,0);

    update bancos
       set saldo_actual = fsaldoinicial+fmovs
     where no_cuenta=pno_cuenta;


return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.recalculasaldo(character) OWNER TO sistema;

--
-- Name: recicreditos(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION recicreditos(integer, character) RETURNS numeric
    AS $_$
declare
  psocioid alias for $1;
  pgarantiaid alias for $2;
  lreciprocidad numeric;

begin

  lreciprocidad := 0;
  select p.montoprestamo/t.tantos
    into lreciprocidad
    from prestamos p, tipoprestamo t
   where p.socioid = psocioid and
         p.saldoprestamo>0 and
         p.claveestadocredito<>'008' and
         t.tipoprestamoid=p.tipoprestamoid and
         t.tantos>0 and
         t.tipomovimientoid=pgarantiaid;

  lreciprocidad := coalesce(lreciprocidad,0);

return lreciprocidad;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.recicreditos(integer, character) OWNER TO sistema;

--
-- Name: reciprocidadactual(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reciprocidadactual(integer) RETURNS numeric
    AS $_$
declare

  lprestamoid alias for $1;

  freciprocidad numeric;
  fsaldo numeric;
  stipomovimientoid char(2);
  lsocioid int4;

  fmonto numeric;
  ftantos numeric;
begin

  fsaldo:=0;
  freciprocidad:=0;
  fmonto:=0;
  ftantos:=0;

  select p.montoprestamo,t.tantos,t.tipomovimientoid,p.socioid
    into fmonto,ftantos,stipomovimientoid,lsocioid
    from prestamos p, tipoprestamo t
   where p.prestamoid=lprestamoid and
         t.tipoprestamoid=p.tipoprestamoid;

  if ftantos>0 then
    freciprocidad:=round(fmonto/ftantos,2);

    select round(saldo,2)
      into fsaldo
      from spssaldosmov(lsocioid)
     where tipomovimientoid=stipomovimientoid;

    if fsaldo>freciprocidad then
      fsaldo:=freciprocidad;
    end if;

  else
    freciprocidad:=0;
  end if;


return round(fsaldo,2);
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reciprocidadactual(integer) OWNER TO sistema;

--
-- Name: reciprocidadactual(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reciprocidadactual(integer, integer) RETURNS numeric
    AS $_$
declare
  psocioid alias for $1;
  pprestamoid alias for $2;

  freciprocidad numeric;
  r record;

  freciprocidadinicial numeric;

  stipomovimientoid char(2);
  fsaldo numeric;
  fotrosprestamos numeric;

  ftotalprestamos numeric;
  fmontoprestamo numeric;

begin

  ftotalprestamos:=0;
  fmontoprestamo:=0;

  select tipomovimientoid
    into stipomovimientoid
    from prestamos p, tipoprestamo t
   where p.prestamoid = pprestamoid and
         t.tipoprestamoid = p.tipoprestamoid;

  select saldo into fsaldo from spssaldosmov(psocioid) where tipomovimientoid=stipomovimientoid;

  freciprocidad:=0;
  for r in
    select * from prestamos where socioid=psocioid and prestamoid=pprestamoid and claveestadocredito='001'
  loop

    select reciprocidadinicial
      into freciprocidadinicial
      from tasastipoprestamo
     where tipoprestamoid=r.tipoprestamoid and tasanormal=r.tasanormal;

    freciprocidadinicial:=coalesce(freciprocidadinicial,0);

    freciprocidad:=freciprocidad+r.montoprestamo*freciprocidadinicial/100;

    ftotalprestamos := ftotalprestamos + r.montoprestamo;
    fmontoprestamo:=r.montoprestamo;

  end loop;

  fotrosprestamos:=0;

  
  for r in
    select * from prestamos where socioid=psocioid and prestamoid<>pprestamoid and claveestadocredito='001'
  loop

    select reciprocidadinicial
      into freciprocidadinicial
      from tasastipoprestamo
     where tipoprestamoid=r.tipoprestamoid and tasanormal=r.tasanormal;

    freciprocidadinicial:=coalesce(freciprocidadinicial,0);

    fotrosprestamos:=fotrosprestamos+r.montoprestamo*freciprocidadinicial/100;
    ftotalprestamos := ftotalprestamos + r.montoprestamo;

  end loop;

  if freciprocidad+fotrosprestamos>fsaldo then
    -- Prorrateo por que son mas de 1 prestamo
    freciprocidad := fmontoprestamo/ftotalprestamos*fsaldo;

  end if;
   
return freciprocidad;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reciprocidadactual(integer, integer) OWNER TO sistema;

--
-- Name: reciprocidadactual(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reciprocidadactual(integer, character) RETURNS numeric
    AS $_$
declare

  psocioid          alias for $1;	
  ptipomovimientoid alias for $2;

  freciprocidad numeric;
 
  fmonto numeric;
 
  r record;

begin


  freciprocidad:=0;
  fmonto:=0;


  for r in select p.socioid,p.prestamoid,p.monto_garantia from prestamos p, tipoprestamo tp  where socioid=psocioid and p.claveestadocredito='001' and p.tipoprestamoid=tp.tipoprestamoid and tp.tipomovimientoid=ptipomovimientoid 

  loop

    fmonto:= coalesce(r.monto_garantia,0);

    freciprocidad:= freciprocidad + fmonto;

  end loop;

return round(freciprocidad,2);
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reciprocidadactual(integer, character) OWNER TO sistema;

--
-- Name: reciprocidadactualaa(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reciprocidadactualaa(integer) RETURNS numeric
    AS $_$
declare

  psocioid          alias for $1;	

  freciprocidad numeric;
 
  fmonto numeric;
 
  r record;

begin

  freciprocidad:=0;
  fmonto:=0;

  for r in select p.socioid,p.prestamoid,p.monto_garantia from prestamos p, tipoprestamo tp  where socioid=psocioid and p.claveestadocredito='001' and p.tipoprestamoid=tp.tipoprestamoid

  loop

    fmonto:= coalesce(r.monto_garantia,0);
    freciprocidad:= freciprocidad + fmonto;

  end loop;

return round(freciprocidad,2);
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reciprocidadactualaa(integer) OWNER TO sistema;

--
-- Name: reciprocidadnov(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reciprocidadnov() RETURNS integer
    AS $$
declare

 iperiodo1 int4;
 iano1 int4;
 iseq int4;
 iseq2 int4;
 lmovipolizaid int4;
 scuenta char(24);
 dfecha date;
 dpoliza date;
 lmv int4;
begin

  --
  -- fecha hasta donde se toman los prestamos
  --
  dfecha:='17-11-2005';

  --
  -- fecha de la poliza, mal hecho por que queda con fecha
  -- posterior a la del ultimo prestamo
  --
  dpoliza:='01-11-2005';

  raise notice 'Comenzando traspaso';

  iperiodo1 := cast(date_part('month',dfecha) as int);
  iano1 := cast(date_part('year',dfecha) as int);

  select setval('seqnopoliza',max(numero_poliza))
    into iseq
    from polizas where tipo_poliza='D';
  select currval('seqnopoliza')
    into iseq;
  select setval('seqreferencia',1)
    into iseq2;


  -- Realizar las polizas por cada socio

  insert into polizas( numero_poliza,seriepoliza,tipo,referencia,ejercicio,periodo,
                       fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,
                       concepto_poliza,fecha_fin_aceptacion )
  select nextval('seqnopoliza') as numero_poliza,
         'ZA' as seriepoliza,
         'J' as tipo,
         nextval('seqreferencia') as referencia,
         iano1 as ejercicio,
         iperiodo1 as periodo,
         dfecha as fechapoliza,
         'D' as tipo_poliza,
         ' ' as clase_poliza,
         ' ' as diario_agrupador,
         a.referenciaprestamo as concepto_poliza,
         dfecha as fecha_fin_aceptacion
    from (

select p.socioid,p.prestamoid,p.referenciaprestamo, 
       p.saldoprestamo,
       tp.tantos, p.montoprestamo, ROUND(p.montoprestamo/tp.tantos,2) as reciprocidad,
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha) as saldorg,
       (case when ROUND(p.montoprestamo/tp.tantos,2)<=saldodemov(p.socioid,tp.tipomovimientoid,dfecha)
             then ROUND(p.montoprestamo/tp.tantos,2)
             else saldodemov(p.socioid,tp.tipomovimientoid,dfecha) end) as cantidad,
       tp.tipomovimientoid, tm.cuentadeposito,tm.cuentaretiro
    from prestamos p, tipoprestamoant tp, tipomovimiento tm
   where p.claveestadocredito<>'008' and p.tipoprestamoid<>'E1 ' and
         p.fecha_otorga<=dfecha and
         p.fecha_otorga>=dpoliza and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tantos>0 and
         tm.tipomovimientoid=tp.tipomovimientoid
having p.saldoprestamo>0 and
       saldodemov(p.socioid,tp.tipomovimientoid,current_date)>=saldodemov(p.socioid,tp.tipomovimientoid,dfecha) and
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha)>0       
order by p.socioid 

) as a;



  select nextval('movipolizas_movipolizaid_seq')
    into lmovipolizaid;

  select CURRVAL('movipolizas_movipolizaid_seq')
    into lmovipolizaid;


  insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)

 select r.polizaid,b.cuentaretiro,' ','C',b.cantidad,0,' ',' ',
        b.referenciaprestamo
   from polizas r, (

select p.socioid,p.prestamoid,p.referenciaprestamo, 
       p.saldoprestamo,
       tp.tantos, p.montoprestamo, ROUND(p.montoprestamo/tp.tantos,2) as reciprocidad,
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha) as saldorg,
       (case when ROUND(p.montoprestamo/tp.tantos,2)<=saldodemov(p.socioid,tp.tipomovimientoid,dfecha)
             then ROUND(p.montoprestamo/tp.tantos,2)
             else saldodemov(p.socioid,tp.tipomovimientoid,dfecha) end) as cantidad,
       tp.tipomovimientoid, tm.cuentadeposito,tm.cuentaretiro
    from prestamos p, tipoprestamoant tp, tipomovimiento tm
   where p.claveestadocredito<>'008' and p.tipoprestamoid<>'E1 ' and
         p.fecha_otorga<=dfecha and
         p.fecha_otorga>=dpoliza and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tantos>0 and
         tm.tipomovimientoid=tp.tipomovimientoid
having p.saldoprestamo>0 and
       saldodemov(p.socioid,tp.tipomovimientoid,current_date)>=saldodemov(p.socioid,tp.tipomovimientoid,dfecha) and
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha)>0       
order by p.socioid 

) as b
where r.fechapoliza=dfecha and r.tipo='J' and
      substr(r.concepto_poliza,1,18)=b.referenciaprestamo
order by r.polizaid;


  select cuentadeposito
    into scuenta
    from tipomovimiento
   where tipomovimientoid='RG';

  select currval('movipolizas_movipolizaid_seq')
    into lmv;

  insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)

 select r.polizaid,scuenta,' ','A',0,b.cantidad,' ',' ',
        b.referenciaprestamo
   from polizas r, (

select p.socioid,p.prestamoid,p.referenciaprestamo, 
       p.saldoprestamo,
       tp.tantos, p.montoprestamo, ROUND(p.montoprestamo/tp.tantos,2) as reciprocidad,
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha) as saldorg,
       (case when ROUND(p.montoprestamo/tp.tantos,2)<=saldodemov(p.socioid,tp.tipomovimientoid,dfecha)
             then ROUND(p.montoprestamo/tp.tantos,2)
             else saldodemov(p.socioid,tp.tipomovimientoid,dfecha) end) as cantidad,
       tp.tipomovimientoid, tm.cuentadeposito,tm.cuentaretiro
    from prestamos p, tipoprestamoant tp, tipomovimiento tm
   where p.claveestadocredito<>'008' and p.tipoprestamoid<>'E1 ' and
         p.fecha_otorga<=dfecha and
         p.fecha_otorga>=dpoliza and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tantos>0 and
         tm.tipomovimientoid=tp.tipomovimientoid
having p.saldoprestamo>0 and
       saldodemov(p.socioid,tp.tipomovimientoid,current_date)>=saldodemov(p.socioid,tp.tipomovimientoid,dfecha) and
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha)>0       
order by p.socioid 

) as b
where r.fechapoliza=dfecha and r.tipo='J' and
      substr(r.concepto_poliza,1,18)=b.referenciaprestamo
order by r.polizaid;


  select setval('seqnopoliza',lmovipolizaid)
    into iseq2;
  select setval('seqreferencia',1)
    into iseq2;


insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,estatusmovicaja,prestamoid)

 select b.socioid,'RG',r.polizaid,1,'ZA',nextval('seqnopoliza'),'A',b.prestamoid
   from polizas r, (

select p.socioid,p.prestamoid,p.referenciaprestamo, 
       p.saldoprestamo,
       tp.tantos, p.montoprestamo, ROUND(p.montoprestamo/tp.tantos,2) as reciprocidad,
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha) as saldorg,
       (case when ROUND(p.montoprestamo/tp.tantos,2)<=saldodemov(p.socioid,tp.tipomovimientoid,dfecha)
             then ROUND(p.montoprestamo/tp.tantos,2)
             else saldodemov(p.socioid,tp.tipomovimientoid,dfecha) end) as cantidad,
       tp.tipomovimientoid, tm.cuentadeposito,tm.cuentaretiro
    from prestamos p, tipoprestamoant tp, tipomovimiento tm
   where p.claveestadocredito<>'008' and p.tipoprestamoid<>'E1 ' and
         p.fecha_otorga<=dfecha and
         p.fecha_otorga>=dpoliza and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tantos>0 and
         tm.tipomovimientoid=tp.tipomovimientoid
having p.saldoprestamo>0 and p.tipoprestamoid<>'E1 ' and
       p.fecha_otorga<=dfecha and
       saldodemov(p.socioid,tp.tipomovimientoid,current_date)>=saldodemov(p.socioid,tp.tipomovimientoid,dfecha) and
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha)>0       
order by p.socioid 

) as b
where r.fechapoliza=dfecha and r.tipo='J' and
      substr(r.concepto_poliza,1,18)=b.referenciaprestamo
order by r.polizaid;


  select setval('seqnopoliza',lmv)
    into iseq2;
  select setval('seqreferencia',1)
    into iseq2;

insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,estatusmovicaja,prestamoid)

 select b.socioid,b.tipomovimientoid,r.polizaid,1,'ZA',nextval('seqnopoliza'),'A',b.prestamoid
   from polizas r, (

select p.socioid,p.prestamoid,p.referenciaprestamo, 
       p.saldoprestamo,
       tp.tantos, p.montoprestamo, ROUND(p.montoprestamo/tp.tantos,2) as reciprocidad,
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha) as saldorg,
       (case when ROUND(p.montoprestamo/tp.tantos,2)<=saldodemov(p.socioid,tp.tipomovimientoid,dfecha)
             then ROUND(p.montoprestamo/tp.tantos,2)
             else saldodemov(p.socioid,tp.tipomovimientoid,dfecha) end) as cantidad,
       tp.tipomovimientoid, tm.cuentadeposito,tm.cuentaretiro
    from prestamos p, tipoprestamoant tp, tipomovimiento tm
   where p.claveestadocredito<>'008' and p.tipoprestamoid<>'E1 ' and
         p.fecha_otorga<=dfecha and
         p.fecha_otorga>=dpoliza and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tantos>0 and
         tm.tipomovimientoid=tp.tipomovimientoid
having p.saldoprestamo>0 and p.tipoprestamoid<>'E1 ' and
       p.fecha_otorga<=dfecha and       
       saldodemov(p.socioid,tp.tipomovimientoid,current_date)>=saldodemov(p.socioid,tp.tipomovimientoid,dfecha) and
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha)>0       
order by p.socioid 

) as b
where r.fechapoliza=dfecha and r.tipo='J' and
      substr(r.concepto_poliza,1,18)=b.referenciaprestamo
order by r.polizaid;



return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reciprocidadnov() OWNER TO sistema;

--
-- Name: recuperanorenovaciones(character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION recuperanorenovaciones(character, character, character) RETURNS integer
    AS $_$
declare
  
  r record;
  phost alias for $1;
  pdb alias for $2;
  psucursal alias for $3;
  pcuentaid char(24);

begin
 
 for r in
    select * from
    dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
        'set search_path to public,'||''''||psucursal||''''||';
    select inversionid,noderenovaciones
    from inversion;')
    as t( inversionid int4,
    noderenovaciones integer)

  loop

    update inversion set noderenovaciones=r.noderenovaciones where inversionid=r.inversionid;
  
    
  end loop;

  raise notice 'Termine noderenovaciones inversion';

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.recuperanorenovaciones(character, character, character) OWNER TO sistema;

--
-- Name: recuperaprecorte(character varying, character varying, character varying, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION recuperaprecorte(character varying, character varying, character varying, integer, integer) RETURNS integer
    AS $_$
declare
  
  phost alias for $1;
  pdb alias for $2;
  psucursal alias for $3;
  pejercicio alias for $4;
  pperiodo alias for $5;

begin

  delete from precorte where ejercicio=pejercicio and periodo=pperiodo;

  insert into precorte(
    tablareservaid,
    prestamoid,
    ejercicio,
    periodo,
    fechacierre,
    diasvencidos,
    porcentajeaplicado,
    factoraplicado,
    saldoprestamo,
    reservacalculada,
    interesdevengadomenoravencido,
    interesdevengadomayoravencido,
    pagocapitalenperiodo,
    pagointeresenperiodo,
    pagomoratorioenperiodo,
    bonificacionintenperiodo,
    bonificacionmorenperiodo,
    noamorvencidas,
    saldovencidomenoravencido,
    saldovencidomayoravencido,
    fechaultamorpagada,
    tipoprestamoid,
    montoprestamo,
    clavefinalidad,
    tasanormal,
    tasa_moratoria,
    ultimoabono,
    diastraspasoavencida,
    fecha_vencimiento,
    ultimoabonointeres,
    interesdevmormenor,
    interesdevmormayor)

    SELECT

    tablareservaid,
    prestamoid,
    ejercicio,
    periodo,
    fechacierre,
    diasvencidos,
    porcentajeaplicado,
    factoraplicado,
    saldoprestamo,
    reservacalculada,
    interesdevengadomenoravencido,
    interesdevengadomayoravencido,
    pagocapitalenperiodo,
    pagointeresenperiodo,
    pagomoratorioenperiodo,
    bonificacionintenperiodo,
    bonificacionmorenperiodo,
    noamorvencidas,
    saldovencidomenoravencido,
    saldovencidomayoravencido,
    fechaultamorpagada,
    tipoprestamoid,
    montoprestamo,
    clavefinalidad,
    tasanormal,
    tasa_moratoria,
    ultimoabono,
    diastraspasoavencida,
    fecha_vencimiento,
    ultimoabonointeres,
    interesdevmormenor,
    interesdevmormayor

    FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema','set search_path to public,'||''''||psucursal||''''||';
    select
    tablareservaid,
    prestamoid,
    ejercicio,
    periodo,
    fechacierre,
    diasvencidos,
    porcentajeaplicado,
    factoraplicado,
    saldoprestamo,
    reservacalculada,
    interesdevengadomenoravencido,
    interesdevengadomayoravencido,
    pagocapitalenperiodo,
    pagointeresenperiodo,
    pagomoratorioenperiodo,
    bonificacionintenperiodo,
    bonificacionmorenperiodo,
    noamorvencidas,
    saldovencidomenoravencido,
    saldovencidomayoravencido,
    fechaultamorpagada,
    tipoprestamoid,
    montoprestamo,
    clavefinalidad,
    tasanormal,
    tasa_moratoria,
    ultimoabono,
    diastraspasoavencida,
    fecha_vencimiento,
    ultimoabonointeres,
    interesdevmormenor,
    interesdevmormayor

    from precorte where ejercicio='||''''||pejercicio||''''||' and
                        periodo='||''''||pperiodo||''''||';')

    as t(
    tablareservaid integer,
    prestamoid integer,
    ejercicio integer,
    periodo integer,
    fechacierre date,
    diasvencidos integer,
    porcentajeaplicado numeric,
    factoraplicado numeric,
    saldoprestamo numeric,
    reservacalculada numeric,
    interesdevengadomenoravencido numeric,
    interesdevengadomayoravencido numeric,
    pagocapitalenperiodo numeric,
    pagointeresenperiodo numeric,
    pagomoratorioenperiodo numeric,
    bonificacionintenperiodo numeric,
    bonificacionmorenperiodo numeric,
    noamorvencidas integer,
    saldovencidomenoravencido numeric,
    saldovencidomayoravencido numeric,
    fechaultamorpagada date,
    tipoprestamoid character(3),
    montoprestamo numeric,
    clavefinalidad character(3),
    tasanormal numeric,
    tasa_moratoria numeric,
    ultimoabono date,
    diastraspasoavencida integer,
    fecha_vencimiento date,
    ultimoabonointeres date,
    interesdevmormenor numeric,
    interesdevmormayor numeric);

  return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.recuperaprecorte(character varying, character varying, character varying, integer, integer) OWNER TO sistema;

--
-- Name: referenciapoliza(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION referenciapoliza(integer) RETURNS integer
    AS $_$
declare

  ppolizaid alias for $1;
  lref int4;
begin

  -- Buscamos primero si se trata de algn mov. de caja

  select max(referenciacaja)
    into lref
    from movicaja
   where polizaid=ppolizaid;

  lref := coalesce(lref,0);

  if lref=0 then

    -- Buscamos si se trata de algun mov. de bancos
    select max(consecutivo)
      into lref
      from movibanco
     where polizaid=ppolizaid;

     lref := coalesce(lref,0);

  end if;

  if lref=0 then
    select referencia
      into lref
      from polizas
     where polizaid=ppolizaid;
  end if;

return lref;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.referenciapoliza(integer) OWNER TO sistema;

--
-- Name: refmovimiento(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION refmovimiento(integer, integer) RETURNS character
    AS $_$
declare
  
  pprestamoid alias for $1;
  pinversionid alias for $2;

  sref char(30);

begin

  sref := '';

  if pprestamoid is not null then
    select referenciaprestamo
      into sref
      from prestamos
     where prestamoid=pprestamoid;
  else
    if pinversionid is not null then
      select 'Inversin '||to_char(fechainversion,'dd-mm-yyyy')
        into sref
        from inversion
       where inversionid=pinversionid;
    end if;
  end if;

return sref;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.refmovimiento(integer, integer) OWNER TO sistema;

--
-- Name: regimen(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION regimen(integer) RETURNS text
    AS $_$
declare
pregimen alias for $1;

ptexto text;

begin
  
  if pregimen=0 then
    ptexto := 'NO APLICA';
  end if;
  if pregimen=1 then
    ptexto := 'BIENES SEPARADOS';
  end if;
    if pregimen=2 then
    ptexto := 'BIENES MANCOMUNADOS';
  end if;
  
  return ptexto;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.regimen(integer) OWNER TO sistema;

--
-- Name: removecm(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION removecm(text) RETURNS text
    AS $_$
declare
  ptexto  alias for $1;

  i int4;
  j int4;
  stexto text;
  s char(1);
begin

  
  stexto:='';
  j:=length(ptexto);
  i:=1;

  loop
    s:=substr(ptexto,i,1);
    if ascii(s)>=32 and ascii(s)<=126 then
      stexto:=stexto||s;
    else
      stexto:=stexto||' ';
    end if;

    i:=i+1;
    if i>j then
      exit;
    end if;

  end loop;


return stexto;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.removecm(text) OWNER TO sistema;

--
-- Name: renum(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION renum() RETURNS integer
    AS $$
declare
  r record;

begin

  for r in
    select p.polizaid
  from movibanco m, polizas p
 where m.no_cuenta = '00815005848' and
       p.polizaid = m.polizaid and
       p.fechapoliza > '2005-05-01'
  loop
update polizas 
   set fechapoliza= '2005-04-26',
       periodo=4,
       numero_poliza = 
       (select max(x.numero_poliza)+1
          from polizas x
         where x.ejercicio=2005 and
               x.periodo=4 and
               x.tipo_poliza='E' )
 where polizaid=r.polizaid;
  end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.renum() OWNER TO sistema;

--
-- Name: renumera(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION renumera() RETURNS integer
    AS $$
declare
 r record;
 ppolizaid int4;
 psig int4;
begin

  for r in
select p.numero_poliza, p.tipo_poliza, p.ejercicio, p.periodo , count(*)
  from polizas p
group by p.numero_poliza, p.tipo_poliza, p.ejercicio, p.periodo
having count(p.numero_poliza)>1
order by p.ejercicio,p.periodo
  loop

    select max(polizaid)
      into ppolizaid
      from polizas
     where ejercicio=r.ejercicio and
           periodo=r.periodo and
           tipo_poliza=r.tipo_poliza and
           numero_poliza=r.numero_poliza;

    select max(numero_poliza)
      into psig
      from polizas
     where ejercicio=r.ejercicio and
           periodo=r.periodo and
           tipo_poliza=r.tipo_poliza;

    psig := coalesce(psig,0)+1;

    update polizas
       set numero_poliza = psig
     where polizaid=ppolizaid;

  end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.renumera() OWNER TO sistema;

--
-- Name: renumeracol(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION renumeracol() RETURNS integer
    AS $$
declare
  r record;
  i int4;
begin

  i:=0;
  for r in

select ciudadmexid,colonia
from domicilio
where colonia is not null and rtrim(colonia)<>''
group by ciudadmexid,colonia
order by ciudadmexid,colonia
  loop

insert into colonia(ciudadmexid,nombrecolonia) values (r.ciudadmexid,r.colonia);

  end loop;
return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.renumeracol() OWNER TO sistema;

--
-- Name: reporte1(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reporte1(date) RETURNS SETOF rreporte1
    AS $_$
declare  
  r rreporte1%rowtype;
  pfechac alias for $1;

  f record;

begin

    for r in

        select s.clavesocioint,substring(ltrim(su.paterno)||' '||ltrim(su.materno)||' '||ltrim(su.nombre),1,40),su.fecha_nacimiento,s.fechaalta,s.tiposocioid,s.socioid,(s.fechaalta-su.fecha_nacimiento)/365 as edad,s.estatussocio,
(case when si.personajuridicaid = 1 then 'Moral' else 'Fisica' end) as  tipopersona,
sum(sd.saldo) as saldohaberes,sum(sd.saldoprestamo) as saldodebes,sum(sd.parte) as saldoparte from socio s, sujeto  su, solicitudingreso si,

        (select mc.socioid, sum(mp.debe)-sum(mp.haber) as saldo,0 as parte, 0 as saldoprestamo,0 as prestamoid from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid not in ('00','IN','AP','CI','IV','IP') and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid  union 

        select mc.socioid,0 as saldo, sum(mp.debe)-sum(mp.haber) as parte,0 as saldoprestamo,0 as prestamoid from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and mc.tipomovimientoid='PA' and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid union

        select p.socioid,0 as saldo,0 as parte,p.montoprestamo-SUM(case when m.cuentaid=tp.cuentaactivo and po.fechapoliza<pfechac+1 then m.haber else 0 end) as saldoprestamo,p.prestamoid from prestamos p left join movicaja mc on p.prestamoid=mc.prestamoid left join polizas po on mc.polizaid = po.polizaid left join movipolizas m on po.polizaid=m.polizaid,tipoprestamo tp where p.fecha_otorga < pfechac+1 and p.claveestadocredito<>'008' and tp.tipoprestamoid = p.tipoprestamoid group by p.socioid,p.montoprestamo,p.prestamoid) sd

        where s.sujetoid=su.sujetoid and s.socioid=si.socioid and s.socioid=sd.socioid
        group by  s.clavesocioint,ltrim(su.paterno)||' '||ltrim(su.materno)||' '||ltrim(su.nombre),su.fecha_nacimiento,s.fechaalta,s.tiposocioid,s.socioid,s.fechaalta,su.fecha_nacimiento,s.estatussocio,si.personajuridicaid order by s.clavesocioint

        loop
                return next r;
        end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reporte1(date) OWNER TO sistema;

--
-- Name: reporte1c(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reporte1c(date) RETURNS SETOF rreporte1
    AS $_$
declare  
  r rreporte1%rowtype;
  pfechai alias for $1;
  f record;
  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||'; select * from reporte1('||''''||pfechai||''''||');';

        for r in
           select * from
           dblink(dblink1,dblink2) as
           t2( clavesocioint       char(15),
               nombre              varchar(80),
               fecha_nacimiento    date,
               fecha_ingreso       date,
               tiposocioid         char(2),
               socioid             int4,
               edad                int4,
               estatussocio	     int4,
               tipopersona         char(10),
               saldohaberes        numeric,
               saldodebes          numeric,
               saldoparte          numeric)

        loop
              return next r;
        end loop;

end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reporte1c(date) OWNER TO sistema;

--
-- Name: reporte4(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reporte4(date) RETURNS SETOF rreporte4
    AS $_$
declare  
  r rreporte4%rowtype;
  pfechai alias for $1;
--  pfechaf alias for $2;

-- contador numeric;

begin

    for r in
      select p.tipoprestamoid,f.desctipoprestamo,p.tasanormal, count(p.prestamoid) as sumaprestamos,sum(p.montoprestamo) as sumamonto,sum(saldofechacorte(p.prestamoid,pfechai)) as sumasaldo from prestamos p, tipoprestamo f  where p.fecha_otorga <=pfechai and f.tipoprestamoid= p.tipoprestamoid group by p.tipoprestamoid,f.desctipoprestamo, p.tasanormal order by p.tasanormal
    loop     
      return next r;
    end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reporte4(date) OWNER TO sistema;

--
-- Name: reporte4c(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reporte4c(date) RETURNS SETOF rreporte4
    AS $_$
declare  
  r rreporte4%rowtype;
  pfechai alias for $1;
--  pfechaf alias for $2;

-- contador numeric;

begin

 raise notice 'Conectando sucursal Etzatlan';
 -- Etzatlan
 for r in
   SELECT * FROM
        dblink('host=169.223.123.200 dbname=calero1 user=sistema',
               'set search_path to public,sucursal1;select tipoprestamoid,desctipoprestamo,tasanormal,sumaprestamos,sumamonto,sumasaldo from reporte4('||''''||pfechai||''''||');') as
               t2( tipoprestamoid      char(3),
 desctipoprestamo    varchar(30),
 tasanormal          numeric,
 sumaprestamos       int4,
 sumamonto           numeric,
 sumasaldo           numeric)

 loop
   return next r;
 end loop;

 raise notice 'Conectando sucursal Magdalena';
 -- Magdalena
 for r in
   SELECT * FROM
        dblink('host=169.223.123.211 dbname=calero2 user=sistema',
               'set search_path to public,sucursal2;select tipoprestamoid,desctipoprestamo,tasanormal,sumaprestamos,sumamonto,sumasaldo from reporte4('||''''||pfechai||''''||');') as
               t2( tipoprestamoid      char(3),
 desctipoprestamo    varchar(30),
 tasanormal          numeric,
 sumaprestamos       int4,
 sumamonto           numeric,
 sumasaldo           numeric)

 loop
   return next r;
 end loop;

 raise notice 'Conectando sucursal San Juanito';
 -- San Juanito
 for r in
   SELECT * FROM
        dblink('host=169.223.123.222 dbname=calero3 user=sistema',
               'set search_path to public,sucursal3;select tipoprestamoid,desctipoprestamo,tasanormal,sumaprestamos,sumamonto,sumasaldo from reporte4('||''''||pfechai||''''||');') as
               t2( tipoprestamoid      char(3),
 desctipoprestamo    varchar(30),
 tasanormal          numeric,
 sumaprestamos       int4,
 sumamonto           numeric,
 sumasaldo           numeric)

 loop
   return next r;
 end loop;

 raise notice 'Conectando sucursal Ixtlan';
 -- San Juanito
 for r in
   SELECT * FROM
        dblink('host=169.223.123.233 dbname=calero4 user=sistema',
               'set search_path to public,sucursal4;select tipoprestamoid,desctipoprestamo,tasanormal,sumaprestamos,sumamonto,sumasaldo from reporte4('||''''||pfechai||''''||');') as
               t2( tipoprestamoid      char(3),
 desctipoprestamo    varchar(30),
 tasanormal          numeric,
 sumaprestamos       int4,
 sumamonto           numeric,
 sumasaldo           numeric)

 loop
   return next r;
 end loop;

 raise notice 'Conectando sucursal tequila';
 -- San Juanito
 for r in
   SELECT * FROM
        dblink('host=169.223.123.244 dbname=calero5 user=sistema',
               'set search_path to public,sucursal5;select tipoprestamoid,desctipoprestamo,tasanormal,sumaprestamos,sumamonto,sumasaldo from reporte4('||''''||pfechai||''''||');') as
               t2( tipoprestamoid      char(3),
 desctipoprestamo    varchar(30),
 tasanormal          numeric,
 sumaprestamos       int4,
 sumamonto           numeric,
 sumasaldo           numeric)

 loop
   return next r;
 end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reporte4c(date) OWNER TO sistema;

--
-- Name: reporteburo(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reporteburo(date) RETURNS SETOF rformato
    AS $_$
declare

  pfecha alias for $1;
  r rformato%rowtype;

  i int;
begin

  i:=1;
  for r in
       select
       --1 clave
       1,
       --2 nombre 
       'Reporte de Buro',
       --3 fecha_reporte
       ''''||to_char(pfecha,'DDMMYYYY'),
       --4 paterno
       (case when su.paterno = null or su.paterno = ' ' or su.paterno = '' then 'NO PROPORCIONADO' else rtrim(su.paterno) end),
       --5 materno 
       (case when su.materno = null or su.materno = ' ' or su.materno = '' then 'NO PROPORCIONADO' else rtrim(su.materno) end),
       --6 adicional
       ' ',
       --7 primer_nombre
       rtrim(su.nombre),
       --8 segundo
       ' ',
       --9 fecha_nac
       ''''||to_char(su.fecha_nacimiento,'DDMMYYYY'),
       --10 rfc
       substring(rtrim(su.rfc),1,13),
       --11 prefijo
       ' ',
       --12 edo_civil
       (case when so.estadocivilid=0 then 'S' else (case when so.estadocivilid=1 then 'M' else (case when so.estadocivilid=2 then 'D' else (case when so.estadocivilid=3 then 'W' else 'F' end) end) end) end),
       --13 sexo
       (case when so.sexo=0 then 'M' else 'F' end),
       --14 f_dec
       null,
       --15 indic_def
       ' ',
       --16 calle_numero 
       rtrim(rtrim(d.calle)||' '||rtrim(d.numero_ext)),
       --17 segunda_linea
       ' ',
       --18 colonia
       rtrim(col.nombrecolonia),
       --19 municipio
       rtrim(d.comunidad),
       --20 ciudad
       rtrim(c.nombreciudadmex),
       --21 estado
       rtrim(e.abre_estado),
       --22 cp
       ''''||lpad(ltrim(to_char(col.cp,'99999')),5,'0'),
       --23 telefono
       (case when d.teldomicilio = ' ' or d.teldomicilio = '' or d.teldomicilio = null then '0' else d.teldomicilio end),
       --24 member
       ' ',
       --25 nombre_2
       'CAJA POPULAR FRAY JUAN CALERO, S.C. DE A.P. DE R.L. DE C.V.',
       --26 cuenta
       ''''||(select substring(sucid,1,3) from empresa where empresaid=1)||substring(p.referenciaprestamo,1,6)||substring(p.referenciaprestamo,8,10),
       --responsabilidad
       'I',
       --tipo_cta
       'I',
       --tipo_contrato
       'PL',
       --moneda
       'MX',
       --num_pagos
       p.numero_de_amor,
       --frec_pagos
       (case when p.meses_de_cobro=2 then 'B' else (case when p.meses_de_cobro=3 then 'Q' else 'M' end) end),       
       --33 importe_pago
       (case when 
       trunc(((interesdevengadomenoravencido+interesdevengadomayoravencido+interesdevmormenor+interesdevmormayor)*1.00)+importeultimaamort)<  trunc(pr.saldoprestamo+((interesdevengadomenoravencido+interesdevengadomayoravencido+interesdevmormenor+interesdevmormayor)*1.00)) then trunc(((interesdevengadomenoravencido+interesdevengadomayoravencido+interesdevmormenor+interesdevmormayor)*1.00)+importeultimaamort) else  trunc(pr.saldoprestamo+((interesdevengadomenoravencido+interesdevengadomayoravencido+interesdevmormenor+interesdevmormayor)*1.00)) end),             
       --34 apertura
       ''''||to_char(p.fecha_otorga,'DDMMYYYY'),
       --35 pago
       ''''||to_char(pr.fechaultamorpagada,'DDMMYYYY'),
       --36 compra
       ''''||to_char(p.fecha_otorga,'DDMMYYYY'),
       --37 cierre       
       (case when pr.saldoprestamo=0 then ''''||to_char(pfecha,'DDMMYYYY') else '''' end),
       --38 reporte
       ''''||to_char(pfecha,'DDMMYYYY'),
       --39 cred_maximo
       trunc(p.montoprestamo),
       --40 saldo_actual El saldo ms todos los intereses.
       trunc(pr.saldoprestamo+((interesdevengadomenoravencido+interesdevengadomayoravencido+interesdevmormenor+interesdevmormayor)*1.00)),
       --41 limite_credito
       trunc(p.montoprestamo),
       --42 saldo_vencido
       trunc(importevencidoamort),             
       --43 pagos_vencidos
       (case when pr.importevencidoamort=0 then 0 else pr.noamorvencidas end),
       --pr.noamorvencidas,
       --44 forma_pago_actual
       ''''||(case when pr.importevencidoamort=0 then '01' else (case when pr.diasvencidos >=1 and pr.diasvencidos <=29 then '02' else (case when pr.diasvencidos >29 and pr.diasvencidos <=59 then '03' else (case when pr.diasvencidos >59 and pr.diasvencidos <=89 then '04' else (case when pr.diasvencidos >89 and pr.diasvencidos <=119 then '05' else  (case when pr.diasvencidos >119 and pr.diasvencidos <=149 then '06' else (case when pr.diasvencidos >149 and pr.diasvencidos <=360 then '07' else (case when pr.diasvencidos >360 and pr.diasvencidos <=389 then '96' else '96' end) end) end)end) end) end) end) end),       
       ' ',
       ' ',
       ' ',
       ' '
       from precorte pr, prestamos p, socio s, solicitudingreso so, sujeto su, domicilio d, colonia col, ciudadesmex c, estadosmex e
       where pr.fechacierre = pfecha and pr.saldoprestamo >0 and
             p.prestamoid = pr.prestamoid and
             s.socioid = p.socioid and
             su.sujetoid=s.sujetoid and
             so.socioid=s.socioid and
             d.sujetoid=su.sujetoid and
             col.coloniaid=d.coloniaid and
             c.ciudadmexid=d.ciudadmexid and
             e.estadomexid=c.estadomexid 
  loop
    r.clave:=i;
    i:=i+1;
    return next r;
  end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reporteburo(date) OWNER TO sistema;

--
-- Name: reporteburoc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reporteburoc(date) RETURNS SETOF rformato
    AS $_$
declare

  pfecha alias for $1;
  r rformato%rowtype;

  f record;

  dblink1 text;
  dblink2 text;

  i int;
begin

i:=1;

for f in
 select * from sucursales where vigente='S'
 
  loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
        dblink2:='set search_path to public,'||f.esquema||';select * from  reporteburo('||''''||pfecha||''''||');';

        --raise notice '% % ', dblink1,dblink2;

      for r in
        SELECT * FROM
          dblink(dblink1,dblink2) as
          t2(clave integer,
	nombre text,
	fecha_reporte char(9),
	paterno character varying(20),
	materno character varying(20),
	adicional character varying(40),
	primer_nombre character varying(40),
	segundo character varying(40),
	fecha_nac character(9),
	rfc character(20),
	prefijo character varying(10),
	edo_civil character varying(8),
	sexo character(2),
	f_def date,
	indic_def character varying(2),
	calle_numero character varying(80),
	segunda_linea character varying(80),
	colonia character varying(100),
	municipio character varying(100),
	ciudad character varying(100),
	estado character varying(4),
	cp character varying(15),
	telefono character varying(20),
	member character varying(10),
	nombre_2 character varying(100),
	cuenta character varying(19),
	responsabilidad character varying(2),
	tipo_cta character varying(2),
	tipo_contrato character varying(3),
	moneda character varying(3),
	num_pagos integer,
	frec_pagos character varying(2),
	importe_pago numeric,
	apertura char(9),
	pago char(9),
	compra char(9),
	cierre char(9),
	reporte char(9),
	cred_maximo numeric,
	saldo_actual numeric,
	limite_credito numeric,
	saldo_vencido numeric,
	pagos_vencidos numeric,
	forma_pago_actual character varying(3),
	observacion character varying(80),
	member_ant character varying(10),
	nombre_ant character varying(30),
	numero_ant character varying(10))

        loop
          r.clave:=i;
          i:=i+1;
          return next r;
        end loop;
  
  end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reporteburoc(date) OWNER TO sistema;

--
-- Name: reporteide(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reporteide(date) RETURNS SETOF rreporteide
    AS $_$
declare  
  r rreporteide%rowtype;
  pfechac alias for $1;
  periodo integer;
  ejercicio integer;
begin
    periodo:=cast(date_part('month',pfechac) as int);
    ejercicio:=cast(date_part('year',pfechac) as int);
    for r in

        select 	substring((s.clavesocioint),1,4) as suc,
		s.clavesocioint,
		s.socioid,
		ltrim(su.paterno)||' '||ltrim(su.materno)||' '||ltrim(su.nombre),
		(case when si.personajuridicaid = 1 then 'Moral' else 'Fisica' end) as  tipopersona,
		su.rfc,
		su.curp,
		substr(ltrim(rtrim(d.calle))||' '||d.numero_ext,1,80) || ' ' || d.colonia || ' C.P.' || d.codpostal as domicilio,
		d.comunidad,
		sum(sd.saldo) as saldoide
	from 	socio s,
		sujeto  su,
		solicitudingreso si,
		domicilio d,
		(
		select  mc.socioid, sum(mp.debe)-sum(mp.haber) as saldo
		from 	movicaja mc, 
			movipolizas mp, 
			tipomovimiento tm, 
			polizas p 
		where 	mp.movipolizaid=mc.movipolizaid and 
			tm.tipomovimientoid=mc.tipomovimientoid and 
			mc.tipomovimientoid = 'ID' and 
			p.polizaid = mc.polizaid and 
			p.periodo = periodo and 
			p.ejercicio = ejercicio  
		group by mc.socioid 
		) sd
 	where 	s.sujetoid=su.sujetoid and 
		s.socioid=si.socioid and 
		s.socioid=sd.socioid and 
		su.sujetoid=d.sujetoid
	group by s.clavesocioint,ltrim(su.paterno)||' '||ltrim(su.materno)||' '||ltrim(su.nombre),
		su.fecha_nacimiento,
		s.fechaalta,
		s.tiposocioid,
		s.socioid,
		s.fechaalta,
		su.fecha_nacimiento,
		s.estatussocio,
		si.personajuridicaid,
		si.sexo,
		su.rfc,
		su.curp,
		d.calle,
		d.numero_ext,
		d.colonia,
		d.teldomicilio , 
		d.comunidad,
		d.codpostal
	order by s.clavesocioint

        loop
	  if( periodo > 06 ) then
	   	select sum(sumadepositosreporte)-15000 into r.importe from sumadepositosreporte('',pfechac,r.socioid);
	   else
		select sum(sumadepositosold)-15000 into r.importe from sumadepositosold('',pfechac,r.socioid);
  	   end if;
          return next r;
        end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reporteide(date) OWNER TO sistema;

--
-- Name: reporteidec(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reporteidec(date) RETURNS SETOF rreporteide
    AS $_$
declare
	r rreporteide%rowtype;
	pfechac alias for $1;
	f record;
  	dblink1 text;
  	dblink2 text;
begin
for f in
		select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||'; select * from reporteide('||''''||pfechac||''''||');';

        for r in
           select * from
           dblink(dblink1,dblink2) as
           t2(suc character(4),
		clavesocioint character(15),
		socioid integer,
		nombre character varying(80),
		tipopersona character(10),
		rfc character(15),
		curp character(20),
		domicilio character varying(80),
		comunidad character varying(80),
		saldoide numeric,	
		importe numeric)

        loop
              return next r;
        end loop;

end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.reporteidec(date) OWNER TO sistema;

--
-- Name: reporteseleccion(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reporteseleccion(date) RETURNS SETOF rreporteseleccion
    AS $_$
declare  
  r rreporteseleccion%rowtype;
  f record;
  pfechac alias for $1;
  psaldoprestamo1 numeric;
  psaldoprestamo2 numeric;
  psaldoprestamo3 numeric;
  psaldoprestamo4 numeric;
  psaldoprestamo5 numeric;
  psaldoprestamo6 numeric;
  psaldoprestamo7 numeric;
  psaldoprestamo8 numeric;
  psaldoprestamo9 numeric;
  psaldoprestamo10 numeric;
  psaldoprestamo11 numeric;
  pnumprestamos numeric;

begin

  for r in

        select s.socioid,s.clavesocioint,ltrim(su.paterno)||' '||ltrim(su.materno)||' '||ltrim(su.nombre),d.colonia,d.codpostal, substr(d.calle||' '||d.numero_ext,1,50) as direccion,d.teldomicilio as telefono, d.comunidad,
sum(sd.parte) as partesocial,sum(sd.cuenta) as cuentacorriente,sum(sd.ahorrosedesol) as ahorrosedesol, sum(sd.ahorroordinario) as ahorroordinario,sum(sd.plazofijo) as plazofijo,sum(sd.otros) as otrohaberes,sum(a1) as credifacil,sum(a2) as confianza, sum(a3) as credihogar, sum(a4) as automatico,sum(a5) as renovado, sum(a6) as ordinario, sum(a7) as  reestructurado, sum(a8) as  extraordinario, sum(a9) as  alapalabracint, sum(a10) as alapalabrasint,sum(a11) as otros, sum(a1)+sum(a2)+sum(a3)+sum(a4)+sum(a5)+sum(a6)+sum(a7)+sum(a8)+sum(a9)+sum(a10)+sum(a11) as totalprestamos, '  ' as tipoprestamo  from socio s, sujeto  su, domicilio d,

(select mc.socioid, sum(case when mc.tipomovimientoid= 'CU'
                    then mp.debe-mp.haber
                    else 0 end) as cuenta,
                    sum(case when mc.tipomovimientoid= 'PA'
                    then mp.debe-mp.haber
                    else 0 end) as parte,
                    sum(case when mc.tipomovimientoid= 'SE'
                    then mp.debe-mp.haber
                    else 0 end) as ahorrosedesol,
                    sum(case when mc.tipomovimientoid= 'AA'
                    then mp.debe-mp.haber
                    else 0 end) as ahorroordinario,
                    0 as plazofijo,
                    sum(case when mc.tipomovimientoid<> 'CU' and mc.tipomovimientoid<> 'PA' and mc.tipomovimientoid<> 'SE'  and mc.tipomovimientoid<> 'AA' and mc.tipomovimientoid<> 'IN'
                    then mp.debe-mp.haber
                    else 0 end) as otros,
                    0 as a1,0 as a2, 0 as a3,0 as a4, 0 as a5, 0 as a6, 0 as a7,0 as a8, 0 as a9,0 as a10, 0 as a11 from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p where mp.movipolizaid=mc.movipolizaid and tm.tipomovimientoid=mc.tipomovimientoid and p.polizaid = mc.polizaid and p.fechapoliza < pfechac+1 and tm.aplicasaldo='S' group by mc.socioid union

select mc.socioid, 0 as cuenta,0 as parte, 0 as ahorrosedesol,0 as ahorroordinario,sum(mp.haber)-sum(mp.debe) AS plazofijo,0 as otros,0 as a1,0 as a2, 0 as a3,0 as a4, 0 as a5, 0 as a6, 0 as a7,0 as a8, 0 as a9,0 as a10, 0 as a11 from movicaja mc, socio s, polizas p, movipolizas mp, inversion i, tipoinversion t where mc.inversionid is not null and s.socioid = mc.socioid and p.polizaid = mc.polizaid and p.fechapoliza<pfechac+1 and  i.inversionid = mc.inversionid and i.fechainversion<pfechac+1 and  t.tipoinversionid = i.tipoinversionid and  mp.polizaid =mc.polizaid and mp.cuentaid = t.cuentapasivo group by mc.socioid  having  sum(mp.haber)-sum(mp.debe)<>0  union 

select pr.socioid, 0 as cuenta,0 as parte, 0 as ahorrosedesol,0 as ahorroordinario, 0 as plazofijo, 0 as otros,
                sum(case when p.tipoprestamoid='A2'
                then p.saldoprestamo
                else 0 end) as a1,
                sum(case when p.tipoprestamoid='B2'
                then p.saldoprestamo
                else 0 end) as a2,
                sum(case when p.tipoprestamoid='C2'
                then p.saldoprestamo
                else 0 end) as a3,
                sum(case when p.tipoprestamoid='N2'
                then p.saldoprestamo
                else 0 end) as a4,
                sum(case when p.tipoprestamoid='R2'
                then p.saldoprestamo
                else 0 end) as a5,
                sum(case when p.tipoprestamoid='S2'
                then p.saldoprestamo
                else 0 end) as a6,
                sum(case when p.tipoprestamoid='T2'
                then p.saldoprestamo
                else 0 end) as a7,
                sum(case when p.tipoprestamoid='V2'
                then p.saldoprestamo
                else 0 end) as a8,
                sum(case when p.tipoprestamoid='X1'
                then p.saldoprestamo
                else 0 end) as a9,
                sum(case when p.tipoprestamoid='X2'
                then p.saldoprestamo
                else 0 end) as a10,
                sum(case when p.tipoprestamoid <>'A2'  and p.tipoprestamoid <>'B2' and p.tipoprestamoid <>'C2' and p.tipoprestamoid <>'N2' and p.tipoprestamoid <>'R2' and p.tipoprestamoid <>'S2' and p.tipoprestamoid <>'T2' and p.tipoprestamoid <>'V2' and p.tipoprestamoid <>'X1' and p.tipoprestamoid <>'X2'
                then p.saldoprestamo
                else 0 end) as a11 from precorte p, prestamos pr where p.fechacierre=pfechac and p.prestamoid=pr.prestamoid group by pr.socioid) sd

    where s.tiposocioid <> '01' and  s.sujetoid=su.sujetoid and su.sujetoid=d.sujetoid and s.socioid=sd.socioid

    group by  s.socioid,s.clavesocioint,ltrim(su.paterno)||' '||ltrim(su.materno)||' '||ltrim(su.nombre),d.colonia,d.codpostal,d.calle,d.numero_ext,d.teldomicilio, d.comunidad order by s.clavesocioint

    loop

          return next r;

   end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reporteseleccion(date) OWNER TO sistema;

--
-- Name: reppolizas(date, date, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION reppolizas(date, date, character, character, character) RETURNS SETOF treppolizas
    AS $_$
declare
  pfechai      alias for $1;
  pfechaf      alias for $2;
  ptipoi       alias for $3;
  ptipof       alias for $4;
  pserie       alias for $5;

  r treppolizas%rowtype;

  fdebe numeric;
  fhaber numeric;

begin

    fdebe := 0;
    fhaber := 0;

    for r in
      select p.polizaid, p.referencia, p.seriepoliza, p.tipo, p.numero_poliza,        
             p.ejercicio, p.periodo, p.fechapoliza, p.tipo_poliza, p.clase_poliza,         
             p.diario_agrupador, p.concepto_poliza, p.fecha_fin_aceptacion, 
             m.movipolizaid, m.cuentaid, m.referencia_mov, m.tipo_mov, m.debe, m.haber,                
             m.diario_mov, m.identific_descr, m.descripcion          
        from polizas p, movipolizas m
       where p.fechapoliza between pfechai and pfechaf and
             p.tipo_poliza>=ptipoi and p.tipo_poliza<=ptipof and
             (pserie=' ' or p.seriepoliza=pserie) and
             m.polizaid = p.polizaid
      order by p.polizaid
    loop

      fdebe := fdebe + r.debe;
      fhaber := fhaber + r.haber;
      return next r;
    end loop;

    r.debe := fdebe;
    r.haber := fhaber;
    return next r;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.reppolizas(date, date, character, character, character) OWNER TO sistema;

--
-- Name: resumencaptacion(date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION resumencaptacion(date, character) RETURNS SETOF tresumencaptacion
    AS $_$
declare

  r tresumencaptacion%rowtype;
  pfecha alias for $1;
  psucursal alias for $2;

  dfechai date;
  idiasanuales int;
  pdiafecha numeric;

begin

    select diasanualesinversion into idiasanuales
      from empresa where empresaid=1;

    -- Inicio de mes
    dfechai := pfecha - cast(extract(day from pfecha) as integer);
    raise notice 'Fecha inicio de mes %',dfechai;

---
---

    for r in

 select pfecha,psucursal,t.desctipoinversion,s.clavesocioint,
        su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
        mc.inversionid, i.fechainversion, i.fechavencimiento,
        i.tasainteresnormalinversion, t.plazo, SUM((case when mp.cuentaid=t.cuentapasivo
                 then mp.haber-mp.debe
                 else 0 end)) AS deposito,
        (case when i.fechavencimiento-pfecha>0
              then i.fechavencimiento-pfecha
              else 0 end),
        t.plazo as formapagorendimiento,
        0 as intdevmensual,
(( pfecha -
       COALESCE(MAX(case when mp.cuentaid=t.cuentaintinver
               then (case when p.fechapoliza<pfecha
                          then p.fechapoliza
                          else i.fechainversion end)
               else i.fechainversion end),i.fechainversion))*i.tasainteresnormalinversion/100/idiasanuales*SUM((case when mp.cuentaid=t.cuentapasivo
                 then mp.haber-mp.debe
                 else 0 end))) as intdevacumulado,
        0 as saldototal,
        0 as saldopromedio,COALESCE(MAX(case when mp.cuentaid=t.cuentaintinver
               then (case when p.fechapoliza<pfecha
                          then p.fechapoliza
                          else i.fechainversion end) else i.fechainversion end),i.fechainversion)
        ,mc.tipomovimientoid,tm.cuentadeposito,d.ciudadmexid,s.socioid,(select grupo from solicitudingreso where socioid=s.socioid) as grupo
   from movicaja mc, socio s, polizas p, movipolizas mp, inversion i, 
        tipoinversion t,sujeto su, domicilio d, tipomovimiento tm
  where mc.inversionid is not null and        
        s.socioid = mc.socioid and        
        p.polizaid = mc.polizaid and        
        p.fechapoliza<pfecha+1 and
        i.inversionid = mc.inversionid and
        i.fechainversion<pfecha+1 and

        t.tipoinversionid = i.tipoinversionid and
        mp.polizaid =mc.polizaid and
        su.sujetoid = s.sujetoid and
        d.sujetoid = su.sujetoid and 
        tm.tipomovimientoid = mc.tipomovimientoid

group by psucursal,t.desctipoinversion,s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno, mc.inversionid, i.fechainversion,i.fechavencimiento,i.tasainteresnormalinversion, t.plazo,i.fechapagoinversion,mc.tipomovimientoid,tm.cuentadeposito,d.ciudadmexid,s.socioid
having   SUM((case when mp.cuentaid=t.cuentapasivo
                 then mp.haber-mp.debe
                 else 0 end))>0 order by clavesocioint
    loop

      
      --
      -- Calcular devengamiento mensual
      --
      -- dfechai = primero del mes

      if r.fechainversion<=dfechai then

        if r.fechavencimiento>=pfecha then
          r.intdevmensual:=(pfecha-dfechai)*r.tasainteresnormalinversion/idiasanuales/100*r.deposito;
        else
          if r.fechavencimiento>dfechai-1 then
            r.intdevmensual:=(r.fechavencimiento-dfechai)*r.tasainteresnormalinversion/idiasanuales/100*r.deposito;
          else
            r.intdevmensual:=0;
          end if;         
        end if;

      else

        if r.fechavencimiento>=pfecha then
          r.intdevmensual:=(pfecha-r.fechainversion)*r.tasainteresnormalinversion/idiasanuales/100*r.deposito;

        else
          r.intdevmensual:=(r.fechavencimiento-r.fechainversion)*r.tasainteresnormalinversion/idiasanuales/100*r.deposito;

        end if;

      end if;

      if r.intdevmensual<0 then
        raise exception 'El interes mensual no puede ser negativo %',r.clavesocioint;
      end if;
      r.intdevmensual := round(r.intdevmensual,2);

      -- Calcular devengamiento acumulado
      -- desde el inicio de la inversion


      pdiafecha:=cast(extract(day from pfecha) as numeric);

      r.saldototal:=r.deposito+r.intdevacumulado;

     
      r.saldopromedio:=r.deposito+round((r.intdevmensual/pdiafecha)*((pdiafecha+1)/2),2);

     
      return next r;

    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.resumencaptacion(date, character) OWNER TO sistema;

--
-- Name: retencionide(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION retencionide(date, date) RETURNS integer
    AS $_$
declare
  pfecha1 alias for $1;
  pfecha2 alias for $2;

  r record;

  sserie_user char(2);

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  scuentacaja char(24);
  lmovicajaid int4;

  iperiodo1 int4;
  iano1 int4;
  iperiodo2 int4;
  iano2 int4;

  finteres numeric;

  gdiasanualesmov int4;

  stipomovimientoid char(2);

  scuentaide char(24);
  scuentaretiro char(24);

begin

  iperiodo1 := cast(date_part('month',pfecha2) as int);
  iano1 := cast(date_part('year',pfecha2) as int);
  iperiodo2 := cast(date_part('month',pfecha2) as int);
  iano2 := cast(date_part('year',pfecha2) as int);

  sserie_user := 'ZA';

      select coalesce(max(referenciacaja),0)
        into lreferenciacaja
        from movicaja
       where seriecaja = sserie_user;


  -- Proceso para el IDE
  for r in
    select * from rptdepositos(pfecha1,pfecha2,25000)
  loop
    -- Buscar el movimiento al que haremos la retencin de IDE
    select tipomovimientoid into stipomovimientoid
      from spssaldosmov(r.socioid)
     where tipomovimientoid in ('PA','AM','AF','AA','AI','AO','AP') and
           saldo>r.idecalculado limit 1;


    stipomovimientoid:=coalesce(stipomovimientoid,'');

    if stipomovimientoid='' then
      raise notice 'No tiene saldo el Socio %',r.clavesocioint;
    else

    select cuentaivamovimiento,cuentaretiro
      into scuentaide,scuentaretiro
      from tipomovimiento
     where tipomovimientoid = stipomovimientoid;

      --
      -- Dar de alta la poliza contable X
      --

      -- Encabezado de la poliza
      select *
        into ppolizaid
        from spipolizasfecha(preferencia,sserie_user,'X',pnumero_poliza,
                             iano2,
                             iperiodo2,
                             ' ',pfecha2,'D',' ',' ',
                             'Retencion de IDE '||stipomovimientoid,pfecha2);

      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,scuentaretiro,' ','C',r.idecalculado,0,' ',' ','IDE Retenido '||stipomovimientoid);

      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,scuentaide,' ','A',0,r.idecalculado,' ',' ','IDE Retenido '||stipomovimientoid);

      -- Realizar el movimiento de caja

      lreferenciacaja := lreferenciacaja+1;

      insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,
                estatusmovicaja,inversionid,formapagoid,efectivo,cheque,fechahora,origen,procesado,movimiento)
      values (r.socioid,stipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL,
             'TR',0,-r.idecalculado,current_timestamp,'S','S','R');

     end if;

  end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.retencionide(date, date) OWNER TO sistema;

--
-- Name: retencionide(date, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION retencionide(date, date, integer) RETURNS integer
    AS $_$
declare
  pfecha1 alias for $1;
  pfecha2 alias for $2;
  psocioid alias for $3;

  r record;

  sserie_user char(2);

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  scuentacaja char(24);
  lmovicajaid int4;

  iperiodo1 int4;
  iano1 int4;
  iperiodo2 int4;
  iano2 int4;

  finteres numeric;

  gdiasanualesmov int4;

  stipomovimientoid char(2);

  scuentaide char(24);
  scuentaretiro char(24);

begin

  iperiodo1 := cast(date_part('month',pfecha2) as int);
  iano1 := cast(date_part('year',pfecha2) as int);
  iperiodo2 := cast(date_part('month',pfecha2) as int);
  iano2 := cast(date_part('year',pfecha2) as int);

  sserie_user := 'ZA';

      select coalesce(max(referenciacaja),0)
        into lreferenciacaja
        from movicaja
       where seriecaja = sserie_user;


  -- Proceso para el IDE
  for r in
    select * from rptdepositos(pfecha1,pfecha2,25000) where socioid=psocioid
  loop
    -- Buscar el movimiento al que haremos la retencin de IDE
    select tipomovimientoid into stipomovimientoid
      from spssaldosmov(r.socioid)
     where tipomovimientoid in ('PA','AM','AF','AA','AI','AO','IN','AP') and
           saldo>r.idecalculado limit 1;
    

    select cuentaivamovimiento,cuentaretiro
      into scuentaide,scuentaretiro
      from tipomovimiento
     where tipomovimientoid = stipomovimientoid;

      --
      -- Dar de alta la poliza contable X
      --

      -- Encabezado de la poliza
      select * 
        into ppolizaid
        from spipolizasfecha(preferencia,sserie_user,'X',pnumero_poliza,
                             iano2,
                             iperiodo2,
                             ' ',pfecha2,'D',' ',' ',
                             'Retencion de IDE '||stipomovimientoid,pfecha2);

      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,scuentaretiro,' ','C',r.idecalculado,0,' ',' ','IDE Retenido '||stipomovimientoid);

      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,scuentaide,' ','A',0,r.idecalculado,' ',' ','IDE Retenido '||stipomovimientoid);

      -- Realizar el movimiento de caja

      lreferenciacaja := lreferenciacaja+1;   

      insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,
                estatusmovicaja,inversionid,formapagoid,efectivo,cheque,fechahora,origen,procesado,movimiento)
      values (r.socioid,stipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL,
             'TR',0,-r.idecalculado,current_timestamp,'S','S','R');



  end loop;




return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.retencionide(date, date, integer) OWNER TO sistema;

--
-- Name: retencionide(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION retencionide(integer) RETURNS numeric
    AS $_$
declare
 lmovicajaid alias for $1;

 fretencionide numeric;

begin

 select sum(mp.haber)
   into fretencionide
   from movicaja mc, movipolizas mp, tipomovimiento t
  where mc.movicajaid=lmovicajaid and
        mp.polizaid = mc.polizaid and
        t.tipomovimientoid= mc.tipomovimientoid and
        t.tipomovimientoid in ('PA','AM','AF','AA','AI','AO','IN','AP') and
        mp.cuentaid=t.cuentaivamovimiento;

 fretencionide:=coalesce(fretencionide,0.00);

return fretencionide;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.retencionide(integer) OWNER TO sistema;

--
-- Name: retiromov(character, date, numeric, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION retiromov(character, date, numeric, character, character, character) RETURNS integer
    AS $_$
declare
--
-- Parametros
--
  pclavesocioint alias for $1;
  pfecha alias for $2;
  psaldo alias for $3;
  ptipomovimientoid alias for $4;
  sserie_user alias for $5;
  scuentacaja alias for $6;

  scuentadeposito char(24);

  lsocioid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;
begin

--
-- **** OJO poner la serie y cuenta de caja correspondiente ****
--
--
-- Tomaremos el saldo como un retiro
--

-- Buscamos la cuenta de deposito y el socio

  select cuentaretiro into scuentadeposito
   from tipomovimiento where tipomovimientoid=ptipomovimientoid;

  select socioid into lsocioid
   from socio
  where clavesocioint = pclavesocioint;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',sserie_user,'A');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipoliza(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','Saldo Inicial',pfecha);

-- Detalle de la poliza


   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','A',0,psaldo,' ',' ','Movimiento del dia');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentadeposito,' ','C',psaldo,0,' ',' ','movimiento del dia');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

  select *
    into pmovicajaid
   from spimovicaja(lsocioid,ptipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL);

return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.retiromov(character, date, numeric, character, character, character) OWNER TO sistema;

--
-- Name: retiromovministrar(character, date, numeric, character, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION retiromovministrar(character, date, numeric, character, character, character, integer) RETURNS integer
    AS $_$
declare
--
-- Parametros
--
  pclavesocioint alias for $1;
  pfecha alias for $2;
  psaldo alias for $3;
  ptipomovimientoid alias for $4;
  sserie_user alias for $5;
  scuentacaja alias for $6;
  pprestamoid alias for $7;
  
  scuentadeposito char(24);
  
  lsocioid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;
begin

--
-- **** OJO poner la serie y cuenta de caja correspondiente ****
--
--
-- Tomaremos el saldo como un retiro
--

-- Buscamos la cuenta de deposito y el socio

  select cuentaretiro into scuentadeposito
   from tipomovimiento where tipomovimientoid=ptipomovimientoid;

  select socioid into lsocioid
   from socio
  where clavesocioint = pclavesocioint;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',sserie_user,'A');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','Saldo Inicial',pfecha);

-- Detalle de la poliza


   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','A',0,psaldo,' ',' ','Movimiento del dia');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentadeposito,' ','C',psaldo,0,' ',' ','movimiento del dia');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

  select *
    into pmovicajaid
   from spimovicajaministrar(lsocioid,ptipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL);

   insert into ministrar(tipomovimientoid,fechaministracion,monto,prestamoid,polizaid,movibancoid,referenciacaja,seriecaja)
   values(ptipomovimientoid,pfecha,psaldo,pprestamoid,ppolizaid,NULL,lreferenciacaja,sserie_user);
 
   
return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.retiromovministrar(character, date, numeric, character, character, character, integer) OWNER TO sistema;

--
-- Name: retiromovministrarrm(character, date, numeric, character, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION retiromovministrarrm(character, date, numeric, character, character, character, integer) RETURNS integer
    AS $_$
declare
--
-- Parametros
--
  pclavesocioint alias for $1;
  pfecha alias for $2;
  psaldo alias for $3;
  ptipomovimientoid alias for $4;
  sserie_user alias for $5;
  scuentacaja alias for $6;
  pprestamoid alias for $7;
  
  scuentadeposito char(24);

  lsocioid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;
begin

--
-- **** OJO poner la serie y cuenta de caja correspondiente ****
--
--
-- Tomaremos el saldo como un retiro
--
-- Buscamos la cuenta de deposito y el socio

  select cuentaactivo into scuentadeposito  
   from tipoprestamo where tipoprestamoid in (select tipoprestamoid from prestamos where prestamoid=pprestamoid);

  select socioid into lsocioid
   from socio
  where clavesocioint = pclavesocioint;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',sserie_user,'A');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','Saldo Inicial',pfecha);

-- Detalle de la poliza


   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','A',0,psaldo,' ',' ','Movimiento del dia');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentadeposito,' ','C',psaldo,0,' ',' ','movimiento del dia');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

  select *
    into pmovicajaid
   from spimovicajaministrar(lsocioid,ptipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,pprestamoid,'A',NULL);
   

   insert into ministrar(tipomovimientoid,fechaministracion,monto,prestamoid,polizaid,movibancoid,referenciacaja,seriecaja)
   values(ptipomovimientoid,pfecha,psaldo,pprestamoid,ppolizaid,NULL,lreferenciacaja,sserie_user);
      
   
return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.retiromovministrarrm(character, date, numeric, character, character, character, integer) OWNER TO sistema;

--
-- Name: retiromovseguro(character, date, numeric, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION retiromovseguro(character, date, numeric, character, character, character) RETURNS integer
    AS $_$
declare
--
-- Parametros
--
  pclavesocioint alias for $1;
  pfecha alias for $2;
  psaldo alias for $3;
  ptipomovimientoid alias for $4;
  sserie_user alias for $5;
  scuentacaja alias for $6;

  scuentadeposito char(24);

  lsocioid int4;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;
begin

--
-- **** OJO poner la serie y cuenta de caja correspondiente ****
--
--
-- Tomaremos el saldo como un retiro
--

-- Buscamos la cuenta de deposito y el socio

  select cuentaretiro into scuentadeposito
   from tipomovimiento where tipomovimientoid=ptipomovimientoid;

  select socioid into lsocioid
   from socio
  where clavesocioint = pclavesocioint;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',sserie_user,'A');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','Saldo Inicial',pfecha);

-- Detalle de la poliza


   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','A',0,psaldo,' ',' ','Movimiento del dia');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentadeposito,' ','C',psaldo,0,' ',' ','movimiento del dia');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

  select *
    into pmovicajaid
   from spimovicajaseguro(lsocioid,ptipomovimientoid,ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,NULL,'A',NULL);

return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.retiromovseguro(character, date, numeric, character, character, character) OWNER TO sistema;

--
-- Name: retpromedio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION retpromedio(integer) RETURNS numeric
    AS $_$ 
DECLARE

  lsocioid alias for $1;
  fpromedio numeric;
  dfechai date;
  dfechaf date;
  dias int4;

BEGIN

  fpromedio:=0;

  select min(p.fechapoliza) into dfechai from movicaja mc, polizas p where mc.socioid=lsocioid and mc.tipomovimientoid in (select tipomovimientoid from tipomovimiento where (aplicasaldo='S' and tasainteres >0) or tipomovimientoid='IN') and mc.polizaid=p.polizaid and p.tipo <> 'W' and p.fechapoliza < current_date ;
  
  select max(p.fechapoliza) into dfechaf from movicaja mc, polizas p where mc.socioid=lsocioid and mc.tipomovimientoid in (select tipomovimientoid from tipomovimiento where (aplicasaldo='S' and tasainteres >0) or tipomovimientoid='IN') and mc.polizaid=p.polizaid and p.tipo <> 'W' and p.fechapoliza < current_date ;

SELECT SUM(round((case when p.fechapoliza<dfechai then
             (mp.haber)*(dfechaf-dfechai) else 0 end),2)) +
       SUM(round(case when p.fechapoliza>dfechai-1 then
             (mp.haber)*(dfechaf-p.fechapoliza) else 0 end,2))
  INTO fpromedio
  FROM ( select ml.socioid, ml.tipomovimientoid, ml.polizaid,
                ml.referenciacaja, ml.seriecaja, ml.movipolizaid
           from movicaja ml
          where ml.socioid=lsocioid and
                ml.tipomovimientoid in (select tipomovimientoid from tipomovimiento where (aplicasaldo='S' and tasainteres >0) or tipomovimientoid='IN')
       GROUP BY ml.socioid, ml.tipomovimientoid, ml.polizaid,
                ml.referenciacaja, ml.seriecaja, ml.movipolizaid ) as m,
       polizas p, movipolizas mp, tipomovimiento t, socio s
 WHERE m.socioid=lsocioid and
       m.tipomovimientoid in (select tipomovimientoid from tipomovimiento where (aplicasaldo='S' and tasainteres >0) or tipomovimientoid='IN') and
       p.polizaid = m.polizaid and
       p.fechapoliza between '01-01-1900' and dfechaf and
       mp.polizaid = p.polizaid and
       mp.movipolizaid = m.movipolizaid and
       t.tipomovimientoid = m.tipomovimientoid and
       t.tasainteres > 0 and 
       s.socioid = m.socioid and 
       (s.estatussocio=1 or s.estatussocio=3 or fechabaja > dfechaf);  

  fpromedio:=coalesce(fpromedio,0);
  dias :=(dfechaf-dfechai);

  raise notice ' % % ',fpromedio,dias;

  if dias <> 0 then 
      RETURN round(fpromedio/(dfechaf-dfechai),2);
  else
      RETURN 0;
  end if;

END; 
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.retpromedio(integer) OWNER TO sistema;

--
-- Name: rmovibancos(character, character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rmovibancos(character, character, date, integer) RETURNS SETOF rptmovibanco
    AS $_$
declare
 pno_cuenta alias for $1;
 pserie alias for $2;
 pfechapoliza alias for $3;
 pmes alias for $4;
 r rptmovibanco%rowtype;

begin

  if pmes=0 then
  -- Regresar los movimientos del dia
    for r in
      select m.consecutivo,p.fechapoliza,m.referenciamovi,t.descritipomovibanco,
             substr(m.beneficiario,1,45),mp.debe,mp.haber, m.serie
        from movibanco m, polizas p, movipolizas mp, tipomovibanco t
       where m.no_cuenta = pno_cuenta and
             --m.serie = pserie and
             p.polizaid = m.polizaid and
             p.fechapoliza = pfechapoliza and
             mp.polizaid = m.polizaid and
             mp.movipolizaid = m.movipolizaid and
             t.tipomovibancoid = m.tipomovibancoid
    loop
      return next r;
    end loop;
  else
  -- Regresar los movimientos del mes actual
    for r in
      select m.consecutivo,p.fechapoliza,m.referenciamovi,t.descritipomovibanco,
             substr(m.beneficiario,45),mp.debe,mp.haber, m.serie
        from movibanco m, polizas p, movipolizas mp, tipomovibanco t
       where m.no_cuenta = pno_cuenta and
             --m.serie = pserie and
             p.polizaid = m.polizaid and
          cast(date_part('year',pfechapoliza) as int)=cast(date_part('year',CURRENT_DATE) as int) and
          cast(date_part('month',pfechapoliza) as int)=cast(date_part('month',CURRENT_DATE) as int) and
             mp.polizaid = m.polizaid and
             mp.movipolizaid = m.movipolizaid and
             t.tipomovibancoid = m.tipomovibancoid
    loop
      return next r;
    end loop;

  end if;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.rmovibancos(character, character, date, integer) OWNER TO sistema;

--
-- Name: rownum(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rownum(integer) RETURNS SETOF integer
    AS $_$
declare
  i int4;
BEGIN
  FOR i IN 1..$1
  LOOP
    RETURN NEXT i;
  END LOOP;
RETURN;
END;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.rownum(integer) OWNER TO sistema;

--
-- Name: rprestamos(character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rprestamos(character, character) RETURNS SETOF rptprestamo
    AS $_$
declare
 preferenciai alias for $1;
 preferenciaf alias for $2;
 r rptprestamo%rowtype;
 fMontoPrestamo numeric;
 fSaldoPrestamo numeric;
begin

 fMontoPrestamo := 0;
 fSaldoPrestamo := 0;
 for r in
   select p.referenciaprestamo,s.clavesocioint,p.montoprestamo,p.saldoprestamo,p.fecha_otorga,p.fecha_vencimiento,p.tasanormal,p.tasa_moratoria,e.descripcionedocredito, p.usuarioid
     from prestamos p, socio s, estados_credito e
    where s.socioid = p.socioid and
          p.referenciaprestamo between preferenciai and preferenciaf and
          p.claveestadocredito<>'008' and
          e.claveestadocredito=p.claveestadocredito
 loop
   fMontoPrestamo := fMontoPrestamo + r.monto_prestamo;
   fSaldoPrestamo := fSaldoPrestamo + r.saldo_prestamo;
   return next r;
 end loop;

 r.referenciaprestamo := 'TOTALES';
 r.clavesocioint := '  ';
 r.monto_prestamo := fMontoPrestamo;
 r.saldo_prestamo := fSaldoPrestamo;
 return next r;
 
return;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.rprestamos(character, character) OWNER TO sistema;

--
-- Name: rprestamossocio(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rprestamossocio(character) RETURNS SETOF rprestamossocio
    AS $_$
declare
 pclavesocioint alias for $1;
 r rprestamossocio%rowtype;
begin

 if pclavesocioint<>'' then
   for r in
     select p.referenciaprestamo,p.fecha_otorga,s.clavesocioint,p.montoprestamo,e.descripcionedocredito
       from prestamos p, socio s, estados_credito e
      where s.clavesocioint = pclavesocioint and
            p.socioid = s.socioid and
            e.claveestadocredito = p.claveestadocredito and
            p.saldoprestamo>0 and
            --p.claveestadocredito<>'002' and
            p.claveestadocredito<>'008'
   loop
     return next r;
   end loop;
 else
   for r in
     select p.referenciaprestamo,p.fecha_otorga,s.clavesocioint,p.montoprestamo,e.descripcionedocredito
       from prestamos p, socio s, estados_credito e
      where p.montoprestamo=p.saldoprestamo and
            p.fecha_otorga>CURRENT_DATE-90 and 
            p.socioid = s.socioid and
            e.claveestadocredito = p.claveestadocredito
   loop
     return next r;
   end loop;
 end if;

return;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.rprestamossocio(character) OWNER TO sistema;

--
-- Name: rptavisos(date, date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rptavisos(date, date, character, character) RETURNS SETOF rpavisos
    AS $_$
declare
  r rpavisos%rowtype;
  pfechai alias for $1;
  pfechaf alias for $2;
  psocioi alias for $3;
  psociof alias for $4;

  lmontoprestamo numeric;
  dfecha_1er_pago date;

  ax record;
  iaval int4;

begin

    for r in
      select s.clavesocioint,
             su.nombre||' '||su.paterno||' '||su.materno as nombre,
             d.teldomicilio,
             ta.descripciontipoaviso,
             p.montoprestamo,
             p.saldoprestamo,
             trunc (p.montoprestamo / p.numero_de_amor) as amortizacionprestamo,
             diasatrasocapital(p.prestamoid, a.fechaenvio) AS diasatrasoprestamo,
             a.fechaenvio,
             a.prestamoid,
             0 as capital,
             0 as interes,
             0 as moratorio,
             0 as iva,
             0 as amortvencidas,
             p.fechaultimopago,
             substr(rtrim(d.calle)||' '||rtrim(d.numero_ext)||' '||rtrim(d.colonia),1,60) as domicilio,
             ' ' as aval1,' ' as domaval1,
             ' ' as aval2,' ' as domaval2,
             p.tipoprestamoid
        from aviso a, tipoaviso ta, prestamos p, socio s, sujeto su, domicilio d
       where a.fechaenvio between pfechai and pfechaf and
             ta.tipoavisoid = a.tipoavisoid and
             p.prestamoid = a.prestamoid and
             s.socioid = p.socioid and
             s.clavesocioint>=psocioi and s.clavesocioint<=psociof and
             su.sujetoid = s.sujetoid and su.sujetoid = d.sujetoid
     order by ta.descripciontipoaviso,s.clavesocioint
    loop

    select capital,interes,moratorio,iva,trunc(capital/r.amortizacion)
      from spscalculopagod(r.prestamoid,r.fechaenvio)
      into r.capital,r.interes,r.moratorio,r.iva,r.amortvencidas;
    
      iaval:=0;     
      for ax in
        select a.avalid,
               rtrim(s.nombre)||' '||rtrim(s.paterno)||' '||rtrim(s.materno) as nombre,
               rtrim(d.calle)||' '||rtrim(d.numero_ext)||' '||rtrim(d.colonia) as domicilio
          from avales a, sujeto s, domicilio d
         where a.prestamoid=r.prestamoid and
               s.sujetoid=a.sujetoid and
               d.sujetoid =s.sujetoid
      loop
        if iaval=0 then
          r.aval1 := substr(ax.nombre,1,60);
          r.domaval1 := substr(ax.domicilio,1,60);
        end if;
        if iaval=1 then
          r.aval2 := substr(ax.nombre,1,60);
          r.domaval2 := substr(ax.domicilio,1,60);
          exit;
        end if;
        iaval:=iaval+1;
        
      end loop;

      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.rptavisos(date, date, character, character) OWNER TO sistema;

--
-- Name: rptdepositos(date, date, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rptdepositos(date, date, numeric) RETURNS SETOF rdepositos
    AS $_$
declare
  pfechai alias for $1;
  pfechaf alias for $2;
  pmonto  alias for $3;
  r rdepositos%rowtype;

  srfccaja varchar(20);
  snombrecaja varchar(80);
begin

  select rfccaja,nombrecaja into srfccaja, snombrecaja from empresa where empresaid=1;
 

    for r in
 select s.clavesocioint,
        su.paterno,su.materno,su.nombre,
        sum(m.efectivo),
        (sum(m.efectivo)-25000)*0.02,0,
        srfccaja,snombrecaja,su.rfc,
        sum(m.efectivo)-25000,0,0,s.socioid
  from movicaja m, socio s, sujeto su
 where m.fechahora between pfechai + interval '0 hours' and pfechaf + interval '23:59:59' and
       s.socioid = m.socioid and
       su.sujetoid = s.sujetoid and
       m.tipomovimientoid in ('PA','AM','AF','AA','AI','AO','IN','AP') and
       m.seriecaja<>'Z ' and m.movimiento='D' and seriecaja<>'ZA' and
       s.clavesocioint in ('001-05461-02',
                           '001-02657-02',
                           '001-02562-02',
                           '002-03515-02',
                           '003-01501-02',
                           '009-00994-02')
                           
 
group by s.clavesocioint,su.paterno,su.materno,su.nombre,s.socioid,su.rfc
having sum(m.efectivo)>=pmonto

   loop

     r.ideretenido := iderecaudado(r.socioid,pfechai,pfechaf);
     if r.ideretenido=0 then
       r.idexrecaudar := r.idecalculado;
     end if;
     return next r;
   end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.rptdepositos(date, date, numeric) OWNER TO sistema;

--
-- Name: rptfolioscancelados(date, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rptfolioscancelados(date, date, character) RETURNS SETOF rpfolioscancelados
    AS $_$
declare
  r rpfolioscancelados%rowtype;
  pfechai alias for $1;
  pfechaf alias for $2;
  pserie  alias for $3;

begin

    if pserie = '  ' then 
     for r in
       select mc.referenciacaja,mc.seriecaja,p.numero_poliza,mc.tipomovimientoid,s.clavesocioint,p.fechapoliza,p.concepto_poliza           
         from movicaja mc, socio s, polizas p
        where mc.estatusmovicaja='C' and mc.polizaid=p.polizaid and p.fechapoliza between pfechai and pfechaf and mc.socioid = s.socioid           
      order by mc.seriecaja, mc.referenciacaja
     loop      
       return next r;
     end loop;
    else 
      for r in
       select mc.referenciacaja,mc.seriecaja,p.numero_poliza,mc.tipomovimientoid,s.clavesocioint,p.fechapoliza,p.concepto_poliza           
         from movicaja mc, socio s, polizas p
        where mc.estatusmovicaja='C' and mc.seriecaja=pserie and mc.polizaid=p.polizaid and p.fechapoliza between pfechai and pfechaf and mc.socioid = s.socioid           
      order by mc.seriecaja, mc.referenciacaja
     loop      
       return next r;
     end loop;
    end if;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.rptfolioscancelados(date, date, character) OWNER TO sistema;

--
-- Name: rptpagosprocampo(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rptpagosprocampo(date, date) RETURNS SETOF rpagoprocampo
    AS $_$
declare

  pfechai     alias for $1;
  pfechaf     alias for $2;

  r rpagoprocampo%rowtype;

begin

    for r in
select p.referenciaprestamo,
       su.nombre||' '||su.paterno||' '||su.materno as nombre,
       p.montoprestamo, p.fechaultimopago
  from procampo p, sujeto su
 where p.saldoprestamo = 0 and
       p.fechaultimopago between pfechai and pfechaf and       
       su.sujetoid = p.sujetoid
order by p.referenciaprestamo       
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.rptpagosprocampo(date, date) OWNER TO sistema;

--
-- Name: rptpagosprocamponopagados(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION rptpagosprocamponopagados(date, date) RETURNS SETOF rpagoprocamponopagados
    AS $_$
declare

  pfechai     alias for $1;
  pfechaf     alias for $2;

  r rpagoprocamponopagados%rowtype;

begin

    for r in

SELECT referenciaprestamo,
       su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
       montoprestamo,
       saldoprestamo,
       fecha_vencimiento,
       fechaultimopago,
       fecha_otorga,
       (pfechaf-fecha_vencimiento) as dias,
       tasanormal,
       round(((((tasanormal/360)*(fecha_vencimiento-fecha_otorga))*montoprestamo)/100),2)  as interes_prestamo, 
       round(((((tasanormal/360)*(pfechaf-fecha_vencimiento))*montoprestamo)/100),2) as total_interes
from procampo pro, sujeto su 
where pro.sujetoid = su.sujetoid and pro.saldoprestamo = pro.montoprestamo and pro.fechaultimopago between pfechai and pfechaf and pro.montoprestamo<>0
order by pro.referenciaprestamo 
    
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.rptpagosprocamponopagados(date, date) OWNER TO sistema;

--
-- Name: saldaamortiza(character, numeric, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldaamortiza(character, numeric, date) RETURNS integer
    AS $_$
declare
  preferenciaprestamo alias for $1;
  pcapitalpagado alias for $2;
  pfechaultimopago alias for $3;

  fAbono numeric;
  fAplicar numeric;
  amor record;
  dnumamor int4;
  lprestamoid int4;
 
begin

  fAbono := round(pcapitalpagado,2);

--
-- Actualizar tabla de prestamos, disminuir el saldo del prestamo y
-- actualizar fecha de ultimo pago, importante ya que a partir de ahi calculamos
-- el interes normal
--

--
-- Buscamos cuentas contables para el tipo de prestamo
--
  select prestamoid into lprestamoid
    from prestamos
   where referenciaprestamo=preferenciaprestamo;   

  select count(amortizacionid) into dnumamor from amortizaciones where prestamoid = lprestamoid;

  update prestamos
     set saldoprestamo = montoprestamo - fAbono,
         fechaultimopago = pfechaultimopago, numero_de_amor=dnumamor
   where referenciaprestamo=preferenciaprestamo;


--
-- Actualizar tabla de amortizaciones
--
  update amortizaciones
           set abonopagado = 0,
               ultimoabono = fechadepago
         where prestamoid=lprestamoid;

  if fAbono>0 then
    for amor in
        select *
          from amortizaciones
         where prestamoid=lprestamoid
      order by fechadepago
    loop

      fAplicar := amor.importeamortizacion - amor.abonopagado;

      if fAbono>=fAplicar then
        update amortizaciones
           set abonopagado = importeamortizacion,
               ultimoabono = pfechaultimopago
         where amortizacionid=amor.amortizacionid;
         fAbono := fAbono - fAplicar;
      else
        if fAbono>0 then
          update amortizaciones
             set abonopagado = abonopagado+fAbono,
                 ultimoabono = pfechaultimopago
           where amortizacionid=amor.amortizacionid;
           fAbono := 0;
        end if;
      end if;
    end loop;
  end if;


return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.saldaamortiza(character, numeric, date) OWNER TO sistema;

--
-- Name: saldaprestamo(character, numeric, date, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldaprestamo(character, numeric, date, numeric) RETURNS integer
    AS $_$
declare
  preferenciaprestamo alias for $1;
  pcapitalpagado alias for $2;
  pfechaultimopago alias for $3;
  pmontoprestamo alias for $4;

  fAbono numeric;
  fAplicar numeric;
  fInteresPagado numeric;
  amor record;

  stipoprestamoid char(3);
  scuentaactivo char(24);
  scuentaintnormal char(24);

  lsocioid int4;
  lprestamoid int4;
 
--
-- Parametros del usuario
--
  sserie_user char(2);
  scuentacaja char(24);

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;
  pejercicio int4;
  pperiodo int4;
begin

  fAbono := round(pcapitalpagado,2);
  fInteresPagado := 0;

--
-- Actualizar tabla de prestamos, disminuir el saldo del prestamo y
-- actualizar fecha de ultimo pago, importante ya que a partir de ahi calculamos
-- el interes normal
--

  update prestamos
     set saldoprestamo = montoprestamo - fAbono,
         fechaultimopago = pfechaultimopago
   where referenciaprestamo=preferenciaprestamo;

--
-- Buscamos cuentas contables para el tipo de prestamo
--
  select tipoprestamoid,socioid,prestamoid into stipoprestamoid,lsocioid,lprestamoid
    from prestamos
   where referenciaprestamo=preferenciaprestamo;   
  
  select cuentaactivo,cuentaintnormal into scuentaactivo,scuentaintnormal
    from tipoprestamo
   where tipoprestamoid = stipoprestamoid;

  sserie_user := 'Z';
  scuentacaja := '800101';

  pejercicio:=cast(date_part('year',pfechaultimopago) as int4);
  pperiodo:=cast(date_part('month',pfechaultimopago) as int4);

--
-- Actualizar tabla de amortizaciones
--
  if fAbono>0 then
    for amor in
        select *
          from amortizaciones
         where prestamoid=lprestamoid
      order by fechadepago
    loop

      fAplicar := amor.importeamortizacion - amor.abonopagado;

      if fAbono>=fAplicar then
        update amortizaciones
           set abonopagado = importeamortizacion,
               ultimoabono = pfechaultimopago
         where amortizacionid=amor.amortizacionid;
         fAbono := fAbono - fAplicar;
      else
        if fAbono>0 then
          update amortizaciones
             set abonopagado = abonopagado+fAbono,
                 ultimoabono = pfechaultimopago
           where amortizacionid=amor.amortizacionid;
           fAbono := 0;
        end if;
      end if;
    end loop;
  end if;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(pejercicio,pperiodo,'D',sserie_user,'A');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'A',pnumero_poliza,2004,12,' ',pfechaultimopago,'D',' ',' ','Migracin Inicial',pfechaultimopago);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentaactivo,' ','C',pmontoprestamo,0,' ',' ','Caja Migracin Inicial');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentaactivo,' ','A',0,pcapitalpagado,' ',' ','Capital Migracin Inicial');

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentacaja,' ','A',0,pmontoprestamo-pcapitalpagado,' ',' ','Capital Migracin Inicial');

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

   select *
     into pmovicajaid
     from spimovicaja(lsocioid,'00',ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,lprestamoid,'A',NULL);


return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.saldaprestamo(character, numeric, date, numeric) OWNER TO sistema;

--
-- Name: saldocuenta(character, integer, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldocuenta(character, integer, integer, character) RETURNS numeric
    AS $_$
declare
  scuentaid alias for $1;
  iejercicio alias for $2;
  iperiodo alias for $3;
  sconsolida alias for $4;

  fvalor numeric;
begin

  if sconsolida='N' then
    select saldoinicialperiodo+cargosdelperiodo-abonosdelperiodo
      into fvalor
      from saldos
     where ejercicio=iejercicio and
           periodo=iperiodo and
           cuentaid=scuentaid;
  else
    select saldoinicialperiodo+cargosdelperiodo-abonosdelperiodo
      into fvalor
      from saldosc
     where ejercicio=iejercicio and
           periodo=iperiodo and
           cuentaid=scuentaid;
  end if;

  fvalor:=coalesce(fvalor,0.00);

return fvalor;

end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.saldocuenta(character, integer, integer, character) OWNER TO sistema;

--
-- Name: saldocuenta(character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldocuenta(character, integer, integer) RETURNS numeric
    AS $_$
declare
  scuentaid alias for $1;
  iejercicio alias for $2;
  iperiodo alias for $3;
  fvalor numeric;
begin

  select saldoinicialperiodo+cargosdelperiodo-abonosdelperiodo
    into fvalor
    from saldos
   where ejercicio=iejercicio and
         periodo=iperiodo and
         cuentaid=scuentaid;

return fvalor;

end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.saldocuenta(character, integer, integer) OWNER TO sistema;

--
-- Name: saldocuentac(character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldocuentac(character, integer, integer) RETURNS numeric
    AS $_$
declare
  scuentaid alias for $1;
  iejercicio alias for $2;
  iperiodo alias for $3;
  fvalor numeric;
begin

  select saldoinicialperiodo+cargosdelperiodo-abonosdelperiodo
    into fvalor
    from saldosc
   where ejercicio=iejercicio and
         periodo=iperiodo and
         cuentaid=scuentaid;

return fvalor;

end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.saldocuentac(character, integer, integer) OWNER TO sistema;

--
-- Name: saldodemov(integer, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldodemov(integer, character, date) RETURNS numeric
    AS $_$
declare
  psocioid alias for $1;
  ptipomovimientoid alias for $2;
  pfecha alias for $3;

  fsaldo numeric;
begin


  select sum(mp.debe)-sum(mp.haber)
    into fsaldo
    from movicaja mc, polizas p, movipolizas mp
   where mc.socioid=psocioid and
         p.polizaid = mc.polizaid and
         p.fechapoliza < pfecha+1 and
         mc.tipomovimientoid=ptipomovimientoid and
         mp.polizaid = p.polizaid and
         mp.movipolizaid=mc.movipolizaid;


   fsaldo:=coalesce(fsaldo,0);

return fsaldo;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.saldodemov(integer, character, date) OWNER TO sistema;

--
-- Name: saldodemovr(integer, character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldodemovr(integer, character, date, integer) RETURNS numeric
    AS $_$
declare
  psocioid alias for $1;
  ptipomovimientoid alias for $2;
  pfecha alias for $3;
  pprestamoid alias for $4;

  fsaldo numeric;

  ptm char(2);
begin

  if ptipomovimientoid='RG' then
    ptm:='DR';
  else
    ptm:=ptipomovimientoid;
  end if;
 
  select sum(mp.debe)-sum(mp.haber)
    into fsaldo
    from movicaja mc, polizas p, movipolizas mp
   where mc.socioid=psocioid  and
         p.polizaid = mc.polizaid and
         p.fechapoliza < pfecha+1 and
         mc.tipomovimientoid=ptm and
         mp.polizaid = p.polizaid and
         mp.movipolizaid=mc.movipolizaid;


   fsaldo:=coalesce(fsaldo,0);

return fsaldo;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.saldodemovr(integer, character, date, integer) OWNER TO sistema;

--
-- Name: saldofechacorte(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldofechacorte(integer, date) RETURNS numeric
    AS $_$
declare
  lprestamoid alias for $1;
       pfecha alias for $2;  

  fsaldofecha numeric;

begin

  fsaldofecha:=0;

  select pr.montoprestamo-sum(m.haber) 
    into fsaldofecha 
  from prestamos pr, tipoprestamo tp, movicaja mc, movipolizas m, polizas p
  where pr.prestamoid = lprestamoid and tp.tipoprestamoid = pr.tipoprestamoid and 
        mc.prestamoid = pr.prestamoid and p.polizaid = mc.polizaid and 
	p.fechapoliza<=pfecha and p.polizaid = m.polizaid and
        m.cuentaid = tp.cuentaactivo group by pr.montoprestamo;

return fsaldofecha;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.saldofechacorte(integer, date) OWNER TO sistema;

--
-- Name: saldoinicial(character, integer, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldoinicial(character, integer, integer, character) RETURNS numeric
    AS $_$
declare
  scuentaid alias for $1;
  iejercicio alias for $2;
  iperiodo alias for $3;
  sconsolida alias for $4;

  fvalor numeric;
begin

  if sconsolida='N' then
    select saldoinicialperiodo
      into fvalor
      from saldos
     where ejercicio=iejercicio and
           periodo=iperiodo and
           cuentaid=scuentaid;
  else
    select saldoinicialperiodo
      into fvalor
      from saldosc
     where ejercicio=iejercicio and
           periodo=iperiodo and
           cuentaid=scuentaid;
  end if;

  fvalor:=coalesce(fvalor,0.00);

return fvalor;

end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.saldoinicial(character, integer, integer, character) OWNER TO sistema;

--
-- Name: saldomensual(character, integer, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldomensual(character, integer, integer, character) RETURNS numeric
    AS $_$
declare
  scuentaid alias for $1;
  iejercicio alias for $2;
  iperiodo alias for $3;
  sconsolida alias for $4;

  fvalor numeric;
begin

  if sconsolida='N' then
    select cargosdelperiodo-abonosdelperiodo
      into fvalor
      from saldos
     where ejercicio=iejercicio and
           periodo=iperiodo and
           cuentaid=scuentaid;
  else
    select cargosdelperiodo-abonosdelperiodo
      into fvalor
      from saldosc
     where ejercicio=iejercicio and
           periodo=iperiodo and
           cuentaid=scuentaid;
  end if;

  fvalor:=coalesce(fvalor,0.00);

return fvalor;

end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.saldomensual(character, integer, integer, character) OWNER TO sistema;

--
-- Name: saldomov(integer, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldomov(integer, character, date) RETURNS numeric
    AS $_$
declare
  psocioid alias for $1;
  ptipomovimientoid alias for $2;
  pfecha alias for $3;

  fsaldo numeric;
  ftotalprestamo numeric;
  ftotalprestamos numeric;
  fmontoprestamo numeric;
  fmontoprestamos numeric;

  r record;

begin

  fsaldo:=0;
  if ptipomovimientoid<>'00' and ptipomovimientoid<>'IN' and
     ptipomovimientoid<>'PA' then

      select sum(mp.haber)-sum(mp.debe) into fsaldo
        from (SELECT movicaja.socioid, movicaja.tipomovimientoid, movicaja.polizaid,
                     movicaja.referenciacaja, movicaja.seriecaja
                FROM movicaja
               WHERE movicaja.socioid=psocioid and
                     movicaja.tipomovimientoid=ptipomovimientoid
            GROUP BY movicaja.socioid, movicaja.tipomovimientoid, movicaja.polizaid,
                     movicaja.referenciacaja, movicaja.seriecaja) mc,
             movipolizas mp, tipomovimiento tm, polizas p
       where mc.socioid=psocioid and
             mc.tipomovimientoid=ptipomovimientoid and
             tm.tipomovimientoid=ptipomovimientoid and
             mp.polizaid = mc.polizaid and
             (mp.cuentaid=tm.cuentadeposito or mp.cuentaid=tm.cuentaretiro) and
             p.polizaid = mp.polizaid and
             p.fechapoliza<=pfecha;
  end if;

  if ptipomovimientoid='IN' then

    select SUM((case when mp.cuentaid=t.cuentapasivo
                then mp.haber-mp.debe
                else 0 end)) into fsaldo
      from polizas p, movicaja m, movipolizas mp, inversion i, tipoinversion t
     where i.socioid=psocioid and
           i.fechainversion<=pfecha and
           m.inversionid = i.inversionid and
           p.polizaid = m.polizaid and
           p.fechapoliza <= pfecha and
           t.tipoinversionid = i.tipoinversionid and
           mp.polizaid = p.polizaid and
           t.tipoinversionid <> 'K3'          
    having SUM((case when mp.cuentaid=t.cuentapasivo
                then mp.haber-mp.debe
                else 0 end))>0 ;

  end if;

  if ptipomovimientoid='00' then

    fmontoprestamos:=0;
    fmontoprestamo:=0;

    for r in
      select * from prestamos where socioid=psocioid
    loop

      select p.montoprestamo-sum(m.haber)
        into fmontoprestamo
        from prestamos p, tipoprestamo tp, movicaja mc, movipolizas m
       where p.prestamoid=r.prestamoid and
             tp.tipoprestamoid = p.tipoprestamoid and
             mc.prestamoid = p.prestamoid and
             m.polizaid = mc.polizaid and
             m.cuentaid = tp.cuentaactivo
    group by p.montoprestamo;

      if not found then
        fmontoprestamos:=fmontoprestamos+r.montoprestamo;
      else
        fmontoprestamos:=fmontoprestamos+coalesce(fmontoprestamo,0);
      end if;
    end loop;

    fsaldo := fmontoprestamos;

  end if;


  if ptipomovimientoid='PA' then

      select sum(mp.debe)-sum(mp.haber) as saldo
        into fsaldo
        from movicaja mc, movipolizas mp, tipomovimiento tm
       where mc.socioid=psocioid and
             mp.movipolizaid=mc.movipolizaid and
             mc.tipomovimientoid='PA' and
             tm.tipomovimientoid=mc.tipomovimientoid and
             tm.aplicasaldo='S';

  end if;

return fsaldo;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.saldomov(integer, character, date) OWNER TO sistema;

--
-- Name: saldomovimiento(date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldomovimiento(date, character) RETURNS numeric
    AS $_$
declare
  r record;
  pfecha alias for $1;
  ptipomovimientoid alias for $2;
  fsaldo numeric;
begin

  fsaldo:=0.00;

  raise notice 'Conectando sucursal Buscando PA';
  for r in
select sum(s.saldo) as saldo from (
      select mc.socioid,sum(mp.debe)-sum(mp.haber) as saldo
        from movicaja mc, movipolizas mp, polizas p
       where mc.tipomovimientoid=ptipomovimientoid and
             mp.movipolizaid=mc.movipolizaid and
             p.polizaid = mc.polizaid and
             p.fechapoliza <=pfecha
      group by mc.socioid
      having sum(mp.debe)-sum(mp.haber)<1000) as s

  loop
     fsaldo:=fsaldo+coalesce(r.saldo,0.00);
  end loop;

return fsaldo;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.saldomovimiento(date, character) OWNER TO sistema;

--
-- Name: saldopromedio(integer, date, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldopromedio(integer, date, date, character) RETURNS numeric
    AS $_$ 
DECLARE

  lsocioid alias for $1;
  dfechai alias for $2;
  dfechaf alias for $3;
  stipomovimientoid alias for $4;
  fpromedio numeric;

BEGIN 
  fpromedio:=0;

SELECT SUM(round((case when p.fechapoliza<dfechai then
             (mp.haber-mp.debe)*(dfechaf-dfechai) else 0 end),2)) +
       SUM(round(case when p.fechapoliza>dfechai-1 then
             (mp.haber-mp.debe)*(dfechaf-p.fechapoliza) else 0 end,2))
  INTO fpromedio
  FROM ( select ml.socioid, ml.tipomovimientoid, ml.polizaid,
                ml.referenciacaja, ml.seriecaja
           from movicaja ml
          where ml.socioid=lsocioid and
                ml.tipomovimientoid=stipomovimientoid
       GROUP BY ml.socioid, ml.tipomovimientoid, ml.polizaid,
                ml.referenciacaja, ml.seriecaja ) as m,
       polizas p, movipolizas mp, tipomovimiento t, socio s
 WHERE m.socioid=lsocioid and
       m.tipomovimientoid=stipomovimientoid and
       p.polizaid = m.polizaid and
       p.fechapoliza between '01-01-1900' and dfechaf and
       mp.polizaid = p.polizaid and
       (mp.cuentaid = t.cuentadeposito or mp.cuentaid=t.cuentaretiro) and
       t.tipomovimientoid = m.tipomovimientoid and
       t.tasainteres > 0 and 
       s.socioid = m.socioid and 
       (s.estatussocio=1 or s.estatussocio=3 or fechabaja > dfechaf);  

  fpromedio:=coalesce(fpromedio,0);

RETURN round(fpromedio/(dfechaf-dfechai),2); 
END; 
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.saldopromedio(integer, date, date, character) OWNER TO sistema;

--
-- Name: saldopromedioprecorte(integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldopromedioprecorte(integer, integer, integer) RETURNS numeric
    AS $_$ 
DECLARE

  pprestamoid alias for $1;
  pejercicio alias for $2;
  pperiodo alias for $3;
  fpromedio numeric;
  periodoant integer;
  ejercicioant integer;
  saldoanterior numeric;
  saldoactual numeric;

BEGIN

  fpromedio:= 0;

  if pperiodo = 1 then

    periodoant := 12;
    ejercicioant := pejercicio-1;
  
  else

    periodoant := pperiodo-1;
    ejercicioant := pejercicio;

  end if;

  select saldoprestamo into saldoanterior from precorte where prestamoid=pprestamoid and ejercicio=ejercicioant and periodo=periodoant;
  saldoanterior:= coalesce(saldoanterior,0);
  
  select saldoprestamo into saldoactual from precorte where prestamoid=pprestamoid and ejercicio=pejercicio and periodo=pperiodo;
  saldoactual:= coalesce(saldoactual,0);


  if saldoanterior = 0 then 
     fpromedio:= saldoactual;
  else 
     fpromedio:= (saldoanterior+saldoactual)/2;
  end if;

  fpromedio:=coalesce(fpromedio,0);


RETURN fpromedio; 
END; 
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.saldopromedioprecorte(integer, integer, integer) OWNER TO sistema;

--
-- Name: saldosprestamos(date, date, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION saldosprestamos(date, date, character, character, character) RETURNS SETOF rsaldos
    AS $_$
declare

  pfechai     alias for $1;
  pfechaf     alias for $2;
  psocioi     alias for $3;
  psociof     alias for $4;
  pusuario    alias for $5;

  r rsaldos%rowtype;
  x rsaldos%rowtype;

  dfecha date;
  sdesctipoprestamo char(30);
  lmonto numeric;
  lsaldo numeric;

  tmonto numeric;
  tsaldo numeric;

  lgmonto numeric;
  lgsaldo numeric;

  j int4;
  t int4;
  i int4;

  sgrupo char(25);
begin

  j       :=0;
  t       :=0;
  i       :=0;
  lmonto  :=0;
  lsaldo  :=0;
  tmonto  :=0;
  tsaldo  :=0;
  lgmonto :=0;
  lgsaldo :=0;




  if pusuario <> '' then
    for r in
      select 0 as tipor,p.referenciaprestamo,s.clavesocioint,
             su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
             p.fecha_otorga,p.montoprestamo,p.saldoprestamo,
             tp.desctipoprestamo,tp.tipoprestamoid,substring(p.usuarioid,1,10)
        from prestamos p, socio s, sujeto su, tipoprestamo tp
       where p.fecha_otorga between pfechai and pfechaf and
             s.socioid = p.socioid and
             s.clavesocioint>=psocioi and s.clavesocioint<=psociof and
             su.sujetoid = s.sujetoid and
             tp.tipoprestamoid = p.tipoprestamoid and
             p.claveestadocredito<>'008' and p.usuarioid=pusuario
       order by p.fecha_otorga,p.tipoprestamoid,s.clavesocioint
    loop

    select si.grupo
      into sgrupo
      from solicitudingreso si, socio s
     where s.clavesocioint=r.clavesocioint and
           si.socioid=s.socioid;

    r.nombresocio:= sgrupo||'-'||substr(r.nombresocio,1,55);

    if t=0 then
      dfecha := r.fecha_otorga;
      sdesctipoprestamo := r.desctipoprestamo;
    else
      if r.desctipoprestamo<>sdesctipoprestamo or r.fecha_otorga<>dfecha then
        ----------------------------------
        -- Registro de subtotal por dia
        ----------------------------------
        x.tipor := 3;
        x.nombresocio := 'Sub-Total ...:'||to_char(i,'99,999');
        x.fecha_otorga := dfecha;
        x.montoprestamo := tmonto;
        x.saldoprestamo := tsaldo;
        tmonto:=0;
        tsaldo:=0;
        i:=0;
        sdesctipoprestamo := r.desctipoprestamo;
        return next x;

      end if;


      if r.fecha_otorga<>dfecha then
        ----------------------------------
        -- Registro de subtotal por dia
        ----------------------------------
        x.tipor := 1;
        x.nombresocio := 'Total por dia:'||to_char(j,'99,999');
        x.fecha_otorga := dfecha;
        x.montoprestamo := lmonto;
        x.saldoprestamo := lsaldo;
        lmonto:=0;
        lsaldo:=0;
        j:=0;
        dfecha := r.fecha_otorga;
        return next x;
      end if;


    end if;

    lmonto := lmonto + r.montoprestamo;
    lsaldo := lsaldo + r.saldoprestamo;
    tmonto := tmonto + r.montoprestamo;
    tsaldo := tsaldo + r.saldoprestamo;
    lgmonto := lgmonto + r.montoprestamo;
    lgsaldo := lgsaldo + r.saldoprestamo;
    j:=j+1;
    t:=t+1;
    i:=i+1;

    return next r;
   end loop;

else
  for r in
  select 0 as tipor,p.referenciaprestamo,s.clavesocioint,
             su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
             p.fecha_otorga,p.montoprestamo,p.saldoprestamo,
             tp.desctipoprestamo,p.tipoprestamoid,substring(p.usuarioid,1,10)
        from prestamos p, socio s, sujeto su, tipoprestamo tp
       where p.fecha_otorga between pfechai and pfechaf and
             s.socioid = p.socioid and
             s.clavesocioint>=psocioi and s.clavesocioint<=psociof and
             su.sujetoid = s.sujetoid and
             tp.tipoprestamoid = p.tipoprestamoid and
             p.claveestadocredito<>'008'
       order by p.fecha_otorga,p.tipoprestamoid,s.clavesocioint
 loop
    if t=0 then
      dfecha := r.fecha_otorga;
      sdesctipoprestamo := r.desctipoprestamo;
    else
      if r.desctipoprestamo<>sdesctipoprestamo or r.fecha_otorga<>dfecha then
        ----------------------------------
        -- Registro de subtotal por dia
        ----------------------------------
        x.tipor := 3;
        x.nombresocio := 'Sub-Total ...:'||to_char(i,'99,999');
        x.fecha_otorga := dfecha;
        x.montoprestamo := tmonto;
        x.saldoprestamo := tsaldo;
        tmonto:=0;
        tsaldo:=0;
        i:=0;
        sdesctipoprestamo := r.desctipoprestamo;
        return next x;

      end if;


      if r.fecha_otorga<>dfecha then
        ----------------------------------
        -- Registro de subtotal por dia
        ----------------------------------
        x.tipor := 1;
        x.nombresocio := 'Total por dia:'||to_char(j,'99,999');
        x.fecha_otorga := dfecha;
        x.montoprestamo := lmonto;
        x.saldoprestamo := lsaldo;
        lmonto:=0;
        lsaldo:=0;
        j:=0;
        dfecha := r.fecha_otorga;
        return next x;
      end if;


    end if;

    lmonto := lmonto + r.montoprestamo;
    lsaldo := lsaldo + r.saldoprestamo;
    tmonto := tmonto + r.montoprestamo;
    tsaldo := tsaldo + r.saldoprestamo;
    lgmonto := lgmonto + r.montoprestamo;
    lgsaldo := lgsaldo + r.saldoprestamo;
    j:=j+1;
    t:=t+1;
    i:=i+1;

    return next r;
  end loop;
end if;
   


  -----------------------------------
  -- Impresin subtotal ultimo tipo
  -----------------------------------
  x.tipor := 3;
  x.nombresocio := 'Sub-Total ...:'||to_char(i,'99,999');
  x.fecha_otorga := dfecha;
  x.montoprestamo := tmonto;
  x.saldoprestamo := tsaldo;
  return next x;


  -----------------------------------
  -- Impresin subtotal ultima fecha
  -----------------------------------
  x.tipor := 1;
  x.nombresocio := 'Total por dia:'||to_char(j,'99,999');
  x.fecha_otorga := dfecha;
  x.montoprestamo := lmonto;
  x.saldoprestamo := lsaldo;
  return next x;

  --------------------
  -- Totales globales
  --------------------
  x.tipor := 2;
  x.fecha_otorga := NULL;
  x.nombresocio := 'Total General:'||to_char(t,'99,999');
  x.montoprestamo := lgmonto;
  x.saldoprestamo := lgsaldo;
  return next x;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.saldosprestamos(date, date, character, character, character) OWNER TO sistema;

--
-- Name: scentralriesgo(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION scentralriesgo() RETURNS SETOF tcentralriesgo
    AS $$
declare

 snombreconyuge       varchar;
 spaternoconyugue     varchar;
 smaternoconyugue     varchar;
 srfcconyugue         varchar;
 scurpconyuge         varchar;
 sedadconyugue        numeric;
 sfechanaciconyugue   date;
 srazonsocialconyugue varchar;
 saval                varchar;

  
 r tcentralriesgo%rowtype;
 ar tavalriesgo%rowtype;

 i int4;

begin


for r in
  select e.nombrecaja, e.sucid, s.clavesocioint,
         (case when s.tiposocioid='01'
               then 'MENOR' 
               else  'MAYOR' end), 
         (case when si.personajuridicaid = 0
               then 'FISICA'
               else 'MORAL' end),
         su.rfc, su.curp, su.paterno, su.materno, su.nombre, su.fecha_nacimiento,
         (case when si.sexo=0
               then 'MASCULINO'
               else 'FEMININO' end),
        si.ocupacion, d.teldomicilio, d.calle, d.numero_ext, d.numero_int,
        c.nombrecolonia,d.codpostal, d.comunidad, ci.nombreciudadmex,
        es.nombreestadomex, p.referenciaprestamo, p.fecha_otorga,
        p.montoprestamo, tp.desctipoprestamo, ec.descripcionedocredito,
        p.fechaultimopago, p.saldoprestamo,
        to_char((select vencidas
                   from spscalculopago(p.prestamoid))/p.numero_de_amor,'9999999'),
        si.solicitudingresoid,p.prestamoid

  from empresa e, socio s, solicitudingreso si, sujeto su, domicilio d,
         colonia c, estadosmex es, ciudadesmex ci, prestamos p, tipoprestamo tp,
         finalidades f, estados_credito ec           

 where e.empresaid=1 and
       si.socioid = s.socioid and
       su.sujetoid = s.sujetoid and
       d.sujetoid = su.sujetoid and
       c.coloniaid = d.coloniaid and
       ci.ciudadmexid = d.ciudadmexid and
       es.estadomexid = ci.estadomexid and
       p.socioid = s.socioid and
       tp.tipoprestamoid = p.tipoprestamoid and
       f.clavefinalidad = p.clavefinalidad and
       ec.claveestadocredito = p.claveestadocredito
loop


   select su.nombre,su.paterno,su.materno,su.rfc,su.curp,
          su.edad,to_char(su.fecha_nacimiento,'dd-mm-yyyy'),su.razonsocial

     into snombreconyuge, spaternoconyugue,smaternoconyugue,srfcconyugue,scurpconyuge,
          sedadconyugue, sfechanaciconyugue,srazonsocialconyugue

     from solicitudingreso s, sujeto su
    where s.solicitudingresoid = r.solicitudingresoid and
          su.sujetoid = s.conyugeid and
          s.conyugeid is not null;

  r.nombreconyuge := coalesce(snombreconyuge,'');
  r.paternoconyugue := coalesce(spaternoconyugue,'');
  r.maternoconyugue := coalesce(smaternoconyugue,'');
  r.rfcconyugue := coalesce(srfcconyugue,'');
  r.curpconyuge := coalesce(scurpconyuge,'');
  r.edadconyugue := sedadconyugue;
  r.fechanaciconyugue := sfechanaciconyugue;
  r.razonsocialconyugue := coalesce(srazonsocialconyugue,'');



  i:=1;
  for ar in

   select a.prestamoid,su.paterno,su.materno,su.nombre,su.curp,su.rfc,d.calle,
          d.numero_ext,d.numero_int,co.nombrecolonia, d.codpostal
     from avales a,sujeto su,domicilio d,colonia co
     
    where a.prestamoid = r.prestamoid and
      a.sujetoid = su.sujetoid and
      d.sujetoid = su.sujetoid and
      co.coloniaid = d.coloniaid 
  loop
    if i=1 then
      r.nombre1 := ar.nombre;
      r.paterno1 := ar.paterno;
      r.materno1 := ar.materno;
      r.calle1 := ar.calle;
      r.numero_ext1 := ar.numero_ext;
      r.numero_int1 := ar.numero_int;
      r.nombrecolonia1 := ar.nombrecolonia;
      r.codpostal1 := ar.codpostal;
      r.curp1 := ar.curp;
      r.rfc1 := ar.rfc;
    end if;

    if i=2 then
      r.nombre2 := ar.nombre;
      r.paterno2 := ar.paterno;
      r.materno2 := ar.materno;
      r.calle2 := ar.calle;
      r.numero_ext2 := ar.numero_ext;
      r.numero_int2 := ar.numero_int;
      r.nombrecolonia2 := ar.nombrecolonia;
      r.codpostal2 := ar.codpostal;
      r.curp2 := ar.curp;
      r.rfc2 := ar.rfc;


    end if;

    if i=3 then
      r.nombre3 := ar.nombre;
      r.paterno3 := ar.paterno;
      r.materno3 := ar.materno;
      r.calle3 := ar.calle;
      r.numero_ext3 := ar.numero_ext;
      r.numero_int3 := ar.numero_int;
      r.nombrecolonia3 := ar.nombrecolonia;
      r.codpostal3 := ar.codpostal;
      r.curp3 := ar.curp;
      r.rfc3 := ar.rfc;

    end if;
    i:=i+1;
  end loop;




  return next r;
end loop;

return;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.scentralriesgo() OWNER TO sistema;

--
-- Name: separacartera(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION separacartera(date, date) RETURNS integer
    AS $_$
declare
  pfecha1 alias for $1;
  pfecha2 alias for $2;

  r record;
  r1 record;

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  scuentaid char(24);
  debehaber1 numeric;
  debehaber2 numeric;
  debehaber21 numeric;
  debehaber3 numeric;
  debehaber4 numeric;
  debehaber5 numeric;

  sserie_user char(2);

  bprimer bool;
  diniciadevengamiento date;

begin

  select iniciadevengamiento
    into diniciadevengamiento
    from empresa;

  if pfecha2=diniciadevengamiento then
    bprimer:=true;
  else
    bprimer:=false;
  end if;
  
  sserie_user := 'ZA';

-- 
-- Borrar poliza del mismo da, serie y tipo=V
--

  delete from movipolizas where polizaid in (select polizaid from polizas where seriepoliza=sserie_user and tipo='V' and fechapoliza=pfecha1);

  delete from polizas where seriepoliza=sserie_user and tipo='V' and fechapoliza=pfecha1;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha1) as int),cast(date_part('month',pfecha1) as int),'V',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'V',pnumero_poliza,cast(date_part('year',pfecha1) as int),cast(date_part('month',pfecha1) as int),' ',pfecha1,'D',' ',' ','Devenga Intereses',pfecha1);

  for r in

select p.tipoprestamoid,t.cuentaactivo,t.cuentaactivovencida,t.cuentaintdevnocobres,
       t.cuentaintnormalnocob,t.cuentaordeninteres,t.ordeninteresacreedor,
       t.cuentaintnormal,t.cuentaintmora,t.cuentaintnormalresvencida,
       t.cuentaintnormalvencida,t.cuentaintmoravencida,
       sum((case when p.diasvencidos <= t.diastraspasoavencida
                 then p.saldoprestamo else 0 end)) as A, 
       sum((case when p.diasvencidos > t.diastraspasoavencida
                 then p.saldoprestamo else 0 end)) as B, 
       sum((case when p.diasvencidos <= t.diastraspasoavencida
                 then p.interesdevengadomenoravencido else 0 end)) as C,
       sum((case when p.diasvencidos > t.diastraspasoavencida
                 then p.interesdevengadomenoravencido else 0 end)) as CC,
       sum((case when p.diasvencidos <= t.diastraspasoavencida
                 then p.interesdevengadomayoravencido else 0 end)) as D,
       sum((case when p.diasvencidos > t.diastraspasoavencida
                 then p.interesdevengadomayoravencido else 0 end)) as DD,       
       sum((case when p.diasvencidos > t.diastraspasoavencida
                 then p.pagointeresenperiodo else 0 end)) as interes,
       sum((case when p.diasvencidos > t.diastraspasoavencida
                 then p.pagomoratorioenperiodo else 0 end)) as moratorio
  from precorte p, tipoprestamo t
 where p.fechacierre = pfecha1 and
       t.tipoprestamoid = p.tipoprestamoid 
group by p.tipoprestamoid,t.cuentaactivo,t.cuentaactivovencida,t.cuentaintdevnocobres,
       t.cuentaintnormalnocob,t.cuentaordeninteres,t.ordeninteresacreedor,
       t.cuentaintnormal,t.cuentaintmora,t.cuentaintnormalresvencida,
       t.cuentaintnormalvencida,t.cuentaintmoravencida
  loop

    for r1 in
  select t.tipoprestamoid,
       sum((case when p.diasvencidos <= t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.saldoprestamo else 0 end)) as A1, 
       sum((case when p.diasvencidos > t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.saldoprestamo else 0 end)) as B1, 
       sum((case when p.diasvencidos <= t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.interesdevengadomenoravencido else 0 end)) as C1,
       sum((case when p.diasvencidos > t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.interesdevengadomenoravencido else 0 end)) as CC1,
       sum((case when p.diasvencidos <= t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.interesdevengadomayoravencido else 0 end)) as D1,
       sum((case when p.diasvencidos > t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.interesdevengadomayoravencido else 0 end)) as DD1,       
       sum((case when p.diasvencidos > t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.pagointeresenperiodo else 0 end)) as interes1,
       sum((case when p.diasvencidos > t.diastraspasoavencida and
                      p.fechacierre=pfecha2
                 then p.pagomoratorioenperiodo else 0 end)) as moratorio1
  from tipoprestamo t left join precorte p on t.tipoprestamoid=p.tipoprestamoid
 where t.tipoprestamoid=r.tipoprestamoid
group by t.tipoprestamoid  

    loop

      -- 1era Parte
      if bprimer then
        debehaber1 := r.b;
      else
        debehaber1 := r.b-r1.b1;
      end if;

      if debehaber1<>0 then
      if debehaber1>0 then
        scuentaid := r.cuentaactivovencida;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','C',debehaber1,0,' ',' ',
                             'Trasp. activo vig. a vencida');
        scuentaid := r.cuentaactivo;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,debehaber1,' ',' ',
                             'Disminuir la cartera vigente');
      else
        scuentaid := r.cuentaactivo;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','C',abs(debehaber1),0,' ',
                             ' ','Trasp. activo vig. a vencida');
        scuentaid := r.cuentaactivovencida;
        select *
          into pmovipolizaid
          from spimovipoliza(ppolizaid,scuentaid,' ','A',0,abs(debehaber1),' ',
                             ' ','Disminuir la cartera vigente');
      end if;
      end if;



    end loop;
  end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.separacartera(date, date) OWNER TO sistema;

--
-- Name: serverdate(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION serverdate(date) RETURNS integer
    AS $_$
declare
  pfecha alias for $1;
  pok int4;
begin

  if CURRENT_DATE=pfecha then
    pok := 1;
  else
    pok := 0;
  end if;

return pok;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.serverdate(date) OWNER TO sistema;

--
-- Name: sexo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sexo(integer) RETURNS text
    AS $_$
declare
psexo alias for $1;

ptexto text;

begin

  
  if psexo=0 then
    ptexto := 'MASCULINO    ';
  end if;
  if psexo=1 then
    ptexto := 'FEMENINO  ';
  end if;
    
  return ptexto;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sexo(integer) OWNER TO sistema;

--
-- Name: sobreprestamo(character, numeric, numeric, numeric, numeric, date, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sobreprestamo(character, numeric, numeric, numeric, numeric, date, character, character, character) RETURNS integer
    AS $_$
declare
  preferenciaprestamo alias for $1;
  pcapitalpagado      alias for $2;
  pinterespagado      alias for $3;
  pmoratoriopagado    alias for $4;
  pivapagado          alias for $5;
  pfechaultimopago    alias for $6;
  psobreprestamo      alias for $7;
  sserie_user         alias for $8;
  scuentacaja         alias for $9;

  fAbono numeric;
  fAplicar numeric;
  fInteresPagado numeric;
  amor record;

  stipoprestamoid  char(3);
  scuentaactivo    char(24);
  scuentaintnormal char(24);
  scuentaintmora   char(24);
  scuentaiva       char(24);

  stipoprestamoid2  char(3);
  scuentaactivo2    char(24);

  lsocioid int4;
  lprestamoid int4;
  lprestamoid2 int4;

--
-- Parametros del usuario
--

  ppolizaid int4;
  pmovipolizaid int4;
  pnumero_poliza int4;
  preferencia int4;

  lreferenciacaja int4;

  pmovipolizaid2 int4;
  pmovicajaid int4;

  pfecha date;

  psaldoactual numeric;
begin

  pfecha := pfechaultimopago;

  fAbono := round(pcapitalpagado,2);
  fInteresPagado := 0;

--
-- Actualizar tabla de prestamos, disminuir el saldo del prestamo y
-- actualizar fecha de ultimo pago, importante ya que a partir de ahi calculamos
-- el interes normal
--
  select saldoprestamo
    into psaldoactual
    from prestamos
   where referenciaprestamo = preferenciaprestamo;

  if psaldoactual=fAbono then

    update prestamos
       set saldoprestamo = saldoprestamo - fAbono,
           fechaultimopago = pfechaultimopago,
           claveestadocredito = '002'
     where referenciaprestamo = preferenciaprestamo;
  else
    raise exception 'La cantidad con que se quiere cubrir el prestamo difiere: Saldo= % Abono= %',psaldoactual,fAbono;
  end if;

--
-- Buscamos cuentas contables para el tipo de prestamo anterior
--
  select tipoprestamoid,socioid,prestamoid into stipoprestamoid,lsocioid,lprestamoid
    from prestamos
   where referenciaprestamo=preferenciaprestamo;   
  
  select cuentaactivo,cuentaintnormal,cuentaiva,cuentaintmora
    into scuentaactivo,scuentaintnormal,scuentaiva,scuentaintmora
    from tipoprestamo
   where tipoprestamoid = stipoprestamoid;

  select tipoprestamoid,socioid,prestamoid into stipoprestamoid2,lprestamoid2
    from prestamos
   where referenciaprestamo=psobreprestamo;   
  
  select cuentaactivo into scuentaactivo2
    from tipoprestamo
   where tipoprestamoid = stipoprestamoid2;

--
-- Actualizar tabla de amortizaciones del prestamo anterior
--
  if fAbono>0 then
    for amor in
        select *
          from amortizaciones
         where prestamoid=lprestamoid
      order by fechadepago
    loop

      fAplicar := amor.importeamortizacion - amor.abonopagado;

      if fAbono>=fAplicar then
        update amortizaciones
           set abonopagado = importeamortizacion,
               ultimoabono = pfechaultimopago
         where amortizacionid=amor.amortizacionid;
         fAbono := fAbono - fAplicar;
      else
        if fAbono>0 then
          update amortizaciones
             set abonopagado = abonopagado+fAbono,
                 ultimoabono = pfechaultimopago
           where amortizacionid=amor.amortizacionid;
           fAbono := 0;
        end if;
      end if;
    end loop;
  end if;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'A',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipoliza(preferencia,sserie_user,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfechaultimopago,'D',' ',' ','Sobre-Prestamo',pfechaultimopago);

-- Detalle de la poliza

   select *
     into pmovipolizaid
     from spimovipoliza(ppolizaid,scuentacaja,' ','C',pcapitalpagado+pinterespagado+pmoratoriopagado+pivapagado,0,' ',' ','Pago de '||preferenciaprestamo);

   select *
     into pmovipolizaid2
     from spimovipoliza(ppolizaid,scuentaactivo,' ','A',0,pcapitalpagado,' ',' ','Capital '||preferenciaprestamo);

   if pinterespagado>0 then
     select *
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaintnormal,' ','A',0,pinterespagado,' ',' ','Interes '||preferenciaprestamo);
   end if;

   if pmoratoriopagado>0 then
     select *
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaintmora,' ','A',0,pmoratoriopagado,' ',' ','Moratorio '||preferenciaprestamo);
   end if;

   if pivapagado>0 then
     select *
       into pmovipolizaid2
       from spimovipoliza(ppolizaid,scuentaiva,' ','A',0,pivapagado,' ',' ','IVA '||preferenciaprestamo);
   end if;


   -- Movimiento de caja

   select coalesce(max(referenciacaja),0)
     into lreferenciacaja
     from movicaja
    where seriecaja = sserie_user;

  lreferenciacaja := lreferenciacaja+1;   

   select *
     into pmovicajaid
     from spimovicaja(lsocioid,'00',ppolizaid,lreferenciacaja,sserie_user,pmovipolizaid,lprestamoid,'A',NULL);

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sobreprestamo(character, numeric, numeric, numeric, numeric, date, character, character, character) OWNER TO sistema;

--
-- Name: socioestatus(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION socioestatus(integer) RETURNS integer
    AS $_$
declare
  lsolicitudingresoid alias for $1;
  iestatus int4;
begin

  select estatussocio
    into iestatus
    from socio
   where solicitudingresoid=lsolicitudingresoid;

  iestatus:=coalesce(iestatus,iestatus,0);

return iestatus;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.socioestatus(integer) OWNER TO sistema;

--
-- Name: solicitudesp(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION solicitudesp() RETURNS SETOF tsociocaja
    AS $$
declare
  r tsociocaja%rowtype;

begin

    for r in
      select p.nosolicitud,s.clavesocioint,j.paterno,j.materno,j.nombre,
             tp.descritiposocio as estatus
        from solicitudprestamo p, socio s, sujeto j, tiposocio tp
       where s.socioid = p.socioid and
             j.sujetoid = s.sujetoid and
             tp.tiposocioid = s.tiposocioid
      order by p.nosolicitud
    loop
      return next r;
    end loop;

return;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.solicitudesp() OWNER TO sistema;

--
-- Name: solicitudespf(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION solicitudespf(text) RETURNS SETOF tsociocaja
    AS $_$
declare
  pfiltro alias for $1; 
  r tsociocaja%rowtype;
  filtro text;
begin

    filtro := pfiltro || '%';
    for r in
      select p.nosolicitud,s.clavesocioint,j.paterno,j.materno,j.nombre,
             tp.descritiposocio as estatus
        from solicitudprestamo p, socio s, sujeto j,tiposocio tp
       where s.socioid = p.socioid and
             j.sujetoid = s.sujetoid and         
             (s.clavesocioint like filtro or
              (j.nombre||' '||j.paterno||' '||j.materno) like filtro or
              (j.paterno||' '||j.materno||' '||j.nombre) like filtro) and
             tp.tiposocioid = s.tiposocioid              
      order by p.nosolicitud
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.solicitudespf(text) OWNER TO sistema;

--
-- Name: spabonointeres(integer, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spabonointeres(integer, numeric, numeric) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;
  pabono alias for $2;
  pmoratorio alias for $3;

  fAbono numeric;
  fAplicar numeric;
  amor record;
  finterescalculado numeric;
  

begin

  fAbono := round(pabono,2);
  select interes into finterescalculado from spscalculopago(pprestamoid);
--
-- Actualizar tabla de amortizaciones
--

  if fAbono>0 then
    for amor in
        select *
          from amortizaciones
         where prestamoid=pprestamoid and interesnormal-interespagado>0
      order by fechadepago
    loop

      fAplicar := amor.interesnormal - amor.interespagado;

      raise notice ' Abonando interes %',fAplicar;
      if fAbono>=fAplicar then
        update amortizaciones
           set interespagado = interesnormal,
               ultimoabono = now()
         where amortizacionid=amor.amortizacionid;

         fAbono := fAbono - fAplicar;
      else
        if fAbono>0 then
           if finterescalculado = pabono then
              update amortizaciones set interesnormal = interespagado+fAbono where amortizacionid=amor.amortizacionid;
           end if;
           update amortizaciones set interespagado = interespagado+fAbono,ultimoabono = now(),moratoriopagado=pmoratorio 
           where amortizacionid=amor.amortizacionid;
           fAbono := 0;
        end if;
      end if;
    end loop;
  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spabonointeres(integer, numeric, numeric) OWNER TO sistema;

--
-- Name: spabonoprestamo(integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spabonoprestamo(integer, numeric) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;
  pabono alias for $2;

  fAbono numeric;
  fAplicar numeric;
  amor record;

  lsaldoprestamo numeric;

  finteres numeric;
  fintpag numeric;
  
begin

  fAbono := round(pabono,2);

--
-- Actualizar tabla de prestamos, disminuir el saldo del prestamo y
-- actualizar fecha de ultimo pago, importante ya que a partir de ahi calculamos
-- el interes normal
--

  update prestamos
     set saldoprestamo = saldoprestamo - fAbono,
         fechaultimopago = now()
   where prestamoid=pprestamoid;

  select saldoprestamo into lsaldoprestamo
   from prestamos where prestamoid=pprestamoid;

  if lsaldoprestamo<0 then
     raise exception 'El abono es mayor al saldo del prestamo';
  end if;

  if lsaldoprestamo=0 then
    -- Cambiar estatus a pagado
    update prestamos
     set claveestadocredito='002'
   where prestamoid=pprestamoid;
  end if;


--
-- Actualizar tabla de amortizaciones
--
  if fAbono>0 then
    for amor in
        select *
          from amortizaciones
         where prestamoid=pprestamoid and importeamortizacion-abonopagado>0
      order by fechadepago
    loop

      fAplicar := amor.importeamortizacion - amor.abonopagado;

      if fAbono>=fAplicar then
        update amortizaciones
           set abonopagado = importeamortizacion,
               ultimoabono = now()
         where amortizacionid=amor.amortizacionid;
         fAbono := fAbono - fAplicar;
      else
        if fAbono>0 then
          update amortizaciones
             set abonopagado = abonopagado+fAbono,
                 ultimoabono = now()
           where amortizacionid=amor.amortizacionid;
           fAbono := 0;
        end if;
      end if;
    end loop;
  end if;


return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spabonoprestamo(integer, numeric) OWNER TO sistema;

--
-- Name: spamortizacionesxgrupo(date, date, character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spamortizacionesxgrupo(date, date, character, character, date) RETURNS SETOF ramortizacionesxgrupo
    AS $_$
declare

  pfechai alias for $1;
  pfechaf alias for $2;
  pgrupo1 alias for $3;
  pgrupo2 alias for $4;
  pfechacal alias for $5;
  
  r ramortizacionesxgrupo;
 
begin

  for r in  
     select si.grupo,p.referenciaprestamo,a.numamortizacion,a.fechadepago,a.importeamortizacion,a.interesnormal,a.iva,a.totalpago,p.prestamoid,s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombresocio,0 as vencapital,0 as veninteres, 0 as venmoratorio, 0 as veniva,0 as ventotal from amortizaciones a, prestamos p, solicitudingreso si,socio s,sujeto su where (a.importeamortizacion > a.abonopagado ) and a.fechadepago >= pfechai and a.fechadepago <= pfechaf and a.prestamoid=p.prestamoid and p.socioid=si.socioid and si.grupo >= pgrupo1 and si.grupo<=pgrupo2 and p.socioid=s.socioid and s.sujetoid=su.sujetoid order by si.grupo

  loop

     select capital,interes,moratorio,iva,capital+interes+moratorio+iva into r.vencapital,r.veninteres,r.venmoratorio,r.veniva,r.ventotal from spscalculopagocartera(r.prestamoid,pfechacal);

     return next r;
     
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spamortizacionesxgrupo(date, date, character, character, date) OWNER TO sistema;

--
-- Name: spautorizabonificacion(numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spautorizabonificacion(numeric) RETURNS SETOF rautorizabonifica
    AS $_$
declare
  pautorizacionid alias for $1;

  r rautorizabonifica%rowtype;

  iautorizacionid integer;
  
begin


iautorizacionid:=trunc(pautorizacionid);

select inormal,imoratorio,cobranza,seguro,comision,ahorro into r.inormal,r.imoratorio,r.cobranza,r.seguro,r.comision,r.ahorro from autorizabonificacion where autorizacionid=iautorizacionid and movicajaid=0 and aplicado =0;

r.inormal:=coalesce(r.inormal,0);
r.imoratorio:=coalesce(r.imoratorio,0);
r.cobranza:=coalesce(r.cobranza,0);
r.seguro:=coalesce(r.seguro,0);
r.comision:=coalesce(r.comision,0);
r.ahorro:=coalesce(r.ahorro,0);

r.totalbonificacion:=r.inormal+r.imoratorio+r.cobranza+r.seguro+r.comision+r.ahorro;

return next r;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spautorizabonificacion(numeric) OWNER TO sistema;

--
-- Name: spcancelamovimiento(character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spcancelamovimiento(character, integer) RETURNS integer
    AS $_$
declare
  pseriecaja alias for $1;
  preferenciacaja alias for $2;

  icancelo int4;
  lpolizaid int4;
  dfechapoliza date;

  r record;

  ppermiso char(1);


begin

   select p.permiso
     into ppermiso
     from parametros pa, permisosmodulos p
    where pa.serie_user = pseriecaja and
          p.usuarioid = pa.usuarioid and
          p.clavemodulo = 'POLANT';

   ppermiso := coalesce(ppermiso,'N');

    select m.polizaid,p.fechapoliza
      into lpolizaid,dfechapoliza
      from movicaja m, polizas p
     where m.seriecaja=pseriecaja and
           m.referenciacaja=preferenciacaja and
           p.polizaid=m.polizaid;  

  if FOUND then
    if dfechapoliza<>CURRENT_DATE then
      -- DESCOMENTAR EL RAISE SI SE QUIERE VALIDACION
      if ppermiso='N' then
        raise exception 'No se permite cancelar movimientos de dias anteriores.';
      end if;
    end if;

   -- Cancelar cada movimiento realizado en el folio

   for r in
    select m.polizaid,p.fechapoliza
      from movicaja m, polizas p
     where m.seriecaja=pseriecaja and
           m.referenciacaja=preferenciacaja and
           p.polizaid=m.polizaid and
           p.fechapoliza=dfechapoliza          
   loop

    select cancelapoliza(r.polizaid)
      into icancelo;

   end loop;

   update sabana
      set cantidad=0,valor=0
    where seriecaja=pseriecaja and
          referenciacaja=preferenciacaja;

  else
      raise exception 'No se encontro el folio solicitado.';
  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spcancelamovimiento(character, integer) OWNER TO sistema;

--
-- Name: spcancelamovimiento(character, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spcancelamovimiento(character, integer, character) RETURNS integer
    AS $_$
declare
  pseriecaja alias for $1;
  preferenciacaja alias for $2;
  plogin alias for $3;

  icancelo int4;
  lpolizaid int4;
  dfechapoliza date;

  r record;

  ppermiso char(1);


begin

   select p.permiso
     into ppermiso
     from parametros pa, permisosmodulos p
    where
          --pa.serie_user = pseriecaja and
          --p.usuarioid = pa.usuarioid and
          p.usuarioid = plogin and
          p.clavemodulo = 'POLANT';

   ppermiso := coalesce(ppermiso,'N');

    select m.polizaid,p.fechapoliza
      into lpolizaid,dfechapoliza
      from movicaja m, polizas p
     where m.seriecaja=pseriecaja and
           m.referenciacaja=preferenciacaja and
           p.polizaid=m.polizaid;  

  if FOUND then
    if dfechapoliza<>CURRENT_DATE then
      -- DESCOMENTAR EL RAISE SI SE QUIERE VALIDACION
      if ppermiso='N' then
        raise exception 'No se permite cancelar movimientos de dias anteriores..';
      end if;
    end if;

   -- raise notice ' plogin %',plogin;
   -- Cancelar cada movimiento realizado en el folio

   for r in
    select m.polizaid,p.fechapoliza
      from movicaja m, polizas p
     where m.seriecaja=pseriecaja and
           m.referenciacaja=preferenciacaja and
           p.polizaid=m.polizaid and
           p.fechapoliza=dfechapoliza          
   loop

    select cancelapoliza(r.polizaid,plogin)
      into icancelo;

   end loop;

   update sabana
      set cantidad=0,valor=0
    where seriecaja=pseriecaja and
          referenciacaja=preferenciacaja;



  else
      raise exception 'No se encontro el folio solicitado.';
  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spcancelamovimiento(character, integer, character) OWNER TO sistema;

--
-- Name: spcancelamovimiento(character, integer, character, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spcancelamovimiento(character, integer, character, text) RETURNS integer
    AS $_$
declare
  pseriecaja alias for $1;
  preferenciacaja alias for $2;
  plogin alias for $3;
  pmotivo alias for $4;

  icancelo int4;
  lpolizaid int4;
  dfechapoliza date;

  r record;

  ppermiso char(1);


begin

   select p.permiso
     into ppermiso
     from parametros pa, permisosmodulos p
    where
          --pa.serie_user = pseriecaja and
          --p.usuarioid = pa.usuarioid and
          p.usuarioid = plogin and
          p.clavemodulo = 'POLANT';

   ppermiso := coalesce(ppermiso,'N');

    select m.polizaid,p.fechapoliza
      into lpolizaid,dfechapoliza
      from movicaja m, polizas p
     where m.seriecaja=pseriecaja and
           m.referenciacaja=preferenciacaja and
           p.polizaid=m.polizaid;  

  if FOUND then
    if dfechapoliza<>CURRENT_DATE then
      -- DESCOMENTAR EL RAISE SI SE QUIERE VALIDACION
      if ppermiso='N' then
        raise exception 'No se permite cancelar movimientos de dias anteriores..';
      end if;
    end if;

   -- raise notice ' plogin %',plogin;
   -- Cancelar cada movimiento realizado en el folio

   for r in
    select m.polizaid,p.fechapoliza
      from movicaja m, polizas p
     where m.seriecaja=pseriecaja and
           m.referenciacaja=preferenciacaja and
           p.polizaid=m.polizaid and
           p.fechapoliza=dfechapoliza          
   loop

    select cancelapoliza(r.polizaid,plogin)
      into icancelo;

    update polizas
       set concepto_poliza = pmotivo
     where polizaid = r.polizaid;


   end loop;

   update sabana
      set cantidad=0,valor=0
    where seriecaja=pseriecaja and
          referenciacaja=preferenciacaja;



  else
      raise exception 'No se encontro el folio solicitado.';
  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spcancelamovimiento(character, integer, character, text) OWNER TO sistema;

--
-- Name: spcapitaladelantado(integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spcapitaladelantado(integer, numeric) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;
  pabono alias for $2;

  fAbono numeric;
  fAplicar numeric;
  amor record;

  lsaldoprestamo numeric;

  finteres numeric;
  fintpag numeric;
  
begin

  fAbono := round(pabono,2);

--
-- Actualizar tabla de prestamos, disminuir el saldo del prestamo y
-- actualizar fecha de ultimo pago, importante ya que a partir de ahi calculamos
-- el interes normal
--

  update prestamos
     set saldoprestamo = saldoprestamo - fAbono,
         fechaultimopago = now()
   where prestamoid=pprestamoid;

  select saldoprestamo into lsaldoprestamo
   from prestamos where prestamoid=pprestamoid;

  if lsaldoprestamo<0 then
     raise exception 'El abono es mayor al saldo del prestamo';
  end if;

  if lsaldoprestamo=0 then
    -- Cambiar estatus a pagado
    update prestamos
     set claveestadocredito='002'
   where prestamoid=pprestamoid;
  end if;


--
-- Actualizar tabla de amortizaciones
--
  if fAbono>0 then
    for amor in
        select *
          from amortizaciones
         where prestamoid=pprestamoid and importeamortizacion-abonopagado>0
      order by fechadepago
      --desc
    loop

      fAplicar := amor.importeamortizacion - amor.abonopagado;

      if fAbono>=fAplicar then
        update amortizaciones
           set abonopagado = importeamortizacion,
               ultimoabono = now(),
               interesnormal=0,
               iva=0
         where amortizacionid=amor.amortizacionid;
         fAbono := fAbono - fAplicar;
      else
        if fAbono>0 then
          update amortizaciones
             set abonopagado = abonopagado+fAbono,
                 ultimoabono = now()
           where amortizacionid=amor.amortizacionid;
           fAbono := 0;
        end if;
      end if;
    end loop;
  end if;


return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spcapitaladelantado(integer, numeric) OWNER TO sistema;

--
-- Name: spcatalogosocio(date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spcatalogosocio(date, character) RETURNS SETOF rcatalogosocio
    AS $_$
declare
 
 pfechaf alias for $1;
 ptiposocioid alias for $2;
 r rcatalogosocio%rowtype;

begin

  update socio
     set fechabaja = NULL
   where fechabaja='1900-01-01' or
         fechabaja=fechaalta;

  for r in
    select s.clavesocioint,
           su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
           d.calle||' '||d.numero_ext||' '||rtrim(d.colonia)||' '||rtrim(d.comunidad)||' C.P. '||d.codpostal as domicilio,
           d.teldomicilio as telefono, ci.nombreciudadmex as ciudad,
           s.fechaalta,s.fechabaja,
           (case when s.fechabaja is null then 'A' else
             (case when s.fechabaja>s.fechaalta then 'B' else 'R' end) end) as tipo, su.edad
      from socio s,sujeto su, domicilio d, ciudadesmex ci
     where s.fechaalta <= pfechaf and
           (ptiposocioid='  ' or s.tiposocioid=ptiposocioid) and
            su.sujetoid = s.sujetoid and d.sujetoid=s.sujetoid and d.ciudadmexid=ci.ciudadmexid
   order by s.clavesocioint         
  loop
    return next r;
  end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spcatalogosocio(date, character) OWNER TO sistema;

--
-- Name: spcomprobante(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spcomprobante(integer) RETURNS text
    AS $_$
declare
  pmovicajaid alias for $1;
        
  stexto text;
  stmp text;

begin

  
  select 'Folio: '||seriecaja||to_char(referenciacaja,'999999')||'          '||p.fechapoliza
    into stmp
    from movicaja m, polizas p
   where m.movicajaid=pmovicajaid and
         p.polizaid=m.polizaid;
  stexto := stmp||'
';

return stexto;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spcomprobante(integer) OWNER TO sistema;

--
-- Name: spconsultamov(character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spconsultamov(character, character, character, character, character, character) RETURNS SETOF rconsultamov
    AS $_$
declare

  psocioinicial alias for $1;
  psociofinal   alias for $2;
  ptm1          alias for $3;
  ptm2          alias for $4;
  ptm3          alias for $5;
  ptm4          alias for $6;

  r rconsultamov%rowtype;
  l record;

  fsaldo1 numeric;
  fsaldo2 numeric;
  fsaldo3 numeric;
  fsaldo4 numeric;

  dfecha1 date;
  dfecha2 date;
  dfecha3 date;
  dfecha4 date;

  ftsaldo1 numeric;
  ftsaldo2 numeric;
  ftsaldo3 numeric;
  ftsaldo4 numeric;

begin

  ftsaldo1 := 0;
  ftsaldo2 := 0;
  ftsaldo3 := 0;
  ftsaldo4 := 0;

    for l in
      select s.clavesocioint,
             su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
             s.socioid
        from socio s, sujeto su
       where s.clavesocioint between psocioinicial and psociofinal and
             su.sujetoid = s.sujetoid
    loop

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo1,dfecha1
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm1 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo2,dfecha2
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm2 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo3,dfecha3
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm3 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo4,dfecha4
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm4 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid;

        r.clavesocioint := l.clavesocioint;
        r.nombresocio := l.nombresocio;
        r.saldo1 := coalesce(fsaldo1,0.00);
        r.saldo2 := coalesce(fsaldo2,0.00);
        r.saldo3 := coalesce(fsaldo3,0.00);
        r.saldo4 := coalesce(fsaldo4,0.00);
        r.fecha1 := dfecha1;
        r.fecha2 := dfecha2;
        r.fecha3 := dfecha3;
        r.fecha4 := dfecha4;

        ftsaldo1 := ftsaldo1 + r.saldo1;
        ftsaldo2 := ftsaldo2 + r.saldo2;
        ftsaldo3 := ftsaldo3 + r.saldo3;
        ftsaldo4 := ftsaldo4 + r.saldo4;
      return next r;
    end loop;

    r.clavesocioint := 'Z';
    r.nombresocio := 'TOTALES';
    r.saldo1 := ftsaldo1;
    r.saldo2 := ftsaldo2;
    r.saldo3 := ftsaldo3;
    r.saldo4 := ftsaldo4;
    return next r;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spconsultamov(character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: spconsultamovd(character, character, character, character, character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spconsultamovd(character, character, character, character, character, character, date) RETURNS SETOF rconsultamov
    AS $_$
declare

  psocioinicial alias for $1;
  psociofinal   alias for $2;
  ptm1          alias for $3;
  ptm2          alias for $4;
  ptm3          alias for $5;
  ptm4          alias for $6;
  pfecha        alias for $7;

  r rconsultamov%rowtype;
  l record;

  fsaldo1 numeric;
  fsaldo2 numeric;
  fsaldo3 numeric;
  fsaldo4 numeric;

  dfecha1 date;
  dfecha2 date;
  dfecha3 date;
  dfecha4 date;

  ftsaldo1 numeric;
  ftsaldo2 numeric;
  ftsaldo3 numeric;
  ftsaldo4 numeric;

begin

  ftsaldo1 := 0;
  ftsaldo2 := 0;
  ftsaldo3 := 0;
  ftsaldo4 := 0;

    for l in
      select s.clavesocioint,
             su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
             s.socioid
        from socio s, sujeto su
       where s.clavesocioint between psocioinicial and psociofinal and
             su.sujetoid = s.sujetoid
    loop

      raise notice 'Procesando %',l.clavesocioint;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo1,dfecha1
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm1 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.fechapoliza<=pfecha;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo2,dfecha2
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm2 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.fechapoliza<=pfecha;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo3,dfecha3
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm3 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.fechapoliza<=pfecha;

      select sum(mp.debe)-sum(mp.haber),max(p.fechapoliza)
             into fsaldo4,dfecha4
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=l.socioid and
             mc.tipomovimientoid = ptm4 and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.fechapoliza<=pfecha;


        r.clavesocioint := l.clavesocioint;
        r.nombresocio := l.nombresocio;
        r.saldo1 := coalesce(fsaldo1,0.00);
        r.saldo2 := coalesce(fsaldo2,0.00);
        r.saldo3 := coalesce(fsaldo3,0.00);
        r.saldo4 := coalesce(fsaldo4,0.00);
        r.fecha1 := dfecha1;
        r.fecha2 := dfecha2;
        r.fecha3 := dfecha3;
        r.fecha4 := dfecha4;

        ftsaldo1 := ftsaldo1 + r.saldo1;
        ftsaldo2 := ftsaldo2 + r.saldo2;
        ftsaldo3 := ftsaldo3 + r.saldo3;
        ftsaldo4 := ftsaldo4 + r.saldo4;
      return next r;
    end loop;

    r.clavesocioint := 'Z';
    r.nombresocio := 'TOTALES';
    r.saldo1 := ftsaldo1;
    r.saldo2 := ftsaldo2;
    r.saldo3 := ftsaldo3;
    r.saldo4 := ftsaldo4;
    return next r;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spconsultamovd(character, character, character, character, character, character, date) OWNER TO sistema;

--
-- Name: spcontratoprenda(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spcontratoprenda(integer) RETURNS text
    AS $_$
declare

  pcontrato alias for $1;
  pformato text;
  pnombre varchar;
  fmonto numeric;
  dfecha_otorga date;
  pmes int;
  psmes varchar;
  pdia char(2);
  pano char(4);

begin
	 

select sop.montosolicitado into fmonto  
from solicitudprestamo sop,socio so,sujeto su
where sop.socioid = so.socioid and 
su.sujetoid = so.sujetoid and
sop.solicitudprestamoid = pcontrato;

select sop.fechaentrega into dfecha_otorga  
from solicitudprestamo sop,socio so,sujeto su
where sop.socioid = so.socioid and 
su.sujetoid = so.sujetoid and
sop.solicitudprestamoid = pcontrato;
--dfecha_otorga = date;

  pmes:=cast(date_part('month',dfecha_otorga) as int);
  pdia:=cast(date_part('day',dfecha_otorga) as char(2));
  pano:=cast(date_part('year',dfecha_otorga) as char(4));

  if pmes=1 then
    psmes := 'Enero     ';
  end if;
  if pmes=2 then
    psmes := 'Febrero   ';
  end if;
  if pmes=3 then
    psmes := 'Marzo     ';
  end if;
  if pmes=4 then
    psmes := 'Abril     ';
  end if;
  if pmes=5 then
    psmes := 'Mayo      ';
  end if;
  if pmes=6 then
    psmes := 'Junio     ';
  end if;
  if pmes=7 then
    psmes := 'Julio     ';
  end if;
  if pmes=8 then
    psmes := 'Agosto    ';
  end if;
  if pmes=9 then
    psmes := 'Septiembre';
  end if;
  if pmes=10 then
    psmes := 'Octubre   ';
  end if;
  if pmes=11 then
    psmes := 'Noviembre ';
  end if;
  if pmes=12 then
    psmes := 'Diciembre ';
  end if;

  psmes := rtrim(psmes);


select
chr(15)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)
||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
'                                                                           '||su.nombre||' '||su.paterno||' '||su.materno||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||'                                      '||su.nombre||' '||su.paterno||' '||su.materno||
chr(13)||chr(10)||'         '||so.clavesocioint||
chr(13)||chr(10)||
chr(13)||chr(10)||
--chr(13)||chr(10)||
chr(13)||chr(10)||'                                                                                                        '||to_char(fmonto,'99,999,999.99')||
chr(13)||chr(10)||'   '||cletra(fmonto)||
chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||chr(13)||chr(10)||
chr(13)||chr(10)||'          DOLORES HIDALGO C.I.N., GTO.   '||pdia||' '||psmes||' '||pano||
chr(13)||chr(10)
into pformato
from solicitudprestamo sop,socio so,sujeto su
where sop.socioid = so.socioid and 
su.sujetoid = so.sujetoid and
sop.solicitudprestamoid = pcontrato; 
return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spcontratoprenda(integer) OWNER TO sistema;

--
-- Name: spdactivo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdactivo(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from activos where activoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdactivo(integer) OWNER TO sistema;

--
-- Name: spdamortizacion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdamortizacion(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from amortizaciones where amortizacionid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdamortizacion(integer) OWNER TO sistema;

--
-- Name: spdasesor(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdasesor(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from asesor where asesorid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdasesor(integer) OWNER TO sistema;

--
-- Name: spdaval(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdaval(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from avales where avalid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdaval(integer) OWNER TO sistema;

--
-- Name: spdbanco(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdbanco(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from bancos where no_cuenta=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdbanco(character) OWNER TO sistema;

--
-- Name: spdbeneficiario(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdbeneficiario(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from beneficiario where beneficiarioid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdbeneficiario(integer) OWNER TO sistema;

--
-- Name: spdbienes(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdbienes(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin

delete from bienes where bienid=pclave;

return 1;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdbienes(integer) OWNER TO sistema;

--
-- Name: spdcalculo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdcalculo(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from calculo where calculoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdcalculo(integer) OWNER TO sistema;

--
-- Name: spdcarteracobrador(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdcarteracobrador(integer) RETURNS integer
    AS $_$
declare 
  pprestamoid alias for $1;

  pcobradorid integer;
begin
  select cobradorid into pcobradorid from carteracobrador where prestamoid=pprestamoid;
  if found then
     delete from carteracobrador where cobradorid=pcobradorid and prestamoid=pprestamoid;
  end if;
return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spdcarteracobrador(integer) OWNER TO sistema;

--
-- Name: spdcatalogo_ctas(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdcatalogo_ctas(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;

  fsaldo1 numeric;
  fsaldo2 numeric;
  fsaldo3 numeric;
begin

  select sum(saldoinicialperiodo),sum(cargosdelperiodo),sum(abonosdelperiodo)
    into fsaldo1,fsaldo2,fsaldo3
   from saldos
  where cuentaid=pclave;

  if fsaldo1=0 and fsaldo2=0 and fsaldo3=0 then
    delete from saldos where cuentaid=pclave;
    delete from saldosc where cuentaid=pclave;
  end if;
  delete from catalogo_ctas where cuentaid=pclave;
  
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdcatalogo_ctas(character) OWNER TO sistema;

--
-- Name: spdciudadmex(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdciudadmex(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from ciudadesmex where ciudadmexid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdciudadmex(integer) OWNER TO sistema;

--
-- Name: spdclasificacioncredito(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdclasificacioncredito(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from clasificacioncredito where clasificacioncreditoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdclasificacioncredito(integer) OWNER TO sistema;

--
-- Name: spdclasificacionsocio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdclasificacionsocio(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from clasificacionsocio where clasificacionsocioid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdclasificacionsocio(integer) OWNER TO sistema;

--
-- Name: spdcobradores(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdcobradores(integer) RETURNS integer
    AS $_$
declare
 
  pcobradorid alias for $1;

  psujetoid integer;
begin

  select coalesce(sujetoid,0) into psujetoid from cobradores where cobradorid=pcobradorid;
  delete from cobradores where cobradorid=pcobradorid;
  delete from sujeto where sujetoid=psujetoid;  

return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spdcobradores(integer) OWNER TO sistema;

--
-- Name: spdcolonia(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdcolonia(integer) RETURNS integer
    AS $_$
declare
  pcoloniaid alias for $1;
begin
  delete from colonia where coloniaid=pcoloniaid;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdcolonia(integer) OWNER TO sistema;

--
-- Name: spdconceptoscoring(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdconceptoscoring(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from conceptoscoring where conceptoscoringid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdconceptoscoring(integer) OWNER TO sistema;

--
-- Name: spdconsolida(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdconsolida(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from sucursales where sucursalid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdconsolida(integer) OWNER TO sistema;

--
-- Name: spddatoingreso(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spddatoingreso(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from datoingreso where datoingresoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spddatoingreso(integer) OWNER TO sistema;

--
-- Name: spddepreciacion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spddepreciacion(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from depreciacion where depreciacionid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spddepreciacion(integer) OWNER TO sistema;

--
-- Name: spddocumentacion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spddocumentacion(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from documentacion where documentacionid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spddocumentacion(integer) OWNER TO sistema;

--
-- Name: spddomicilio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spddomicilio(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from domicilio where domicilioid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spddomicilio(integer) OWNER TO sistema;

--
-- Name: spdepreciacioncontable(date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdepreciacioncontable(date, character) RETURNS integer
    AS $_$
declare

  pfecha alias for $1;
  sserie_user alias for $2;

  r record;

  scuenta_activo char(24);
  scuenta_gasto  char(24);
  sdescripcion   char(30);
  fdeprecia numeric;
  idepreciacionid int4;

  pnumero_poliza int4;
  preferencia int4;
  ppolizaid int4;
  pmovipolizaid int4;

begin


-- 
-- Borrar poliza del mismo da, serie y tipo=G
--

  delete from movipolizas where polizaid in (select polizaid from polizas where seriepoliza=sserie_user and tipo='G' and fechapoliza=pfecha);

  delete from polizas where seriepoliza=sserie_user and tipo='G' and fechapoliza=pfecha;

--
-- Dar de alta la poliza contable
--
  select *
    into pnumero_poliza,preferencia
  from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'G',sserie_user,'D');

-- Encabezado de la poliza
  select * 
    into ppolizaid
    from spipolizasfecha(preferencia,sserie_user,'G',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','Poliza de Depreciacin',pfecha);


  idepreciacionid:=0;
  fdeprecia:=0;

  for r in
select activoid,depreciacionid,
       activoclave,activodescripcion,activo_valor,feciniciodepconta,activotasaconta,
       100/((activotasaconta/100)/12*100) as g,
       (case when pfecha<feciniciodepconta then 0
        else trunc((pfecha-feciniciodepconta)/30,0) end) as h,
        
       (case when (case when pfecha<feciniciodepconta then 0
                   else trunc((pfecha-feciniciodepconta)/30,0) end)>(100/((activotasaconta/100)/12*100)) then 0
             else 
         trunc(activo_valor/(100/((activotasaconta/100)/12*100)),2)*(case when (case when pfecha<feciniciodepconta then 0
        else trunc((pfecha-feciniciodepconta)/30,0) end)<1 then 0 else 1 end ) end) as depmensual,
        
        (case when (case when pfecha<feciniciodepconta then 0
                     else trunc((pfecha-feciniciodepconta)/30,0) end)>(100/((activotasaconta/100)/12*100)) 
           then activo_valor
           else (case when pfecha<feciniciodepconta then 0
        else trunc((pfecha-feciniciodepconta)/30,0) end)*(case when (case when pfecha<feciniciodepconta then 0
                   else trunc((pfecha-feciniciodepconta)/30,0) end)>(100/((activotasaconta/100)/12*100)) then 0
             else 
   trunc(activo_valor/(100/((activotasaconta/100)/12*100)),2)*(case when (case when pfecha<feciniciodepconta then 0
        else trunc((pfecha-feciniciodepconta)/30,0) end)<1 then 0 else 1 end ) end)
           end) as depacumulada
                   
 from activos
order by depreciacionid,activoclave

  loop
   if idepreciacionid=0 then
     idepreciacionid:=r.depreciacionid;
   end if;


   if idepreciacionid<>r.depreciacionid then
     select depre_activo,depre_ctagasto,depredescripcion
       into scuenta_activo, scuenta_gasto,sdescripcion
       from depreciacion
      where depreciacionid=idepreciacionid;

      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,scuenta_gasto,' ','C',fdeprecia,0,' ',' ',
                          substr(sdescripcion,1,29));
      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,scuenta_activo,' ','A',0,fdeprecia,' ',' ',
                          substr(sdescripcion,1,29));

     fdeprecia:=0;
   end if;
   idepreciacionid:=r.depreciacionid;
   fdeprecia:=fdeprecia+r.depmensual;

   update activos
      set actdepreacumconta=r.depacumulada
    where activoid=r.activoid;

  end loop;

     select depre_activo,depre_ctagasto,depredescripcion
       into scuenta_activo, scuenta_gasto,sdescripcion
       from depreciacion
      where depreciacionid=idepreciacionid;

      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,scuenta_gasto,' ','C',fdeprecia,0,' ',' ',
                          substr(sdescripcion,1,29));
      select *
        into pmovipolizaid
        from spimovipoliza(ppolizaid,scuenta_activo,' ','A',0,fdeprecia,' ',' ',
                          substr(sdescripcion,1,29));


return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdepreciacioncontable(date, character) OWNER TO sistema;

--
-- Name: spdestadomex(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdestadomex(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from estadosmex where estadomexid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdestadomex(integer) OWNER TO sistema;

--
-- Name: spdestados_credito(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdestados_credito(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from estados_credito where claveestadocredito=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdestados_credito(character) OWNER TO sistema;

--
-- Name: spdfinalidades(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdfinalidades(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from finalidades where clavefinalidad=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdfinalidades(character) OWNER TO sistema;

--
-- Name: spdgrupo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdgrupo(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from grupo where grupoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdgrupo(integer) OWNER TO sistema;

--
-- Name: spdinpc(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdinpc(integer, integer) RETURNS integer
    AS $_$
declare
  pano alias for $1;
  pmes alias for $2;

begin

  delete from inpc where ano=pano and mes=pmes;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdinpc(integer, integer) OWNER TO sistema;

--
-- Name: spdinversion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdinversion(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from inversion where inversionid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdinversion(integer) OWNER TO sistema;

--
-- Name: spdmodulo(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdmodulo(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from modulos where clavemodulo=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdmodulo(character) OWNER TO sistema;

--
-- Name: spdmoneda(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdmoneda(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from monedas where monedaid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdmoneda(character) OWNER TO sistema;

--
-- Name: spdmotivobaja(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdmotivobaja(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from motivobaja where motivobajaid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdmotivobaja(integer) OWNER TO sistema;

--
-- Name: spdmovibanco(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdmovibanco(integer) RETURNS integer
    AS $_$
declare
  pmovibancoid alias for $1;
begin
  delete from movibanco where movibancoid=pmovibancoid;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdmovibanco(integer) OWNER TO sistema;

--
-- Name: spdmovicaja(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdmovicaja(integer) RETURNS integer
    AS $_$
declare
  r movicaja%rowtype;
  poperacion alias for $1;
begin
  delete from movicaja where operacion=poperacion;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdmovicaja(integer) OWNER TO sistema;

--
-- Name: spdmovipolizas(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdmovipolizas(integer) RETURNS integer
    AS $_$
declare
  r movipolizas%rowtype;
  pmovipolizaid alias for $1;
begin
  delete from movipolizas where movipolizaid=pmovipolizaid;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdmovipolizas(integer) OWNER TO sistema;

--
-- Name: spdocupacion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdocupacion(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from ocupacion where ocupacionid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdocupacion(integer) OWNER TO sistema;

--
-- Name: spdparametro(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdparametro(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from parametros where usuarioid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdparametro(character) OWNER TO sistema;

--
-- Name: spdpermisomodulo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdpermisomodulo(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from permisosmodulos where permisomoduloid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdpermisomodulo(integer) OWNER TO sistema;

--
-- Name: spdpoliza(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdpoliza(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from polizas where operacion=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdpoliza(integer) OWNER TO sistema;

--
-- Name: spdprestamos(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdprestamos(character) RETURNS integer
    AS $_$
declare
  preferenciaprestamo alias for $1;
begin
  delete from prestamos where referenciaprestamo=preferenciaprestamo;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdprestamos(character) OWNER TO sistema;

--
-- Name: spdprocampo(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdprocampo(character) RETURNS integer
    AS $_$
declare
  preferenciaprestamo alias for $1;
begin
  delete from procampo where referenciaprestamo=preferenciaprestamo;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdprocampo(character) OWNER TO sistema;

--
-- Name: spdpromocion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdpromocion(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from promocion where promocionid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdpromocion(integer) OWNER TO sistema;

--
-- Name: spdrango(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdrango(integer) RETURNS integer
    AS $_$
declare
  prangoid alias for $1;

begin

  delete from subrango where rangoid=prangoid;
  delete from rango where rangoid=prangoid;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdrango(integer) OWNER TO sistema;

--
-- Name: spdrecargos(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdrecargos(integer, integer) RETURNS integer
    AS $_$
declare
  pano alias for $1;
  pmes alias for $2;
begin
  delete from recargos where ano=pano and mes=pmes;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdrecargos(integer, integer) OWNER TO sistema;

--
-- Name: spdrelacion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdrelacion(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from relacion where relacionid=pclave;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdrelacion(integer) OWNER TO sistema;

--
-- Name: spdsubrango(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdsubrango(integer) RETURNS integer
    AS $_$
declare
  psubrangoid alias for $1;

begin

  delete from subrango where subrangoid=psubrangoid;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdsubrango(integer) OWNER TO sistema;

--
-- Name: spdsujeto(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdsujeto(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from sujetos where sujetoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdsujeto(integer) OWNER TO sistema;

--
-- Name: spdtipo_garantia(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdtipo_garantia(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from tipo_garantia where clavegarantia=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdtipo_garantia(character) OWNER TO sistema;

--
-- Name: spdtipoacreditador(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdtipoacreditador(integer) RETURNS integer
    AS $_$
declare
  ptipocreditadoid alias for $1;
begin
  delete from tipoacreditador where tipocreditadoid=ptipocreditadoid;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdtipoacreditador(integer) OWNER TO sistema;

--
-- Name: spdtipoaviso(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdtipoaviso(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from tipoaviso where tipoavisoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdtipoaviso(integer) OWNER TO sistema;

--
-- Name: spdtipoinversion(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdtipoinversion(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from tipoinversion where tipoinversionid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdtipoinversion(character) OWNER TO sistema;

--
-- Name: spdtipomovibanco(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdtipomovibanco(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from tipomovibanco where tipomovibancoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdtipomovibanco(character) OWNER TO sistema;

--
-- Name: spdtipomovimiento(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdtipomovimiento(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from tipomovimiento where tipomovimientoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdtipomovimiento(character) OWNER TO sistema;

--
-- Name: spdtipoprestamo(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdtipoprestamo(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from tipoprestamo where tipoprestamoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdtipoprestamo(character) OWNER TO sistema;

--
-- Name: spdtipopromocion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdtipopromocion(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from tipopromocion where tipopromocionid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdtipopromocion(integer) OWNER TO sistema;

--
-- Name: spdtiposocio(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdtiposocio(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from tiposocio where tiposocioid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdtiposocio(character) OWNER TO sistema;

--
-- Name: spdtipousuario(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdtipousuario(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from tipousuario where tipousuarioid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdtipousuario(character) OWNER TO sistema;

--
-- Name: spdudis(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdudis(date) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from udis where fecha=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdudis(date) OWNER TO sistema;

--
-- Name: spdusuario(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spdusuario(character) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from parametros where usuarioid=pclave;
  delete from permisosmodulos where usuarioid=pclave;
  delete from usuarios where usuarioid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spdusuario(character) OWNER TO sistema;

--
-- Name: spfolio(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spfolio(integer, character) RETURNS text
    AS $_$
declare
  preferenciacaja alias for $1;
  pseriecaja alias for $2;
        
  pformato text;
  ptexto text;
  ptexto1 text;

  r record;
  x record;

  plineasiniciales integer;
  pnombrecaja char(80);
  prfccaja char(20);
  pdescripcion char(29);
  pdireccioncaja char(100);
 sucursal char(4); 
 pcuentacaja char(24);
  pusuarioid char(20);
  preferenciaprestamo char(18);
  psaldoprestamo numeric;
  psocio integer;

  fmontoprestamo numeric;

  i integer;
  l integer;
  subtotal numeric;

  fcapital numeric;
  fnormal numeric;
  fmoratorio numeric;
  fiva numeric;
  ftotal numeric;
  fisr numeric;
  dfecha date;
  pencabezado integer;
  psucursal char(10);
  supago numeric;
  esefectivo text;

  tepago numeric;
  tecomision numeric;
  teivacomision numeric;
  
begin

  pformato := '';
  subtotal := 0;
  
  fcapital := 0;
  fnormal := 0;
  fmoratorio := 0;
  fiva := 0;
  pencabezado := 0;
 
  select lineasiniciales, nombrecaja, rfccaja, direccioncaja, sucid
    into plineasiniciales, pnombrecaja, prfccaja, pdireccioncaja, sucursal
    from empresa;


  plineasiniciales := coalesce(plineasiniciales,0);
  pnombrecaja := coalesce(pnombrecaja,' ');
  prfccaja := coalesce(prfccaja,' ');  
  pdireccioncaja := coalesce(pdireccioncaja,' ');

 select cuentacaja, usuarioid
   into pcuentacaja, pusuarioid
   from parametros
  where serie_user = pseriecaja;

 select distinct(m.socioid), p.fechapoliza
   into psocio, dfecha
   from movicaja m, polizas p
  where referenciacaja = preferenciacaja and
        seriecaja = pseriecaja and
        p.polizaid = m.polizaid;
	
 select (current_schemas(false))[2]
   into psucursal;



  for i in 1..plineasiniciales
    loop
      pformato := pformato||chr(13)||chr(10);
    end loop;  

  select
chr(13)||chr(10)
||chr(13)||chr(10)
||chr(13)||chr(10)
||chr(13)||chr(10)
||chr(13)||chr(10)
||chr(13)||chr(15)
        ||'FOLIO:    ' ||alineacero(ltrim(to_char(m.referenciacaja,'999999')))||lpad('CAJA: ',30,' ')||'  '||sucursal||chr(13)||chr(10)||
	'SOCIO:    '||s.clavesocioint||lpad('CAJERA: ',20,' ')||pusuarioid ||' '||to_char(p.fechapoliza,'dd/mm/yyyy')||'  '||to_char( now(), 'HH24:MI:SS')||chr(13)||chr(10)||
	'NOMBRE:   '||rtrim(su.nombre)||' '||rtrim(su.paterno)||' '||rtrim(su.materno)|| ' Tipo Socio:'|| s.tiposocioid ||chr(13)||chr(10)||chr(13)||
	lpad('DESCRIPCION DEL MOVIMIENTO',50,' ')||chr(13)||chr(10)||
'========================================================================'||chr(13)||chr(10)
   into ptexto1
   from movicaja m, polizas p, socio s,sujeto su,domicilio d
  where m.referenciacaja = preferenciacaja and
        m.seriecaja = pseriecaja and
        p.polizaid = m.polizaid and
        s.socioid = m.socioid and
        su.sujetoid = s.sujetoid and
	su.sujetoid = d.sujetoid;	
	
  pformato := pformato||ptexto1;

 l := 7;

--raise notice 'Encabezado %',l;

  pencabezado = 0;
  -- Movimientos

  for r in

  select m.tipomovimientoid, t.desctipomovimiento, (mp.debe-mp.haber) as cantidad, mp.descripcion, m.polizaid
    from movicaja m, polizas p, movipolizas mp, tipomovimiento t
   where m.referenciacaja = preferenciacaja and
         m.seriecaja = pseriecaja and
         m.tipomovimientoid <> '00' and
         m.tipomovimientoid <> 'IN' and
         p.polizaid = m.polizaid and
         mp.polizaid = p.polizaid and
         mp.movipolizaid = m.movipolizaid and
         t.tipomovimientoid = m.tipomovimientoid

     loop
          if pencabezado = 0 then
	     if l >= 21 then
	        pformato := pformato||chr(13)||chr(10)||ptexto1;
	        l := 7;
	     else
--                pformato := pformato||chr(13)||chr(10);
	     end if;
	     l := l+1;
             pencabezado := 1;     	  	  
	    end if;

--           select descripcion into pdescripcion from movipolizas where polizaid=r.polizaid and cuentaid=pcuentacaja and ( haber = r.cantidad or debe = r.cantidad);
          pdescripcion := coalesce(r.descripcion,' ');

--          pdescripcion := coalesce(pdescripcion,' ');
          if substr(pdescripcion,1,14)='Poliza Aut. de' then
             pdescripcion:= ' ';
	  end if;

          if r.tipomovimientoid = 'TE' then

             --Obtiene el pago del telefono sin comision
             select mp.haber into tepago
             from movicaja m, polizas p, movipolizas mp, tipomovimiento t
             where m.referenciacaja = preferenciacaja
                   and m.seriecaja = pseriecaja
                   and m.tipomovimientoid='TE'
                   and p.polizaid = m.polizaid
                   and mp.polizaid = p.polizaid
                   and t.tipomovimientoid = m.tipomovimientoid
                   and cuentaid=t.cuentadeposito;

             --Obtiene la comision del pago de telefono
             select mp.haber into tecomision
             from movicaja m, polizas p, movipolizas mp, tipomovimiento t
             where m.referenciacaja = preferenciacaja
                   and m.seriecaja = pseriecaja
                   and m.tipomovimientoid='TE'
                   and p.polizaid = m.polizaid
                   and mp.polizaid = p.polizaid
                   and t.tipomovimientoid = m.tipomovimientoid
                   and cuentaid=t.cuentacomision;

             --Obtiene el iva de la comision del pago de telefono
             select mp.haber into teivacomision
             from movicaja m, polizas p, movipolizas mp, tipomovimiento t
             where m.referenciacaja = preferenciacaja
                   and m.seriecaja = pseriecaja
                   and m.tipomovimientoid='TE'
                   and p.polizaid = m.polizaid
                   and mp.polizaid = p.polizaid
                   and t.tipomovimientoid = m.tipomovimientoid
                   and cuentaid=t.cuentaivacomision;

             ptexto := 'TU MOVIMIENTO EN '||r.tipomovimientoid||': '||chr(13)||chr(10)
             ||rpad(pdescripcion,22,' ')||rpad(r.desctipomovimiento,20,' ')||lpad(to_char(tepago,'999,999,999.99'),24,' ')||chr(13)||chr(10)
             ||rpad(pdescripcion,22,' ')||rpad('COMISION',20,' ')||lpad(to_char(tecomision,'999,999,999.99'),24,' ')||chr(13)||chr(10)
             ||rpad(pdescripcion,22,' ')||rpad('IVA COMISION',20,' ')||lpad(to_char(teivacomision,'999,999,999.99'),24,' ')||chr(13)||chr(10);
	  end if;
                

          if r.tipomovimientoid <> 'TE' then
                    ptexto := 'TU MOVIMIENTO EN '||r.tipomovimientoid||': '||rpad(r.desctipomovimiento,25,' ')||chr(13)||chr(10)
                    ||rpad(pdescripcion,22,' ')||lpad(to_char(r.cantidad,'999,999,999.99'),44,' ')||chr(13)||chr(10);
          end if;

          
          subtotal := subtotal+r.cantidad;
	  if l >= 21 then
	     pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||ptexto;
	     l := 8;
	  else
             pformato := pformato||ptexto;
	  end if;
          l := l+1;	  

     end loop;

  pencabezado := 0;
  

-- Prestamos

  for r in

  select t.cuentaactivo,t.cuentaintnormal,t.cuentaintmora,t.cuentaiva,m.polizaid,p.referenciaprestamo,
         p.prestamoid,p.tipoprestamoid
    from movicaja m, prestamos p, tipoprestamo t
   where m.referenciacaja = preferenciacaja and
         m.seriecaja = pseriecaja and
         m.tipomovimientoid = '00' and
         p.prestamoid=m.prestamoid and
         t.tipoprestamoid=p.tipoprestamoid

     loop

          -- Buscar capital
          select sum(haber-debe)
            into fcapital
            from movipolizas
           where polizaid=r.polizaid and
                 cuentaid=r.cuentaactivo;

          -- Buscar interes normal
          select sum(haber-debe)
            into fnormal
            from movipolizas
           where polizaid=r.polizaid and
                 cuentaid=r.cuentaintnormal;

          -- Buscar interes moratorio
          select sum(haber-debe)
            into fmoratorio
            from movipolizas
           where polizaid=r.polizaid and
                 cuentaid=r.cuentaintmora;

          -- Buscar iva
          select sum(haber-debe)
            into fiva
            from movipolizas
           where polizaid=r.polizaid and
                 cuentaid=r.cuentaiva;

          -- Buscar Cta Caja
          select sum(debe-haber)
            into ftotal
            from movipolizas
          where polizaid=r.polizaid and
                cuentaid=pcuentacaja;

          fcapital:=coalesce(fcapital,0);
          fnormal:=coalesce(fnormal,0);
          fmoratorio:=coalesce(fmoratorio,0);
          fiva:=coalesce(fiva,0);

          select montoprestamo into fmontoprestamo
            from prestamos where prestamoid=r.prestamoid;

          -- Buscar Saldo del prestamo
                SELECT fmontoprestamo-sum(haber) as saldo 
                  into psaldoprestamo
                  from movicaja m, polizas p,movipolizas mp
                 where m.prestamoid = r.prestamoid and
                       p.polizaid=m.polizaid and
                       p.fechapoliza < dfecha+1 and
                       mp.polizaid=m.polizaid and
                       mp.cuentaid = r.cuentaactivo;

	  psaldoprestamo:=coalesce(psaldoprestamo,fmontoprestamo);

          if pencabezado = 0 then
	     if l >= 21 then
	        pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||
			 ' Tu pago al Prestamo con saldo '||fcapital+psaldoprestamo||' fue:'||chr(13)||chr(10)||
'     Capital       Int. Normal     Int. Moratorio     I.V.A.      Total'||chr(13)||chr(10);
	        l := 8;
	     else

                pformato := pformato||
                         ' Tu pago al Prestamo con saldo '||fcapital+psaldoprestamo||' fue:'||chr(13)||chr(10)||
'     Capital       Int. Normal     Int. Moratorio     I.V.A.      Total'||chr(13)||chr(10);
	     end if;
	     l := l+1;
             pencabezado := 1;     
          end if;

          ptexto := lpad(to_char(fcapital,'9,999,999.99'),13,' ')||' '||
                    to_char(fnormal,'9,999,999.99')||'  '||
                    to_char(fmoratorio,'9,999,999.99')||' '||
                    to_char(fiva,'9,999,999.99')||'  '||
		    to_char(ftotal,'9,999,999.99')||chr(13)||chr(10)||
                    ' Tu saldo actual en prestamo '||r.tipoprestamoid||'  '||r.referenciaprestamo||' es  '||
                    ltrim(to_char(psaldoprestamo,'9,999,999.99'))||chr(13)||chr(10);
          subtotal := subtotal + ftotal;

          
	  if l >= 21 then
	     pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||ptexto;
	     l := 8;
	  else
             pformato := pformato||ptexto;
	  end if;

	  --raise notice ' voy aqui buscando prestamos % % % % %',fcapital,fnormal,fiva,fmoratorio,ftotal;          

	  l := l+2;		    

     end loop;

    -- raise notice 'Prestamos % %',l,pformato;


  pencabezado := 0;
-- Inversiones

    for x in
  select t.cuentapasivo,t.cuentaintinver,t.cuentaivainver,t.cuentariesgocred,m.polizaid
    from movicaja m, inversion v, tipoinversion t
   where m.referenciacaja = preferenciacaja and
         m.seriecaja = pseriecaja and
         m.tipomovimientoid = 'IN' and
	 t.tipoinversionid <> 'K3' and
         v.inversionid = m.inversionid and
         t.tipoinversionid = v.tipoinversionid

    loop

          -- Buscar capital
          select sum(haber-debe)
            into fcapital
            from movipolizas
           where polizaid=x.polizaid and
                 cuentaid=x.cuentapasivo;

          -- Buscar interes
          select sum(haber-debe)
            into fnormal
            from movipolizas
           where polizaid=x.polizaid and
                 cuentaid=x.cuentaintinver;

          -- Buscar iva
          select sum(haber-debe)
            into fiva
            from movipolizas
           where polizaid=x.polizaid and
                 cuentaid=x.cuentaivainver;

          -- Buscar ISR
          select sum(haber-debe)
            into fisr
            from movipolizas
           where polizaid=x.polizaid and
                 cuentaid=x.cuentariesgocred;

          -- Buscar Cta Caja
          select sum(debe-haber)
            into ftotal
            from movipolizas
           where polizaid=x.polizaid and
                 cuentaid=pcuentacaja;

          fcapital:=coalesce(fcapital,0);
          fnormal:=coalesce(fnormal,0);
          fiva:=coalesce(fiva,0);
          fisr:=coalesce(fisr,0);

          if pencabezado = 0 then
	     if l >= 21 then
	        pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||
			 '           Concepto                           Movimiento'||chr(13)||chr(10);
	        l := 8;
	     else
		pformato := pformato||	 '           Concepto                          Movimiento'||chr(13)||chr(10);	     
	     end if;	  	  
             pencabezado := 1;
	     l := l+2;
          end if;
	  
          ptexto := lpad('Capital        :  ',25,' ')||to_char(fcapital,'999,999,999.99')||'     '||chr(13)||chr(10)||
                    lpad('Interes Normal :  ',25,' ')||to_char(fnormal,'999,999,999.99')||'     '||chr(13)||chr(10)||
                    lpad('I.V.A.         :  ',25,' ')||to_char(fiva,'999,999,999.99')||'     '||chr(13)||chr(10)||
                    lpad('I.S.R.         :  ',25,' ')||to_char(fisr,'999,999,999.99')||'     '||chr(13)||chr(10)||
		    lpad('T o t a l: ',24,' ')||' '||to_char(ftotal,'999,999,999.99')||chr(13)||chr(10)||chr(13)||chr(10);
          l := l+2;		    
          subtotal := subtotal + ftotal;
	  if l >= 21 then
	     pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||ptexto;
	     l := 8;
	  else
             pformato := pformato||ptexto;
	  end if;
	  l := l+2;		    
     end loop;     
   
   if pencabezado <> 0 then
      pformato := pformato||'  INVERSION'||chr(13)||chr(10)||chr(13)||chr(10)||
                  'Saldos en movimientos:'||chr(13)||chr(10);
      l := l+3;
      pencabezado:=5;
   end if;

-- Total
   if pencabezado <> 5 then
     ptexto := lpad('T O T A L:           ',47,' ')||'   '||to_char(subtotal,'$999,999,999.99')||chr(13)||chr(10);
     if l >= 21 then
        pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||ptexto||
                    'Saldos en movimientos:'||chr(13)||chr(10);
        l := 8;
     else
        pformato := pformato||ptexto||
                    'Saldos en movimientos:'||chr(13)||chr(10);
     end if;
     l := l+2;
   end if;

--  raise notice 'Total %',l;
  
-- Saldos
   for r in
      select * from spssaldosmovf(psocio,dfecha)
   loop        
         ptexto := '          '||rpad(r.desctipomovimiento,30,' ')||'          '||
                   to_char(r.saldo,'$999,999,999.99')||chr(13)||chr(10);
         if l >= 21 then
            if r.saldo > 0 then
               pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||ptexto;
            end if;
             l := 8;
         else
             if r.saldo > 0 then
                pformato := pformato||ptexto;
             end if;
         end if;		   
	 l := l+1;
      
   end loop;
   
--  raise notice 'Saldos %',l;   


-- FORMA DE PAGO
   if pencabezado <> 5 then
         select sum(valor)
	   into supago
	   from sabana
	  where referenciacaja = preferenciacaja and 
	        seriecaja = pseriecaja and
		entradasalida=0;
		
	 supago := coalesce(supago,subtotal);
	 
	 select efectivo
	   into esefectivo
	   from sabana s, denominacion d
	  where s.referenciacaja = preferenciacaja and 
	        s.seriecaja = pseriecaja and
		s.entradasalida=0 and
		d.denominacionid=s.denominacionid;
         if esefectivo is not null then
            if esefectivo = '1' then
	         esefectivo = 'EFECTIVO';
	      else
	         esefectivo = 'CHEQUE';
	      end if;
         else
	    esefectivo = 'EFECTIVO';
	 end if;
         		
            ptexto := chr(13)||chr(10)||'   TOTAL A PAGAR '||to_char(subtotal,'$999,999.99')||
                      chr(13)||chr(10)||'   SU PAGO       '||to_char(supago,'$999,999.99')||
                      chr(13)||chr(10)||'   SU CAMBIO     '||to_char(supago-subtotal,'$999,999.99')||
                      chr(13)||chr(10)||'   PAGO CON          '||esefectivo||chr(13)||chr(10);

         if l >= 21 then
             pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||ptexto;
             l := 8;
         else
             pformato := pformato||ptexto;
         end if;		   
	 l := l+1;      	       
    end if;


-- Usuario y Sucursal
   if l = 17 then
     pformato := pformato||chr(13)||chr(10)||
                 ' LOS DOCUMENTOS  DEPOSITADOS  SON  ACEPTADOS SALVO BUEN COBRO'||chr(13)||chr(10)||
                 ' ESTE COMPROBANTE SERA VALIDO CON EL SELLO Y FIRMA DEL CAJERO'||chr(13)||chr(10)||
		 '      '||rtrim(psucursal)||' - '||pusuarioid||chr(13)||chr(10);
     l := l+4;
   else
     if l < 19 then
       for f in l..17
       loop
          pformato := pformato||chr(13)||chr(10);
	  l:= l+1;
       end loop;
       pformato := pformato||' LOS DOCUMENTOS  DEPOSITADOS  SON  ACEPTADOS SALVO BUEN COBRO'||chr(13)||chr(10)||
                   ' ESTE COMPROBANTE SERA VALIDO CON EL SELLO Y FIRMA DEL CAJERO'||chr(13)||chr(10)||
		   '      '||rtrim(psucursal)||' - '||pusuarioid||chr(13)||chr(10);    
       l := l+3;
     else
        if l = 19 then
          pformato := pformato||' LOS DOCUMENTOS  DEPOSITADOS  SON  ACEPTADOS SALVO BUEN COBRO'||chr(13)||chr(10)||
                   ' ESTE COMPROBANTE SERA VALIDO CON EL SELLO Y FIRMA DEL CAJERO'||chr(13)||chr(10);
	  l := l+2;
        else
	  if l = 20 then
             pformato := pformato||'     '||rtrim(psucursal)||' - '||rtrim(pusuarioid)||
	                 lpad('_________________________',50-length('     '||rtrim(psucursal)||' - '||rtrim(pusuarioid)))||chr(13)||chr(10);
	     l := l+1;         
	  else
             pformato := pformato||ptexto1||' LOS DOCUMENTOS  DEPOSITADOS  SON  ACEPTADOS SALVO BUEN COBRO'||chr(13)||chr(10)||
                         ' ESTE COMPROBANTE SERA VALIDO CON EL SELLO Y FIRMA DEL CAJERO'||chr(13)||chr(10)||
		         '      '||rtrim(psucursal)||' - '||pusuarioid||chr(13)||chr(10);    	  
	  end if;
        end if;
     end if;
   end if;     

--  raise notice 'Final %',l;

   pformato := pformato||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10);

return pformato;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spfolio(integer, character) OWNER TO sistema;

--
-- Name: spfolio(integer, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spfolio(integer, character, integer) RETURNS text
    AS $_$
declare
  preferenciacaja alias for $1;
  pseriecaja alias for $2;
  pconsaldos alias for $3;

  pformato text;

begin

  select * into pformato from spfolio(preferenciacaja,pseriecaja);

  return pformato;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spfolio(integer, character, integer) OWNER TO sistema;

--
-- Name: spfoliopromo(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spfoliopromo(integer, character) RETURNS text
    AS $_$
declare
  preferenciacaja alias for $1;
  pseriecaja alias for $2;
        
  pformato text;
  ptexto text;
  ptexto1 text;

  r record;
  x record;

  plineasiniciales integer;
  pnombrecaja char(80);
  prfccaja char(20);
  pdescripcion char(29);
  pdireccioncaja char(100);
 sucursal char(4); 
 pcuentacaja char(24);
  pusuarioid char(20);
  preferenciaprestamo char(18);
  psaldoprestamo numeric;
  psocio integer;

  fmontoprestamo numeric;

  i integer;
  l integer;
  subtotal numeric;

  fcapital numeric;
  fnormal numeric;
  fmoratorio numeric;
  fiva numeric;
  ftotal numeric;
  fisr numeric;
  dfecha date;
  pencabezado integer;
  psucursal char(10);
  supago numeric;
  esefectivo text;

  tepago numeric;
  tecomision numeric;
  teivacomision numeric;
  
begin

  pformato := '';
  subtotal := 0;
  
  fcapital := 0;
  fnormal := 0;
  fmoratorio := 0;
  fiva := 0;
  pencabezado := 0;
 
  select lineasiniciales, nombrecaja, rfccaja, direccioncaja, sucid
    into plineasiniciales, pnombrecaja, prfccaja, pdireccioncaja, sucursal
    from empresa;


  plineasiniciales := coalesce(plineasiniciales,0);
  pnombrecaja := coalesce(pnombrecaja,' ');
  prfccaja := coalesce(prfccaja,' ');  
  pdireccioncaja := coalesce(pdireccioncaja,' ');

 select cuentacaja, usuarioid
   into pcuentacaja, pusuarioid
   from parametros
  where serie_user = pseriecaja;

 select distinct(m.socioid), p.fechapoliza
   into psocio, dfecha
   from movicaja m, polizas p
  where referenciacaja = preferenciacaja and
        seriecaja = pseriecaja and
        p.polizaid = m.polizaid;
	
 select (current_schemas(false))[2]
   into psucursal;



  for i in 1..plineasiniciales
    loop
      pformato := pformato||chr(13)||chr(10);
    end loop;  

  select
chr(13)||chr(10)
||chr(13)||chr(10)
||chr(13)||chr(10)
||chr(13)||chr(10)
||chr(13)||chr(10)
||chr(13)||chr(15)
        ||'FOLIO:    ' ||alineacero(ltrim(to_char(m.referenciacaja,'999999')))||lpad('CAJA: ',30,' ')||'  '||sucursal||chr(13)||chr(10)||
	'SOCIO:    '||s.clavesocioint||lpad('CAJERA: ',20,' ')||pusuarioid ||' '||to_char(p.fechapoliza,'dd/mm/yyyy')||'  '||to_char( now(), 'HH24:MI:SS')||chr(13)||chr(10)||
	'NOMBRE:   '||rtrim(su.nombre)||' '||rtrim(su.paterno)||' '||rtrim(su.materno)|| ' Tipo Socio:'|| s.tiposocioid ||chr(13)||chr(10)||chr(13)||
	lpad('DESCRIPCION DEL MOVIMIENTO',50,' ')||chr(13)||chr(10)||
'========================================================================'||chr(13)||chr(10)
   into ptexto1
   from movicaja m, polizas p, socio s,sujeto su,domicilio d
  where m.referenciacaja = preferenciacaja and
        m.seriecaja = pseriecaja and
        p.polizaid = m.polizaid and
        s.socioid = m.socioid and
        su.sujetoid = s.sujetoid and
	su.sujetoid = d.sujetoid;	
	
  pformato := pformato||ptexto1;

 l := 7;

--raise notice 'Encabezado %',l;

  pencabezado = 0;
  -- Movimientos

  for r in

  select m.tipomovimientoid, t.desctipomovimiento, (mp.debe-mp.haber) as cantidad, mp.descripcion, m.polizaid
    from movicaja m, polizas p, movipolizas mp, tipomovimiento t
   where m.referenciacaja = preferenciacaja and
         m.seriecaja = pseriecaja and
         m.tipomovimientoid <> '00' and
         m.tipomovimientoid <> 'IN' and
         p.polizaid = m.polizaid and
         mp.polizaid = p.polizaid and
         mp.movipolizaid = m.movipolizaid and
         t.tipomovimientoid = m.tipomovimientoid

     loop
          if pencabezado = 0 then
	     if l >= 21 then
	        pformato := pformato||chr(13)||chr(10)||ptexto1;
	        l := 7;
	     else
--                pformato := pformato||chr(13)||chr(10);
	     end if;
	     l := l+1;
             pencabezado := 1;     	  	  
	    end if;

--           select descripcion into pdescripcion from movipolizas where polizaid=r.polizaid and cuentaid=pcuentacaja and ( haber = r.cantidad or debe = r.cantidad);
          pdescripcion := coalesce(r.descripcion,' ');

--          pdescripcion := coalesce(pdescripcion,' ');
          if substr(pdescripcion,1,14)='Poliza Aut. de' then
             pdescripcion:= ' ';
	  end if;

		if r.tipomovimientoid = 'RE' then
             ptexto := '';
	  end if;

          if (r.tipomovimientoid = 'PR' or r.tipomovimientoid = 'AH') and  r.tipomovimientoid <> 'RE' then

             ptexto := 'MOVIMIENTO DEPOSITADO EN '||r.tipomovimientoid||': '||rpad(r.desctipomovimiento,29,' ')--||chr(13)--||chr(10)
                    ||rpad(pdescripcion,0,' ')||lpad(to_char(r.cantidad,'99,999.99'),10,' ')||chr(13)||chr(10);
	  end if;
                

          if r.tipomovimientoid <> 'PR' and r.tipomovimientoid <> 'AH' and r.tipomovimientoid <> 'RE' then
                    ptexto := 'MOVIMIENTO APLICADO   EN '||r.tipomovimientoid||': '||rpad(r.desctipomovimiento,29,' ')--||chr(13)||chr(10)
                    ||rpad(pdescripcion,0,' ')||lpad(to_char(r.cantidad,'99,999.99'),10,' ')||chr(13)||chr(10);
          end if;

          
      subtotal := subtotal+r.cantidad;
	  if l >= 21 then
	     pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||ptexto;
	     l := 8;
	  else
             pformato := pformato||ptexto;
	  end if;
          l := l+1;	  

     end loop;

  pencabezado := 0;

-- Total
   if pencabezado <> 5 then
     ptexto := lpad('T O T A L:           ',49,' ')||'   '||to_char(subtotal,'$999,999,999.99')||chr(13)||chr(10);
     if l >= 21 then
        pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||ptexto||
                    'Saldos en movimientos:'||chr(13)||chr(10);
        l := 8;
     else
        pformato := pformato||ptexto||
                    'Saldos en movimientos:'||chr(13)||chr(10);
     end if;
     l := l+2;
   end if;

--  raise notice 'Total %',l;

-- Saldos
   for r in
      select * from spssaldosmovf(psocio,dfecha)
   loop        
         ptexto := '          '||rpad(r.desctipomovimiento,32,' ')||'          '||
                   to_char(r.saldo,'$999,999,999.99')||chr(13)||chr(10);
         --if l >= 21 then
            --if r.saldo > 0 then
               --pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||ptexto;
            --end if;
             --l := 8;
        -- else
             if r.saldo > 0 then
                pformato := pformato||ptexto;
             end if;
         --end if;		   
	 l := l+1;
      
   end loop;
   
--  raise notice 'Saldos %',l;   


-- FORMA DE PAGO
   if pencabezado <> 5 then
         select sum(valor)
	   into supago
	   from sabana
	  where referenciacaja = preferenciacaja and 
	        seriecaja = pseriecaja and
		entradasalida=0;
		
	 supago := coalesce(supago,subtotal);
	 
	 select efectivo
	   into esefectivo
	   from sabana s, denominacion d
	  where s.referenciacaja = preferenciacaja and 
	        s.seriecaja = pseriecaja and
		s.entradasalida=0 and
		d.denominacionid=s.denominacionid;
         if esefectivo is not null then
            if esefectivo = '1' then
	         esefectivo = 'EFECTIVO';
	      else
	         esefectivo = 'CHEQUE';
	      end if;
         else
	    esefectivo = 'EFECTIVO';
	 end if;
         		
            ptexto := chr(13)||chr(10)||'   TOTAL A PAGAR '||to_char(subtotal,'$999,999.99')||
                      chr(13)||chr(10)||'   SU PAGO       '||to_char(supago,'$999,999.99')||
                      chr(13)||chr(10)||'   SU CAMBIO     '||to_char(supago-subtotal,'$999,999.99')||
                      chr(13)||chr(10)||'   PAGO CON          '||esefectivo||chr(13)||chr(10);

        -- if l >= 21 then
           --  pformato := pformato||chr(13)||chr(10)||ptexto1||chr(13)||chr(10)||ptexto;
             --l := 8;
         --else
             pformato := pformato||ptexto;
         --end if;		   
	 l := l+1;      	       
    end if;

-- Usuario y Sucursal
   if l = 17 then
     pformato := pformato||chr(13)||chr(10)||
                 ' LOS DOCUMENTOS  DEPOSITADOS  SON  ACEPTADOS SALVO BUEN COBRO'||chr(13)||chr(10)||
                 ' ESTE COMPROBANTE SERA VALIDO CON EL SELLO Y FIRMA DEL CAJERO'||chr(13)||chr(10)||
		 '      '||rtrim(psucursal)||' - '||pusuarioid||chr(13)||chr(10);
     l := l+4;
   else
     if l < 19 then
       for f in l..17
       loop
          pformato := pformato||chr(13)||chr(10);
	  l:= l+1;
       end loop;
       pformato := pformato||' LOS DOCUMENTOS  DEPOSITADOS  SON  ACEPTADOS SALVO BUEN COBRO'||chr(13)||chr(10)||
                   ' ESTE COMPROBANTE SERA VALIDO CON EL SELLO Y FIRMA DEL CAJERO'||chr(13)||chr(10)||
		   '      '||rtrim(psucursal)||' - '||pusuarioid||chr(13)||chr(10);    
       l := l+3;
     else
        if l = 19 then
          pformato := pformato||' LOS DOCUMENTOS  DEPOSITADOS  SON  ACEPTADOS SALVO BUEN COBRO'||chr(13)||chr(10)||
                   ' ESTE COMPROBANTE SERA VALIDO CON EL SELLO Y FIRMA DEL CAJERO'||chr(13)||chr(10);
	  l := l+2;
        else
	  if l = 20 then
             pformato := pformato||'     '||rtrim(psucursal)||' - '||rtrim(pusuarioid)||
	                 lpad('_________________________',50-length('     '||rtrim(psucursal)||' - '||rtrim(pusuarioid)))||chr(13)||chr(10);
	     l := l+1;         
	  else
             pformato := pformato/**/||chr(13)||chr(10)/*||ptexto1*/||' LOS DOCUMENTOS  DEPOSITADOS  SON  ACEPTADOS SALVO BUEN COBRO'||chr(13)||chr(10)||
                         ' ESTE COMPROBANTE SERA VALIDO CON EL SELLO Y FIRMA DEL CAJERO'||chr(13)||chr(10)||
		         '      '||rtrim(psucursal)||' - '||pusuarioid||chr(13)||chr(10);    	  
	  end if;
        end if;
     end if;
   end if;     

--  raise notice 'Final %',l;

   pformato := pformato||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10)||chr(13)||chr(10);

return pformato;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spfoliopromo(integer, character) OWNER TO sistema;

--
-- Name: spgeneravisos(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spgeneravisos(date) RETURNS SETOF ravisos
    AS $_$
declare
  pfecha alias for $1;
  r ravisos%rowtype;
  rec record;

  lavisoid int4;
  iamortizacionesvencidas int4;
  fcapitalvencido numeric;
  finteresvencido numeric;
  fmoratorio numeric;
  fiva numeric;

  iExiste int4;

  igenerados int4;

  iavisoxamortiza int4;

  fimpamortizacion numeric;

begin

    select avisoxamortiza into iavisoxamortiza from empresa where empresaid=1;

    select count(*) into igenerados from aviso where fechaenvio=pfecha;
    igenerados:=coalesce(igenerados,0);
    if igenerados>0 then
      raise exception 'Los avisos para esta fecha ya fueron generados anteriormente !!';
    end if;

if iavisoxamortiza=0 then

    --
    --  Generar avisos por dias vencidos
    --
    --  Solo generar para los no pagados con estatus de credito 001 y que no tengan convenio vigente
    --  y que no tengan un aviso del mismo tipo 1 Vigente o 2 Contestado
    FOR rec IN
    SELECT p.prestamoid, p.diasatraso, ta.tipoavisoid, p.clavesocioint, p.nombre as nombresocio, pr.referenciaprestamo,
	   ta.descripciontipoaviso, p.tipoprestamo,p.capital,p.interes,p.moratorio,p.iva,p.vencidas
      FROM carteracomunidadfecha p, prestamos pr,
	   tipoaviso ta	  
     WHERE p.fechadegeneracion=pfecha and p.diasatraso BETWEEN ta.diainicial
       AND ta.diafinal
       and p.prestamoid=pr.prestamoid
       AND pr.claveestadocredito = '001'
       AND NOT
    EXISTS ( SELECT c.prestamoid
	       FROM convenio c
	      WHERE c.prestamoid = p.prestamoid
	        AND c.vigente = 'S' )
       AND NOT
    EXISTS ( SELECT a.prestamoid
	       FROM aviso a
	      WHERE a.prestamoid = p.prestamoid
	        AND a.tipoavisoid = ta.tipoavisoid
	        AND ( a.estatusaviso = 'X' OR a.estatusaviso = 'X' ) )
          LOOP

                finteresvencido := rec.interes + rec.moratorio + rec.iva;
        	finteresvencido := COALESCE ( rec.interes, 0 );
        	fcapitalvencido := COALESCE ( rec.capital, 0 );
        	iamortizacionesvencidas := COALESCE ( rec.vencidas, 0 );

	   
		-- Generar aviso         
		SELECT *
		  INTO lavisoid
		  FROM spiaviso ( rec.tipoavisoid,
				  rec.prestamoid,
				  pfecha,
				  NULL,
				  rec.diasatraso,
				  iamortizacionesvencidas,
				  fcapitalvencido,
				  finteresvencido,
				  NULL,
				  '1' );

		r.avisoid := lavisoid;
		r.tipoavisoid := rec.tipoavisoid;
		r.prestamoid := rec.prestamoid;
		r.fechaenvio := pfecha;
		--r.fechacontestacion      := NULL;
		r.diasatrasoprestamo := rec.diasatraso;
		r.amortizacionesvencidas := iamortizacionesvencidas;
		r.capitalvencido := fcapitalvencido;
		r.interesvencido := finteresvencido;
		--r.observacionaviso       := NULL;
		r.estatusaviso := '1';
		r.clavesocioint := rec.clavesocioint;
		r.nombresocio := rec.nombresocio;
		r.referenciaprestamo := rec.referenciaprestamo;
		r.descripciontipoaviso := rec.descripciontipoaviso;
		RETURN NEXT r;

        END LOOP;

else


    --
    --  Generar avisos por amortizaciones
    --
    --  Solo generar para los no pagados con estatus de credito 001 y que no tengan convenio vigente
    --  y que no tengan un aviso del mismo tipo 1 Vigente o 2 Contestado
    FOR rec IN
    SELECT p.prestamoid,p.diasatraso, ta.tipoavisoid, p.clavesocioint, p.nombre as nombresocio, pr.referenciaprestamo,
	   ta.descripciontipoaviso, p.tipoprestamo,p.capital,p.interes,p.moratorio,p.iva,p.vencidas
      FROM carteracomunidadfecha p, prestamos pr,
	   tipoaviso ta
     WHERE p.fechadegeneracion=pfecha and p.vencidas BETWEEN ta.diainicial
       AND ta.diafinal
       and p.prestamoid=pr.prestamoid
       AND pr.claveestadocredito = '001'
       AND NOT
    EXISTS ( SELECT c.prestamoid
	       FROM convenio c
	      WHERE c.prestamoid = p.prestamoid
	        AND c.vigente = 'S' )
       AND NOT
    EXISTS ( SELECT a.prestamoid
	       FROM aviso a
	      WHERE a.prestamoid = p.prestamoid
	        AND a.tipoavisoid = ta.tipoavisoid
	        AND ( a.estatusaviso = 'X' OR a.estatusaviso = 'X' ) )
          LOOP

                finteresvencido := rec.interes + rec.moratorio + rec.iva;
        	finteresvencido := COALESCE ( rec.interes, 0 );
        	fcapitalvencido := COALESCE ( rec.capital, 0 );
        	iamortizacionesvencidas := COALESCE ( rec.vencidas, 0 );

	   
		-- Generar aviso         
		SELECT *
		  INTO lavisoid
		  FROM spiaviso ( rec.tipoavisoid,
				  rec.prestamoid,
				  pfecha,
				  NULL,
				  rec.diasatraso,
				  iamortizacionesvencidas,
				  fcapitalvencido,
				  finteresvencido,
				  NULL,
				  '1' );

		r.avisoid := lavisoid;
		r.tipoavisoid := rec.tipoavisoid;
		r.prestamoid := rec.prestamoid;
		r.fechaenvio := pfecha;
		--r.fechacontestacion      := NULL;
		r.diasatrasoprestamo := rec.diasatraso;
		r.amortizacionesvencidas := iamortizacionesvencidas;
		r.capitalvencido := fcapitalvencido;
		r.interesvencido := finteresvencido;
		--r.observacionaviso       := NULL;
		r.estatusaviso := '1';
		r.clavesocioint := rec.clavesocioint;
		r.nombresocio := rec.nombresocio;
		r.referenciaprestamo := rec.referenciaprestamo;
		r.descripciontipoaviso := rec.descripciontipoaviso;
		RETURN NEXT r;

        END LOOP;


end if;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spgeneravisos(date) OWNER TO sistema;

--
-- Name: spiactivo(integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, numeric, date, character, numeric, numeric, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiactivo(integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, numeric, date, character, numeric, numeric, numeric, numeric) RETURNS integer
    AS $_$
declare
  pdepreciacionid alias for $1;
  pactivoclave alias for $2;
  pactivodescripcion alias for $3;
  pactivo_valor alias for $4;
  pporcenvidautil alias for $5;
  pvalormercado alias for $6;
  plocalizacion alias for $7;
  pactivonoserie alias for $8;
  pfeciniciodepconta alias for $9;
  pactivotasaconta alias for $10;
  pactdepreacumconta alias for $11;
  pactmetododepreconta alias for $12;
  pfeciniciodepfiscal alias for $13;
  pactdeduccioninme alias for $14;
  pactivotasafiscal alias for $15;
  pactdepreacumfiscal alias for $16;
  pactmetododeprefiscal alias for $17;
  pactmonmaxdedufiscal alias for $18;

begin

   insert into activos(depreciacionid,activoclave,activodescripcion,activo_valor,porcenvidautil,valormercado,localizacion,activonoserie,feciniciodepconta,activotasaconta,actdepreacumconta,actmetododepreconta,feciniciodepfiscal,actdeduccioninme,activotasafiscal,actdepreacumfiscal,actmetododeprefiscal,actmonmaxdedufiscal)

    values( pdepreciacionid,
            pactivoclave,
            pactivodescripcion,
            pactivo_valor,
            pporcenvidautil,
            pvalormercado,
            plocalizacion,
            pactivonoserie,
            pfeciniciodepconta,
            pactivotasaconta,
            pactdepreacumconta,
            pactmetododepreconta,
            pfeciniciodepfiscal,
            pactdeduccioninme,
            pactivotasafiscal,
            pactdepreacumfiscal,
            pactmetododeprefiscal,
            pactmonmaxdedufiscal);

return currval('activos_activoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiactivo(integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, numeric, date, character, numeric, numeric, numeric, numeric) OWNER TO sistema;

--
-- Name: spiactivo(integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, integer, date, character, numeric, numeric, integer, numeric, numeric, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiactivo(integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, integer, date, character, numeric, numeric, integer, numeric, numeric, character, integer) RETURNS integer
    AS $_$
declare
  pdepreciacionid alias for $1;
  pactivoclave alias for $2;
  pactivodescripcion alias for $3;
  pactivo_valor alias for $4;
  pporcenvidautil alias for $5;
  pvalormercado alias for $6;
  plocalizacion alias for $7;
  pactivonoserie alias for $8;
  pfeciniciodepconta alias for $9;
  pactivotasaconta alias for $10;
  pactdepreacumconta alias for $11;
  pactmetododepreconta alias for $12;
  pfeciniciodepfiscal alias for $13;
  pactdeduccioninme alias for $14;
  pactivotasafiscal alias for $15;
  pactdepreacumfiscal alias for $16;
  pactmetododeprefiscal alias for $17;
  pactmonmaxdedufiscal alias for $18;
  pmontooriginal alias for $19;
  pmonedaid alias for $20;
  pdepartamento alias for $21;

begin

   insert into activos(depreciacionid,activoclave,activodescripcion,activo_valor,porcenvidautil,valormercado,localizacion,activonoserie,feciniciodepconta,activotasaconta,actdepreacumconta,actmetododepreconta,feciniciodepfiscal,actdeduccioninme,activotasafiscal,actdepreacumfiscal,actmetododeprefiscal,actmonmaxdedufiscal,montooriginal,monedaid,departamento)

    values( pdepreciacionid,
            pactivoclave,
            pactivodescripcion,
            pactivo_valor,
            pporcenvidautil,
            pvalormercado,
            plocalizacion,
            pactivonoserie,
            pfeciniciodepconta,
            pactivotasaconta,
            pactdepreacumconta,
            pactmetododepreconta,
            pfeciniciodepfiscal,
            pactdeduccioninme,
            pactivotasafiscal,
            pactdepreacumfiscal,
            pactmetododeprefiscal,
            pactmonmaxdedufiscal,
            pmontooriginal,
            pmonedaid,
            pdepartamento);

return currval('activos_activoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiactivo(integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, integer, date, character, numeric, numeric, integer, numeric, numeric, character, integer) OWNER TO sistema;

--
-- Name: spialertapdl(integer, integer, character, character, numeric, character, date, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spialertapdl(integer, integer, character, character, numeric, character, date, date, character) RETURNS integer
    AS $_$
declare
  pmovicajaid alias for $1;
  psocioid alias for $2;
  pclavesocioint alias for $3;
  ptipomovimientoid alias for $4;
  pmonto alias for $5;
  pobservaciones alias for $6;
  pfecha_operacion alias for $7;
  pfecha_deteccion alias for $8;
  padministrar alias for $9;

begin

  if exists (select alertaid from alertasprevencion where movicajaid=pmovicajaid) then

     update alertasprevencion set movicajaid=pmovicajaid, socioid=psocioid, clavesocioint=pclavesocioint,tipomovimientoid=ptipomovimientoid, monto=pmonto,observaciones=pobservaciones, fecha_operacion=pfecha_operacion, fecha_deteccion=pfecha_deteccion,administrar=padministrar where movicajaid=pmovicajaid;

  else
       
     insert into alertasprevencion(movicajaid,socioid,clavesocioint,tipomovimientoid,monto,observaciones,fecha_operacion,fecha_deteccion,administrar) values (pmovicajaid,psocioid,pclavesocioint,ptipomovimientoid,pmonto,pobservaciones,pfecha_operacion,pfecha_deteccion,'N');
   
  end if;
            
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spialertapdl(integer, integer, character, character, numeric, character, date, date, character) OWNER TO sistema;

--
-- Name: spiamortizacion(integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiamortizacion(integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date) RETURNS integer
    AS $_$
declare
  pnumprestamo alias for $1;
  pnumamortizacion alias for $2;
  pfechadepago alias for $3;
  pimporteamortizacion alias for $4;
  pinteresnormal alias for $5;
  psaldo_absoluto alias for $6;
  pestatusamortizacion alias for $7;
  pinterespagado alias for $8;
  pabonopagado alias for $9;
  pultimoabono alias for $10;

begin

   insert into amortizaciones(prestamoid,numamortizacion,fechadepago,importeamortizacion,interesnormal,saldo_absoluto,interespagado,abonopagado,ultimoabono,claveestadocredito)
    values( pnumprestamo,
            pnumamortizacion,
            pfechadepago,
            pimporteamortizacion,
            pinteresnormal,
            psaldo_absoluto,
            pinterespagado,
            pabonopagado,
            pultimoabono,
            pestatusamortizacion);

return currval('amortizaciones_amortizacionid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiamortizacion(integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date) OWNER TO sistema;

--
-- Name: spiamortizacion(integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiamortizacion(integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date, numeric, numeric) RETURNS integer
    AS $_$
declare
  pnumprestamo alias for $1;
  pnumamortizacion alias for $2;
  pfechadepago alias for $3;
  pimporteamortizacion alias for $4;
  pinteresnormal alias for $5;
  psaldo_absoluto alias for $6;
  pestatusamortizacion alias for $7;
  pinterespagado alias for $8;
  pabonopagado alias for $9;
  pultimoabono alias for $10;
  piva alias for $11;
  ptotalpago alias for $12;

begin

   insert into amortizaciones(prestamoid,numamortizacion,fechadepago,importeamortizacion,interesnormal,saldo_absoluto,interespagado,abonopagado,ultimoabono,claveestadocredito,iva,totalpago)
    values( pnumprestamo,
            pnumamortizacion,
            pfechadepago,
            pimporteamortizacion,
            pinteresnormal,
            psaldo_absoluto,
            pinterespagado,
            pabonopagado,
            pultimoabono,
            pestatusamortizacion,
            piva,
            ptotalpago);

return currval('amortizaciones_amortizacionid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiamortizacion(integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date, numeric, numeric) OWNER TO sistema;

--
-- Name: spiamortizacion(integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date, numeric, numeric, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiamortizacion(integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date, numeric, numeric, numeric, numeric) RETURNS integer
    AS $_$
declare
  pnumprestamo alias for $1;
  pnumamortizacion alias for $2;
  pfechadepago alias for $3;
  pimporteamortizacion alias for $4;
  pinteresnormal alias for $5;
  psaldo_absoluto alias for $6;
  pestatusamortizacion alias for $7;
  pinterespagado alias for $8;
  pabonopagado alias for $9;
  pultimoabono alias for $10;
  piva alias for $11;
  ptotalpago alias for $12;
  pahorro alias for $13;
  pseguro alias for $14;
  
begin

   insert into amortizaciones(prestamoid,numamortizacion,fechadepago,importeamortizacion,interesnormal,saldo_absoluto,interespagado,abonopagado,ultimoabono,claveestadocredito,iva,totalpago,ahorro,seguro)
    values( pnumprestamo,
            pnumamortizacion,
            pfechadepago,
            pimporteamortizacion,
            pinteresnormal,
            psaldo_absoluto,
            pinterespagado,
            pabonopagado,
            pultimoabono,
            pestatusamortizacion,
            piva,
            ptotalpago,pahorro,pseguro);

return currval('amortizaciones_amortizacionid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiamortizacion(integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date, numeric, numeric, numeric, numeric) OWNER TO sistema;

--
-- Name: spiasamblea(integer, date, character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiasamblea(integer, date, character, character varying) RETURNS integer
    AS $_$
declare
  psocioid alias for $1;
  pfechaasistencia alias for $2;
  pespartecomite alias for $3;
  ppuestoocupado alias for $4;  
begin

   insert into domicilio(socioid,fechaasamblea,espartecomite,puestoocupado)
    values( psocioid,
            pfechaasistencia,
            pespartecomite,
            ppuestoocupado);
            
return currval('asamblea_asambleaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiasamblea(integer, date, character, character varying) OWNER TO sistema;

--
-- Name: spiasesor(integer, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiasesor(integer, character varying) RETURNS integer
    AS $_$
declare
  pasesorid alias for $1;
  pnomasesor alias for $2;
begin

   insert into asesor(nomasesor)
    values( pnomasesor);
            

return currval('asesor_asesorid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiasesor(integer, character varying) OWNER TO sistema;

--
-- Name: spiaval(integer, integer, integer, numeric, character varying, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiaval(integer, integer, integer, numeric, character varying, integer, integer) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;
  psocioid alias for $2;
  psujetoid alias for $3;
  pporcentajeavala alias for $4;
  prelacionconsocio alias for $5;
  pessobreprestamo alias for $6;
  pnoaval alias for $7;

  avala integer;

  preferenciaprestamo char(18);
  lsocioid int4;
begin

-- Validar que el aval no se encuentre en mas de 2 prestamos activos

   select count(*) into avala
     from prestamos p,avales a
    where a.sujetoid = psujetoid and
          p.prestamoid = a.prestamoid and
          p.saldoprestamo>0 and
          p.claveestadocredito='001';

   -- Ojo no tomo sobreprestamos
   if pessobreprestamo=0 then   
     avala := coalesce(avala,0);
     if avala>=2 then
       raise exception 'El Aval ya avala a % prestamos activos, no se puede ser aval de otro prestamo.',avala;
     end if;
   end if;

   select socioid
     into lsocioid
     from socio
    where sujetoid = psujetoid;

   lsocioid := coalesce(lsocioid,0);

   if lsocioid>0 then
     insert into avales(prestamoid,socioid,sujetoid,porcentajeavala,relacionconsocio,noaval)
      values( pprestamoid,
              lsocioid,
              psujetoid,
              pporcentajeavala,
              prelacionconsocio,
              pnoaval);
   else
     insert into avales(prestamoid,socioid,sujetoid,porcentajeavala,relacionconsocio,noaval)
      values( pprestamoid,
              psocioid,
              psujetoid,
              pporcentajeavala,
              prelacionconsocio,
              pnoaval);
   end if;

return currval('avales_avalid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiaval(integer, integer, integer, numeric, character varying, integer, integer) OWNER TO sistema;

--
-- Name: spiaval(integer, integer, integer, numeric, character varying, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiaval(integer, integer, integer, numeric, character varying, integer, integer, integer) RETURNS integer
    AS $_$
declare
  pprestamoid alias for $1;
  psocioid alias for $2;
  psujetoid alias for $3;
  pporcentajeavala alias for $4;
  prelacionconsocio alias for $5;
  pessobreprestamo alias for $6;
  pnoaval alias for $7;
  psolicitudprestamoid alias for $8;

  avala integer;

  preferenciaprestamo char(18);
  lsocioid int4;

  iavalesc int4;

  snombre char(40);
  spaterno char(20);
  smaterno char(20);
  srfc char(16);


  inoavalesxprestamo int4;
  lavalid int4;

  laval int4;
begin

   select noavalesxprestamo
     into inoavalesxprestamo
    from empresa where empresaid=1;

-- Validar que el aval no se encuentre en mas de 2 prestamos activos

   select count(*) into avala
     from prestamos p,avales a
    where a.sujetoid = psujetoid and
          p.prestamoid = a.prestamoid and
          p.saldoprestamo>0 and
          p.claveestadocredito='001';

   -- Ojo no tomo sobreprestamos
   if pessobreprestamo=0 then   
     avala := coalesce(avala,0);
     if avala>=inoavalesxprestamo then
       raise exception 'El Aval ya avala a % prestamos activos, no se puede ser aval de otro prestamo.',avala;
     end if;

     -- Checar en las demas sucursales
     select nombre,paterno,materno,rfc
       into snombre,spaterno,smaterno,srfc
       from sujeto
      where sujetoid = psujetoid;


--     select count(*)
--       into iavalesc
--       from spsavalac(snombre,spaterno,smaterno,srfc);

     iavalesc:=coalesce(iavalesc,0);

     if iavalesc>=inoavalesxprestamo then
       raise exception 'El Aval ya avala a % prestamos activos, no se puede ser aval de otro prestamo.',iavalesc;
     end if;         

   end if;

   if psocioid is null then
     select socioid
       into lsocioid
       from socio
      where sujetoid = psujetoid;
 
     lsocioid := coalesce(lsocioid,0);
   else
     lsocioid := psocioid;     
   end if;

        
   if psolicitudprestamoid is not null then
   select avalid into laval
     from avales where solicitudprestamoid=psolicitudprestamoid and sujetoid=psujetoid;
   else
     select avalid into laval
     from avales where prestamoid=pprestamoid and sujetoid=psujetoid;
   end if;
   laval:=coalesce(laval,0);

   if laval=0 then

     if lsocioid>0 then
       insert into avales(prestamoid,
                        socioid,
                        sujetoid,
                        porcentajeavala,
                        relacionconsocio,
                        noaval,
                        solicitudprestamoid)
        values( pprestamoid,
              lsocioid,
              psujetoid,
              pporcentajeavala,
              prelacionconsocio,
              pnoaval,
              psolicitudprestamoid);
     else
       insert into avales(prestamoid,
                        socioid,
                        sujetoid,
                        porcentajeavala,
                        relacionconsocio,
                        noaval,
                        solicitudprestamoid)
        values( pprestamoid,
              psocioid,
              psujetoid,
              pporcentajeavala,
              prelacionconsocio,
              pnoaval,
              psolicitudprestamoid);
     end if;
     return currval('avales_avalid_seq');
   else

     
     update avales
        set prestamoid=pprestamoid,
            porcentajeavala=pporcentajeavala,
            relacionconsocio=prelacionconsocio,
            noaval=pnoaval
      where avalid=laval;

      lavalid:=laval;
   end if;


return lavalid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiaval(integer, integer, integer, numeric, character varying, integer, integer, integer) OWNER TO sistema;

--
-- Name: spiaviso(integer, integer, date, date, integer, integer, numeric, numeric, text, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiaviso(integer, integer, date, date, integer, integer, numeric, numeric, text, character) RETURNS integer
    AS $_$
declare

  ptipoavisoid            alias for $1;
  pprestamoid             alias for $2;
  pfechaenvio             alias for $3;
  pfechacontestacion      alias for $4;
  pdiasatrasoprestamo     alias for $5;
  pamortizacionesvencidas alias for $6;
  pcapitalvencido         alias for $7;
  pinteresvencido         alias for $8;
  pobservacionaviso       alias for $9;
  pestatusaviso           alias for $10;

begin

   insert into aviso(tipoavisoid,prestamoid,fechaenvio,fechacontestacion,diasatrasoprestamo,
                     amortizacionesvencidas,capitalvencido,interesvencido,observacionaviso,estatusaviso)
    values( ptipoavisoid,pprestamoid,pfechaenvio,pfechacontestacion,pdiasatrasoprestamo,
            pamortizacionesvencidas,pcapitalvencido,pinteresvencido,pobservacionaviso,pestatusaviso );

return currval('aviso_avisoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiaviso(integer, integer, date, date, integer, integer, numeric, numeric, text, character) OWNER TO sistema;

--
-- Name: spibanco(character, character varying, date, numeric, numeric, numeric, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spibanco(character, character varying, date, numeric, numeric, numeric, character, character, integer) RETURNS character
    AS $_$
declare
  pno_cuenta alias for $1;
  pbanco alias for $2;
  pfecha_inicio alias for $3;
  psaldo_inicial alias for $4;
  psaldo_actual alias for $5;
  psaldo_pen alias for $6;
  pcuentaid alias for $7;
  pseriebanco alias for $8;
  pnocheque alias for $9;

begin

   insert into bancos (no_cuenta,banco,fecha_inicio,saldo_inicial,saldo_actual,saldo_pen,cuentaid,seriebanco,nocheque)
    values( pno_cuenta,
            pbanco,
            pfecha_inicio,
            round(psaldo_inicial,2),
            round(psaldo_actual,2),
            round(psaldo_pen,2),
            pcuentaid,
            pseriebanco,
            pnocheque);
            

return pno_cuenta;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spibanco(character, character varying, date, numeric, numeric, numeric, character, character, integer) OWNER TO sistema;

--
-- Name: spibeneficiario(integer, integer, integer, character varying, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spibeneficiario(integer, integer, integer, character varying, numeric) RETURNS integer
    AS $_$
declare
  pinversionid alias for $1;
  psocioid alias for $2;
  psujetoid alias for $3;
  pparentesco alias for $4;
  pporcentajebeneficiario alias for $5;
 
begin

   insert into beneficiario(inversionid,socioid,sujetoid,parentesco,porcentajebeneficiario)
    values( pinversionid,
            psocioid,
            psujetoid,
            pparentesco,
            pporcentajebeneficiario);

return currval('beneficiario_beneficiarioid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spibeneficiario(integer, integer, integer, character varying, numeric) OWNER TO sistema;

--
-- Name: spibeneficiario(integer, integer, integer, character varying, numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spibeneficiario(integer, integer, integer, character varying, numeric, integer) RETURNS integer
    AS $_$
declare
  pinversionid alias for $1;
  psocioid alias for $2;
  psujetoid alias for $3;
  pparentesco alias for $4;
  pporcentajebeneficiario alias for $5;
  pcontratoid alias for $6;
 
begin

   insert into beneficiario(inversionid,socioid,sujetoid,parentesco,porcentajebeneficiario,contratoid)
    values( pinversionid,
            psocioid,
            psujetoid,
            pparentesco,
            pporcentajebeneficiario,
            pcontratoid);

return currval('beneficiario_beneficiarioid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spibeneficiario(integer, integer, integer, character varying, numeric, integer) OWNER TO sistema;

--
-- Name: spibeneficiario(integer, integer, integer, character varying, numeric, integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spibeneficiario(integer, integer, integer, character varying, numeric, integer, integer, integer, integer) RETURNS integer
    AS $_$
declare
  pinversionid alias for $1;
  psocioid alias for $2;
  psujetoid alias for $3;
  pparentesco alias for $4;
  pporcentajebeneficiario alias for $5;
  pcontratoid alias for $6;
  pesbeneficiario alias for $7;
  pesrepresentante alias for $8;
  pescootitular alias for $9;
 
begin

   insert into beneficiario(inversionid,socioid,sujetoid,parentesco,porcentajebeneficiario,contratoid,esbeneficiario,esrepresentante,escootitular)
    values( pinversionid,
            psocioid,
            psujetoid,
            pparentesco,
            pporcentajebeneficiario,
            pcontratoid,
            pesbeneficiario,
            pesrepresentante,
            pescootitular);

return currval('beneficiario_beneficiarioid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spibeneficiario(integer, integer, integer, character varying, numeric, integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: spibeneficiario(integer, integer, integer, character varying, numeric, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spibeneficiario(integer, integer, integer, character varying, numeric, integer, integer) RETURNS integer
    AS $_$
declare
  pinversionid alias for $1;
  psocioid alias for $2;
  psujetoid alias for $3;
  pparentesco alias for $4;
  pporcentajebeneficiario alias for $5;
  pbeneficiario alias for $6;
  pcotitular alias for $7;
 
begin

   insert into beneficiario(inversionid,socioid,sujetoid,parentesco,porcentajebeneficiario,esbeneficiario,escootitular)
    values( pinversionid,
            psocioid,
            psujetoid,
            pparentesco,
            pporcentajebeneficiario,pbeneficiario,pcotitular);

return currval('beneficiario_beneficiarioid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spibeneficiario(integer, integer, integer, character varying, numeric, integer, integer) OWNER TO sistema;

--
-- Name: spibienes(integer, character varying, character varying, character varying, character varying, numeric, numeric, numeric, character varying, numeric, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spibienes(integer, character varying, character varying, character varying, character varying, numeric, numeric, numeric, character varying, numeric, character, date) RETURNS integer
    AS $_$
declare

  psujetoid alias for $1;
  ppropietario alias for $2;
  pdescribien alias for $3;
  pcaracteristicas alias for $4;
  pregistropublico alias for $5;
  pvalorcomercial alias for $6;
  pvalorfiscal alias for $7;
  pvalorcatastro alias for $8;
  pdatoshipoteca alias for $9;
  prelaciongarantia alias for $10;
  padjudicado alias for $11;
  pfechaadjudicado alias for $12;
  
begin

   insert into bienes(sujetoid,propietario,describien,caracteristicas,registropublico,
     valorcomercial,valorfiscal,valorcatastro,datoshipoteca,relaciongarantia,adjudicado,fechaadjudicado)   
    values( psujetoid,
            ppropietario,
	    pdescribien,
	    pcaracteristicas,
	    pregistropublico,
	    pvalorcomercial,
            pvalorfiscal,
            pvalorcatastro,
	    pdatoshipoteca,
	    prelaciongarantia,
	    padjudicado,
	    pfechaadjudicado);

return currval('bienes_bienid_seq'); 
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spibienes(integer, character varying, character varying, character varying, character varying, numeric, numeric, numeric, character varying, numeric, character, date) OWNER TO sistema;

--
-- Name: spicalculo(character, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spicalculo(character, text) RETURNS integer
    AS $_$
declare
  pdescripcioncalculo alias for $1;
  pformula alias for $2;
  r calculo%rowtype;

begin

   select * into r
     from calculo
   where formula=pformula;
   if found then
     raise exception 'Ya existe una formula: %',pformula;
   end if;

   insert into calculo(descripcioncalculo,formula)
    values( pdescripcioncalculo,
            pformula );
            

return currval('calculo_calculoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spicalculo(character, text) OWNER TO sistema;

--
-- Name: spicargoprestamo(character, character, character, integer, integer, integer, numeric, numeric, numeric, numeric, integer, integer, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spicargoprestamo(character, character, character, integer, integer, integer, numeric, numeric, numeric, numeric, integer, integer, character, character) RETURNS integer
    AS $_$
declare
 -- pcargoprestamoi   alias for $1;
  ptipoprestamoid   alias for $1;
  pcuentaid         alias for $2;
  pdescripcioncargo alias for $3;
  ptipocargo        alias for $4;
  pporamortizacion  alias for $5;
  papertura         alias for $6;
  prangoinicial     alias for $7;
  prangofinal       alias for $8;
  pporcentaje       alias for $9;
  pmontocargo       alias for $10;
  paplicaiva        alias for $11;
  pcalculoporfuncion alias for $12;
  pfuncion alias for $13;
  pcuentaiva	     alias for $14;
begin

   insert into cargoprestamo (tipoprestamoid,cuentaid,descripcioncargo,tipocargo,poramortizacion,apertura,rangoinicial,rangofinal,porcentaje,montocargo,aplicaiva,calculoporfuncion, funcion, cuentaiva)

    values( ptipoprestamoid,
            pcuentaid,
            pdescripcioncargo,
            ptipocargo,
            pporamortizacion,
            papertura,
            prangoinicial,
            prangofinal,
            pporcentaje,
            pmontocargo,
            paplicaiva,
            pcalculoporfuncion,
            pfuncion,
	    pcuentaiva);


return currval('cargoprestamo_cargoprestamoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spicargoprestamo(character, character, character, integer, integer, integer, numeric, numeric, numeric, numeric, integer, integer, character, character) OWNER TO sistema;

--
-- Name: spicarteracobrador(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spicarteracobrador(integer, character) RETURNS integer
    AS $_$
declare 
  pcobradorid alias for $1;
  preferenciaprestamo alias for $2;

  pprestamoid integer;
  pprestamoid1 integer;
begin
  select prestamoid into pprestamoid from prestamos where referenciaprestamo=preferenciaprestamo and claveestadocredito<>'002' and claveestadocredito<>'008';
  if found then
    select prestamoid into pprestamoid1 from carteracobrador where cobradorid=pcobradorid and prestamoid=pprestamoid;
    if not found then   
        insert into carteracobrador(cobradorid,prestamoid) values(pcobradorid,pprestamoid);
  	end if;
  end if;
return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spicarteracobrador(integer, character) OWNER TO sistema;

--
-- Name: spicatalogo_ctas(character, character, character, character, character, character, date, date, character, double precision, double precision, double precision, double precision); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spicatalogo_ctas(character, character, character, character, character, character, date, date, character, double precision, double precision, double precision, double precision) RETURNS character
    AS $_$
declare
  pcuentaid         alias for $1;
  pcat_cuentaid     alias for $2;
  pidentificacion   alias for $3; 
  pcuentanombre     alias for $4;
  ptipo_cta         alias for $5;
  pestado_cta       alias for $6;
  pfecha_estado     alias for $7;
  pfecha_ult_mov    alias for $8;
  pnaturaleza       alias for $9;
  pdigito_agrupador alias for $10;
  psaldo_inic_ejer  alias for $11;
  pcargos_acum_ejer alias for $12;
  pabonos_acum_ejer alias for $13;

begin

   insert into catalogo_ctas(cuentaid,cat_cuentaid,identificacion,cuentanombre,tipo_cta,estado_cta,fecha_estado,fecha_ult_mov,naturaleza,digito_agrupador,saldo_inic_ejer,cargos_acum_ejer,abonos_acum_ejer)
    values( pcuentaid,
            pcat_cuentaid,
            pidentificacion,      
            pcuentanombre,
            ptipo_cta,
            pestado_cta,
            pfecha_estado,
            pfecha_ult_mov,
            pnaturaleza,
            pdigito_agrupador,
            psaldo_inic_ejer,
            pcargos_acum_ejer,
            pabonos_acum_ejer );

return pcuentaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spicatalogo_ctas(character, character, character, character, character, character, date, date, character, double precision, double precision, double precision, double precision) OWNER TO sistema;

--
-- Name: spicatalogo_ctasc(character, character, character, character, character, character, date, date, character, double precision, double precision, double precision, double precision); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spicatalogo_ctasc(character, character, character, character, character, character, date, date, character, double precision, double precision, double precision, double precision) RETURNS text
    AS $_$
declare
  pcuentaid         alias for $1;
  pcat_cuentaid     alias for $2;
  pidentificacion   alias for $3; 
  pcuentanombre     alias for $4;
  ptipo_cta         alias for $5;
  pestado_cta       alias for $6;
  pfecha_estado     alias for $7;
  pfecha_ult_mov    alias for $8;
  pnaturaleza       alias for $9;
  pdigito_agrupador alias for $10;
  psaldo_inic_ejer  alias for $11;
  pcargos_acum_ejer alias for $12;
  pabonos_acum_ejer alias for $13;

  scuentaid text;

begin

select dblink_exec('host=sucursal2.cajareforma.org dbname=reforma2 user=sistema',
    'set search_path to public,sucursal2; insert into catalogo_ctas values ('||
    ''''||pcuentaid||''''||','||
    ''''||pcat_cuentaid||''''||','||
    ''''||pidentificacion||''''||','||
    ''''||pcuentanombre||''''||','||
    ''''||ptipo_cta||''''||','||
    ''''||pestado_cta||''''||','||
    ''''||pfecha_estado||''''||','||
    ''''||pfecha_ult_mov||''''||','||
    ''''||pnaturaleza||''''||','||
    psaldo_inic_ejer||','||
    pcargos_acum_ejer||','||
    pabonos_acum_ejer||');')
  into scuentaid;


select dblink_exec('host=sucursal4.cajareforma.org dbname=reforma4 user=sistema',
    'set search_path to public,sucursal4; insert into catalogo_ctas values ('||
    ''''||pcuentaid||''''||','||
    ''''||pcat_cuentaid||''''||','||
    ''''||pidentificacion||''''||','||
    ''''||pcuentanombre||''''||','||
    ''''||ptipo_cta||''''||','||
    ''''||pestado_cta||''''||','||
    ''''||pfecha_estado||''''||','||
    ''''||pfecha_ult_mov||''''||','||
    ''''||pnaturaleza||''''||','||
    psaldo_inic_ejer||','||
    pcargos_acum_ejer||','||
    pabonos_acum_ejer||');')
  into scuentaid;

select dblink_exec('host=sucursal3.cajareforma.org dbname=reforma3 user=sistema',
    'set search_path to public,sucursal3; insert into catalogo_ctas values ('||
    ''''||pcuentaid||''''||','||
    ''''||pcat_cuentaid||''''||','||
    ''''||pidentificacion||''''||','||
    ''''||pcuentanombre||''''||','||
    ''''||ptipo_cta||''''||','||
    ''''||pestado_cta||''''||','||
    ''''||pfecha_estado||''''||','||
    ''''||pfecha_ult_mov||''''||','||
    ''''||pnaturaleza||''''||','||
    psaldo_inic_ejer||','||
    pcargos_acum_ejer||','||
    pabonos_acum_ejer||');')
  into scuentaid;


select dblink_exec('host=sucursal5.cajareforma.org dbname=reforma5 user=sistema',
    'set search_path to public,sucursal5; insert into catalogo_ctas values ('||
    ''''||pcuentaid||''''||','||
    ''''||pcat_cuentaid||''''||','||
    ''''||pidentificacion||''''||','||
    ''''||pcuentanombre||''''||','||
    ''''||ptipo_cta||''''||','||
    ''''||pestado_cta||''''||','||
    ''''||pfecha_estado||''''||','||
    ''''||pfecha_ult_mov||''''||','||
    ''''||pnaturaleza||''''||','||
    psaldo_inic_ejer||','||
    pcargos_acum_ejer||','||
    pabonos_acum_ejer||');')
  into scuentaid;

select dblink_exec('host=sucursal6.cajareforma.org dbname=reforma6 user=sistema',
    'set search_path to public,sucursal6; insert into catalogo_ctas values ('||
    ''''||pcuentaid||''''||','||
    ''''||pcat_cuentaid||''''||','||
    ''''||pidentificacion||''''||','||
    ''''||pcuentanombre||''''||','||
    ''''||ptipo_cta||''''||','||
    ''''||pestado_cta||''''||','||
    ''''||pfecha_estado||''''||','||
    ''''||pfecha_ult_mov||''''||','||
    ''''||pnaturaleza||''''||','||
    psaldo_inic_ejer||','||
    pcargos_acum_ejer||','||
    pabonos_acum_ejer||');')
  into scuentaid;

select dblink_exec('host=sucursal7.cajareforma.org dbname=reforma7 user=sistema',
    'set search_path to public,sucursal7; insert into catalogo_ctas values ('||
    ''''||pcuentaid||''''||','||
    ''''||pcat_cuentaid||''''||','||
    ''''||pidentificacion||''''||','||
    ''''||pcuentanombre||''''||','||
    ''''||ptipo_cta||''''||','||
    ''''||pestado_cta||''''||','||
    ''''||pfecha_estado||''''||','||
    ''''||pfecha_ult_mov||''''||','||
    ''''||pnaturaleza||''''||','||
    psaldo_inic_ejer||','||
    pcargos_acum_ejer||','||
    pabonos_acum_ejer||');')
  into scuentaid;
return scuentaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spicatalogo_ctasc(character, character, character, character, character, character, date, date, character, double precision, double precision, double precision, double precision) OWNER TO sistema;

--
-- Name: spiciudadmex(integer, character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiciudadmex(integer, character, character varying) RETURNS integer
    AS $_$
declare
  pestadomexid alias for $1;
  pclaveciudadmex alias for $2;
  pnombreciudadmex alias for $3; 
begin

   insert into ciudadesmex(estadomexid,claveciudadmex,nombreciudadmex)
    values( pestadomexid,pclaveciudadmex,pnombreciudadmex);
            
return currval('ciudadesmex_ciudadmexid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiciudadmex(integer, character, character varying) OWNER TO sistema;

--
-- Name: spiclasificacioncredito(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiclasificacioncredito(character) RETURNS integer
    AS $_$
declare
  pdescripcion      alias for $1;

 
begin

  insert into clasificacioncredito(descripcion)
    values(pdescripcion );

        
return currval('clasificacioncredito_clasificacioncreditoid_seq');

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiclasificacioncredito(character) OWNER TO sistema;

--
-- Name: spiclasificacionsocio(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiclasificacionsocio(character) RETURNS integer
    AS $_$
declare
  pdescripcion      alias for $1;

 
begin

  insert into clasificacionsocio(descripcion)
    values(pdescripcion );

        
return currval('clasificacionsocio_clasificacionsocioid_seq');

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiclasificacionsocio(character) OWNER TO sistema;

--
-- Name: spicobradores(character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spicobradores(character, character, character, character) RETURNS integer
    AS $_$
declare
 
  ppaterno alias for $1;
  pmaterno alias for $2;
  pnombre  alias for $3;
  prazonsoc alias for $4;

  pcobradorid integer;
  psujetoid integer;
begin

  insert into sujeto(paterno,materno,nombre,razonsocial) values(ppaterno,pmaterno,pnombre,prazonsoc);
  select max(sujetoid) into psujetoid from sujeto;
  select coalesce(max(cobradorid),0)+1 into pcobradorid from cobradores;

  insert into cobradores(cobradorid,sujetoid) values (pcobradorid,psujetoid);
return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spicobradores(character, character, character, character) OWNER TO sistema;

--
-- Name: spicolonia(integer, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spicolonia(integer, integer, character) RETURNS integer
    AS $_$
declare

  pcoloniaid alias for $1;
  pciudadmexid alias for $2;
  pnombrecolonia alias for $3;

begin

   insert into colonia(ciudadmexid,nombrecolonia)
    values( pciudadmexid,pnombrecolonia );
            
return currval('colonia_coloniaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spicolonia(integer, integer, character) OWNER TO sistema;

--
-- Name: spicolonia(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spicolonia(integer, character) RETURNS integer
    AS $_$
declare

  pciudadmexid alias for $1;
  pnombrecolonia alias for $2;

begin

   insert into colonia(ciudadmexid,nombrecolonia)
    values( pciudadmexid,pnombrecolonia );
            
return currval('colonia_coloniaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spicolonia(integer, character) OWNER TO sistema;

--
-- Name: spicolonia(integer, character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spicolonia(integer, character, integer, integer) RETURNS integer
    AS $_$
declare
  
  pciudadmexid alias for $1;
  pnombrecolonia alias for $2;
  pcp alias for $3;
  pasentamientoid alias for $4;

begin

   insert into colonia(ciudadmexid,nombrecolonia,cp,tipoasentamientoid)
    values( pciudadmexid,pnombrecolonia,pcp,pasentamientoid );
            
return currval('colonia_coloniaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spicolonia(integer, character, integer, integer) OWNER TO sistema;

--
-- Name: spicolonia(integer, integer, character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spicolonia(integer, integer, character, integer, integer) RETURNS integer
    AS $_$
declare

  pid alias for $1;
  pciudadmexid alias for $2;
  pnombrecolonia alias for $3;
  pcp alias for $4;
  pasentamientoid alias for $5;

begin

   insert into colonia(ciudadmexid,nombrecolonia,cp,tipoasentamientoid)
    values( pciudadmexid,pnombrecolonia,pcp,pasentamientoid );
            
return currval('colonia_coloniaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spicolonia(integer, integer, character, integer, integer) OWNER TO sistema;

--
-- Name: spiconceptoscoring(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiconceptoscoring(character) RETURNS integer
    AS $_$
declare
  pconceptoscoring      alias for $1;

 
begin

  insert into conceptoscoring (conceptoscoring)
    values(pconceptoscoring);

        
return currval('conceptoscoring_conceptoscoringid_seq');

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiconceptoscoring(character) OWNER TO sistema;

--
-- Name: spiconsolida(integer, character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiconsolida(integer, character, character, character, character, character, character) RETURNS integer
    AS $_$
declare

  psucursalid alias for $1;
  phost       alias for $2;
  pbasedatos  alias for $3;
  pesquema    alias for $4;
  pusuariodb  alias for $5;
  ppassworddb alias for $6;
  pvigente    alias for $7;

begin

   insert into sucursales(host,basededatos,esquema,usuariodb,passworddb,vigente)
    values(phost,pbasedatos,pesquema,pusuariodb,ppassworddb,pvigente);
            
return currval('sucursales_sucursalid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiconsolida(integer, character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: spiconsolida(integer, character, character, character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiconsolida(integer, character, character, character, character, character, character, character, character) RETURNS integer
    AS $_$
declare

  psucursalid alias for $1;
  phost       alias for $2;
  pbasedatos  alias for $3;
  pesquema    alias for $4;
  pusuariodb  alias for $5;
  ppassworddb alias for $6;
  pvigente    alias for $7;
  pcuentaremesas alias for $8;
  pcuentafinanciamiento alias for $9;

begin

   insert into sucursales(host,basededatos,esquema,usuariodb,passworddb,vigente,cuentaremesas,cuentafinanciamiento)
    values(phost,pbasedatos,pesquema,pusuariodb,ppassworddb,pvigente,pcuentaremesas,pcuentafinanciamiento);
            
return currval('sucursales_sucursalid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiconsolida(integer, character, character, character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: spiconvenio(integer, date, text, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiconvenio(integer, date, text, character, character, integer) RETURNS integer
    AS $_$
declare

  pprestamoid     alias for $1;
  pfechaconvenio  alias for $2;
  ptextoconvenio  alias for $3;
  pvigente        alias for $4;
  pusuarioid      alias for $5;
  plugar          alias for $6;

begin

   insert into convenio(prestamoid,fechaconvenio,textoconvenio,vigente,usuarioid,lugar)
    values(pprestamoid,pfechaconvenio,ptextoconvenio,pvigente,pusuarioid,plugar);

return currval('convenio_convenioid_seq');
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spiconvenio(integer, date, text, character, character, integer) OWNER TO sistema;

--
-- Name: spiconvenio(integer, date, text, character, character, integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiconvenio(integer, date, text, character, character, integer, date) RETURNS integer
    AS $_$
declare

  pprestamoid     alias for $1;
  pfechaconvenio  alias for $2;
  ptextoconvenio  alias for $3;
  pvigente        alias for $4;
  pusuarioid      alias for $5;
  plugar          alias for $6;
  pfechavigencia  alias for $7;
begin

   if plugar<>0 and plugar<>1 then
     raise exception 'Error en plugar';
   end if;

   insert into convenio(prestamoid,fechaconvenio,textoconvenio,vigente,usuarioid,lugar,fechavigencia)
    values(pprestamoid,pfechaconvenio,ptextoconvenio,pvigente,pusuarioid,plugar,pfechavigencia);

return currval('convenio_convenioid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiconvenio(integer, date, text, character, character, integer, date) OWNER TO sistema;

--
-- Name: spiconvenio(integer, date, text, character, character, integer, date, character, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiconvenio(integer, date, text, character, character, integer, date, character, date, character) RETURNS integer
    AS $_$
declare

  pprestamoid     alias for $1;
  pfechaconvenio  alias for $2;
  ptextoconvenio  alias for $3;
  pvigente        alias for $4;
  pusuarioid      alias for $5;
  plugar          alias for $6;
  pfechavigencia  alias for $7;
  paccion         alias for $8;
  pfechanegociar  alias for $9;   
  phoranegociar   alias for $10;
begin

   if plugar<>0 and plugar<>1 then
     raise exception 'Error en plugar';
   end if;

   insert into convenio(prestamoid,fechaconvenio,textoconvenio,vigente,usuarioid,lugar,fechavigencia,accion,fechanegociar,horanegociar)
    values(pprestamoid,pfechaconvenio,ptextoconvenio,pvigente,pusuarioid,plugar,pfechavigencia,paccion,pfechanegociar,phoranegociar);

return currval('convenio_convenioid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiconvenio(integer, date, text, character, character, integer, date, character, date, character) OWNER TO sistema;

--
-- Name: spidatoingreso(character varying, character varying, character varying, numeric, numeric, integer, numeric, numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spidatoingreso(character varying, character varying, character varying, numeric, numeric, integer, numeric, numeric, integer) RETURNS integer
    AS $_$
declare
  pnombredelconyuge alias for $1;
  pempresadondetrabaja alias for $2;
  pocupacion alias for $3;
  pingresosmensuales alias for $4;
  potrosingresos alias for $5;
  pno_dependientes alias for $6;
  ptotalegresos alias for $7;
  pahorromensual alias for $8;
  pestadocivil alias for $9;

begin

   insert into datoingreso(nombredelconyuge,
                           empresadondetrabaja,
                           ocupacion,
                           ingresosmensuales,
                           otrosingresos,
                           no_dependientes,
                           totalegresos,
                           ahorromensual,
                           estadocivil)
    values( pnombredelconyuge,
            pempresadondetrabaja,
            pocupacion,
            pingresosmensuales,
            potrosingresos,
            pno_dependientes,
            ptotalegresos,
            pahorromensual,
            pestadocivil);
     
return currval('datoingreso_datoingresoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spidatoingreso(character varying, character varying, character varying, numeric, numeric, integer, numeric, numeric, integer) OWNER TO sistema;

--
-- Name: spidepreciacion(character, character, character, character, character, character varying, numeric, numeric, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spidepreciacion(character, character, character, character, character, character varying, numeric, numeric, numeric, numeric) RETURNS integer
    AS $_$
declare

pmonedaid          alias for $1;
pdepre_activo      alias for $2;
pdepre_ctadepre    alias for $3;
pdepre_ctagasto    alias for $4;
pdepre_ctabaja     alias for $5;
pdepredescripcion  alias for $6;
pdepretasacontable alias for $7;
pdepretasafiscal   alias for $8;
pmaximodeducible   alias for $9;
pdepreporcentaje   alias for $10;

begin

   insert into depreciacion(monedaid,depre_activo,depre_ctadepre,depre_ctagasto,depre_ctabaja,depredescripcion,depretasacontable,depretasafiscal,maximodeducible,depreporcentaje)
    values(pmonedaid,pdepre_activo,pdepre_ctadepre,pdepre_ctagasto,pdepre_ctabaja,pdepredescripcion,pdepretasacontable,pdepretasafiscal,pmaximodeducible,pdepreporcentaje);

return currval('depreciacion_depreciacionid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spidepreciacion(character, character, character, character, character, character varying, numeric, numeric, numeric, numeric) OWNER TO sistema;

--
-- Name: spidocumentacion(character, character varying, character, character varying, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spidocumentacion(character, character varying, character, character varying, date) RETURNS integer
    AS $_$
declare
  pdocucompletasocio alias for $1;
  pdocufaltantesocio alias for $2;
  pdocucompletapres alias for $3;
  pdocufaltantepres alias for $4;
  pfechanotificacion alias for $5;

--  ptexto text;
begin

--   select historial
--     into ptexto
--     from empresa
--    where empresaid=1;

--   ptexto := coalesce(ptexto,'vacio');

   insert into documentacion(docucompletasocio,docufaltantesocio,docucompletapres,docufaltantepres,fechanotificacion)
    values( pdocucompletasocio,
            pdocufaltantesocio,
            pdocucompletapres,
            pdocufaltantepres,
            pfechanotificacion);

return currval('documentacion_documentacionid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spidocumentacion(character, character varying, character, character varying, date) OWNER TO sistema;

--
-- Name: spidomicilio(integer, integer, character varying, character varying, character varying, character varying, integer, character varying, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spidomicilio(integer, integer, character varying, character varying, character varying, character varying, integer, character varying, character varying) RETURNS integer
    AS $_$
declare
  pciudadmexid alias for $1;
  psujetoid alias for $2;
  pcalle alias for $3;
  pnumero_ext alias for $4;
  pnumero_int alias for $5;
  pcolonia alias for $6;
  pcodpostal alias for $7;
  pcomunidad alias for $8;
  pteldomicilio alias for $9;

  ldomicilioid int4;

begin

  select min(domicilioid)
    into ldomicilioid
    from domicilio
   where sujetoid=psujetoid;

  ldomicilioid := coalesce(ldomicilioid,0);

  if ldomicilioid=0 then

    insert into domicilio( ciudadmexid,sujetoid,calle,numero_ext,
                           numero_int,colonia,codpostal,comunidad,
                           teldomicilio )
    values ( pciudadmexid,
             psujetoid,
             pcalle,
             pnumero_ext,
             pnumero_int,
             pcolonia,
             pcodpostal,
             pcomunidad,
             pteldomicilio );
     return currval('domicilio_domicilioid_seq');

   else

     -- Existe el domicilio para el sujeto solamente actualizarlo
     update domicilio
        set ciudadmexid = pciudadmexid,
            calle =  pcalle,
            numero_ext = pnumero_ext,
            numero_int = pnumero_int,
            colonia = pcolonia,
            codpostal = pcodpostal,
            comunidad = pcomunidad,
            teldomicilio = pteldomicilio
      where domicilioid = ldomicilioid;        

     return ldomicilioid;

   end if;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spidomicilio(integer, integer, character varying, character varying, character varying, character varying, integer, character varying, character varying) OWNER TO sistema;

--
-- Name: spidomicilio(integer, integer, character varying, character varying, character varying, character varying, integer, character varying, character varying, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spidomicilio(integer, integer, character varying, character varying, character varying, character varying, integer, character varying, character varying, integer) RETURNS integer
    AS $_$
declare
  pciudadmexid alias for $1;
  psujetoid alias for $2;
  pcalle alias for $3;
  pnumero_ext alias for $4;
  pnumero_int alias for $5;
  pcolonia alias for $6;
  pcodpostal alias for $7;
  pcomunidad alias for $8;
  pteldomicilio alias for $9;
  pcoloniaid alias for $10;

  ldomicilioid int4;

  scolonia char(30);
  lcoloniaid int4;

begin

  
  if pcoloniaid=0 then
    select coloniaid
      into lcoloniaid
      from colonia
     where ciudadmexid=pciudadmexid and
           nombrecolonia='NO ESPECIFICADA';
  else
   
    if pcoloniaid>0 then
      select substr(nombrecolonia,1,30)
        into scolonia
        from colonia
       where coloniaid=pcoloniaid;
    else
      scolonia:=pcolonia;
    end if;
    lcoloniaid:=pcoloniaid;

  end if;

  select min(domicilioid)
    into ldomicilioid
    from domicilio
   where sujetoid=psujetoid;

  ldomicilioid := coalesce(ldomicilioid,0);

  raise notice 'DomicilioID=%',ldomicilioid;

  if ldomicilioid=0 then

    insert into domicilio( ciudadmexid,sujetoid,calle,numero_ext,
                           numero_int,colonia,codpostal,comunidad,
                           teldomicilio,coloniaid )
    values ( pciudadmexid,
             psujetoid,
             pcalle,
             pnumero_ext,
             pnumero_int,
             scolonia,
             pcodpostal,
             pcomunidad,
             pteldomicilio,
             lcoloniaid);
     return currval('domicilio_domicilioid_seq');

   else

     -- Existe el domicilio para el sujeto solamente actualizarlo
     update domicilio
        set ciudadmexid = pciudadmexid,
            calle =  pcalle,
            numero_ext = pnumero_ext,
            numero_int = pnumero_int,
            colonia = scolonia,
            codpostal = pcodpostal,
            comunidad = pcomunidad,
            teldomicilio = pteldomicilio,
            coloniaid = lcoloniaid
      where domicilioid = ldomicilioid;        

     return ldomicilioid;

   end if;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spidomicilio(integer, integer, character varying, character varying, character varying, character varying, integer, character varying, character varying, integer) OWNER TO sistema;

--
-- Name: spiestadomex(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiestadomex(character, character varying) RETURNS integer
    AS $_$
declare
  pclaveestadomex alias for $1;
  pnombreestadomex alias for $2;
  r estadosmex%rowtype;

begin

   select * into r
     from estadosmex
   where nombreestadomex=pnombreestadomex;
   if found then
     raise exception 'Ya existe un estado con %',pnombreestadomex;
   end if;

   select * into r
     from estadosmex
   where claveestadomex=pclaveestadomex;
   if found then
     raise exception 'Ya existe una clave %',pclaveestadomex;
   end if;

   insert into estadosmex(claveestadomex,nombreestadomex)
    values( pclaveestadomex,
            pnombreestadomex );
            

return currval('estadosmex_estadomexid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiestadomex(character, character varying) OWNER TO sistema;

--
-- Name: spiestados_credito(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiestados_credito(character, character varying) RETURNS character
    AS $_$
declare
  pclaveestadocredito alias for $1;
  pdescripcionedocredito alias for $2;
begin 

   insert into estados_credito(claveestadocredito,descripcionedocredito)
    values( pclaveestadocredito,pdescripcionedocredito );
            
return pclaveestadocredito;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiestados_credito(character, character varying) OWNER TO sistema;

--
-- Name: spifinalidades(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spifinalidades(character, character varying) RETURNS character
    AS $_$
declare
  pclavefinalidad alias for $1;
  pdescripcionfinalidad alias for $2;
begin

   insert into finalidades(clavefinalidad,descripcionfinalidad)
    values( pclavefinalidad,pdescripcionfinalidad );
            
return pclavefinalidad;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spifinalidades(character, character varying) OWNER TO sistema;

--
-- Name: spigrupo(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spigrupo(character) RETURNS integer
    AS $_$
declare
  pgrupo      alias for $1;

 
begin

  insert into grupo(grupo)
    values(pgrupo );

        
return currval('grupo_grupoid_seq');

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spigrupo(character) OWNER TO sistema;

--
-- Name: spiinpc(integer, integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiinpc(integer, integer, numeric) RETURNS integer
    AS $_$
declare
  pano alias for $1;
  pmes alias for $2;
  pinpc alias for $3;
begin

   insert into inpc(ano,mes,inpc)
    values(pano,pmes,pinpc);
            
return pano;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiinpc(integer, integer, numeric) OWNER TO sistema;

--
-- Name: spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character) RETURNS integer
    AS $_$
declare
  psocioid                       alias for $1;
  ptipoinversionid               alias for $2;
  preferenciainver               alias for $3;
  pserieinver                    alias for $4;
  pdepositoinversion             alias for $5;
  pretiroinversion               alias for $6;
  pinteresinversion              alias for $7;
  pfechainversion                alias for $8;
  pfechavencimiento              alias for $9;
  pultimarenovacion              alias for $10;
  pnoderenovaciones              alias for $11;
  ptasainteresnormalinversion    alias for $12;
  ptasainteresmoratorioinversion alias for $13;
  pfechapagoinversion            alias for $14;
  pfechapagoanterior             alias for $15;
  preinversionautomatica         alias for $16;

  pref int4;

 sclavesocioint char(15);
 stiposocioid char(2);

  iclasificacionid int4;

  linversionid int4;
  lfoliocertificado int4;
  fmontomaximo numeric;
  fmontominimo numeric;
  iplazomaximo integer;



begin

  select clavesocioint,tiposocioid
    into sclavesocioint,stiposocioid
    from socio
   where socioid=psocioid;


   select clasificacionid,montomaximo,montominimo,plazomaximo into iclasificacionid,fmontomaximo,fmontominimo,iplazomaximo
     from tipoinversion where tipoinversionid=ptipoinversionid;

   if pdepositoinversion < fmontominimo or pdepositoinversion > fmontomaximo then
     raise exception 'El Importe no cubre los parametros de minimo y maximo';
   end if;


   --select coalesce(max(referenciainversion),0) into pref
   --  from inversion
   -- where serieinversion=pserieinver;

   --  pref := pref + 1;
   pref := preferenciainver;

   insert into inversion(tipoinversionid,socioid,referenciainversion,serieinversion,depositoinversion,retiroinversion,interesinversion,fechainversion,fechavencimiento,ultimarenovacion,noderenovaciones,tasainteresnormalinversion,tasainteresmoratorioinversion,fechapagoinversion,fechapagoanterior,reinversionautomatica)
    values( ptipoinversionid,
            psocioid,
            pref,
            pserieinver,
            pdepositoinversion,
            pretiroinversion,
            pinteresinversion,
            pfechainversion,
            pfechavencimiento,
            pultimarenovacion,
            pnoderenovaciones,
            ptasainteresnormalinversion,
            ptasainteresmoratorioinversion,
            pfechapagoinversion,
            pfechapagoanterior,
            preinversionautomatica);

select currval('inversion_inversionid_seq') into linversionid;

-- Verificar si es certificado

  if iclasificacionid=1 then
    select max(foliocertificado)
      into lfoliocertificado
      from certificado;

    lfoliocertificado:=coalesce(lfoliocertificado,0);
    lfoliocertificado:=lfoliocertificado+1;

    insert into certificado values (linversionid,lfoliocertificado);

  end if;


return linversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character) OWNER TO sistema;

--
-- Name: spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric) RETURNS integer
    AS $_$
declare
  psocioid                       alias for $1;
  ptipoinversionid               alias for $2;
  preferenciainver               alias for $3;
  pserieinver                    alias for $4;
  pdepositoinversion             alias for $5;
  pretiroinversion               alias for $6;
  pinteresinversion              alias for $7;
  pfechainversion                alias for $8;
  pfechavencimiento              alias for $9;
  pultimarenovacion              alias for $10;
  pnoderenovaciones              alias for $11;
  ptasainteresnormalinversion    alias for $12;
  ptasainteresmoratorioinversion alias for $13;
  pfechapagoinversion            alias for $14;
  pfechapagoanterior             alias for $15;
  preinversionautomatica         alias for $16;
  pdepositoanteside              alias for $17;
  pide                           alias for $18;

  pref int4;

 sclavesocioint char(15);
 stiposocioid char(2);

  iclasificacionid int4;

  linversionid int4;
  lfoliocertificado int4;

begin

  select clavesocioint,tiposocioid
    into sclavesocioint,stiposocioid
    from socio
   where socioid=psocioid;


   select clasificacionid into iclasificacionid
     from tipoinversion where tipoinversionid=ptipoinversionid;

   if stiposocioid='01' then
     --raise exception 'El socio menor no puede realizar este tipo de movimiento.';
   end if;


   --select coalesce(max(referenciainversion),0) into pref
   --  from inversion
   -- where serieinversion=pserieinver;

   --  pref := pref + 1;
   pref := preferenciainver;

   insert into inversion(tipoinversionid,socioid,referenciainversion,serieinversion,depositoinversion,retiroinversion,interesinversion,fechainversion,fechavencimiento,ultimarenovacion,noderenovaciones,tasainteresnormalinversion,tasainteresmoratorioinversion,fechapagoinversion,fechapagoanterior,reinversionautomatica,depositoanteside,ide)
    values( ptipoinversionid,
            psocioid,
            pref,
            pserieinver,
            pdepositoinversion,
            pretiroinversion,
            pinteresinversion,
            pfechainversion,
            pfechavencimiento,
            pultimarenovacion,
            pnoderenovaciones,
            ptasainteresnormalinversion,
            ptasainteresmoratorioinversion,
            pfechapagoinversion,
            pfechapagoanterior,
            preinversionautomatica,pdepositoanteside,pide);

select currval('inversion_inversionid_seq') into linversionid;

-- Verificar si es certificado

  if iclasificacionid=1 then
    select max(foliocertificado)
      into lfoliocertificado
      from certificado;

    lfoliocertificado:=coalesce(lfoliocertificado,0);
    lfoliocertificado:=lfoliocertificado+1;

    insert into certificado values (linversionid,lfoliocertificado);

  end if;


return linversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric) OWNER TO sistema;

--
-- Name: spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric, integer, integer) RETURNS integer
    AS $_$
declare
  psocioid                       alias for $1;
  ptipoinversionid               alias for $2;
  preferenciainver               alias for $3;
  pserieinver                    alias for $4;
  pdepositoinversion             alias for $5;
  pretiroinversion               alias for $6;
  pinteresinversion              alias for $7;
  pfechainversion                alias for $8;
  pfechavencimiento              alias for $9;
  pultimarenovacion              alias for $10;
  pnoderenovaciones              alias for $11;
  ptasainteresnormalinversion    alias for $12;
  ptasainteresmoratorioinversion alias for $13;
  pfechapagoinversion            alias for $14;
  pfechapagoanterior             alias for $15;
  preinversionautomatica         alias for $16;
  pdepositoanteside              alias for $17;
  pide                           alias for $18;
  pinversionanterior             alias for $19;
  pmanejo                        alias for $20;
   
  r record;
  
  pref int4;

  sclavesocioint char(15);
  stiposocioid char(2);

  iclasificacionid int4;

  linversionid int4;
  lfoliocertificado int4;
  
  lindicadorid int4;
  fpuntos numeric;
  ftasacalculada numeric;
  fvalor numeric;
  
begin

  select clavesocioint,tiposocioid
    into sclavesocioint,stiposocioid
    from socio
   where socioid=psocioid;

   select clasificacionid into iclasificacionid
     from tipoinversion where tipoinversionid=ptipoinversionid;

   if stiposocioid='01' then
     --raise exception 'El socio menor no puede realizar este tipo de movimiento.';
   end if;

   ftasacalculada := ptasainteresnormalinversion ;
      
   --select coalesce(max(referenciainversion),0) into pref
   --  from inversion
   -- where serieinversion=pserieinver;

   --  pref := pref + 1;
   pref := preferenciainver;
   
   insert into inversion(tipoinversionid,socioid,referenciainversion,serieinversion,depositoinversion,retiroinversion,interesinversion,fechainversion,fechavencimiento,ultimarenovacion,noderenovaciones,tasainteresnormalinversion,tasainteresmoratorioinversion,fechapagoinversion,fechapagoanterior,reinversionautomatica,depositoanteside,ide,inversionanteriorid,manejo)
    values( ptipoinversionid,
            psocioid,
            pref,
            pserieinver,
            pdepositoinversion,
            pretiroinversion,
            pinteresinversion,
            pfechainversion,
            pfechavencimiento,
            pultimarenovacion,
            pnoderenovaciones,
            ftasacalculada,
            ptasainteresmoratorioinversion,
            pfechapagoinversion,
            pfechapagoanterior,
            preinversionautomatica,pdepositoanteside,pide,pinversionanterior,pmanejo);

select currval('inversion_inversionid_seq') into linversionid;

-- Agregar los beneficiarios

for r in select * from beneficiario where inversionid=pinversionanterior
loop 

     insert into beneficiario(inversionid,socioid,sujetoid,parentesco,porcentajebeneficiario)
     values( linversionid,
            r.socioid,
            r.sujetoid,
            r.parentesco,
            r.porcentajebeneficiario);
            
end loop;

-- Verificar si es certificado

  if iclasificacionid=1 then
    select max(foliocertificado)
      into lfoliocertificado
      from certificado;

    lfoliocertificado:=coalesce(lfoliocertificado,0);
    lfoliocertificado:=lfoliocertificado+1;

    insert into certificado values (linversionid,lfoliocertificado);

  end if;


return linversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric, integer, integer) OWNER TO sistema;

--
-- Name: spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric, integer) RETURNS integer
    AS $_$
declare
  psocioid                       alias for $1;
  ptipoinversionid               alias for $2;
  preferenciainver               alias for $3;
  pserieinver                    alias for $4;
  pdepositoinversion             alias for $5;
  pretiroinversion               alias for $6;
  pinteresinversion              alias for $7;
  pfechainversion                alias for $8;
  pfechavencimiento              alias for $9;
  pultimarenovacion              alias for $10;
  pnoderenovaciones              alias for $11;
  ptasainteresnormalinversion    alias for $12;
  ptasainteresmoratorioinversion alias for $13;
  pfechapagoinversion            alias for $14;
  pfechapagoanterior             alias for $15;
  preinversionautomatica         alias for $16;
  pdepositoanteside              alias for $17;
  pide                           alias for $18;
  pmanejo                        alias for $19;
   
  r record;
  
  pref int4;

  sclavesocioint char(15);
  stiposocioid char(2);

  iclasificacionid int4;

  linversionid int4;
  lfoliocertificado int4;
  
  lindicadorid int4;
  fpuntos numeric;
  ftasacalculada numeric;
  fvalor numeric;
  
begin

  select clavesocioint,tiposocioid
    into sclavesocioint,stiposocioid
    from socio
   where socioid=psocioid;

   select clasificacionid into iclasificacionid
     from tipoinversion where tipoinversionid=ptipoinversionid;

   if stiposocioid='01' then
     --raise exception 'El socio menor no puede realizar este tipo de movimiento.';
   end if;

   ftasacalculada := ptasainteresnormalinversion ;
  
   --select coalesce(max(referenciainversion),0) into pref
   --  from inversion
   -- where serieinversion=pserieinver;

   --  pref := pref + 1;
   
   pref := preferenciainver;
   
   insert into inversion(tipoinversionid,socioid,referenciainversion,serieinversion,depositoinversion,retiroinversion,interesinversion,fechainversion,fechavencimiento,ultimarenovacion,noderenovaciones,tasainteresnormalinversion,tasainteresmoratorioinversion,fechapagoinversion,fechapagoanterior,reinversionautomatica,depositoanteside,ide,manejo)
    values( ptipoinversionid,
            psocioid,
            pref,
            pserieinver,
            pdepositoinversion,
            pretiroinversion,
            pinteresinversion,
            pfechainversion,
            pfechavencimiento,
            pultimarenovacion,
            pnoderenovaciones,
            ftasacalculada,
            ptasainteresmoratorioinversion,
            pfechapagoinversion,
            pfechapagoanterior,
            preinversionautomatica,pdepositoanteside,pide,pmanejo);

select currval('inversion_inversionid_seq') into linversionid;


-- Verificar si es certificado

  if iclasificacionid=1 then
    select max(foliocertificado)
      into lfoliocertificado
      from certificado;

    lfoliocertificado:=coalesce(lfoliocertificado,0);
    lfoliocertificado:=lfoliocertificado+1;

    insert into certificado values (linversionid,lfoliocertificado);

  end if;


return linversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiinversion(integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric, integer) OWNER TO sistema;

--
-- Name: spimodulo(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spimodulo(character, character varying) RETURNS character
    AS $_$
declare
  pclavemodulo alias for $1;
  pdescripcionmodulos alias for $2;
begin

   insert into modulos(clavemodulo,descripcionmodulos)
    values( pclavemodulo,
            pdescripcionmodulos);
            

return pclavemodulo;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spimodulo(character, character varying) OWNER TO sistema;

--
-- Name: spimoneda(character, character varying, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spimoneda(character, character varying, numeric) RETURNS character
    AS $_$
declare
  pmonedaid alias for $1;
  pmonedadescri alias for $2;
  pmonedavalor alias for $3;
begin

   insert into monedas(monedaid,monedadescri,monedavalor)
    values( pmonedaid,
            pmonedadescri,
            pmonedavalor );
            

return pmonedaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spimoneda(character, character varying, numeric) OWNER TO sistema;

--
-- Name: spimotivobaja(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spimotivobaja(character) RETURNS integer
    AS $_$
declare
  pdescripcionmotivo      alias for $1;

 
begin

  insert into motivobaja(descripcionmotivo)
    values(pdescripcionmotivo );

        
return currval('motivobaja_motivobajaid_seq');

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spimotivobaja(character) OWNER TO sistema;

--
-- Name: spimovibanco(character, integer, character, integer, integer, character, character, character, character, character, date, character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spimovibanco(character, integer, character, integer, integer, character, character, character, character, character, date, character, integer, integer) RETURNS integer
    AS $_$
declare
   ptipomovibancoid alias for $1;
   pprestamoid      alias for $2;
   pno_cuenta       alias for $3;
   ppolizaid        alias for $4;
   pconsecutivo     alias for $5;
   pserie	    alias for $6;
   preferenciamovi  alias for $7;
   pconcepto	    alias for $8;
   pbeneficiario    alias for $9;
   pconciliado      alias for $10;
   pfecha_pen       alias for $11;
   ppostfechado     alias for $12;
   pmovipolizaid    alias for $13;
   pprocampoid      alias for $14;

   lconsecutivo integer;
   ldebe numeric;
   lhaber numeric;
   sreferenciaprestamo char(18);
   fmontoprestamo numeric;
   activoprestamo numeric;

   l integer;

   irepetido int4;

begin


   if ptipomovibancoid='02' then    

     -- Incrementar Consecutivo de cheque
     update bancos
        set nocheque=nocheque+1
      where no_cuenta=pno_cuenta;

   end if;

     -- Verificar que no hay sido retirado con RM

     select count(p.*) into irepetido
       from movicaja m, polizas p
      where m.prestamoid=pprestamoid and
            m.tipomovimientoid='RM' and
            p.polizaid=m.polizaid and
            substr(p.concepto_poliza,1,9)<>'CANCELADO';

     irepetido:=coalesce(irepetido,0);

     if irepetido>0 then
       raise exception 'El prestamo ya fue retirado en caja';
     end if;


   select coalesce(max(consecutivo)+1,1)
     into lconsecutivo
     from movibanco
    where serie=pserie;

   insert into movibanco(tipomovibancoid,prestamoid,no_cuenta,polizaid,consecutivo,
                         serie,referenciamovi,concepto,beneficiario,conciliado,
                         fecha_pen,postfechado,movipolizaid,procampoid)
    values(ptipomovibancoid,pprestamoid,pno_cuenta,ppolizaid,lconsecutivo,
           pserie,preferenciamovi,pconcepto,pbeneficiario,pconciliado,
           pfecha_pen,ppostfechado,pmovipolizaid,pprocampoid);

   -- Actualizar el saldo del banco
   -- Recalculandolo completamente
   --select recalculasaldo(pno_cuenta) into l;

   select debe,haber
     into ldebe,lhaber
     from movipolizas where movipolizaid=pmovipolizaid;

   update bancos
      set saldo_actual = saldo_actual + ldebe - lhaber
    where no_cuenta=pno_cuenta;

   -- Validar el total del activo prestamo

   if pprestamoid is not null then

     select referenciaprestamo,montoprestamo into sreferenciaprestamo,fmontoprestamo from prestamos where prestamoid=pprestamoid;

     select sumaactivoprestamo into activoprestamo from sumaactivoprestamo(sreferenciaprestamo );

     raise notice ' %   %   ',activoprestamo,fmontoprestamo;

     if  activoprestamo > fmontoprestamo then 
    
       raise exception 'La suma del registro en activo es > monto del prestamo';

     end if;

   end if;

return currval('movibanco_movibancoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spimovibanco(character, integer, character, integer, integer, character, character, character, character, character, date, character, integer, integer) OWNER TO sistema;

--
-- Name: spimovicaja(integer, character, integer, integer, character, integer, integer, character, integer, integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spimovicaja(integer, character, integer, integer, character, integer, integer, character, integer, integer, numeric) RETURNS integer
    AS $_$
declare
   psocioid          alias for $1;	
   ptipomovimientoid alias for $2;
   ppolizaid         alias for $3;
   preferenciacaja   alias for $4;
   pseriecaja        alias for $5;
   pmovipolizaid     alias for $6;
   pprestamoid       alias for $7;
   pestatusmovicaja  alias for $8;
   pinversionid      alias for $9;
   pcontratoid       alias for $10;
   pautorizacionid   alias for $11;
   
   amort record;

   fprestamos numeric;
   fretiro numeric;
   fdeposito numeric;
   fsaldo  numeric;

   iestatussocio int;

   saplicasaldo char(1);
   saceptadeposito char(1);
   saceptaretiro   char(1);

   stiposocioid char(2);

   fmontopartesocial numeric;
   fsaldopa numeric;
   ipartesocialcompleta int4;
  
   lsocioid int4;

   irepetido int4;

-- IDE

   fdepositoefectivo numeric;
   fsumaefectivo numeric;
   psaldo numeric;
   pefectivo integer;

   pfecha date;

   scuentacaja char(24);
   scuentadeposito char(24);

   pnumero_poliza int4;
   preferencia int4;

   lreferenciacaja int4;

   ppolizaid1 int4;
   pmovipolizaid1 int4;
   pmovipolizaid2 int4;
   fideexento numeric;
   fporide numeric;
   freciprocidad numeric;
   
   susuarioid character(20);

   fdepaplicar numeric;
   iautorizacionid integer;
   imovicajaid integer;

   
begin


   
   --Abrir y cerrar cajas

---

 if ptipomovimientoid='00' then
     -- Validar que el prestamo corresponda al socio

     select socioid into lsocioid
       from prestamos where prestamoid=pprestamoid;
     if lsocioid<>psocioid then
       raise exception 'Verifique el prestamo no corresponde al socio !!!';
     end if;
   end if;

  

   if ptipomovimientoid='IN' then
     -- Validar que la inversion corresponda al socio

     select socioid into lsocioid
       from inversion where inversionid=pinversionid;
     if lsocioid<>psocioid then
       raise exception 'Verifique la inversion no corresponde al socio !!!';
     end if;

   end if;

   select estatussocio,tiposocioid into iestatussocio,stiposocioid
     from socio
    where socioid=psocioid;

   select montopartesocial,partesocialcompleta,ideexento,poride
       into fmontopartesocial,ipartesocialcompleta,fideexento,fporide
       from empresa where empresaid=1;


   if stiposocioid='02' and
      (ptipomovimientoid<>'00' and ptipomovimientoid<>'PA' and
       ptipomovimientoid<>'RE' and ptipomovimientoid<>'CH' and
       ptipomovimientoid<>'MG' and ptipomovimientoid<>'BS') then

   
     if ipartesocialcompleta=1 then
       -- Validar que tenga la parte social
       select sum(mp.debe)-sum(mp.haber) into fsaldopa
         from movicaja mc, movipolizas mp
        where mc.socioid=psocioid and
              mc.tipomovimientoid='PA' and
              mp.movipolizaid=mc.movipolizaid;
       fsaldopa:=coalesce(fsaldopa,0);

       if fsaldopa<fmontopartesocial then
         raise exception 'El socio no tiene cubierta su parte social';
       end if;
     end if;
   end if;

   select aplicasaldo,aceptadeposito,aceptaretiro
     into saplicasaldo,saceptadeposito,saceptaretiro
     from tipomovimiento where tipomovimientoid=ptipomovimientoid;

   if iestatussocio=2 and ptipomovimientoid<>'PA' then
     raise exception 'No se pueden realizar movimientos en socios dados de BAJA.';
   end if;

   if stiposocioid='01' and
      (ptipomovimientoid='00') then
       raise exception 'El socio menor no puede realizar el tipo de movimiento %',ptipomovimientoid;
   end if;

   if stiposocioid='01' and ptipomovimientoid='AA' then
       raise exception 'El socio menor no puede realizar el tipo de movimiento %',ptipomovimientoid;
   end if;

   if stiposocioid='02' and ptipomovimientoid='AM' then
       raise exception 'El socio Mayor no puede realizar el tipo de movimiento %',ptipomovimientoid;
   end if;

   select sum(p.montoprestamo/tp.tantos) into fprestamos
    from prestamos p, tipoprestamo tp
   where p.socioid = psocioid and
         p.saldoprestamo>0 and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tipomovimientoid = ptipomovimientoid and
         tp.tantos>0 and
         p.claveestadocredito<>'008';

   select debe,haber into fdeposito,fretiro
    from movipolizas
   where movipolizaid=pmovipolizaid;

   if iestatussocio=1 and ptipomovimientoid='PA' and fretiro>0 then
     raise exception 'El socio debe pasar primeramente a informacin a realizar su BAJA Antes de realizar el retiro de su PARTE SOCIAL';
   end if;

   fdeposito := coalesce(fdeposito,0);
   fretiro := coalesce(fretiro,0);

   fprestamos := coalesce(fprestamos,0);

   -- Validar que el tipo de movimiento acepte el deposito o el retiro
   if fdeposito>0 and saceptadeposito='N' then
     raise exception 'En este tipo de movimiento % no se pueden realizar depositos.',ptipomovimientoid;
   end if;
   if fretiro>0 and saceptaretiro='N' then
     raise exception 'En el tipo de movimiento % no se pueden realizar retiros.',ptipomovimientoid;
   end if;


   -- Validar que no retire mas de lo que tiene en Saldo
   select sum(mp.debe)-sum(mp.haber) into fsaldo
     from movicaja mc, movipolizas mp
    where mc.socioid=psocioid and
          mc.tipomovimientoid=ptipomovimientoid and
          mp.movipolizaid=mc.movipolizaid;

   fsaldo:=coalesce(fsaldo,0);

   if saplicasaldo='S' and
      fretiro>fsaldo and
      ptipomovimientoid<>'IN' and
      ptipomovimientoid<>'RM' and
      ptipomovimientoid<>'RE' then
      raise exception 'El socio no puede retirar mas de su Saldo.';
   end if;

   -- Validar la promocion
   --if not validapromocion(psocioid,ptipomovimientoid,fretiro) then
   --  raise exception 'El socio no pude realizar retiro por que esta en una promocin';
   --end if;

   -- Verificar el retiro de interes al ahorro
   if ptipomovimientoid='IA' and fretiro>0 and fretiro<>fsaldo then
     raise exception 'El interes al ahorro debe ser retirado en su totalidad.';
   end if;


   if fretiro>0 then
     
    freciprocidad:=round(reciprocidadactual(psocioid,ptipomovimientoid),2);

    if fretiro>fsaldo-freciprocidad and saplicasaldo='S' and ptipomovimientoid<>'IN' and ptipomovimientoid<>'RM' and ptipomovimientoid<>'RE' then
        raise exception 'El socio no puede realizar este tipo de movimiento, es garantia de algun prestamo del socio.  Reciprocidad=%',freciprocidad;
    end if;

    if ptipomovimientoid = 'AA' then 
       freciprocidad:=round(reciprocidadactualAA(psocioid),2);
       if fretiro>fsaldo-freciprocidad and saplicasaldo='S' and ptipomovimientoid<>'IN' and ptipomovimientoid<>'RM' and ptipomovimientoid<>'RE' then
           raise exception 'El socio no puede realizar este tipo de movimiento, AA es garantia de algun prestamo del socio.  Reciprocidad=%',freciprocidad;
        end if;   
    end if;    
   end if;

----

   select sum(valor) into fdepositoefectivo from sabana where referenciacaja=preferenciacaja and seriecaja = pseriecaja and entradasalida=0 and denominacionid in (select denominacionid from denominacion where efectivo=1);

   if fdepositoefectivo >= fdeposito then
     pefectivo:=1;
   else
     pefectivo:=0;
   end if;

   insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,estatusmovicaja,inversionid,saldoactual,efectivo,fechahora,contratoid)
   values(psocioid,ptipomovimientoid,ppolizaid,preferenciacaja,pseriecaja,pmovipolizaid,pprestamoid,pestatusmovicaja,pinversionid,fsaldo,pefectivo,current_timestamp,pcontratoid);

   -- Insertando el numero de autorizacion
   
   imovicajaid:=currval('movicaja_movicajaid_seq');

   iautorizacionid:=trunc(pautorizacionid);

   update autorizabonificacion set movicajaid=imovicajaid,aplicado=1 where autorizacionid=iautorizacionid;
 

   --validar el pago de seguroy del ahorro reciprocidad en la tabla de amortizaciones
   
   if fdeposito > 0 and ptipomovimientoid in ('AA','AR','0A','0B','0C') and pprestamoid is not null then

      --raise notice ' Voy a aplicar en amortizaciones %',fdepaplicar;
   
      if ptipomovimientoid in ('AA','AR') then

          fdepaplicar:=fdeposito;

          for amort in select amortizacionid,ahorro,ahorropagado from amortizaciones where prestamoid=pprestamoid and ahorro> ahorropagado order by fechadepago
          loop
           if fdepaplicar > 0 then 
             if fdepaplicar > amort.ahorro-amort.ahorropagado then

                update amortizaciones set ahorropagado= amort.ahorro-amort.ahorropagado where amortizacionid=amort.amortizacionid;
                fdepaplicar:=  fdepaplicar- (amort.ahorro-amort.ahorropagado);
                
             else
             
                update amortizaciones set ahorropagado= fdepaplicar where amortizacionid=amort.amortizacionid;
                fdepaplicar:=  0;

             end if;
           end if;  
          end loop;
      end if;

      fdepaplicar:=0;
      
      if ptipomovimientoid in ('0A') then

          select sum(haber) into fdepaplicar from movipolizas where polizaid=ppolizaid and cuentaid in (select cuentadeposito from tipomovimiento where tipomovimientoid = ptipomovimientoid);
          
          fdepaplicar:=coalesce(fdepaplicar,0);

          for amort in select amortizacionid,cobranza,cobranzapagado from amortizaciones where prestamoid=pprestamoid and cobranza> cobranzapagado order by fechadepago
          loop
            if fdepaplicar > 0 then 
             if fdepaplicar > amort.cobranza-amort.cobranzapagado then

                update amortizaciones set cobranzapagado= amort.cobranza-amort.cobranzapagado where amortizacionid=amort.amortizacionid;
                fdepaplicar:=  fdepaplicar- (amort.cobranza-amort.cobranzapagado);
                
             else
             
                update amortizaciones set cobranzapagado= fdepaplicar where amortizacionid=amort.amortizacionid;
                fdepaplicar:=  0;

             end if;
            end if; 
          end loop;
      end if;

      fdepaplicar:=0;  

      if ptipomovimientoid in ('0C') then

          select sum(haber) into fdepaplicar from movipolizas where polizaid=ppolizaid and cuentaid in (select cuentadeposito from tipomovimiento where tipomovimientoid = ptipomovimientoid);
          
          fdepaplicar:=coalesce(fdepaplicar,0);

          raise notice ' Voy a aplicar el seguro %',fdepaplicar;
           
          for amort in select amortizacionid,seguro,seguropagado from amortizaciones where prestamoid=pprestamoid and seguro> seguropagado order by fechadepago
          loop

            if fdepaplicar > 0 then 

             if fdepaplicar > amort.seguro-amort.seguropagado then

                update amortizaciones set seguropagado= amort.seguro-amort.seguropagado where amortizacionid=amort.amortizacionid;
                fdepaplicar:=  fdepaplicar- (amort.seguro-amort.seguropagado);
                
             else
             
                update amortizaciones set seguropagado= fdepaplicar where amortizacionid=amort.amortizacionid;
                fdepaplicar:=  0;

             end if;

            end if;
            
          end loop;
          
      end if;
      
   end if;
   
------------------------------------------

-- Impuesto Deposito en efectivo

   raise notice ' Voy a efectuar el ide ';

   if saplicasaldo='S' and ptipomovimientoid<>'IN' and ptipomovimientoid<>'RM' and ptipomovimientoid<>'RE' and ptipomovimientoid<>'IP'  and  pefectivo=1 then

     select fechapoliza into pfecha from polizas where polizaid=ppolizaid;
     select cuentacaja into scuentacaja from parametros where serie_user=pseriecaja;

     select sumadepositos into fsumaefectivo from sumadepositos(ptipomovimientoid,pfecha,psocioid);
    
     
     if fsumaefectivo > fideexento then

      psaldo:=0;
      if fsumaefectivo-fdeposito > fideexento then 
         psaldo := fdeposito * fporide;
      else            
         psaldo := (fsumaefectivo-fideexento) * fporide;
      end if;

      --
      -- Dar de alta la poliza contable para el IDE
      --

      select fechapoliza into pfecha from polizas where polizaid=ppolizaid;
      select cuentacaja into scuentacaja from parametros where serie_user=pseriecaja;

      select cuentadeposito into scuentadeposito from tipomovimiento where tipomovimientoid='ID';


      select *
        into pnumero_poliza,preferencia
        from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',pseriecaja,'A');

      -- Encabezado de la poliza
      select * 
        into ppolizaid1
        from spipolizasfecha(preferencia,pseriecaja,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','IMPUESTO DEPOSITOS EN EFECTIVO',pfecha);

      -- Detalle de la poliza

      select *
        into pmovipolizaid1
        from spimovipoliza(ppolizaid1,scuentacaja,' ','C',psaldo,0,' ',' ','IDE');

      select *
        into pmovipolizaid2
        from spimovipoliza(ppolizaid1,scuentadeposito,' ','A',0,psaldo,' ',' ','IDE');

      insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,estatusmovicaja,inversionid,saldoactual,efectivo)
      values(psocioid,'ID',ppolizaid1,preferenciacaja,pseriecaja,pmovipolizaid1,NULL,pestatusmovicaja,NULL,0,1);


      -- Dar de alta la poliza retiro de caja para el IDE
      --
 
      select cuentaretiro into scuentadeposito from tipomovimiento where tipomovimientoid=ptipomovimientoid;


      select *
        into pnumero_poliza,preferencia
        from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',pseriecaja,'A');

      -- Encabezado de la poliza
      select * 
        into ppolizaid1
        from spipolizasfecha(preferencia,pseriecaja,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','IMPUESTO DEPOSITOS EN EFECTIVO',pfecha);

      -- Detalle de la poliza

      select *
        into pmovipolizaid1
        from spimovipoliza(ppolizaid1,scuentacaja,' ','A',0,psaldo,' ',' ','IDE');

      select *
        into pmovipolizaid2
        from spimovipoliza(ppolizaid1,scuentadeposito,' ','C',psaldo,0,' ',' ','IDE');


      insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,estatusmovicaja,inversionid,saldoactual,efectivo)
      values(psocioid,ptipomovimientoid,ppolizaid1,preferenciacaja,pseriecaja,pmovipolizaid1,NULL,pestatusmovicaja,NULL,0,1);

     end if;

   end if;
   
return currval('movicaja_movicajaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spimovicaja(integer, character, integer, integer, character, integer, integer, character, integer, integer, numeric) OWNER TO sistema;

--
-- Name: spimovicaja(integer, character, integer, integer, character, integer, integer, character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spimovicaja(integer, character, integer, integer, character, integer, integer, character, integer, integer) RETURNS integer
    AS $_$
declare
   psocioid          alias for $1;	
   ptipomovimientoid alias for $2;
   ppolizaid         alias for $3;
   preferenciacaja   alias for $4;
   pseriecaja        alias for $5;
   pmovipolizaid     alias for $6;
   pprestamoid       alias for $7;
   pestatusmovicaja  alias for $8;
   pinversionid      alias for $9;
   pcontratoid       alias for $10;
  
   amort record;

   fprestamos numeric;
   fretiro numeric;
   fdeposito numeric;
   fsaldo  numeric;

   iestatussocio int;

   saplicasaldo char(1);
   saceptadeposito char(1);
   saceptaretiro   char(1);

   stiposocioid char(2);

   fmontopartesocial numeric;
   fsaldopa numeric;
   ipartesocialcompleta int4;
  
   lsocioid int4;

   irepetido int4;

-- IDE

   fdepositoefectivo numeric;
   fsumaefectivo numeric;
   psaldo numeric;
   pefectivo integer;

   pfecha date;

   scuentacaja char(24);
   scuentadeposito char(24);

   pnumero_poliza int4;
   preferencia int4;

   lreferenciacaja int4;

   ppolizaid1 int4;
   pmovipolizaid1 int4;
   pmovipolizaid2 int4;
   fideexento numeric;
   fporide numeric;
   freciprocidad numeric;
   
   susuarioid character(20);

   fdepaplicar numeric;
   iautorizacionid integer;
   imovicajaid integer;
   ptipomovimientoret char(2);

   
begin


   
   --Abrir y cerrar cajas

---

 if ptipomovimientoid='00' then
     -- Validar que el prestamo corresponda al socio

     select socioid into lsocioid
       from prestamos where prestamoid=pprestamoid;
     if lsocioid<>psocioid then
       raise exception 'Verifique el prestamo no corresponde al socio !!!';
     end if;
   end if;

  

   if ptipomovimientoid='IN' then
     -- Validar que la inversion corresponda al socio

     select socioid into lsocioid
       from inversion where inversionid=pinversionid;
     if lsocioid<>psocioid then
       raise exception 'Verifique la inversion no corresponde al socio !!!';
     end if;

   end if;

   select estatussocio,tiposocioid into iestatussocio,stiposocioid
     from socio
    where socioid=psocioid;

   select montopartesocial,partesocialcompleta,ideexento,poride
       into fmontopartesocial,ipartesocialcompleta,fideexento,fporide
       from empresa where empresaid=1;


   if stiposocioid='02' and
      (ptipomovimientoid<>'00' and ptipomovimientoid<>'PA' and
       ptipomovimientoid<>'RE' and ptipomovimientoid<>'CH' and
       ptipomovimientoid<>'MG' and ptipomovimientoid<>'BS') then

   
     if ipartesocialcompleta=1 then
       -- Validar que tenga la parte social
       select sum(mp.debe)-sum(mp.haber) into fsaldopa
         from movicaja mc, movipolizas mp
        where mc.socioid=psocioid and
              mc.tipomovimientoid='PA' and
              mp.movipolizaid=mc.movipolizaid;
       fsaldopa:=coalesce(fsaldopa,0);

       if fsaldopa<fmontopartesocial then
         raise exception 'El socio no tiene cubierta su parte social';
       end if;
     end if;
   end if;

   select aplicasaldo,aceptadeposito,aceptaretiro
     into saplicasaldo,saceptadeposito,saceptaretiro
     from tipomovimiento where tipomovimientoid=ptipomovimientoid;

   if iestatussocio=2 and ptipomovimientoid<>'PA' then
     raise exception 'No se pueden realizar movimientos en socios dados de BAJA.';
   end if;

   if stiposocioid='01' and
      (ptipomovimientoid='00') then
       raise exception 'El socio menor no puede realizar el tipo de movimiento %',ptipomovimientoid;
   end if;

   if stiposocioid='01' and ptipomovimientoid='AA' then
       raise exception 'El socio menor no puede realizar el tipo de movimiento %',ptipomovimientoid;
   end if;

   if stiposocioid='02' and ptipomovimientoid='AM' then
       raise exception 'El socio Mayor no puede realizar el tipo de movimiento %',ptipomovimientoid;
   end if;

   select sum(p.montoprestamo/tp.tantos) into fprestamos
    from prestamos p, tipoprestamo tp
   where p.socioid = psocioid and
         p.saldoprestamo>0 and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tipomovimientoid = ptipomovimientoid and
         tp.tantos>0 and
         p.claveestadocredito<>'008';

   select debe,haber into fdeposito,fretiro
    from movipolizas
   where movipolizaid=pmovipolizaid;

   if iestatussocio=1 and ptipomovimientoid='PA' and fretiro>0 then
     raise exception 'El socio debe pasar primeramente a informaci?n a realizar su BAJA Antes de realizar el retiro de su PARTE SOCIAL';
   end if;

   fdeposito := coalesce(fdeposito,0);
   fretiro := coalesce(fretiro,0);

   fprestamos := coalesce(fprestamos,0);

   -- Validar que el tipo de movimiento acepte el deposito o el retiro
   if fdeposito>0 and saceptadeposito='N' then
     raise exception 'En este tipo de movimiento % no se pueden realizar depositos.',ptipomovimientoid;
   end if;
   if fretiro>0 and saceptaretiro='N' then
     raise exception 'En el tipo de movimiento % no se pueden realizar retiros.',ptipomovimientoid;
   end if;


   -- Validar que no retire mas de lo que tiene en Saldo
   select sum(mp.debe)-sum(mp.haber) into fsaldo
     from movicaja mc, movipolizas mp
    where mc.socioid=psocioid and
          mc.tipomovimientoid=ptipomovimientoid and
          mp.movipolizaid=mc.movipolizaid;

   fsaldo:=coalesce(fsaldo,0);

   if saplicasaldo='S' and
      fretiro>fsaldo and
      ptipomovimientoid<>'IN' and
      ptipomovimientoid<>'RM' and
      ptipomovimientoid<>'RE' then
      raise exception 'El socio no puede retirar mas de su Saldo.';
   end if;

   -- Validar la promocion
   --if not validapromocion(psocioid,ptipomovimientoid,fretiro) then
   --  raise exception 'El socio no pude realizar retiro por que esta en una promoci?n';
   --end if;

   -- Verificar el retiro de interes al ahorro
   if ptipomovimientoid='IA' and fretiro>0 and fretiro<>fsaldo then
     raise exception 'El interes al ahorro debe ser retirado en su totalidad.';
   end if;


   if fretiro>0 then
     
    freciprocidad:=round(reciprocidadactual(psocioid,ptipomovimientoid),2);

    if fretiro>fsaldo-freciprocidad and saplicasaldo='S' and ptipomovimientoid<>'IN' and ptipomovimientoid<>'RM' and ptipomovimientoid<>'RE' then
        raise exception 'El socio no puede realizar este tipo de movimiento, es garantia de algun prestamo del socio.  Reciprocidad=%',freciprocidad;
    end if;

    if ptipomovimientoid = 'AA' then 
       freciprocidad:=round(reciprocidadactualAA(psocioid),2);
       if fretiro>fsaldo-freciprocidad and saplicasaldo='S' and ptipomovimientoid<>'IN' and ptipomovimientoid<>'RM' and ptipomovimientoid<>'RE' then
           raise exception 'El socio no puede realizar este tipo de movimiento, AA es garantia de algun prestamo del socio.  Reciprocidad=%',freciprocidad;
        end if;   
    end if;    
   end if;

----

   select sum(valor) into fdepositoefectivo from sabana where referenciacaja=preferenciacaja and seriecaja = pseriecaja and entradasalida=0 and denominacionid in (select denominacionid from denominacion where efectivo=1);

   if fdepositoefectivo >= fdeposito then
     pefectivo:=1;
   else
     pefectivo:=0;
   end if;

   insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,estatusmovicaja,inversionid,saldoactual,efectivo,fechahora,contratoid)
   values(psocioid,ptipomovimientoid,ppolizaid,preferenciacaja,pseriecaja,pmovipolizaid,pprestamoid,pestatusmovicaja,pinversionid,fsaldo,pefectivo,current_timestamp,pcontratoid);

   -- Insertando el numero de autorizacion
   
  
------------------------------------------

-- Impuesto Deposito en efectivo

   raise notice ' Voy a efectuar el ide credito ';

   if ptipomovimientoid in ((select tipomovimientoid from tipomovimiento where tipomovimientoid<>'CI' and tipomovimientoid<>'IP'  and ptipomovimientoid<>'AH' and tipomovimientoid<>'RE' and aplicasaldo='S') union (select (case when exists (select socioid from datosfiscales where socioid =psocioid) then '**' else '00' end) )) and  pefectivo=1 then


     select fechapoliza into pfecha from polizas where polizaid=ppolizaid;
     select cuentacaja into scuentacaja from parametros where serie_user=pseriecaja;

     select sumadepositos into fsumaefectivo from sumadepositos(ptipomovimientoid,pfecha,psocioid);
         
     if fsumaefectivo > fideexento then

      psaldo:=0;
      if fsumaefectivo-fdeposito > fideexento then 
         psaldo := fdeposito * fporide;
      else            
         psaldo := (fsumaefectivo-fideexento) * fporide;
      end if;

      --
      -- Dar de alta la poliza contable para el IDE
      --

      select fechapoliza into pfecha from polizas where polizaid=ppolizaid;
      select cuentacaja into scuentacaja from parametros where serie_user=pseriecaja;

      select cuentadeposito into scuentadeposito from tipomovimiento where tipomovimientoid='ID';


      select *
        into pnumero_poliza,preferencia
        from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',pseriecaja,'A');

      -- Encabezado de la poliza
      select * 
        into ppolizaid1
        from spipolizasfecha(preferencia,pseriecaja,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','IMPUESTO DEPOSITOS EN EFECTIVO',pfecha);

      -- Detalle de la poliza

      select *
        into pmovipolizaid1
        from spimovipoliza(ppolizaid1,scuentacaja,' ','C',psaldo,0,' ',' ','IDE');

      select *
        into pmovipolizaid2
        from spimovipoliza(ppolizaid1,scuentadeposito,' ','A',0,psaldo,' ',' ','IDE');

      insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,estatusmovicaja,inversionid,saldoactual,efectivo)
      values(psocioid,'ID',ppolizaid1,preferenciacaja,pseriecaja,pmovipolizaid1,NULL,pestatusmovicaja,NULL,0,1);


      -- Dar de alta la poliza retiro de caja para el IDE
      --
 
      if ptipomovimientoid <> '00' then
            select cuentaretiro into scuentadeposito from tipomovimiento where tipomovimientoid=ptipomovimientoid;
            ptipomovimientoret:=ptipomovimientoid;
      else
            select cuentaretiro,tipomovimientoid into scuentadeposito,ptipomovimientoret from tipomovimiento where tipomovimientoid in (select tp.tipomovimientoid from prestamos p, tipoprestamo tp where p.prestamoid=pprestamoid and p.tipoprestamoid=tp.tipoprestamoid);
      end if;      

      raise notice ' cuenta retiro %  sumadepositos %  ide % ',scuentadeposito,fsumaefectivo,psaldo;
      
      select *
        into pnumero_poliza,preferencia
        from rconspoliza(cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),'D',pseriecaja,'A');

      -- Encabezado de la poliza
      select * 
        into ppolizaid1
        from spipolizasfecha(preferencia,pseriecaja,'A',pnumero_poliza,cast(date_part('year',pfecha) as int),cast(date_part('month',pfecha) as int),' ',pfecha,'D',' ',' ','IMPUESTO DEPOSITOS EN EFECTIVO',pfecha);

      -- Detalle de la poliza

      select *
        into pmovipolizaid1
        from spimovipoliza(ppolizaid1,scuentacaja,' ','A',0,psaldo,' ',' ','IDE');

      select *
        into pmovipolizaid2
        from spimovipoliza(ppolizaid1,scuentadeposito,' ','C',psaldo,0,' ',' ','IDE');


      insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,estatusmovicaja,inversionid,saldoactual,efectivo)
      values(psocioid,ptipomovimientoret,ppolizaid1,preferenciacaja,pseriecaja,pmovipolizaid1,NULL,pestatusmovicaja,NULL,0,1);

     end if;

   end if;
   
return currval('movicaja_movicajaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spimovicaja(integer, character, integer, integer, character, integer, integer, character, integer, integer) OWNER TO sistema;

--
-- Name: spimovicajaministrar(integer, character, integer, integer, character, integer, integer, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spimovicajaministrar(integer, character, integer, integer, character, integer, integer, character, integer) RETURNS integer
    AS $_$
declare
   psocioid          alias for $1;	
   ptipomovimientoid alias for $2;
   ppolizaid         alias for $3;
   preferenciacaja   alias for $4;
   pseriecaja        alias for $5;
   pmovipolizaid     alias for $6;
   pprestamoid       alias for $7;
   pestatusmovicaja  alias for $8;
   pinversionid      alias for $9;

   fprestamos numeric;
   fretiro numeric;
   fdeposito numeric;
   fsaldo  numeric;

   iestatussocio int;

   saplicasaldo char(1);
   saceptadeposito char(1);
   saceptaretiro   char(1);

   stiposocioid char(2);

   fmontopartesocial numeric;
   fsaldopa numeric;
   ipartesocialcompleta int4;
  
   lsocioid int4;

   irepetido int4;

-- IDE

   fdepositoefectivo numeric;
   fsumaefectivo numeric;
   psaldo numeric;
   pefectivo integer;

   pfecha date;

   scuentacaja char(24);
   scuentadeposito char(24);

   pnumero_poliza int4;
   preferencia int4;

   lreferenciacaja int4;

   ppolizaid1 int4;
   pmovipolizaid1 int4;
   pmovipolizaid2 int4;
   fideexento numeric;
   fporide numeric;
      
begin

   select estatussocio,tiposocioid into iestatussocio,stiposocioid
     from socio
    where socioid=psocioid;

  select montopartesocial,partesocialcompleta,ideexento,poride
       into fmontopartesocial,ipartesocialcompleta,fideexento,fporide
       from empresa where empresaid=1;

   select aplicasaldo,aceptadeposito,aceptaretiro
     into saplicasaldo,saceptadeposito,saceptaretiro
     from tipomovimiento where tipomovimientoid=ptipomovimientoid;

   pefectivo:=0;

   insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,estatusmovicaja,inversionid,saldoactual,efectivo)
   values(psocioid,ptipomovimientoid,ppolizaid,preferenciacaja,pseriecaja,pmovipolizaid,pprestamoid,pestatusmovicaja,pinversionid,fsaldo,pefectivo);

   
return currval('movicaja_movicajaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spimovicajaministrar(integer, character, integer, integer, character, integer, integer, character, integer) OWNER TO sistema;

--
-- Name: spimovicajaseguro(integer, character, integer, integer, character, integer, integer, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spimovicajaseguro(integer, character, integer, integer, character, integer, integer, character, integer) RETURNS integer
    AS $_$
declare
   psocioid          alias for $1;	
   ptipomovimientoid alias for $2;
   ppolizaid         alias for $3;
   preferenciacaja   alias for $4;
   pseriecaja        alias for $5;
   pmovipolizaid     alias for $6;
   pprestamoid       alias for $7;
   pestatusmovicaja  alias for $8;
   pinversionid      alias for $9;

   fprestamos numeric;
   fretiro numeric;
   fdeposito numeric;
   fsaldo  numeric;

   iestatussocio int;

   saplicasaldo char(1);
   saceptadeposito char(1);
   saceptaretiro   char(1);

   stiposocioid char(2);

   fmontopartesocial numeric;
   fsaldopa numeric;
   ipartesocialcompleta int4;
  
   lsocioid int4;

   irepetido int4;

-- IDE

   fdepositoefectivo numeric;
   fsumaefectivo numeric;
   psaldo numeric;
   pefectivo integer;

   pfecha date;

   scuentacaja char(24);
   scuentadeposito char(24);

   pnumero_poliza int4;
   preferencia int4;

   lreferenciacaja int4;

   ppolizaid1 int4;
   pmovipolizaid1 int4;
   pmovipolizaid2 int4;
   fideexento numeric;
   fporide numeric;
      
begin

   select estatussocio,tiposocioid into iestatussocio,stiposocioid
     from socio
    where socioid=psocioid;

  select montopartesocial,partesocialcompleta,ideexento,poride
       into fmontopartesocial,ipartesocialcompleta,fideexento,fporide
       from empresa where empresaid=1;

   select aplicasaldo,aceptadeposito,aceptaretiro
     into saplicasaldo,saceptadeposito,saceptaretiro
     from tipomovimiento where tipomovimientoid=ptipomovimientoid;

   pefectivo:=0;

   insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,prestamoid,estatusmovicaja,inversionid,saldoactual,efectivo)
   values(psocioid,ptipomovimientoid,ppolizaid,preferenciacaja,pseriecaja,pmovipolizaid,pprestamoid,pestatusmovicaja,pinversionid,fsaldo,pefectivo);

   
return currval('movicaja_movicajaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spimovicajaseguro(integer, character, integer, integer, character, integer, integer, character, integer) OWNER TO sistema;

--
-- Name: spimovipoliza(integer, character, character, character, numeric, numeric, character, character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spimovipoliza(integer, character, character, character, numeric, numeric, character, character, character varying) RETURNS integer
    AS $_$
declare
   ppolizaid         alias for $1;	
   pcuentaid         alias for $2;
   preferencia_mov   alias for $3;
   ptipo_mov         alias for $4;
   pdebe             alias for $5;
   phaber	     alias for $6;
   pdiario_mov       alias for $7;
   pidentific_descr  alias for $8;
   pdescripcion      alias for $9;

begin

   insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)
    values(ppolizaid,pcuentaid,preferencia_mov,ptipo_mov,round(pdebe,2),round(phaber,2),pdiario_mov,pidentific_descr,pdescripcion);
            
return currval('movipolizas_movipolizaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spimovipoliza(integer, character, character, character, numeric, numeric, character, character, character varying) OWNER TO sistema;

--
-- Name: spimovipoliza(integer, character, character, character, numeric, numeric, character, character, character varying, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spimovipoliza(integer, character, character, character, numeric, numeric, character, character, character varying, integer, integer) RETURNS integer
    AS $_$
declare
   ppolizaid         alias for $1;	
   pcuentaid         alias for $2;
   preferencia_mov   alias for $3;
   ptipo_mov         alias for $4;
   pdebe             alias for $5;
   phaber	     alias for $6;
   pdiario_mov       alias for $7;
   pidentific_descr  alias for $8;
   pdescripcion      alias for $9;
   pprestamoid       alias for $10;
   pinversionid      alias for $11;

begin

   insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion,prestamoid,inversionid)
    values(ppolizaid,pcuentaid,preferencia_mov,ptipo_mov,round(pdebe,2),round(phaber,2),pdiario_mov,pidentific_descr,pdescripcion,pprestamoid,pinversionid);
            
return currval('movipolizas_movipolizaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spimovipoliza(integer, character, character, character, numeric, numeric, character, character, character varying, integer, integer) OWNER TO sistema;

--
-- Name: spimprimesolicitud(integer); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION spimprimesolicitud(integer) RETURNS text
    AS $_$
declare
psocioid alias for $1;
begin
select so.nosolicitud,s.nombre||' '||s.paterno||' '||s.materno as nombre ,d.teldomicilio,d.calle||' '||d.numero_int||' '||d.numero_ext||' '||d.colonia as domicilio, ci.nombreciudadmex,
       es.nombreestadomex,s.fecha_nacimiento,na.nombreciudadmex as ciudadnacimiento,s.rfc,so.sexo,so.estadocivilid,so.regimenmatrimonial,so.ocupacion,so.profesion
       from solicitudingreso so,sujeto s, socio sc, domicilio d,ciudadesmex ci,estadosmex es, ciudadesmex na
where so.sujetoid = s.sujetoid and 
      sc.socioid = so.socioid  and 
      d.sujetoid = s.sujetoid  and 
      d.ciudadmexid = ci.ciudadmexid and
      ci.estadomexid = es.estadomexid and
      na.ciudadmexid = so.ciudadmexid and
      s.sujetoid=psocioid
      ;

return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spimprimesolicitud(integer) OWNER TO postgres;

--
-- Name: spimprimesolicitudi(integer); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION spimprimesolicitudi(integer) RETURNS text
    AS $_$
declare
psocioid alias for $1;
begin
select so.nosolicitud,s.nombre||' '||s.paterno||' '||s.materno as nombre ,d.teldomicilio,d.calle||' '||d.numero_int||' '||d.numero_ext||' '||d.colonia as domicilio, ci.nombreciudadmex,
       es.nombreestadomex,s.fecha_nacimiento,na.nombreciudadmex as ciudadnacimiento,s.rfc,so.sexo,so.estadocivilid,so.regimenmatrimonial,so.ocupacion,so.profesion
       from solicitudingreso so,sujeto s, socio sc, domicilio d,ciudadesmex ci,estadosmex es, ciudadesmex na
where so.sujetoid = s.sujetoid and 
      sc.socioid = so.socioid  and 
      d.sujetoid = s.sujetoid  and 
      d.ciudadmexid = ci.ciudadmexid and
      ci.estadomexid = es.estadomexid and
      na.ciudadmexid = so.ciudadmexid and
      s.sujetoid=psocioid
      ;

return pformato;
end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spimprimesolicitudi(integer) OWNER TO postgres;

--
-- Name: spiocupacion(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiocupacion(character) RETURNS integer
    AS $_$
declare
  pocupacion      alias for $1;

 
begin

  insert into ocupacion(ocupacion)
    values(pocupacion );

        
return currval('ocupacion_ocupacionid_seq');

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiocupacion(character) OWNER TO sistema;

--
-- Name: spiparametro(character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiparametro(character, character, character) RETURNS integer
    AS $_$
declare
  pusuarioid alias for $1;
  pserieuser alias for $2;
  pcuentaid  alias for $3;
begin

   insert into parametros(usuarioid,serie_user,cuentacaja)
    values( pusuarioid,
            pserieuser,
            pcuentaid );
            
return currval('parametros_parametroid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiparametro(character, character, character) OWNER TO sistema;

--
-- Name: spiparametro(character, character, character, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiparametro(character, character, character, character, character, integer) RETURNS integer
    AS $_$                                                                                                                                                            
declare                                                                                                                                                      
  pusuarioid alias for $1;                           sorareporte alias for $5;                                                                                                                            
  preporteslaser alias for $6;                                                                                                                               
                                                                                                                                                             
begin                                                                                                                                                        
                                                                                                                                                             
   insert into parametros(usuarioid,serie_user,cuentacaja,                                                                                                   
          impresoracaja,impresorareporte,reporteslaser)                                                                                                      
    values( pusuarioid,                                                                                                                                      
            pserieuser,                                                                                                                                      
            pcuentaid,                                                                                                                                       
            pimpresoracaja,                                                                                                                                  
            pimpresorareporte,                                                                                                                               
            preporteslaser);                                                                                                                                 
                                                                                                                                                             
return currval('parametros_parametroid_seq');                                                                                                              
end                                                                                                                                                          
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiparametro(character, character, character, character, character, integer) OWNER TO sistema;

--
-- Name: spiparametro(character, character, character, character, character, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiparametro(character, character, character, character, character, integer, character) RETURNS integer
    AS $_$
declare
  pusuarioid alias for $1;
  pserieuser alias for $2;
  pcuentaid  alias for $3;
  pimpresoracaja alias for $4;
  pimpresorareporte alias for $5;
  preporteslaser alias for $6;
  pclavesocioint alias for $7;

begin

   insert into parametros(usuarioid,serie_user,cuentacaja,
          impresoracaja,impresorareporte,reporteslaser,
          clavesocioint)
    values( pusuarioid,
            pserieuser,
            pcuentaid,
            pimpresoracaja,
            pimpresorareporte,
            preporteslaser,
            pclavesocioint);
            
return currval('parametros_parametroid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiparametro(character, character, character, character, character, integer, character) OWNER TO sistema;

--
-- Name: spiparametro(character, character, character, character, character, integer, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiparametro(character, character, character, character, character, integer, character, date) RETURNS integer
    AS $_$
declare
  pusuarioid alias for $1;
  pserieuser alias for $2;
  pcuentaid  alias for $3;
  pimpresoracaja alias for $4;
  pimpresorareporte alias for $5;
  preporteslaser alias for $6;
  pclavesocioint alias for $7;
  pfecha alias for $8;

begin

   insert into parametros(usuarioid,serie_user,cuentacaja,
          impresoracaja,impresorareporte,reporteslaser,
          clavesocioint,fechapassword)
    values( pusuarioid,
            pserieuser,
            pcuentaid,
            pimpresoracaja,
            pimpresorareporte,
            preporteslaser,
            pclavesocioint,
            CURRENT_DATE);
            
return currval('parametros_parametroid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiparametro(character, character, character, character, character, integer, character, date) OWNER TO sistema;

--
-- Name: spipermisomodulo(character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spipermisomodulo(character, character, character) RETURNS integer
    AS $_$
declare
  pclavemodulo alias for $1;
  pusuarioid alias for $2;
  ppermiso alias for $3;

begin

   insert into permisosmodulos(clavemodulo,usuarioid,permiso)
    values( pclavemodulo,
            pusuarioid,
            ppermiso);

return currval('permisosmodulos_permisomoduloid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spipermisomodulo(character, character, character) OWNER TO sistema;

--
-- Name: spipoliza(integer, character, character, integer, integer, integer, character, date, character, character, character, text, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spipoliza(integer, character, character, integer, integer, integer, character, date, character, character, character, text, date) RETURNS integer
    AS $_$
declare

  preferencia            alias for $1;
  pserie                 alias for $2;
  ptipo                  alias for $3;
  pnumero_poliza         alias for $4;
  pejercicio             alias for $5;
  pperiodo               alias for $6;
  pidentificacion        alias for $7;
  pfecha                 alias for $8;
  ptipo_poliza           alias for $9;
  pclase_poliza          alias for $10;
  pdiario_agrupador      alias for $11;
  pconcepto_poliza       alias for $12;
  pfecha_fin_aceptacion  alias for $13;

  pref int4;
  pnopol int4;

  ppermiso char(1);
begin


   if periodovalido(pejercicio,pperiodo)=0 then
     raise exception 'El periodo % del Ejercicio % se encuentra CERRADO !!!',pperiodo,pejercicio;
   end if;


   select p.permiso
     into ppermiso
     from parametros pa, permisosmodulos p
    where pa.serie_user = pserie and
          p.usuarioid = pa.usuarioid and
          p.clavemodulo = 'POLANT';

   ppermiso := coalesce(ppermiso,'N');

   if pfecha<>CURRENT_DATE then
      -- DESCOMENTAR EL RAISE SI SE QUIERE VALIDACION
     if ppermiso='N' then
       raise exception 'Verifique la fecha, la fecha proporcionada es diferente a la fecha del SERVIDOR';
     end if;
   end if;

   select coalesce(max(numero_poliza),0)
    into pnopol
    from polizas
   where ejercicio=pejercicio and
         periodo=pperiodo and
         tipo_poliza=ptipo_poliza;

   pnopol:=pnopol+1;

   select coalesce(max(referencia),0) into pref
     from polizas where seriepoliza=pserie and tipo=ptipo;

   pref := pref+1;

   insert into polizas( referencia,seriepoliza,tipo,numero_poliza,ejercicio,periodo,fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,concepto_poliza,fecha_fin_aceptacion )
    values( pref,pserie,ptipo,pnopol,pejercicio,pperiodo,pfecha,ptipo_poliza,pclase_poliza,pdiario_agrupador,pconcepto_poliza,pfecha_fin_aceptacion );
            
return currval('polizas_polizaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spipoliza(integer, character, character, integer, integer, integer, character, date, character, character, character, text, date) OWNER TO sistema;

--
-- Name: spipolizasfecha(integer, character, character, integer, integer, integer, character, date, character, character, character, text, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spipolizasfecha(integer, character, character, integer, integer, integer, character, date, character, character, character, text, date) RETURNS integer
    AS $_$
declare

  preferencia            alias for $1;
  pserie                 alias for $2;
  ptipo                  alias for $3;
  pnumero_poliza         alias for $4;
  pejercicio             alias for $5;
  pperiodo               alias for $6;
  pidentificacion        alias for $7;
  pfecha                 alias for $8;
  ptipo_poliza           alias for $9;
  pclase_poliza          alias for $10;
  pdiario_agrupador      alias for $11;
  pconcepto_poliza       alias for $12;
  pfecha_fin_aceptacion  alias for $13;

  pref int4;
  pnopol int4;
begin

   if pfecha<>CURRENT_DATE then
     -- DESCOMENTAR EL RAISE SI SE QUIERE VALIDACION
     -- raise exception 'Verifique la fecha, la fecha proporcionada es diferente a la fecha del SERVIDOR';
   end if;

   select coalesce(max(numero_poliza),0)
    into pnopol
    from polizas
   where ejercicio=pejercicio and
         periodo=pperiodo and
         tipo_poliza=ptipo_poliza;

   pnopol:=pnopol+1;

   select coalesce(max(referencia),0) into pref
     from polizas where seriepoliza=pserie and tipo=ptipo;

   pref := pref+1;

   insert into polizas( referencia,seriepoliza,tipo,numero_poliza,ejercicio,periodo,fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,concepto_poliza,fecha_fin_aceptacion )
    values( pref,pserie,ptipo,pnopol,pejercicio,pperiodo,pfecha,ptipo_poliza,pclase_poliza,pdiario_agrupador,pconcepto_poliza,pfecha_fin_aceptacion );
            
return currval('polizas_polizaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spipolizasfecha(integer, character, character, integer, integer, integer, character, date, character, character, character, text, date) OWNER TO sistema;

--
-- Name: spiprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, integer) RETURNS integer
    AS $_$
declare

 preferenciaprestamo alias for $1;
 pmontoprestamo      alias for $2;
 psaldoprestamo      alias for $3;
 pnumero_de_amor     alias for $4;
 pfecha_otorga       alias for $5;
 pfecha_vencimiento  alias for $6;
 ptipoprestamoid     alias for $7;
 ptasanormal         alias for $8;
 ptasa_moratoria     alias for $9;
 psocioid            alias for $10;
 pdias_de_cobro      alias for $11;
 pmeses_de_cobro     alias for $12;
 pdia_mes_cobro      alias for $13;
 pfecha_1er_pago     alias for $14;
 pclavegarantia      alias for $15;
 pmonto_garantia     alias for $16;
 pclaveestadocredito alias for $17;
 pautorizaprestamo   alias for $18;
 pfinalidadprestamo  alias for $19;
 pcalculonormalid    alias for $20;
 pcalculomoratorioid alias for $21;
 pessobreprestamo    alias for $22;
 psolicitudprestamoid alias for $23;
 pnorenovaciones     alias for $24;
 pformalizado        alias for $25;
 pcondicionid        alias for $26;
 pclasificacioncreditoid alias for $27;
 psujetoid           alias for $28;
 ptipoacreditadoid   alias for $29;
 pfechavaluaciongarantia alias for $30;
 pprestamodescontado alias for $31;
 pinversionid alias for $32;

 ahorro numeric;
 ahorromin varchar;
 prestamossocio integer;
 itantos integer;
 stipomovimientoid char(2);

 sreferenciaprestamo char(18);

 lgenero int4;

 sclavesocioint char(15);
 stiposocioid char(2);

 iestatussocio int4;

 ptasanormal1 numeric;
 ptasa_moratoria1 numeric; 

begin


  select clavesocioint,tiposocioid,estatussocio
    into sclavesocioint,stiposocioid,iestatussocio
    from socio
   where socioid=psocioid;

   if iestatussocio=2 then
     raise exception 'No se pueden otorgar prestamos a socios dados de baja !!!';
   end if;


   if NOT FOUND then
     raise exception 'Clave de socio no encontrada, Verifique este correcta !!';
   end if;

   if stiposocioid='01' then
     raise exception 'El socio menor no puede realizar este tipo de movimiento.';
   end if;

  -- Validar la reciprocidad antes de dar de alta el prestamo

  select referenciaprestamo
    into sreferenciaprestamo
    from prestamos
   where referenciaprestamo=preferenciaprestamo;

  if FOUND then
    raise exception 'Un prestamo con igual referencia ya fue dado de alta, verifique !!!';
  end if;

  select tantos,tipomovimientoid into itantos,stipomovimientoid
    from tipoprestamo
   where tipoprestamoid=ptipoprestamoid;

  select sum(mp.debe)-sum(mp.haber) into ahorro
    from movicaja mc, movipolizas mp
   where mc.socioid=psocioid and
         mp.movipolizaid=mc.movipolizaid and
         mc.tipomovimientoid=stipomovimientoid;

  ahorro := coalesce(round(ahorro,2),0);

  -- Restar la reciprocidad de prestamos anteriores activos
  -- Pendiente

  ahorro := ahorro - recicreditos(psocioid,stipomovimientoid) + 10;

  if pessobreprestamo=0 then

    -- Verificar la reciprocidad del prestamo
    if (ahorro*itantos)<pmontoprestamo and itantos>0 then
      ahorro := ahorro - 10;
      raise exception 'No cumple con la reciprocidad: Socio=% Ahorro %  Tantos %  Monto=%',sclavesocioint,ahorro,itantos,pmontoprestamo;
    end if;
    
    -- Validar que no tenga mas de 2 presamos activos y que no sean
    select count(*) into prestamossocio
      from prestamos
     where socioid=psocioid and
           saldoprestamo>0 and
           claveestadocredito<>'008';
  end if;

  prestamossocio := coalesce(prestamossocio,0);

  if pessobreprestamo=0 then
    if prestamossocio>=5 then
      raise exception 'El socio tiene % prestamos activos, no se puede otorgar otro prestamo.',prestamossocio;
    end if;
  end if;

  select tasanormal,tasamoratoria into ptasanormal1,ptasa_moratoria1 from 
spstasastipoprestamo(ptipoprestamoid,pmontoprestamo,psocioid,preferenciaprestamo);

  ptasanormal1:=coalesce(ptasanormal1,ptasanormal);
  ptasa_moratoria1:=coalesce(ptasa_moratoria1,ptasa_moratoria);



if psujetoid>0 then
   insert into prestamos(referenciaprestamo, montoprestamo, saldoprestamo, numero_de_amor, fecha_otorga, fecha_vencimiento, tipoprestamoid, 
tasanormal, tasa_moratoria, socioid, dias_de_cobro, meses_de_cobro, dia_mes_cobro, fecha_1er_pago, clavegarantia, monto_garantia, 
claveestadocredito, usuarioid, clavefinalidad, calculonormalid, calculomoratorioid, 
fechaultimopago,solicitudprestamoid,norenovaciones,formalizado,condicionid,clasificacioncreditoid,sujetoid,tipoacreditadoid,fechavaluaciongarantia,prestamodescontado)
    values( preferenciaprestamo,pmontoprestamo, pmontoprestamo, pnumero_de_amor, pfecha_otorga, pfecha_vencimiento, ptipoprestamoid, 
ptasanormal1, ptasa_moratoria1, psocioid, pdias_de_cobro, pmeses_de_cobro, pdia_mes_cobro, pfecha_1er_pago, pclavegarantia, pmonto_garantia, 
'001', pautorizaprestamo, pfinalidadprestamo, pcalculonormalid, pcalculomoratorioid, 
pfecha_otorga,psolicitudprestamoid,pnorenovaciones,pformalizado,pcondicionid,pclasificacioncreditoid,psujetoid,ptipoacreditadoid,pfecha_otorga,pprestamodescontado);
else
   insert into prestamos(referenciaprestamo, montoprestamo, saldoprestamo, numero_de_amor, fecha_otorga, fecha_vencimiento, tipoprestamoid, 
tasanormal, tasa_moratoria, socioid, dias_de_cobro, meses_de_cobro, dia_mes_cobro, fecha_1er_pago, clavegarantia, monto_garantia, 
claveestadocredito, usuarioid, clavefinalidad, calculonormalid, calculomoratorioid, 
fechaultimopago,solicitudprestamoid,norenovaciones,formalizado,condicionid,clasificacioncreditoid,sujetoid,tipoacreditadoid,fechavaluaciongarantia,prestamodescontado)
    values( preferenciaprestamo,pmontoprestamo, pmontoprestamo, pnumero_de_amor, pfecha_otorga, pfecha_vencimiento, ptipoprestamoid, 
ptasanormal1, ptasa_moratoria1, psocioid, pdias_de_cobro, pmeses_de_cobro, pdia_mes_cobro, pfecha_1er_pago, pclavegarantia, pmonto_garantia, 
'001', pautorizaprestamo, pfinalidadprestamo, pcalculonormalid, pcalculomoratorioid, 
pfecha_otorga,psolicitudprestamoid,pnorenovaciones,pformalizado,pcondicionid,pclasificacioncreditoid,NULL,ptipoacreditadoid,pfecha_otorga,pprestamodescontado);
end if;

  
  -- Generar las amortizaciones aqui
  select * into lgenero from generaramortizaciones(preferenciaprestamo,0,pfecha_otorga);

--  if psolicitudprestamoid is not null then
   if psolicitudprestamoid>0 then
     update avales
        set prestamoid = (select prestamoid from prestamos where referenciaprestamo=preferenciaprestamo)
      where solicitudprestamoid = psolicitudprestamoid;
   end if;
--  end if;

 --  raise exception 'Llega bien al alta';         
return currval('prestamos_prestamoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, integer) OWNER TO sistema;

--
-- Name: spiprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, numeric, integer, numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, numeric, integer, numeric, integer) RETURNS integer
    AS $_$
declare

 preferenciaprestamo alias for $1;
 pmontoprestamo      alias for $2;
 psaldoprestamo      alias for $3;
 pnumero_de_amor     alias for $4;
 pfecha_otorga       alias for $5;
 pfecha_vencimiento  alias for $6;
 ptipoprestamoid     alias for $7;
 ptasanormal         alias for $8;
 ptasa_moratoria     alias for $9;
 psocioid            alias for $10;
 pdias_de_cobro      alias for $11;
 pmeses_de_cobro     alias for $12;
 pdia_mes_cobro      alias for $13;
 pfecha_1er_pago     alias for $14;
 pclavegarantia      alias for $15;
 pmonto_garantia     alias for $16;
 pclaveestadocredito alias for $17;
 pautorizaprestamo   alias for $18;
 pfinalidadprestamo  alias for $19;
 pcalculonormalid    alias for $20;
 pcalculomoratorioid alias for $21;
 pessobreprestamo    alias for $22;
 psolicitudprestamoid alias for $23;
 pnorenovaciones     alias for $24;
 pformalizado        alias for $25;
 pcondicionid        alias for $26;
 pclasificacioncreditoid alias for $27;
 psujetoid           alias for $28;
 ptipoacreditadoid   alias for $29;
 pfechavaluaciongarantia alias for $30;
 pprestamodescontado alias for $31;
 pcomision alias for $32;
 ptipocobrocomision alias for $33;
 pahorrocompromiso alias for $34;
 pinteresanticipado alias for $35;
 
 ahorro numeric;
 ahorromin varchar;
 
 prestamossocio integer;
 itantos integer;
 
 stipomovimientoid char(2);
 sreferenciaprestamo char(18);

 lgenero int4;

 sclavesocioint char(15);
 stiposocioid char(2);

 iestatussocio int4; 

 ptasanormal1 numeric;
 ptasa_moratoria1 numeric;
 
begin

  select clavesocioint,tiposocioid,estatussocio
    into sclavesocioint,stiposocioid,iestatussocio
    from socio
   where socioid=psocioid;


   if pnumero_de_amor=1 and ptipoprestamoid <> 'P1' and ptipoprestamoid <> 'P4' then
      raise exception 'El tipo P1 es el unico que puede ser de 1 amortizacion!';
   end if;

   if iestatussocio=2 then
     raise exception 'No se pueden otorgar prestamos a socios dados de baja !';
   end if;

   if NOT FOUND then
     raise exception 'Clave de socio no encontrada, Verifique este correcta !';
   end if;

   if stiposocioid='01' then
     raise exception 'El socio menor no puede realizar este tipo de movimiento.';
   end if;

  -- Validar la reciprocidad antes de dar de alta el prestamo

  select referenciaprestamo
    into sreferenciaprestamo
    from prestamos
   where referenciaprestamo=preferenciaprestamo;

  if FOUND then
    raise exception 'Un prestamo con igual referencia ya fue dado de alta, verifique !';
  end if;

  select tantos,tipomovimientoid into itantos,stipomovimientoid
    from tipoprestamo
   where tipoprestamoid=ptipoprestamoid;

  select sum(mp.debe)-sum(mp.haber) into ahorro
    from movicaja mc, movipolizas mp
   where mc.socioid=psocioid and
         mp.movipolizaid=mc.movipolizaid and
         mc.tipomovimientoid=stipomovimientoid;

  ahorro := coalesce(round(ahorro,2),0);

  -- Restar la reciprocidad de prestamos anteriores activos
  -- Pendiente

  ahorro := ahorro - recicreditos(psocioid,stipomovimientoid) + 10;

  if pessobreprestamo=0 then

    -- Verificar la reciprocidad del prestamo
    if (ahorro*itantos)<pmontoprestamo and itantos>0 then
      ahorro := ahorro - 10;
      raise exception 'No cumple con la reciprocidad: Socio=% Ahorro %  Tantos %  Monto=%',sclavesocioint,ahorro,itantos,pmontoprestamo;
    end if;
    
    -- Validar que no tenga mas de 2 presamos activos y que no sean
    select count(*) into prestamossocio
      from prestamos
     where socioid=psocioid and
           saldoprestamo>0 and
           claveestadocredito<>'008';
  end if;

  prestamossocio := coalesce(prestamossocio,0);

  if pessobreprestamo=0 then
    if prestamossocio>=5 then
      raise exception 'El socio tiene % prestamos activos, no se puede otorgar otro prestamo.',prestamossocio;
    end if;
  end if;

  select tasanormal,tasamoratoria into ptasanormal1,ptasa_moratoria1 from spstasastipoprestamo(ptipoprestamoid,pmontoprestamo,psocioid,preferenciaprestamo);

  ptasanormal1:=coalesce(ptasanormal1,ptasanormal);
  ptasa_moratoria1:=coalesce(ptasa_moratoria1,ptasa_moratoria);

if psujetoid>0 then

   insert into prestamos(referenciaprestamo, montoprestamo, saldoprestamo, numero_de_amor, fecha_otorga, fecha_vencimiento, tipoprestamoid, tasanormal, tasa_moratoria, socioid, dias_de_cobro, meses_de_cobro, dia_mes_cobro, fecha_1er_pago, clavegarantia, monto_garantia, claveestadocredito, usuarioid, clavefinalidad, calculonormalid, calculomoratorioid, fechaultimopago,solicitudprestamoid,norenovaciones,formalizado,condicionid,clasificacioncreditoid,sujetoid,tipoacreditadoid,fechavaluaciongarantia,prestamodescontado,comision,tipocobrocomision,ahorrocompromiso,interesanticipado)
    values( preferenciaprestamo,pmontoprestamo, pmontoprestamo, pnumero_de_amor, pfecha_otorga, pfecha_vencimiento, ptipoprestamoid, ptasanormal1, ptasa_moratoria1, psocioid, pdias_de_cobro, pmeses_de_cobro, pdia_mes_cobro, pfecha_1er_pago, pclavegarantia, pmonto_garantia, '001', pautorizaprestamo, pfinalidadprestamo, pcalculonormalid, pcalculomoratorioid, pfecha_otorga,psolicitudprestamoid,pnorenovaciones,pformalizado,pcondicionid,pclasificacioncreditoid,psujetoid,ptipoacreditadoid,pfecha_otorga,pprestamodescontado,pcomision,ptipocobrocomision,pahorrocompromiso,pinteresanticipado);
    
else

   insert into prestamos(referenciaprestamo, montoprestamo, saldoprestamo, numero_de_amor, fecha_otorga, fecha_vencimiento, tipoprestamoid, tasanormal, tasa_moratoria, socioid, dias_de_cobro, meses_de_cobro, dia_mes_cobro, fecha_1er_pago, clavegarantia, monto_garantia, claveestadocredito, usuarioid, clavefinalidad, calculonormalid, calculomoratorioid, fechaultimopago,solicitudprestamoid,norenovaciones,formalizado,condicionid,clasificacioncreditoid,sujetoid,tipoacreditadoid,fechavaluaciongarantia,prestamodescontado,comision,tipocobrocomision,ahorrocompromiso,interesanticipado)
    values( preferenciaprestamo,pmontoprestamo, pmontoprestamo, pnumero_de_amor, pfecha_otorga, pfecha_vencimiento, ptipoprestamoid, ptasanormal1, ptasa_moratoria1, psocioid, pdias_de_cobro, pmeses_de_cobro, pdia_mes_cobro, pfecha_1er_pago, pclavegarantia, pmonto_garantia, '001', pautorizaprestamo, pfinalidadprestamo, pcalculonormalid, pcalculomoratorioid, pfecha_otorga,psolicitudprestamoid,pnorenovaciones,pformalizado,pcondicionid,pclasificacioncreditoid,NULL,ptipoacreditadoid,pfecha_otorga,pprestamodescontado,pcomision,ptipocobrocomision,pahorrocompromiso,pinteresanticipado);
    
end if;
  
  -- Generar las amortizaciones aqui
  select * into lgenero from generaramortizaciones(preferenciaprestamo,0,pfecha_otorga);

--  if psolicitudprestamoid is not null then
   if psolicitudprestamoid>0 then
     update avales
        set prestamoid = (select prestamoid from prestamos where referenciaprestamo=preferenciaprestamo)
      where solicitudprestamoid = psolicitudprestamoid;
   end if;
--  end if;

 --  raise exception 'Llega bien al alta';         
return currval('prestamos_prestamoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, numeric, integer, numeric, integer) OWNER TO sistema;

--
-- Name: spiprocampo(character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiprocampo(character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric) RETURNS integer
    AS $_$
declare

 ptipoprestamoid     alias for $1; 
 pbeneficiarioid     alias for $2; 
 psujetoid           alias for $3; 
 preferenciaprestamo alias for $4; 
 pmontoprestamo      alias for $5; 
 psaldoprestamo      alias for $6; 
 pnumero_de_amor     alias for $7; 
 pfecha_otorga       alias for $8; 
 pfecha_vencimiento  alias for $9; 
 ptasanormal         alias for $10;
 ptasa_moratoria     alias for $11;
 pdias_de_cobro      alias for $12;
 pmeses_de_cobro     alias for $13;
 pdia_mes_cobro      alias for $14;
 pfecha_1er_pago     alias for $15;
 pfechaultimopago    alias for $16;
 pnohectareas        alias for $17;
 pcredxhec           alias for $18;
 pcomxhec            alias for $19;
 pcomxch             alias for $20;
 pinteres            alias for $21;
 pmontoentregado     alias for $22;

begin

   insert into procampo(tipoprestamoid,beneficiarioid,sujetoid, referenciaprestamo, montoprestamo, saldoprestamo, numero_de_amor, fecha_otorga, fecha_vencimiento, tasanormal, tasa_moratoria, dias_de_cobro, meses_de_cobro, dia_mes_cobro, fecha_1er_pago, fechaultimopago, nohectareas, credxhec, comxhec, comxch, interes, montoentregado)
    values(ptipoprestamoid,pbeneficiarioid,psujetoid, preferenciaprestamo, pmontoprestamo, psaldoprestamo, pnumero_de_amor, pfecha_otorga, pfecha_vencimiento, ptasanormal, ptasa_moratoria, pdias_de_cobro, pmeses_de_cobro, pdia_mes_cobro, pfecha_1er_pago, pfechaultimopago, pnohectareas, pcredxhec, pcomxhec, pcomxch, pinteres, pmontoentregado);

       
return currval('procampo_procampoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiprocampo(character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric) OWNER TO sistema;

--
-- Name: spiprocampo(character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiprocampo(character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric) RETURNS integer
    AS $_$
declare

 ptipoprestamoid     alias for $1; 
 pbeneficiarioid     alias for $2; 
 psujetoid           alias for $3; 
 preferenciaprestamo alias for $4; 
 pmontoprestamo      alias for $5; 
 psaldoprestamo      alias for $6; 
 pnumero_de_amor     alias for $7; 
 pfecha_otorga       alias for $8; 
 pfecha_vencimiento  alias for $9; 
 ptasanormal         alias for $10;
 ptasa_moratoria     alias for $11;
 pdias_de_cobro      alias for $12;
 pmeses_de_cobro     alias for $13;
 pdia_mes_cobro      alias for $14;
 pfecha_1er_pago     alias for $15;
 pfechaultimopago    alias for $16;
 pnohectareas        alias for $17;
 pcredxhec           alias for $18;
 pcomxhec            alias for $19;
 pcomxch             alias for $20;
 pinteres            alias for $21;
 pmontoentregado     alias for $22;
 pasesorid           alias for $23;
 pcomisionasesor     alias for $24;

begin

   insert into procampo(tipoprestamoid,beneficiarioid,sujetoid, referenciaprestamo, montoprestamo, saldoprestamo, numero_de_amor, fecha_otorga, fecha_vencimiento, tasanormal, tasa_moratoria, dias_de_cobro, meses_de_cobro, dia_mes_cobro, fecha_1er_pago, fechaultimopago, nohectareas, credxhec, comxhec, comxch, interes, montoentregado,
asesorid,comisionasesor)
    values(ptipoprestamoid,pbeneficiarioid,psujetoid, preferenciaprestamo, pmontoprestamo, psaldoprestamo, pnumero_de_amor, pfecha_otorga, pfecha_vencimiento, ptasanormal, ptasa_moratoria, pdias_de_cobro, pmeses_de_cobro, pdia_mes_cobro, pfecha_1er_pago, pfechaultimopago, pnohectareas, pcredxhec, pcomxhec, pcomxch, pinteres, pmontoentregado,
pasesorid,pcomisionasesor);

       
return currval('procampo_procampoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiprocampo(character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric) OWNER TO sistema;

--
-- Name: spipromocion(integer, integer, date, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spipromocion(integer, integer, date, date, integer) RETURNS integer
    AS $_$
declare
  ptipopromocionid alias for $1;
  psocioid         alias for $2;
  pfechaalta       alias for $3;
  pfechabaja       alias for $4;
  pestatus         alias for $5;

begin

   insert into promocion(tipopromocionid,socioid,fechaalta,fechabaja,estatus)
    values(ptipopromocionid,
           psocioid,
           pfechaalta,
           pfechabaja,
           pestatus);          

return currval('promocion_promocionid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spipromocion(integer, integer, date, date, integer) OWNER TO sistema;

--
-- Name: spirango(character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spirango(character varying) RETURNS integer
    AS $_$
declare
   pnombrerango alias for $1;
begin

   insert into rango(nombrerango)
    values( pnombrerango );
            
return currval('rango_rangoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spirango(character varying) OWNER TO sistema;

--
-- Name: spirecargos(integer, integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spirecargos(integer, integer, numeric) RETURNS integer
    AS $_$
declare
  pano alias for $1;
  pmes alias for $2;
  pporcentaje alias for $3;
 begin

   insert into recargos(ano,mes,porcentaje)
    values(pano,pmes,pporcentaje);
            

return pano;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spirecargos(integer, integer, numeric) OWNER TO sistema;

--
-- Name: spirelacion(integer, integer, integer, integer, character varying, numeric, integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spirelacion(integer, integer, integer, integer, character varying, numeric, integer, integer, integer, integer) RETURNS integer
    AS $_$
declare

  prelacionid alias for $1;
  psolicitudingresoid alias for $2;
  psujetoid alias for $3;
  psocioid alias for $4;
  pparentesco alias for $5;
  pporcentaje alias for $6;
  pesbeneficiario alias for $7;
  pesreferenciapersonal alias for $8;
  pesrepresentante alias for $9;
  pescotitular alias for $10;

  lsocioid int4;

  tsocioid int4;
  tsujetoid int4;
begin

   select socioid,sujetoid
     into tsocioid,tsujetoid
     from solicitudingreso
    where solicitudingresoid =  psolicitudingresoid;

   tsocioid:=coalesce(tsocioid,0);
   tsujetoid:=coalesce(tsujetoid,0);


   select socioid
     into lsocioid
     from socio
    where sujetoid = psujetoid;

   lsocioid := coalesce(lsocioid,0);


   if (tsocioid>0 and tsocioid=lsocioid) or tsujetoid=psujetoid then
     raise exception 'El mismo socio no puede ser su propia relacion, Verifique su captura !!!';
   end if;


   if lsocioid>0 then
     insert into relacion(solicitudingresoid,sujetoid,socioid,parentesco,porcentaje,esbenficiario,esreferenciapersonal,esrepresentante,escotitular)
      values( psolicitudingresoid,psujetoid,lsocioid,pparentesco,pporcentaje,
              pesbeneficiario,pesreferenciapersonal,pesrepresentante,pescotitular);
   else
      insert into relacion(solicitudingresoid,sujetoid,socioid,parentesco,porcentaje,esbenficiario,esreferenciapersonal,esrepresentante,escotitular)
      values( psolicitudingresoid,psujetoid,NULL,pparentesco,pporcentaje,
              pesbeneficiario,pesreferenciapersonal,pesrepresentante,pescotitular);
   end if;

return currval('relacion_relacionid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spirelacion(integer, integer, integer, integer, character varying, numeric, integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: spisabana(integer, integer, character, integer, date, numeric, integer, integer, character varying, character varying, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spisabana(integer, integer, character, integer, date, numeric, integer, integer, character varying, character varying, character varying) RETURNS integer
    AS $_$
declare
   pdenominacionid  alias for $1;
   psocioid         alias for $2;
   pseriecaja       alias for $3;
   preferenciacaja  alias for $4;
   pfecha           alias for $5;
   pvalor           alias for $6;
   pcantidad        alias for $7;
   pentradasalida   alias for $8;
   pnumcheque       alias for $9;
   pbanco           alias for $10;
   pnocta           alias for $11;

   iefectivo integer;
  

begin

   insert into sabana(denominacionid,socioid,seriecaja,referenciacaja,fecha,valor,cantidad,entradasalida,numcheque,banco,nocta)
    values(pdenominacionid,psocioid,pseriecaja,preferenciacaja,pfecha,pvalor,pcantidad,pentradasalida,pnumcheque,pbanco,pnocta);


   select efectivo into iefectivo from denominacion where denominacionid=pdenominacionid;
   update movicaja set efectivo=iefectivo where referenciacaja=preferenciacaja and seriecaja=pseriecaja;


return currval('sabana_sabanaid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spisabana(integer, integer, character, integer, date, numeric, integer, integer, character varying, character varying, character varying) OWNER TO sistema;

--
-- Name: spiscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, integer) RETURNS integer
    AS $_$
declare

  psolicitudprestamoid alias for $1;
  pavalid alias for $2;
  pgenero alias for $3;
  pestadocivil alias for $4;
  ptipovivienda alias for $5;
  ptiempoendomicilio alias for $6;
  ptiempoentrabajo alias for $7;
  pingresomensual alias for $8;
  pegresomensual alias for $9;
  pdependienteseconomicos alias for $10;
  pcalificacionburo alias for $11;


  pexiste int4;

  l int4;
begin

  select count(*) into pexiste from scoring
   where avalid = pavalid and
         solicitudprestamoid = psolicitudprestamoid;

  pexiste:=coalesce(pexiste,0);

  if pexiste=0 then
    insert into scoring(solicitudprestamoid,avalid,genero,tipovivienda,
                  tiempoendomicilio,tiempoentrabajo,ingresomensual,
                  egresomensual,
                  dependienteseconomicos,calificacionburo,
                  estadocivil)
      values (psolicitudprestamoid,pavalid,pgenero,ptipovivienda,
                  ptiempoendomicilio,ptiempoentrabajo,pingresomensual,
                  pegresomensual,
                  pdependienteseconomicos,pcalificacionburo,
                  pestadocivil);

return currval('scoring_scoringid_seq');

  else

   update scoring
      set solicitudprestamoid = psolicitudprestamoid,
          avalid = pavalid,
          genero = pgenero,
          estadocivil = pestadocivil,
          tipovivienda = ptipovivienda,
          tiempoendomicilio = ptiempoendomicilio,
          ingresomensual = pingresomensual,
          egresomensual = pegresomensual,
          dependienteseconomicos = pdependienteseconomicos,
          calificacionburo = pcalificacionburo
    where avalid=pavalid;

select scoringid into l from scoring where avalid=pavalid;
    return l;
  end if;


end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, integer) OWNER TO sistema;

--
-- Name: spiscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, integer, character, character, character, character, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, integer, character, character, character, character, integer, character) RETURNS integer
    AS $_$
declare

  psolicitudprestamoid alias for $1;
  pavalid alias for $2;
  pgenero alias for $3;
  pestadocivil alias for $4;
  ptipovivienda alias for $5;
  ptiempoendomicilio alias for $6;
  ptiempoentrabajo alias for $7;
  pingresomensual alias for $8;
  pegresomensual alias for $9;
  pdependienteseconomicos alias for $10;
  pcalificacionburo alias for $11;

  ptelefono1 alias for $12;
  ptelefono2 alias for $13;
  pfuenteingreso alias for $14;
  pactividad alias for $15;
  pverificado alias for $16;

  pobs alias for $17;

  pexiste int4;

  l int4;
begin

  select count(*) into pexiste from scoring
   where avalid = pavalid and
         solicitudprestamoid = psolicitudprestamoid;

  pexiste:=coalesce(pexiste,0);

  if pexiste=0 then
    insert into scoring(solicitudprestamoid,avalid,genero,tipovivienda,
                  tiempoendomicilio,tiempoentrabajo,ingresomensual,
                  egresomensual,
                  dependienteseconomicos,calificacionburo,
                  estadocivil,
                  telefono1,telefono2,fuenteingreso,actividad,verificado,obs
                  )
      values (psolicitudprestamoid,pavalid,pgenero,ptipovivienda,
                  ptiempoendomicilio,ptiempoentrabajo,pingresomensual,
                  pegresomensual,
                  pdependienteseconomicos,pcalificacionburo,
                  pestadocivil,
                  ptelefono1,ptelefono2,pfuenteingreso,pactividad,pverificado,pobs
              );

   return currval('scoring_scoringid_seq');

  else

   update scoring
      set solicitudprestamoid = psolicitudprestamoid,
          avalid = pavalid,
          genero = pgenero,
          estadocivil = pestadocivil,
          tipovivienda = ptipovivienda,
          tiempoendomicilio = ptiempoendomicilio,
          ingresomensual = pingresomensual,
          egresomensual = pegresomensual,
          dependienteseconomicos = pdependienteseconomicos,
          calificacionburo = pcalificacionburo,
          telefono1 = ptelefono1,
          telefono2 = ptelefono2,
          fuenteingreso = pfuenteingreso,
          actividad = pactividad,
          verificado = pverificado,
          obs = pobs
    where avalid=pavalid;

    select scoringid into l from scoring where avalid=pavalid;
    return l;
  end if;


end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, integer, character, character, character, character, integer, character) OWNER TO sistema;

--
-- Name: spisocio(integer, integer, character, integer, integer, character, date, date, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spisocio(integer, integer, character, integer, integer, character, date, date, integer, integer) RETURNS integer
    AS $_$
declare
  psocioid alias for $1;
  psujetoid alias for $2;
  ptiposocioid alias for $3;
  pdocumentacionid alias for $4;
  pdatoingresoid alias for $5;
  pclavesocioint alias for $6;
  pfechaalta alias for $7;
  pfechabaja alias for $8;
  prepresentanteid alias for $9;
  pestatussocio    alias for $10;

  oldestatus int4;
  lsaldo numeric;
  lsaldop numeric;
  itiposocioid int4;
begin

   select estatussocio,tiposocioid into oldestatus,itiposocioid
     from socio
    where socioid=psocioid;

   
   if oldestatus=1 and pestatussocio=2 and itiposocioid=2 then
     -- Validar que no tenga ni prestamos ni saldos en movimientos
     select saldo into lsaldo
       from spssaldosmov(psocioid)
      where tipomovimientoid<>'PA';

     lsaldo:=coalesce(lsaldo,0);

     if lsaldo>0 then
       raise exception 'El socio debe tener saldos de 0 para poder realizar la BAJA, excepto en Parte Social.';
     end if;

     select sum(saldoprestamo) int lsaldop
       from prestamos
      where socioid=psocioid and claveestadocredito='001' and saldoprestamo>0;

     lsaldop := coalesce(lsaldop,0);

     if lsaldop>0 then
       raise exception 'El socio no debe tener adeudos de prestamos para realizar la BAJA, Verifiquelo !!!';
     end if;

   end if;

   update socio
    set sujetoid = psujetoid,
        tiposocioid = ptiposocioid,
        documentacionid = pdocumentacionid,
        datoingresoid = pdatoingresoid,
        clavesocioint = pclavesocioint,
        fechaalta = pfechaalta,
        fechabaja = pfechabaja,
        representanteid = prepresentanteid,
        estatussocio = pestatussocio
   where socioid = psocioid;     

return psocioid;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spisocio(integer, integer, character, integer, integer, character, date, date, integer, integer) OWNER TO sistema;

--
-- Name: spisocio(integer, character, integer, integer, character, date, date, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spisocio(integer, character, integer, integer, character, date, date, integer, integer) RETURNS integer
    AS $_$
declare
  psujetoid        alias for $1;
  ptiposocioid     alias for $2;
  pdocumentacionid alias for $3;
  pdatoingresoid   alias for $4;
  pclavesocioint   alias for $5;
  pfechaalta       alias for $6;
  pfechabaja       alias for $7;
  prepresentanteid alias for $8;
  pestatussocio    alias for $9;

  sclavesocioint char(15);

begin

   --select nextsocio() into sclavesocioint;
   select clavesocioint into sclavesocioint
     from socio
    where clavesocioint=pclavesocioint;
   if FOUND then
     raise exception 'Un socio ya tiene asignada esa clave, no se pueden repetir claves de socio.';
   end if;

   insert into socio(sujetoid,tiposocioid,documentacionid,datoingresoid,clavesocioint,fechaalta,fechabaja,representanteid,estatussocio)
    values( psujetoid,
            ptiposocioid,
	    pdocumentacionid,
            pdatoingresoid,
            pclavesocioint,
            pfechaalta,
            pfechabaja,
            prepresentanteid,
            pestatussocio);
    
return currval('socio_socioid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spisocio(integer, character, integer, integer, character, date, date, integer, integer) OWNER TO sistema;

--
-- Name: spisocio(integer, integer, character, character, date, date, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spisocio(integer, integer, character, character, date, date, integer, integer, integer) RETURNS integer
    AS $_$
declare
  psocioid alias for $1;
  psujetoid alias for $2;
  ptiposocioid alias for $3;
  pclavesocioint alias for $4;
  pfechaalta alias for $5;
  pfechabaja alias for $6;
  pestatussocio    alias for $7;
  psolicitudingresoid alias for $8;
  pmotivobajaid alias for $9;

  sclavesocioint char(15);

begin


   sclavesocioint:='';

   select clavesocioint
     into sclavesocioint
     from socio
    where clavesocioint=pclavesocioint;

raise notice '*%* *%*',sclavesocioint,pclavesocioint;
   if sclavesocioint=pclavesocioint then
     raise exception 'Un socio ya tiene asignada esa clave, no se pueden repetir claves de socio.';

   end if;

   insert into socio(sujetoid,tiposocioid,clavesocioint,fechaalta,fechabaja,estatussocio,solicitudingresoid,motivobajaid)
    values( psujetoid,
            ptiposocioid,
            pclavesocioint,
            pfechaalta,
            pfechabaja,
            pestatussocio,
            psolicitudingresoid,
            pmotivobajaid);
    
return currval('socio_socioid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spisocio(integer, integer, character, character, date, date, integer, integer, integer) OWNER TO sistema;

--
-- Name: spisolicitudingreso(integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spisolicitudingreso(integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text) RETURNS integer
    AS $_$
declare

  pnosolicitud            alias for $1;
  pfechasolicitud         alias for $2;
  pfechaingreso           alias for $3;

  psocioid                alias for $4;
  psujetoid               alias for $5;
  pciudadmexid            alias for $6;
  psexo                   alias for $7;
  pnivelestudiosid        alias for $8;

  pprofesion              alias for $9;
  pocupacion              alias for $10;
  ptipocasaid             alias for $11;
  pestadocivilid          alias for $12;
  pconyugeid              alias for $13;

  pregimenmatrimonial     alias for $14;
  ptiempovivirendomicilio alias for $15;
  pmotivoingresoid        alias for $16;

  pmedioseenteroid        alias for $17;
  pperteneceaotracaja     alias for $18;
  potracaja               alias for $19;
  pclaveescuela           alias for $20;

  pnombreescuela          alias for $21;
  ppersonaautorizadaid    alias for $22;
  pusuarioid              alias for $23;
  plastusuarioid          alias for $24;

  plastupdate             alias for $25;
  ptiposocioid            alias for $26;
  pobservaciones          alias for $27;
  
  lnosolicitud int4;
begin

   raise notice 'Insertando solicitud --> %',pnosolicitud;

   select max(coalesce(nosolicitud,0)+1)
     into lnosolicitud
     from solicitudingreso;

   lnosolicitud:=coalesce(lnosolicitud,1);

   insert into
    solicitudingreso(nosolicitud,
           fechasolicitud,         
           fechaingreso,           
           socioid,                
           sujetoid,               
           ciudadmexid,            
           sexo,                   
           nivelestudiosid,          
           profesion,              
           ocupacion,              
           tipocasaid,             
           estadocivilid,          
           conyugeid,              
           regimenmatrimonial,     
           tiempovivirendomicilio, 
           motivoingresoid,        
           medioseenteroid,        
           perteneceaotracaja,     
           otracaja,               
           claveescuela,           
           nombreescuela,          
           personaautorizadaid,    
           usuarioid,              
           lastusuarioid,          
           lastupdate,
           tiposocioid,
           observaciones )
    values(lnosolicitud,
           pfechasolicitud,         
           pfechaingreso,           
           NULL,                
           psujetoid,               
           pciudadmexid,            
           psexo,                   
           pnivelestudiosid,          
           pprofesion,              
           pocupacion,              
           ptipocasaid,             
           pestadocivilid,          
           NULL,              
           pregimenmatrimonial,     
           ptiempovivirendomicilio, 
           pmotivoingresoid,        
           pmedioseenteroid,        
           pperteneceaotracaja,     
           potracaja,               
           pclaveescuela,           
           pnombreescuela,          
           NULL,    
           pusuarioid,              
           plastusuarioid,          
           plastupdate,
           ptiposocioid,
           pobservaciones);
    
return currval('solicitudingreso_solicitudingresoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spisolicitudingreso(integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text) OWNER TO sistema;

--
-- Name: spisolicitudingreso(integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text, integer, text, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spisolicitudingreso(integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text, integer, text, integer) RETURNS integer
    AS $_$
declare

  pnosolicitud            alias for $1;
  pfechasolicitud         alias for $2;
  pfechaingreso           alias for $3;

  psocioid                alias for $4;
  psujetoid               alias for $5;
  pciudadmexid            alias for $6;
  psexo                   alias for $7;
  pnivelestudiosid        alias for $8;

  pprofesion              alias for $9;
  pocupacion              alias for $10;
  ptipocasaid             alias for $11;
  pestadocivilid          alias for $12;
  pconyugeid              alias for $13;

  pregimenmatrimonial     alias for $14;
  ptiempovivirendomicilio alias for $15;
  pmotivoingresoid        alias for $16;

  pmedioseenteroid        alias for $17;
  pperteneceaotracaja     alias for $18;
  potracaja               alias for $19;
  pclaveescuela           alias for $20;

  pnombreescuela          alias for $21;
  ppersonaautorizadaid    alias for $22;
  pusuarioid              alias for $23;
  plastusuarioid          alias for $24;

  plastupdate             alias for $25;
  ptiposocioid            alias for $26;
  pobservaciones          alias for $27;

  pdoccompleta            alias for $28;
  pdocfaltante            alias for $29;
  ppersonajuridicaid      alias for $30;

  lnosolicitud int4;

  lrepetido int4;


  lconyugeid int4;

begin

   if pconyugeid=0 then
     lconyugeid := NULL;
   else
     lconyugeid := pconyugeid;
   end if;

   if  pestadocivilid = 1 and pconyugeid=0 then
     raise exception 'Debe teclear el conyuge si la persona es casada';
   end if;

   raise notice 'Sujeto Buscado %',psujetoid;

   select MIN(nosolicitud)
     into lrepetido
     from solicitudingreso
    where sujetoid=psujetoid;

   lrepetido:=coalesce(lrepetido,0);

   if lrepetido>0 then
     raise exception 'Existe la Solicitud % para esta misma persona',lrepetido;
   end if;

   raise notice 'Insertando solicitud --> %',pnosolicitud;

   select max(coalesce(nosolicitud,0)+1)
     into lnosolicitud
     from solicitudingreso;

   lnosolicitud:=coalesce(lnosolicitud,1);

   insert into
    solicitudingreso(nosolicitud,
           fechasolicitud,         
           fechaingreso,           
           socioid,                
           sujetoid,               
           ciudadmexid,            
           sexo,                   
           nivelestudiosid,          
           profesion,              
           ocupacion,              
           tipocasaid,             
           estadocivilid,          
           conyugeid,              
           regimenmatrimonial,     
           tiempovivirendomicilio, 
           motivoingresoid,        
           medioseenteroid,        
           perteneceaotracaja,     
           otracaja,               
           claveescuela,           
           nombreescuela,          
           personaautorizadaid,    
           usuarioid,              
           lastusuarioid,          
           lastupdate,
           tiposocioid,
           observaciones,
           doccompleta,
           docfaltante,
           personajuridicaid)
    values(lnosolicitud,
           pfechasolicitud,         
           pfechaingreso,           
           NULL,                
           psujetoid,               
           pciudadmexid,            
           psexo,                   
           pnivelestudiosid,          
           pprofesion,              
           pocupacion,              
           ptipocasaid,             
           pestadocivilid,          
           lconyugeid,              
           pregimenmatrimonial,     
           ptiempovivirendomicilio, 
           pmotivoingresoid,        
           pmedioseenteroid,        
           pperteneceaotracaja,     
           potracaja,               
           pclaveescuela,           
           pnombreescuela,          
           NULL,    
           pusuarioid,              
           plastusuarioid,          
           plastupdate,
           ptiposocioid,
           pobservaciones,
           pdoccompleta,
           pdocfaltante,
           ppersonajuridicaid);
    
return currval('solicitudingreso_solicitudingresoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spisolicitudingreso(integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text, integer, text, integer) OWNER TO sistema;

--
-- Name: spisolicitudprestamo(integer, integer, integer, character, character, character, integer, integer, date, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric, integer, numeric, numeric, date, date, character varying, date, integer, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spisolicitudprestamo(integer, integer, integer, character, character, character, integer, integer, date, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric, integer, numeric, numeric, date, date, character varying, date, integer, integer, character) RETURNS integer
    AS $_$
declare
  
  psolicitudprestamoid alias for $1;
  psocioid alias for $2;
  psujetoid alias for $3;
  ptipoprestamoid alias for $4;
  pclavefinalidad alias for $5;
  pclavegarantia alias for $6;
  pdomicilioid alias for $7;
  pnosolicitud alias for $8;
  pfechasolicitud alias for $9;
  psueldo alias for $10;
  psueldoconyuge alias for $11;
  potrosingresos alias for $12;
  ptotalingresos alias for $13;
  pgastosordinarios alias for $14;
  potrosgastos alias for $15;
  potrosabonos alias for $16;
  ptotalegresos alias for $17;
  pcapacidadpago alias for $18;
  pvalorpropiedades alias for $19;
  ptotaldeudas alias for $20;
  pabonospropuestos alias for $21;
  pmontosolicitado alias for $22;
  pperiodopagoid alias for $23;
  ptasanormal alias for $24;
  ptasamoratorio alias for $25;
  pfecharesultado alias for $26;
  pfechaentrega alias for $27;
  pactano alias for $28;
  pfechacomite alias for $29;
  presolucionid alias for $30;
  pentregado alias for $31;
  pusuarioid alias for $32;

  ptasanormal1 numeric;
  ptasamoratorio1 numeric;


begin


  select tasanormal,tasamoratoria into ptasanormal1,ptasamoratorio1 from spstasastipoprestamo(ptipoprestamoid,pmontosolicitado,psocioid,' ');

  ptasanormal1:=coalesce(ptasanormal1,ptasanormal);
  ptasamoratorio1:=coalesce(ptasamoratorio1,ptasamoratorio);


  if pabonospropuestos=1 and ptipoprestamoid <> 'P1' and ptipoprestamoid <> 'P4'then
      raise exception 'El tipo P1 es el unico que puede ser de 1 amortizacion!';
  end if;

  if ptotalingresos <=  ptotalegresos then 
     raise exception 'Los egresos son mayores o iguales  a los ingresos.';
  end if;

  insert into
    solicitudprestamo(
      socioid,            
      sujetoid,           
      tipoprestamoid,     
      clavefinalidad,     
      clavegarantia,      
      domicilioid,        
      nosolicitud,        
      fechasolicitud,     
      sueldo,             
      sueldoconyuge,      
      otrosingresos,      
      totalingresos,      
      gastosordinarios,   
      otrosgastos,        
      otrosabonos,        
      totalegresos,       
      capacidadpago,      
      valorpropiedades,   
      totaldeudas,        
      abonospropuestos,   
      montosolicitado,    
      periodopagoid,      
      tasanormal,         
      tasamoratorio,      
      fecharesultado,     
      fechaentrega,       
      actano,             
      fechacomite,        
      resolucionid,       
      entregado,          
      usuarioid,
      lastusuarioid)

 values(
      psocioid,            
      psujetoid,           
      ptipoprestamoid,     
      pclavefinalidad,     
      pclavegarantia,     
      pdomicilioid,        
      pnosolicitud,        
      pfechasolicitud,     
      psueldo,             
      psueldoconyuge,      
      potrosingresos,      
      ptotalingresos,      
      pgastosordinarios,   
      potrosgastos,        
      potrosabonos,        
      ptotalegresos,       
      pcapacidadpago,      
      pvalorpropiedades,   
      ptotaldeudas,        
      pabonospropuestos,   
      pmontosolicitado,    
      pperiodopagoid,      
      ptasanormal1,         
      ptasamoratorio1,      
      pfecharesultado,     
      pfechaentrega,       
      pactano,             
      pfechacomite,        
      presolucionid,       
      pentregado,          
      pusuarioid,
      pusuarioid);



return currval('solicitudprestamo_solicitudprestamoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spisolicitudprestamo(integer, integer, integer, character, character, character, integer, integer, date, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric, integer, numeric, numeric, date, date, character varying, date, integer, integer, character) OWNER TO sistema;

--
-- Name: spisubrango(integer, character, character, integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spisubrango(integer, character, character, integer, numeric) RETURNS integer
    AS $_$
declare
  prangoid alias for $1;
  prangoinicial alias for $2;
  prangofinal alias for $3;
  poperacion alias  for $4;
  pfactor alias  for $5;
begin

   insert into subrango(rangoid,rangoinicial,rangofinal,operacion,factor)
    values( prangoid,
            prangoinicial,
            prangofinal,
            poperacion,
            pfactor);
            

return currval('subrango_subrangoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spisubrango(integer, character, character, integer, numeric) OWNER TO sistema;

--
-- Name: spisujeto(character varying, character varying, character varying, character, character, integer, date, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spisujeto(character varying, character varying, character varying, character, character, integer, date, character varying) RETURNS integer
    AS $_$
declare
  ppaterno alias for $1;
  pmaterno alias for $2;
  pnombre alias for $3;
  prfc alias for $4;
  pcurp alias for $5;
  pedad alias for $6;
  pfecha_nacimiento alias for $7;
  prazonsocial alias for $8;

  psujetoid int4;
begin

   if pfecha_nacimiento='01-01-1900' then
     --raise exception 'La fecha de nacimiento es incorrecta, Verifique !!!';
   end if;

-- Verificar si ya existe el sujeto

   select MIN(sujetoid) into psujetoid
    from sujeto
   where upper(rtrim(paterno))=upper(rtrim(ppaterno)) and
         upper(rtrim(materno))=upper(rtrim(pmaterno)) and
         upper(rtrim(nombre))=upper(rtrim(pnombre)) and
         upper(rtrim(rfc))=upper(rtrim(prfc));

   psujetoid := coalesce(psujetoid,0);

   if psujetoid>0 then
     -- Ya existe
     update sujeto  
        set paterno = ppaterno,
            materno = pmaterno,
            nombre = pnombre,
            rfc = prfc,
            curp = pcurp,
            edad = pedad,
            fecha_nacimiento = pfecha_nacimiento,
            razonsocial = prazonsocial
      where sujetoid = psujetoid;     
     return psujetoid;
   else
     -- El sujeto no existe
     insert into
            sujeto(paterno,materno,nombre,rfc,curp,edad,fecha_nacimiento,razonsocial)
     values(ppaterno,
            pmaterno,
            pnombre,
            prfc,
            pcurp,
            pedad,
            pfecha_nacimiento,
            prazonsocial);
     return currval('sujeto_sujetoid_seq');
   end if;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spisujeto(character varying, character varying, character varying, character, character, integer, date, character varying) OWNER TO sistema;

--
-- Name: spitablon(integer, date, text, character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitablon(integer, date, text, character, character, date) RETURNS integer
    AS $_$
declare

  psocioid        alias for $1;
  pfechatablon    alias for $2;
  ptextotablon    alias for $3;
  pvigente        alias for $4;
  pusuarioid      alias for $5;
  pfechavigencia  alias for $6;

begin

   insert into tablon(socioid,fechatablon,textotablon,vigente,usuarioid,fechavigencia)
   values(psocioid,pfechatablon,ptextotablon,pvigente,pusuarioid,pfechavigencia);

return currval('tablon_tablonid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitablon(integer, date, text, character, character, date) OWNER TO sistema;

--
-- Name: spitipo_garantia(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipo_garantia(character, character varying) RETURNS character
    AS $_$
declare
  pclavegarantia alias for $1;
  pdescripciongarantia alias for $2;
begin

   insert into tipo_garantia(clavegarantia,descripciongarantia)
    values( pclavegarantia,pdescripciongarantia );
            
return pclavegarantia;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipo_garantia(character, character varying) OWNER TO sistema;

--
-- Name: spitipoacreditador(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipoacreditador(integer, character) RETURNS integer
    AS $_$
declare

  ptipocreditadoid           alias for $1;
  pdescripciontipoacreditado alias for $2;

begin

   insert into tipoacreditador(tipocreditadoid,descripciontipoacreditado)
    values( ptipocreditadoid,pdescripciontipoacreditado);
            
return currval('tipoacreditador_tipocreditadoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipoacreditador(integer, character) OWNER TO sistema;

--
-- Name: spitipoaviso(character, character, integer, integer, character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipoaviso(character, character, integer, integer, character, integer, integer) RETURNS integer
    AS $_$
declare
  pdescripciontipoaviso alias for $1;
  pprocedimientoaimprimir alias for $2;
  pdiainicial alias for $3;
  pdiafinal alias for $4;
  pclasificacion alias for $5;
  pparasocio alias for $6;
  pparaaval alias for $7;
begin

   insert into tipoaviso(descripciontipoaviso,procedimientoaimprimir,diainicial,diafinal,clasificacion,parasocio,paraaval)
    values( pdescripciontipoaviso,
            pprocedimientoaimprimir,
            pdiainicial,
            pdiafinal,
            pclasificacion,
            pparasocio,
            pparaaval);
            
return currval('tipoaviso_tipoavisoid_seq');
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipoaviso(character, character, integer, integer, character, integer, integer) OWNER TO sistema;

--
-- Name: spitipoinversion(character, character varying, numeric, integer, character, character, character, character, character, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipoinversion(character, character varying, numeric, integer, character, character, character, character, character, character, character, integer) RETURNS character
    AS $_$
declare
  ptipoinversionid alias for $1;
  pdesctipoinversion alias for $2;
  ptasa_normal_inversion alias for $3;
  pplazo alias for $4;
  pcuentapasivo alias for $5;
  pcuentapasivovencida alias for $6;
  pcuentaintinver alias for $7;
  pcuentaintinvernocob alias for $8;
  pcuentaivainver alias for $9;
  pcuentariesgocred alias for $10;
  paplicaivainversion alias for $11;
  pcalculoid alias for $12;
begin


   insert into tipoinversion(tipoinversionid,    
                             desctipoinversion,  
                             tasa_normal_inversion,        
                             plazo,              
                             cuentapasivo,       
                             cuentapasivovencida,
                             cuentaintinver,     
                             cuentaintinvernocob,
                             cuentaivainver,     
                             cuentariesgocred,   
                             aplicaivainversion,
                             calculoid)
    values(ptipoinversionid,    
           pdesctipoinversion,  
           ptasa_normal_inversion,        
           pplazo,              
           pcuentapasivo,       
           pcuentapasivovencida,
           pcuentaintinver,     
           pcuentaintinvernocob,
           pcuentaivainver,     
           pcuentariesgocred,   
           paplicaivainversion,
           pcalculoid);
            
return ptipoinversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipoinversion(character, character varying, numeric, integer, character, character, character, character, character, character, character, integer) OWNER TO sistema;

--
-- Name: spitipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character) RETURNS character
    AS $_$
declare

  ptipoinversionid alias for $1;
  pcuentariesgocred alias for $2;
  pcuentaintinvernocob alias for $3;
  pcalculoid alias for $4;
  pcuentapasivo alias for $5;
  pcuentapasivovencida alias for $6;
  pcuentaintinver alias for $7;
  pcuentaivainver alias for $8;
  pdesctipoinversion alias for $9;
  ptasa_normal_inversion alias for $10;
  pplazo alias for $11;
  paplicaivainversion alias for $12;
  paplicaisr alias for $13;
  preinvierteinteres alias for $14;
  ptipomovimientoid alias for $15;
  pcuentaprovisionisr alias for $16;

begin

   insert into
     tipoinversion(tipoinversionid,
                   cuentariesgocred,
                   cuentaintinvernocob,  
                   calculoid,            
                   cuentapasivo,         
                   cuentapasivovencida,  
                   cuentaintinver,       
                   cuentaivainver,       
                   desctipoinversion,    
                   tasa_normal_inversion,
                   plazo,                
                   aplicaivainversion,   
                   aplicaisr,            
                   reinvierteinteres,    
                   tipomovimientoid,     
                   cuentaprovisionisr )   
    values(ptipoinversionid,
           pcuentariesgocred,
           pcuentaintinvernocob,  
           pcalculoid,            
           pcuentapasivo,         
           pcuentapasivovencida,  
           pcuentaintinver,       
           pcuentaivainver,       
           pdesctipoinversion,    
           ptasa_normal_inversion,
           pplazo,                
           paplicaivainversion,   
           paplicaisr,            
           preinvierteinteres,    
           ptipomovimientoid,     
           pcuentaprovisionisr);
            
return ptipoinversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character) OWNER TO sistema;

--
-- Name: spitipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character, integer) RETURNS character
    AS $_$
declare

  ptipoinversionid alias for $1;
  pcuentariesgocred alias for $2;
  pcuentaintinvernocob alias for $3;
  pcalculoid alias for $4;
  pcuentapasivo alias for $5;
  pcuentapasivovencida alias for $6;
  pcuentaintinver alias for $7;
  pcuentaivainver alias for $8;
  pdesctipoinversion alias for $9;
  ptasa_normal_inversion alias for $10;
  pplazo alias for $11;
  paplicaivainversion alias for $12;
  paplicaisr alias for $13;
  preinvierteinteres alias for $14;
  ptipomovimientoid alias for $15;
  pcuentaprovisionisr alias for $16;
  pclasificacionid alias for $17;

begin

   insert into
     tipoinversion(tipoinversionid,
                   cuentariesgocred,
                   cuentaintinvernocob,  
                   calculoid,            
                   cuentapasivo,         
                   cuentapasivovencida,  
                   cuentaintinver,       
                   cuentaivainver,       
                   desctipoinversion,    
                   tasa_normal_inversion,
                   plazo,                
                   aplicaivainversion,   
                   aplicaisr,            
                   reinvierteinteres,    
                   tipomovimientoid,     
                   cuentaprovisionisr,
                   clasificacionid)   
    values(ptipoinversionid,
           pcuentariesgocred,
           pcuentaintinvernocob,  
           pcalculoid,            
           pcuentapasivo,         
           pcuentapasivovencida,  
           pcuentaintinver,       
           pcuentaivainver,       
           pdesctipoinversion,    
           ptasa_normal_inversion,
           pplazo,                
           paplicaivainversion,   
           paplicaisr,            
           preinvierteinteres,    
           ptipomovimientoid,     
           pcuentaprovisionisr,
           pclasificacionid);
            
return ptipoinversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character, integer) OWNER TO sistema;

--
-- Name: spitipomovibanco(character, character varying, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipomovibanco(character, character varying, character) RETURNS character
    AS $_$
declare
  ptipomovibancoid alias for $1;
  pdescritipomovibanco alias for $2;
  poperacionsumaresta alias for $3;
begin

   insert into tipomovibanco(tipomovibancoid,descritipomovibanco,operacionsumaresta)
    values( ptipomovibancoid,
            pdescritipomovibanco,
            poperacionsumaresta );
            

return ptipomovibancoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipomovibanco(character, character varying, character) OWNER TO sistema;

--
-- Name: spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character) RETURNS character
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro   alias for $12;
begin

   insert into tipomovimiento(tipomovimientoid,desctipomovimiento,aplicasaldo,cuentadeposito,cuentaretiro,cuentaintpagado,cuentaintcobrado,cuentaivamovimiento,cuentaisr,tipopoliza,aceptadeposito,aceptaretiro)
    values( ptipomovimientoid,
            pdesctipomovimiento,
            paplicasaldo,
            pcuentadeposito,
            pcuentaretiro,
            pcuentaintpagado,
            pcuentaintcobrado,
            pcuentaivamovimiento,
            pcuentaisr,
            ptipopoliza,
            paceptadeposito,
            paceptaretiro);
            
return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric) RETURNS character
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro   alias for $12;
  ptasainteres alias for $13;

begin

   insert into tipomovimiento(tipomovimientoid,desctipomovimiento,aplicasaldo,cuentadeposito,cuentaretiro,cuentaintpagado,cuentaintcobrado,cuentaivamovimiento,cuentaisr,tipopoliza,aceptadeposito,aceptaretiro,tasainteres)
    values( ptipomovimientoid,
            pdesctipomovimiento,
            paplicasaldo,
            pcuentadeposito,
            pcuentaretiro,
            pcuentaintpagado,
            pcuentaintcobrado,
            pcuentaivamovimiento,
            pcuentaisr,
            ptipopoliza,
            paceptadeposito,
            paceptaretiro,
            ptasainteres);
            
return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric) OWNER TO sistema;

--
-- Name: spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character) RETURNS character
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro   alias for $12;
  ptasainteres alias for $13;
  pcuentaordenacredor alias for $14;
  pcuentaordendeudor alias for $15;
  pcuentaorden alias for $16;

begin

   insert into tipomovimiento(tipomovimientoid,desctipomovimiento,aplicasaldo,cuentadeposito,cuentaretiro,cuentaintpagado,cuentaintcobrado,cuentaivamovimiento,cuentaisr,tipopoliza,aceptadeposito,aceptaretiro,tasainteres,cuentaordenacredor,cuentaordendeudor,cuentaorden)
    values( ptipomovimientoid,
            pdesctipomovimiento,
            paplicasaldo,
            pcuentadeposito,
            pcuentaretiro,
            pcuentaintpagado,
            pcuentaintcobrado,
            pcuentaivamovimiento,
            pcuentaisr,
            ptipopoliza,
            paceptadeposito,
            paceptaretiro,
            ptasainteres,
            pcuentaordenacredor,
            pcuentaordendeudor,
            pcuentaorden);
            
return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character) OWNER TO sistema;

--
-- Name: spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character) RETURNS character
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro   alias for $12;
  ptasainteres alias for $13;
  pcuentaordenacredor alias for $14;
  pcuentaordendeudor alias for $15;
  pcuentaorden alias for $16;

begin

   insert into tipomovimiento(tipomovimientoid,desctipomovimiento,aplicasaldo,cuentadeposito,cuentaretiro,cuentaintpagado,cuentaintcobrado,cuentaivamovimiento,cuentaisr,tipopoliza,aceptadeposito,aceptaretiro,tasainteres,cuentaordenacredor,cuentaordendeudor,cuentaorden)
    values( ptipomovimientoid,
            pdesctipomovimiento,
            paplicasaldo,
            pcuentadeposito,
            pcuentaretiro,
            pcuentaintpagado,
            pcuentaintcobrado,
            pcuentaivamovimiento,
            pcuentaisr,
            ptipopoliza,
            paceptadeposito,
            paceptaretiro,
            ptasainteres,
            pcuentaordenacredor,
            pcuentaordendeudor,
            pcuentaorden);
            
return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character) OWNER TO sistema;

--
-- Name: spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character) RETURNS character
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro   alias for $12;
  ptasainteres alias for $13;
  pcuentaordenacredor alias for $14;
  pcuentaordendeudor alias for $15;
  pcuentaorden alias for $16;
  pcuentaprovisionisr alias for $17;

begin

   insert into tipomovimiento(tipomovimientoid,desctipomovimiento,aplicasaldo,cuentadeposito,cuentaretiro,cuentaintpagado,cuentaintcobrado,cuentaivamovimiento,cuentaisr,tipopoliza,aceptadeposito,aceptaretiro,tasainteres,cuentaordenacredor,cuentaordendeudor,cuentaorden,cuentaprovisionisr)
    values( ptipomovimientoid,
            pdesctipomovimiento,
            paplicasaldo,
            pcuentadeposito,
            pcuentaretiro,
            pcuentaintpagado,
            pcuentaintcobrado,
            pcuentaivamovimiento,
            pcuentaisr,
            ptipopoliza,
            paceptadeposito,
            paceptaretiro,
            ptasainteres,
            pcuentaordenacredor,
            pcuentaordendeudor,
            pcuentaorden,
            pcuentaprovisionisr);
            
return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character) OWNER TO sistema;

--
-- Name: spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character, character) RETURNS character
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro   alias for $12;
  ptasainteres alias for $13;
  pcuentaordenacredor alias for $14;
  pcuentaordendeudor alias for $15;
  pcuentaorden alias for $16;
  pcuentaprovisionisr alias for $17;
  pcuentacxcide alias for $18;

begin

   insert into tipomovimiento(tipomovimientoid,desctipomovimiento,aplicasaldo,cuentadeposito,cuentaretiro,cuentaintpagado,cuentaintcobrado,cuentaivamovimiento,cuentaisr,tipopoliza,aceptadeposito,aceptaretiro,tasainteres,cuentaordenacredor,cuentaordendeudor,cuentaorden,cuentaprovisionisr,cuentacxcide)
    values( ptipomovimientoid,
            pdesctipomovimiento,
            paplicasaldo,
            pcuentadeposito,
            pcuentaretiro,
            pcuentaintpagado,
            pcuentaintcobrado,
            pcuentaivamovimiento,
            pcuentaisr,
            ptipopoliza,
            paceptadeposito,
            paceptaretiro,
            ptasainteres,
            pcuentaordenacredor,
            pcuentaordendeudor,
            pcuentaorden,
            pcuentaprovisionisr,
            pcuentacxcide);
            
return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character, character) OWNER TO sistema;

--
-- Name: spitipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character) RETURNS character
    AS $_$
declare
  ptipoprestamoid           alias for $1;
  pdesctipoprestamo         alias for $2;
  ptantos                   alias for $3;
  ptasa_normal              alias for $4;
  ptasa_mora                alias for $5;
  ptipomovimientoid         alias for $6;
                                                                            
  pcuentaactivo             alias for $7;
  pcuentaactivovencida      alias for $8;
  pcuentaintnormal          alias for $9;
  pcuentaintnormalvencida   alias for $10;
  pcuentaintnormalnocob     alias for $11;
  pcuentaintmora            alias for $12;
  pcuentaintmoravencida     alias for $13;
  pcuentaiva                alias for $14;
  pcuentariesgocred         alias for $15;
  pcuentaordenaval          alias for $16;
  pcuentaordeninteres       alias for $17;

  paplicaivaprestamo        alias for $18;
  pdiastraspasoavencida     alias for $19;

  pcuentaintdevnocobres     alias for $20;
  pcuentariesgocredres      alias for $21;
  pcuentaintmoranocobact    alias for $22;
  pcuentaintmoradevnocobres alias for $23;

  pordendeudornormalbonificado  alias for $24;
  pordenacredornormalbonificado alias for $25;

  pcuentafondorecuperacion alias for $26;
  pcuentagtosadm alias for $27;

begin

   insert into tipoprestamo(tipoprestamoid,desctipoprestamo,tantos,tasa_normal,tasa_mora,
                          tipomovimientoid,cuentaactivo,
                          cuentaactivovencida,cuentaintnormal,cuentaintnormalvencida,
                          cuentaintnormalnocob,cuentaintmora,cuentaintmoravencida,cuentaiva,
                          cuentariesgocred,cuentaordenaval,cuentaordeninteres,aplicaivaprestamo,
                          diastraspasoavencida,cuentaintdevnocobres,cuentariesgocredres,
                          cuentaintmoranocobact,cuentaintmoradevnocobres,
                          ordendeudornormalbonificado,ordenacredornormalbonificado,
                          cuentafondorecuperacion,cuentagtosadm)
    values( ptipoprestamoid,pdesctipoprestamo,ptantos,ptasa_normal,ptasa_mora,
                          ptipomovimientoid,pcuentaactivo,
                          pcuentaactivovencida,pcuentaintnormal,pcuentaintnormalvencida,
                          pcuentaintnormalnocob,pcuentaintmora,pcuentaintmoravencida,pcuentaiva,
                          pcuentariesgocred,pcuentaordenaval,pcuentaordeninteres,paplicaivaprestamo,
                          pdiastraspasoavencida,pcuentaintdevnocobres,pcuentariesgocredres,
                          pcuentaintmoranocobact,pcuentaintmoradevnocobres,
                          pordendeudornormalbonificado,pordenacredornormalbonificado,
                          pcuentafondorecuperacion,pcuentagtosadm);
            

return ptipoprestamoid;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spitipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: spitipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character) RETURNS character
    AS $_$
declare
  ptipoprestamoid           alias for $1;
  pdesctipoprestamo         alias for $2;
  ptantos                   alias for $3;
  ptasa_normal              alias for $4;
  ptasa_mora                alias for $5;
  ptipomovimientoid         alias for $6;
                                                                            
  pcuentaactivo             alias for $7;
  pcuentaactivovencida      alias for $8;
  pcuentaintnormal          alias for $9;
  pcuentaintnormalvencida   alias for $10;
  pcuentaintnormalnocob     alias for $11;
  pcuentaintmora            alias for $12;
  pcuentaintmoravencida     alias for $13;
  pcuentaiva                alias for $14;
  pcuentariesgocred         alias for $15;
  pcuentaordenaval          alias for $16;
  pcuentaordeninteres       alias for $17;

  paplicaivaprestamo        alias for $18;
  pdiastraspasoavencida     alias for $19;

  pcuentaintdevnocobres     alias for $20;
  pcuentariesgocredres      alias for $21;
  pcuentaintmoranocobact    alias for $22;
  pcuentaintmoradevnocobres alias for $23;

  pordendeudornormalbonificado  alias for $24;
  pordenacredornormalbonificado alias for $25;

  pcuentafondorecuperacion alias for $26;
  pcuentagtosadm alias for $27;

  pcuentaintnormalresvencida alias for $28;
  pordeninteresacreedor alias for $29;

begin

   insert into tipoprestamo(tipoprestamoid,desctipoprestamo,tantos,tasa_normal,tasa_mora,
                          tipomovimientoid,cuentaactivo,
                          cuentaactivovencida,cuentaintnormal,cuentaintnormalvencida,
                          cuentaintnormalnocob,cuentaintmora,cuentaintmoravencida,cuentaiva,
                          cuentariesgocred,cuentaordenaval,cuentaordeninteres,aplicaivaprestamo,
                          diastraspasoavencida,cuentaintdevnocobres,cuentariesgocredres,
                          cuentaintmoranocobact,cuentaintmoradevnocobres,
                          ordendeudornormalbonificado,ordenacredornormalbonificado,
                          cuentafondorecuperacion,cuentagtosadm,
                          cuentaintnormalresvencida,ordeninteresacreedor)
    values( ptipoprestamoid,pdesctipoprestamo,ptantos,ptasa_normal,ptasa_mora,
                          ptipomovimientoid,pcuentaactivo,
                          pcuentaactivovencida,pcuentaintnormal,pcuentaintnormalvencida,
                          pcuentaintnormalnocob,pcuentaintmora,pcuentaintmoravencida,pcuentaiva,
                          pcuentariesgocred,pcuentaordenaval,pcuentaordeninteres,paplicaivaprestamo,
                          pdiastraspasoavencida,pcuentaintdevnocobres,pcuentariesgocredres,
                          pcuentaintmoranocobact,pcuentaintmoradevnocobres,
                          pordendeudornormalbonificado,pordenacredornormalbonificado,
                          pcuentafondorecuperacion,pcuentagtosadm,
                          pcuentaintnormalresvencida,pordeninteresacreedor);
            

return ptipoprestamoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: spitipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character, integer, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character, integer, integer, character) RETURNS character
    AS $_$
declare
  ptipoprestamoid           alias for $1;
  pdesctipoprestamo         alias for $2;
  ptantos                   alias for $3;
  ptasa_normal              alias for $4;
  ptasa_mora                alias for $5;
  ptipomovimientoid         alias for $6;
                                                                            
  pcuentaactivo             alias for $7;
  pcuentaactivovencida      alias for $8;
  pcuentaintnormal          alias for $9;
  pcuentaintnormalvencida   alias for $10;
  pcuentaintnormalnocob     alias for $11;
  pcuentaintmora            alias for $12;
  pcuentaintmoravencida     alias for $13;
  pcuentaiva                alias for $14;
  pcuentariesgocred         alias for $15;
  pcuentaordenaval          alias for $16;
  pcuentaordeninteres       alias for $17;

  paplicaivaprestamo        alias for $18;
  pdiastraspasoavencida     alias for $19;

  pcuentaintdevnocobres     alias for $20;
  pcuentariesgocredres      alias for $21;
  pcuentaintmoranocobact    alias for $22;
  pcuentaintmoradevnocobres alias for $23;

  pordendeudornormalbonificado  alias for $24;
  pordenacredornormalbonificado alias for $25;

  pcuentafondorecuperacion alias for $26;
  pcuentagtosadm alias for $27;

  pcuentaintnormalresvencida alias for $28;
  pordeninteresacreedor alias for $29;

  pcalculonormalid alias for $30;
  pcalculomoraid alias for $31;
  pclavefinalidad alias for $32;

 

begin

   insert into tipoprestamo(tipoprestamoid,desctipoprestamo,tantos,tasa_normal,tasa_mora,
                          tipomovimientoid,cuentaactivo,
                          cuentaactivovencida,cuentaintnormal,cuentaintnormalvencida,
                          cuentaintnormalnocob,cuentaintmora,cuentaintmoravencida,cuentaiva,
                          cuentariesgocred,cuentaordenaval,cuentaordeninteres,aplicaivaprestamo,
                          diastraspasoavencida,cuentaintdevnocobres,cuentariesgocredres,
                          cuentaintmoranocobact,cuentaintmoradevnocobres,
                          ordendeudornormalbonificado,ordenacredornormalbonificado,
                          cuentafondorecuperacion,cuentagtosadm,
                          cuentaintnormalresvencida,ordeninteresacreedor,calculonormalid,calculomoraid,clavefinalidad)
    values( ptipoprestamoid,pdesctipoprestamo,ptantos,ptasa_normal,ptasa_mora,
                          ptipomovimientoid,pcuentaactivo,
                          pcuentaactivovencida,pcuentaintnormal,pcuentaintnormalvencida,
                          pcuentaintnormalnocob,pcuentaintmora,pcuentaintmoravencida,pcuentaiva,
                          pcuentariesgocred,pcuentaordenaval,pcuentaordeninteres,paplicaivaprestamo,
                          pdiastraspasoavencida,pcuentaintdevnocobres,pcuentariesgocredres,
                          pcuentaintmoranocobact,pcuentaintmoradevnocobres,
                          pordendeudornormalbonificado,pordenacredornormalbonificado,
                          pcuentafondorecuperacion,pcuentagtosadm,
                          pcuentaintnormalresvencida,pordeninteresacreedor,pcalculonormalid,pcalculomoraid,pclavefinalidad);
            

return ptipoprestamoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character, integer, integer, character) OWNER TO sistema;

--
-- Name: spitipopromocion(character, date, date, character varying, integer, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipopromocion(character, date, date, character varying, integer, character varying) RETURNS integer
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pfechainicial     alias for $2;
  pfechafinal       alias for $3;
  pcondicion        alias for $4;
  pestatus          alias for $5;
  pdescripcion      alias for $6;

 
begin

  insert into tipopromocion(tipomovimientoid,fechainicial,fechafinal,condicion,estatus,descripcion)
    values(ptipomovimientoid,
	   pfechainicial,
	   pfechafinal,
	   pcondicion,
	   pestatus,
	   pdescripcion );

        
return currval('tipopromocion_tipopromocionid_seq');

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipopromocion(character, date, date, character varying, integer, character varying) OWNER TO sistema;

--
-- Name: spitiposocio(character, character varying, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitiposocio(character, character varying, character varying) RETURNS character
    AS $_$
declare
  ptiposocioid alias for $1;
  pdescritiposocio alias for $2;
  pobservaciones alias for $3;
begin

   insert into tiposocio(tiposocioid,descritiposocio,observaciones)
    values( ptiposocioid,
            pdescritiposocio,
            pobservaciones );
           
return ptiposocioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitiposocio(character, character varying, character varying) OWNER TO sistema;

--
-- Name: spitipousuario(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spitipousuario(character, character varying) RETURNS character
    AS $_$
declare
  ptipousuarioid alias for $1;
  pdescripciontipousuario alias for $2;
begin

   insert into tipousuario(tipousuarioid,descripciontipousuario)
    values( ptipousuarioid,
            pdescripciontipousuario);
            

return ptipousuarioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spitipousuario(character, character varying) OWNER TO sistema;

--
-- Name: spiudis(date, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiudis(date, numeric) RETURNS date
    AS $_$
declare

  pfecha alias for $1;
  pvalor alias for $2;
 
begin

   insert into udis(fecha,valor)
    values(pfecha,pvalor );
            

return pfecha;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiudis(date, numeric) OWNER TO sistema;

--
-- Name: spiusuario(character, character, character, character varying, character varying, character varying, character varying, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spiusuario(character, character, character, character varying, character varying, character varying, character varying, integer) RETURNS character
    AS $_$
declare
 pusuarioid      alias for $1;
 ptipousuarioid  alias for $2;
 pusu_usuarioid  alias for $3;
 pcontrasenia    alias for $4;
 pemail          alias for $5;
 pdicola         alias for $6;
 pobsusuario     alias for $7;
 psujetoid       alias for $8;

begin

   insert into usuarios (usuarioid,tipousuarioid,usu_usuarioid,contrasenia,email,dicola,obsusuario,sujetoid)
      values(pusuarioid,ptipousuarioid,pusu_usuarioid,pcontrasenia,pemail,pdicola,pobsusuario,psujetoid);

return pusuarioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spiusuario(character, character, character, character varying, character varying, character varying, character varying, integer) OWNER TO sistema;

--
-- Name: spnavega(integer, integer, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spnavega(integer, integer, character, character) RETURNS SETOF tpolizas
    AS $_$
declare

 pejercicio alias for $1;
 pperiodo   alias for $2;
 ptipo      alias for $3;
 pserie     alias for $4;

 r tpolizas%rowtype;

begin

  for r in
    select polizaid,numero_poliza,referencia,seriepoliza,fechapoliza,tipo_poliza,concepto_poliza
      from polizas
     where ejercicio = pejercicio and
           periodo = pperiodo and
           (ptipo=' ' or tipo_poliza=ptipo) and
           (pserie='  ' or seriepoliza=pserie)
  order by fechapoliza,tipo_poliza,numero_poliza
  loop
    return next r;
  end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spnavega(integer, integer, character, character) OWNER TO sistema;

--
-- Name: sprecuperacion(date, date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sprecuperacion(date, date, character, character) RETURNS SETOF rrecupera
    AS $_$
declare

  pfechai     alias for $1;
  pfechaf     alias for $2;
  psocioi     alias for $3;
  psociof     alias for $4;

  r rrecupera%rowtype;

  fiva numeric;
  fivacalculado numeric;
  finterestotal numeric;

begin

  select iva into fiva from empresa;

  for r in
select substr(s.clavesocioint,1,4) as suc,pr.referenciaprestamo,pr.prestamoid,
       s.clavesocioint,p.fechapoliza,
       su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
       pr.montoprestamo,
       pr.tipoprestamoid,
       sum(case when m.cuentaid=t.cuentaactivo 
                then m.haber
                else 0 end) as capital,
       sum(case when m.cuentaid=t.cuentaintnormal
                then m.haber
                else 0 end) as interes,
       sum(case when m.cuentaid=t.cuentaintmora
                then m.haber
                else 0 end) as moratorio,
       sum(case when m.cuentaid=t.cuentaiva
                then m.haber
                else 0 end) as iva,0 as ivacalculado,si.grupo
  from polizas p, movicaja mc, movipolizas m, prestamos pr,
       tipoprestamo t, socio s, sujeto su, solicitudingreso si
 where p.fechapoliza between pfechai and pfechaf and
       mc.polizaid=p.polizaid and
       mc.tipomovimientoid='00' and
       m.polizaid = p.polizaid and
       pr.prestamoid = mc.prestamoid and
       t.tipoprestamoid = pr.tipoprestamoid and
       s.socioid = mc.socioid and
       s.clavesocioint>=psocioi and s.clavesocioint<=psociof and
       su.sujetoid = s.sujetoid and 
       s.socioid=si.socioid
group by pr.referenciaprestamo,s.clavesocioint,p.fechapoliza,su.nombre,su.paterno,su.materno,pr.prestamoid,
         pr.montoprestamo,pr.tipoprestamoid,si.grupo
order by si.grupo,pr.tipoprestamoid,s.clavesocioint         
  loop
    
    finterestotal:=r.interes+r.moratorio;

    select (case when clavefinalidad ='002' then finterestotal*fiva  else 0 end) into fivacalculado from tipoprestamo where tipoprestamoid=r.tipoprestamoid;
    
    select paterno||' '||materno||' '||nombre into r.cobrador from sujeto where sujetoid = (select sujetoid from cobradores natural join carteracobrador where prestamoid=r.prestamoid group by sujetoid);

    r.ivacalculado:=fivacalculado;   

    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sprecuperacion(date, date, character, character) OWNER TO sistema;

--
-- Name: spriesgocomun(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spriesgocomun(date, date) RETURNS SETOF rriesgocomun
    AS $_$
declare

  pfechai alias for $1;
  pfechaf alias for $2;
 
  r rriesgocomun%rowtype;
  f rriesgocomun%rowtype;
  sw integer;
 
begin

  for r in
select s.clavesocioint,p.tipoprestamoid,       
       p.fecha_otorga,p.montoprestamo as monto,
       su.nombre,su.paterno,su.materno,su.rfc, su.curp, 'RELACION',
       d.calle||' '||d.numero_ext as domicilio, c.nombrecolonia, cm.nombreciudadmex,
       d.teldomicilio,si.solicitudingresoid
  from prestamos p, socio s, solicitudingreso si, sujeto su, domicilio d,
       colonia c, ciudadesmex cm
 where p.fecha_otorga >= pfechai and p.fecha_otorga <= pfechaf and p.claveestadocredito='001' and p.socioid = s.socioid and
       si.socioid= s.socioid and su.sujetoid = s.sujetoid and
       d.sujetoid = s.sujetoid and
       c.coloniaid = d.coloniaid and
       cm.ciudadmexid=d.ciudadmexid 
order by s.clavesocioint  

  loop

      raise notice ' Buscando Relaciones % ',r.solicitudingresoid;
      sw:=0;

      for f in
      select s.clavesocioint,p.tipoprestamoid,       
       p.fecha_otorga,p.montoprestamo as monto,
       su.nombre,su.paterno,su.materno,su.rfc, su.curp, re.parentesco,
       d.calle||' '||d.numero_ext as domicilio, c.nombrecolonia, cm.nombreciudadmex,
       d.teldomicilio,r.solicitudingresoid
      from relacion re, solicitudingreso si , prestamos p, socio s, sujeto su, domicilio d,
       colonia c, ciudadesmex cm  
      where re.solicitudingresoid=r.solicitudingresoid and re.socioid = p.socioid and p.socioid = s.socioid and
       si.socioid= p.socioid and su.sujetoid = s.sujetoid and
       p.fecha_otorga >= pfechai and p.fecha_otorga <= pfechaf and p.claveestadocredito='001' and
       d.sujetoid = s.sujetoid and
       c.coloniaid = d.coloniaid and
       cm.ciudadmexid=d.ciudadmexid 
      order by s.clavesocioint  

      loop
        if sw=0 then
           return next r;
           sw:=1;
        end if;

        raise notice ' Buscando Relaciones 2 % % ',r.solicitudingresoid,f.clavesocioint;

        r.clavesocioint:=f.clavesocioint;
        r.tipoprestamoid:=f.tipoprestamoid;
        r.monto:=f.monto;
        r.nombre:=f.nombre;
        r.paterno:=f.paterno;
        r.materno:=f.materno;
        r.rfc:=f.rfc;
        r.curp:=f.curp;
        r.parentesco:=f.parentesco;
        r.domicilio:=f.domicilio;
        r.colonia:=f.colonia;
        r.ciudad:=f.ciudad;
        r.telefono:=f.telefono;
        r.solicitudingresoid:=f.solicitudingresoid;

        return next r;
        
      end loop;

  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spriesgocomun(date, date) OWNER TO sistema;

--
-- Name: spriesgocomunc(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spriesgocomunc(date, date) RETURNS SETOF rriesgocomun
    AS $_$
declare

  r rriesgocomun%rowtype;
  pfechai alias for $1;
  pfechaf alias for $2;
  f record;

  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
        dblink2:='set search_path to public,'||f.esquema||';select * from  spriesgocomun('||''''||pfechai||''''||','||''''||pfechaf||''''||');';

    --    raise notice 'dblink % % ',dblink1,dblink2;

        for r in
        SELECT * FROM
        dblink(dblink1,dblink2) as
               t2(
        clavesocioint character(15),
	tipoprestamoid char(3),
	fecha_otorga date,
	monto numeric,
	nombre character(40),
	paterno character(20),
	materno character(20),
	rfc character(16),
	curp character(20),
	parentesco character(20),
	domicilio character varying(80),
	colonia character varying(100),
	ciudad character varying(100),
	telefono character varying(20),
        solicitudingresoid int4)

        loop
                return next r;
        end loop;

 end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spriesgocomunc(date, date) OWNER TO sistema;

--
-- Name: sprpbalance(integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sprpbalance(integer, integer, integer, integer) RETURNS SETOF rrpbalance
    AS $_$
declare

  pejercicio   alias for $1;
  pperiodo     alias for $2;
  pconsolidado alias for $3;
  pmiles       alias for $4;

  sconsolida char(1);
  r rrpbalance%rowtype;

  daytab numeric[2][12]:=array[[31,28,31,30,31,30,31,31,30,31,30,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31]];
  mestab varchar[13]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE',
                            'DICIEMBRE'];

  fresultado numeric;
  factivo numeric;
  fpasivo numeric;
  fcapital numeric;
  cf numeric;
  cf2 numeric;

  finversionenvalores numeric;
  fcarteravigente numeric;
  fcarteravencida numeric;
  freserva numeric;

  fcaptacion numeric;
  fprestamosbancarios numeric;
  fotrascxp numeric;

  fcapitalcontribuido numeric;
  fcapitalganado numeric;

  f numeric;

  finvmenor30 numeric;
  pfecha date;
  f1 numeric;
  f2 numeric;

  fcapgan numeric;
begin

  select cast(to_char(pejercicio,'9999')||'-'||trim(to_char(pperiodo,'99'))||'-'||trim(to_char(daytab[1][pperiodo],'99')) as date)
    into pfecha;

  raise notice 'Fecha %',pfecha;

  fresultado:=0;
  factivo:=0;
  fpasivo:=0;
  fcapital:=0;
  freserva:=0;
  cf:=0;

  if pconsolidado=1 then
    r.rubro1:='CONSOLIDADO';
    r.rubro2:='D-1 Balance General';
    sconsolida:='S';
  else
    r.rubro1:='SUCURSAL';
    r.rubro2:='D-1 Balance General';
    sconsolida:='N';
  end if;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select nombrecaja into r.rubro1 from empresa where empresaid=1;
  r.rubro2:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select niveloperaciones into r.rubro1 from empresa where empresaid=1;
  r.rubro2:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select direccioncaja into r.rubro1 from empresa where empresaid=1;
  r.rubro2:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  -- Pendiente validar ao bisiesto
  if pconsolidado=1 then
   r.rubro1:='BALANCE GENERAL CONSOLIDADO AL'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  else
   r.rubro1:='BALANCE GENERAL AL'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  end if;
  r.rubro2:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  r.rubro1:='EXPRESADO EN MONEDA DE PODER ADQUISITIVO HISTORICO';
  r.rubro2:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  if pmiles=1 then
    r.rubro1:='(CIFRAS EN MILES DE PESOS)';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  else
    r.rubro1:='(CIFRAS EN PESOS)';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  end if;


    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='ACTIVO';
    r.rubro2:='PASIVO';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    fresultado:=saldocuenta('5',pejercicio,pperiodo,sconsolida)-saldocuenta('6',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      fresultado:=fresultado/1000.00;
    end if;


    cf:=saldocuenta('11 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    factivo:=factivo+cf;
   

    r.rubro1:='DISPONIBILIDADES';
    r.rubro2:='CAPTACION TRADICIONAL';
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    
    cf:=-1*saldocuenta('2101 ',pejercicio,pperiodo,sconsolida);
    f:=saldocuenta('1101 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
      f:=f/1000.00;
    end if;

    fcaptacion := cf;

    f2:=cf;

    r.rubro1:='Caja';
    r.rubro2:='Captacin con vencimiento < a 30 das';
    r.t1 := f;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    f:=saldocuenta('1102 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      f:=f/1000.00;
    end if;


    r.rubro1:='Bancos';
    r.rubro2:='Depositos de exigibilidad inmediata';
    r.t1 := f;
    r.t2 := NULL;
    r.t3 := cf;
    r.t4 := NULL;
    return next r;


    cf:=-1*saldocuenta('2102 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;    

    if sconsolida='S' then

      select sum(deposito+interes)
        into finvmenor30
        from inversionesxfechac(pfecha)
       where plazo<30;

    else
      select sum(deposito+interes)
        into finvmenor30
        from inversionesxfecha(pfecha)
       where plazo<30;

    end if;

    finvmenor30:=coalesce(finvmenor30,0);

    if pmiles=1 then
      finvmenor30:=finvmenor30/1000.00;
    end if;

    f2:=f2+finvmenor30;
    fcaptacion:=fcaptacion+finvmenor30;

    r.rubro1:='Otras Disponibilidades';
    r.rubro2:='Depositos a Plazo';
    r.t1 := 0.00;
    r.t2 := NULL;
    r.t3 := finvmenor30;
    r.t4 := NULL;
    return next r;

   
   

    cf2:=-1*saldocuenta('2103 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;
    fcaptacion := fcaptacion + cf2;

    r.rubro1:=NULL;
    r.rubro2:='Ttulos de crditos emitidos';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf2;
    r.t4 := fcaptacion;
    return next r;

    finversionenvalores:=0;
    r.rubro1:='INVERSIONES EN VALORES';
    r.rubro2:='Captacin por vencimiento >= a 30 das';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='Inversiones con vencimiento < 30 das';
    r.rubro2:='Depositos de exigibilidad inmediata';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := 0.00;
    r.t4 := NULL;
    return next r;


    cf:=saldocuenta('1201 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;

    
    f:=-1*saldocuenta('2102 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      f:=f/1000.00;
    end if;
    f:=f-finvmenor30;

    r.rubro1:='Titulos a negociar';
    r.rubro2:='Depositos a Plazo';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := f;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('1202 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;

    finversionenvalores:= finversionenvalores+cf;

    r.rubro1:='Ttulos disponibles para la venta';
    r.rubro2:='Ttulos de crdito emitidos';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := 0.00;
    r.t4 := f;
    return next r;

    cf:=saldocuenta('12030101 ',pejercicio,pperiodo,sconsolida)+
        saldocuenta('12030102 ',pejercicio,pperiodo,sconsolida);

    if pmiles=1 then
      cf:=cf/1000.00;
    end if;

    finversionenvalores:= finversionenvalores+cf;


    fcaptacion:=fcaptacion+f;

    r.rubro1:='Ttulos conservados a vencimiento';
    r.rubro2:=NULL;
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('1204 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;

    finversionenvalores:= finversionenvalores+cf;

    r.rubro1:='Ttulos recibidos en reporto';
    r.rubro2:=NULL;
    r.t1 := cf;
    r.t2 := finversionenvalores;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    factivo:=factivo+finversionenvalores;


    r.rubro1:=NULL;
    r.rubro2:='PRESTAMOS BANCARIOS Y DE OTROS ORGANISMOS';
    r.t1 := -0.001;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf:=-1*saldocuenta('2201 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fprestamosbancarios:=cf;

    r.rubro1:=NULL;
    r.rubro2:='De corto plazo';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf;
    r.t4 := NULL;
    return next r;


    cf:=-1*saldocuenta('2202 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fprestamosbancarios:= fprestamosbancarios+cf;

    r.rubro1:=NULL;
    r.rubro2:='De largo plazo';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf;
    r.t4 := fprestamosbancarios;
    return next r;

    r.rubro1:='CARTERA DE CREDITO VIGENTE';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.001;
    r.t4 := NULL;
    return next r;


    cf:=saldocuenta('13010101',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fcarteravigente:=cf;

    r.rubro1:='Crditos comerciales';
    r.rubro2:=NULL;
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('130102 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fcarteravigente:=fcarteravigente+cf;

    r.rubro1:='Crditos al consumo';
    r.rubro2:=NULL;
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('130103 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fcarteravigente:=fcarteravigente+cf;

    r.rubro1:='Crditos a la vivienda';
    r.rubro2:='OTRAS CUENTAS POR PAGAR';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    cf:=-1*saldocuenta('2301 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fotrascxp:=cf;

    r.rubro1:=NULL;
    r.rubro2:='ISR y PTU por pagar';
    r.t1 := -0.001;
    r.t2 := NULL;
    r.t3 := cf;
    r.t4 := NULL;
    return next r;

   

-- Falta cuenta
    r.rubro1:= 'TOTAL CARTERA DE CREDITO VIGENTE';
    r.rubro2:='Aportaciones para futuros aumentos de capital';
    r.t1 := fcarteravigente;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

   
-- Falta especificar cuenta
    r.rubro1:= NULL;
    r.rubro2:='pendientes de formalizar por su rgano de gobierno';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := 0.00;
    r.t4 := NULL;
    return next r;


    cf:=(-1*saldocuenta('2303 ',pejercicio,pperiodo,sconsolida));
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fotrascxp:=fotrascxp+cf;
    
-- cuenta 2-03-05
    r.rubro1:= NULL;
    r.rubro2:='Fondo de Obra Social';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf;
    r.t4 := NULL;
    return next r;

    cf:=(-1*saldocuenta('2304 ',pejercicio,pperiodo,sconsolida));
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fotrascxp:=fotrascxp+cf;


-- cuenta 2-03-06

    r.rubro1:=NULL;
    r.rubro2:='Fondo de Educacin Cooperativa (2)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf;
    r.t4 := NULL;
    return next r;

    cf:=(-1*saldocuenta('23 ',pejercicio,pperiodo,sconsolida));
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fotrascxp:=fotrascxp+cf;

    r.rubro1:=NULL;
    r.rubro2:='Acredores diversos y otras cuentas por pagar';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf;
    r.t4 := fotrascxp;
    return next r;

    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.001;
    r.t4 := NULL;
    return next r;

    r.rubro1:='CARTERA DE CREDITO VENCIDA';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('13020101 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fcarteravencida :=cf;

    r.rubro1:='Crditos comerciales';
    r.rubro2:='OBLIGACIONES SUBORDINADAS EN CIRCULACION';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('130202 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fcarteravencida :=fcarteravencida+cf;

    r.rubro1:='Crditos al consumo';
    r.rubro2:=NULL;
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('130203 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    fcarteravencida :=fcarteravencida+cf;

    cf2:=-1*saldocuenta('25 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;

    r.rubro1:='Crditos a la vivienda';
    r.rubro2:='IMPUESTOS DIFERIDOS (NETO)';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := cf2;
    return next r;

    cf2:=-1*saldocuenta('26 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;
    r.rubro1:=NULL;
    r.rubro2:='CREDITOS DIFERIDOS Y COBROS ANTICIPADOS';
    r.t1 := -0.001;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := cf2;
    return next r;

    r.rubro1:='TOTAL CARTERA DE CREDITO VENCIDA';
    r.rubro2:=NULL;
    r.t1 := fcarteravencida;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := -0.001;
    return next r;


    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if pmiles=1 then
      fpasivo:= fcaptacion + fprestamosbancarios + fotrascxp +
              (-1*saldocuenta('25 ',pejercicio,pperiodo,sconsolida)/1000.00)+
              (-1*saldocuenta('26 ',pejercicio,pperiodo,sconsolida)/1000.00);
    else
      fpasivo:= fcaptacion + fprestamosbancarios + fotrascxp +
              (-1*saldocuenta('25 ',pejercicio,pperiodo,sconsolida))+
              (-1*saldocuenta('26 ',pejercicio,pperiodo,sconsolida));
    end if;


    r.rubro1:='TOTAL CARTERA DE CREDITO';
    r.rubro2:='TOTAL PASIVO';
    r.t1 := fcarteravigente+fcarteravencida;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := fpasivo;
    return next r;

    r.rubro1:='(-)MENOS:';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='ESTIMACION PREVENTIVA';
    r.rubro2:='CAPITAL CONTABLE';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='PARA RIESGOS CREDITICIOS';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('130302010101 ',pejercicio,pperiodo,sconsolida)+saldocuenta('1303010101',pejercicio,pperiodo,sconsolida);

    if cf<0 then
      cf=-1*cf;
    end if;

    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    freserva:=cf;

    r.rubro1:='Crditos comerciales';
    r.rubro2:='CAPITAL CONTRIBUIDO';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('1303010102 ',pejercicio,pperiodo,sconsolida)+
        saldocuenta('1303020102 ',pejercicio,pperiodo,sconsolida);

    if cf<0 then
      cf=-1*cf;
    end if;

    if pmiles=1 then
      cf:=cf/1000.00;
    end if;

    freserva:=freserva+cf;

    cf2:=-1*saldocuenta('4101 ',pejercicio,pperiodo,sconsolida);


    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;
    fcapitalcontribuido:=cf2;

    r.rubro1:='Crditos al consumo';
    r.rubro2:='Capital Social';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := cf2;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('1303010103 ',pejercicio,pperiodo,sconsolida)+saldocuenta('1303020103 ',pejercicio,pperiodo,sconsolida);

    if cf<0 then
      cf=-1*cf;
    end if;

    if pmiles=1 then
      cf:=cf/1000.00;
    end if;
    freserva:=freserva+cf;

    cf2:=-1*saldocuenta('4103 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;
    fcapitalcontribuido:= fcapitalcontribuido+cf2;

-- Falta cuenta
    r.rubro1:='Crditos a la vivienda';
    r.rubro2:='Aportaciones para futuros aumentos de capital';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:=NULL;
    r.rubro2:='acordadas por su rgano de gobierno';
    r.t1 := -0.001;
    r.t2 := NULL;
    r.t3 := 0.00;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.rubro2:='Prima en Venta de Acciones (1)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf2;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.rubro2:='Obligaciones subordinadas en circulacin';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := 0.00;
    r.t4 := NULL;
    return next r;


    cf2:=-1*saldocuenta('4105 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;
    fcapitalcontribuido:= fcapitalcontribuido+cf2;

    r.rubro1:=NULL;
    r.rubro2:='Reserva aportada por Institucin Fundadora (2)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf2;
    r.t4 := NULL;
    return next r;

    cf2:=-1*saldocuenta('4106 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;
    fcapitalcontribuido:= fcapitalcontribuido+cf2;

    r.rubro1:=NULL;
    r.rubro2:='Donativos';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf2;
    r.t4 := NULL;
    return next r;


    cf2:=-1*saldocuenta('4107 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;   

    fcapitalcontribuido:= fcapitalcontribuido+cf2;

-- Falta especificar cuenta
    r.rubro1:=NULL;
    r.rubro2:='Efecto por Incorporacin al Rgimen de Entidad (EIRE)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf2;
    r.t4 := fcapitalcontribuido;
    return next r;



    r.rubro1:='CARTERA DE CREDITO (NETO)';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := fcarteravigente+fcarteravencida-freserva;
    r.t3 := -0.001;
    r.t4 := -0.001;
    return next r;

    factivo:=factivo+fcarteravigente+fcarteravencida-freserva;

    r.rubro1:=NULL;
    r.rubro2:='CAPITAL GANADO';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf2:=-1*saldocuenta('4201 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;
    fcapitalganado:=cf2;

    r.rubro1:=NULL;
    r.rubro2:='Fondo Reserva';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf2;
    r.t4 := NULL;
    return next r;


    cf:=saldocuenta('14 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;


    cf2:=(-1*saldocuenta('4202 ',pejercicio,pperiodo,sconsolida));

    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;

    fcapitalganado:=fcapitalganado+cf2;


    r.rubro1:='OTRAS CUENTAS POR COBRAR (NETO)';
    r.rubro2:='Resultado de ejercicios anteriores';
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := cf2;
    r.t4 := NULL;
    return next r;

    factivo:=factivo+cf;

-- Falta especificar cuenta
    r.rubro1:=NULL;
    r.rubro2 := 'Resultado por valuacin de titulos disponibles para la venta';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := 0.00;
    r.t4 := NULL;
    return next r;

-- Falta especificar cuenta
    r.rubro1:=NULL;
    r.rubro2 := 'Resultado por tenencia de activos no monetarios';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := 0.00;
    r.t4 := NULL;
    return next r;


    cf:=saldocuenta('15 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;

    r.rubro1:='BIENES ADJUDICADOS';
    r.rubro2:='Ajustes por obligaciones laborables al retiro';
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    factivo:=factivo+cf;


    cf2:=-1*(saldocuenta('5 ',pejercicio,pperiodo,sconsolida)+saldocuenta('6 ',pejercicio,pperiodo,sconsolida));
    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;

    r.rubro1:= NULL;
    r.rubro2:='Resultado Neto';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := cf2;
    r.t4 := NULL;
    return next r;

fcapgan := fcapitalganado+cf2;

    cf:=saldocuenta('16 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;



    cf2:=(-1*saldocuenta('41 ',pejercicio,pperiodo,sconsolida))+
         (-1*saldocuenta('42 ',pejercicio,pperiodo,sconsolida))+
         (-1*(saldocuenta('5 ',pejercicio,pperiodo,sconsolida)+saldocuenta('6 ',pejercicio,pperiodo,sconsolida)));
    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;

    r.rubro1:= 'INMUEBLES, MOBILIARIO Y EQUIPO (NETO)';
    r.rubro2:= 'TOTAL CAPITAL CONTABLE';
    r.t1 := NULL;
    r.t2 := cf;
--    r.t3 := fcapgan;
    r.t3 := NULL;
    r.t4 := cf2;

    return next r;

    factivo:=factivo+cf;

    cf:=saldocuenta('17 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;

    r.rubro1:= 'INVERSIONES PERMANENTES EN ACCIONES';
    r.rubro2:= NULL;
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := -0.001;
    r.t4 := -0.001;
    return next r;

    factivo:=factivo+cf;


-- Falta especificar cuenta
    r.rubro1:= 'IMPUESTOS DIFERIDOS (NETO)';
    r.rubro2:= NULL;
    r.t1 := NULL;
    r.t2 := 0.00;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:= 'OTROS ACTIVOS';
    r.rubro2:= NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    cf:=saldocuenta('19 ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      cf:=cf/1000.00;
    end if;

    cf2:=(-1*saldocuenta('41 ',pejercicio,pperiodo,sconsolida))+
         (-1*saldocuenta('42 ',pejercicio,pperiodo,sconsolida))+
         (-1*(saldocuenta('5 ',pejercicio,pperiodo,sconsolida)+saldocuenta('6 ',pejercicio,pperiodo,sconsolida)));

    if pmiles=1 then
      cf2:=cf2/1000.00;
    end if;

    r.rubro1:= 'Cargos diferidos e intangibles';
    r.rubro2:= NULL;
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

-- Falta especificar cuenta
    r.rubro1:= 'Otros activos';
    r.rubro2:= NULL;
    r.t1 := NULL;
    r.t2 := 0.00;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    factivo:=factivo+cf;
    fcapital:=cf2;

    r.rubro1:= NULL;
    r.rubro2:= NULL;
    r.t1 := NULL;
    r.t2 := -0.001;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;



    r.rubro1:= 'TOTAL ACTIVO';
    r.rubro2:= 'TOTAL PASIVO Y CAPITAL CONTABLE';
    r.t1 := NULL;
    r.t2 := factivo;
    r.t3 := NULL;
    r.t4 := fpasivo+fcapital;
    return next r;

    r.rubro1:= NULL;
    r.rubro2:= NULL;
    r.t1 := NULL;
    r.t2 := -0.002;
    r.t3 := NULL;
    r.t4 := -0.002;
    return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sprpbalance(integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: sprpbalance2(integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sprpbalance2(integer, integer, integer, integer) RETURNS SETOF rrpbalance
    AS $_$
declare

  pejercicio   alias for $1;
  pperiodo     alias for $2;
  pconsolidado alias for $3;
  pmiles       alias for $4;

  sconsolida char(1);
  r rrpbalance%rowtype;

  daytab numeric[2][12]:=array[[31,28,31,30,31,30,31,31,30,31,30,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31]];
  mestab varchar[12]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE'];
  cf numeric;

  sgerente varchar;
  scontador varchar;
  scontadorsucursal varchar;
  spresidenteadmon varchar;

begin

  cf:=0;

  if pconsolidado=1 then
    r.rubro1:='CONSOLIDADO';
    r.rubro2:='D-1 Balance General';
    sconsolida:='S';
  else
    r.rubro1:='SUCURSAL';
    r.rubro2:='D-1 Balance General';
    sconsolida:='N';
  end if;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select nombrecaja into r.rubro1 from empresa where empresaid=1;
  r.rubro2:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select niveloperaciones into r.rubro1 from empresa where empresaid=1;
  r.rubro2:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select direccioncaja into r.rubro1 from empresa where empresaid=1;
  r.rubro2:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  -- Pendiente validar ao bisiesto

  if pconsolidado=1 then
   r.rubro1:='BALANCE GENERAL CONSOLIDADO AL'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  else
   r.rubro1:='BALANCE GENERAL AL'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  end if;
  r.rubro2:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  r.rubro1:='EXPRESADO EN MONEDA DE PODER ADQUISITIVO HISTORICO';
  r.rubro2:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  if pmiles=1 then
    r.rubro1:='(CIFRAS EN MILES DE PESOS)';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  else
    r.rubro1:='(CIFRAS EN PESOS)';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  end if;


    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='CUENTAS DE ORDEN';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

--    r.rubro1:='Avales';
--    r.rubro2:=NULL;
--   r.t1 := NULL;
--    r.t2 := 0.00;
--    r.t3 := NULL;
--    r.t4 := NULL;
--    return next r;

    r.rubro1:='Obligaciones contingentes';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := 0.00;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='Bienes en cuastodia o en administracin';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := 0.00;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='Garantias recibidas';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := 0.00;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    cf:=saldocuenta('710501 ',pejercicio,pperiodo,sconsolida);

    if pmiles=1 then
      cf:=cf/1000.00;
    end if;

    r.rubro1:='Intereses devengados no cobrados de cartera de crdito vencida';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cf:=saldocuenta('7206 ',pejercicio,pperiodo,sconsolida);

    if pmiles=1 then
      cf:=cf/1000.00;
    end if;


    r.rubro1:='Otras cuentas de registro';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='Director / Gerente General';
    r.rubro2:='Director de Administracin / Contador General';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='______________________________________';
    r.rubro2:='______________________________________';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

select gerente,contador,contadorsucursal,presidenteadmon
  into sgerente,scontador,scontadorsucursal,spresidenteadmon
  from empresa
 where empresaid=1;


    r.rubro1:=sgerente;
    r.rubro2:=scontador;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='Presidente del Consejo de Administracin';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='______________________________________';
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:=spresidenteadmon;
    r.rubro2:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sprpbalance2(integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: sprpcambioscapital1(integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sprpcambioscapital1(integer, integer, integer, integer) RETURNS SETOF rrpedores
    AS $_$
declare

  pejercicio   alias for $1;
  pperiodo     alias for $2;
  pconsolidado alias for $3;
  pmiles       alias for $4;

  sconsolida char(1);
  r rrpedores%rowtype;

  daytab numeric[2][12]:=array[[31,28,31,30,31,30,31,31,30,31,30,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31]];
  mestab varchar[12]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE'];


begin


  if pconsolidado=1 then
    r.rubro1:='CONSOLIDADO';
    sconsolida:='S';
  else
    r.rubro1:='SUCURSAL';
    sconsolida:='N';
  end if;
  return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

  select nombrecaja into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select niveloperaciones into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select direccioncaja into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  -- Pendiente validar ao bisiesto
  if pconsolidado=1 then
    r.rubro1:='ESTADO DE VARIACIONES EN EL CAPITAL CONTABLE DEL 01 AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  else
    r.rubro1:='ESTADO DE VARIACIONES EN EL CAPITAL CONTABLE DEL 01 AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  end if;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  r.rubro1:='EXPRESADO EN MONEDA DE PODER ADQUISITIVO HISTORICO';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  if pmiles=1 then
    r.rubro1:='(CIFRAS EN MILES DE PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  else
    r.rubro1:='(CIFRAS EN PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  end if;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sprpcambioscapital1(integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: sprpcambioscapital2(integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sprpcambioscapital2(integer, integer, integer, integer) RETURNS SETOF rrpcambios
    AS $_$
declare

  pejercicio   alias for $1;
  pperiodo     alias for $2;
  pconsolidado alias for $3;
  pmiles       alias for $4;

  sconsolida char(1);
  r rrpcambios%rowtype;

  daytab numeric[2][13]:=array[[31,28,31,30,31,30,31,31,30,31,30,31,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31,31]];
  mestab varchar[13]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE',
                            'DICIEMBRE'];

  fpaincompleta numeric;
  fcapitalsocial numeric;
  fcapitalsociali numeric;
  pfecha date;

  fresultadoperiodo numeric;
  ffondoreserva numeric;
  ffondoreservai numeric;
  fresultadoanti numeric;
  fresultadoant numeric;

  fresultadonetoi numeric;
  fresultadoneto numeric;
  fcapitalcontablei numeric;
  fcapitalcontable numeric;
  faportacionesi numeric;
  faportaciones numeric;

  pfechaa date;

  fpa numeric;

begin

 select cast(to_char(pejercicio,'9999')||'-'||trim(to_char(pperiodo,'99'))||'-'||trim(to_char(daytab[1][pperiodo],'99')) as date)
    into pfecha;

  raise notice 'Fecha %',pfecha;

pfechaa := pfecha-cast(daytab[1][pperiodo] as int);

raise notice 'Fecha 2 %',pfechaa;

  if pconsolidado=1 then
    sconsolida:='S';
  else
    sconsolida:='N';
  end if;

    fcapitalsocial:=-1*saldocuenta('4101  ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      fcapitalsocial:=round(fcapitalsocial,-3)/1000;
    end if;

    fcapitalsociali:=-1*saldoinicial('4101  ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      fcapitalsociali:=round(fcapitalsociali,-3)/1000;
    end if;



-- Fondo de reserva
    ffondoreservai:=-1*saldoinicial('4201  ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      ffondoreservai:=round(ffondoreservai,-3)/1000;
    end if;
    ffondoreserva:=-1*saldocuenta('4201  ',pejercicio,pperiodo,sconsolida);
    if pmiles=1 then
      ffondoreserva:=round(ffondoreserva,-3)/1000;
    end if;

-- Resultados ejercicios anteriores
    fresultadoanti:=(-1*saldoinicial('4202 ',pejercicio,pperiodo,sconsolida));
    if pmiles=1 then
      fresultadoanti:=round(fresultadoanti,-3)/1000;
    end if;


    fresultadoant:=(-1*saldocuenta('4202  ',pejercicio,pperiodo,sconsolida));
    if pmiles=1 then
      fresultadoant:=round(fresultadoant,-3)/1000;
    end if;

-- Aportaciones para el futuro
    faportacionesi:=(-1*saldoinicial('410201  ',pejercicio,pperiodo,sconsolida));
    if pmiles=1 then
      faportacionesi:=round(fresultadoanti,-3)/1000;
    end if;


    faportaciones:=(-1*saldocuenta('410201  ',pejercicio,pperiodo,sconsolida));
    if pmiles=1 then
      faportaciones:=round(fresultadoant,-3)/1000;
    end if;


-- Resultado Neto

    fresultadonetoi:=abs(saldoinicial('5  ',pejercicio,pperiodo,sconsolida))-
                     abs(saldoinicial('6  ',pejercicio,pperiodo,sconsolida));

    if pmiles=1 then
      fresultadonetoi:=round(fresultadonetoi,-3)/1000;
    end if;
 
    fresultadoneto:=abs(saldocuenta('5  ',pejercicio,pperiodo,sconsolida))-
                    abs(saldocuenta('6  ',pejercicio,pperiodo,sconsolida));



    if pmiles=1 then
      fresultadoneto:=round(fresultadoneto,-3)/1000;
    end if;

-- Resultado del periodo

    fresultadoperiodo:= fresultadoneto - fresultadonetoi;

    if pmiles=1 then
      fresultadoperiodo:= round(fresultadoperiodo,-3)/1000;
    end if;

-- Total capital contable

    fcapitalcontablei:=(-1*saldoinicial('4101  ',pejercicio,pperiodo,sconsolida));
    if pmiles=1 then
      fcapitalcontablei:=round(fcapitalcontablei,-3)/1000;
    end if;

    fcapitalcontable:=(-1*saldocuenta('4101  ',pejercicio,pperiodo,sconsolida))+
                      (saldocuenta('5  ',pejercicio,pperiodo,sconsolida)-
                       saldocuenta('6  ',pejercicio,pperiodo,sconsolida));
    if pmiles=1 then
      fcapitalcontable:=round(fcapitalcontable,-3)/1000;
    end if;


  r.rubro1:='Saldo al 1 de '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  r.t1:=fcapitalcontablei;
  r.t2:=faportacionesi;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=ffondoreservai;
  r.t8:=fresultadoanti;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=fresultadonetoi;
  r.t12:=fcapitalcontablei+fresultadonetoi+ffondoreservai+fresultadoanti;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='MOVIMIENTOS INHERENTES A LAS DECISIONES DE';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='LOS SOCIOS DE SOCIEDADES COOPERATIVAS O ';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='ACCIONES DE SOCIEDADES FINANCIERAS POPULARES';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;


  r.rubro1:='Suscripcin de certificados(1) de aportacin  acciones(2)';
  r.t1:= NULL;
  r.t2:= NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='Capitalizacin de utilidades';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;


  r.rubro1:='Constitucin de reservas';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='Traspaso del resultado neto a resultado de ejercicios anteriores';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;


  r.rubro1:='Distribucin de excedentes(1) o pago de dividendos(2)';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;


  r.rubro1:='';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;


  r.rubro1:='';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;


  r.rubro1:='Total';
  r.t1:=fcapitalcontablei;
  r.t2:=faportacionesi;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=ffondoreservai;
  r.t8:=fresultadoanti;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=fresultadonetoi;
  r.t12:=fcapitalcontablei+fresultadonetoi+ffondoreservai+fresultadoanti;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='MOVIMIENTOS INHERENTES AL RECONOCIMIENTO';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='DE LA UTILIDAD INTEGRAL';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='Utilidad Integral';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='-Resultado neto';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=fresultadoperiodo;
  r.t12:=fresultadoperiodo;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='-Resultado por valuacin de ttulos disponibles para la venta';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='-Resultado por tenencia de activos no monetarios';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='-Ajustes por obligaciones laborales al retiro';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='-EIRE';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=NULL;
  r.t12:=NULL;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;

  r.rubro1:='Total';
  r.t1:=NULL;
  r.t2:=NULL;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=NULL;
  r.t8:=NULL;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=fresultadoperiodo;
  r.t12:=fresultadoperiodo;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;
  return next r;





  r.rubro1:='Saldo al '||to_char(daytab[1][pperiodo],'99')||' de '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');

  r.t1:=fcapitalcontablei;
  r.t2:=faportacionesi;
  r.t3:=NULL;
  r.t4:=NULL;
  r.t5:=NULL;
  r.t6:=NULL;
  r.t7:=ffondoreservai;
  r.t8:=fresultadoanti;
  r.t9:=NULL;
  r.t10:=NULL;
  r.t11:=fresultadonetoi+fresultadoperiodo;
  r.t12:=fcapitalcontablei+fresultadonetoi+fresultadoperiodo+fresultadoanti+fresultadoanti;
  r.t13:=NULL;
  r.t14:=NULL;
  r.t15:=NULL;
  r.t16:=NULL;
  r.t17:=NULL;
  r.t18:=NULL;

 
  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sprpcambioscapital2(integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: sprpedores(integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sprpedores(integer, integer, integer, integer) RETURNS SETOF rrpedores
    AS $_$
declare

  pejercicio   alias for $1;
  pperiodo     alias for $2;
  pconsolidado alias for $3;
  pmiles       alias for $4;

  sconsolida char(1);
  r rrpedores%rowtype;

  daytab numeric[2][12]:=array[[31,28,31,30,31,30,31,31,30,31,30,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31]];
  mestab varchar[12]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE'];

  fresultado numeric;
  fresultadoa numeric;
  fingresos numeric;
  fingresosa numeric;

  cf numeric;
  cfa numeric;
 
  t1 numeric;
  t2 numeric;

  sgerente varchar;
  scontador varchar;
  scontadorsucursal varchar;
  spresidenteadmon varchar;

begin

  fresultado:=0;

  if pconsolidado=1 then
    r.rubro1:='CONSOLIDADO                           D-2 Estado de Resultados';
    sconsolida:='S';
  else
    r.rubro1:='SUCURSAL                              D-2 Estado de Resultados';
    sconsolida:='N';
  end if;
  return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

  select nombrecaja||'  '||sucid into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select niveloperaciones into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select direccioncaja into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  -- Pendiente validar ao bisiesto
  if pconsolidado=1 then
   r.rubro1:='ESTADO DE RESULTADOS CONSOLIDADO DEL 01 DE ENERO AL'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  else
   r.rubro1:='ESTADO DE RESULTADOS DE SUCURSAL DEL 01 DE ENERO AL'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  end if;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  r.rubro1:='EXPRESADO EN MONEDA DE PODER ADQUISITIVO HISTORICO';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  if pmiles=1 then
    r.rubro1:='(CIFRAS EN MILES DE PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  else
    r.rubro1:='(CIFRAS EN PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  end if;


    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='MENSUAL';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;



    fingresosa:=saldocuenta('5101               ',pejercicio,pperiodo,sconsolida);

    if (pmiles=1) then
        fingresosa:=fingresosa/1000.00;
    end if;
    fingresosa:=-1*fingresosa;

    fingresos:=saldomensual('5101               ',pejercicio,pperiodo,sconsolida);

    if (pmiles=1) then
        fingresos:=fingresos/1000.00;
    end if;
    fingresos:=-1*fingresos;

    r.rubro1:='INGRESOS POR INTERESES';
    r.t1 := NULL;
    r.t2 := fingresos;
    r.t3 := NULL;
    r.t4 := fingresosa;
    return next r;

    fresultadoa:=fingresosa;
    fresultado:=fingresos;


    cfa:=-1*saldocuenta('5102               ',pejercicio,pperiodo,sconsolida);
    cf:=-1*saldomensual('5102               ',pejercicio,pperiodo,sconsolida);

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    r.rubro1:='GASTOS POR INTERESES';
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := NULL;
    r.t4 := cfa;
    return next r;

    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;


    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := -0.001;
    r.t3 := NULL;
    r.t4 := -0.001;
    return next r;


    r.rubro1:='MARGEN FINANCIERO';
    r.t1 := NULL;
    r.t2 := fresultado;
    r.t3 := NULL;
    r.t4 := fresultadoa;
    return next r;


    cfa:=-1*saldocuenta('5104               ',pejercicio,pperiodo,sconsolida);
    cf:=-1*saldomensual('5104               ',pejercicio,pperiodo,sconsolida);

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    r.rubro1:='Estimacin preventiva para riesgos crediticios';
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := NULL;
    r.t4 := cfa;
    return next r;

    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := -0.001;
    r.t3 := NULL;
    r.t4 := -0.001;
    return next r;

    r.rubro1:='MARGEN FINANCIERO AJUSTADO POR RIESGOS CREDITICIOS';
    r.t1 := NULL;
    r.t2 := fresultado;
    r.t3 := NULL;
    r.t4 := fresultadoa;
    return next r;


    cfa:=-1*saldocuenta('6101               ',pejercicio,pperiodo,sconsolida);
    cf:=-1*saldomensual('6101               ',pejercicio,pperiodo,sconsolida);

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    r.rubro1:='Comisiones y Tarifas cobradas';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := cfa;
    r.t4 := NULL;
    return next r;

    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;

    cfa:=-1*saldocuenta('6102               ',pejercicio,pperiodo,sconsolida);
    cf:=-1*saldomensual('6102               ',pejercicio,pperiodo,sconsolida);

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    r.rubro1:='Comisiones y Tarifas pagadas';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := cfa;
    r.t4 := NULL;
    return next r;

    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;


    cfa:=-1*saldocuenta('5103               ',pejercicio,pperiodo,sconsolida);
    cf:=-1*saldomensual('5103               ',pejercicio,pperiodo,sconsolida);

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    r.rubro1:='Resultados por intermediacin';
    r.t1 := cf;

    r.t3 := cfa;


    if (pmiles=1) then
      r.t2 := ((-1*saldomensual('6101               ',pejercicio,pperiodo,sconsolida))+
              (-1*saldomensual('6102               ',pejercicio,pperiodo,sconsolida))+
              (-1*saldomensual('5103               ',pejercicio,pperiodo,sconsolida)))/1000.0;
      r.t4 := ((-1*saldocuenta('6101               ',pejercicio,pperiodo,sconsolida))+
              (-1*saldocuenta('6102               ',pejercicio,pperiodo,sconsolida))+
              (-1*saldocuenta('5103               ',pejercicio,pperiodo,sconsolida)))/1000.0;
    else 
      r.t2 := (-1*saldomensual('6101               ',pejercicio,pperiodo,sconsolida))+
              (-1*saldomensual('6102               ',pejercicio,pperiodo,sconsolida))+
              (-1*saldomensual('5103               ',pejercicio,pperiodo,sconsolida));
      r.t4 := (-1*saldocuenta('6101               ',pejercicio,pperiodo,sconsolida))+
              (-1*saldocuenta('6102               ',pejercicio,pperiodo,sconsolida))+
              (-1*saldocuenta('5103               ',pejercicio,pperiodo,sconsolida));
    end if;
    return next r;

    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;


    r.rubro1:=NULL;
    r.t1 := -0.001;
    r.t2 := -0.001;
    r.t3 := -0.001;
    r.t4 := -0.001;
    return next r;


    r.rubro1:='INGRESOS (EGRESOS) TOTALES DE LA OPERACION';
    r.t1 := NULL;
    r.t2 := fresultado;
    r.t3 := NULL;
    r.t4 := fresultadoa;
    return next r;


    cfa:=-1*saldocuenta('62                 ',pejercicio,pperiodo,sconsolida);
    cf:=-1*saldomensual('62                 ',pejercicio,pperiodo,sconsolida);

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    r.rubro1:='Gastos de administracin y promocin';
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := NULL;
    r.t4 := cfa;
    return next r;

    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := -0.001;
    r.t3 := NULL;
    r.t4 := -0.001;
    return next r;

    r.rubro1:='RESULTADO DE LA OPERACION';
    r.t1 := NULL;
    r.t2 := fresultado;
    r.t3 := NULL;
    r.t4 := fresultadoa;
    return next r;


    cfa:=-1*(saldocuenta('6301               ',pejercicio,pperiodo,sconsolida));
    cf:=-1*(saldomensual('6301               ',pejercicio,pperiodo,sconsolida));

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    r.rubro1:='Otros productos';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := cfa;
    r.t4 := NULL;
    return next r;


    t1:=cf;
    t2:=cfa;
    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;


    cfa:=-1*(saldocuenta('6302               ',pejercicio,pperiodo,sconsolida));
    cf:=-1*(saldomensual('6302               ',pejercicio,pperiodo,sconsolida));

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    r.rubro1:='Otros gastos';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := cfa;
    r.t4 := NULL;
    return next r;


    t1:=t1+cf;
    t2:=t2+cfa;
    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;

    r.rubro1:=NULL;
    r.t1 := -0.001;
    r.t2 := -0.001;
    r.t3 := -0.001;
    r.t4 := -0.001;
    return next r;


    r.rubro1:='RESULTADO ANTES DE ISR Y PTU';
    r.t1 := t1;
    r.t2 := fresultado;
    r.t3 := t2;
    r.t4 := fresultadoa;
    return next r;


    cfa:=-1*(saldocuenta('6401               ',pejercicio,pperiodo,sconsolida));
    cf:=-1*(saldomensual('6401               ',pejercicio,pperiodo,sconsolida));

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    r.rubro1:='ISR y PTU causados';
    r.t1 := cf;
    r.t2 := NULL;
    r.t3 := cfa;
    r.t4 := NULL;
    return next r;


    t1:=cf;
    t2:=cfa;
    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;

    cfa:=-1*(saldocuenta('6402               ',pejercicio,pperiodo,sconsolida));
    cf:=-1*(saldomensual('6402               ',pejercicio,pperiodo,sconsolida));

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    t1:=t1+cf;
    t2:=t2+cfa;

    r.rubro1:='ISR y PTU diferidos';
    r.t1 := cf;
    r.t2 := t1;
    r.t3 := cfa;
    r.t4 := t2;
    return next r;

    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;


    r.rubro1:=NULL;
    r.t1 := -0.001;
    r.t2 := -0.001;
    r.t3 := -0.001;
    r.t4 := -0.001;
    return next r;

    r.rubro1:='RESULTADO POR OPERACIONES CONTINUAS';
    r.t1 := NULL;
    r.t2 := fresultado;
    r.t3 := NULL;
    r.t4 := fresultadoa;
    return next r;


    cfa:=(-1*(saldocuenta('65                 ',pejercicio,pperiodo,sconsolida)))+
         (-1*(saldocuenta('66                 ',pejercicio,pperiodo,sconsolida)));
    cf:=(-1*(saldomensual('65                 ',pejercicio,pperiodo,sconsolida)))+
        (-1*(saldomensual('66                 ',pejercicio,pperiodo,sconsolida)));

    if (pmiles=1) then
        cfa:=cfa/1000.00;
        cf:=cf/1000.00;
    end if;

    r.rubro1:='Operaciones discontinuas, partidas extraordinarias y cambios en politicas contables';
    r.t1 := NULL;
    r.t2 := cf;
    r.t3 := NULL;
    r.t4 := cfa;
    return next r;


    fresultadoa:=fresultadoa+cfa;
    fresultado:=fresultado+cf;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := -0.001;
    r.t3 := NULL;
    r.t4 := -0.001;
    return next r;

    r.rubro1:='RESULTADO NETO';
    r.t1 := NULL;
    r.t2 := fresultado;
    r.t3 := NULL;
    r.t4 := fresultadoa;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:GERENTE:PRESIDENTE DEL CONSEJO';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:________________________________:_________________________________';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    select gerente,contador,contadorsucursal,presidenteadmon
    into sgerente,scontador,scontadorsucursal,spresidenteadmon
    from empresa
    where empresaid=1;
    
    r.rubro1:='GG:'||sgerente||':'||spresidenteadmon;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:CONTADOR GENERAL:CONSEJO DE VIGILANCIA';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:________________________________:_________________________________';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:'||scontador||':'||scontadorsucursal;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sprpedores(integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: sprporigen(integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sprporigen(integer, integer, integer, integer) RETURNS SETOF rrpedores
    AS $_$
declare

  pejercicio   alias for $1;
  pperiodo     alias for $2;
  pconsolidado alias for $3;
  pmiles       alias for $4;

  sconsolida char(1);
  r rrpedores%rowtype;

  daytab numeric[2][13]:=array[[31,28,31,30,31,30,31,31,30,31,30,31,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31,31]];
  mestab varchar[13]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE','DICIEMBRE'];

  cf numeric;
 
  sgerente varchar;
  scontador varchar;
  scontadorsucursal varchar;
  spresidenteadmon varchar;

  -- Tabla auxiliar de calculos
  origen numeric[20][5]:=array[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],
                               [0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],
                               [0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],
                               [0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],
                               [0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]];

  saldoi numeric;
  saldof numeric;
  s1 numeric;
  s2 numeric;
  s3 numeric;
  s4 numeric;

begin


  if pconsolidado=1 then
    sconsolida:='S';
  else
    sconsolida:='N';
  end if;

   s1:=0;
   s2:=0;
   s3:=0;
   s4:=0;

   -- Resultado
   --cf:=saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida);

   cf:=-1*(saldoinicial('5  ',pejercicio,pperiodo,sconsolida))-
       saldoinicial('6  ',pejercicio,pperiodo,sconsolida);

   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[1][1]:=cf;

   cf:=-1*(saldocuenta('5  ',pejercicio,pperiodo,sconsolida))-
       saldocuenta('6  ',pejercicio,pperiodo,sconsolida);

   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[1][2]:=cf;  

   origen[1][3]:=origen[1][2]-origen[1][1];
   if origen[1][2]>origen[1][1] then
     origen[1][4]:=abs(origen[1][2]-origen[1][1]);
   else
     origen[1][5]:=abs(origen[1][2]-origen[1][1]);
   end if;
   s1:=s1+origen[1][4]-origen[1][5];


   -- Resultados por valuacin a valor razonable
   cf:=saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida);

   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[2][1]:=cf;


   cf:=saldomensual('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldomensual('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldomensual('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldomensual('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldomensual('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldomensual('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldomensual('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldomensual('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldomensual('Borrar  ',pejercicio,pperiodo,sconsolida)+
       saldomensual('Borrar  ',pejercicio,pperiodo,sconsolida);

   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[2][2]:=cf;

   origen[2][3]:=origen[2][2]-origen[2][1];
   if origen[2][2]<origen[2][1] then
     origen[2][4]:=abs(origen[2][2]-origen[2][1]);
   else
     origen[2][5]:=abs(origen[2][2]-origen[2][1]);
   end if;
   s1:=s1+origen[2][4]-origen[2][5];


   -- Estimacin preventiva para riesgos crediticios
   cf:=saldoinicial('1303 ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[3][1]:=cf;

   cf:=saldocuenta('1303 ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[3][2]:=cf;  

   origen[3][3]:=origen[3][2]-origen[3][1];
   if origen[3][2]<origen[3][1] then
     origen[3][4]:=abs(origen[3][2]-origen[3][1]);
   else
     origen[3][5]:=abs(origen[3][2]-origen[3][1]);
   end if;
   s1:=s1+origen[3][4]-origen[3][5];



   -- Depreciacin y amortizacion
   cf:=saldoinicial('1603  ',pejercicio,pperiodo,sconsolida)
+saldoinicial(' ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[4][1]:=cf;

   cf:=saldocuenta('1603  ',pejercicio,pperiodo,sconsolida)
+saldocuenta(' ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[4][2]:=cf;  

   origen[4][3]:=origen[4][2]-origen[4][1];
   if origen[4][2]<origen[4][1] then
     origen[4][4]:=abs(origen[4][2]-origen[4][1]);
   else
     origen[4][5]:=abs(origen[4][2]-origen[4][1]);
   end if;   
   s1:=s1+origen[4][4]-origen[4][5];


   -- Impuestos diferidos
   cf:=saldoinicial('1901 ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[5][1]:=cf;

   cf:=saldocuenta('1901 ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[5][2]:=cf;

   origen[5][3]:=origen[5][2]-origen[5][1];
   if origen[5][2]<origen[5][1] then
     origen[5][4]:=abs(origen[5][2]-origen[5][1]);
   else
     origen[5][5]:=abs(origen[5][2]-origen[5][1]);
   end if;   


   saldoi:=saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;

   saldof:=saldocuenta('Borrar  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;

   if saldof>saldoi then
     origen[5][4]:=abs(origen[5][4]+saldof-saldoi);
   else
     origen[5][5]:=abs(origen[5][5]+saldof-saldoi);
   end if;

   s1:=s1+origen[5][4]-origen[5][5];
--raise exception 'el valor de s1=%',s1;




   -- Disminucin o aumento en la captacin tradicional

   s2:=0;
   saldoi:=saldoinicial('21  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     saldoi:=round(saldoi,-3)/1000;
   end if;

   saldof:=saldocuenta('21  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     saldof:=round(saldof,-3)/1000;
   end if;

   if saldof<saldoi then
     origen[6][4]:=abs(origen[6][4]+saldof-saldoi);
   else
     origen[6][5]:=abs(origen[6][5]+saldof-saldoi);
   end if;   

   s2:=s2+origen[6][4]-origen[6][5];


   -- Disminucin o aumento en la cartera de crdito
   cf:=saldoinicial('13  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('    ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[7][1]:=cf;

   cf:=saldocuenta('13  ',pejercicio,pperiodo,sconsolida)+
       saldocuenta('    ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[7][2]:=cf;  

   origen[7][3]:=origen[7][2]-origen[7][1];
   if origen[7][2]<origen[7][1] then
     origen[7][4]:=abs(origen[7][2]-origen[7][1]);
   else
     origen[7][5]:=abs(origen[7][2]-origen[7][1]);
   end if;   
   s2:=s2+origen[7][4]-origen[7][5];

   -- Disminucin o aumento por operaciones en tesorera (inversiones en valores)
   cf:=saldoinicial('12  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[20][1]:=cf;

   cf:=saldocuenta('12  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[20][2]:=cf;  

   origen[20][3]:=origen[20][2]-origen[20][1];
   if origen[20][2]<origen[20][1] then
     origen[20][4]:=abs(origen[20][2]-origen[20][1]);
   else
     origen[20][5]:=abs(origen[20][2]-origen[20][1]);
   end if;   
   s2:=s2+origen[20][4]-origen[20][5];


   -- Prstamos bancarios y de otros organismos
   cf:=saldoinicial('22  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[8][1]:=cf;

   cf:=saldocuenta('22 ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[8][2]:=cf;

   origen[8][3]:=origen[8][2]-origen[8][1];
   if origen[8][2]<origen[8][1] then
     origen[8][4]:=abs(origen[8][2]-origen[8][1]);
   else
     origen[8][5]:=abs(origen[8][2]-origen[8][1]);
   end if;   
   s2:=s2+origen[8][4]-origen[8][5];

   -- Otras cuentas x pagar
   cf:=saldoinicial('23  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[9][1]:=cf;

   cf:=saldocuenta('23  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[9][2]:=cf;

   origen[9][3]:=origen[9][2]-origen[9][1];
   if origen[9][2]<origen[9][1] then
     origen[9][4]:=abs(origen[9][2]-origen[9][1]);
   else
     origen[9][5]:=abs(origen[9][2]-origen[9][1]);
   end if;   
-- s2:=s2+origen[9][4]-origen[9][5];

s3:=s3+origen[9][4]-origen[9][5];

   -- Otros adeudos vencidos

   cf:=saldoinicial(' ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[10][1]:=cf;

   cf:=saldocuenta(' ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[10][2]:=cf;

   origen[10][3]:=origen[10][2]-origen[10][1];
   if origen[10][2]<origen[10][1] then
     origen[10][4]:=abs(origen[10][2]-origen[10][1]);
   else
     origen[10][5]:=abs(origen[10][2]-origen[10][1]);
   end if;   
-- s2:=s2+origen[10][4]-origen[10][5];


   -- Otras cuentas x cobrar

   cf:=saldoinicial('14  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial(' ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[11][1]:=cf;

   cf:=saldocuenta('14  ',pejercicio,pperiodo,sconsolida)+
       saldocuenta(' ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[11][2]:=cf;

   origen[11][3]:=origen[11][2]-origen[11][1];
   if origen[11][2]<origen[11][1] then
     origen[11][4]:=abs(origen[11][2]-origen[11][1]);
   else
     origen[11][5]:=abs(origen[11][2]-origen[11][1]);
   end if;   
-- s2:=s2+origen[11][4]-origen[11][5];


   -- Bienes Adjudicados

--   cf:=saldoinicial('15  ',pejercicio,pperiodo,sconsolida);
--   if pmiles=1 then
--     cf:=round(cf,-3)/1000;
--   end if;
--   origen[12][1]:=cf;

--   cf:=saldocuenta('15  ',pejercicio,pperiodo,sconsolida);
--   if pmiles=1 then
--     cf:=round(cf,-3)/1000;
--   end if;
--   origen[12][2]:=cf;

--   origen[12][3]:=origen[12][2]-origen[12][1];
--   if origen[12][2]<origen[12][1] then
--     origen[12][4]:=abs(origen[12][2]-origen[12][1]);
--   else
--     origen[12][5]:=abs(origen[12][2]-origen[12][1]);
--   end if;   
--   s2:=s2+origen[12][4]-origen[12][5];


   -- Inversiones permanentes en acciones

--   cf:=saldoinicial('17  ',pejercicio,pperiodo,sconsolida);
--   if pmiles=1 then
--     cf:=round(cf,-3)/1000;
--   end if;
--   origen[13][1]:=cf;

--   cf:=saldocuenta('17  ',pejercicio,pperiodo,sconsolida);
--   if pmiles=1 then
--     cf:=round(cf,-3)/1000;
--   end if;
--   origen[13][2]:=cf;

--   origen[13][3]:=origen[13][2]-origen[12][1];
--   if origen[13][2]<origen[13][1] then
--     origen[13][4]:=abs(origen[13][2]-origen[13][1]);
--  else
--     origen[13][5]:=abs(origen[13][2]-origen[13][1]);
--   end if;   
--   s2:=s2+origen[13][4]-origen[13][5];


   -- Emisin de obligaciones subordinadas
   cf:=saldoinicial('Borrar  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[14][1]:=cf;

   cf:=saldocuenta('Borrar  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[14][2]:=cf;

   origen[14][3]:=origen[14][2]-origen[14][1];
   if origen[14][2]<origen[14][1] then
     origen[14][4]:=abs(origen[14][2]-origen[14][1]);
   else
     origen[14][5]:=abs(origen[14][2]-origen[14][1]);
   end if;   
   --s3:=s3+origen[14][2]-origen[14][1];
   s3:=s3+origen[14][4]-origen[14][5];


   -- Emisin o reduccin de capital social
   cf:=saldoinicial('4  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[15][1]:=cf;

   cf:=saldocuenta('4  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[15][2]:=cf;

   origen[15][3]:=origen[15][2]-origen[15][1];
   if origen[15][2]<origen[15][1] then
     origen[15][4]:=abs(origen[15][2]-origen[15][1]);
   else
     origen[15][5]:=abs(origen[15][2]-origen[15][1]);
   end if;
   --s3:=s3+origen[15][2]-origen[15][1];
   s3:=s3+origen[15][4]-origen[15][5];



   -- Capital Ganado
   cf:=saldoinicial('42  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[16][1]:=cf;

   cf:=saldocuenta('42  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[16][2]:=cf;

   origen[16][3]:=origen[16][2]-origen[16][1];
   if origen[16][2]<origen[16][1] then
     origen[16][4]:=abs(origen[16][2]-origen[16][1]);
   else
     origen[16][5]:=abs(origen[16][2]-origen[16][1]);
   end if;   

   s3:=s3+origen[16][2]-origen[16][1];     


   -- Bienes Adjudicados

   cf:=saldoinicial('1601  ',pejercicio,pperiodo,sconsolida)+
       saldoinicial('  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[17][1]:=cf;

   cf:=saldocuenta('1601  ',pejercicio,pperiodo,sconsolida)+
       saldocuenta('  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[17][2]:=cf;

   origen[17][3]:=origen[17][2]-origen[17][1];
   if origen[17][2]<origen[17][1] then
     origen[17][4]:=abs(origen[17][2]-origen[17][1]);
   else
     origen[17][5]:=abs(origen[17][2]-origen[17][1]);
   end if;   


   -- Disminucin o aumento en cargos y crditos diferidos
   cf:=saldoinicial('1901  ',pejercicio,pperiodo,sconsolida)-
saldoinicial(' ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000.00;
   end if;
   origen[18][1]:=cf;

   cf:=saldocuenta('1901  ',pejercicio,pperiodo,sconsolida)-
saldocuenta(' ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[18][2]:=cf;

   origen[18][3]:=origen[18][2]-origen[18][1];
   if origen[18][2]<origen[18][1] then
     origen[18][4]:=abs(origen[18][2]-origen[18][1]);
   else
     origen[18][5]:=abs(origen[18][2]-origen[18][1]);
   end if;   

--raise exception '4.- %  5.- %',origen[18][4],origen[18][5];


   -- EFECTIVO

   cf:=saldoinicial('11  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[19][1]:=cf;

   cf:=saldocuenta('11  ',pejercicio,pperiodo,sconsolida);
   if pmiles=1 then
     cf:=round(cf,-3)/1000;
   end if;
   origen[19][2]:=cf;

   origen[19][3]:=origen[19][2]-origen[19][1];
   if origen[19][2]<origen[19][1] then
     origen[19][4]:=abs(origen[19][2]-origen[19][1]);
   else
     origen[19][5]:=abs(origen[19][2]-origen[19][1]);
   end if;


  if pconsolidado=1 then
    r.rubro1:='CONSOLIDADO D-4 ESTADO DE CAMBIOS EN LA SITUACION FINANCIERA';
    sconsolida:='S';
  else
    r.rubro1:='SUCURSAL D-4 ESTADO DE CAMBIOS EN LA SITUACION FINANCIERA';
    sconsolida:='N';
  end if;
  return next r;

  select nombrecaja into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select niveloperaciones into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select direccioncaja into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  -- Pendiente validar ao bisiesto
  if pconsolidado=1 then
    r.rubro1:='ESTADO DE CAMBIOS CONSOLIDADO EN LA SITUACION FINANCIERA DEL 1 DE '||mestab[pperiodo]||' AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE '||to_char(pejercicio,'9999');
  else
    r.rubro1:='ESTADO DE CAMBIOS EN LA SITUACION FINANCIERA DEL 1 DE '||mestab[pperiodo]||' AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE '||to_char(pejercicio,'9999');
  end if;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  r.rubro1:='EXPRESADO EN MONEDA DE PODER ADQUISITIVO HISTORICO';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  if pmiles=1 then
    r.rubro1:='(CIFRAS EN MILES DE PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  else
    r.rubro1:='(CIFRAS EN PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  end if;


    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='Actividades de operacin';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='Resultado neto';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := origen[1][4]-origen[1][5];
    r.t4 := -0.001;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='Partidas aplicadas a resultados que no generaron o requirieron la utilizacin de recursos:';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := -0.001;
    return next r;


--  if origen[2][4]-origen[2][5]<>0 then
      r.rubro1:='Resultados por valuacin a valor razonable';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[2][4]-origen[2][5];
      r.t4 := -0.001;
      return next r;
--  end if;

--  if origen[3][4]-origen[3][5]<>0 then
      r.rubro1:='Estimacin preventiva para riesgos crediticios';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[3][4]-origen[3][5];
      r.t4 := -0.001;
      return next r;
--  end if;

--  if origen[4][4]-origen[4][5]<>0 then
      r.rubro1:='Depreciacin y amortizacin';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[4][4]-origen[4][5];
      r.t4 := -0.001;
      return next r;
--  end if;

--  if origen[5][4]-origen[5][5]<>0 then
      r.rubro1:='Impuestos diferidos';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[5][4]-origen[5][5];
      r.t4 := -0.001;
      return next r;
--  end if;

      r.rubro1:='Provisiones para obligaciones diversas';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := 0.00;
      r.t4 := -0.001;
      return next r;


    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.001;
    r.t4 := NULL;
    return next r;



    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := s1;
    r.t4 := NULL;
    return next r;


    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='Aumento o disminucin de partidas relacionadas con la operacin:';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


--  if origen[6][4]-origen[6][5]<>0 then
      r.rubro1:='Disminucin o aumento en la captacin tradicional';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[6][4]-origen[6][5];
      r.t4 := -0.001;
      return next r;
--  end if;

--  if origen[7][4]-origen[7][5]<>0 then
      r.rubro1:='Disminucin o aumento en la cartera de crdito';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[7][4]-origen[7][5];
      r.t4 := -0.001;
      return next r;
--  end if;

--  if origen[20][4]-origen[20][5]<>0 then
      r.rubro1:='Disminucin o aumento por operaciones en tesorera (inversiones en valores)';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[20][4]-origen[20][5];
      r.t4 := -0.001;
      return next r;
--  end if;

--  if origen[8][4]-origen[8][5]<>0 then
      r.rubro1:='Prstamos bancarios y de otros organismos';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[8][4]-origen[8][5];
      r.t4 := -0.001;
      return next r;
--  end if;


      r.rubro1:='Amortizacin de prstamos bancarios y de otros organismos';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := 0.00;
      r.t4 := -0.001;
      return next r;


--  if origen[9][4]-origen[9][5]<>0 then
--    r.rubro1:='Otras cuentas x pagar';
--    r.t1 := NULL;
--    r.t2 := NULL;
--    r.t3 := origen[9][4]-origen[9][5];
--    r.t4 := -0.001;
--    return next r;
--  end if;

--  if origen[10][4]-origen[10][5]<>0 then
--    r.rubro1:='Otros adeudos vencidos';
--    r.t1 := NULL;
--    r.t2 := NULL;
--    r.t3 := origen[10][4]-origen[10][5];
--    r.t4 := -0.001;
--    return next r;
--  end if;

--  if origen[11][4]-origen[11][5]<>0 then
--    r.rubro1:='Otras cuentas x cobrar';
--    r.t1 := NULL;
--    r.t2 := NULL;
--    r.t3 := origen[11][4]-origen[11][5];
--    r.t4 := -0.001;
--    return next r;
--  end if;

  if origen[12][4]-origen[12][5]<>0 then
    r.rubro1:='Bienes Adjudicados';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := origen[12][4]-origen[12][5];
    r.t4 := -0.001;
    return next r;
  end if;

  if origen[13][4]-origen[13][5]<>0 then
    r.rubro1:='Inversiones permanentes en acciones';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := origen[13][4]-origen[13][5];
    r.t4 := NULL;
    return next r;
  end if;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.001;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := s2;
    r.t4 := NULL;
    return next r;

    r.rubro1:='Recursos generados o utilizados por la operacin';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := s1+s2;
    r.t4 := -0.001;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.002;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='Actividades de financiamiento';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

--  if origen[14][4]-origen[14][5]<>0 then
      r.rubro1:='Emisin de obligaciones subordinadas';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[14][4]-origen[14][5];
      r.t4 := -0.001;
      return next r;
--  end if;

      r.rubro1:='Amortizacin de obligaciones subordinadas';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := 0.00;
      r.t4 := -0.001;
      return next r;

      r.rubro1:='Distribucin de excedentes(1)';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := 0.00;
      r.t4 := -0.001;
      return next r;

      r.rubro1:='Pago de dividendos en efectivo (2)';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := 0.00;
      r.t4 := -0.001;
      return next r;



--    if origen[15][4]-origen[15][5]<>0 then
      r.rubro1:='Aportaciones o reembolsos de capital social';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[15][4]-origen[15][5];
      r.t4 := -0.001;
      return next r;
--    end if;

      r.rubro1:='Disminucin o aumento en otras cuentas x pagar';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[9][4]-origen[9][5];
      r.t4 := -0.001;
      return next r;

s3:=origen[15][4]-origen[15][5]+origen[9][4]-origen[9][5];


--  if origen[16][4]-origen[16][5]<>0 then
--    r.rubro1:='Capital Ganado';
--    r.t1 := NULL;
--    r.t2 := NULL;
--    r.t3 := origen[16][4]-origen[16][5];
--    r.t4 := NULL;
--    return next r;
--  end if;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.001;
    r.t4 := NULL;
    return next r;

    r.rubro1:='Recursos generados  utilizados en actividades de financiamiento';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := s3;
    r.t4 := -0.001;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.002;
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='Actividades de inversin';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

--  if origen[17][4]-origen[17][5]<>0 then
      r.rubro1:='Adquisiciones o ventas de activo fijo y de inversiones permantentes en acciones';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[17][4]-origen[17][5];
      r.t4 := -0.001;

      s4:= r.t3;

      return next r;
--  end if;

--  if origen[18][4]-origen[18][5]<>0 then
      r.rubro1:='Disminucin o aumento en cargos y crditos diferidos';
      r.t1 := NULL;
      r.t2 := NULL;
      r.t3 := origen[18][4]-origen[18][5];
      r.t4 := -0.001;

      s4:=s4+r.t3;

      return next r;
--  end if;


    r.rubro1:='Otras cuentas x cobrar';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := origen[11][4]-origen[11][5];
    r.t4 := -0.001;
    return next r;

-- Otras cuentas x cobrar
s4:=s4+origen[11][4]-origen[11][5];

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.001;
    r.t4 := NULL;
    return next r;

   
    r.rubro1:='Recursos generados o utilizados en actividades de inversin';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := s4;
    r.t4 := -0.001;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.002;
    r.t4 := NULL;
    return next r;


    r.rubro1:='Disminucin o aumento de efectivo y equivalentes';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := origen[19][3];
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.002;
    r.t4 := NULL;
    return next r;


    r.rubro1:='Efectivo y equivalentes al principio del periodo';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := origen[19][1];
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.001;
    r.t4 := NULL;
    return next r;


    r.rubro1:='Efectivo y equivalentes al final del periodo';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := origen[19][2];
    r.t4 := NULL;
    return next r;

    r.rubro1:=NULL;
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := -0.002;
    r.t4 := NULL;
    return next r;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sprporigen(integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: sprpr2111(integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sprpr2111(integer, integer, integer, integer) RETURNS SETOF rrpedores
    AS $_$
declare

  pejercicio   alias for $1;
  pperiodo     alias for $2;
  pconsolidado alias for $3;
  pmiles       alias for $4;

  sconsolida char(1);
  r rrpedores%rowtype;

  daytab numeric[2][12]:=array[[31,28,31,30,31,30,31,31,30,31,30,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31]];
  mestab varchar[12]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE'];


  cf numeric;
  fcarteramenor90 numeric;
  fcarteramayor90 numeric;
  cf1 numeric;

  rcre1 numeric;
  rcre2 numeric;
  rcre3 numeric;

  r1 numeric;
  r2 numeric;
  r3 numeric;
  r4 numeric;
  r5 numeric;
  r6 numeric;
  r7 numeric;
  r8 numeric;
  ra numeric;
  rb numeric;
  rc numeric;
  ra1 numeric;
  rb2 numeric;

  req1 numeric;

  pg1 numeric;
  pg2 numeric;
  pg3 numeric;

  req2 numeric;

  fcapitalneto numeric;

  reqt numeric;

  pfecha date;

begin

  select cast(to_char(pejercicio,'9999')||'-'||trim(to_char(pperiodo,'99'))||'-'||trim(to_char(daytab[1][pperiodo],'99')) as date)
    into pfecha;

  raise notice 'Fecha %',pfecha;


-- Primero validar el riesgo de credito

--
--  Comienza pagina 1
--
--

  if pconsolidado=1 then
    r.rubro1:='CONSOLIDADO';
    r.t1 := NULL; 
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4:=1;
    sconsolida:='S';
  else
    r.rubro1:='SUCURSAL';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4:=1;
    sconsolida:='N';
  end if;
  return next r;

  select nombrecaja into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  select niveloperaciones into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  select direccioncaja into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  -- Pendiente validar ao bisiesto

  if pconsolidado=1 then
    r.rubro1:='CALCULO CONSOLIDADO DEL REQUERIMIENTO DE CAPITAL POR RIESGOS DE CREDITO Y MERCADO AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  else
    r.rubro1:='CALCULO DEL REQUERIMIENTO DE CAPITAL POR RIESGOS DE CREDITO Y MERCADO AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');

  end if;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  r.rubro1:='EXPRESADO EN MONEDA DE PODER ADQUISITIVO HISTORICO';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  if pmiles=1 then
    r.rubro1:='(CIFRAS EN MILES DE PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := 1;
    return next r;
  else
    r.rubro1:='(CIFRAS EN PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := 1;
    return next r;
  end if;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  r.rubro1:='1.- RIESGO DE CRDITO';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  rcre1:=0;

  r.rubro1:='GRUPO 1';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;


  cf:=saldocuenta('1101  ',pejercicio,pperiodo,sconsolida);
  r.rubro1:='Caja';
  r.t1 := cf;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  rcre1:= rcre1+cf;

  r.rubro1:='Valores emitidos o avalados por el Gobierno Federal';
  r.t1 := 0.00;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  r.rubro1:='Crditos al Gobierno Federal o con garanta expresa de la Federacin';
  r.t1 := 0.00;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  r.rubro1:='Operaciones continguentes realizadas con las personas sealadas en este grupo';
  r.t1 := 0.00;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  r.rubro1:='Otras operaciones donde la contraparte sea alguna de las personas mencionas de este grupo';
  r.t1 := 0.00;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  r.rubro1:='TOTAL GRUPO 1';
  r.t1 := rcre1;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  

  pg1:=0.00;
  r.rubro1:='Ponderacin por riesgo de Activos Grupo 1 (0%)';
  r.t1 := 0.00;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  
 
  rcre2:=0;

  r.rubro1:='GRUPO 2';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  

  cf:=saldocuenta('1102 ',pejercicio,pperiodo,sconsolida);

  r.rubro1:='Depsitos, valores y crditos a cargo de o garantizados o avalados por instituciones de crdito y por casas de bolsa';
  r.t1 := cf;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  rcre2:=rcre2+cf;
  
  r.rubro1:='Crditos y valores a cargo de o garantizados o avalados por fideocomisos pblicos constituidos por el Gobierno Federal para el fomento econmico';
  r.t1 := 0.00;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  



  r.rubro1:='Valores y crditos a cargo de organismos descentralizados del Gobierno Federal';
  r.t1 := 0;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  

  cf:=saldocuenta('1201 ',pejercicio,pperiodo,sconsolida)+
      saldocuenta('1204  ',pejercicio,pperiodo,sconsolida);


  r.rubro1:='Otras operaciones autorizadas en donde la contraparte de las Entidades sea alguna de las personas mencionadas en este grupo';
  r.t1 := cf;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  

  rcre2:=rcre2+cf;

  r.rubro1:='TOTAL GRUPO 2';
  r.t1 := rcre2;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  


  pg2:=rcre2*0.20;
  r.rubro1:='Ponderacin por riesgo de Activos Grupo 2 (20%)';
  r.t1 := pg2;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;
 
  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  rcre3:=0;

  r.rubro1:='GRUPO 3';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  


  cf:=saldocuenta('13  ',pejercicio,pperiodo,sconsolida);

  r.rubro1:='Crditos, valores y dems activos, no comprendidos en los numerales anteriores';
  r.t1 := cf;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  pg3:=cf*1.00;
  r.rubro1:='Ponderacin por riesgo de Activos Grupo 3 (100%)';
  r.t1 := pg3;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  


  r.rubro1:='Activos ponderados por riesgo (1+2+3)';
  r.t1 := pg1+pg2+pg3;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  

  req2:=(pg1+pg2+pg3)*0.08;
  r.rubro1:='Requerimiento por riesgo de crdito (8% de Activos ponderados por riesgo)';
  r.t1 := req2;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 1;
  return next r;  


-- Comienza la pagina 2 requerimiento de riesgo de mercado

  -- Pendiente validar ao bisiesto


  if pconsolidado=1 then
    r.rubro1:='CALCULO CONSOLIDADO DEL REQUERIMIENTO DE CAPITAL POR RIESGOS DE CREDITO Y MERCADO AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  else
    r.rubro1:='CALCULO DEL REQUERIMIENTO DE CAPITAL POR RIESGOS MERCADO AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');

  end if;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;

  r.rubro1:='EXPRESADO EN MONEDA DE PODER ADQUISITIVO HISTORICO';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;

  if pmiles=1 then
    r.rubro1:='(CIFRAS EN MILES DE PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := 2;
    return next r;
  else
    r.rubro1:='(CIFRAS EN PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := 2;
    return next r;
  end if;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;

  r.rubro1:='2.- RIESGO DE MERCADO';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;

  cf:= req2;
  r1:=cf;

  r.rubro1:='1.- Requerimiento de Capital por Riesgo de Crdito ';
  r.t1 := cf;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;
 

  r.rubro1:='TOTAL ';
  r.t1 := cf;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;


  req1:=req2*.3;

  r.rubro1:='REQUERIMIENTO POR RIESGO DE MERCADO 30%';
  r.t1 := req1;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 2;
  return next r;


--
--  Comienza pagina 3
--
--


  if pconsolidado=1 then
    r.rubro1:='CONSOLIDADO';
    r.t1 := NULL; 
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4:=3;
    sconsolida:='S';
  else
    r.rubro1:='SUCURSAL';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4:=3;
    sconsolida:='N';
  end if;
  return next r;

  select nombrecaja into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  select niveloperaciones into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  select direccioncaja into r.rubro1 from empresa where empresaid=1;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  -- Pendiente validar ao bisiesto
  if pconsolidado=1 then
    r.rubro1:='CALCULO CONSOLIDADO DEL REQUERIMIENTO DE CAPITAL POR RIESGOS DE CREDITO Y MERCADO AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');
  else
    r.rubro1:='CALCULO DEL REQUERIMIENTO DE CAPITAL POR RIESGOS DE CREDITO Y MERCADO AL '||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');

  end if;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='EXPRESADO EN MONEDA DE PODER ADQUISITIVO HISTORICO';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  if pmiles=1 then
    r.rubro1:='(CIFRAS EN MILES DE PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := 3;
    return next r;
  else
    r.rubro1:='(CIFRAS EN PESOS)';
    r.t1 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := 3;
    return next r;
  end if;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='3.- CAPITAL NETO';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  cf:=(-1*saldocuenta('41  ',pejercicio,pperiodo,sconsolida))+
      (-1*saldocuenta('42  ',pejercicio,pperiodo,sconsolida));

  r.rubro1:='1.- Capital Contable';
  r.t1 := cf;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='mas Obligaciones Subordinadas de conversion obligatoria';
  r.t1 := 0.00;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='mas Obligaciones subordinadas no convertibles o de conversion voluntaria con los requisitos establecidos';
  r.t1 := 0.00;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='';
  r.t1 := null;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;


  cf1:=saldocuenta('19  ',pejercicio,pperiodo,sconsolida);

  r.rubro1:='menos Las partidas que se contabilicen en el Activo de la Entidad como Intangibles';
  r.t1 := cf1;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='menos Crditos que se otorguen y las demas operaciones que se realicen en contravencion a las disposiciones aplicables';
  r.t1 := 0.00;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;


  fcapitalneto:=cf;
  r.rubro1:='CAPITAL NETO ';
  r.t1 := fcapitalneto;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;


  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;


  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='NIVEL DE CAPITALIZACION';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='REQUERIMIENTO TOTAL DE CAPITAL POR RIESGO DE MERCADO';
  r.t1 := req1;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='REQUERIMIENTO TOTAL DE CAPITAL POR RIESGO DE CRDITO';
  r.t1 := req2;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='100% DE OPERACIONES FUERA DE POLITICAS';
  r.t1 := 0.00;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  reqt:=req1+req2;

  r.rubro1:='REQUERIMIENTO TOTAL DE CAPITAL POR RIESGOS';
  r.t1 := reqt;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:=NULL;
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='CAPITAL NETO/REQUERIMIENTO TOTAL DE CAPITAL POR RIESGOS';
  r.t1 := 100*fcapitalneto/reqt;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;

  r.rubro1:='PARAMETRO>=100%';
  r.t1 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := 3;
  return next r;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sprpr2111(integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: sprprazones(date, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sprprazones(date, integer, integer) RETURNS SETOF rrprazones
    AS $_$
declare

  pfechaf   alias for $1;
  pconsolidado alias for $2;
  pmiles       alias for $3;

  sconsolida char(1);
  r rrprazones%rowtype;
  f record;

  daytab numeric[2][13]:=array[[31,28,31,30,31,30,31,31,30,31,30,31,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31,31]];
  mestab varchar[13]:=array['ENERO','FEBRERO','MARZO',
                            'ABRIL','MAYO','JUNIO',
                            'JULIO','AGOSTO','SEPTIEMBRE',
                            'OCTUBRE','NOVIEMBRE','DICIEMBRE',
                            'DICIEMBRE'];

  dfechai date;
  querysql  varchar;

  cfa numeric;
  cfb numeric;

  cfc numeric;
  cfd numeric;

  cfe numeric;
  cff numeric;

  cfg numeric;
  cfh numeric;
 
  t1 numeric;
  t2 numeric;

  pperiodo int;
  pejercicio int;

  sgerente varchar;
  scontador varchar;
  scontadorsucursal varchar;
  spresidenteadmon varchar;

  razon2 numeric;
  razon3 numeric;
  razon4 numeric;
  razon5 numeric;
  razon6 numeric;
  razon7 numeric;
  razon8 numeric;
  razon9 numeric;
  razon10 numeric;
  razon11 numeric;

  finvmenor30 numeric;

begin

  cfa:=0;
  cfb:=0;
  cfc:=0;
  cfd:=0;
  cfe:=0;
  cff:=0;
  cfg:=0;
  cfh:=0;

  t1:=0;
  t2:=0;

  -- Inicio de mes

  dfechai := pfechaf - (cast(extract(day from pfechaf) as integer) -1);
  raise notice 'Fecha inicio de mes %',dfechai;

  pejercicio:=cast(extract(year from pfechaf) as integer);
  pperiodo:=cast(extract(month from pfechaf) as integer);


  if pconsolidado=1 then
    r.rubro1:='GG:CONSOLIDADO::RAZONES FINANCIERAS';
    sconsolida:='S';
  else
    r.rubro1:='GG:SUCURSAL::RAZONES FINANCIERAS';
    sconsolida:='N';
  end if;
  return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

  select 'GG:'||nombrecaja into r.rubro1 from empresa where empresaid=1;
  r.rubro2 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select  'GG:'||niveloperaciones into r.rubro1 from empresa where empresaid=1;
  r.rubro2 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  select  'GG:'||direccioncaja into r.rubro1 from empresa where empresaid=1;
  r.rubro2 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  -- Pendiente validar ao bisiesto
  if pconsolidado=1 then
   r.rubro1:='GG:RAZONES FINANCIERAS'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');

  else
   r.rubro1:='GG:RAZONES FINANCIERAS'||to_char(daytab[1][pperiodo],'99')||' DE '||mestab[pperiodo]||' DE'||to_char(pejercicio,'9999');

  end if;
  r.rubro2 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  r.rubro1:='GG:EXPRESADO EN MONEDA DE PODER ADQUISITIVO HISTORICO';
  r.rubro2 := NULL;
  r.t2 := NULL;
  r.t3 := NULL;
  r.t4 := NULL;
  return next r;

  if pmiles=1 then
    r.rubro1:='GG:(CIFRAS EN MILES DE PESOS)';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  else
    r.rubro1:='GG:(CIFRAS EN PESOS)';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
  end if;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:2. COBERTURA DE CARTERA VENCIDA::Parmetro >=     90%';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:Frmula a/b  ';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    cfa:=abs(saldocuenta('1303',pejercicio,pperiodo,sconsolida));
   
    if (pmiles=1) then
        cfa:=cfa/1000.00;
    end if;

    raise notice ' Razon aqui 1';

  
    r.rubro1:='a)Estimacin preventiva para riesgos crediticios';
    r.rubro2 := '';
    r.t2 := cfa;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
   
    cfb:=abs(saldocuenta('1302',pejercicio,pperiodo,sconsolida));

    if (pmiles=1) then
        cfb:=cfb/1000.00;
    end if;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='b )Total de cartera de crdito vencida ';
    r.rubro2:=NULL;
    r.t2 := cfb;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if cfb <> 0 then 
       razon2:=cfa/cfb*100;
    else
       razon2:=0;
    end if;

    r.rubro1:=' ';
    r.rubro2 := 'Nivel de cobertura de la entidad';
    r.t2 := razon2;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    raise notice ' Razon 2 %',razon2;

    if razon2 >= 90 then        
       t1:=4.95;
    else
       t1:=0;
    end if;

    t2:=t2+t1;
    
    r.rubro1:='Valor POR CNBV   4.95%';
    r.rubro2 :='Calificacin=';
    r.t2 := t1;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    -- Razon 3

    r.rubro1:='GG:3. SOLVENCIA::Parmetro >=    100%';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:Formula (a-b-c-d) / (e+f)';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfa:=abs(saldocuenta('1',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfa:=cfa/1000.00;
    end if;

    r.rubro1:='a)Activo total.';
    r.rubro2 :=' ';
    r.t2 := cfa;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfb:=abs(saldocuenta('1302',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfb:=cfb/1000.00;
    end if;

    r.rubro1:='b)Cartera de credito vencido';
    r.rubro2 :=' ';
    r.t2 := cfb;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
    
    cfc:=abs(saldocuenta('15',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfc:=cfc/1000.00;
    end if;

    r.rubro1:='c)Bienes adjudicados';
    r.rubro2 :=' ';
    r.t2 := cfc;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
    
 
    cfd:=abs(saldocuenta('19',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfd:=cfd/1000.00;
    end if;

    r.rubro1:='d)Activos intangibles y diferidos';
    r.rubro2 :=' ';
    r.t2 := cfd;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
    
 
    cfe:=abs(saldocuenta('21',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfe:=cfe/1000.00;
    end if;

    r.rubro1:='e)Depositos totales';
    r.rubro2 :=' ';
    r.t2 := cfe;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cff:=abs(saldocuenta('4',pejercicio,pperiodo,sconsolida))+abs(saldocuenta('5',pejercicio,pperiodo,sconsolida))-abs(saldocuenta('6',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cff:=cff/1000.00;
    end if;

    r.rubro1:='f)Capital contable';
    r.rubro2 :=' ';
    r.t2 := cff;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if (cfe+cff) <> 0 then 
       razon3:=(cfa-cfb-cfc-cfd)/(cfe+cff)*100;
    else
       razon3:=0;
    end if; 

    r.rubro1:=' ';
    r.rubro2 := 'Nivel de cobertura de la entidad';
    r.t2 := razon3;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if razon3 >= 100 then        
       t1:=4.95;
    else
       t1:=0;
    end if;

    t2:=t2+t1;
    
    r.rubro1:='Valor POR CNBV   4.95%';
    r.rubro2 :='Calificacin=';
    r.t2 := t1;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

 -- Razon 4

    r.rubro1:='GG:4. LIQUIDEZ::Parmetro >=     10%';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:Frmula   (a+b+c+d) / (e)';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfa:=abs(saldocuenta('1101',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfa:=cfa/1000.00;
    end if;

    r.rubro1:='a)Caja.';
    r.rubro2 :=' ';
    r.t2 := cfa;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    cfb:=abs(saldocuenta('1102',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfb:=cfb/1000.00;
    end if;

    r.rubro1:='b)Bancos ';
    r.rubro2 :=' ';
    r.t2 := cfb;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
    
    cfc:=abs(saldocuenta('12',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfc:=cfc/1000.00;
    end if;

    r.rubro1:='c) Inversiones en valores ';
    r.rubro2 :=' ';
    r.t2 := cfc;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
     
    cfd:=abs(saldocuenta('19',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfd:=cfd/1000.00;
    end if;

    r.rubro1:='d)Activos intangibles y diferidos';
    r.rubro2 :=' ';
    r.t2 := cfd;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
    
    if sconsolida='S' then

      select sum(deposito+interes)
        into finvmenor30
        from inversionesxfechac(pfechaf)
       where plazo>90;

    else
      select sum(deposito+interes)
        into finvmenor30
        from inversionesxfecha(pfechaf)
       where plazo>90;

    end if;

    finvmenor30:=coalesce(finvmenor30,0);

    cfe:=abs(saldocuenta('21',pejercicio,pperiodo,sconsolida))- finvmenor30;  

    if (pmiles=1) then
        cfe:=cfe/1000.00;
    end if;

    r.rubro1:='e) Pasivos a corto plazo';
    r.rubro2 :=' ';
    r.t2 := cfe;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cff:=finvmenor30;

    if (pmiles=1) then
        cff:=cff/1000.00;
    end if;

    r.rubro1:='Nota Pasivos a largo plazo';
    r.rubro2 :=' ';
    r.t2 := cff;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if cfe <> 0 then 
       razon4:=(cfa+cfb+cfc+cfd)/(cfe)*100;
    else
       razon4:=0;
    end if;

    r.rubro1:=' ';
    r.rubro2 := 'Nivel de cobertura de la entidad';
    r.t2 := razon4;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if razon4 >= 10 then        
       t1:=4.95;
    else
       t1:=0;
    end if;

    t2:=t2+t1;
    
    r.rubro1:='Valor POR CNBV   4.95%';
    r.rubro2 :='Calificacin=';
    r.t2 := t1;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


 -- Razon 5

    r.rubro1:='GG:5. INDICE DE MOROSIDAD::Parametro <=  10%';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:Frmula   (a/b) ';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfa:=abs(saldocuenta('1302',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfa:=cfa/1000.00;
    end if;

    r.rubro1:='a)Total de cartera crdito vencida.';
    r.rubro2 :=' ';
    r.t2 := cfa;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfb:=abs(saldocuenta('1301',pejercicio,pperiodo,sconsolida))+abs(saldocuenta('1302',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfb:=cfb/1000.00;
    end if;

    r.rubro1:='b)Cartera de crdito total ';
    r.rubro2 :=' ';
    r.t2 := cfb;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if cfb <> 0 then 
      razon5:=(cfa/cfb)*100;
    else
      razon5:=0;
    end if;

    r.rubro1:=' ';
    r.rubro2 := 'Nivel de cobertura de la entidad';
    r.t2 := razon5;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    if razon5 <= 10 then        
       t1:=4.95;
    else
       t1:=0;
    end if;

    t2:=t2+t1;
    
    r.rubro1:='Valor POR CNBV   4.95% ';
    r.rubro2 :='Calificacin=';
    r.t2 := t1;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

 -- Razon 6

    r.rubro1:='GG:6. FONDEO DE ACTIVOS IMPRODUCTIVOS::Parmetro <=    100%';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:Frmula   (a-b+c+d+e) / (f+g+h)';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfa:=abs(saldocuenta('1302',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfa:=cfa/1000.00;
    end if;

    r.rubro1:='a)Cartera de crdito vencida. ';
    r.rubro2 :=' ';
    r.t2 := cfa;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:menos';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfb:=abs(saldocuenta('1303',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfb:=cfb/1000.00;
    end if;

    r.rubro1:='b)Estimacin preventiva de riesgos crediticios ';
    r.rubro2 :=' ';
    r.t2 := cfb;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
    
    cfc:=abs(saldocuenta('15',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfc:=cfc/1000.00;
    end if;

    r.rubro1:='c)Bienes adjudicados ';
    r.rubro2 :=' ';
    r.t2 := cfc;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
     
    cfd:=abs(saldocuenta('16',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfd:=cfd/1000.00;
    end if;

    r.rubro1:='d)Inmuebles, mobiliario y equipo (neto)';
    r.rubro2 :=' ';
    r.t2 := cfd;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
    
    cfe:=abs(saldocuenta('19',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfe:=cfe/1000.00;
    end if;

    r.rubro1:='e) Otros activos, cargos diferidos e intangibles';
    r.rubro2 :=' ';
    r.t2 := cfe;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cff:=abs(saldocuenta('4101',pejercicio,pperiodo,sconsolida));

    if (pmiles=1) then
        cff:=cff/1000.00;
    end if;

    r.rubro1:='f)Capital Social';
    r.rubro2 :=' ';
    r.t2 := cff;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfg:=abs(saldocuenta('4105',pejercicio,pperiodo,sconsolida))+abs(saldocuenta('4106',pejercicio,pperiodo,sconsolida));

    if (pmiles=1) then
        cfg:=cfg/1000.00;
    end if;

    r.rubro1:='g)Capital institucional';
    r.rubro2 :=' ';
    r.t2 := cfg;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfh:=abs(saldocuenta('4202',pejercicio,pperiodo,sconsolida));

    if (pmiles=1) then
        cfh:=cfh/1000.00;
    end if;

    r.rubro1:='h) Resultado ejercicios anteriores';
    r.rubro2 :=' ';
    r.t2 := cfh;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if (cff+cfg+cfh) <> 0 then 
       razon6:=(cfa-cfb+cfc+cfd+cfe)/(cff+cfg+cfh)*100;
    else
       razon6:=0;
    end if;

    r.rubro1:=' ';
    r.rubro2 := 'Nivel de cobertura de la entidad';
    r.t2 := razon6;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if razon6 <= 100 then        
       t1:=2.25;
    else
       t1:=0;
    end if;

    t2:=t2+t1;
    
    r.rubro1:='Valor POR CNBV   2.25% ';
    r.rubro2 :='Calificacin=';
    r.t2 := t1;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    raise notice ' Razon 6 %',razon6;

 -- Razon 7

    r.rubro1:='GG:7. CREDITO NETO ::Parmetro Entre 70 y 80%';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:Frmula   (a/b) ';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfa:=abs(saldocuenta('13',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfa:=cfa/1000.00;
    end if;

    r.rubro1:='a) Cartera de crdito total neta.';
    r.rubro2 :=' ';
    r.t2 := cfa;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfb:= abs(saldocuenta('1',pejercicio,pperiodo,sconsolida)); 

    if (pmiles=1) then
        cfb:=cfb/1000.00;
    end if;

    r.rubro1:='b) Activo Total ';
    r.rubro2 :=' ';
    r.t2 := cfb;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    raise notice ' Razon 7 %',razon7;

    if cfb <> 0 then        
       razon7:=(cfa/cfb)*100;
    else
       razon7:=0;
    end if;

    r.rubro1:=' ';
    r.rubro2 := 'Nivel de cobertura de la entidad';
    r.t2 := razon7;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if razon7 >= 70 and razon7 <= 80 then        
       t1:=2.70;
    else
       t1:=0;
    end if;

    t2:=t2+t1;
    
    r.rubro1:='Valor POR CNBV   2.70% ';
    r.rubro2 :='Calificacin=';
    r.t2 := t1;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

 -- Razon 8

    r.rubro1:='GG:8. AUTOSUFICIENCIA OPERATIVA::Parmetro >=  100%';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:Frmula  (a+b) / (c+d+e+f)';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfa:=abs(saldocuenta('510103',pejercicio,pperiodo,sconsolida))+abs(saldocuenta('510104',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfa:=cfa/1000.00;
    end if;

    r.rubro1:='a) Ingresos por intereses sobre prstamos ';
    r.rubro2 :=' ';
    r.t2 := cfa;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfb:=abs(saldocuenta('6101',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfb:=cfb/1000.00;
    end if;

    r.rubro1:='b) Comisiones y tarifas cobradas ';
    r.rubro2 :=' ';
    r.t2 := cfb;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
    
    cfc:=abs(saldocuenta('5102',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfc:=cfc/1000.00;
    end if;

    r.rubro1:='c) Gastos x intereses por captacin de recursos';
    r.rubro2 :=' ';
    r.t2 := cfc;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
     
    cfd:=abs(saldocuenta('6102',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfd:=cfd/1000.00;
    end if;

    r.rubro1:='d) Comisiones y tarifas pagadas ';
    r.rubro2 :=' ';
    r.t2 := cfd;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
    
    cfe:=abs(saldocuenta('5104',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfe:=cfe/1000.00;
    end if;

    r.rubro1:='e) Estimacin preventiva para riesgos crediticios';
    r.rubro2 :=' ';
    r.t2 := cfe;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cff:=abs(saldocuenta('62',pejercicio,pperiodo,sconsolida));

    if (pmiles=1) then
        cff:=cff/1000.00;
    end if;

    r.rubro1:='f) Gastos de administracin y promocin';
    r.rubro2 :=' ';
    r.t2 := cff;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if (cfc+cfd+cfe+cff)<> 0 then 
       razon8:=(cfa+cfb)/(cfc+cfd+cfe+cff)*100;
    else
       razon8:=0;
    end if;

    r.rubro1:=' ';
    r.rubro2 := 'Nivel de cobertura de la entidad';
    r.t2 := razon8;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if razon8 >= 100 then      
       t1:=4.95;
    else
       t1:=0;
    end if;

    t2:=t2+t1;
    
    r.rubro1:='Valor POR CNBV   4.95% ';
    r.rubro2 :='Calificacin=';
    r.t2 := t1;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


 -- Razon 9

    r.rubro1:='GG:9. GASTOS DE ADMINISTRACION Y PROMOCION::Parmetro <=      70%';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:Frmula   (a/b) ';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfa:=abs(saldocuenta('62',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfa:=cfa/1000.00;
    end if;

    r.rubro1:='a) Gastos de admnistracin y promocin';
    r.rubro2 :=' ';
    r.t2 := cfa;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfb:=abs(saldocuenta('5101',pejercicio,pperiodo,sconsolida))-abs(saldocuenta('5102',pejercicio,pperiodo,sconsolida));


    if (pmiles=1) then
        cfb:=cfb/1000.00;
    end if;

    r.rubro1:='b) Margen financiero ';
    r.rubro2 :=' ';
    r.t2 := cfb;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if cfb <> 0 then 
       razon9:=(cfa/cfb)*100;
    else
       razon9:=0;
    end if;

    r.rubro1:=' ';
    r.rubro2 := 'Nivel de cobertura de la entidad';
    r.t2 := razon9;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if razon9 <= 70 then      
       t1:=2.70;
    else
       t1:=0;
    end if;

    t2:=t2+t1;
    
    r.rubro1:='Valor POR CNBV   2.70% ';
    r.rubro2 :='Calificacin=';
    r.t2 := t1;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;
 
 -- Razon 10

    r.rubro1:='GG:10. RENDIMIENTO SOBRE LOS ACTIVOS::Parmetro >=       0%';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:Frmula   (a/b) ';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfa:=abs(saldocuenta('5',pejercicio,pperiodo,sconsolida))-abs(saldocuenta('6',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfa:=cfa/1000.00;
    end if;

    r.rubro1:='a) Resultado neto ';
    r.rubro2 :=' ';
    r.t2 := cfa;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    SELECT promedioactivo into cfb FROM promedioactivo(pejercicio,pperiodo,'1');
    cfb:=coalesce(cfb,0);

    if (pmiles=1) then
        cfb:=cfb/1000.00;
    end if;

    r.rubro1:='b) Promedio de activo total ';
    r.rubro2 :=' ';
    r.t2 := cfb;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if cfb <> 0 then 
       razon10:=(cfa/cfb)*100;
    else
       razon10:=0;
    end if;

    r.rubro1:=' ';
    r.rubro2 := 'Nivel de cobertura de la entidad';
    r.t2 := razon10;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if razon10 >= 0 then      
       t1:=2.25;
    else
       t1:=0;
    end if;

    t2:=t2+t1;
    
    r.rubro1:='Valor POR CNBV   2.25% ';
    r.rubro2 :='Calificacin=';
    r.t2 := t1;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

 -- Razon 11

    r.rubro1:='GG:11. MARGEN FINANCIERO::Parmetro >=     70%';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:Frmula   (a/b) ';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfa:=abs(saldocuenta('5101',pejercicio,pperiodo,sconsolida))-abs(saldocuenta('5102',pejercicio,pperiodo,sconsolida));  

    if (pmiles=1) then
        cfa:=cfa/1000.00;
    end if;

    r.rubro1:='a) Margen financiero  ';
    r.rubro2 :=' ';
    r.t2 := cfa;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    cfb:=abs(saldocuenta('510103',pejercicio,pperiodo,sconsolida))+abs(saldocuenta('510104',pejercicio,pperiodo,sconsolida));

    if (pmiles=1) then
        cfb:=cfa/1000.00;
    end if;

    r.rubro1:='b) Ingresos por intereses sobre prstamos';
    r.rubro2 :=' ';
    r.t2 := cfb;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    raise notice ' Aqui vamos en la 11';

    if cfb <> 0 then 
       razon11:=(cfa/cfb)*100;
    else
       razon11:=0;
    end if;

    r.rubro1:=' ';
    r.rubro2 := 'Nivel de cobertura de la entidad';
    r.t2 := razon11;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    if razon11 >= 70 then      
       t1:=2.25;
    else
       t1:=0;
    end if;

    t2:=t2+t1;
    
    r.rubro1:='Valor POR CNBV   2.25% ';
    r.rubro2 :='Calificacin=';
    r.t2 := t1;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='Total POR CNBV  41.85% ';
    r.rubro2 :='Calificacin total entidad=';
    r.t2 := t2;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:DIRECTOR GENERAL:::PRESIDENTE CONSEJO ADMINISTRACIN';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:________________________________:::_________________________________';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    select gerente,contador,contadorsucursal,presidenteadmon
    into sgerente,scontador,scontadorsucursal,spresidenteadmon
    from empresa
    where empresaid=1;
    
    r.rubro1:='GG:'||sgerente||':::'||spresidenteadmon;
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:CONTADOR GENERAL';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:________________________________:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;

    r.rubro1:='GG:'||scontador||':';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


    r.rubro1:='GG:';
    r.rubro2 := NULL;
    r.t2 := NULL;
    r.t3 := NULL;
    r.t4 := NULL;
    return next r;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sprprazones(date, integer, integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: activos; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE activos (
    activoid integer NOT NULL,
    depreciacionid integer NOT NULL,
    activoclave character(6) NOT NULL,
    activodescripcion character varying(255),
    activo_valor numeric NOT NULL,
    porcenvidautil numeric NOT NULL,
    valormercado numeric NOT NULL,
    localizacion character varying(15) NOT NULL,
    activonoserie character varying(16) NOT NULL,
    feciniciodepconta date NOT NULL,
    activotasaconta numeric NOT NULL,
    actdepreacumconta numeric NOT NULL,
    actmetododepreconta numeric NOT NULL,
    feciniciodepfiscal date NOT NULL,
    actdeduccioninme character(1) NOT NULL,
    activotasafiscal numeric NOT NULL,
    actdepreacumfiscal numeric NOT NULL,
    actmetododeprefiscal numeric NOT NULL,
    actmonmaxdedufiscal numeric NOT NULL,
    montooriginal numeric,
    monedaid character(2),
    departamento integer
);


ALTER TABLE sucursal1.activos OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsactivo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsactivo(integer) RETURNS SETOF sucursal1.activos
    AS $_$
declare
  r activos%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select activoid,depreciacionid,activoclave,activodescripcion,activo_valor,porcenvidautil,valormercado,localizacion,activonoserie,feciniciodepconta,activotasaconta,actdepreacumconta,actmetododepreconta,feciniciodepfiscal,actdeduccioninme,activotasafiscal,actdepreacumfiscal,actmetododeprefiscal,actmonmaxdedufiscal,montooriginal,monedaid,departamento from activos where activoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select activoid,depreciacionid,activoclave,activodescripcion,activo_valor,porcenvidautil,valormercado,localizacion,activonoserie,feciniciodepconta,activotasaconta,actdepreacumconta,actmetododepreconta,feciniciodepfiscal,actdeduccioninme,activotasafiscal,actdepreacumfiscal,actmetododeprefiscal,actmonmaxdedufiscal,montooriginal,monedaid,departamento from activos order by activoid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsactivo(integer) OWNER TO sistema;

--
-- Name: spsaldosdemovimientos(character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsaldosdemovimientos(character, character, date) RETURNS SETOF rsaldosdemovimientos
    AS $_$
declare

  psocioinicial alias for $1;
  psociofinal   alias for $2;
  pfecha        alias for $3;

  r rsaldosdemovimientos%rowtype;

begin

  for r in
select mc.tipomovimientoid,s.clavesocioint,
       su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
       sum(mp.debe)-sum(mp.haber) as saldo,max(p.fechapoliza) as ultmov           
  from movicaja mc, movipolizas mp, polizas p, socio s, sujeto su, 
       tipomovimiento t
 where t.tipomovimientoid=mc.tipomovimientoid and   
       t.aplicasaldo='S' and
       p.polizaid = mc.polizaid and
       mp.movipolizaid=mc.movipolizaid and
       p.fechapoliza<pfecha+1 and
       s.socioid=mc.socioid and
       su.sujetoid=s.sujetoid 
group by mc.tipomovimientoid,s.clavesocioint,su.nombre,su.paterno,su.materno      
order by mc.tipomovimientoid,s.clavesocioint

  loop
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsaldosdemovimientos(character, character, date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: amortizaciones; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE amortizaciones (
    amortizacionid integer NOT NULL,
    prestamoid integer NOT NULL,
    claveestadocredito character(3) NOT NULL,
    numamortizacion integer NOT NULL,
    fechadepago date NOT NULL,
    importeamortizacion numeric NOT NULL,
    interesnormal numeric NOT NULL,
    saldo_absoluto numeric NOT NULL,
    interespagado numeric NOT NULL,
    abonopagado numeric NOT NULL,
    ultimoabono date NOT NULL,
    iva numeric,
    totalpago numeric,
    ahorro numeric DEFAULT 0,
    seguro numeric DEFAULT 0,
    ahorropagado numeric DEFAULT 0,
    seguropagado numeric DEFAULT 0,
    cobranza numeric DEFAULT 0,
    cobranzapagado numeric DEFAULT 0,
    moratoriopagado numeric DEFAULT 0
);


ALTER TABLE sucursal1.amortizaciones OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsamortizacion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsamortizacion(integer) RETURNS SETOF sucursal1.amortizaciones
    AS $_$
declare
  r amortizaciones%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from amortizacion where amortizacionid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select * from amortizacion order by amortizacionid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsamortizacion(integer) OWNER TO sistema;

--
-- Name: spsamortizaciones(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsamortizaciones(integer) RETURNS SETOF sucursal1.amortizaciones
    AS $_$
declare
  r amortizaciones%rowtype;
  pclave alias for $1;
begin

   for r in
      select amortizacionid , prestamoid , claveestadocredito , numamortizacion , fechadepago , importeamortizacion , interesnormal , saldo_absoluto , interespagado,abonopagado , ultimoabono ,iva, totalpago,ahorro,seguro,ahorropagado,seguropagado,cobranza,cobranzapagado, moratoriopagado from amortizaciones where prestamoid=pclave order by numamortizacion
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsamortizaciones(integer) OWNER TO sistema;

--
-- Name: spsamortizacionporpagar(integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsamortizacionporpagar(integer, numeric) RETURNS integer
    AS $_$
declare
  lprestamoid alias for $1;
  ppagado alias for $2;
  
  rec record;
  amor record;
  
  noamor integer;
  fpagado numeric;
  fcapital numeric;
  finteres numeric;
  fmoratorio numeric;
  idiasint integer;
  sformula text;
  dultimoabono date;
  fsaldoinsoluto   numeric;
  fsaldoprestamo numeric;
  ftasanormal numeric;
  ftasa_moratoria numeric;
  dfecha_otorga date;
  icalculomoratorioid integer;
  
begin
 
  noamor:=1;
  fcapital := 0;
  finteres := 0;
  fmoratorio :=0;
  fpagado:=ppagado;

   
  select saldoprestamo,tasanormal,tasa_moratoria,fecha_otorga,calculomoratorioid
    into fsaldoprestamo,ftasanormal,ftasa_moratoria,dfecha_otorga,icalculomoratorioid
    from prestamos 
   where prestamoid=lprestamoid;

     
  select max(p.fechapoliza)
     into dultimoabono
     from movicaja mc,polizas p, movipolizas m
    where mc.prestamoid = lprestamoid and             
          p.polizaid = mc.polizaid and
          m.movipolizaid = mc.movipolizaid and
          mc.estatusmovicaja='A' and
          mc.tipomovimientoid='00' and
          m.debe>0;

     dultimoabono := coalesce(dultimoabono,dfecha_otorga);

     
  
  for amor in
   select * from amortizaciones
    where prestamoid=lprestamoid and fechadepago<=CURRENT_DATE and
          (importeamortizacion-abonopagado>0.10) order by fechadepago
  loop

    finteres:=(amor.interesnormal-amor.interespagado);
    fcapital:=(amor.importeamortizacion-amor.abonopagado);
    
   if dultimoabono>amor.fechadepago then
      idiasint := CURRENT_DATE -  dultimoabono;
    else
      idiasint := CURRENT_DATE -  amor.fechadepago;
    end if;

    if idiasint<0 then
      idiasint := 0;
    end if;

    update calculo
       set saldoinsoluto = fsaldoinsoluto,
           amortizacion = amor.importeamortizacion-amor.abonopagado,
           dias = idiasint,
           tasaintnormal = ftasanormal,
           tasaintmoratorio = ftasa_moratoria
     where calculoid=icalculomoratorioid;

    SELECT formula into sformula from calculo where calculoid=icalculomoratorioid;

    for rec in execute
             'SELECT ' || sformula || ' as interes FROM calculo where calculoid='||icalculomoratorioid
    loop
      
      --if round(rec.interes,4)-trunc(round(rec.interes,4))>=0.50 then
      --  fmoratorio := fmoratorio+round(trunc(rec.interes)+1,2);
      --else
      --  fmoratorio := fmoratorio+round(trunc(rec.interes),2);
      --end if;

      fmoratorio := round(rec.interes,2);

     
    end loop;
    
    raise notice ' Aqui vamos  % % % % %',fcapital, finteres, fmoratorio,fpagado,noamor;

    if fcapital+fmoratorio+finteres+((fcapital+finteres)*.15) < fpagado then    
        noamor:=noamor+1;
        fpagado:=fpagado - (fmoratorio+fcapital+finteres+((fcapital+finteres)*.15));
    else
     if fmoratorio+finteres+((fcapital+finteres)*.15) < fpagado  and fpagado > 0 then    
        noamor:=noamor+1;
        fpagado:=0;
     end if;   
    end if;
 
 end loop;

 
return noamor;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsamortizacionporpagar(integer, numeric) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: asesor; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE asesor (
    asesorid integer NOT NULL,
    nomasesor character varying(50) NOT NULL
);


ALTER TABLE sucursal1.asesor OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsasesor(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsasesor(integer) RETURNS SETOF sucursal1.asesor
    AS $_$
declare
  r asesor%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select asesorid,nomasesor from asesor where asesorid=pclave
       order by asesorid
    loop
      return next r;
    end loop;
  else
   for r in
      select asesorid,nomasesor from asesor order by asesorid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsasesor(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: avales; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE avales (
    avalid integer NOT NULL,
    prestamoid integer,
    socioid integer,
    sujetoid integer NOT NULL,
    porcentajeavala numeric,
    relacionconsocio character varying(20),
    noaval integer,
    solicitudprestamoid integer
);


ALTER TABLE sucursal1.avales OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsaval(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsaval(integer) RETURNS SETOF sucursal1.avales
    AS $_$
declare
  r avales%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select avalid,prestamoid,socioid,sujetoid,porcentajeavala,relacionconsocio,noaval,
             solicitudprestamoid
        from avales where avalid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select avalid,prestamoid,socioid,sujetoid,porcentajeavala,relacionconsocio,noaval from avales order by avalid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsaval(integer) OWNER TO sistema;

--
-- Name: spsavala(character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsavala(character, character, character, character) RETURNS smallint
    AS $_$
declare
  pnombre alias for $1;
  ppaterno alias for $2;
  pmaterno alias for $3;
  prfc alias for $4;

  avala int2;
begin

-- Validar que el aval no se encuentre en mas de 2 prestamos activos

   select count(*) into avala
     from prestamos p,avales a,sujeto s
    where upper(ltrim(rtrim(s.nombre))) = upper(ltrim(rtrim(pnombre))) and
          upper(ltrim(rtrim(s.paterno))) = upper(ltrim(rtrim(ppaterno))) and
          upper(ltrim(rtrim(s.materno))) = upper(ltrim(rtrim(pmaterno))) and
          a.sujetoid = s.sujetoid and
          p.prestamoid = a.prestamoid and
          p.saldoprestamo>0 and
          p.claveestadocredito<>'008';
       
   avala := coalesce(avala,0);

return avala;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsavala(character, character, character, character) OWNER TO sistema;

--
-- Name: spsavalac(character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsavalac(character, character, character, character) RETURNS smallint
    AS $_$
declare

  pnombre alias for $1;
  ppaterno alias for $2;
  pmaterno alias for $3;
  prfc alias for $4;
  pavala integer;
  pavalac integer;
  f record;
  r record;
  dblink1 text;
  dblink2 text;

begin

  for f in
    SELECT * from sucursales where vigente='S'

  loop
        pavalac := 0;

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb;
        dblink2:='set search_path to public,'||f.esquema||';select * from  
                                                                  spsavala('||''''||pnombre||''''||',
                                                                           '||''''||ppaterno||''''||',
                                                                           '||''''||pmaterno||''''||',
                                                                           '||''''||prfc||''''||');' ;
        for r in 
          SELECT * FROM
              dblink(dblink1,dblink2) as t(avala int2)
        loop
          pavala := coalesce(r.avala,0);
          pavalac:=pavalac+pavala;

        end loop;
  
      
  end loop;
return pavalac;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsavalac(character, character, character, character) OWNER TO sistema;

--
-- Name: spsavalados(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsavalados(integer) RETURNS SETOF ravalados
    AS $_$
declare

  psocioid alias for $1;
  r ravalados%rowtype;
  x prestamos%rowtype;

  lprestamoid int4;
  fatraso numeric;

  pnombre varchar(40);
  ppaterno varchar(20);
  pmaterno varchar(20);

  lsujetoid int4;

begin

  -- sujetoid del socio
  select s.sujetoid
    into lsujetoid
    from socio s
   where s.socioid=psocioid;

  select upper(ltrim(nombre)),upper(ltrim(materno)),upper(ltrim(paterno))
    into pnombre,pmaterno,ppaterno
    from sujeto
   where sujetoid=lsujetoid;




  for x in
   select p.*
     from prestamos p,avales a,sujeto s
    where upper(ltrim(rtrim(s.nombre))) = upper(ltrim(rtrim(pnombre))) and
          upper(ltrim(rtrim(s.paterno))) = upper(ltrim(rtrim(ppaterno))) and
          upper(ltrim(rtrim(s.materno))) = upper(ltrim(rtrim(pmaterno))) and
          a.sujetoid = s.sujetoid and
          p.prestamoid = a.prestamoid and
          p.saldoprestamo>0 and
          p.claveestadocredito<>'008'
  loop

  for r in

select so.clavesocioint,p.referenciaprestamo, 
       su.nombre||' '||su.paterno||' '||su.materno as nombre,       
       p.montoprestamo, p.saldoprestamo, 0 as atraso
  from prestamos p, socio so, sujeto su
 where p.prestamoid = x.prestamoid and
       so.socioid = p.socioid and
       su.sujetoid = so.sujetoid

  loop

    select prestamoid
      into lprestamoid
      from prestamos
     where referenciaprestamo=r.referenciaprestamo;

    select total into fatraso
      from spscalculopago(lprestamoid)
     where vencidas>0 and diasint>30;

    fatraso:=coalesce(fatraso,0);

    r.atraso := fatraso;

    return next r;
  end loop;

 end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsavalados(integer) OWNER TO sistema;

--
-- Name: spsavalas(character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsavalas(character, character, character) RETURNS text
    AS $_$
declare
  pnombre alias for $1;
  ppaterno alias for $2;
  pmaterno alias for $3;

  r record;
  stmp text; 
  stexto text;

begin

-- Validar que el aval no se encuentre en mas de 2 prestamos activos
  SELECT 'Tiene '||to_char(spsavala(pnombre,ppaterno,pmaterno,'                '),'9')||' firmas como aval.

'
    INTO stexto;

  for r in
   select p.prestamoid
     from prestamos p,avales a,sujeto s
    where upper(ltrim(rtrim(s.nombre))) = upper(ltrim(rtrim(pnombre))) and
          upper(ltrim(rtrim(s.paterno))) = upper(ltrim(rtrim(ppaterno))) and
          upper(ltrim(rtrim(s.materno))) = upper(ltrim(rtrim(pmaterno))) and
          a.sujetoid = s.sujetoid and
          p.prestamoid = a.prestamoid and
          p.saldoprestamo>0 and
          p.claveestadocredito<>'008'
  loop

     select cast(so.clavesocioint as varchar)||' '||cast(p.referenciaprestamo as varchar)||' '||to_char(p.montoprestamo,'999,999.99')||'  '||to_char(p.saldoprestamo,'999,999.99')||'  '||t.desctipoprestamo||'  '||s.nombre||' '||s.paterno||' '||s.materno
       into stmp
       from prestamos p, socio so, sujeto s, tipoprestamo t
      where p.prestamoid = r.prestamoid and
            so.socioid = p.socioid and
            s.sujetoid = so.sujetoid and
            t.tipoprestamoid = p.tipoprestamoid;

    stexto := stexto||stmp||'
';

  end loop;

return stexto;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsavalas(character, character, character) OWNER TO sistema;

--
-- Name: spsavalasc(character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsavalasc(character, character, character) RETURNS text
    AS $_$
declare

  pnombre alias for $1;
  ppaterno alias for $2;
  pmaterno alias for $3;  

  ptotalavales text;
  pavalac text;
  itotalavales int2;
  r record;
  f record;
  dblink1 text;
  dblink2 text;

begin

 pavalac := 0;
  for f in
   SELECT * FROM sucursales where vigente='S'

  loop
         raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

         dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb;

         dblink2:='set search_path, to public,'||f.esquema||';select * from spsavalas('||''''||pnombre||''''||','||''''||ppaterno||''''||','||''''||pmaterno||''''||');';

         for r in
           SELECT * FROM dblink(dblink1, dblink2) as t(avala text)
         
         loop 
            pavalac:=pavalac||r.avala||'
';
         end loop;
     
    end loop;

    select spsavalac into itotalavales from spsavalac(pnombre,ppaterno,pmaterno,'');
        itotalavales:= coalesce(itotalavales,0);
    ptotalavales:= ' Tiene '||to_char(itotalavales,'999')||' como total de firmas de aval'; 
    pavalac:=pavalac||ptotalavales||'
';
    return pavalac;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsavalasc(character, character, character) OWNER TO sistema;

--
-- Name: spsavales(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsavales(integer) RETURNS SETOF sucursal1.avales
    AS $_$
declare
  r avales%rowtype;
  pclave alias for $1;
begin


  for r in
    select avalid,prestamoid,socioid,sujetoid,porcentajeavala,relacionconsocio,noaval,
           solicitudprestamoid
      from avales where prestamoid=pclave
  loop
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsavales(integer) OWNER TO sistema;

--
-- Name: spsavalessolicitud(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsavalessolicitud(integer) RETURNS SETOF sucursal1.avales
    AS $_$
declare
  r avales%rowtype;
  pclave alias for $1;
begin


  for r in
    select avalid,prestamoid,socioid,sujetoid,porcentajeavala,relacionconsocio,noaval,
           solicitudprestamoid
      from avales where solicitudprestamoid=pclave
  loop
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsavalessolicitud(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: bancos; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE bancos (
    no_cuenta character(15) NOT NULL,
    cuentaid character(24) NOT NULL,
    banco character(25) NOT NULL,
    fecha_inicio date NOT NULL,
    saldo_inicial numeric NOT NULL,
    saldo_actual numeric NOT NULL,
    saldo_pen numeric NOT NULL,
    seriebanco character(2),
    nocheque integer
);


ALTER TABLE sucursal1.bancos OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsbanco(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsbanco(character) RETURNS SETOF sucursal1.bancos
    AS $_$
declare
  r bancos%rowtype;
  pclave alias for $1;
begin

  if pclave<>'              ' then
    for r in
      select no_cuenta,cuentaid,banco,fecha_inicio,saldo_inicial,saldo_actual,saldo_pen,seriebanco,nocheque from bancos where no_cuenta=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select no_cuenta,cuentaid,banco,fecha_inicio,saldo_inicial,saldo_actual,saldo_pen,seriebanco,nocheque from bancos order by no_cuenta
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsbanco(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: beneficiario; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE beneficiario (
    beneficiarioid integer NOT NULL,
    inversionid integer,
    socioid integer,
    sujetoid integer NOT NULL,
    parentesco character varying(30) NOT NULL,
    porcentajebeneficiario numeric NOT NULL,
    contratoid integer,
    esbeneficiario integer,
    esrepresentante integer,
    escootitular integer
);


ALTER TABLE sucursal1.beneficiario OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsbeneficiario(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsbeneficiario(integer) RETURNS SETOF sucursal1.beneficiario
    AS $_$
declare
  r beneficiario%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select beneficiarioid,inversionid,socioid,sujetoid,parentesco,porcentajebeneficiario from beneficiario where beneficiarioid=pclave
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsbeneficiario(integer) OWNER TO sistema;

--
-- Name: spsbeneficiarios(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsbeneficiarios(integer) RETURNS SETOF sucursal1.beneficiario
    AS $_$
declare
  r beneficiario%rowtype;
  pclave alias for $1;
begin

  for r in
    select beneficiarioid,inversionid,socioid,sujetoid,parentesco,porcentajebeneficiario
      from beneficiario where inversionid=pclave
  loop
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsbeneficiarios(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: bienes; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE bienes (
    bienid integer NOT NULL,
    sujetoid integer NOT NULL,
    propietario character varying(60),
    describien character varying(60),
    caracteristicas character varying(254),
    registropublico character varying(254),
    valorcomercial numeric,
    valorfiscal numeric,
    valorcatastro numeric,
    datoshipoteca character varying(254),
    relaciongarantia numeric,
    adjudicado character(1),
    fechaadjudicado date
);


ALTER TABLE sucursal1.bienes OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsbienes(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsbienes(integer) RETURNS SETOF sucursal1.bienes
    AS $_$
declare
  r bienes%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from bienes where sujetoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select * from bienes order by bienid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsbienes(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: calculo; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE calculo (
    calculoid integer NOT NULL,
    descripcioncalculo character varying(40) NOT NULL,
    saldoinsoluto numeric,
    dias integer,
    tasaintnormal numeric,
    tasaintmoratorio numeric,
    formula character varying(255) NOT NULL,
    amortizacion numeric,
    montoprestamo numeric
);


ALTER TABLE sucursal1.calculo OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spscalculo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscalculo(integer) RETURNS SETOF sucursal1.calculo
    AS $_$
declare
  r calculo%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from calculo where calculoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select * from calculo order by calculoid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscalculo(integer) OWNER TO sistema;

--
-- Name: spscalculopago(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscalculopago(integer) RETURNS SETOF tcalculopago
    AS $_$
declare
  lprestamoid alias for $1;
  r tcalculopago%rowtype;
  rec record;
  amor record;

  famortizacion numeric;
  fvencidas     numeric;
  idiasint      integer;
  fcapital      numeric;
  finteres      numeric;
  fmoratorio    numeric;
  fiva          numeric;
  ftotal        numeric;

  fmontoprestamo   numeric;
  fsaldoprestamo   numeric;
  dfechaultimopago date;
  ftasanormal      numeric;
  ftasa_moratoria  numeric;
  dfecha_otorga    date;
  dfecha_1er_pago  date;

  fsaldoinsoluto   numeric;

  saplicaiva       char(1);
  sformula text;
  icalculonormalid int4;
  icalculomoratorioid int4;

  finteresminimo numeric;

  itantos int4;
  freciprocidad numeric;

  dultimoabono date;

  saplicareciprocidad char(1);

  fsaldoact numeric;
  fsaldocalculado numeric;

  sclaveestadocredito char(3);

  gIVA numeric;
  gcobrardiainicial int4;

  dfechaprestamo date;

  dfechacobroiva date;

  dfecha2 date;

  gmoratoriopormonto int4;
  gdiasmoratoriopormonto int4;
  gdiasanualesprestamo int4;


  fpagado numeric;
  idiastraspasoavencida numeric;
  idias numeric;
  fmormenor numeric;
  fmormayor numeric;
  swmora numeric;
  dfechapago date;
  dfecha_vencimiento date;

begin

  select iva,cobrardiainicial,aplicareciprocidad,fechacobroiva,moratoriopormonto,diasmoratoriopormonto,diasanualesprestamo
    into gIVA,gcobrardiainicial,saplicareciprocidad,dfechacobroiva,gmoratoriopormonto,gdiasmoratoriopormonto,gdiasanualesprestamo
    from empresa where empresaid=1;

--raise notice 'Calculando';

select fecha_otorga,fechaultimopago
  into dfechaprestamo,dfecha2
  from prestamos where prestamoid=lprestamoid;


  if dfecha2<dfechaprestamo then

    -- La fecha del ultimo pago es menor que la fecha del prestamo

    update prestamos
       set fechaultimopago=dfechaprestamo
     where prestamoid=lprestamoid;

  end if;

if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
  saplicaiva:='N';
end if;


-- Recalcular el saldo en base a pagos
select p.saldoprestamo, p.montoprestamo-sum(m.haber),p.claveestadocredito
  into fsaldoact,fsaldocalculado,sclaveestadocredito
  from prestamos p, tipoprestamo tp, movicaja mc, movipolizas m
 where p.prestamoid = lprestamoid and
       tp.tipoprestamoid = p.tipoprestamoid and
       mc.prestamoid = p.prestamoid and
       m.polizaid = mc.polizaid and
       m.cuentaid = tp.cuentaactivo
group by p.saldoprestamo,p.montoprestamo,p.claveestadocredito;

  fsaldoact:=coalesce(fsaldoact,0);
  fsaldocalculado:=coalesce(fsaldocalculado,0);

  --raise notice ' Saldo Actual %  Saldo Calculado %',fsaldoact,fsaldocalculado;
  if fsaldoact<>fsaldocalculado then
    update prestamos
       set saldoprestamo = fsaldocalculado
     where prestamoid=lprestamoid;
  end if;

  select aplicareciprocidad
    into saplicareciprocidad
    from empresa
   where empresaid=1;

  famortizacion := 0;
  fvencidas     := 0;
  idiasint      := 0;
  fcapital      := 0;
  finteres      := 0;
  fmoratorio    := 0;
  fiva          := 0;
  ftotal        := 0;

  select interesminimo
    into finteresminimo
    from empresa
   where empresaid=1;
  finteresminimo := coalesce(finteresminimo,0);

  select p.montoprestamo,p.saldoprestamo,p.tasanormal,p.tasa_moratoria,p.fecha_otorga,p.fecha_1er_pago,
         tp.aplicaivaprestamo,p.calculonormalid,p.calculomoratorioid,tp.tantos,p.fecha_vencimiento
    into fmontoprestamo,fsaldoprestamo,ftasanormal,ftasa_moratoria,dfecha_otorga,dfecha_1er_pago,
         saplicaiva,icalculonormalid,icalculomoratorioid,itantos,dfecha_vencimiento
    from prestamos p, tipoprestamo tp
   where p.prestamoid=lprestamoid and
         tp.tipoprestamoid = p.tipoprestamoid;


   itantos:=coalesce(itantos,1);
   if itantos>0 then
     freciprocidad := fmontoprestamo/itantos;
   else
     freciprocidad := fmontoprestamo;
   end if;


if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
  saplicaiva:='N';
end if;



--
-- Validar que el saldo insoluto del prestamo se encuentre calculado correctamente
--
--  select fmontoprestamo-coalesce(sum(capitalpagoprestammo),0)
--    into fsaldoinsoluto
--    from pagoprestamo
--   where prestamoid=lprestamoid;

   fsaldoinsoluto := fsaldoprestamo;

   if fsaldoprestamo<>fsaldoinsoluto then
     raise exception 'Error Saldos, verifique saldos del prestamo ... % %',fsaldoprestamo,fsaldoinsoluto;
   end if;

--
-- Fecha de ultimo pago, donde pago a capital o interes normal
--
  select coalesce(MAX(fechaultimopago),dfecha_otorga-1)
    into dfechaultimopago
    from prestamos
   where prestamoid=lprestamoid;

   --
   -- Verificar la fecha de ultimo abono
   -- en caso de estar erronea correguirla
   --
   select max(p.fechapoliza)
     into dultimoabono
     from movicaja mc,polizas p, movipolizas m
    where mc.prestamoid = lprestamoid and             
          p.polizaid = mc.polizaid and
          m.movipolizaid = mc.movipolizaid and
          mc.estatusmovicaja='A' and
          mc.tipomovimientoid='00' and
          m.debe>0;

   dultimoabono := coalesce(dultimoabono,dfechaultimopago);

   --raise notice 'ult. abo. % - ult. pag. %',dultimoabono,dfechaultimopago;
   if dultimoabono<>dfechaultimopago then

     dfechaultimopago := dultimoabono;
     update prestamos
        set fechaultimopago = dultimoabono
      where prestamoid = lprestamoid;

   end if;

--
-- Buscar amortizacion actual
--
   select coalesce(SUM(importeamortizacion-abonopagado),0.00)
     into famortizacion
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago=CURRENT_DATE and importeamortizacion-abonopagado>0;
    
--
-- Buscar amortizaciones vencidas
--
   select coalesce(SUM(round(importeamortizacion-abonopagado,2)),0.00)
     into fvencidas
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<CURRENT_DATE and importeamortizacion-abonopagado>0;
  
  idiasint := CURRENT_DATE - dfechaultimopago;
  fcapital := round( famortizacion + fvencidas, 2);
  
  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    if gcobrardiainicial=1 then
      idiasint := idiasint + 1;
    end if;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;

--
-- Calculo de interes Normal
--

  if ftasanormal>0 then
    ftasanormal := tasareciprocidad(lprestamoid);
  end if;

  if idiasint<0 then
    idiasint := 0;
  end if;

  update calculo
     set saldoinsoluto = fsaldoinsoluto,
         dias = idiasint,
         tasaintnormal = ftasanormal,
         tasaintmoratorio = ftasa_moratoria
   where calculoid=icalculonormalid;

  SELECT formula into sformula from calculo where calculoid=icalculonormalid;

  for rec in execute
      'SELECT round(' || sformula || ',2) as interes FROM calculo where calculoid='||icalculonormalid
  loop

    if round(rec.interes,2)-trunc(round(rec.interes,2))>=0.50 then
      finteres := round(trunc(rec.interes)+1,2);
    else
      finteres := round(trunc(rec.interes),2);
    end if;
  end loop;

--
-- Calculo de interes moratorio
--

  fpagado:= fmontoprestamo - fsaldoinsoluto ;

  select t.diastraspasoavencida into idiastraspasoavencida
    from prestamos p, tipoprestamo t
   where p.prestamoid = lprestamoid and
         t.tipoprestamoid = p.tipoprestamoid;

  -- idiastraspasoavencida:=90;

   --raise notice ' mora menor *** 1 ';

  swmora:=0;
  fmormenor :=0;
  fmormayor :=0;
  dfechapago:=CURRENT_DATE;

  if dfechaultimopago >=  dfecha_vencimiento then

    fmormayor:=fsaldoinsoluto*idiasint*ftasa_moratoria/100/360;

  else

    for amor in
      select * from amortizaciones
      where prestamoid=lprestamoid
      order by fechadepago
    loop

      if fpagado<amor.importeamortizacion then

      --raise notice ' fpagado % amortizacion % --% --%--%',fpagado,amor.importeamortizacion,amor.fechadepago,fmormenor,dfechaultimopago;

      if amor.fechadepago<dfechapago then
        -- Calcular moratorio
        if amor.fechadepago-dfechaultimopago<=idiastraspasoavencida then
          --raise notice ' mora menor 1 ';
          if dfechapago-amor.fechadepago>0 then
            
            if dfechaultimopago > amor.fechadepago then 
              idias:= dfechapago-dfechaultimopago;
            else 
              idias:= dfechapago-amor.fechadepago;
            --idias:= amor.fechadepago-dfechaultimopago;
            end if;

            if idias < 0 then
               idias:=0;
            end if;

            fmoratorio:=(amor.importeamortizacion-fpagado)*idias*ftasa_moratoria/100/360;

            --raise notice ' mora menor 2 %  -- % -- idiasven %',idias,fmoratorio,idiastraspasoavencida;

            if round(fmoratorio,2)-trunc(round(fmoratorio,2))>=0.50 then
               fmormenor := fmormenor + round(trunc(fmoratorio)+1,2);
            else
               fmormenor := fmormenor + round(trunc(fmoratorio),2);
            end if;

            fpagado:=0;
                     
          end if;
        end if;

        if amor.fechadepago-dfechaultimopago>idiastraspasoavencida then
            --raise notice ' mora mayor 1 * %', fmoratorio;
            if dfechapago-amor.fechadepago>0 then
              --raise noce ' mora mayor 2 ';
              -- Aqui se agrega el calculo especial de credimax
            
                 if swmora=0 and amor.fechadepago-dfechaultimopago > idiastraspasoavencida then
                      idias:= dfechapago-amor.fechadepago;
                      fmoratorio:=(fsaldoinsoluto)*idias*ftasa_moratoria/100/360;
                      --raise notice ' mora mayor 2 ** % % %',fsaldoinsoluto,idias,fmoratorio;
                      swmora:=1;
                      -- Lo hacemos una vez y prendemos el switch
                  else
                      fmoratorio:=0;
                  end if;

              --raise notice ' mora menor 3 %  -- % -- idiasven %',idias,fmoratorio,idiastraspasoavencida;
          
              -- Aqui termina 

              if round(fmoratorio,2)-trunc(round(fmoratorio,2))>=0.50 then
                 fmormayor := fmormayor+ round(trunc(fmoratorio)+1,2);
              else
                 fmormayor := fmormayor+ round(trunc(fmoratorio),2);
              end if;
              
              fpagado:=0;

           end if;
         
        end if;

      else
        exit;
      end if;
    else
      fpagado := fpagado - amor.importeamortizacion;
    end if;
    
    end loop;

  end if;

  if fmormayor = 0 and dfecha_vencimiento < dfechapago then
      idias:= dfechapago-dfechaultimopago;
      --idias:= dfechapago-dfecha_vencimiento;
      fmormayor:=(fsaldoinsoluto)*idias*ftasa_moratoria/100/360;
      raise notice ' mora menor 4 %  -- % -- idiasven %',idias,fmormayor,idiastraspasoavencida;
  end if;

  fmoratorio:=coalesce(fmormenor,0)+coalesce(fmormayor,0);


  if CURRENT_DATE-dfechaultimopago>gdiasmoratoriopormonto and gmoratoriopormonto=1 then
    -- Calcular el moratrio en base al saldo
    fmoratorio:=(CURRENT_DATE-dfechaultimopago)*fsaldoinsoluto*ftasa_moratoria/100/gdiasanualesprestamo;
  end if;


  -- No cobrar si la reciprocidad >= saldoprestamo
  if freciprocidad>=fsaldoprestamo and saplicareciprocidad='S' then
    fmoratorio := 0;
  end if;

  -- Iva y pago minimo


if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
  saplicaiva:='N';
end if;


  if ftasanormal>0 then
    if (1+gIVA)*(finteres+fmoratorio)<finteresminimo and dfechaultimopago<>CURRENT_DATE then
      -- Tomar el interes minimo como interes normal    
      finteres := finteresminimo;
      fmoratorio := 0;
    end if;
  end if;

  if saplicaiva='S' then

      fiva := round( (finteres+fmoratorio)*gIVA , 2);

  else
    if ftasanormal>0 then
    if (finteres+fmoratorio)<finteresminimo and dfechaultimopago<>CURRENT_DATE then
      -- Tomar el interes minimo como interes normal
      finteres := finteresminimo;
      fmoratorio := 0;
      fiva:=0;
    end if;
    end if;
  end if;


  ftotal := round(fcapital + finteres + fmoratorio + fiva, 2);

  idiasint := CURRENT_DATE - dfechaultimopago;

  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    if gcobrardiainicial=1 then
      idiasint := idiasint + 1;
    end if;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;

  if idiasint<0 then
    idiasint := 0;
  end if;

  r.prestamoid   := lprestamoid;
  r.amortizacion := round(famortizacion,2);
  r.vencidas     := fvencidas;
  r.diasint      := idiasint;
  r.capital      := round(fcapital,2);
  r.interes      := round(finteres,2);
  r.moratorio    := round(fmoratorio,2);
  r.iva          := round(fiva,2);
  r.total        := round(ftotal,2);

  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscalculopago(integer) OWNER TO sistema;

--
-- Name: spscalculopagoamortizacion(integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscalculopagoamortizacion(integer, numeric) RETURNS SETOF tcalculopago
    AS $_$
declare
  lprestamoid alias for $1;
  pamortizacion alias for $2;
  
  r tcalculopago%rowtype;
  rec record;
  amor record;

  famortizacion numeric;
  fvencidas     numeric;
  idiasint      integer;
  fcapital      numeric;
  finteres      numeric;
  fmoratorio    numeric;
  fiva          numeric;
  ftotal        numeric;

  fmontoprestamo   numeric;
  fsaldoprestamo   numeric;
  dfechaultimopago date;
  ftasanormal      numeric;
  ftasa_moratoria  numeric;
  dfecha_otorga    date;
  dfecha_1er_pago  date;

  fsaldoinsoluto   numeric;

  saplicaiva       char(1);
  sformula text;
  icalculonormalid int4;
  icalculomoratorioid int4;

  finteresminimo numeric;

  itantos int4;
  freciprocidad numeric;

  dultimoabono date;

  saplicareciprocidad char(1);

  fsaldoact numeric;
  fsaldocalculado numeric;

  sclaveestadocredito char(3);

  gIVA numeric;
  gcobrardiainicial int4;

  dfechaprestamo date;

  dfechacobroiva date;

  dfecha2 date;

  gmoratoriopormonto int4;
  gdiasmoratoriopormonto int4;
  gdiasanualesprestamo int4;

  ptipoprestamoid char(3);
  noamor integer;

begin

  select iva,cobrardiainicial,aplicareciprocidad,fechacobroiva,moratoriopormonto,diasmoratoriopormonto,diasanualesprestamo
    into gIVA,gcobrardiainicial,saplicareciprocidad,dfechacobroiva,gmoratoriopormonto,gdiasmoratoriopormonto,gdiasanualesprestamo
    from empresa where empresaid=1;

--raise notice 'Calculando';

select fecha_otorga,fechaultimopago
  into dfechaprestamo,dfecha2
  from prestamos where prestamoid=lprestamoid;


  if dfecha2<dfechaprestamo then

    -- La fecha del ultimo pago es menor que la fecha del prestamo

    update prestamos
       set fechaultimopago=dfechaprestamo
     where prestamoid=lprestamoid;

  end if;

if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
  saplicaiva:='N';
end if;

  famortizacion := 0;
  fvencidas     := 0;
  idiasint      := 0;
  fcapital      := 0;
  finteres      := 0;
  fmoratorio    := 0;
  fiva          := 0;
  ftotal        := 0;

  
  select p.montoprestamo,p.saldoprestamo,p.tasanormal,p.tasa_moratoria,p.fecha_otorga,p.fecha_1er_pago,
         tp.aplicaivaprestamo,p.calculonormalid,p.calculomoratorioid,tp.tantos,p.tipoprestamoid,p.fechaultimopago
    into fmontoprestamo,fsaldoprestamo,ftasanormal,ftasa_moratoria,dfecha_otorga,dfecha_1er_pago,
         saplicaiva,icalculonormalid,icalculomoratorioid,itantos,ptipoprestamoid,dfechaultimopago
    from prestamos p, tipoprestamo tp
   where p.prestamoid=lprestamoid and
         tp.tipoprestamoid = p.tipoprestamoid;

   -- Verificar la fecha de ultimo abono
   -- en caso de estar erronea correguirla
   --
   
   select max(p.fechapoliza)
     into dultimoabono
     from movicaja mc,polizas p, movipolizas m
    where mc.prestamoid = lprestamoid and             
          p.polizaid = mc.polizaid and
          m.movipolizaid = mc.movipolizaid and
          mc.estatusmovicaja='A' and
          mc.tipomovimientoid='00' and
          m.debe>0;

   dultimoabono := coalesce(dultimoabono,dfecha_otorga);

   --raise notice 'ult. abo. % - ult. pag. %',dultimoabono,dfechaultimopago;
   if dultimoabono<>dfechaultimopago then

     dfechaultimopago := dultimoabono;
     update prestamos
        set fechaultimopago = dultimoabono
      where prestamoid = lprestamoid;

   end if;

--
-- Calculo de interes Normal
--
--SE ADICIONO EL C17, C18 Y C19 29MAY09, YA QUE SE SE CREARON PRODUCTOS NUEVOS MISMAS CONSIDERACIONES SALDOS INSOLUTOS PF 

  --calculo para el tipo de prestamo C12, C13, C14, C15, C16, nuevos-> C17,C18,C19

  noamor:=0;
  fcapital := 0;
  finteres := 0;
  
  for amor in
   select *
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<=CURRENT_DATE and
          (importeamortizacion-abonopagado>0.10) order by fechadepago
  loop
   if noamor<pamortizacion then
    finteres:=finteres+(amor.interesnormal-amor.interespagado);
    fcapital:=fcapital+(amor.importeamortizacion-amor.abonopagado);
    noamor:=noamor+1;
   end if; 
  end loop;

  raise notice ' interes % ',finteres;
 
  --
  -- Calculo de interes moratorio
  --
  
  noamor:=0;
  fmoratorio := 0;

  for amor in
   select *
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<CURRENT_DATE and
          importeamortizacion-abonopagado>0 order by fechadepago 
  loop
  if noamor<pamortizacion then
    if dfechaultimopago>amor.fechadepago then
      idiasint := CURRENT_DATE - dfechaultimopago;
    else
      idiasint := CURRENT_DATE - amor.fechadepago;
    end if;

    if idiasint<0 then
      idiasint := 0;
    end if;

    update calculo
       set saldoinsoluto = fsaldoinsoluto,
           amortizacion = amor.importeamortizacion-amor.abonopagado,
           dias = idiasint,
           tasaintnormal = ftasanormal,
           tasaintmoratorio = ftasa_moratoria
     where calculoid=icalculomoratorioid;

    SELECT formula into sformula from calculo where calculoid=icalculomoratorioid;

    for rec in execute
             'SELECT ' || sformula || ' as interes FROM calculo where calculoid='||icalculomoratorioid
    loop
      
      --if round(rec.interes,4)-trunc(round(rec.interes,4))>=0.50 then
      --  fmoratorio := fmoratorio+round(trunc(rec.interes)+1,2);
      --else
      --  fmoratorio := fmoratorio+round(trunc(rec.interes),2);
      --end if;

      fmoratorio := fmoratorio + round(rec.interes,2);

      --raise notice '% Dias % Amortizacion % Tasa % El interes acumulado es %',dfechaultimopago,idiasint,amor.numamortizacion,ftasa_moratoria,fmoratorio;
    end loop;

  noamor:=noamor+1;
  end if; 
 end loop;

 
  if saplicaiva='S' then
      fiva := round( (finteres+fmoratorio)*gIVA , 2);
  end if;

  if idiasint<0 then
    idiasint := 0;
  end if;

  r.prestamoid   := lprestamoid;
  r.amortizacion := round(famortizacion,2);
  r.vencidas     := fvencidas;
  r.diasint      := idiasint;
  r.capital      := round(fcapital,2);
  r.interes      := round(finteres,2);
  r.moratorio    := round(fmoratorio,2);
  r.iva          := round(fiva,2);
  r.total        := round(ftotal,2);

  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscalculopagoamortizacion(integer, numeric) OWNER TO sistema;

--
-- Name: spscalculopagocartera(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscalculopagocartera(integer, date) RETURNS SETOF tcalculopagocartera
    AS $_$
declare
  lprestamoid alias for $1;
  dfechapago  alias for $2;

  r tcalculopagocartera%rowtype;
  rec record;
  amor record;

  famortizacion numeric;
  fvencidas     numeric;
  idiasint      integer;
  fcapital      numeric;
  finteres      numeric;
  fmoratorio    numeric;
  fiva          numeric;
  ftotal        numeric;
  
  fmontoprestamo   numeric;
  fsaldoprestamo   numeric;
  dfechaultimopago date;
  ftasanormal      numeric;
  ftasa_moratoria  numeric;
  dfecha_otorga    date;
  dfecha_1er_pago  date;

  fsaldoinsoluto   numeric;

  saplicaiva       char(1);
  sformula text;
  icalculonormalid int4;
  icalculomoratorioid int4;

  finteresminimo numeric;

  itantos int4;
  freciprocidad numeric;

  dultimoabono date;

  gIVA numeric;
  gcobrardiainicial int4;
  saplicareciprocidad char(1);

  dfechaprestamo date;  

  dfechacobroiva date;

  fpagado numeric;
  idiastraspasoavencida numeric;
  idias numeric;
  idiasmora integer;
  fmormenor numeric;
  fmormayor numeric;
  swmora numeric;
  dfecha_vencimiento date;
  nvencidas integer;
  tamortizaciones numeric;
  swdiasmora integer;

  -- Dias de capital
  ifrecuencia integer;
  dfechaultimapagada date;

begin

  select iva,cobrardiainicial,aplicareciprocidad,fechacobroiva
    into gIVA,gcobrardiainicial,saplicareciprocidad,dfechacobroiva
    from empresa where empresaid=1;

select fecha_otorga into dfechaprestamo from prestamos where prestamoid=lprestamoid;

if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
end if;


  famortizacion := 0;
  fvencidas     := 0;
  idiasint      := 0;
  fcapital      := 0;
  finteres      := 0;
  fmoratorio    := 0;
  fiva          := 0;
  ftotal        := 0;

  select interesminimo
    into finteresminimo
    from empresa
   where empresaid=1;
  finteresminimo := coalesce(finteresminimo,0);

  select p.montoprestamo,p.saldoprestamo,p.tasanormal,p.tasa_moratoria,p.fecha_otorga,p.fecha_1er_pago,
         tp.aplicaivaprestamo,p.calculonormalid,p.calculomoratorioid,tp.tantos,p.fecha_vencimiento,
         (case when p.dias_de_cobro > 0 then p.dias_de_cobro else p.meses_de_cobro*30 end)
    into fmontoprestamo,fsaldoprestamo,ftasanormal,ftasa_moratoria,dfecha_otorga,dfecha_1er_pago,
         saplicaiva,icalculonormalid,icalculomoratorioid,itantos,dfecha_vencimiento,ifrecuencia
    from prestamos p, tipoprestamo tp
   where p.prestamoid=lprestamoid and
         tp.tipoprestamoid = p.tipoprestamoid;


   itantos:=coalesce(itantos,1);
   if itantos>0 then
     freciprocidad := fmontoprestamo/itantos;
   else
     freciprocidad := fmontoprestamo;
   end if;

--
-- Validar que el saldo insoluto del prestamo se encuentre calculado correctamente
--
--  select fmontoprestamo-coalesce(sum(capitalpagoprestammo),0)
--    into fsaldoinsoluto
--    from pagoprestamo
--   where prestamoid=lprestamoid;

   fsaldoinsoluto := fsaldoprestamo;

   if fsaldoprestamo<>fsaldoinsoluto then
     raise exception 'Error Saldos, verifique saldos del prestamo ... % %',fsaldoprestamo,fsaldoinsoluto;
   end if;

--
-- Fecha de ultimo pago, donde pago a capital o interes normal
--
  select coalesce(MAX(fechaultimopago),dfecha_otorga-1)
    into dfechaultimopago
    from prestamos
   where prestamoid=lprestamoid;


   --
   -- Verificar la fecha de ultimo abono
   -- en caso de estar erronea correguirla
   --
   select max(p.fechapoliza)
     into dultimoabono
     from movicaja mc,polizas p, movipolizas m
    where mc.prestamoid = lprestamoid and             
          p.polizaid = mc.polizaid and
          m.movipolizaid = mc.movipolizaid and
          mc.estatusmovicaja='A' and
          mc.tipomovimientoid='00' and
          m.debe+m.haber>0;

   dultimoabono := coalesce(dultimoabono,dfechaultimopago);

--raise notice 'ult. abo. % - ult. pag. %',dultimoabono,dfechaultimopago;
   if dultimoabono>dfechaultimopago then

     dfechaultimopago := dultimoabono;
     update prestamos
        set fechaultimopago = dultimoabono
      where prestamoid = lprestamoid;

   end if;

--
-- Buscar amortizacion actual
--
   select coalesce(SUM(importeamortizacion-abonopagado),0.00)
     into famortizacion
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago=dfechapago and importeamortizacion-abonopagado>0;
    
--
-- Buscar amortizaciones vencidas
--
   select coalesce(SUM(round(importeamortizacion-abonopagado,2)),0.00)
     into fvencidas
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<dfechapago and importeamortizacion-abonopagado>0;

--raise exception ' Vencidas % ',fvencidas;

  idiasint := dfechapago - dfechaultimopago;
  fcapital := round( famortizacion + fvencidas, 2);
  
  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    if gcobrardiainicial=1 then
      idiasint := idiasint + 1;
    end if;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;

--
-- Calculo de interes Normal
--

  ftasanormal := tasareciprocidad(lprestamoid);

  if idiasint<0 then
    idiasint := 0;
  end if;

  update calculo
     set saldoinsoluto = fsaldoinsoluto,
         dias = idiasint,
         tasaintnormal = ftasanormal,
         tasaintmoratorio = ftasa_moratoria
   where calculoid=icalculonormalid;

  SELECT formula into sformula from calculo where calculoid=icalculonormalid;

  for rec in execute
      'SELECT round(' || sformula || ',2) as interes FROM calculo where calculoid='||icalculonormalid
  loop
    -- Preguntar a Juan lo del redondeo
    --raise exception '% -  % % % -  %',sformula,fsaldoinsoluto,idiasint,ftasanormal,rec.interes;

    if round(rec.interes,2)-trunc(round(rec.interes,2))>=0.50 then
      finteres := round(trunc(rec.interes)+1,2);
    else
      finteres := round(trunc(rec.interes),2);
    end if;
  end loop;


--
-- Calculo de interes moratorio
--

  fpagado:= fmontoprestamo - fsaldoinsoluto ;

  select t.diastraspasoavencida into idiastraspasoavencida
    from prestamos p, tipoprestamo t
   where p.prestamoid = lprestamoid and
         t.tipoprestamoid = p.tipoprestamoid;

  swmora:=0;
  fmormenor :=0;
  fmormayor :=0;

  nvencidas:=0;
  idiasmora:=0;
  tamortizaciones:=0;
  swdiasmora:=0;

  if dfechaultimopago >=  dfecha_vencimiento then

    fmormayor:=fsaldoinsoluto*idiasint*ftasa_moratoria/100/360;
    if swdiasmora=0 then
              idiasmora:= idiasint;
              swdiasmora:=1;            
              raise notice ' 1 dias mora %',idiasmora;
    end if;           

  else

    for amor in
      select * from amortizaciones
      where prestamoid=lprestamoid
      order by fechadepago
    loop


      if swdiasmora=0 and amor.importeamortizacion > amor.abonopagado and amor.fechadepago <dfechapago then
              idiasmora:= dfechapago-amor.fechadepago;
              swdiasmora:=1;
              raise notice ' 2 dias mora %  %  %',idiasmora,dfechapago,amor.fechadepago;
      end if;           


    if fpagado<amor.importeamortizacion then

      --raise notice ' fpagado % amortizacion % --% --%--%',fpagado,amor.importeamortizacion,amor.fechadepago,fmormenor,dfechaultimopago;

      if amor.fechadepago<dfechapago then
        -- Calcular moratorio
        if amor.fechadepago-dfechaultimopago<=idiastraspasoavencida then
          --raise notice ' mora menor 1 ';
          if dfechapago-amor.fechadepago>0 then

            if dfechaultimopago > amor.fechadepago then 
              idias:= dfechapago-dfechaultimopago;
            else 
              idias:= dfechapago-amor.fechadepago;
            --idias:= amor.fechadepago-dfechaultimopago;
            end if;

            if idias < 0 then
               idias:=0;
            end if;
           
            nvencidas=nvencidas+1;
            tamortizaciones=tamortizaciones+amor.importeamortizacion;

            fmoratorio:=(amor.importeamortizacion-fpagado)*idias*ftasa_moratoria/100/360;

            --raise notice ' mora menor 2 %  -- %',idias,fmoratorio;

            if round(fmoratorio,2)-trunc(round(fmoratorio,2))>=0.50 then
               fmormenor := fmormenor + round(trunc(fmoratorio)+1,2);
            else
               fmormenor := fmormenor + round(trunc(fmoratorio),2);
            end if;

            fpagado:=0;
                     
          end if;
        end if;

        if amor.fechadepago-dfechaultimopago>idiastraspasoavencida then
            --raise notice ' mora mayor 1 ';
            if dfechapago-amor.fechadepago>0 then
              --   raise notice ' mora mayor 2 ';
              -- Aqui se agrega el calculo especial de credimax
            
                 if swmora=0 and amor.fechadepago-dfechaultimopago > idiastraspasoavencida then
                      idias:= dfechapago-amor.fechadepago;
                      fmoratorio:=(fsaldoinsoluto)*idias*ftasa_moratoria/100/360;
                      swmora:=1;
                      -- Lo hacemos una vez y prendemos el switch
                  else
                      fmoratorio:=0;
                  end if;

                  --raise notice ' mora menor 3 %  -- %',idias,fmoratorio;
          
              -- Aqui termina 

              if round(fmoratorio,2)-trunc(round(fmoratorio,2))>=0.50 then
                 fmormayor := fmormayor+ round(trunc(fmoratorio)+1,2);
              else
                 fmormayor := fmormayor+ round(trunc(fmoratorio),2);
              end if;
              
              fpagado:=0;

           end if;
         
        end if;

      else
        exit;
      end if;
    else
      fpagado := fpagado - amor.importeamortizacion;
    end if;
    
    end loop;

  end if;

  if fmormayor = 0 and dfecha_vencimiento < dfechapago then
      --idias:= dfechapago-dfecha_vencimiento;
      idias:= dfechapago-dfechaultimopago;
      fmormayor:=(fsaldoinsoluto)*idias*ftasa_moratoria/100/360;    
  end if;


  fmoratorio:=coalesce(fmormenor,0)+coalesce(fmormayor,0);

-- Aqui termina el procedimiento
--

  -- No cobrar si la reciprocidad >= saldoprestamo

  if freciprocidad>=fsaldoprestamo and saplicareciprocidad='S' then
    fmoratorio := 0;
  end if;


if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
  saplicaiva:='N';
end if;


  -- Iva y pago minimo

  if (1+gIVA)*(finteres+fmoratorio)<finteresminimo and dfechaultimopago<>dfechapago then
    -- Tomar el interes minimo como interes normal
    finteres := finteresminimo;
    fmoratorio := 0;
  end if;

  if saplicaiva='S' then
    fiva := round( (finteres+fmoratorio)*gIVA , 2);
  else
    if (finteres+fmoratorio)<finteresminimo and dfechaultimopago<>dfechapago then
      -- Tomar el interes minimo como interes normal
      finteres := finteresminimo;
      fmoratorio := 0;
      fiva:=0;
    end if;
  end if;


  ftotal := round(fcapital + finteres + fmoratorio + fiva, 2);

  idiasint := dfechapago - dfechaultimopago;

  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    if gcobrardiainicial=1 then
      idiasint := idiasint + 1;
    end if;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;

  raise notice ' 3 dias mora %',idiasmora;

  if idiasint<0 then
    idiasint := 0;
  end if;

  r.prestamoid   := lprestamoid;
  if nvencidas > 0 then 
        r.amortizacion := round(tamortizaciones/nvencidas,2);
  else
        select min(importeamortizacion) into r.amortizacion from amortizaciones where prestamoid=lprestamoid;
        nvencidas:=trunc(fcapital/r.amortizacion);
  end if;

  dfechaultimapagada:=fechaultimapagada(lprestamoid,dfechapago);  
  idiasmora:=(case when (dfechapago-dfechaultimapagada)-ifrecuencia > 0 then (dfechapago-dfechaultimapagada)-ifrecuencia else 0 end);
  
  r.vencidas     := nvencidas;
  r.diasint      := idiasmora;
  r.capital      := round(fcapital,2);
  r.interes      := round(finteres,2);
  r.moratorio    := round(fmoratorio,2);
  r.iva          := round(fiva,2);
  r.total        := round(ftotal,2);
  r.saldoprestamo:= fsaldoinsoluto;
  r.fechaultimopago:= dfechaultimopago;

  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscalculopagocartera(integer, date) OWNER TO sistema;

--
-- Name: spscalculopagod(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscalculopagod(integer, date) RETURNS SETOF tcalculopago
    AS $_$
declare
  lprestamoid alias for $1;
  dfechapago  alias for $2;

  r tcalculopago%rowtype;
  rec record;
  amor record;

  famortizacion numeric;
  fvencidas     numeric;
  idiasint      integer;
  fcapital      numeric;
  finteres      numeric;
  fmoratorio    numeric;
  fiva          numeric;
  ftotal        numeric;
  
  fmontoprestamo   numeric;
  fsaldoprestamo   numeric;
  dfechaultimopago date;
  ftasanormal      numeric;
  ftasa_moratoria  numeric;
  dfecha_otorga    date;
  dfecha_1er_pago  date;

  fsaldoinsoluto   numeric;

  saplicaiva       char(1);
  sformula text;
  icalculonormalid int4;
  icalculomoratorioid int4;

  finteresminimo numeric;

  itantos int4;
  freciprocidad numeric;

  dultimoabono date;

  gIVA numeric;
  gcobrardiainicial int4;
  saplicareciprocidad char(1);

  dfechaprestamo date;  

  dfechacobroiva date;

  fpagado numeric;
  idiastraspasoavencida numeric;
  idias numeric;
  fmormenor numeric;
  fmormayor numeric;
  swmora numeric;
  dfecha_vencimiento date;

begin

  select iva,cobrardiainicial,aplicareciprocidad,fechacobroiva
    into gIVA,gcobrardiainicial,saplicareciprocidad,dfechacobroiva
    from empresa where empresaid=1;

select fecha_otorga into dfechaprestamo from prestamos where prestamoid=lprestamoid;

if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
end if;


  famortizacion := 0;
  fvencidas     := 0;
  idiasint      := 0;
  fcapital      := 0;
  finteres      := 0;
  fmoratorio    := 0;
  fiva          := 0;
  ftotal        := 0;

  select interesminimo
    into finteresminimo
    from empresa
   where empresaid=1;
  finteresminimo := coalesce(finteresminimo,0);

  select p.montoprestamo,p.saldoprestamo,p.tasanormal,p.tasa_moratoria,p.fecha_otorga,p.fecha_1er_pago,
         tp.aplicaivaprestamo,p.calculonormalid,p.calculomoratorioid,tp.tantos,p.fecha_vencimiento 
    into fmontoprestamo,fsaldoprestamo,ftasanormal,ftasa_moratoria,dfecha_otorga,dfecha_1er_pago,
         saplicaiva,icalculonormalid,icalculomoratorioid,itantos,dfecha_vencimiento
    from prestamos p, tipoprestamo tp
   where p.prestamoid=lprestamoid and
         tp.tipoprestamoid = p.tipoprestamoid;


   itantos:=coalesce(itantos,1);
   if itantos>0 then
     freciprocidad := fmontoprestamo/itantos;
   else
     freciprocidad := fmontoprestamo;
   end if;

--
-- Validar que el saldo insoluto del prestamo se encuentre calculado correctamente
--
--  select fmontoprestamo-coalesce(sum(capitalpagoprestammo),0)
--    into fsaldoinsoluto
--    from pagoprestamo
--   where prestamoid=lprestamoid;

   fsaldoinsoluto := fsaldoprestamo;

   if fsaldoprestamo<>fsaldoinsoluto then
     raise exception 'Error Saldos, verifique saldos del prestamo ... % %',fsaldoprestamo,fsaldoinsoluto;
   end if;

--
-- Fecha de ultimo pago, donde pago a capital o interes normal
--
  select coalesce(MAX(fechaultimopago),dfecha_otorga-1)
    into dfechaultimopago
    from prestamos
   where prestamoid=lprestamoid;


   --
   -- Verificar la fecha de ultimo abono
   -- en caso de estar erronea correguirla
   --
   select max(p.fechapoliza)
     into dultimoabono
     from movicaja mc,polizas p, movipolizas m
    where mc.prestamoid = lprestamoid and             
          p.polizaid = mc.polizaid and
          m.movipolizaid = mc.movipolizaid and
          mc.estatusmovicaja='A' and
          mc.tipomovimientoid='00' and
          m.debe+m.haber>0;

   dultimoabono := coalesce(dultimoabono,dfechaultimopago);

--raise notice 'ult. abo. % - ult. pag. %',dultimoabono,dfechaultimopago;
   if dultimoabono>dfechaultimopago then

     dfechaultimopago := dultimoabono;
     update prestamos
        set fechaultimopago = dultimoabono
      where prestamoid = lprestamoid;

   end if;

--
-- Buscar amortizacion actual
--
   select coalesce(SUM(importeamortizacion-abonopagado),0.00)
     into famortizacion
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago=dfechapago and importeamortizacion-abonopagado>0;
    
--
-- Buscar amortizaciones vencidas
--
   select coalesce(SUM(round(importeamortizacion-abonopagado,2)),0.00)
     into fvencidas
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<dfechapago and importeamortizacion-abonopagado>0;

--raise exception ' Vencidas % ',fvencidas;

  idiasint := dfechapago - dfechaultimopago;
  fcapital := round( famortizacion + fvencidas, 2);
  
  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    if gcobrardiainicial=1 then
      idiasint := idiasint + 1;
    end if;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;

--
-- Calculo de interes Normal
--

  ftasanormal := tasareciprocidad(lprestamoid);

  if idiasint<0 then
    idiasint := 0;
  end if;

  update calculo
     set saldoinsoluto = fsaldoinsoluto,
         dias = idiasint,
         tasaintnormal = ftasanormal,
         tasaintmoratorio = ftasa_moratoria
   where calculoid=icalculonormalid;

  SELECT formula into sformula from calculo where calculoid=icalculonormalid;

  for rec in execute
      'SELECT round(' || sformula || ',2) as interes FROM calculo where calculoid='||icalculonormalid
  loop
    -- Preguntar a Juan lo del redondeo
    --raise exception '% -  % % % -  %',sformula,fsaldoinsoluto,idiasint,ftasanormal,rec.interes;

    if round(rec.interes,2)-trunc(round(rec.interes,2))>=0.50 then
      finteres := round(trunc(rec.interes)+1,2);
    else
      finteres := round(trunc(rec.interes),2);
    end if;
  end loop;


--
-- Calculo de interes moratorio
--

  fpagado:= fmontoprestamo - fsaldoinsoluto ;

  select t.diastraspasoavencida into idiastraspasoavencida
    from prestamos p, tipoprestamo t
   where p.prestamoid = lprestamoid and
         t.tipoprestamoid = p.tipoprestamoid;

  swmora:=0;
  fmormenor :=0;
  fmormayor :=0;

  if dfechaultimopago >=  dfecha_vencimiento then

    fmormayor:=fsaldoinsoluto*idiasint*ftasa_moratoria/100/360;

  else


    for amor in
      select * from amortizaciones
      where prestamoid=lprestamoid
      order by fechadepago
    loop

    if fpagado<amor.importeamortizacion then

      --raise notice ' fpagado % amortizacion % --% --%--%',fpagado,amor.importeamortizacion,amor.fechadepago,fmormenor,dfechaultimopago;

      if amor.fechadepago<dfechapago then
        -- Calcular moratorio
        if amor.fechadepago-dfechaultimopago<=idiastraspasoavencida then
          --raise notice ' mora menor 1 ';
          if dfechapago-amor.fechadepago>0 then

            if dfechaultimopago > amor.fechadepago then 
              idias:= dfechapago-dfechaultimopago;
            else 
              idias:= dfechapago-amor.fechadepago;
            --idias:= amor.fechadepago-dfechaultimopago;
            end if;

            if idias < 0 then
               idias:=0;
            end if;

            fmoratorio:=(amor.importeamortizacion-fpagado)*idias*ftasa_moratoria/100/360;

            --raise notice ' mora menor 2 %  -- %',idias,fmoratorio;

            if round(fmoratorio,2)-trunc(round(fmoratorio,2))>=0.50 then
               fmormenor := fmormenor + round(trunc(fmoratorio)+1,2);
            else
               fmormenor := fmormenor + round(trunc(fmoratorio),2);
            end if;

            fpagado:=0;
                     
          end if;
        end if;

        if amor.fechadepago-dfechaultimopago>idiastraspasoavencida then
            --raise notice ' mora mayor 1 ';
            if dfechapago-amor.fechadepago>0 then
              --   raise notice ' mora mayor 2 ';
              -- Aqui se agrega el calculo especial de credimax
            
                 if swmora=0 and amor.fechadepago-dfechaultimopago > idiastraspasoavencida then
                      idias:= dfechapago-amor.fechadepago;
                      fmoratorio:=(fsaldoinsoluto)*idias*ftasa_moratoria/100/360;
                      swmora:=1;
                      -- Lo hacemos una vez y prendemos el switch
                  else
                      fmoratorio:=0;
                  end if;

                  --raise notice ' mora menor 3 %  -- %',idias,fmoratorio;
          
              -- Aqui termina 

              if round(fmoratorio,2)-trunc(round(fmoratorio,2))>=0.50 then
                 fmormayor := fmormayor+ round(trunc(fmoratorio)+1,2);
              else
                 fmormayor := fmormayor+ round(trunc(fmoratorio),2);
              end if;
              
              fpagado:=0;

           end if;
         
        end if;

      else
        exit;
      end if;
    else
      fpagado := fpagado - amor.importeamortizacion;
    end if;
    
    end loop;

  end if;

  if fmormayor = 0 and dfecha_vencimiento < dfechapago then
      idias:= dfechapago-dfechaultimopago;
      --idias:= dfechapago-dfecha_vencimiento;
      fmormayor:=(fsaldoinsoluto)*idias*ftasa_moratoria/100/360;
      raise notice ' mora menor 4 %  -- % -- idiasven %',idias,fmormayor,idiastraspasoavencida;
  end if;

  fmoratorio:=coalesce(fmormenor,0)+coalesce(fmormayor,0);


-- Aqui termina el procedimiento
--

  -- No cobrar si la reciprocidad >= saldoprestamo

  if freciprocidad>=fsaldoprestamo and saplicareciprocidad='S' then
    fmoratorio := 0;
  end if;


if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
  saplicaiva:='N';
end if;


  -- Iva y pago minimo

  if (1+gIVA)*(finteres+fmoratorio)<finteresminimo and dfechaultimopago<>dfechapago then
    -- Tomar el interes minimo como interes normal
    finteres := finteresminimo;
    fmoratorio := 0;
  end if;

  if saplicaiva='S' then
    fiva := round( (finteres+fmoratorio)*gIVA , 2);
  else
    if (finteres+fmoratorio)<finteresminimo and dfechaultimopago<>dfechapago then
      -- Tomar el interes minimo como interes normal
      finteres := finteresminimo;
      fmoratorio := 0;
      fiva:=0;
    end if;
  end if;


  ftotal := round(fcapital + finteres + fmoratorio + fiva, 2);

  idiasint := dfechapago - dfechaultimopago;

  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    if gcobrardiainicial=1 then
      idiasint := idiasint + 1;
    end if;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;

  if idiasint<0 then
    idiasint := 0;
  end if;

  r.prestamoid   := lprestamoid;
  r.amortizacion := round(famortizacion,2);
  r.vencidas     := fvencidas;
  r.diasint      := idiasint;
  r.capital      := round(fcapital,2);
  r.interes      := round(finteres,2);
  r.moratorio    := round(fmoratorio,2);
  r.iva          := round(fiva,2);
  r.total        := round(ftotal,2);

  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscalculopagod(integer, date) OWNER TO sistema;

--
-- Name: spscalculopagod2(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscalculopagod2(integer, date) RETURNS SETOF tcalculopago
    AS $_$
declare
  lprestamoid alias for $1;
  dfechapago  alias for $2;

  r tcalculopago%rowtype;
  rec record;
  amor record;

  famortizacion numeric;
  fvencidas     numeric;
  idiasint      integer;
  fcapital      numeric;
  finteres      numeric;
  fmoratorio    numeric;
  fiva          numeric;
  ftotal        numeric;

  fmontoprestamo   numeric;
  fsaldoprestamo   numeric;
  dfechaultimopago date;
  ftasanormal      numeric;
  ftasa_moratoria  numeric;
  dfecha_otorga    date;
  dfecha_1er_pago  date;

  fsaldoinsoluto   numeric;

  saplicaiva       char(1);
  sformula text;
  icalculonormalid int4;
  icalculomoratorioid int4;

  finteresminimo numeric;

  itantos int4;
  freciprocidad numeric;

  dultimoabono date;

  gIVA numeric;
  gcobrardiainicial int4;
  saplicareciprocidad char(1);

  dfechaprestamo date;  

  dfechacobroiva date;
  fmor numeric;

begin


  famortizacion := 0;
  fvencidas     := 0;
  idiasint      := 0;
  fcapital      := 0;
  finteres      := 0;
  fmoratorio    := 0;
  fiva          := 0;
  ftotal        := 0;


  select p.montoprestamo,p.saldoprestamo,p.tasanormal,p.tasa_moratoria,p.fecha_otorga,p.fecha_1er_pago,
         tp.aplicaivaprestamo,p.calculonormalid,p.calculomoratorioid,tp.tantos,
         e.iva,e.cobrardiainicial,e.aplicareciprocidad,e.fechacobroiva,e.interesminimo
    into fmontoprestamo,fsaldoprestamo,ftasanormal,ftasa_moratoria,dfecha_otorga,dfecha_1er_pago,
         saplicaiva,icalculonormalid,icalculomoratorioid,itantos,
         gIVA,gcobrardiainicial,saplicareciprocidad,dfechacobroiva,finteresminimo
    from prestamos p, tipoprestamo tp, empresa e
   where p.prestamoid=lprestamoid and
         tp.tipoprestamoid = p.tipoprestamoid and
         e.empresaid = 1;

  finteresminimo := coalesce(finteresminimo,0);

  select fecha_otorga,coalesce(fechaultimopago,dfecha_otorga-1)
    into dfechaprestamo,dfechaultimopago
    from prestamos where prestamoid=lprestamoid;

  if dfechaprestamo<dfechacobroiva then
    gIVA:=0;
  end if;


   itantos:=coalesce(itantos,1);
   if itantos>0 then
     freciprocidad := fmontoprestamo/itantos;
   else
     freciprocidad := fmontoprestamo;
   end if;


--
-- Buscar amortizacion actual
--

  select coalesce(count(amortizacionid),0)
     into famortizacion
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<=dfechapago and importeamortizacion-abonopagado>0;

--
-- Buscar amortizaciones vencidas
--
   select coalesce(SUM(round(importeamortizacion-abonopagado,2)),0.00)
     into fvencidas
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<=dfechapago and importeamortizacion-abonopagado>0;

--raise exception ' Vencidas % ',fvencidas;

  idiasint := dfechapago - dfechaultimopago;
  fcapital := round(fvencidas, 2);
  
  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    if gcobrardiainicial=1 then
      idiasint := idiasint + 1;
    end if;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;

--
-- Calculo de interes Normal
--

  ftasanormal := tasareciprocidad(lprestamoid);

  if idiasint<0 then
    idiasint := 0;
  end if;


--  update calculo
--     set saldoinsoluto = fsaldoinsoluto,
--         dias = idiasint,
--         tasaintnormal = ftasanormal,
--         tasaintmoratorio = ftasa_moratoria
--   where calculoid=icalculonormalid;

--  SELECT formula into sformula from calculo where calculoid=icalculonormalid;

--  for rec in execute
--      'SELECT round(' || sformula || ',2) as interes FROM calculo where calculoid='||icalculonormalid
--  loop
    -- Preguntar a Juan lo del redondeo
    --raise exception '% -  % % % -  %',sformula,fsaldoinsoluto,idiasint,ftasanormal,rec.interes;

--    if round(rec.interes,2)-trunc(round(rec.interes,2))>=0.50 then
--      finteres := round(trunc(rec.interes)+1,2);
--    else
--      finteres := round(trunc(rec.interes),2);
--    end if;
--  end loop;


  fsaldoinsoluto:= fsaldoprestamo;
  if icalculonormalid=1 then
    finteres:= fsaldoinsoluto*idiasint*((ftasanormal/100)/360);
  else
    -- Tomar el monto para icalculonormalid=4
    if icalculonormalid=4 then
      finteres:= fmontoprestamo*idiasint*((ftasanormal/100)/360);
    end if;
  end if;
  if round(finteres,2)-trunc(round(finteres,2))>=0.50 then
    finteres := round(trunc(finteres)+1,2);
  else
    finteres := round(trunc(finteres),2);
  end if;

--raise notice 'Saldo Insoluto %  dias %  tasanormal  % Interes %',fsaldoinsoluto,idiasint,ftasanormal,finteres;


--
-- Calculo de interes moratorio
--

  fmoratorio := 0;

  for amor in
   select *
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<dfechapago and
          importeamortizacion-abonopagado>0
  loop

    if dfechaultimopago>amor.fechadepago then
      idiasint := dfechapago - dfechaultimopago;
    else
      idiasint := dfechapago - amor.fechadepago;
    end if;

    if idiasint<0 then
      idiasint := 0;
    end if;



--    update calculo
--       set saldoinsoluto = fsaldoinsoluto,
--           amortizacion = amor.importeamortizacion-amor.abonopagado,
--           dias = idiasint,
--           tasaintnormal = ftasanormal,
--           tasaintmoratorio = ftasa_moratoria
--     where calculoid=icalculomoratorioid;

--    SELECT formula into sformula from calculo where calculoid=icalculomoratorioid;

--    for rec in execute
--             'SELECT ' || sformula || ' as interes FROM calculo where calculoid='||icalculomoratorioid
--    loop
--      if round(rec.interes,4)-trunc(round(rec.interes,4))>=0.50 then
--        fmoratorio := fmoratorio+round(trunc(rec.interes)+1,2);
--      else
--        fmoratorio := fmoratorio+round(trunc(rec.interes),2);
--     end if;
      --fmoratorio := fmoratorio + round(rec.interes,2);
--    end loop;


    fmor:=(amor.importeamortizacion-amor.abonopagado)*idiasint*((ftasa_moratoria/100)/360);
    if round(fmor,4)-trunc(round(fmor,4))>=0.50 then
      fmor := round(trunc(fmor)+1,2);
    else
      fmor := round(trunc(fmor),2);
    end if;
    fmoratorio:=fmoratorio+fmor;


  end loop;


  -- No cobrar si la reciprocidad >= saldoprestamo
  if freciprocidad>=fsaldoprestamo and saplicareciprocidad='S' then
    fmoratorio := 0;
  end if;


if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
  saplicaiva:='N';
end if;


  -- Iva y pago minimo

  if (1+gIVA)*(finteres+fmoratorio)<finteresminimo and dfechaultimopago<>dfechapago then
    -- Tomar el interes minimo como interes normal
    finteres := finteresminimo;
    fmoratorio := 0;
  end if;

  if saplicaiva='S' then
    fiva := round( (finteres+fmoratorio)*gIVA , 2);
  else
    if (finteres+fmoratorio)<finteresminimo and dfechaultimopago<>dfechapago then
      -- Tomar el interes minimo como interes normal
      finteres := finteresminimo;
      fmoratorio := 0;
      fiva:=0;
    end if;
  end if;


  ftotal := round(fcapital + finteres + fmoratorio + fiva, 2);

  idiasint := dfechapago - dfechaultimopago;

  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    if gcobrardiainicial=1 then
      idiasint := idiasint + 1;
    end if;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;

  if idiasint<0 then
    idiasint := 0;
  end if;

  r.prestamoid   := lprestamoid;
  r.amortizacion := round(famortizacion,2);
  r.vencidas     := fvencidas;
  r.diasint      := idiasint;
  r.capital      := round(fcapital,2);
  r.interes      := round(finteres,2);
  r.moratorio    := round(fmoratorio,2);
  r.iva          := round(fiva,2);
  r.total        := round(ftotal,2);

  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscalculopagod2(integer, date) OWNER TO sistema;

--
-- Name: spscalculopagods(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscalculopagods(integer, date) RETURNS SETOF tcalculopagos
    AS $_$
declare
  lprestamoid alias for $1;
  dfechapago  alias for $2;

  r tcalculopagos%rowtype;
  rec record;
  amor record;

  famortizacion numeric;
  fvencidas     numeric;
  idiasint      integer;
  fcapital      numeric;
  finteres      numeric;
  fmoratorio    numeric;
  fiva          numeric;
  ftotal        numeric;

  fmontoprestamo   numeric;
  fsaldoprestamo   numeric;
  dfechaultimopago date;
  ftasanormal      numeric;
  ftasa_moratoria  numeric;
  dfecha_otorga    date;
  dfecha_1er_pago  date;

  fsaldoinsoluto   numeric;

  saplicaiva       char(1);
  sformula text;
  icalculonormalid int4;
  icalculomoratorioid int4;

  finteresminimo numeric;

  itantos int4;
  freciprocidad numeric;

  dultimoabono date;

  gIVA numeric;
  gcobrardiainicial int4;
  saplicareciprocidad char(1);

  dfechaprestamo date;  

  dfechacobroiva date;

begin

  select iva,cobrardiainicial,aplicareciprocidad,fechacobroiva
    into gIVA,gcobrardiainicial,saplicareciprocidad,dfechacobroiva
    from empresa where empresaid=1;

select fecha_otorga into dfechaprestamo from prestamos where prestamoid=lprestamoid;

if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
end if;


  famortizacion := 0;
  fvencidas     := 0;
  idiasint      := 0;
  fcapital      := 0;
  finteres      := 0;
  fmoratorio    := 0;
  fiva          := 0;
  ftotal        := 0;

  select interesminimo
    into finteresminimo
    from empresa
   where empresaid=1;
  finteresminimo := coalesce(finteresminimo,0);

  select p.montoprestamo,p.saldoprestamo,p.tasanormal,p.tasa_moratoria,p.fecha_otorga,p.fecha_1er_pago,
         tp.aplicaivaprestamo,p.calculonormalid,p.calculomoratorioid,tp.tantos
    into fmontoprestamo,fsaldoprestamo,ftasanormal,ftasa_moratoria,dfecha_otorga,dfecha_1er_pago,
         saplicaiva,icalculonormalid,icalculomoratorioid,itantos
    from prestamos p, tipoprestamo tp
   where p.prestamoid=lprestamoid and
         tp.tipoprestamoid = p.tipoprestamoid;


   itantos:=coalesce(itantos,1);
   if itantos>0 then
     freciprocidad := fmontoprestamo/itantos;
   else
     freciprocidad := fmontoprestamo;
   end if;

--
-- Validar que el saldo insoluto del prestamo se encuentre calculado correctamente
--
--  select fmontoprestamo-coalesce(sum(capitalpagoprestammo),0)
--    into fsaldoinsoluto
--    from pagoprestamo
--   where prestamoid=lprestamoid;

   fsaldoinsoluto := fsaldoprestamo;

   if fsaldoprestamo<>fsaldoinsoluto then
     raise exception 'Error Saldos, verifique saldos del prestamo ... % %',fsaldoprestamo,fsaldoinsoluto;
   end if;

--
-- Fecha de ultimo pago, donde pago a capital o interes normal
--
  select coalesce(MAX(fechaultimopago),dfecha_otorga-1)
    into dfechaultimopago
    from prestamos
   where prestamoid=lprestamoid;


   --
   -- Verificar la fecha de ultimo abono
   -- en caso de estar erronea correguirla
   --
   select max(p.fechapoliza)
     into dultimoabono
     from movicaja mc,polizas p, movipolizas m
    where mc.prestamoid = lprestamoid and             
          p.polizaid = mc.polizaid and
          m.movipolizaid = mc.movipolizaid and
          mc.estatusmovicaja='A' and
          mc.tipomovimientoid='00' and
          m.debe+m.haber>0;

   dultimoabono := coalesce(dultimoabono,dfechaultimopago);

--raise notice 'ult. abo. % - ult. pag. %',dultimoabono,dfechaultimopago;
   if dultimoabono>dfechaultimopago then

     dfechaultimopago := dultimoabono;
     update prestamos
        set fechaultimopago = dultimoabono
      where prestamoid = lprestamoid;

   end if;

--
-- Buscar amortizacion actual
--
   select coalesce(SUM(importeamortizacion-abonopagado),0.00)
     into famortizacion
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago=dfechapago and importeamortizacion-abonopagado>0;
    
--
-- Buscar amortizaciones vencidas
--
   select coalesce(SUM(round(importeamortizacion-abonopagado,2)),0.00)
     into fvencidas
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<dfechapago and importeamortizacion-abonopagado>0;

--raise exception ' Vencidas % ',fvencidas;

  idiasint := dfechapago - dfechaultimopago;
  fcapital := round( famortizacion + fvencidas, 2);
  
  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    if gcobrardiainicial=1 then
      idiasint := idiasint + 1;
    end if;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;

--
-- Calculo de interes Normal
--

  ftasanormal := tasareciprocidad(lprestamoid);

  if idiasint<0 then
    idiasint := 0;
  end if;

  update calculo
     set saldoinsoluto = fsaldoinsoluto,
         dias = idiasint,
         tasaintnormal = ftasanormal,
         tasaintmoratorio = ftasa_moratoria
   where calculoid=icalculonormalid;

  SELECT formula into sformula from calculo where calculoid=icalculonormalid;

  for rec in execute
      'SELECT round(' || sformula || ',2) as interes FROM calculo where calculoid='||icalculonormalid
  loop
    -- Preguntar a Juan lo del redondeo
    --raise exception '% -  % % % -  %',sformula,fsaldoinsoluto,idiasint,ftasanormal,rec.interes;

    if round(rec.interes,2)-trunc(round(rec.interes,2))>=0.50 then
      finteres := round(trunc(rec.interes)+1,2);
    else
      finteres := round(trunc(rec.interes),2);
    end if;
  end loop;


--
-- Calculo de interes moratorio
--

  fmoratorio := 0;

  for amor in
   select *
     from amortizaciones
    where prestamoid=lprestamoid and fechadepago<dfechapago and
          importeamortizacion-abonopagado>0
  loop

    if dfechaultimopago>amor.fechadepago then
      idiasint := dfechapago - dfechaultimopago;
    else
      idiasint := dfechapago - amor.fechadepago;
    end if;

    if idiasint<0 then
      idiasint := 0;
    end if;

    update calculo
       set saldoinsoluto = fsaldoinsoluto,
           amortizacion = amor.importeamortizacion-amor.abonopagado,
           dias = idiasint,
           tasaintnormal = ftasanormal,
           tasaintmoratorio = ftasa_moratoria
     where calculoid=icalculomoratorioid;

    SELECT formula into sformula from calculo where calculoid=icalculomoratorioid;

    for rec in execute
             'SELECT ' || sformula || ' as interes FROM calculo where calculoid='||icalculomoratorioid
    loop
      if round(rec.interes,4)-trunc(round(rec.interes,4))>=0.50 then
        fmoratorio := fmoratorio+round(trunc(rec.interes)+1,2);
      else
        fmoratorio := fmoratorio+round(trunc(rec.interes),2);
      end if;
      --fmoratorio := fmoratorio + round(rec.interes,2);
    end loop;

  end loop;


  -- No cobrar si la reciprocidad >= saldoprestamo
  if freciprocidad>=fsaldoprestamo and saplicareciprocidad='S' then
    fmoratorio := 0;
  end if;


if dfechaprestamo<dfechacobroiva then
  gIVA:=0;
  saplicaiva:='N';
end if;


  -- Iva y pago minimo

  if (1+gIVA)*(finteres+fmoratorio)<finteresminimo and dfechaultimopago<>dfechapago then
    -- Tomar el interes minimo como interes normal
    finteres := finteresminimo;
    fmoratorio := 0;
  end if;

  if saplicaiva='S' then
    fiva := round( (finteres+fmoratorio)*gIVA , 2);
  else
    if (finteres+fmoratorio)<finteresminimo and dfechaultimopago<>dfechapago then
      -- Tomar el interes minimo como interes normal
      finteres := finteresminimo;
      fmoratorio := 0;
      fiva:=0;
    end if;
  end if;


  ftotal := round(fcapital + finteres + fmoratorio + fiva, 2);

  idiasint := dfechapago - dfechaultimopago;

  if dfechaultimopago=dfecha_otorga then
    --
    -- Para el caso de la 1era amortizacion agregar un dia de interes
    --
    if gcobrardiainicial=1 then
      idiasint := idiasint + 1;
    end if;
    --raise exception ' % %  %',dfechaultimopago,dfecha_otorga,idiasint;
  end if;

  if idiasint<0 then
    idiasint := 0;
  end if;

  r.prestamoid   := lprestamoid;
  r.saldoprestamo:= fsaldoinsoluto;
  r.amortizacion := round(famortizacion,2);
  r.vencidas     := fvencidas;
  r.diasint      := idiasint;
  r.capital      := round(fcapital,2);
  r.interes      := round(finteres,2);
  r.moratorio    := round(fmoratorio,2);
  r.iva          := round(fiva,2);
  r.total        := round(ftotal,2);

  return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscalculopagods(integer, date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: cargoprestamo; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE cargoprestamo (
    cargoprestamoid integer NOT NULL,
    tipoprestamoid character(3) NOT NULL,
    cuentaid character(24) NOT NULL,
    descripcioncargo character varying(50) NOT NULL,
    tipocargo integer DEFAULT 0 NOT NULL,
    poramortizacion integer DEFAULT 0 NOT NULL,
    apertura integer DEFAULT 0 NOT NULL,
    rangoinicial numeric DEFAULT 0 NOT NULL,
    rangofinal numeric DEFAULT 0 NOT NULL,
    porcentaje numeric DEFAULT 0 NOT NULL,
    montocargo numeric DEFAULT 0 NOT NULL,
    aplicaiva integer DEFAULT 0,
    calculoporfuncion integer DEFAULT 0,
    funcion character varying(50),
    cuentaiva character(24)
);


ALTER TABLE sucursal1.cargoprestamo OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spscargoprestamo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscargoprestamo(integer) RETURNS SETOF sucursal1.cargoprestamo
    AS $_$
declare

r cargoprestamo%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from cargoprestamo where cargoprestamoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select * from cargoprestamo order by cargoprestamoid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscargoprestamo(integer) OWNER TO sistema;

--
-- Name: spscarterac(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscarterac(integer, integer) RETURNS SETOF carterac
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo alias for $2;
  r carterac%rowtype;
  f record;
  dblink1 text;
  dblink2 text;
 
begin

for f in
 select * from sucursales where vigente='S'
 loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
        dblink2:='select clavefinalidad,tipoprestamoid,diasvencidos,saldoprestamo from '||f.esquema||'.precorte where ejercicio='||to_char(pejercicio,'9999')||' and periodo='||to_char(pperiodo,'99');
       
        for r in
        SELECT * FROM
        dblink(dblink1,dblink2) as
        t2(clavefinalidad   char(3),
        tipoprestamoid   char(3),
        diasvencidos     int4,
        saldoprestamo numeric)

        loop
           return next r;
        end loop;

 end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscarterac(integer, integer) OWNER TO sistema;

--
-- Name: spscarteracomunidad(character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscarteracomunidad(character, character, date) RETURNS SETOF rcarteracomunidad
    AS $_$
declare  
  r rcarteracomunidad%rowtype;
  psocioi alias for $1;
  psociof alias for $2;
  pfechac alias for $3;

  diasatraso int;

begin

  diasatraso:=0;

    for r in
                 --  select p.prestamoid,s.socioid,s.clavesocioint, p.referenciaprestamo,p.tipoprestamoid,
                 --   su.nombre||' '||su.paterno||' '||su.materno as nombre,


 select  s.tiposocioid,p.prestamoid,s.socioid,s.sujetoid,s.clavesocioint,p.referenciaprestamo,p.tipoprestamoid,
         su.nombre,su.paterno,su.materno,

         --substr(d.calle||' '||d.numero_ext||' '||d.colonia,1,80) as direccion,
          d.calle, d.numero_ext, d.numero_int, c.nombrecolonia, cd.nombreciudadmex, e.nombreestadomex, 
        d.teldomicilio as telefono, d.comunidad, d.codpostal, su.rfc, su.curp, si.sexo,0 as totalingresos, si.ocupacion,fi.descripcionfinalidad,
         p.fecha_otorga, p.fecha_vencimiento, p.fechaultimopago,su.fecha_nacimiento,fechaalta as fecha_de_ingreso,(p.fecha_vencimiento-pfechac)/30 as mesesavencer,p.montoprestamo,
	 p.saldoprestamo,0 as cantidadpagada, diasatrasocapital(p.prestamoid, pfechac) AS diasatrasoprestamo,trunc (p.montoprestamo / p.numero_de_amor) as amortizacionprestamo
from prestamos p, socio s, sujeto su, domicilio d, solicitudingreso si, finalidades fi, colonia c, ciudadesmex cd, estadosmex e
--, solicitudprestamo sp
   where p.saldoprestamo > 0 and
         p.fecha_otorga<=pfechac and
	 s.socioid = p.socioid and
         s.clavesocioint>=psocioi and s.clavesocioint<=psociof and
         su.sujetoid = s.sujetoid and
         d.sujetoid=s.sujetoid and
         si.sujetoid=s.sujetoid and
         --sp.sujetoid=s.sujetoid and
         p.claveestadocredito <> '008' and 
         p.clavefinalidad=fi.clavefinalidad and
         d.coloniaid = c.coloniaid and
         d.ciudadmexid = cd.ciudadmexid and
         cd.estadomexid = e.estadomexid
   order by s.clavesocioint
    loop
      select saldoprestamo,capital,interes,moratorio,iva,round(capital/r.amortizacion,2) from spscalculopagods(r.prestamoid,pfechac) into r.saldoprest,r.capital,r.interes,r.moratorio,r.iva,r.vencidas;

      select  saldomov from saldomov(r.socioid,'AA',pfechac) into r.ahorro;
      select  saldomov from saldomov(r.socioid,'AG',pfechac) into r.ahorro_reci;

      r.cantidadpagada:=r.montoprestamo-r.saldoprest;

      select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombreaval,
d.calle, d.numero_ext, d.numero_int, c.nombrecolonia, d.comunidad, cd.nombreciudadmex, e.nombreestadomex, d.teldomicilio
into r.caval1,r.nombreaval1,r.calleaval1, r.numeroextaval1, r.numerointaval1, r.coloniaaval1, r.comunidadaval1, r.ciudadaval1, r.estadoaval1, r.telefonoaval1
from socio s, sujeto su, avales av, domicilio d, colonia c, ciudadesmex cd, estadosmex e
where av.prestamoid=r.prestamoid and noaval=1 and av.socioid=s.socioid and av.sujetoid=su.sujetoid 
and su.sujetoid=d.sujetoid and d.coloniaid = c.coloniaid and d.ciudadmexid = cd.ciudadmexid and cd.estadomexid = e.estadomexid;

select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombreaval,
d.calle, d.numero_ext, d.numero_int, c.nombrecolonia, d.comunidad, cd.nombreciudadmex, e.nombreestadomex, d.teldomicilio
into r.caval2,r.nombreaval2,r.calleaval2, r.numeroextaval2, r.numerointaval2, r.coloniaaval2, r.comunidadaval2, r.ciudadaval2, r.estadoaval2, r.telefonoaval2
from socio s, sujeto su, avales av, domicilio d, colonia c, ciudadesmex cd, estadosmex e
where av.prestamoid=r.prestamoid and noaval=2 and av.socioid=s.socioid and av.sujetoid=su.sujetoid 
and su.sujetoid=d.sujetoid and d.coloniaid = c.coloniaid and d.ciudadmexid = cd.ciudadmexid and cd.estadomexid = e.estadomexid;

select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombreaval,
d.calle, d.numero_ext, d.numero_int, c.nombrecolonia, d.comunidad, cd.nombreciudadmex, e.nombreestadomex, d.teldomicilio
into r.caval3,r.nombreaval3,r.calleaval3, r.numeroextaval3, r.numerointaval3, r.coloniaaval3, r.comunidadaval3, r.ciudadaval3, r.estadoaval3, r.telefonoaval3
from socio s, sujeto su, avales av, domicilio d, colonia c, ciudadesmex cd, estadosmex e
where av.prestamoid=r.prestamoid and noaval=3 and av.socioid=s.socioid and av.sujetoid=su.sujetoid 
and su.sujetoid=d.sujetoid and d.coloniaid = c.coloniaid and d.ciudadmexid = cd.ciudadmexid and cd.estadomexid = e.estadomexid;
      

  select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombreaval,
d.calle, d.numero_ext, d.numero_int, c.nombrecolonia, d.comunidad, cd.nombreciudadmex, e.nombreestadomex, d.teldomicilio
into r.caval4,r.nombreaval4,r.calleaval4, r.numeroextaval4, r.numerointaval4, r.coloniaaval4, r.comunidadaval4, r.ciudadaval4, r.estadoaval4, r.telefonoaval4
from socio s, sujeto su, avales av, domicilio d, colonia c, ciudadesmex cd, estadosmex e
where av.prestamoid=r.prestamoid and noaval=4 and av.socioid=s.socioid and av.sujetoid=su.sujetoid 
and su.sujetoid=d.sujetoid and d.coloniaid = c.coloniaid and d.ciudadmexid = cd.ciudadmexid and cd.estadomexid = e.estadomexid;


      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscarteracomunidad(character, character, date) OWNER TO sistema;

--
-- Name: spscarteracomunidad(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscarteracomunidad(date) RETURNS integer
    AS $_$
declare  

  pfechac alias for $1;
  r record; 
  rsaldoprest numeric;
  rcapital             numeric;
  rcantidadpagada      numeric;
  rinteres             numeric;
  rmoratorio           numeric;
  riva                 numeric;
  rvencidas            numeric;
  rfechaultimopago     date;
  rdiasatraso          integer;
  rcaval1              char(15);
  rnombreaval1         varchar(80);
  rdireccionaval1      varchar(130);
  rcaval2              char(15);
  rnombreaval2         varchar(80);
  rdireccionaval2      varchar(130);
  rcaval3              char(15);
  rnombreaval3         varchar(80);
  rdireccionaval3      varchar(130);
  rcaval4              char(15);
  rnombreaval4         varchar(80);
  rdireccionaval4      varchar(130);

begin

  delete from carteracomunidadfecha where fechadegeneracion=pfechac;

  insert into carteracomunidadfecha (fechadegeneracion,prestamoid,clavesocioint,grupo,referenciaprestamo, tipoprestamo, nombre, direccion,colonia, telefono, comunidad, rfc, curp, sexo, totalingresos, ocupacion, finalidaddefault,finalidadcredito, fecha_otorga, fecha_vencimiento, fecha_ultimopago, fecha_nacimiento, mesesavencer, montoprestamo, saldoprest, cantidadpagada, diasatraso, amortizacion,promotorid)

  select pfechac,p.prestamoid,s.clavesocioint, si.grupo,p.referenciaprestamo,p.tipoprestamoid,su.nombre||' '||su.paterno||' '||su.materno,substr(d.calle||' '||d.numero_ext,1,80),d.colonia,d.teldomicilio , d.comunidad, su.rfc, su.curp, (case when si.sexo=0 then 'MA' else 'FE' end) , 0 as totalingresos, si.ocupacion, (select descripcionfinalidad from finalidades where clavefinalidad in (select clavefinalidad from tipoprestamo where tipoprestamoid = p.tipoprestamoid)), fi.descripcionfinalidad, p.fecha_otorga, p.fecha_vencimiento, p.fechaultimopago,su.fecha_nacimiento,(p.fecha_vencimiento-pfechac)/30,p.montoprestamo, p.saldoprestamo,0 as cantidadpagada, 0 AS diasatrasoprestamo, 0 as amortizacionprestamo,s.promotorid 
from prestamos p, socio s, sujeto su, domicilio d, solicitudingreso si, finalidades fi
where p.saldoprestamo > 0 and p.claveestadocredito <> '008' and
         p.fecha_otorga<=pfechac and
	 p.socioid = s.socioid and
         s.socioid = si.socioid and
         s.sujetoid = su.sujetoid and
         su.sujetoid= d.sujetoid and        
         p.clavefinalidad=fi.clavefinalidad order by p.prestamoid;

   for r in select prestamoid,montoprestamo from carteracomunidadfecha where fechadegeneracion=pfechac

   loop 

      select saldoprestamo,capital,interes,moratorio,iva,vencidas,fechaultimopago,diasint from spscalculopagocartera(r.prestamoid,pfechac) into rsaldoprest,rcapital,rinteres,rmoratorio,riva,rvencidas,rfechaultimopago,rdiasatraso;

      rcantidadpagada:=r.montoprestamo-rsaldoprest;

      select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombreaval,substring(rtrim(d.calle)||' '||rtrim(d.numero_ext)||' '||rtrim(d.comunidad)||' Tel: '||rtrim(d.teldomicilio),1,130) as direccionaval  into rcaval1,rnombreaval1,rdireccionaval1 from socio s, sujeto su, avales av, domicilio d where av.prestamoid=r.prestamoid and noaval=1 and av.socioid=s.socioid and av.sujetoid=su.sujetoid and su.sujetoid=d.sujetoid;

      select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombreaval,substring(rtrim(d.calle)||' '||rtrim(d.numero_ext)||' '||rtrim(d.comunidad)||' Tel: '||rtrim(d.teldomicilio),1,130) as direccionaval  into rcaval2,rnombreaval2,rdireccionaval2 from socio s, sujeto su, avales av,domicilio d where av.prestamoid=r.prestamoid and noaval=2 and av.socioid=s.socioid and av.sujetoid=su.sujetoid and su.sujetoid=d.sujetoid;

      select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombreaval,substring(rtrim(d.calle)||' '||rtrim(d.numero_ext)||' '||rtrim(d.comunidad)||' Tel: '||rtrim(d.teldomicilio),1,130) as direccionaval  into rcaval3,rnombreaval3,rdireccionaval3 from socio s, sujeto su, avales av,domicilio d where av.prestamoid=r.prestamoid and noaval=3 and av.socioid=s.socioid and av.sujetoid=su.sujetoid and su.sujetoid=d.sujetoid;

      select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombreaval,substring(rtrim(d.calle)||' '||rtrim(d.numero_ext)||' '||rtrim(d.comunidad)||' Tel: '||rtrim(d.teldomicilio),1,130) as direccionaval  into rcaval4,rnombreaval4,rdireccionaval4 from socio s, sujeto su, avales av,domicilio d where av.prestamoid=r.prestamoid and noaval=4 and av.socioid=s.socioid and av.sujetoid=su.sujetoid and su.sujetoid=d.sujetoid;

      update carteracomunidadfecha set saldoprest=rsaldoprest,capital=rcapital,interes=rinteres,moratorio=rmoratorio,iva=riva,vencidas=rvencidas,fecha_ultimopago=rfechaultimopago,diasatraso=rdiasatraso,caval1=rcaval1,caval2=rcaval2,caval3=rcaval3,caval4=rcaval4,nombreaval1=rnombreaval1,nombreaval2=rnombreaval2,nombreaval3=rnombreaval3,nombreaval4=rnombreaval4,direccionaval1=rdireccionaval1,direccionaval2=rdireccionaval2,direccionaval3=rdireccionaval3,direccionaval4=rdireccionaval4 where prestamoid=r.prestamoid and fechadegeneracion=pfechac;

      raise notice ' Procesando % ',r.prestamoid;

    end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscarteracomunidad(date) OWNER TO sistema;

--
-- Name: spscarteracomunidadc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscarteracomunidadc(date) RETURNS integer
    AS $_$
declare
  pfecha alias for $1;

  f record;
  dblink1 text;
  dblink2 text;
  icartera integer;


begin

for f in
 select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
        dblink2:='set search_path to public,'||f.esquema||';select * from spscarteracomunidad('||''''||pfecha||''''||');' ;

--        raise notice 'dblink % % ',dblink1,dblink2;
        
        SELECT cartera into icartera FROM
        dblink(dblink1,dblink2) as t2(cartera int4) ;

 end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscarteracomunidadc(date) OWNER TO sistema;

--
-- Name: spscarteraxfinalidad(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscarteraxfinalidad(date) RETURNS SETOF cartera
    AS $_$
declare
  r cartera%rowtype;
  pfechacorte alias for $1;

begin

    for r in
select f.descripcionfinalidad,'  ' as desctipoprestamo,sum(p.saldoprestamo),
       sum(case when p.diasvencidos=0
                then p.saldoprestamo else 0 end) as menor30,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo else 0 end) as dias1_7,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo else 0 end) as dias8_30,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo else 0 end) as dias31_60,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo else 0 end) as dias61_90,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo else 0 end) as dias91_120,
       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.saldoprestamo else 0 end) as dias121_180,
       sum(case when p.diasvencidos>180
                then p.saldoprestamo else 0 end) as mayor180
  from precorte p, finalidades f
 where p.fechacierre=pfechacorte and
       f.clavefinalidad = p.clavefinalidad
group by f.descripcionfinalidad
order by f.descripcionfinalidad

    loop      
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscarteraxfinalidad(date) OWNER TO sistema;

--
-- Name: spscarteraxtipo(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscarteraxtipo(date) RETURNS SETOF cartera
    AS $_$
declare
  r cartera%rowtype;
  pfechacorte alias for $1;

  ltotal        numeric;
  lmenor30      numeric;
  ldias1_7      numeric;
  ldias8_30     numeric;
  ldias31_60    numeric;
  ldias61_90    numeric;
  ldias91_120   numeric;
  ldias121_180  numeric;
  lmayor180     numeric;

begin

    ltotal := 0;
    lmenor30 := 0;
    ldias1_7 := 0;
    ldias8_30 := 0;
    ldias31_60 := 0;
    ldias61_90 := 0;
    ldias91_120 := 0;
    ldias121_180 := 0;
    lmayor180 := 0;

    for r in
select f.descripcionfinalidad,t.desctipoprestamo,sum(p.saldoprestamo),
       sum(case when p.diasvencidos=0
                then p.saldoprestamo else 0 end) as menor30,

       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo else 0 end) as dias1_7,

       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo else 0 end) as dias8_30,

       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo else 0 end) as dias31_60,

       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo else 0 end) as dias61_90,

       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo else 0 end) as dias91_120,

       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.saldoprestamo else 0 end) as dias121_180,
       sum(case when p.diasvencidos>180
                then p.saldoprestamo else 0 end) as mayor180
  from precorte p, finalidades f, tipoprestamo t
 where p.fechacierre=pfechacorte and
       f.clavefinalidad = p.clavefinalidad and
       t.tipoprestamoid = p.tipoprestamoid
group by f.descripcionfinalidad,t.desctipoprestamo  
order by f.descripcionfinalidad,t.desctipoprestamo

    loop

      ltotal       := ltotal     + r.total;
      lmenor30     := lmenor30   + r.menor30;
      ldias1_7     := ldias1_7   + r.dias1_7;
      ldias8_30    := ldias8_30  + r.dias8_30;
      ldias31_60   := ldias31_60 + r.dias31_60;
      ldias61_90   := ldias61_90 + r.dias61_90;
      ldias91_120  := ldias91_120 + r.dias91_120;
      ldias121_180 := ldias121_180 + r.dias121_180;
      lmayor180    := lmayor180  + r.mayor180;

      return next r;
    end loop;

    r.descripcionfinalidad := ' ';
    r.desctipoprestamo := 'TOTALES ....';
    r.total      := ltotal     ;
    r.menor30    := lmenor30   ;
    r.dias1_7    := ldias1_7   ;
    r.dias8_30   := ldias8_30  ;
    r.dias31_60  := ldias31_60 ;
    r.dias61_90  := ldias61_90 ;
    r.dias91_120 := ldias91_120;
    r.dias121_180 := ldias121_180;
    r.mayor180   := lmayor180  ;
  
    return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscarteraxtipo(date) OWNER TO sistema;

--
-- Name: spscarteraxtipoc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscarteraxtipoc(date) RETURNS SETOF cartera
    AS $_$
declare
  pfechacorte alias for $1;
  r cartera%rowtype;

  ltotal numeric;
  lmenor30      numeric;
  ldias1_7      numeric;
  ldias8_30     numeric;
  ldias31_60    numeric;
  ldias61_90    numeric;
  ldias91_120   numeric;
  ldias121_180  numeric;
  lmayor180     numeric;

  iejercicio int4;
  iperiodo int4;

begin

  iejercicio := cast(date_part('year',pfechacorte) as int);
  iperiodo := cast(date_part('month',pfechacorte) as int);

    ltotal := 0;
    lmenor30 := 0;
    ldias1_7 := 0;
    ldias8_30 := 0;
    ldias31_60 := 0;
    ldias61_90 := 0;
    ldias91_120 := 0;
    ldias121_180 := 0;
    lmayor180 := 0;

    for r in
select f.descripcionfinalidad,t.desctipoprestamo,sum(p.saldoprestamo),
       sum(case when p.diasvencidos=0
                then p.saldoprestamo else 0 end) as menor30,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.saldoprestamo else 0 end) as dias1_7,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.saldoprestamo else 0 end) as dias8_30,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.saldoprestamo else 0 end) as dias31_60,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.saldoprestamo else 0 end) as dias61_90,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.saldoprestamo else 0 end) as dias91_120,
       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.saldoprestamo else 0 end) as dias121_180,
       sum(case when p.diasvencidos>180
                then p.saldoprestamo else 0 end) as mayor180
  from spscarterac(iejercicio,iperiodo) p, finalidades f, tipoprestamo t
 where f.clavefinalidad = p.clavefinalidad and
       t.tipoprestamoid = p.tipoprestamoid
group by f.descripcionfinalidad,t.desctipoprestamo  
order by f.descripcionfinalidad,t.desctipoprestamo

    loop

      ltotal      := ltotal     +r.total;
      lmenor30     := lmenor30   + r.menor30;
      ldias1_7     := ldias1_7   + r.dias1_7;
      ldias8_30    := ldias8_30  + r.dias8_30;
      ldias31_60   := ldias31_60 + r.dias31_60;
      ldias61_90   := ldias61_90 + r.dias61_90;
      ldias91_120  := ldias91_120 + r.dias91_120;
      ldias121_180 := ldias121_180 + r.dias121_180;
      lmayor180    := lmayor180  + r.mayor180;

      return next r;
    end loop;

    r.descripcionfinalidad := ' ';
    r.desctipoprestamo := 'TOTALES ....';
    r.total      := ltotal     ;
    r.menor30    := lmenor30   ;
    r.dias1_7    := ldias1_7   ;
    r.dias8_30   := ldias8_30  ;
    r.dias31_60  := ldias31_60 ;
    r.dias61_90  := ldias61_90 ;
    r.dias91_120 := ldias91_120;
    r.dias121_180 := ldias121_180;
    r.mayor180   := lmayor180  ;
  
    return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscarteraxtipoc(date) OWNER TO sistema;

--
-- Name: spscatalogo_ctas(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscatalogo_ctas(character) RETURNS SETOF sucursal1.catalogo_ctas
    AS $_$
declare
  r catalogo_ctas%rowtype;
  pclave alias for $1;
begin

  if pclave<>'                        ' then
    for r in
      SELECT cuentaid,cat_cuentaid,identificacion,cuentanombre,tipo_cta,estado_cta,
             fecha_estado,fecha_ult_mov,naturaleza,digito_agrupador,
             saldo_inic_ejer,cargos_acum_ejer,abonos_acum_ejer
        FROM catalogo_ctas
       WHERE cuentaid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      SELECT cuentaid,cat_cuentaid,identificacion,cuentanombre,tipo_cta,estado_cta,
             fecha_estado,fecha_ult_mov,naturaleza,digito_agrupador,
             saldo_inic_ejer,cargos_acum_ejer,abonos_acum_ejer
        FROM catalogo_ctas
      ORDER BY cuentaid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscatalogo_ctas(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: ciudadesmex; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE ciudadesmex (
    ciudadmexid integer NOT NULL,
    estadomexid integer NOT NULL,
    claveciudadmex character(4),
    nombreciudadmex character(50),
    claveconapo character(10)
);


ALTER TABLE sucursal1.ciudadesmex OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsciudadmex(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsciudadmex(integer) RETURNS SETOF sucursal1.ciudadesmex
    AS $_$
declare
  r ciudadesmex%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select ciudadmexid,estadomexid,claveciudadmex,nombreciudadmex from ciudadesmex where ciudadmexid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select ciudadmexid,estadomexid,claveciudadmex,nombreciudadmex from ciudadesmex order by ciudadmexid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsciudadmex(integer) OWNER TO sistema;

--
-- Name: spsciudadxedo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsciudadxedo(integer) RETURNS SETOF sucursal1.ciudadesmex
    AS $_$
declare
  r ciudadesmex%rowtype;
  pclave alias for $1;
begin

  for r in
    select *
      from ciudadesmex
     where estadomexid=pclave
   order by nombreciudadmex
  loop
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsciudadxedo(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: clasificacioncredito; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE clasificacioncredito (
    clasificacioncreditoid integer NOT NULL,
    descripcion character(30)
);


ALTER TABLE sucursal1.clasificacioncredito OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsclasificacioncredito(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsclasificacioncredito(integer) RETURNS SETOF sucursal1.clasificacioncredito
    AS $_$
declare
  r clasificacioncredito%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select clasificacioncreditoid,descripcion
        from clasificacioncredito
       where clasificacioncreditoid=pclave

    loop
      return next r;
    end loop;
  else
   for r in
     select clasificacioncreditoid,descripcion
       from clasificacioncredito
   order by clasificacioncreditoid   
     loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsclasificacioncredito(integer) OWNER TO sistema;

--
-- Name: clasificacionsocio; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE clasificacionsocio (
    clasificacionsocioid integer NOT NULL,
    descripcion character(30) NOT NULL
);


ALTER TABLE public.clasificacionsocio OWNER TO sistema;

--
-- Name: spsclasificacionsocio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsclasificacionsocio(integer) RETURNS SETOF clasificacionsocio
    AS $_$
declare
  r clasificacionsocio%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select clasificacionsocioid,descripcion from clasificacionsocio where clasificacionsocioid=pclave

    loop
      return next r;
    end loop;
  else
   for r in
   select clasificacionsocioid,descripcion from clasificacionsocio order by clasificacionsocioid   
     loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsclasificacionsocio(integer) OWNER TO sistema;

--
-- Name: spscobradormensaje(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscobradormensaje(text) RETURNS SETOF tcobrador
    AS $_$
declare
  pfiltro alias for $1; 
  r tcobrador%rowtype;
  filtro text;
begin
    filtro := pfiltro || '%';
    for r in
      select c.cobradorid,j.sujetoid,j.paterno,j.materno,j.nombre,j.razonsocial
        from cobradores c, sujeto j
       where j.sujetoid = c.sujetoid and         
             (j.sujetoid like filtro or
              (j.nombre||' '||j.paterno||' '||j.materno) like filtro or
              (j.paterno||' '||j.materno||' '||j.nombre) like filtro or
	      j.razonsocial like filtro)
      order by j.sujetoid
    loop
      return next r;
    end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscobradormensaje(text) OWNER TO sistema;

--
-- Name: spscobranzaesperada(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscobranzaesperada(date, date) RETURNS SETOF rcobranzaesperada
    AS $_$
declare
  r rcobranzaesperada%rowtype;
  pfechai alias for $1;
  pfechaf alias for $2;
begin


    for r in
select p.prestamoid,
      s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombre,
      b.referenciaprestamo,
      b.fechadepago
   from socio s, sujeto su, prestamos p, 
(select p.prestamoid, p.referenciaprestamo, max(a.fechadepago) as fechadepago
  from prestamos p, amortizaciones a
 where p.claveestadocredito<>'008' and
       p.saldoprestamo>0 and
       a.prestamoid = p.prestamoid and
       a.fechadepago between pfechai and pfechaf
group by p.prestamoid, p.referenciaprestamo  
order by fechadepago ) as b
where p.prestamoid = b.prestamoid and
      s.socioid = p.socioid and
      su.sujetoid = s.sujetoid  
order by b.fechadepago, s.clavesocioint 
    loop

      select amortizacion,vencidas,diasint,capital,interes,moratorio,iva,total
        into r.amortizacion,r.vencidas,r.diasint,r.capital,r.interes,r.moratorio,r.iva,r.total
        from spscalculopagod(r.prestamoid,r.fechadepago);

      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscobranzaesperada(date, date) OWNER TO sistema;

--
-- Name: spscobropagosr(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscobropagosr(date, date) RETURNS SETOF rreportepagoscobros
    AS $_$
declare
	r rreportepagoscobros%rowtype;
	pfechai alias for $1;
  	pfechaf alias for $2;
begin
	    for r in
			select 	substring((s.clavesocioint),1,4) as suc, 
					s.clavesocioint,
					su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
					p.fechapoliza as fechamvto,
					p.polizaid,
					m.debe as deposito,
					m.haber as retiro,
					t.tipomovimientoid as t_mvto,
					t.desctipomovimiento,
					p.seriepoliza as s_pol, 
					pa.usuarioid
			from 	parametros pa, 
					movicaja mc, 
					polizas p, 
					movipolizas m,
					tipomovimiento t,
					socio s, 
					sujeto su 
			where 	pa.serie_user=mc.seriecaja and 
					su.sujetoid=s.sujetoid and 
					s.clavesocioint = s.clavesocioint and 
					mc.socioid = s.socioid and 
					p.polizaid = mc.polizaid and 
					m.movipolizaid = mc.movipolizaid and 
					t.tipomovimientoid =mc.tipomovimientoid and 
					t.tipomovimientoid in ('EV','EI','RG','LE','TE','SA','AT','SM','SI','SQ','SB','ST','OP','EN','RN') and 
					p.seriepoliza !='ZA' and 
					p.seriepoliza !='Z'  and 
					p.seriepoliza !='WW' and 
					p.fechapoliza between pfechai and pfechaf and
					(m.debe > 0 or m.haber > 0)
			order by s.clavesocioint, p.fechapoliza
	    loop
			if( r.t_mvto = 'TE' ) then
					r.deposito = 0.00;
					select haber into r.deposito from movipolizas where polizaid=r.polizaid and cuentaid = '2305010403';
					raise notice 'Entre el if';
			end if;
      		return next r;
    	    end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spscobropagosr(date, date) OWNER TO sistema;

--
-- Name: spscobropagosrc(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscobropagosrc(date, date) RETURNS SETOF rreportepagoscobros
    AS $_$
declare
	r rreportepagoscobros%rowtype;
	pfechai alias for $1;
  	pfechaf alias for $2;
	f record;
  	dblink1 text;
  	dblink2 text;
begin
for f in
		select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||'; select * from spscobropagosr('||''''||pfechai||''''||','||''''||pfechaf||''''||');';

        for r in
           select * from
           dblink(dblink1,dblink2) as
           t2(suc character(4),
	clavesocioint character(16),
	nombresocio character varying(80),
	fechamvto date,
	polizaid integer,
	deposito numeric,
	retiro numeric,
	t_mvto character(2),
	desctipomovimiento character(30),
	s_pol character(30),
	usuarioid character(20))

        loop
              return next r;
        end loop;

end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spscobropagosrc(date, date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: colonia; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE colonia (
    coloniaid integer NOT NULL,
    ciudadmexid integer,
    nombrecolonia character(100),
    cp integer,
    tipoasentamientoid integer,
    claveconapo character(10)
);


ALTER TABLE sucursal1.colonia OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spscolonia(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscolonia(integer) RETURNS SETOF sucursal1.colonia
    AS $_$
declare
  r colonia%rowtype;
  pclave alias for $1;
  pciudadmexid int4;
begin

  if pclave<>0 then
    for r in
      select *
        from colonia where coloniaid=pclave
    loop
      return next r;
    end loop;
  else

    pciudadmexid:=pclave;
    if pclave=0 then
      select ciudadmexid
        into pciudadmexid
        from empresa where empresaid=1;
    end if;
    for r in
      select * from colonia
       where ciudadmexid=pciudadmexid
       order by nombrecolonia
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscolonia(integer) OWNER TO sistema;

--
-- Name: spscoloniacp(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscoloniacp(integer) RETURNS SETOF sucursal1.colonia
    AS $_$
declare
  r colonia%rowtype;
  pcp alias for $1;

begin

    for r in
      select *
        from colonia where cp=pcp
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscoloniacp(integer) OWNER TO sistema;

--
-- Name: spscolonias(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscolonias(integer) RETURNS SETOF sucursal1.colonia
    AS $_$
declare
  r colonia%rowtype;
  pclave alias for $1;
  pciudadmexid int4;
begin

  pciudadmexid:=pclave;
  if pclave=0 then
    select ciudadmexid
      into pciudadmexid
      from empresa where empresaid=1;
  end if;

  for r in
    select *
      from colonia
     where ciudadmexid=pciudadmexid
   order by nombrecolonia
  loop
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscolonias(integer) OWNER TO sistema;

--
-- Name: spscomisionescobradasr(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscomisionescobradasr(date, date) RETURNS SETOF rreportecomisionescob
    AS $_$
declare
	r rreportecomisionescob%rowtype;
	pfechai alias for $1;
  	pfechaf alias for $2;
begin
	    for r in
			select 	substring((s.clavesocioint),1,4) as suc, 
					s.clavesocioint,
					su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
					p.fechapoliza as fechamvto,
					p.polizaid,
					m.debe as monto,
					t.tipomovimientoid as t_mvto,
					t.desctipomovimiento,
					p.seriepoliza as s_pol, 
					pa.usuarioid,
					m.movipolizaid
			from 	parametros pa, 
					movicaja mc, 
					polizas p, 
					movipolizas m,
					tipomovimiento t,
					socio s, 
					sujeto su 
			where 	pa.serie_user=mc.seriecaja and 
					su.sujetoid=s.sujetoid and 
					s.clavesocioint = s.clavesocioint and 
					mc.socioid = s.socioid and 
					p.polizaid = mc.polizaid and 
					m.movipolizaid = mc.movipolizaid and 
					--m.polizaid = mc.polizaid and 
					t.tipomovimientoid =mc.tipomovimientoid and 
					t.tipomovimientoid in ('BU','CP','TE','RP') and 
					p.seriepoliza !='ZA' and 
					p.seriepoliza !='Z'  and 
					p.seriepoliza !='WW' and 
					p.fechapoliza between pfechai and pfechaf
			order by s.clavesocioint, p.fechapoliza
	    loop
			select haber into r.comision from movipolizas where polizaid=r.polizaid and (cuentaid LIKE '610108%' OR cuentaid LIKE '630102%');
			select haber into r.iva from movipolizas where polizaid=r.polizaid and cuentaid='2305090401';
      		return next r;
		end loop;
		
		for r in
			select  substring((s.clavesocioint),1,4) as suc, 
					s.clavesocioint,
					su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
					p.fechapoliza as fechamvto,
					p.polizaid,
					null as monto,
					'CREDILLANTAS' as t_mvto,
					'COMISION CREDILLANTAS' as desctipomovimiento,
					p.seriepoliza as s_pol,
					pa.usuarioid, 
					m.movipolizaid
			from 	parametros pa,
					movipolizas m, 
					polizas p,
					prestamos pr,
					socio s,
					sujeto su
			where 	pa.serie_user=p.seriepoliza and 
					pr.prestamoid = m.prestamoid and
					s.socioid = pr.socioid and
					su.sujetoid = s.sujetoid and
					m.polizaid = p.polizaid and
					m.cuentaid='6101080304'
		loop
			select haber into r.comision from movipolizas where polizaid=r.polizaid and cuentaid = '6101080304';
			select haber into r.iva from movipolizas where polizaid=r.polizaid and cuentaid ILIKE '230509%';
			select debe into r.monto from movipolizas where polizaid=r.polizaid and cuentaid = '13010203010115';
			return next r;
		end loop;
		
		for r in
			select  substring((s.clavesocioint),1,4) as suc, 
					s.clavesocioint,
					su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
					p.fechapoliza as fechamvto,
					p.polizaid,
					null as monto,
					'1 AL MILLAR' as t_mvto,
					m.descripcion as desctipomovimiento,
					p.seriepoliza as s_pol,
					pa.usuarioid, 
					m.movipolizaid
			from 	parametros pa,
					movipolizas m, 
					polizas p,
					prestamos pr,
					socio s,
					sujeto su
			where 	pa.serie_user=p.seriepoliza and 
					pr.prestamoid = m.prestamoid and
					s.socioid = pr.socioid and
					su.sujetoid = s.sujetoid and
					m.polizaid = p.polizaid and
					m.cuentaid='6101080601'
		loop
			select haber into r.comision from movipolizas where polizaid=r.polizaid and cuentaid = '6101080601';
			select haber into r.iva from movipolizas where polizaid=r.polizaid and cuentaid ILIKE '230509%';
			select debe into r.monto from movipolizas where polizaid=r.polizaid and cuentaid ILIKE '1301%';
			return next r;
		end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spscomisionescobradasr(date, date) OWNER TO sistema;

--
-- Name: spscomisionescobradasrc(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscomisionescobradasrc(date, date) RETURNS SETOF rreportecomisionescob
    AS $_$
declare
	r rreportecomisionescob%rowtype;
	pfechai alias for $1;
  	pfechaf alias for $2;
	f record;
  	dblink1 text;
  	dblink2 text;
begin
for f in
		select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||'; select * from spscomisionescobradasr('||''''||pfechai||''''||','||''''||pfechaf||''''||');';

        for r in
           select * from
           dblink(dblink1,dblink2) as
           t2(suc character(4),
	clavesocioint character(16),
	nombresocio character varying(80),
	fechamvto date,
	polizaid integer,
	monto numeric,
	t_mvto character(20),
	desctipomovimiento character(30),
	s_pol character(30),
	usuarioid character(20),
	comision numeric,
	iva numeric)

        loop
              return next r;
        end loop;

end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spscomisionescobradasrc(date, date) OWNER TO sistema;

--
-- Name: spscondonaciones(date, date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spscondonaciones(date, date, character, character) RETURNS SETOF tcondonaciones
    AS $_$
declare
  pfechai     alias for $1;
  pfechaf     alias for $2;
  psocioi     alias for $3;
  psociof     alias for $4;

  r tcondonaciones%rowtype;

  r1 record;
  fiva numeric;
  finterestotal numeric;  
  vtipomovimientoid character(2);
  saldomovimiento numeric;
begin
  select iva into fiva from empresa;

  for r in
      select '',
             p.seriepoliza,
      	     p.fechapoliza,
	     s.socioid,
	     s.clavesocioint,
	     su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
	     si.grupo,
	     pr.referenciaprestamo,
      	     pr.fecha_otorga,
      	     pr.montoprestamo,
	     pr.tipoprestamoid,
	     (case when (pfechaf-fechaultimapagada(pr.prestamoid,pfechaf))-(case when pr.dias_de_cobro > 0 then pr.dias_de_cobro else pr.meses_de_cobro*30 end) > 0 then (pfechaf-fechaultimapagada(pr.prestamoid,pfechaf))-(case when pr.dias_de_cobro > 0 then pr.dias_de_cobro else pr.meses_de_cobro*30 end) else 0 end) as diasmora,
       	     sum(case when m.cuentaid=t.cuentaactivo then m.haber else 0 end) as capital,
       	     sum(case when m.cuentaid=t.cuentaintnormal then m.haber else 0 end) as interes,
       	     sum(case when m.cuentaid=t.cuentaintmora then m.haber else 0 end) as moratorio,
     	     sum(case when m.cuentaid=t.cuentaiva then m.haber else 0 end) as iva,
	     sum(case when m.cuentaid=t.ordendeudornormalbonificado then m.haber else 0 end) as ordendeudornormalbonificado,
	     sum(case when m.cuentaid=t.ordenacredornormalbonificado then m.haber else 0 end) as ordenacredornormalbonificado,
	     sum(case when m.cuentaid=t.cuentaordeninteres then m.haber else 0 end) as ordeninteres,
	     sum(case when m.cuentaid=t.cuentaintmoranocobact then m.haber else 0 end) as intmoranocobact,
	     sum(case when m.cuentaid=t.cuentaintmoradevnocobres then m.haber else 0 end) as intmoradevnocobres,	     
	     --haberes
	     0,
	     --cobrado efectivo
	     0,
             pr.claveestadocredito
      from polizas p, movicaja mc, movipolizas m, prestamos pr, tipoprestamo t, socio s, sujeto su, solicitudingreso si
      where p.fechapoliza between pfechai and pfechaf 
      	    and mc.polizaid=p.polizaid
	    and mc.tipomovimientoid='00'
	    and m.polizaid = p.polizaid
	    and pr.prestamoid = mc.prestamoid
	    and t.tipoprestamoid = pr.tipoprestamoid
	    and s.socioid = mc.socioid
	    and s.clavesocioint>=psocioi
	    and s.clavesocioint<=psociof
	    and su.sujetoid = s.sujetoid
	    and s.socioid=si.socioid
      group by pr.usuarioid,
      	     p.fechapoliza,
	     s.clavesocioint,
	     su.nombre,
	     su.paterno,
	     su.materno,
	     si.grupo,
	     pr.referenciaprestamo,
      	     pr.fecha_otorga,
      	     pr.montoprestamo,
	     pr.tipoprestamoid,
	     pr.prestamoid,
	     pr.dias_de_cobro,
	     pr.meses_de_cobro,
	     s.socioid,
             p.seriepoliza,
             pr.claveestadocredito
      order by si.grupo,pr.tipoprestamoid,s.clavesocioint
  loop
       if r.claveestadocredito = '002' then
          r.diasmora := 0;
       end if;
      select usuarioid into r.usuarioid from usuarios natural join parametros where serie_user = r.seriepoliza;
    
    finterestotal:=r.interes+r.moratorio;

    for vtipomovimientoid in 
    select tipomovimientoid from tipomovimiento where aplicasaldo='S' loop
    	select coalesce(saldomov,0) into saldomovimiento from saldomov (r.socioid,vtipomovimientoid,pfechaf);
    	r.haberes := r.haberes + saldomovimiento;
    end loop;

    return next r;

  end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spscondonaciones(date, date, character, character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: sucursales; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE sucursales (
    sucursalid integer NOT NULL,
    host character(40),
    basededatos character(20),
    esquema character(20),
    usuariodb character(20),
    passworddb character(20),
    vigente character(1),
    importar character(1),
    sucid character(4),
    hostremoto character(40)
);


ALTER TABLE sucursal1.sucursales OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsconsolida(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsconsolida(integer) RETURNS SETOF sucursal1.sucursales
    AS $_$
declare
  r sucursales%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from sucursales where sucursalid=pclave
    loop
      return next r;
    end loop;
  else
    for r in
      select * from sucursales order by sucursalid   
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsconsolida(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: convenio; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE convenio (
    convenioid integer NOT NULL,
    prestamoid integer NOT NULL,
    fechaconvenio date NOT NULL,
    textoconvenio text,
    vigente character(1) DEFAULT 'S'::bpchar NOT NULL,
    usuarioid character(20),
    lugar integer DEFAULT 1,
    fechavigencia date,
    accion character(30),
    fechanegociar date,
    horanegociar character(5)
);


ALTER TABLE sucursal1.convenio OWNER TO sistema;

--
-- Name: COLUMN convenio.lugar; Type: COMMENT; Schema: sucursal1; Owner: sistema
--

COMMENT ON COLUMN convenio.lugar IS '1 Oficina 2 Visita';


SET search_path = public, pg_catalog;

--
-- Name: spsconvenio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsconvenio(integer) RETURNS SETOF sucursal1.convenio
    AS $_$
declare
  r convenio%rowtype;
  pconvenioid alias for $1;

begin

    -- Cambiar estatus a convenios anteriores
--    update convenio
--       set vigente='N'
--     where fechavigencia<current_date;

    for r in
      select convenioid,prestamoid,fechaconvenio,textoconvenio,vigente,usuarioid,lugar,fechavigencia,accion,fechanegociar,horanegociar
        from convenio
       where convenioid=pconvenioid
    loop
      return next r;
    end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsconvenio(integer) OWNER TO sistema;

--
-- Name: spsconveniop(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsconveniop(integer) RETURNS SETOF sucursal1.convenio
    AS $_$
declare
  r convenio%rowtype;
  pprestamoid alias for $1;

begin

    for r in
      select *
        from convenio
       where prestamoid=pprestamoid and vigente='S'

    loop
      return next r;
    end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsconveniop(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: depreciacion; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE depreciacion (
    depreciacionid integer NOT NULL,
    monedaid character(2) NOT NULL,
    depre_activo character(24) NOT NULL,
    depre_ctadepre character(24) NOT NULL,
    depre_ctagasto character(24) NOT NULL,
    depre_ctabaja character(24) NOT NULL,
    depredescripcion character varying(30),
    depretasacontable numeric NOT NULL,
    depretasafiscal numeric NOT NULL,
    maximodeducible numeric NOT NULL,
    depreporcentaje numeric NOT NULL
);


ALTER TABLE sucursal1.depreciacion OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsdepreciacion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsdepreciacion(integer) RETURNS SETOF sucursal1.depreciacion
    AS $_$
declare
  r depreciacion%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select depreciacionid,monedaid,depre_activo,depre_ctadepre,depre_ctagasto,depre_ctabaja,depredescripcion,depretasacontable,depretasafiscal,maximodeducible,depreporcentaje from depreciacion where depreciacionid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select depreciacionid,monedaid,depre_activo,depre_ctadepre,depre_ctagasto,depre_ctabaja,depredescripcion,depretasacontable,depretasafiscal,maximodeducible,depreporcentaje from depreciacion order by depreciacionid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsdepreciacion(integer) OWNER TO sistema;

--
-- Name: spsdocalculado(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsdocalculado(integer) RETURNS SETOF rsdocalculado
    AS $_$
declare
  lprestamoid alias for $1;
  r rsdocalculado%rowtype;

begin


    for r in
 select p.saldoprestamo, p.montoprestamo-sum(m.haber),p.claveestadocredito
  from prestamos p, tipoprestamo tp, movicaja mc, movipolizas m
 where p.prestamoid = lprestamoid and
       tp.tipoprestamoid = p.tipoprestamoid and
       mc.prestamoid = p.prestamoid and
       m.polizaid = mc.polizaid and
       m.cuentaid = tp.cuentaactivo
group by p.saldoprestamo,p.montoprestamo,p.claveestadocredito
   loop
     return next r;
   end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsdocalculado(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: domicilio; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE domicilio (
    domicilioid integer NOT NULL,
    ciudadmexid integer NOT NULL,
    sujetoid integer NOT NULL,
    calle character varying(30) NOT NULL,
    numero_ext character varying(15),
    numero_int character varying(15),
    colonia character varying(30),
    codpostal integer,
    comunidad character varying(50),
    teldomicilio character varying(20),
    coloniaid integer
);


ALTER TABLE sucursal1.domicilio OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsdomicilio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsdomicilio(integer) RETURNS SETOF sucursal1.domicilio
    AS $_$
declare
  r domicilio%rowtype;
  pclave alias for $1;

  scolonia char(30);
begin

  if pclave<>0 then
    for r in
      select domicilioid,ciudadmexid,sujetoid,calle,numero_ext,numero_int,
             colonia,codpostal,comunidad,teldomicilio,coloniaid
        from domicilio where domicilioid=pclave
    loop
      if r.coloniaid>0 then
        select substr(nombrecolonia,1,30)
          into scolonia
          from colonia
         where coloniaid=r.coloniaid;
        r.colonia := scolonia;
      end if;
      
      return next r;
    end loop;
  else
   for r in
      select domicilioid,ciudadmexid,sujetoid,calle,numero_ext,numero_int,colonia,
             codpostal,comunidad,teldomicilio,coloniaid
        from domicilio where domicilioid==pcclave
    loop
      if r.coloniaid>0 then
        select substr(nombrecolonia,1,30)
          into scolonia
          from colonia
         where coloniaid=r.coloniaid;
        r.colonia := scolonia;
      end if;
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsdomicilio(integer) OWNER TO sistema;

--
-- Name: spsdomiciliosujeto(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsdomiciliosujeto(integer) RETURNS SETOF sucursal1.domicilio
    AS $_$
declare
  r domicilio%rowtype;
  pclave alias for $1;

  scolonia char(30);
begin

    for r in
      select domicilioid,ciudadmexid,sujetoid,calle,numero_ext,numero_int,colonia,
             codpostal,comunidad,teldomicilio,coloniaid
        from domicilio where sujetoid=pclave
    loop
      if r.coloniaid>0 then
        select substr(nombrecolonia,1,30)
          into scolonia
          from colonia
         where coloniaid=r.coloniaid;
        r.colonia := scolonia;
      end if;

      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsdomiciliosujeto(integer) OWNER TO sistema;

--
-- Name: spsdomovsocios(date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsdomovsocios(date, character) RETURNS SETOF sdomovsocio
    AS $_$
declare
  pfecha alias for $1;
  ptipomovimientoid alias for $2;
  r sdomovsocio%rowtype;
  
begin

    for r in

select (case when instr(s.clavesocioint,'M')>0 then 0 else 1 end),
       s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
       max(p.fechapoliza), sum(mp.debe-mp.haber)
  from movicaja m, polizas p, movipolizas mp, socio s, sujeto su, tipomovimiento tm
 where m.tipomovimientoid=ptipomovimientoid and
       p.polizaid = m.polizaid and
       p.fechapoliza<=pfecha and
       tm.tipomovimientoid=m.tipomovimientoid and
--       mp.polizaid=p.polizaid and
--       mp.cuentaid=tm.cuentadeposito and
       mp.movipolizaid=m.movipolizaid and
       s.socioid=m.socioid and
       su.sujetoid=s.sujetoid
group by s.clavesocioint,su.nombre,su.paterno,su.materno
order by (case when instr(s.clavesocioint,'M')>0 then 0 else 1 end),
         s.clavesocioint

    loop

      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsdomovsocios(date, character) OWNER TO sistema;

--
-- Name: spsefectivocaja(date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsefectivocaja(date, character) RETURNS SETOF tsabana
    AS $_$
declare
  r tsabana%rowtype;
  pfecha alias for $1;
  pserie alias for $2;
begin

  for r in
    select d.descripciondenominacion,
           sum((case when s.entradasalida=0
                     then s.cantidad else -1*s.cantidad end)) as cantidad,
           sum((case when s.entradasalida=0
                     then s.valor else -1*s.valor end)) as valor
      from sabana s, denominacion d
     where s.fecha=pfecha and
           (pserie='  ' or s.seriecaja=pserie) and
           d.denominacionid=s.denominacionid
     group by d.descripciondenominacion
    loop
      return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsefectivocaja(date, character) OWNER TO sistema;

--
-- Name: spsestadisticoctas(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsestadisticoctas(date) RETURNS SETOF restadisticoctas
    AS $_$
declare  
  pfecha alias for $1;
  r restadisticoctas%rowtype;

  ptipomb char(3);
  lnosocios int4;
  lsocios int4;
  lgsocios int4;
  fsubtotal numeric;
  ftotal numeric;
  fsaldomov numeric;
  psaldotipomb numeric;

begin

  fsubtotal := 0;
  ftotal := 0;
  lsocios := 0;
  lgsocios := 0;

  for r in
select t.tipomovimientoid,t.desctipomovimiento,0 as nosocios,
       0 as saldo
  from tipomovimiento t
 where t.aplicasaldo='S' and
       t.tipomovimientoid<>'99' and
       t.tipomovimientoid<>'IN'     
group by t.tipomovimientoid,t.desctipomovimiento
order by t.tipomovimientoid      
    loop

      select count(socioid),sum(saldomovimiento) into lnosocios,fsaldomov from spssociosxtipomovimiento(r.tipo,pfecha);

      r.saldo    := fsaldomov;
      r.nosocios := lnosocios;
      r.ordenmov := 'A';
      fsubtotal := fsubtotal + r.saldo;
      lsocios := lsocios + lnosocios;
      return next r;
    end loop;


    fsubtotal := 0;
    lsocios:=0;

   for r in
    
   select pr.tipoprestamoid,t.desctipoprestamo,count(distinct pr.socioid) as nosocios,
         sum(mp.debe-mp.haber) 
         from tipoprestamo t, polizas p, movipolizas mp, prestamos pr, movicaja m
            where m.prestamoid=pr.prestamoid and
            pr.tipoprestamoid=t.tipoprestamoid and 
            m.polizaid = p.polizaid and 
            p.fechapoliza<pfecha+1 and
            m.polizaid=mp.polizaid and
            mp.cuentaid=t.cuentaactivo
            group by pr.tipoprestamoid, t.desctipoprestamo

    loop
--      select count(distinct pr.socioid)
--        into lnosocios
--        from prestamos pr
--       where pr.fecha_otorga<pfecha+1 and
--             pr.tipoprestamoid=r.tipo and
--             pr.;
    
  select pr.tipoprestamoid,sum(mp.debe-mp.haber) into ptipomb, psaldotipomb
         from polizas p, movipolizas mp, prestamos pr, movibanco m, tipoprestamo t
            where m.prestamoid=pr.prestamoid and
            pr.tipoprestamoid=r.tipo and
            pr.tipoprestamoid=t.tipoprestamoid and 
            m.polizaid = p.polizaid and 
            p.fechapoliza<pfecha+1 and
            m.polizaid=mp.polizaid and
            mp.cuentaid=t.cuentaactivo
            group by pr.tipoprestamoid;

      psaldotipomb:= COALESCE ( psaldotipomb, 0 );

      --raise notice ' Calculando movibanco % ',psaldotipomb;

--      r.nosocios := lnosocios;
      r.ordenmov := 'B';
      r.saldo := r.saldo+psaldotipomb;
      fsubtotal := fsubtotal + r.saldo;
      lsocios := lsocios + lnosocios;
      return next r;
    end loop;


    fsubtotal := 0;
    lsocios:=0;


    for r in
select t.tipoinversionid,t.desctipoinversion, count(distinct mc.socioid) as nosocios,
       sum(m.haber)-sum(m.debe) as saldo
  from polizas p, tipoinversion t, movicaja mc, movipolizas m, inversion i
 where mc.tipomovimientoid='IN' and
       i.inversionid=mc.inversionid and
       t.tipoinversionid=i.tipoinversionid and
       p.polizaid=mc.polizaid and
       p.fechapoliza<pfecha+1 and       
       m.polizaid=p.polizaid and
       m.cuentaid=t.cuentapasivo
group by t.tipoinversionid,t.desctipoinversion
order by t.tipoinversionid

    loop

--      select count(distinct mc.socioid)
--        into lnosocios
--        from movicaja mc, polizas p, inversion i
--       where mc.tipomovimientoid='IN' and
--             p.polizaid=mc.polizaid and
--             p.fechapoliza<pfecha+1 and
--             i.inversionid=mc.inversionid and
--             i.tipoinversionid=r.tipo;
--      r.nosocios := lnosocios;

      r.ordenmov := 'C';
      fsubtotal := fsubtotal + r.saldo;
      lsocios := lsocios + lnosocios;
      return next r;
    end loop;

   
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsestadisticoctas(date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: estadosmex; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE estadosmex (
    estadomexid integer NOT NULL,
    claveestadomex character(3) NOT NULL,
    nombreestadomex character varying(20) NOT NULL,
    abre_estado character(3)
);


ALTER TABLE sucursal1.estadosmex OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsestadomex(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsestadomex(integer) RETURNS SETOF sucursal1.estadosmex
    AS $_$
declare
  r estadosmex%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select estadomexid,claveestadomex,nombreestadomex from estadosmex where estadomexid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select estadomexid,claveestadomex,nombreestadomex from estadosmex order by estadomexid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsestadomex(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: estados_credito; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE estados_credito (
    claveestadocredito character(3) NOT NULL,
    descripcionedocredito character varying(30) NOT NULL
);


ALTER TABLE sucursal1.estados_credito OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsestados_credito(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsestados_credito(character) RETURNS SETOF sucursal1.estados_credito
    AS $_$
declare
  r estados_credito%rowtype;
  pclave alias for $1;
begin

  if pclave<>'   ' then
    for r in
      select claveestadocredito,descripcionedocredito from estados_credito where claveestadocredito=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select claveestadocredito,descripcionedocredito from estados_credito order by claveestadocredito
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsestados_credito(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: finalidades; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE finalidades (
    clavefinalidad character(3) NOT NULL,
    descripcionfinalidad character varying(30) NOT NULL
);


ALTER TABLE sucursal1.finalidades OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsfinalidades(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsfinalidades(character) RETURNS SETOF sucursal1.finalidades
    AS $_$
declare
  r finalidades%rowtype;
  pclave alias for $1;
begin

  if pclave<>'   ' then
    for r in
      select clavefinalidad,descripcionfinalidad from finalidades where clavefinalidad=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select clavefinalidad,descripcionfinalidad from finalidades order by clavefinalidad
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsfinalidades(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: grupo; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE grupo (
    grupoid integer NOT NULL,
    grupo character(25)
);


ALTER TABLE sucursal1.grupo OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsgrupo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsgrupo(integer) RETURNS SETOF sucursal1.grupo
    AS $_$
declare
  r grupo%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from grupo where grupoid=pclave

    loop
      return next r;
    end loop;
  else
   for r in
   select * from grupo order by grupoid   
     loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsgrupo(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: inpc; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE inpc (
    ano integer NOT NULL,
    mes integer NOT NULL,
    inpc numeric NOT NULL
);


ALTER TABLE sucursal1.inpc OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsinpc(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsinpc(integer, integer) RETURNS SETOF sucursal1.inpc
    AS $_$
declare
  r inpc%rowtype;
  pano alias for $1;
  pmes alias for $2;
begin

  if pano>0 and pmes>0 then
    for r in
      select ano,mes,inpc
        from inpc where pano=ano and mes=pmes
    loop
      return next r;
    end loop;
  else
   for r in
      select ano,mes,inpc from inpc order by ano, mes
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsinpc(integer, integer) OWNER TO sistema;

--
-- Name: spsinteresdevengadomov(date, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsinteresdevengadomov(date, date, character) RETURNS SETOF tinteresdevengadomov
    AS $_$
declare
  pfecha1 alias for $1;
  pfecha2 alias for $2;
  ptipomovimientoid alias for $3;

  r tinteresdevengadomov%rowtype;
begin

  for r in
select t.tipomovimientoid,s.clavesocioint,
       su.nombre||' '||su.paterno||' '||su.materno as nombre,
       p.fechapoliza, mp.haber
  from polizas p, movipolizas mp, movicaja mc, socio s, tipomovimiento t, sujeto su
 where p.fechapoliza between pfecha1 and pfecha2 and
       p.tipo='W' and
       mc.polizaid=p.polizaid and
       mc.tipomovimientoid=ptipomovimientoid and
       t.tipomovimientoid = mc.tipomovimientoid and
       t.tasainteres>0 and
       mp.polizaid=p.polizaid and
       mp.cuentaid = t.cuentadeposito and
       s.socioid = mc.socioid and
       su.sujetoid = s.sujetoid
order by t.tipomovimientoid,s.clavesocioint
  loop       
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsinteresdevengadomov(date, date, character) OWNER TO sistema;

--
-- Name: spsinteresdevengadomovc(date, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsinteresdevengadomovc(date, date, character) RETURNS SETOF tinteresdevengadomov
    AS $_$
declare
  pfecha1 alias for $1;
  pfecha2 alias for $2;
  ptipomovimientoid alias for $3;

  r tinteresdevengadomov%rowtype;
  f record;
  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop

  raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

  dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
  dblink2:='set search_path to public,'||f.esquema||';select * from spsinteresdevengadomov('||''''||pfecha1||''''||','||''''||pfecha2||''''||','||''''||ptipomovimientoid||''''||');';
  for r in
    select * from
    dblink( dblink1,dblink2 )
    as t ( tipomovimientoid              char(2),
           clavesocioint                 char(18),
           nombresocio                   varchar(82),
           fecha                         date,
           interes                       numeric)
  loop
    return next r;
  end loop;
 end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsinteresdevengadomovc(date, date, character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: inversion; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE inversion (
    inversionid integer NOT NULL,
    socioid integer NOT NULL,
    tipoinversionid character(3) NOT NULL,
    referenciainversion integer NOT NULL,
    serieinversion character(2) NOT NULL,
    depositoinversion numeric NOT NULL,
    retiroinversion numeric NOT NULL,
    interesinversion numeric NOT NULL,
    fechainversion date NOT NULL,
    fechavencimiento date NOT NULL,
    ultimarenovacion date NOT NULL,
    noderenovaciones integer NOT NULL,
    tasainteresnormalinversion numeric NOT NULL,
    tasainteresmoratorioinversion numeric NOT NULL,
    fechapagoinversion date NOT NULL,
    fechapagoanterior date NOT NULL,
    reinversionautomatica character(1) NOT NULL,
    depositoanteside numeric,
    ide numeric,
    inversionanteriorid integer,
    manejo integer,
    isr numeric DEFAULT 0
);


ALTER TABLE sucursal1.inversion OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsinversion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsinversion(integer) RETURNS SETOF sucursal1.inversion
    AS $_$
declare
  r inversion%rowtype;
  pclave alias for $1;

  icalculoid int;

  sformula text;
  rec record;
  idias int;

  dfecha date;

  ssolodiaspactados char(1);
 

begin

    select solodiaspactados
      into ssolodiaspactados
      from empresa
    where empresaid=1;

    for r in
      -- Solo las no canceladas
      select * from inversion where inversionid=pclave and depositoinversion>0
    loop
      
      select max(p.fechapoliza)
        into dfecha
        from movicaja m, polizas p
       where m.inversionid=r.inversionid and m.estatusmovicaja='A' and
             p.polizaid = m.polizaid;

      --raise notice ' fecha pago anterior %',dfecha;

      if r.fechapagoinversion<dfecha then

        r.fechapagoinversion := dfecha;
        update inversion
           set fechapagoinversion = dfecha
         where inversionid=r.inversionid;

      end if;

      select calculoid
        into icalculoid
        from tipoinversion
       where tipoinversionid = r.tipoinversionid;

        idias := r.fechavencimiento - r.fechainversion;

        if r.noderenovaciones= 3 then

           select interesgeneradoinversion into r.interesinversion from interesgeneradoinversion(r.inversionid);

        else 

          select interesgeneradoinversionvencimiento into r.interesinversion from interesgeneradoinversionvencimiento(r.inversionid);

        end if;

        if r.interesinversion<0 then
          r.interesinversion:=0;
        end if;

        --raise notice ' % ', r.interesinversion;

      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsinversion(integer) OWNER TO sistema;

--
-- Name: spsinversiond(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsinversiond(date) RETURNS SETOF rinversiones
    AS $_$
declare
  r rinversiones%rowtype;
  pfecha alias for $1;

  icalculoid int;

  sformula text;
  rec record;
  idias int;

  dfecha date;

  ssolodiaspactados char(1);
  ldias int4;
  iperiodopagoinversion integer;


begin

  select solodiaspactados,periodopagoinversion
    into ssolodiaspactados,iperiodopagoinversion
    from empresa where empresaid=1;


    for r in
      -- Solo las no canceladas
      select i.inversionid, s.clavesocioint, i.depositoinversion,
             i.fechavencimiento, i.fechapagoinversion, i.interesinversion,
             pfecha-i.fechapagoinversion as dias, i.tipoinversionid,
             i.tasainteresnormalinversion,i.noderenovaciones
        from inversion i, socio s
       where
            (i.fechavencimiento=pfecha or
             (i.fechavencimiento=pfecha or pfecha-i.fechapagoinversion=iperiodopagoinversion)) and
             i.depositoinversion>0 and i.retiroinversion=0 and
             s.socioid=i.socioid
    loop
      select plazo into ldias from tipoinversion
       where tipoinversionid=r.tipoinversionid;

      select max(p.fechapoliza)
        into dfecha
        from movicaja m, polizas p
       where m.inversionid=r.inversionid and m.estatusmovicaja='A' and
             p.polizaid = m.polizaid;

      if r.fechapagoinversion<dfecha then

        r.fechapagoinversion := dfecha;

        update inversion
           set fechapagoinversion = dfecha
         where inversionid=r.inversionid;

      end if;

        if r.noderenovaciones= 3 then

           select interesgeneradoinversion into r.interesinversion from interesgeneradoinversion(r.inversionid);

        else 

          select interesgeneradoinversionvencimiento into r.interesinversion from interesgeneradoinversionvencimiento(r.inversionid);

        end if;

        if r.interesinversion<0 then
          r.interesinversion:=0;
        end if;

      return next r;

    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsinversiond(date) OWNER TO sistema;

--
-- Name: spsinversiones(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsinversiones(integer) RETURNS SETOF sucursal1.inversion
    AS $_$
declare
  r inversion%rowtype;
  pclave alias for $1;

  icalculoid int;
  idias int;


  sformula text;
  rec record;

  dfecha date;
  ssolodiaspactados char(1);
begin

    select solodiaspactados
      into ssolodiaspactados
      from empresa
    where empresaid=1;

    for r in
      select inversionid,socioid,tipoinversionid,referenciainversion,serieinversion,depositoinversion,retiroinversion,interesinversion,fechainversion,fechavencimiento,ultimarenovacion,noderenovaciones,tasainteresnormalinversion,tasainteresmoratorioinversion,fechapagoinversion,fechapagoanterior,reinversionautomatica,depositoanteside,ide,inversionanteriorid,isr from inversion
       where socioid=pclave and depositoinversion>retiroinversion  and tipoinversionid<>'K3'
    loop

      select max(p.fechapoliza)
        into dfecha
        from movicaja m, polizas p
       where m.inversionid=r.inversionid and m.estatusmovicaja='A' and
             p.polizaid = m.polizaid;

      if r.fechapagoinversion<dfecha then

        r.fechapagoinversion := dfecha;
        update inversion
           set fechapagoinversion = dfecha
         where inversionid=r.inversionid;

      end if;

      select calculoid
        into icalculoid
        from tipoinversion
       where tipoinversionid = r.tipoinversionid;        
       
        idias := r.fechavencimiento - r.fechainversion;
        
        if idias<0 then
          idias := 0;
        end if;

        select interesgeneradoinversion into r.interesinversion from interesgeneradoinversion(r.inversionid);      
     
        r.interesinversion := coalesce(r.interesinversion,0);
        if r.interesinversion<0 then
          r.interesinversion:=0;
        end if;
        
        select isrinversionmes into r.isr from isrinversionmes(r.inversionid);      
     
        r.isr := coalesce(r.isr,0);
        if r.isr<0 then
          r.isr:=0;
        end if;

        r.interesinversion:=r.interesinversion-r.isr;        

        --raise notice ' % ', r.interesinversion;     

      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsinversiones(integer) OWNER TO sistema;

--
-- Name: spsinversionesporpagar(date, date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsinversionesporpagar(date, date, character, character) RETURNS SETOF rinversionesporpagar
    AS $_$
declare
  r  rinversionesporpagar %rowtype;
  pfecha1 alias for $1;
  pfecha2 alias for $2;
  pgrupo1 alias for $3;
  pgrupo2 alias for $4;

  icalculoid int;
  idias int;

  fisrinversion numeric;
  sformula text;
  rec record;

  dfecha date;
  ssolodiaspactados char(1);
  iperiodopagoinversion integer;

begin

    select solodiaspactados,periodopagoinversion
      into ssolodiaspactados, iperiodopagoinversion
      from empresa
    where empresaid=1;

    for r in
      select inversionid,i.socioid,substring(rtrim(su.nombre)||' '||rtrim(su.paterno)||' '||rtrim(su.materno),1,40) as nombre,depositoinversion,interesinversion,fechainversion,fechavencimiento,noderenovaciones,tasainteresnormalinversion,fechapagoinversion,0,(case when noderenovaciones=0 then 'Depositar Capital e interes al ahorro' else (case when noderenovaciones=1 then 'Reinvertir Capital e interes' else (case when noderenovaciones=2 then 'Reinvertir Capital y pasar interes al ahorro' else (case when noderenovaciones=3 then 'Pago de Interes Parcial y pasar a ahorro' end) end) end) end),tipoinversionid,fechapagoinversion,0,0,0,si.grupo from inversion i, sujeto su, solicitudingreso si 
       where i.depositoinversion > i.retiroinversion and ((i.fechavencimiento >= pfecha1 and  i.fechavencimiento <= pfecha2) or (i.fechapagoinversion+ iperiodopagoinversion >= pfecha1 and  i.fechapagoinversion- iperiodopagoinversion <= pfecha2 and i.noderenovaciones=3)) and i.socioid=si.socioid and si.grupo >= pgrupo1 and si.grupo <= pgrupo2  and si.sujetoid = su.sujetoid

    loop
   
        select calculoid
        into icalculoid
        from tipoinversion
        where tipoinversionid = r.tipoinversionid;

        idias := r.fechavencimiento - r.fechainversion;
        
        if idias<0 then
          idias := 0;
        end if;

        select interesinversion into r.interesinversion from interesinversion(r.depositoinversion,r.tasainteresnormalinversion,icalculoid,idias);      
     
        r.interesinversion := coalesce(r.interesinversion,0);

        select isrinversion into r.isrinversion from isrinversion(r.depositoinversion,idias);
        r.isrinversion := coalesce(r.isrinversion,0);

        if r.interesinversion<0 then
          r.interesinversion:=0;
        end if;

        if r.isrinversion<0 then
          r.isrinversion:=0;
        end if;

       
        if (r.fechavencimiento >= pfecha1 and  r.fechavencimiento <= pfecha2) then
           r.proxfechapago:=r.fechavencimiento;
           select isrinversionvencimiento into r.proxisr from isrinversionvencimiento(r.inversionid);
           select round(interesgeneradoinversionvencimiento,2) into r.proxinteres from interesgeneradoinversionvencimiento(r.inversionid); 
           r.proxcapital:=r.depositoinversion;
        else
           r.proxfechapago:=r.fechapagoinversion+iperiodopagoinversion;
           select isrinversionmes into r.proxisr from isrinversionmes(r.inversionid);
           select round(interesgeneradoinversion,2) into r.proxinteres from interesgeneradoinversion(r.inversionid); 
           r.proxcapital:=0;
        end if;

        raise notice ' periodo %  prxisr % prxinteres %  proxcapital % ', iperiodopagoinversion,r.proxisr,r.proxinteres,r.proxcapital;

      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsinversionesporpagar(date, date, character, character) OWNER TO sistema;

--
-- Name: spsinversionestado(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsinversionestado(integer) RETURNS SETOF restadoinversion
    AS $_$
declare
  r  restadoinversion %rowtype;
  pclave alias for $1;

  icalculoid int;
  idias int;

  fisrinversion numeric;
  sformula text;
  rec record;

  dfecha date;
  ssolodiaspactados char(1);
begin

    select solodiaspactados
      into ssolodiaspactados
      from empresa
    where empresaid=1;

    for r in
      select inversionid,socioid,depositoinversion-retiroinversion,interesinversion,fechainversion,fechavencimiento,noderenovaciones,tasainteresnormalinversion,fechapagoinversion,0,(case when noderenovaciones=0 then 'Depositar Capital e interes al ahorro' else (case when noderenovaciones=1 then 'Reinvertir Capital e interes' else (case when noderenovaciones=2 then 'Reinvertir Capital y pasar interes al ahorro' else (case when noderenovaciones=3 then 'Pago de Interes Parcial y pasar a ahorro' end) end) end) end),tipoinversionid from inversion
       where socioid=pclave and depositoinversion>=retiroinversion

    loop
   
        select calculoid
        into icalculoid
        from tipoinversion
        where tipoinversionid = r.tipoinversionid;

        idias := r.fechavencimiento - r.fechainversion;
        
        if idias<0 then
          idias := 0;
        end if;

        select interesinversion into r.interesinversion from interesinversion(r.depositoinversion,r.tasainteresnormalinversion,icalculoid,idias);      
     
        r.interesinversion := coalesce(r.interesinversion,0);

        select isrinversion into r.isrinversion from isrinversion(r.depositoinversion,idias);
        r.isrinversion := coalesce(r.isrinversion,0);

        if r.interesinversion<0 then
          r.interesinversion:=0;
        end if;

        if r.isrinversion<0 then
          r.isrinversion:=0;
        end if;

      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsinversionestado(integer) OWNER TO sistema;

--
-- Name: spsinversiontipo(character, character, date, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsinversiontipo(character, character, date, date, integer) RETURNS SETOF rinversiontipo
    AS $_$
declare
  r rinversiontipo%rowtype;
  psocioi alias for $1;
  psociof alias for $2;
  pfechai alias for $3;
  pfechaf alias for $4;
  ptipo   alias for $5;

begin
  if ptipo=-1 then
    raise exception 'No selecciono el estado de la inversin';
  end if;

  if ptipo=0 then
    for r in
  select s.clavesocioint,i.referenciainversion,
         substr(su.nombre||' '||su.paterno||' '||su.materno,1,30) as nombre,
         i.fechainversion,i.fechavencimiento,
         i.depositoinversion,i.tasainteresnormalinversion, 
         interesinversion(i.depositoinversion,i.tasainteresnormalinversion,t.calculoid,i.fechavencimiento-i.fechainversion),
         isrinversion(i.depositoinversion,i.fechavencimiento-i.fechainversion,i.inversionid,i.fechavencimiento) as isr,i.tipoinversionid
    from inversion i, socio s, sujeto su, tipoinversion t
   where i.fechainversion between pfechai and pfechaf and
         s.socioid = i.socioid and
         s.clavesocioint>=psocioi and s.clavesocioint<=psociof and
         su.sujetoid = s.sujetoid and
         t.tipoinversionid = i.tipoinversionid
   order by s.clavesocioint
    loop
      return next r;
    end loop;
  else
    for r in
  select s.clavesocioint,i.referenciainversion,
         substr(su.nombre||' '||su.paterno||' '||su.materno,1,30) as nombre,
         i.fechainversion,i.fechavencimiento,
         i.depositoinversion,i.tasainteresnormalinversion, 
         interesinversion(i.depositoinversion,i.tasainteresnormalinversion,t.calculoid,i.fechavencimiento-i.fechainversion),
         isrinversion(i.depositoinversion,i.fechavencimiento-i.fechainversion,i.inversionid,i.fechavencimiento) as isr,i.tipoinversionid
    from inversion i, socio s, sujeto su, tipoinversion t
   where i.fechavencimiento between pfechai and pfechaf and
         s.socioid = i.socioid and
         s.clavesocioint>=psocioi and s.clavesocioint<=psociof and
         su.sujetoid = s.sujetoid and
         t.tipoinversionid = i.tipoinversionid
  order by s.clavesocioint
    loop
      return next r;
    end loop;
  end if;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsinversiontipo(character, character, date, date, integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: modulos; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE modulos (
    clavemodulo character(10) NOT NULL,
    descripcionmodulos character varying(80) NOT NULL
);


ALTER TABLE sucursal1.modulos OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsmodulo(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmodulo(character) RETURNS SETOF sucursal1.modulos
    AS $_$
declare
  r modulos%rowtype;
  pclave alias for $1;
begin

  if pclave<>'  ' then
    for r in
      select clavemodulo,descripcionmodulos from modulos where clavemodulo=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select clavemodulo,descripcionmodulos from modulos order by descripcionmodulos
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsmodulo(character) OWNER TO sistema;

--
-- Name: spsmoneda(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmoneda(character) RETURNS SETOF sucursal1.monedas
    AS $_$
declare
  r monedas%rowtype;
  pclave alias for $1;
begin

  if pclave<>'  ' then
    for r in
      select monedaid,monedavalor,monedadescri from monedas where monedaid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select monedaid,monedavalor,monedadescri from monedas order by monedaid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsmoneda(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: motivobaja; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE motivobaja (
    motivobajaid integer NOT NULL,
    descripcionmotivo character(30)
);


ALTER TABLE sucursal1.motivobaja OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsmotivobaja(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmotivobaja(integer) RETURNS SETOF sucursal1.motivobaja
    AS $_$
declare
  r motivobaja%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select motivobajaid,descripcionmotivo from motivobaja where motivobajaid=pclave

    loop
      return next r;
    end loop;
  else
   for r in
   select motivobajaid,descripcionmotivo from motivobaja order by motivobajaid   
     loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsmotivobaja(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: movibanco; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE movibanco (
    movibancoid integer NOT NULL,
    tipomovibancoid character(2) NOT NULL,
    prestamoid integer,
    no_cuenta character(15) NOT NULL,
    polizaid integer NOT NULL,
    consecutivo integer NOT NULL,
    serie character(2) NOT NULL,
    referenciamovi character(14) NOT NULL,
    concepto character varying(255) NOT NULL,
    beneficiario character varying(45) NOT NULL,
    conciliado character(1) NOT NULL,
    fecha_pen date NOT NULL,
    postfechado character(1) NOT NULL,
    movipolizaid integer,
    procampoid integer
);


ALTER TABLE sucursal1.movibanco OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsmovibanco(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmovibanco(integer) RETURNS SETOF sucursal1.movibanco
    AS $_$
declare
  r movibanco%rowtype;
  pmovibancoid alias for $1;
begin

  for r in
    select movibancoid,tipomovibancoid,prestamoid,no_cuenta,polizaid,consecutivo,serie,
           referenciamovi,concepto,beneficiario,conciliado,fecha_pen,postfechado,movipolizaid,procampoid
      from movibanco where movibancoid=pmovibancoid
  loop
     return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsmovibanco(integer) OWNER TO sistema;

--
-- Name: spsmovibanco(character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmovibanco(character, character, integer) RETURNS SETOF sucursal1.movibanco
    AS $_$
declare
  r movibanco%rowtype;
  pno_cuenta alias for $1;
  pserie     alias for $2;
  pconsecutivo alias for $3;
begin

  for r in select movibancoid,tipomovibancoid,prestamoid,no_cuenta,polizaid,consecutivo,serie,
                  referenciamovi,concepto,beneficiario,conciliado,fecha_pen,postfechado,movipolizaid,procampoid
             from movibanco where no_cuenta=pno_cuenta and serie=pserie and consecutivo=pconsecutivo
  loop
     return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsmovibanco(character, character, integer) OWNER TO sistema;

--
-- Name: spsmovicaja(character, integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmovicaja(character, integer, date) RETURNS SETOF rmovicaja
    AS $_$
declare
  pseriecaja alias for $1;
  preferenciacaja alias for $2;
  pfecha alias for $3;
  r rmovicaja%rowtype;
begin
  for r in
    select m.movicajaid,m.socioid,m.tipomovimientoid,m.polizaid,m.referenciacaja,m.seriecaja,
           m.movipolizaid,m.prestamoid,m.estatusmovicaja,m.inversionid,
           mp.debe,mp.haber
      from movicaja m,polizas p,movipolizas mp
     where m.seriecaja=pseriecaja and
           m.referenciacaja=preferenciacaja and
           p.polizaid=m.polizaid and
           p.fechapoliza=pfecha and
           mp.movipolizaid=m.movipolizaid
  loop

    return next r;
  end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsmovicaja(character, integer, date) OWNER TO sistema;

--
-- Name: spsmovicaja00(character, integer, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmovicaja00(character, integer, date, character) RETURNS SETOF rmovicaja00
    AS $_$
declare
  pseriecaja alias for $1;
  preferenciacaja alias for $2;
  pfecha alias for $3;
  pcuentacaja alias for $4;

  r rmovicaja00%rowtype;

  fcapital numeric;
  finteres numeric;
  fmoratorio numeric;
  fiva numeric;
  fdeposito numeric;
  fretiro numeric;

  stipomovimientoid char(2);

begin

--
-- Provisionalmente sacarlo del corte de caja
-- pendiente optimizar este query
--

raise notice 'Llega aqui ..';
    
    select capital,interes,moratorio,iva,tipomovimientoid,deposito,retiro
      into fcapital,finteres,fmoratorio,fiva,stipomovimientoid,fdeposito,fretiro
      from cortecaja(' ',pfecha,pcuentacaja)
     where serie = pseriecaja and
           folio = preferenciacaja and
           tipomovimientoid in ('00','IN');

raise notice 'Empieza el for ..';

  for r in
    select m.movicajaid,m.socioid,m.tipomovimientoid,m.polizaid,m.referenciacaja,m.seriecaja,
           m.movipolizaid,m.prestamoid,m.estatusmovicaja,m.inversionid,
           fdeposito as debe,fretiro as haber,fcapital as capital,
           finteres as interes,fmoratorio as moratorio ,fiva as iva
      from movicaja m,movipolizas mp
     where m.seriecaja=pseriecaja and
           m.referenciacaja=preferenciacaja and
           mp.movipolizaid=m.movipolizaid and
           m.tipomovimientoid in ('00','IN')
  loop

    return next r;
  end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsmovicaja00(character, integer, date, character) OWNER TO sistema;

--
-- Name: spsmovicajaxx(character, integer, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmovicajaxx(character, integer, date, character) RETURNS SETOF rmovicaja00
    AS $_$
declare
  pseriecaja alias for $1;
  preferenciacaja alias for $2;
  pfecha alias for $3;
  pcuentacaja alias for $4;

  r rmovicaja00%rowtype;

  fcapital numeric;
  finteres numeric;
  fmoratorio numeric;
  fiva numeric;
  fdeposito numeric;
  fretiro numeric;

  stipomovimientoid char(2);

begin

--
-- Provisionalmente sacarlo del corte de caja
-- pendiente optimizar este query
--
    
    select capital,interes,moratorio,iva,tipomovimientoid,deposito,retiro
      into fcapital,finteres,fmoratorio,fiva,stipomovimientoid,fdeposito,fretiro
      from cortecaja(pseriecaja,pfecha,0)
     where serie = pseriecaja and
           folio = preferenciacaja;

  for r in
    select m.movicajaid,m.socioid,m.tipomovimientoid,m.polizaid,m.referenciacaja,m.seriecaja,
           m.movipolizaid,m.prestamoid,m.estatusmovicaja,m.inversionid,
           fdeposito as debe,fretiro as haber,fcapital as capital,
           finteres as interes,fmoratorio as moratorio ,fiva as iva
      from movicaja m,movipolizas mp
     where m.seriecaja=pseriecaja and
           m.referenciacaja=preferenciacaja and
           mp.movipolizaid=m.movipolizaid
  loop

    return next r;
  end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsmovicajaxx(character, integer, date, character) OWNER TO sistema;

--
-- Name: spsmovicaptacionr(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmovicaptacionr(date, date) RETURNS SETOF rdetallemovicaptacion
    AS $_$
declare
	r rdetallemovicaptacion%rowtype;
	pfechai alias for $1;
  	pfechaf alias for $2;
begin
	    for r in
	 	select substring((s.clavesocioint),1,4) as suc, s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
		p.fechapoliza as fechamvto, t.tipomovimientoid as t_mvto, t.desctipomovimiento, m.debe as deposito, m.haber as retiro,
		p.seriepoliza as s_pol, pa.usuarioid 
		from parametros pa, movicaja mc, polizas p, movipolizas m,tipomovimiento t,socio s, sujeto su 
		where pa.serie_user=mc.seriecaja and su.sujetoid=s.sujetoid and 
		s.clavesocioint = s.clavesocioint and mc.socioid = s.socioid and 
		p.polizaid = mc.polizaid and m.movipolizaid = mc.movipolizaid and 
		t.tipomovimientoid =mc.tipomovimientoid and t.tipomovimientoid in ('PA','IN','AO','AC','AA','AF','AM','AI','AP','P3','TA','AH','PR') and 
		p.seriepoliza !='ZA' and p.seriepoliza !='Z'  and p.seriepoliza !='WW' and p.fechapoliza between pfechai and pfechaf
		order by s.clavesocioint, p.fechapoliza
	    loop
      		return next r;
    	    end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spsmovicaptacionr(date, date) OWNER TO sistema;

--
-- Name: spsmovicaptacionrc(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmovicaptacionrc(date, date) RETURNS SETOF rdetallemovicaptacion
    AS $_$
declare
	r rdetallemovicaptacion%rowtype;
	pfechai alias for $1;
  	pfechaf alias for $2;
	f record;
  	dblink1 text;
  	dblink2 text;
begin
for f in
		select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||'; select * from spsmovicaptacionr('||''''||pfechai||''''||','||''''||pfechaf||''''||');';

        for r in
           select * from
           dblink(dblink1,dblink2) as
           t2(suc character(4),
		clavesocioint character(16),
		nombresocio character varying(80),
		fechamvto date,
                t_mvto character(2),
		desctipomovimiento character(30),
		deposito numeric,
		retiro numeric,
		s_pol character(30),
		usuarioid character(20))

            loop
              return next r;
        end loop;

end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spsmovicaptacionrc(date, date) OWNER TO sistema;

--
-- Name: spsmovimientosxfecha(character, character, date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmovimientosxfecha(character, character, date, date) RETURNS SETOF rmovimientosxfecha
    AS $_$
declare

  psocioi alias for $1;
  psociof alias for $2;
  pfechai alias for $3;
  pfechaf alias for $4;

  r rmovimientosxfecha%rowtype;

begin

  for r in
select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombre,
       sum(case when t.tipomovimientoid='AA' and m.cuentaid=t.cuentadeposito
                then m.haber
                else 0 end) as depAA,
       sum(case when t.tipomovimientoid='AA' and m.cuentaid=t.cuentaretiro
                then m.debe
                else 0 end) as retAA,                
       sum(case when t.tipomovimientoid='DV' and m.cuentaid=t.cuentadeposito
                then m.haber
                else 0 end) as depDV,
       sum(case when t.tipomovimientoid='DV' and m.cuentaid=t.cuentaretiro
                then m.debe
                else 0 end) as retDV,
       sum(case when t.tipomovimientoid='IN' and m.cuentaid=t.cuentadeposito
                then m.haber
                else 0 end) as depIN,
       sum(case when t.tipomovimientoid='IN' and m.cuentaid=t.cuentaretiro
                then m.debe
                else 0 end) as retIN
  from polizas p, movipolizas m, movicaja mc, socio s, tipomovimiento t, sujeto su
 where p.fechapoliza between pfechai and pfechaf and
       mc.polizaid=p.polizaid and
       mc.tipomovimientoid in ('AA','DV','IN') and
       m.polizaid = p.polizaid and
       s.socioid = mc.socioid and
       s.clavesocioint>=psocioi and s.clavesocioint<=psociof and
       t.tipomovimientoid = mc.tipomovimientoid and
       su.sujetoid = s.socioid        
 group by s.clavesocioint,su.nombre,su.paterno,su.materno
 order by s.clavesocioint
  loop
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsmovimientosxfecha(character, character, date, date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: movipolizas; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE movipolizas (
    movipolizaid integer NOT NULL,
    polizaid integer NOT NULL,
    cuentaid character(24) NOT NULL,
    referencia_mov character(8),
    tipo_mov character(1) NOT NULL,
    debe numeric NOT NULL,
    haber numeric NOT NULL,
    diario_mov character(3),
    identific_descr character(1),
    descripcion character varying(29),
    prestamoid integer,
    inversionid integer
);


ALTER TABLE sucursal1.movipolizas OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsmovipoliza(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsmovipoliza(integer) RETURNS SETOF sucursal1.movipolizas
    AS $_$
declare
  r movipolizas%rowtype;
  ppolizaid alias for $1;
begin

  for r in
    select * from movipolizas where polizaid=ppolizaid order by movipolizaid
  loop
     return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsmovipoliza(integer) OWNER TO sistema;

--
-- Name: spsocioactivo(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsocioactivo(date) RETURNS SETOF socioactivo
    AS $_$
declare
  r socioactivo%rowtype;
  pfecha alias for $1;
begin

  for r in
select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombre,
       d.calle||' '||d.numero_ext||' '||rtrim(d.colonia)||' '||rtrim(d.comunidad)||' C.P. '||d.codpostal||' '||c.nombreciudadmex as domicilio,
       s.estatussocio
  from precorte p, prestamos pr, socio s, sujeto su, domicilio d, ciudadesmex c
 where p.fechacierre=pfecha and
       p.diasvencidos<90 and
       pr.prestamoid = p.prestamoid and
      s.socioid = pr.socioid and
       su.sujetoid = s.sujetoid and
       d.sujetoid = s.sujetoid and
       c.ciudadmexid = d.ciudadmexid
    loop
      return next r;
    end loop;


    for r in
select s.clavesocioint,su.nombre||' '||su.paterno||' '||su.materno as nombre,
       d.calle||' '||d.numero_ext||' '||rtrim(d.comunidad)||' '||c.nombreciudadmex as domicilio,s.estatussocio
  from socio s, sujeto su, domicilio d, ciudadesmex c
 where (s.estatussocio = 1 or s.estatussocio=3) and 
       su.sujetoid = s.sujetoid and	
       d.sujetoid = s.sujetoid and       
       c.ciudadmexid = d.ciudadmexid
       and not exists (select pr.socioid 
                               from precorte p, prestamos pr 
                              where p.fechacierre=pfecha and 
                                    pr.prestamoid=p.prestamoid and
                                    pr.socioid=s.socioid)

    loop

      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsocioactivo(date) OWNER TO sistema;

--
-- Name: spsocioxtipo(character, integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsocioxtipo(character, integer, date) RETURNS SETOF socioxtipo
    AS $_$
declare
  r socioxtipo%rowtype;

  ptiposocioid alias for $1;
  ppartesocialcubierta alias for $2;
  pfecha alias for $3;

  fmontopartesocial numeric;

begin

   select montopartesocial into fmontopartesocial
     from empresa where empresaid=1;

    for r in
      select s.clavesocioint, su.nombre||' '||su.paterno||' '||su.materno as nombre,
             d.calle||' '||d.numero_ext as domicilio,
             d.colonia, d.codpostal, d.comunidad, c.nombreciudadmex,
             sum(mp.debe)-sum(mp.haber) as saldo,
             s.tiposocioid, s.estatussocio
        from movicaja mc, movipolizas mp, polizas p, tipomovimiento tm,
             socio s, sujeto su, domicilio d, ciudadesmex c
       where mc.tipomovimientoid='PA' and
             mp.movipolizaid=mc.movipolizaid and
             p.polizaid = mp.polizaid and
             p.fechapoliza between '01-01-1900' and pfecha and      
             tm.tipomovimientoid=mc.tipomovimientoid and
             s.socioid = mc.socioid and
             su.sujetoid = s.sujetoid and
             d.sujetoid = su.sujetoid and
             c.ciudadmexid = d.ciudadmexid and
             (ptiposocioid='  ' or s.tiposocioid = ptiposocioid)
      group by s.clavesocioint, su.nombre, su.paterno, su.materno,
               d.calle, d.numero_ext,
               d.colonia, d.codpostal, d.comunidad, c.nombreciudadmex,
               s.tiposocioid, s.estatussocio
--      having (ppartesocialcubierta=0 or sum(mp.debe)-sum(mp.haber)>0)
      order by s.clavesocioint
    loop
      if ((ppartesocialcubierta=1 and r.partesocial>0 and
           r.partesocial>=fmontopartesocial) or
          (ppartesocialcubierta=0 and r.partesocial<fmontopartesocial)) then
        return next r;
      end if;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsocioxtipo(character, integer, date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: ocupacion; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE ocupacion (
    ocupacionid integer NOT NULL,
    ocupacion character varying(40) NOT NULL
);


ALTER TABLE sucursal1.ocupacion OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsocupacion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsocupacion(integer) RETURNS SETOF sucursal1.ocupacion
    AS $_$
declare
  r ocupacion%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from ocupacion where ocupacionid=pclave

    loop
      return next r;
    end loop;
  else
   for r in
   select * from ocupacion order by ocupacionid   
     loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsocupacion(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: parametros; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE parametros (
    parametroid integer NOT NULL,
    usuarioid character(20) NOT NULL,
    serie_user character(2) NOT NULL,
    cuentacaja character(24) NOT NULL,
    impresoracaja character(50),
    impresorareporte character(50),
    reporteslaser integer,
    clavesocioint character(15),
    fechapassword date
);


ALTER TABLE sucursal1.parametros OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsparametro(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsparametro(character) RETURNS SETOF sucursal1.parametros
    AS $_$
declare
  r parametros%rowtype;
  pclave alias for $1;
begin


    for r in
      select *
        from parametros
       where usuarioid=pclave
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsparametro(character) OWNER TO sistema;

--
-- Name: spspermisomodulo(character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspermisomodulo(character, character) RETURNS SETOF rpermisomodulo
    AS $_$
declare
  r rpermisomodulo%rowtype;
  pusuarioid alias for $1;
  pclavemodulo alias for $2;
begin

   for r in
      select p.permisomoduloid,p.clavemodulo,p.usuarioid,p.permiso,m.descripcionmodulos
        from permisosmodulos p, modulos m
       where p.usuarioid=pusuarioid and p.clavemodulo=pclavemodulo and
             m.clavemodulo = p.clavemodulo
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspermisomodulo(character, character) OWNER TO sistema;

--
-- Name: spspermisosmodulo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspermisosmodulo(integer) RETURNS SETOF rpermisomodulo
    AS $_$
declare
  r rpermisomodulo%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select p.permisomoduloid,p.clavemodulo,p.usuarioid,p.permiso,m.descripcionmodulos
        from permisosmodulos p, modulos m
       where p.permisomoduloid=pclave and
             m.clavemodulo = p.clavemodulo
      order by m.descripcionmodulos
    loop
      return next r;
    end loop;
  else
    for r in
      select p.permisomoduloid,p.clavemodulo,p.usuarioid,p.permiso,m.descripcionmodulos
        from permisosmodulos p, modulos m
       where m.clavemodulo = p.clavemodulo
     order by m.descripcionmodulos
    loop
      return next r;
    end loop;

  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspermisosmodulo(integer) OWNER TO sistema;

--
-- Name: spspermisosmodulos(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspermisosmodulos(character) RETURNS SETOF rpermisomodulo
    AS $_$
declare
  r rpermisomodulo%rowtype;
  pclave alias for $1;
begin

    for r in
      select p.permisomoduloid,p.clavemodulo,p.usuarioid,p.permiso,m.descripcionmodulos
        from permisosmodulos p, modulos m
       where p.usuarioid=pclave and
             m.clavemodulo = p.clavemodulo
      order by m.descripcionmodulos
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspermisosmodulos(character) OWNER TO sistema;

--
-- Name: spspoliza(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspoliza(integer) RETURNS SETOF sucursal1.polizas
    AS $_$
declare
  r polizas%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from polizas where polizaid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select * from polizas order by polizaid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspoliza(integer) OWNER TO sistema;

--
-- Name: spspoliza(integer, integer, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspoliza(integer, integer, character, integer) RETURNS SETOF sucursal1.polizas
    AS $_$
declare
  r polizas%rowtype;
  pejercicio alias for $1;
  pperiodo   alias for $2;
  ptipo_poliza alias for $3;
  pnumero_poliza alias for $4;

  sseriepoliza char(2);
  lreferencia int4;
begin

  select seriepoliza,referencia
    into sseriepoliza,lreferencia
    from polizas
   where ejercicio=pejercicio and periodo=pperiodo and
         tipo_poliza=ptipo_poliza and numero_poliza=pnumero_poliza-1;
   

    for r in
      select * from polizas
       where ejercicio=pejercicio and periodo=pperiodo and
             tipo_poliza=ptipo_poliza and numero_poliza>=pnumero_poliza and
             seriepoliza=sseriepoliza
      order by numero_poliza
    loop
      return next r;
      exit;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspoliza(integer, integer, character, integer) OWNER TO sistema;

--
-- Name: spspoliza(integer, integer, character, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspoliza(integer, integer, character, integer, character) RETURNS SETOF sucursal1.polizas
    AS $_$
declare
  r polizas%rowtype;
  pejercicio alias for $1;
  pperiodo   alias for $2;
  ptipo_poliza alias for $3;
  pnumero_poliza alias for $4;
  pserie alias for $5;
begin

    for r in
      select * from polizas
       where ejercicio=pejercicio and periodo=pperiodo and
             tipo_poliza=ptipo_poliza and numero_poliza=pnumero_poliza and
             seriepoliza=pserie
                              
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspoliza(integer, integer, character, integer, character) OWNER TO sistema;

--
-- Name: spspolizaant(integer, integer, character, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspolizaant(integer, integer, character, integer, character) RETURNS SETOF sucursal1.polizas
    AS $_$
declare
  r polizas%rowtype;
  pejercicio alias for $1;
  pperiodo   alias for $2;
  ptipo_poliza alias for $3;
  pnumero_poliza alias for $4;
  sseriepoliza alias for $5;

begin

    for r in
      select * from polizas
       where ejercicio=pejercicio and periodo=pperiodo and
             tipo_poliza=ptipo_poliza and numero_poliza<=pnumero_poliza and
             (seriepoliza=sseriepoliza or sseriepoliza='  ')
      order by numero_poliza desc
    loop
      return next r;
      exit;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspolizaant(integer, integer, character, integer, character) OWNER TO sistema;

--
-- Name: spspolizainversion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspolizainversion(integer) RETURNS integer
    AS $_$
declare
  pinversionid alias for $1;
  pmovicajaid int4;
  preturn int;
begin
   
   select movicajaid
     into pmovicajaid
     from movicaja
    where inversionid=pinversionid;

    if FOUND then
      preturn := 1;
    else
      preturn := 0;
    end if;

return preturn;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspolizainversion(integer) OWNER TO sistema;

--
-- Name: spspolizas(date, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspolizas(date, character, character) RETURNS SETOF tpolizas
    AS $_$
declare
 pfecha alias for $1;
 ptipo  alias for $2; 
 pserie alias for $3;
 r tpolizas%rowtype;

begin

  for r in
  select polizaid,numero_poliza,referencia,seriepoliza,fechapoliza,tipo_poliza,concepto_poliza
    from polizas
   where ejercicio = cast(date_part('year',pfecha) as int) and
         periodo = cast(date_part('month',pfecha) as int) and
         tipo_poliza = ptipo and
         seriepoliza = pserie   
  loop
    return next r;
  end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspolizas(date, character, character) OWNER TO sistema;

--
-- Name: spspolizasig(integer, integer, character, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspolizasig(integer, integer, character, integer, character) RETURNS SETOF sucursal1.polizas
    AS $_$
declare
  r polizas%rowtype;
  pejercicio alias for $1;
  pperiodo   alias for $2;
  ptipo_poliza alias for $3;
  pnumero_poliza alias for $4;
  sseriepoliza alias for $5;

begin

    for r in
      select * from polizas
       where ejercicio=pejercicio and periodo=pperiodo and
             tipo_poliza=ptipo_poliza and numero_poliza>=pnumero_poliza and
             (seriepoliza=sseriepoliza or sseriepoliza='  ')
      order by numero_poliza
    loop
      return next r;
      exit;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspolizasig(integer, integer, character, integer, character) OWNER TO sistema;

--
-- Name: spsprecortec(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsprecortec(integer, integer) RETURNS SETOF precortec
    AS $_$
declare
  pejercicio alias for $1;
  pperiodo alias for $2;
  r precortec%rowtype;
  f record;
  dblink1 text;
  dblink2 text;
  
begin

for f in
 select * from sucursales where vigente='S'
 loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='select clavefinalidad,tipoprestamoid,diasvencidos,reservacalculada,saldoprestamo from '||f.esquema||'.precorte where ejercicio='||to_char(pejercicio,'9999')||' and periodo='||to_char(pperiodo,'99');

        for r in
        SELECT * FROM
        dblink(dblink1,dblink2) as
        t2(clavefinalidad   char(3),
        tipoprestamoid   char(3),
        diasvencidos     int4,
        reservacalculada numeric,
        saldoprestamo numeric)

        loop
           return next r;
        end loop;

 end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsprecortec(integer, integer) OWNER TO sistema;

--
-- Name: spsprestamo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsprestamo(integer) RETURNS SETOF sucursal1.prestamos
    AS $_$
declare
  r prestamos%rowtype;
  pprestamoid alias for $1;

  o record;
begin

    for r in
      select * from prestamos
       where prestamoid=pprestamoid
    loop
      r.tasanormal:=tasareciprocidad(r.prestamoid);

      for o in
        select * from avales where solicitudprestamoid=r.solicitudprestamoid
      loop
        if o.prestamoid is null then
          update avales set prestamoid=r.prestamoid where avalid=o.avalid;
        end if;
      end loop;

      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsprestamo(integer) OWNER TO sistema;

--
-- Name: spsprestamos(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsprestamos(character) RETURNS SETOF sucursal1.prestamos
    AS $_$
declare
  r prestamos%rowtype;
  preferenciaprestamo alias for $1;

  fsaldoact numeric;
  fsaldocalculado numeric;

  lprestamoid int4;

  lsolicitudprestamoid int4;

  o record;
begin

  select prestamoid into lprestamoid
    from prestamos where referenciaprestamo=preferenciaprestamo;

-- Recalcular el saldo en base a pagos
select p.saldoprestamo, p.montoprestamo-sum(m.haber)
  into fsaldoact,fsaldocalculado
  from movipolizas m, movicaja mc, prestamos p, tipoprestamo tp
 where p.prestamoid = lprestamoid and
--p.referenciaprestamo = preferenciaprestamo and
       tp.tipoprestamoid = p.tipoprestamoid and
       mc.prestamoid = p.prestamoid and
       m.polizaid = mc.polizaid and
       m.cuentaid = tp.cuentaactivo
group by p.saldoprestamo,p.montoprestamo;

  raise notice ' Saldo Actual %  Saldo Calculado %',fsaldoact,fsaldocalculado;
  if fsaldoact<>fsaldocalculado then
    update prestamos
       set saldoprestamo = fsaldocalculado
     where referenciaprestamo=preferenciaprestamo;

    if fsaldocalculado=0 then
      update prestamos
         set claveestadocredito='002'
       where referenciaprestamo=preferenciaprestamo;
    end if;

  end if;


-- Verificar que haya pasado los avales
   select solicitudprestamoid
     into lsolicitudprestamoid
     from prestamos
    where referenciaprestamo=preferenciaprestamo;

   for o in
     select * from avales where solicitudprestamoid=lsolicitudprestamoid
   loop
     if o.prestamoid is null then
       update avales set prestamoid=lprestamoid where avalid=o.avalid;
     end if;
   end loop;


  if preferenciaprestamo<>'                   ' then
    for r in
      select * from prestamos where referenciaprestamo=preferenciaprestamo
    loop       
      return next r;
    end loop;
  else
   for r in
     select * from prestamos order by referenciaprestamo
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsprestamos(character) OWNER TO sistema;

--
-- Name: spsprestamos(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsprestamos(integer) RETURNS SETOF sucursal1.prestamos
    AS $_$
declare
  r prestamos%rowtype;
  psocioid alias for $1;
  o record;
begin

    for r in
      select * from prestamos
       where socioid=psocioid and saldoprestamo>0 and claveestadocredito<>'008' and tipoprestamoid<>'P4'
    order by fecha_otorga
    loop
      r.tasanormal:=tasareciprocidad(r.prestamoid);
      for o in
        select * from avales where solicitudprestamoid=r.solicitudprestamoid
      loop
        if o.prestamoid is null then
          update avales set prestamoid=r.prestamoid where avalid=o.avalid;
        end if;
      end loop;

      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsprestamos(integer) OWNER TO sistema;

--
-- Name: spsprestamos(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsprestamos(integer, character) RETURNS SETOF sucursal1.prestamos
    AS $_$
declare
  r prestamos%rowtype;
  psocioid alias for $1;
  plogin alias for $2;
  o record;

  spermiso char(1);
begin

 select permiso
    into spermiso
    from permisosmodulos
   where usuarioid=plogin and
         clavemodulo='0456';


   if spermiso='S' then
    for r in
      select * from prestamos
       where socioid=psocioid and saldoprestamo>0 and claveestadocredito<>'008'
    order by fecha_otorga
    loop
      r.tasanormal:=tasareciprocidad(r.prestamoid);
      for o in
        select * from avales where solicitudprestamoid=r.solicitudprestamoid
      loop
        if o.prestamoid is null then
          update avales set prestamoid=r.prestamoid where avalid=o.avalid;
        end if;
      end loop;

      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsprestamos(integer, character) OWNER TO sistema;

--
-- Name: spsprestamosactivos(character, date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsprestamosactivos(character, date, date) RETURNS SETOF rprestamosactivos
    AS $_$
declare
  pclavesocioint alias for $1;
  pfechai alias for $2;
  pfechaf alias for $3;

  r rprestamosactivos%rowtype;
  
  lsocioid int4;
  summonto numeric;
  sumsaldo  numeric;
begin 
  summonto := 0.00;
  sumsaldo := 0.00;
  select socioid into lsocioid from socio where clavesocioint=pclavesocioint;

  for r in
   	select p.referenciaprestamo,p.montoprestamo,
               p.montoprestamo - SUM( case when m.cuentaid=tp.cuentaactivo and po.fechapoliza<=pfechaf then m.haber else 0 end ) as tsaldo,
               p.fecha_vencimiento,p.tasanormal,p.tasa_moratoria, p.fechaultimopago 
        from prestamos p left join movicaja mc on p.prestamoid=mc.prestamoid 
	                 left join polizas po on mc.polizaid = po.polizaid
	                 left join movipolizas m on po.polizaid=m.polizaid , tipoprestamo tp
	where p.fecha_otorga <= pfechaf and
              p.claveestadocredito<>'008' and
              p.socioid = lsocioid and
              p.tipoprestamoid <> 'P4'
	group by p.prestamoid, p.tipoprestamoid,p.montoprestamo,
	         p.clavefinalidad,
	         p.fecha_1er_pago,p.fecha_vencimiento,p.referenciaprestamo,p.tasanormal,p.tasa_moratoria,p.fechaultimopago
 	having p.montoprestamo-SUM(case when m.cuentaid=tp.cuentaactivo and po.fechapoliza<=pfechai then m.haber else 0 end)  > 0
   loop
	summonto := summonto + r.tmontoprestamo;
        sumsaldo := sumsaldo + r.tsaldoprestamo;
        return next r;
   end loop;
   
   r.treferenciaprestamo:= null;
   r.tmontoprestamo := summonto;
   r.tsaldoprestamo := sumsaldo;
   r.tfecha_vencimiento := null;
   
   return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsprestamosactivos(character, date, date) OWNER TO sistema;

--
-- Name: spsprestamosxtipo(date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsprestamosxtipo(date, integer) RETURNS SETOF prestamosxt
    AS $_$
declare
  pfecha     alias for $1;
  pconsaldo  alias for $2;
  r prestamosxt%rowtype;

  fmontoprestamo numeric;
  fsaldoprestamo numeric;
  stipoprestamoid char(3);
  ltotalprestamos int4;

  fgmontoprestamo numeric;
  fgsaldoprestamo numeric;
  lgtotalprestamos int4;

  tsaldoprestamo numeric;
  tmontoprestamo numeric;
begin

  fmontoprestamo:=0;
  fsaldoprestamo:=0;
  ltotalprestamos:=0;
  stipoprestamoid:='   ';

  fgmontoprestamo:=0;
  fgsaldoprestamo:=0;
  lgtotalprestamos:=0;

  for r in
    select 0,s.clavesocioint,p.referenciaprestamo,p.montoprestamo,p.saldoprestamo,
           p.tipoprestamoid, p.fecha_otorga,p.fecha_vencimiento 
      from prestamos p, socio s 
     where s.socioid=p.socioid and p.saldoprestamo>0
     order by p.tipoprestamoid,p.referenciaprestamo 
  loop
    if stipoprestamoid='   ' then
      stipoprestamoid:=r.tipoprestamoid;
    end if;
    if stipoprestamoid<>r.tipoprestamoid then
      tmontoprestamo:=r.montoprestamo;
      tsaldoprestamo:=r.saldoprestamo;

      -- Es un subtotal
      r.essubtotal:=1;
      r.montoprestamo:=fmontoprestamo;
      r.saldoprestamo:=fsaldoprestamo;
      return next r;

      r.essubtotal:=2;
      r.montoprestamo:=ltotalprestamos;
      return next r;

      fgmontoprestamo:=fgmontoprestamo+fmontoprestamo;
      fgsaldoprestamo:=fgsaldoprestamo+fsaldoprestamo;
      lgtotalprestamos:=lgtotalprestamos+ltotalprestamos;

      fmontoprestamo:=0;
      fsaldoprestamo:=0;
      ltotalprestamos:=0;
      stipoprestamoid:=r.tipoprestamoid;

      r.montoprestamo:=tmontoprestamo;
      r.saldoprestamo:=tsaldoprestamo;

    end if;

    r.essubtotal:=0;
    fmontoprestamo:=fmontoprestamo+r.montoprestamo;
    fsaldoprestamo:=fsaldoprestamo+r.saldoprestamo;
    ltotalprestamos:=ltotalprestamos+1;
    return next r;
      
   
  end loop;

  -- Es un subtotal
  r.essubtotal:=1;
  r.montoprestamo:=fmontoprestamo;
  r.saldoprestamo:=fsaldoprestamo;
  return next r;

  r.essubtotal:=2;
  r.montoprestamo:=ltotalprestamos;
  return next r;

  r.essubtotal:=3;
  r.montoprestamo:=fgmontoprestamo;
  r.saldoprestamo:=fgsaldoprestamo;
  return next r;

  r.essubtotal:=4;
  r.montoprestamo:=lgtotalprestamos;
  return next r;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsprestamosxtipo(date, integer) OWNER TO sistema;

--
-- Name: spsprestamoxtipo(date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsprestamoxtipo(date, integer) RETURNS SETOF prestamoxtipo
    AS $_$
declare
  pfecha     alias for $1;
  pconsaldo  alias for $2;
  r prestamoxtipo%rowtype;

  fmontoprestamo numeric;
  fsaldoprestamo numeric;
  stipoprestamoid char(3);
  ltotalprestamos int4;

  fgmontoprestamo numeric;
  fgsaldoprestamo numeric;
  lgtotalprestamos int4;

  tsaldoprestamo numeric;
  tmontoprestamo numeric;
begin

  fmontoprestamo:=0;
  fsaldoprestamo:=0;
  ltotalprestamos:=0;
  stipoprestamoid:='   ';

  fgmontoprestamo:=0;
  fgsaldoprestamo:=0;
  lgtotalprestamos:=0;

  for r in

select 0,s.clavesocioint,p.referenciaprestamo,p.montoprestamo,
           p.montoprestamo-sum(mp.haber),
           p.tipoprestamoid, p.fecha_otorga, p.fecha_vencimiento,
           su.nombre||' '||su.paterno||' '||su.materno as nombre
      from prestamos p, socio s, sujeto su, tipoprestamo t,
           movicaja m, polizas po, movipolizas mp
     where s.socioid=p.socioid and 
           su.sujetoid = s.sujetoid and
           t.tipoprestamoid = p.tipoprestamoid and
           m.prestamoid = p.prestamoid and
           po.polizaid = m.polizaid and
           po.fechapoliza <= pfecha and
           mp.polizaid = po.polizaid and
           mp.cuentaid = t.cuentaactivo     
   group by s.clavesocioint,p.referenciaprestamo,p.montoprestamo,p.saldoprestamo,
           p.tipoprestamoid, p.fecha_otorga,p.fecha_vencimiento,
           su.nombre,su.paterno,su.materno 
    having (pconsaldo=0 or p.montoprestamo-sum(mp.haber)>0)
order by p.tipoprestamoid,p.referenciaprestamo

  loop
    if stipoprestamoid='   ' then
      stipoprestamoid:=r.tipoprestamoid;
    end if;
    if stipoprestamoid<>r.tipoprestamoid then
      tmontoprestamo:=r.montoprestamo;
      tsaldoprestamo:=r.saldoprestamo;

      -- Es un subtotal
      r.essubtotal:=1;
      r.montoprestamo:=fmontoprestamo;
      r.saldoprestamo:=fsaldoprestamo;
      return next r;

      r.essubtotal:=2;
      r.montoprestamo:=ltotalprestamos;
      return next r;

      fgmontoprestamo:=fgmontoprestamo+fmontoprestamo;
      fgsaldoprestamo:=fgsaldoprestamo+fsaldoprestamo;
      lgtotalprestamos:=lgtotalprestamos+ltotalprestamos;

      fmontoprestamo:=0;
      fsaldoprestamo:=0;
      ltotalprestamos:=0;
      stipoprestamoid:=r.tipoprestamoid;

      r.montoprestamo:=tmontoprestamo;
      r.saldoprestamo:=tsaldoprestamo;

    end if;

    r.essubtotal:=0;
    fmontoprestamo:=fmontoprestamo+r.montoprestamo;
    fsaldoprestamo:=fsaldoprestamo+r.saldoprestamo;
    ltotalprestamos:=ltotalprestamos+1;
    return next r;
      
   
  end loop;

  -- Es un subtotal
  r.essubtotal:=1;
  r.montoprestamo:=fmontoprestamo;
  r.saldoprestamo:=fsaldoprestamo;
  return next r;

  r.essubtotal:=2;
  r.montoprestamo:=ltotalprestamos;
  return next r;

  r.essubtotal:=3;
  r.montoprestamo:=fgmontoprestamo;
  r.saldoprestamo:=fgsaldoprestamo;
  return next r;

  r.essubtotal:=4;
  r.montoprestamo:=lgtotalprestamos;
  return next r;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsprestamoxtipo(date, integer) OWNER TO sistema;

--
-- Name: spspresupuestosocios(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspresupuestosocios(date, date) RETURNS SETOF rpresupuestosocios
    AS $_$
declare
  pfechai alias for $1;
  pfecha alias for $2;  
  r rpresupuestosocios%rowtype;

  psociomayormes numeric; 
  psociomenormes numeric;
  psocioformames numeric;
  psociomayor numeric; 
  psociomenor numeric;
  psocioforma numeric;
 
begin


        select count(socioid) into psociomayor from spssociosxtipomovimiento('PA',pfecha);

        r.sociomayor:= COALESCE (psociomayor, 0 );

        select count(socioid) into psociomenor from spssociosxtipomovimiento('AM',pfecha);

        r.sociomenor:= COALESCE (psociomenor, 0 );

        select count(socioid) into psocioforma from spssociosxtipomovimiento('AS',pfecha);
        
        r.socioforma:= COALESCE (psocioforma, 0 );

        select count(socioid) into psociomayormes from socio where fechaalta>= pfechai and fechaalta < pfecha+1 and tiposocioid='02' and estatussocio<>2  ;

        r.sociomayormes:= COALESCE (psociomayormes, 0 );

        select count(socioid) into psociomenormes from socio where fechaalta>= pfechai and fechaalta < pfecha+1 and tiposocioid='01' and estatussocio<>2  ;

        r.sociomenormes:= COALESCE (psociomenormes, 0 );

        select count(socioid) into psocioformames from socio where fechaalta>= pfechai and fechaalta < pfecha+1 and tiposocioid='03'  and estatussocio<>2 ;

        r.socioformames:= COALESCE (psocioformames, 0 );

    return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspresupuestosocios(date, date) OWNER TO sistema;

--
-- Name: spspresupuestosociosc(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspresupuestosociosc(date, date) RETURNS SETOF rpresupuestosocios
    AS $_$
declare  
  r rpresupuestosocios%rowtype;
  pfechai alias for $1;
  pfechaf alias for $2;

-- contador numeric;

  f record;
  dblink1 text;
  dblink2 text;

begin

for f in
  select * from sucursales where vigente='S'
  loop

    raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

    dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

    dblink2:= 'set search_path to public,'||f.esquema||';select * from spspresupuestosocios('||''''||pfechai||''''||','||''''||pfechaf||''''||');';

    for r in SELECT * FROM
        dblink(dblink1,dblink2) as
        t2(sociomayormes numeric, 
        sociomenormes numeric,
        socioformames numeric,
        sociomayor numeric, 
        sociomenor numeric,
        socioforma numeric)
    loop
      return next r;
    end loop;

  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspresupuestosociosc(date, date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: procampo; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE procampo (
    procampoid integer NOT NULL,
    tipoprestamoid character(3) NOT NULL,
    beneficiarioid integer NOT NULL,
    sujetoid integer NOT NULL,
    referenciaprestamo character(18) NOT NULL,
    montoprestamo numeric NOT NULL,
    saldoprestamo numeric NOT NULL,
    numero_de_amor integer NOT NULL,
    fecha_otorga date NOT NULL,
    fecha_vencimiento date NOT NULL,
    tasanormal numeric NOT NULL,
    tasa_moratoria numeric NOT NULL,
    dias_de_cobro integer NOT NULL,
    meses_de_cobro integer NOT NULL,
    dia_mes_cobro integer NOT NULL,
    fecha_1er_pago date NOT NULL,
    fechaultimopago date NOT NULL,
    nohectareas numeric,
    credxhec numeric,
    comxhec numeric,
    comxch numeric,
    interes numeric,
    montoentregado numeric,
    asesorid integer,
    comisionasesor numeric
);


ALTER TABLE sucursal1.procampo OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsprocampo(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsprocampo(character) RETURNS SETOF sucursal1.procampo
    AS $_$
declare
  r procampo%rowtype;
  preferenciaprestamo alias for $1;
begin

  for r in
    select * from procampo where referenciaprestamo=preferenciaprestamo
  loop       
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsprocampo(character) OWNER TO sistema;

--
-- Name: spsprocampo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsprocampo(integer) RETURNS SETOF sucursal1.procampo
    AS $_$
declare
  r procampo%rowtype;
  psujetoid alias for $1;
begin

    for r in
      select * from procampo
       where sujetoid=psujetoid
    order by fecha_otorga
    loop
      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsprocampo(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: promocion; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE promocion (
    promocionid integer NOT NULL,
    tipopromocionid integer NOT NULL,
    socioid integer NOT NULL,
    fechaalta date NOT NULL,
    fechabaja date,
    estatus integer NOT NULL
);


ALTER TABLE sucursal1.promocion OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spspromocion(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspromocion(integer, integer) RETURNS SETOF sucursal1.promocion
    AS $_$
declare
  r promocion%rowtype;
  ppromocionid alias for $1;
  ptipopromocionid alias for $2;
begin

  if ppromocionid<>0 then
    for r in
      select promocionid,tipopromocionid,socioid,fechaalta,fechabaja,estatus
        from promocion
       where promocionid=ppromocionid
     loop
      return next r;
    end loop;
  else
   for r in
      select promocionid,tipopromocionid,socioid,fechaalta,fechabaja,estatus
        from promocion
       where tipopromocionid=ptipopromocionid 
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspromocion(integer, integer) OWNER TO sistema;

--
-- Name: spspromocionxtipo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spspromocionxtipo(integer) RETURNS SETOF rpromocion
    AS $_$
declare
  ptipopromocionid alias for $1;
  r rpromocion%rowtype;
begin


  for r in
    select s.clavesocioint,
           su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
           p.fechaalta,p.estatus,p.promocionid
      from promocion p, socio s, sujeto su
     where tipopromocionid=ptipopromocionid and
           s.socioid=p.socioid and
           su.sujetoid=s.sujetoid
  loop
    return next r;
  end loop;
  
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spspromocionxtipo(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: rango; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE rango (
    rangoid integer NOT NULL,
    nombrerango character varying(80) NOT NULL
);


ALTER TABLE sucursal1.rango OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsrango(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsrango(integer) RETURNS SETOF sucursal1.rango
    AS $_$
declare

  pclave alias for $1;

  r rango%rowtype;
  
begin

  if pclave<>0 then
    for r in
      select rangoid,nombrerango from rango where rangoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select rangoid,nombrerango from rango order by rangoid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsrango(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: recargos; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE recargos (
    ano integer NOT NULL,
    mes integer NOT NULL,
    porcentaje numeric NOT NULL
);


ALTER TABLE sucursal1.recargos OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsrecargos(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsrecargos(integer, integer) RETURNS SETOF sucursal1.recargos
    AS $_$
declare
  r recargos%rowtype;
  pano alias for $1;
  pmes alias for $2;
begin

  if pano<>0 and pmes<>0 then
    for r in
      select ano,mes,porcentaje
        from recargos
       where ano=pano and mes=pmes
      order by ano,mes
    loop
      return next r;
    end loop;
  else
   for r in
      select ano,mes,porcentaje
        from recargos
      order by ano,mes
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsrecargos(integer, integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: relacion; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE relacion (
    relacionid integer NOT NULL,
    solicitudingresoid integer NOT NULL,
    sujetoid integer NOT NULL,
    socioid integer,
    parentesco character varying(20) NOT NULL,
    porcentaje numeric NOT NULL,
    esbenficiario integer NOT NULL,
    esreferenciapersonal integer NOT NULL,
    esrepresentante integer NOT NULL,
    escotitular integer,
    tiporelacion integer
);


ALTER TABLE sucursal1.relacion OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsrelacion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsrelacion(integer) RETURNS SETOF sucursal1.relacion
    AS $_$
declare
  r relacion%rowtype;
  pclave alias for $1;
begin

  for r in
    select * from relacion where relacionid=pclave
  loop
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsrelacion(integer) OWNER TO sistema;

--
-- Name: spsrelaciones(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsrelaciones(integer) RETURNS SETOF sucursal1.relacion
    AS $_$
declare
  r relacion%rowtype;
  pclave alias for $1;
begin

  for r in
    select * from relacion where solicitudingresoid=pclave
  loop
    return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsrelaciones(integer) OWNER TO sistema;

--
-- Name: spsrelacionessocio(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsrelacionessocio(character) RETURNS SETOF rrelacionessocio
    AS $_$
declare
	r rrelacionessocio%rowtype;
	pclavesocioint alias for $1;
begin
	    for r in
			SELECT re.socioid,
			re.parentesco,
			sr.clavesocioint 
		from socio s,
			solicitudingreso si,
			relacion re, 
			(select * from socio) sr 
		where s.clavesocioint=pclavesocioint and 
			s.socioid=si.socioid and 
			si.solicitudingresoid=re.solicitudingresoid and 
			re.socioid = sr.socioid
	    loop
      		return next r;
    	end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spsrelacionessocio(character) OWNER TO sistema;

--
-- Name: spsrelacionessocioc(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsrelacionessocioc(character) RETURNS SETOF rrelacionessocio
    AS $_$
declare
	r rrelacionessocio%rowtype;
	pclavesocioint alias for $1;
	f record;
  	dblink1 text;
  	dblink2 text;
	suc character(2);
begin
	SELECT into suc substr(pclavesocioint,2,2);
for f in
		select * from sucursales where vigente='S' and basededatos like '%'||suc||'%'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;
		
        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
		
        dblink2:='set search_path to public,'||f.esquema||'; select * from spsrelacionessocio('||''''||pclavesocioint||''''||');';

        for r in
           select * from
           dblink(dblink1,dblink2) as
           t2(socioid integer,
				parentesco character varying(20),
				clavesocioint character(16)
			)

        loop
              return next r;
        end loop;
end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spsrelacionessocioc(character) OWNER TO sistema;

--
-- Name: spsreporte(refcursor); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsreporte(refcursor) RETURNS refcursor
    AS $_$
begin

    open $1 for execute 'select c.* from catalogo_ctas c order by c.cuentaid';
    return $1;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsreporte(refcursor) OWNER TO sistema;

--
-- Name: spsreporteisr(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsreporteisr(date, date) RETURNS SETOF rreporteisr
    AS $_$
declare
	r rreporteisr%rowtype;
	pfechai alias for $1;
  	pfechaf alias for $2;
begin
	    for r in
			select 	substring((s.clavesocioint),1,4) as suc, 
					s.clavesocioint,
					su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
					p.fechapoliza as fechamvto,
					p.polizaid,
					m.haber as cobro,
					m.inversionid,
					--t.tipomovimientoid as t_mvto,
					--t.desctipomovimiento,
					NULL as monto_inversion,
					NULL as interes_inversion,
					p.seriepoliza as s_pol
					--pa.usuarioid,
					--m.movipolizaid
			from 	--parametros pa, 
					movicaja mc, 
					polizas p, 
					movipolizas m,
					--tipomovimiento t,
					socio s, 
					sujeto su 
			where 	--pa.serie_user=mc.seriecaja and 
					su.sujetoid=s.sujetoid and 
					s.clavesocioint = s.clavesocioint and 
					mc.socioid = s.socioid and 
					m.cuentaid = '2305100102' and 
					--p.polizaid = mc.polizaid and 
					--m.movipolizaid = mc.movipolizaid and 
					--m.polizaid = mc.polizaid and 
					--t.tipomovimientoid =mc.tipomovimientoid and 
					--t.tipomovimientoid in ('BU','CP','TE','RP') and 
					--p.seriepoliza !='ZA' and 
					--p.seriepoliza !='Z'  and 
					--p.seriepoliza !='WW' and 
					m.polizaid = p.polizaid and 
					mc.polizaid=p.polizaid and
					p.fechapoliza between pfechai and pfechaf
			order by s.clavesocioint, p.fechapoliza
	    loop
			select depositoinversion into r.monto_inversion from inversion where inversionid = r.inversionid;
			select interesinversion into r.interes_inversion from inversion where inversionid = r.inversionid;
      		return next r;
		end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spsreporteisr(date, date) OWNER TO sistema;

--
-- Name: spsreporteisrc(date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsreporteisrc(date, date) RETURNS SETOF rreporteisr
    AS $_$
declare
	r rreporteisr%rowtype;
	pfechai alias for $1;
  	pfechaf alias for $2;
	f record;
  	dblink1 text;
  	dblink2 text;
begin
for f in
		select * from sucursales where vigente='S'
 loop
        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||'; select * from spsreporteisr('||''''||pfechai||''''||','||''''||pfechaf||''''||');';

        for r in
           select * from
           dblink(dblink1,dblink2) as
           t2(suc character(4),
	clavesocioint character(16),
	nombresocio character varying(80),
	fechamvto date,
	polizaid integer,
	cobro numeric,
	inversionid integer,
	monto_inversion numeric,
	interes_inversion numeric,
	--t_mvto character(20),
	--desctipomovimiento character(30),
	--concepto character(30),
	s_pol character(30)
	--usuarioid character(20)
	)

        loop
              return next r;
        end loop;

end loop;
return;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spsreporteisrc(date, date) OWNER TO sistema;

--
-- Name: spsreportesaldosxfecha(character, date, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsreportesaldosxfecha(character, date, date) RETURNS SETOF rptsaldosxfecha
    AS $_$
declare
  pclavesocioint alias for $1;
  pfechai alias for $2;
  pfechaf alias for $3;
  r rptsaldosxfecha%rowtype;
  
  lsocioid int4;
begin

    select socioid
      into lsocioid
      from socio
     where clavesocioint=pclavesocioint;

    for r in
SELECT t.tipomovimientoid, t.desctipomovimiento,
       sum(case when p.fechapoliza<pfechai and
           (mp.cuentaid=t.cuentadeposito or mp.cuentaid=t.cuentaretiro)
           then mp.haber-mp.debe else 0 end) as saldoinicial,          
       sum(case when p.fechapoliza>=pfechai and p.fechapoliza<=pfechaf and
                     mp.cuentaid = t.cuentadeposito
           then mp.haber else 0 end) as depositos,
       sum(case when p.fechapoliza>=pfechai and p.fechapoliza<=pfechaf and
                     mp.cuentaid = t.cuentaretiro
           then mp.debe else 0 end) as retiros,
       sum(case when p.fechapoliza<=pfechaf and
                     (mp.cuentaid=t.cuentadeposito or mp.cuentaid=t.cuentaretiro)
           then mp.haber-mp.debe else 0 end) as saldofinal
  FROM movicaja m, polizas p, movipolizas mp, tipomovimiento t
 WHERE m.socioid = lsocioid and 
       t.tipomovimientoid = m.tipomovimientoid and
       t.aplicasaldo = 'S' and       
       p.polizaid = m.polizaid and
       p.fechapoliza <= pfechaf and
       mp.polizaid = p.polizaid 
GROUP BY  t.tipomovimientoid, t.desctipomovimiento
ORDER BY t.tipomovimientoid          

    loop
      return next r;
    end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsreportesaldosxfecha(character, date, date) OWNER TO sistema;

--
-- Name: spsrepresentante(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsrepresentante(character) RETURNS text
    AS $_$
declare
  pclavesocioint alias for $1;

  stmp text; 
  stexto text;

  lsujetoid int4;
begin

select max(r.sujetoid)
 into lsujetoid
  from solicitudingreso s, socio so, relacion r
  where so.clavesocioint=pclavesocioint AND
        s.socioid=so.socioid and
        r.solicitudingresoid=s.solicitudingresoid and
        r.esrepresentante=1;

  select nombre||' '||paterno||' '||materno
    into stmp
    from sujeto
   where sujetoid=lsujetoid;

  stexto := stmp||'
';

return stexto;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsrepresentante(character) OWNER TO sistema;

--
-- Name: spsreservaxtipo(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsreservaxtipo(date) RETURNS SETOF cartera
    AS $_$
declare
  r cartera%rowtype;
  pfechacorte alias for $1;

  ltotal numeric;
  lmenor30 numeric;
  ldias1_7 numeric;
  ldias8_30     numeric;
  ldias31_60    numeric;
  ldias61_90    numeric;
  ldias91_120   numeric;
  ldias121_180  numeric;
  lmayor180 numeric;

begin

    ltotal := 0;
    lmenor30 := 0;
    ldias1_7 := 0;
    ldias8_30 := 0;
    ldias31_60 := 0;
    ldias61_90 := 0;
    ldias91_120 := 0;
    ldias121_180 := 0;
    lmayor180 := 0;

    for r in
select f.descripcionfinalidad,t.desctipoprestamo,sum(p.reservacalculada),
       sum(case when p.diasvencidos=0
                then p.reservacalculada else 0 end) as menor30,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.reservacalculada else 0 end) as dias1_7,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.reservacalculada else 0 end) as dias8_30,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.reservacalculada else 0 end) as dias31_60,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.reservacalculada else 0 end) as dias61_90,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.reservacalculada else 0 end) as dias91_120,
       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.reservacalculada else 0 end) as dias121_180,
       sum(case when p.diasvencidos>180
                then p.reservacalculada else 0 end) as mayor180
  from precorte p, finalidades f, tipoprestamo t
 where p.fechacierre=pfechacorte and
       f.clavefinalidad = p.clavefinalidad and
       t.tipoprestamoid = p.tipoprestamoid
group by f.descripcionfinalidad,t.desctipoprestamo  
order by f.descripcionfinalidad,t.desctipoprestamo

    loop

      ltotal      := ltotal     +r.total;
      lmenor30    := lmenor30   +r.menor30;
      ldias1_7    := ldias1_7   +r.dias1_7;
      ldias8_30    := ldias8_30  + r.dias8_30;
      ldias31_60   := ldias31_60 + r.dias31_60;
      ldias61_90   := ldias61_90 + r.dias61_90;
      ldias91_120  := ldias91_120 + r.dias91_120;
      ldias121_180 := ldias121_180 + r.dias121_180;
      lmayor180   := lmayor180  +r.mayor180;

      return next r;
    end loop;

    r.descripcionfinalidad := ' ';
    r.desctipoprestamo := 'TOTALES ....';
    r.total      := ltotal     ;
    r.menor30    := lmenor30   ;
    r.dias1_7    := ldias1_7   ;
    r.dias8_30   := ldias8_30  ;
    r.dias31_60  := ldias31_60 ;
    r.dias61_90  := ldias61_90 ;
    r.dias91_120 := ldias91_120;
    r.dias121_180 := ldias121_180;
    r.mayor180   := lmayor180  ;
  
    return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsreservaxtipo(date) OWNER TO sistema;

--
-- Name: spsreservaxtipoc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsreservaxtipoc(date) RETURNS SETOF cartera
    AS $_$
declare
  pfechacorte alias for $1;
  r cartera%rowtype;

  ltotal numeric;
  lmenor30      numeric;
  ldias1_7      numeric;
  ldias8_30     numeric;
  ldias31_60    numeric;
  ldias61_90    numeric;
  ldias91_120   numeric;
  ldias121_180  numeric;
  lmayor180     numeric;


  iejercicio int4;
  iperiodo int4;

begin

  iejercicio := cast(date_part('year',pfechacorte) as int);
  iperiodo := cast(date_part('month',pfechacorte) as int);

    ltotal := 0;
    lmenor30 := 0;
    ldias1_7 := 0;
    ldias8_30 := 0;
    ldias31_60 := 0;
    ldias61_90 := 0;
    ldias91_120 := 0;
    ldias121_180 := 0;
    lmayor180 := 0;


    for r in
select f.descripcionfinalidad,t.desctipoprestamo,sum(p.reservacalculada),
       sum(case when p.diasvencidos=0
                then p.reservacalculada else 0 end) as menor30,
       sum(case when p.diasvencidos>0 and p.diasvencidos<8
                then p.reservacalculada else 0 end) as dias1_7,
       sum(case when p.diasvencidos>7 and p.diasvencidos<31
                then p.reservacalculada else 0 end) as dias8_30,
       sum(case when p.diasvencidos>30 and p.diasvencidos<61
                then p.reservacalculada else 0 end) as dias31_60,
       sum(case when p.diasvencidos>60 and p.diasvencidos<91
                then p.reservacalculada else 0 end) as dias61_90,
       sum(case when p.diasvencidos>90 and p.diasvencidos<121
                then p.reservacalculada else 0 end) as dias91_120,
       sum(case when p.diasvencidos>120 and p.diasvencidos<181
                then p.reservacalculada else 0 end) as dias121_180,
       sum(case when p.diasvencidos>180
                then p.reservacalculada else 0 end) as mayor180
  from spsprecortec(iejercicio,iperiodo) p, finalidades f, tipoprestamo t
 where f.clavefinalidad = p.clavefinalidad and
       t.tipoprestamoid = p.tipoprestamoid
group by f.descripcionfinalidad,t.desctipoprestamo  
order by f.descripcionfinalidad,t.desctipoprestamo

    loop

      ltotal      := ltotal     +r.total;
      lmenor30    := lmenor30   +r.menor30;
      ldias1_7    := ldias1_7   +r.dias1_7;
      ldias8_30    := ldias8_30  + r.dias8_30;
      ldias31_60   := ldias31_60 + r.dias31_60;
      ldias61_90   := ldias61_90 + r.dias61_90;
      ldias91_120  := ldias91_120 + r.dias91_120;
      ldias121_180 := ldias121_180 + r.dias121_180;
      lmayor180   := lmayor180  +r.mayor180;

      return next r;
    end loop;

    r.descripcionfinalidad := ' ';
    r.desctipoprestamo := 'TOTALES ....';
    r.total      := ltotal     ;
    r.menor30    := lmenor30   ;
    r.dias1_7    := ldias1_7   ;
    r.dias8_30   := ldias8_30  ;
    r.dias31_60  := ldias31_60 ;
    r.dias61_90  := ldias61_90 ;
    r.dias91_120 := ldias91_120;
    r.dias121_180 := ldias121_180;
    r.mayor180   := lmayor180  ;

    return next r;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsreservaxtipoc(date) OWNER TO sistema;

--
-- Name: spsresumencaptacionc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsresumencaptacionc(date) RETURNS SETOF tresumencaptacion
    AS $_$
declare

  pfecha alias for $1;
  r tresumencaptacion%rowtype;
  f record;
  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop

  raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

  dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb ;

  dblink2:='set search_path to public,'||f.esquema||'; select * from resumencaptacion('||''''||pfecha||''''||','||''''||'SUC'||''''||');';

  for r in
    select * from
    dblink(dblink1,dblink2) as
    t ( sucursal           char(4),
        desctipoinversion  char(30),
        clavesocioint      char(18),
        nombresocio        varchar(80),
        inversionid        int4,
        fechainversion     date,
        fechavencimiento   date,
        tasainteresnormalinversion numeric,
        plazo              int4,
        deposito           numeric,
        diasvencimiento    int4)

  loop
    return next r;
  end loop;


end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsresumencaptacionc(date) OWNER TO sistema;

--
-- Name: spsresumenprestamos(date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsresumenprestamos(date, character) RETURNS SETOF resumenprestamos
    AS $_$
declare
  pfecha alias for $1;
  psuc   alias for $2;
  r resumenprestamos%rowtype;
  
begin

    for r in
     select psuc as sucursal,
       f.descripcionfinalidad,pr.referenciaprestamo,s.clavesocioint,
       su.nombre||' '||su.paterno||' '||su.materno as nombresocio,
       p.fechacierre,
       (case when p.diasvencidos<=90
             then p.saldoprestamo
             else 0 end) as saldovencidomenoravencido,
       (case when p.diasvencidos>90
             then p.saldoprestamo
             else 0 end) as saldovencidomayoravencido,
       p.interesdevengadomenoravencido,p.interesdevengadomayoravencido,
       pr.montoprestamo,pr.tasanormal,pr.numero_de_amor,pr.fecha_otorga,
       pr.fecha_vencimiento,p.ultimoabono,
           (case when t.tantos>0 then p.montoprestamo/t.tantos
              else 0 end) as tantos,
       (case when p.saldovencidomayoravencido+p.saldovencidomenoravencido>0 then
          diasvencidos else 0 end) as diasmora,
       (select max(fechadepago)
          from amortizaciones
         where prestamoid=pr.prestamoid)-pfecha as diasporvencer
  from precorte p, finalidades f, prestamos pr, socio s, sujeto su, tipoprestamo t
 where p.fechacierre = pfecha and
       f.clavefinalidad = p.clavefinalidad and
       pr.prestamoid = p.prestamoid and
--       pr.saldoprestamo > 0 and
--       pr.claveestadocredito <> '008' and
       s.socioid = pr.socioid and
       su.sujetoid = s.sujetoid and
       t.tipoprestamoid = pr.tipoprestamoid       
order by s.clavesocioint

    loop
      if r.diasporvencer<0 then
        r.diasporvencer=0;
      end if;
      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsresumenprestamos(date, character) OWNER TO sistema;

--
-- Name: spsresumenprestamosc(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsresumenprestamosc(date) RETURNS SETOF resumenprestamos
    AS $_$
declare
  pfecha alias for $1;
  r resumenprestamos%rowtype;

  f record;
  dblink1 text;
  dblink2 text;

begin

for f in
 select * from sucursales where vigente='S'
 loop

        raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

        dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;

        dblink2:='set search_path to public,'||f.esquema||';select * from spsresumenprestamos('||''''||to_char(pfecha,'yyyy-mm-dd')||''''||','||''''||'SUC1'||''''||');';

for r in
    select * from
    dblink(dblink1,dblink2) as
    t ( sucursal                      char(4),
        descripcionfinalidad          varchar(30),
        referenciaprestamo            char(18),
        clavesocioint                 char(15),
        nombresocio                   varchar(82),
        fechacierre                   date,
        saldovencidomenoravencido     numeric,
        saldovencidomayoravencido     numeric,
        interesdevengadomenoravencido numeric,
        interesdevengadomayoravencido numeric,
        montoprestamo                 numeric,
        tasanormal                    numeric,
        numero_de_amor                int4,
        fecha_otorga                  date,
        fecha_vencimiento             date,
        ultimoabono                   date,
        tantos                        numeric,
        diasmora                      int4,
        diasporvencer                 int4)

  loop
    return next r;
  end loop;

  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsresumenprestamosc(date) OWNER TO sistema;

--
-- Name: spsrptxtipomovimiento(character, date, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsrptxtipomovimiento(character, date, date, character) RETURNS SETOF rptxtipomovimiento
    AS $_$
declare
  pclavesocioint alias for $1;
  pfechai alias for $2;
  pfechaf alias for $3;
  ptipomovimientoid alias for $4;

  r rptxtipomovimiento%rowtype;

  l record;
  
  lsocioid int4;

  fsaldoinicial numeric;
  fsaldofinal   numeric;
  finteres numeric;
  fi numeric;

  fdeposito numeric;
  fretiro numeric;
  finteresinver numeric;

  ftasa numeric;
  dfecha date;
  dfecha1 date;

  bprimer bool;
  stipomovimientoid char(2);
  sdopromedio numeric;
  ftasainteres numeric;
  gdiasanualesmov int4;
  idiames integer;

begin

 select diasanualesmov
    into gdiasanualesmov
    from empresa;

    idiames := cast(date_part('day',pfechaf) as int);
    dfecha1 := pfechaf - idiames;

    select socioid
      into lsocioid
      from socio
     where clavesocioint=pclavesocioint;

    select tasainteres
      into ftasa
      from tipomovimiento
     where tipomovimientoid=ptipomovimientoid;

    fsaldoinicial := 0;
    fi :=0;
    finteres := 0;

    dfecha := '1900-01-01';

    bprimer=true;


if ptipomovimientoid = 'IN' then

fsaldoinicial:=0;

for l in
    select m.tipomovimientoid,p.seriepoliza,m.referenciacaja,p.numero_poliza,
       p.fechapoliza,
       0 as saldoinicial,
       0 as depositos, 0 as retiros,
       0 as interes, 0 as saldofinal,
       m.polizaid,t.cuentapasivo,t.cuentaintinver,m.inversionid
      from movicaja m, inversion i, tipoinversion t, polizas p
     where m.socioid=lsocioid and m.tipomovimientoid = ptipomovimientoid and
           m.inversionid =  i.inversionid and
           t.tipoinversionid = i.tipoinversionid and
           p.polizaid = m.polizaid and           
           p.fechapoliza <= pfechaf
     group by m.tipomovimientoid,p.seriepoliza,m.referenciacaja,p.numero_poliza,
       p.fechapoliza, m.polizaid,t.cuentapasivo,t.cuentaintinver,m.inversionid
   order by p.fechapoliza
           
  loop

    select coalesce(sum(haber),0) into fdeposito
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentapasivo and debe=0;

    select coalesce(sum(debe),0) into fretiro
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentapasivo and haber=0;

    select coalesce(sum(debe),0) into finteresinver
      from movipolizas
     where polizaid = l.polizaid and
           cuentaid = l.cuentaintinver and haber=0;

      if l.fechapoliza<pfechai then
        fsaldoinicial := fsaldoinicial + fdeposito - fretiro;
        fsaldofinal := fsaldoinicial;

      else

	r.tipomovimientoid := l.tipomovimientoid;
        r.serie := l.seriepoliza;
        r.referencia := l.referenciacaja;    
	r.numero_poliza := l.numero_poliza;
        r.fecha := l.fechapoliza;

	r.saldoinicial:= fsaldoinicial;
	r.depositos := fdeposito;
	r.retiros := fretiro;
	r.interes := finteresinver;

	r.saldofinal := r.saldoinicial+r.depositos- r.retiros;

        fsaldoinicial:= fsaldoinicial+r.depositos- r.retiros;

        return next r;

      end if;

    end loop;
    
     
else

for r in 
select m.tipomovimientoid,p.seriepoliza,m.referenciacaja,p.numero_poliza,
       p.fechapoliza as fecha,
       0 as saldoinicial,
       mp.debe as depositos, mp.haber as retiros,
       0 as interes, 0 as saldofinal
  from movicaja m, movipolizas mp, polizas p
 where m.socioid=lsocioid and
       (ptipomovimientoid='  ' or m.tipomovimientoid=ptipomovimientoid) and
       mp.movipolizaid=m.movipolizaid and
       p.polizaid = m.polizaid and
       p.fechapoliza<=pfechaf      
order by m.tipomovimientoid,p.fechapoliza,mp.haber 

    loop
      if bprimer=true then
        stipomovimientoid=r.tipomovimientoid;
       
      else
        if stipomovimientoid<>r.tipomovimientoid then
          fsaldoinicial:=0;
          stipomovimientoid=r.tipomovimientoid;
          select saldopromedio into sdopromedio from saldopromedio(lsocioid,dfecha1,pfechaf,stipomovimientoid);
          select tasainteres into ftasainteres from tipomovimiento where tipomovimientoid=stipomovimientoid;
          ftasainteres:=coalesce(ftasainteres,0);
          r.interes:=(round(sdopromedio*(pfechaf-dfecha1)*ftasainteres/100/gdiasanualesmov,2));
        
        end if;
      end if;

      if r.fecha<pfechai then
        fsaldoinicial := fsaldoinicial + r.depositos - r.retiros;
        fsaldofinal := fsaldoinicial;       
      else

        if bprimer=true then
                select saldopromedio into sdopromedio from saldopromedio(lsocioid,dfecha1,pfechaf,stipomovimientoid);
                select tasainteres into ftasainteres from tipomovimiento where tipomovimientoid=stipomovimientoid;
                ftasainteres:=coalesce(ftasainteres,0);
                r.interes:=(round(sdopromedio*(pfechaf-dfecha1)*ftasainteres/100/gdiasanualesmov,2));
                bprimer=false;
        end if;
        r.saldoinicial := fsaldoinicial;
        r.saldofinal := r.saldoinicial + r.depositos - r.retiros;
        fsaldofinal:= r.saldofinal;
        fsaldoinicial := r.saldofinal;

        if r.tipomovimientoid = 'IN' then

          if r.saldofinal < 0 then
            r.retiros:=r.retiros + r.saldofinal;
            r.interes:=abs(r.saldofinal);
            r.saldofinal:=  r.saldoinicial + r.depositos - r.retiros;
            fsaldoinicial := r.saldofinal;

          end if;
        end if;
      

        return next r;
      end if;
     
      
    end loop;

    if fsaldoinicial=fsaldofinal and bprimer=true then
           r.saldoinicial := fsaldoinicial;
           r.depositos := 0;
           r.retiros := 0;
           r.saldofinal := fsaldoinicial;
           r.tipomovimientoid:=stipomovimientoid;
       
           select saldopromedio into sdopromedio from saldopromedio(lsocioid,dfecha1,pfechaf,stipomovimientoid);
           select tasainteres into ftasainteres from tipomovimiento where tipomovimientoid=stipomovimientoid;
           ftasainteres:=coalesce(ftasainteres,0);
           r.interes:=(round(sdopromedio*(pfechaf-dfecha1)*ftasainteres/100/gdiasanualesmov,2));
           return next r;
     end if;

end if;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsrptxtipomovimiento(character, date, date, character) OWNER TO sistema;

--
-- Name: spssaldofechacorte(character, character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssaldofechacorte(character, character, date, integer) RETURNS SETOF rsaldofechacorte
    AS $_$
declare  
  r rsaldofechacorte%rowtype;
  psocioi alias for $1;
  psociof alias for $2;
  pfechac alias for $3;
  pvencidos alias for $4;

  diasatraso int;

begin

  diasatraso:=0;

    for r in
  select p.prestamoid,p.clavesocioint, p.referenciaprestamo,
         p.nombre,p.fecha_otorga, p.fecha_vencimiento, p.montoprestamo,
	 p.saldoprest, p.diasatraso, p.amortizacion, p.capital,p.interes,p.moratorio,
         p.iva,p.vencidas,p.fecha_ultimopago,p.direccion||' '||p.comunidad,p.telefono        
    from carteracomunidadfecha p, prestamos pr
   where p.fechadegeneracion=pfechac and p.prestamoid = pr.prestamoid and p.saldoprest > 0 and (case when pvencidos=1 then
         p.fecha_vencimiento <= pfechac else p.fecha_otorga <= p.fecha_vencimiento end) and p.fecha_otorga<=pfechac and
         p.clavesocioint>=psocioi and p.clavesocioint<=psociof        
   order by p.clavesocioint
    loop
      --raise notice '% %',r.prestamoid,pfechac;
      return next r;
    end loop;

   

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssaldofechacorte(character, character, date, integer) OWNER TO sistema;

--
-- Name: spssaldofechacortec(character, character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssaldofechacortec(character, character, date, integer) RETURNS SETOF rsaldofechacorte
    AS $_$
declare

  r rsaldofechacorte%rowtype;
  psocioi alias for $1;
  psociof alias for $2;
  pfechac alias for $3;
  pvencidos alias for $4;
  f record;
  dblink1 text;
  dblink2 text;

begin

for f in
  select * from sucursales where vigente='S'
  loop

    raise notice 'Conectando sucursal % % ',f.basededatos,f.esquema;

    dblink1:='host='||f.host||' dbname='||f.basededatos||' user='||f.usuariodb||' password='||f.passworddb;
    dblink2:='set search_path to public,'||f.esquema||';select * from spssaldofechacorte('||''''||psocioi||''''||','||''''||psociof||''''||','||''''|| pfechac ||''''||','||pvencidos||');';

    for r in SELECT * FROM
        dblink(dblink1,dblink2) as
        t2(
        prestamoid          int4,
 clavesocioint       char(15),
 referenciaprestamo  char(18),
 nombre              varchar(80),
 fecha_otorga        date,
 fecha_vencimiento   date,
 montoprestamo       numeric,
 saldoprest          numeric,
 diasatraso          numeric,
 amortizacion        numeric,
 capital             numeric,
 interes             numeric,
 moratorio           numeric,
 iva                 numeric,
 vencidas            numeric,
 fechaultimopago     date,
 direccion           char(256),
 telefono            char(20))
    loop
      return next r;
    end loop;

end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssaldofechacortec(character, character, date, integer) OWNER TO sistema;

--
-- Name: spssaldosmov(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssaldosmov(integer) RETURNS SETOF tsaldosmov
    AS $_$
declare
  r tsaldosmov%rowtype;
  psocioid alias for $1;
begin

    for r in
      select mc.tipomovimientoid, tm.desctipomovimiento,
             sum(mp.debe)-sum(mp.haber) as saldo
        from movicaja mc, movipolizas mp, tipomovimiento tm
       where mc.socioid=psocioid and
             mp.movipolizaid=mc.movipolizaid and
             tm.tipomovimientoid=mc.tipomovimientoid and
             mc.tipomovimientoid<>'00' and
             mc.tipomovimientoid<>'IN' and
             tm.aplicasaldo='S'
      group by mc.tipomovimientoid,tm.desctipomovimiento
      order by mc.tipomovimientoid
    loop
      return next r;
    end loop;

    -- Calcular el saldo para la inversion tomando movimientos de la cuenta de pasivo de
    -- la inversion
    for r in
       SELECT m.tipomovimientoid,tm.desctipomovimiento, -sum(debe)+sum(haber) as saldo
         from movicaja m, polizas p,tipoinversion t,movipolizas mp,inversion i,tipomovimiento tm
        where m.socioid=psocioid and m.tipomovimientoid='IN' and p.polizaid=m.polizaid and
              i.inversionid = m.inversionid and
              t.tipoinversionid=i.tipoinversionid and mp.polizaid=m.polizaid and
              mp.cuentaid = t.cuentapasivo and
              tm.tipomovimientoid=m.tipomovimientoid and
	      t.tipoinversionid <> 'K3'
      group by m.tipomovimientoid,tm.desctipomovimiento
    loop
        return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssaldosmov(integer) OWNER TO sistema;

--
-- Name: spssaldosmovf(integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssaldosmovf(integer, date) RETURNS SETOF tsaldosmov
    AS $_$
declare
  psocioid alias for $1;
  pfecha alias for $2;
  
  r tsaldosmov%rowtype;

begin

    for r in

      select mc.tipomovimientoid, tm.desctipomovimiento, sum(mp.debe)-sum(mp.haber) as saldo
        from movicaja mc, movipolizas mp, tipomovimiento tm, polizas p
       where mc.socioid=psocioid and
             mp.movipolizaid=mc.movipolizaid and
             tm.tipomovimientoid=mc.tipomovimientoid and
             mc.tipomovimientoid<>'00' and
             mc.tipomovimientoid<>'IN' and
             p.polizaid = mc.polizaid and
             p.fechapoliza < pfecha+1 and
             tm.aplicasaldo='S'
      group by mc.tipomovimientoid,tm.desctipomovimiento
      order by mc.tipomovimientoid
    loop
      return next r;
    end loop;

    -- Calcular el saldo para la inversion tomando movimientos de la cuenta de pasivo de
    -- la inversion
    for r in
       SELECT m.tipomovimientoid,tm.desctipomovimiento, -sum(debe)+sum(haber) as saldo
         from movicaja m, polizas p,tipoinversion t,movipolizas mp,inversion i,tipomovimiento tm
        where m.socioid=psocioid and m.tipomovimientoid='IN' and t.tipoinversionid <> 'K3' and p.polizaid=m.polizaid and
              p.fechapoliza < pfecha+1 and
              i.inversionid = m.inversionid and
              t.tipoinversionid=i.tipoinversionid and mp.polizaid=m.polizaid and
              mp.cuentaid = t.cuentapasivo and
              tm.tipomovimientoid=m.tipomovimientoid
      group by m.tipomovimientoid,tm.desctipomovimiento
    loop
        return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssaldosmovf(integer, date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: scoring; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE scoring (
    scoringid integer NOT NULL,
    solicitudprestamoid integer NOT NULL,
    avalid integer NOT NULL,
    genero integer,
    estadocivil integer,
    tipovivienda integer,
    tiempoendomicilio integer,
    tiempoentrabajo integer,
    ingresomensual numeric,
    egresomensual numeric,
    dependienteseconomicos integer,
    calificacionburo integer,
    telefono1 character(20),
    telefono2 character(20),
    fuenteingreso character(30),
    actividad character(30),
    verificado integer,
    obs text
);


ALTER TABLE sucursal1.scoring OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsscoring(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsscoring(integer) RETURNS SETOF sucursal1.scoring
    AS $_$
declare
  r scoring%rowtype;
  pclave alias for $1;
begin


    for r in
      select * from scoring where avalid=pclave

    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsscoring(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: socio; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE socio (
    socioid integer NOT NULL,
    sujetoid integer NOT NULL,
    tiposocioid character(2) NOT NULL,
    clavesocioint character(15) NOT NULL,
    fechaalta date NOT NULL,
    fechabaja date,
    estatussocio integer DEFAULT 1,
    solicitudingresoid integer,
    motivobajaid integer,
    promotorid character(20)
);


ALTER TABLE sucursal1.socio OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spssocio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssocio(integer) RETURNS SETOF sucursal1.socio
    AS $_$
declare
  r socio%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select socioid,sujetoid,tiposocioid,clavesocioint,fechaalta,fechabaja,estatussocio,solicitudingresoid,motivobajaid
      from socio where socioid=pclave 
    loop
      return next r;
    end loop;
  else
    for r in
      select socioid,sujetoid,tiposocioid,clavesocioint,fechaalta,fechabaja,estatussocio,solicitudingresoid,motivobajaid
      from socio
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssocio(integer) OWNER TO sistema;

--
-- Name: spssocio(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssocio(character) RETURNS SETOF sucursal1.socio
    AS $_$
declare
  r socio%rowtype;
  pclave alias for $1;
begin

  if pclave<>'   ' then
    for r in
      select socioid,sujetoid,tiposocioid,clavesocioint,fechaalta,fechabaja,estatussocio,solicitudingresoid,motivobajaid 
      from socio where clavesocioint=pclave 
    loop
      return next r;
    end loop;
  else
      for r in
      select socioid,sujetoid,tiposocioid,clavesocioint,fechaalta,fechabaja,estatussocio,solicitudingresoid,motivobajaid 
      from socio
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssocio(character) OWNER TO sistema;

--
-- Name: spssociocaja(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssociocaja() RETURNS SETOF tsociocaja
    AS $$
declare
  r tsociocaja%rowtype;

begin

    for r in
      select s.socioid,s.clavesocioint,j.paterno,j.materno,j.nombre,tp.descritiposocio as estatus
        from socio s, sujeto j, tiposocio tp
       where j.sujetoid = s.sujetoid and
             tp.tiposocioid = s.tiposocioid
      order by s.clavesocioint
    loop
      return next r;
    end loop;

return;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssociocaja() OWNER TO sistema;

--
-- Name: spssociocajaf(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssociocajaf(text) RETURNS SETOF tsociocaja
    AS $_$
declare
  pfiltro alias for $1; 
  r tsociocaja%rowtype;
  filtro text;
begin

    filtro := pfiltro || '%';
    for r in
      select s.socioid,s.clavesocioint,j.paterno,j.materno,j.nombre,tp.descritiposocio as estatus
        from socio s, sujeto j,tiposocio tp
       where j.sujetoid = s.sujetoid and         
             (s.clavesocioint like filtro or
              (j.nombre||' '||j.paterno||' '||j.materno) like filtro or
              (j.paterno||' '||j.materno||' '||j.nombre) like filtro) and
             tp.tiposocioid = s.tiposocioid              
      order by s.clavesocioint
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssociocajaf(text) OWNER TO sistema;

--
-- Name: spssociomensaje(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssociomensaje(text) RETURNS SETOF tsociocaja
    AS $_$
declare
  pfiltro alias for $1; 
  r tsociocaja%rowtype;
  filtro text;
begin

    filtro := pfiltro || '%';
    for r in
      select s.socioid,s.clavesocioint,j.paterno,j.materno,j.nombre,tp.descritiposocio as estatus
        from socio s, sujeto j,tiposocio tp
       where j.sujetoid = s.sujetoid and         
             (s.clavesocioint like filtro or
              (j.nombre||' '||j.paterno||' '||j.materno) like filtro or
              (j.paterno||' '||j.materno||' '||j.nombre) like filtro) and
             tp.tiposocioid = s.tiposocioid              
      order by s.clavesocioint
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssociomensaje(text) OWNER TO sistema;

--
-- Name: spssocioprestamo(text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssocioprestamo(text) RETURNS SETOF tsociocaja
    AS $_$
declare
  pfiltro alias for $1; 
  r tsociocaja%rowtype;
  filtro text;
begin

    filtro := pfiltro || '%';
    for r in
      select s.socioid,s.clavesocioint,j.paterno,j.materno,j.nombre,tp.descritiposocio as estatus
        from socio s, sujeto j,tiposocio tp
       where j.sujetoid = s.sujetoid and         
             (s.clavesocioint like filtro or
              (j.nombre||' '||j.paterno||' '||j.materno) like filtro or
              (j.paterno||' '||j.materno||' '||j.nombre) like filtro) and
             tp.tiposocioid = s.tiposocioid and socioid in (select socioid from prestamos where saldoprestamo > 0)              
      order by s.clavesocioint
    loop
      return next r;
    end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssocioprestamo(text) OWNER TO sistema;

--
-- Name: spssociosxtipomovimiento(character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssociosxtipomovimiento(character, date) RETURNS SETOF sociosxtipomovimiento
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pfecha alias for $2;
  r sociosxtipomovimiento%rowtype;

begin

  for r in 
  select mc.socioid, s.clavesocioint, sum(mp.debe)-sum(mp.haber) as saldo from movicaja mc, polizas p, movipolizas mp, socio s where mc.tipomovimientoid=ptipomovimientoid and mp.movipolizaid=mc.movipolizaid and p.polizaid=mc.polizaid and p.fechapoliza<pfecha+1 and mc.socioid=s.socioid group by mc.socioid,s.clavesocioint having sum(mp.debe)-sum(mp.haber) > 0
  loop

        return next r;
  end loop;

  return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssociosxtipomovimiento(character, date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: solicitudingreso; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE solicitudingreso (
    solicitudingresoid integer NOT NULL,
    nosolicitud integer NOT NULL,
    fechasolicitud date NOT NULL,
    fechaingreso date,
    socioid integer,
    sujetoid integer NOT NULL,
    ciudadmexid integer NOT NULL,
    sexo integer NOT NULL,
    nivelestudiosid integer NOT NULL,
    profesion character varying(40),
    ocupacion character varying(40),
    tipocasaid integer NOT NULL,
    estadocivilid integer NOT NULL,
    conyugeid integer,
    regimenmatrimonial integer,
    tiempovivirendomicilio character varying(15),
    motivoingresoid integer NOT NULL,
    medioseenteroid integer NOT NULL,
    perteneceaotracaja integer NOT NULL,
    otracaja character varying(40),
    claveescuela character varying(20),
    nombreescuela character varying(50),
    personaautorizadaid integer,
    usuarioid character(20) NOT NULL,
    lastusuarioid character(20) NOT NULL,
    lastupdate date NOT NULL,
    tiposocioid character(2) NOT NULL,
    observaciones text,
    doccompleta integer,
    docfaltante text,
    personajuridicaid integer,
    grupo character(25),
    cta character(25)
);


ALTER TABLE sucursal1.solicitudingreso OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spssolicitudingreso(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssolicitudingreso(integer) RETURNS SETOF sucursal1.solicitudingreso
    AS $_$
declare
  r solicitudingreso%rowtype;
  pclave alias for $1;
begin

  for r in
    select * 
      from solicitudingreso where nosolicitud=pclave 
    loop
      return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssolicitudingreso(integer) OWNER TO sistema;

--
-- Name: spssolicitudingreso(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssolicitudingreso(character) RETURNS SETOF sucursal1.solicitudingreso
    AS $_$
declare
  r solicitudingreso%rowtype;
  pclave alias for $1;
begin

  for r in
    select * 
      from solicitudingreso s, socio so
     where so.clavesocioint=pclave and
           s.socioid=so.socioid 
    loop
      return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssolicitudingreso(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: solicitudprestamo; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE solicitudprestamo (
    solicitudprestamoid integer NOT NULL,
    socioid integer NOT NULL,
    sujetoid integer NOT NULL,
    tipoprestamoid character(3) NOT NULL,
    clavefinalidad character(3) NOT NULL,
    clavegarantia character(3) NOT NULL,
    domicilioid integer,
    nosolicitud integer NOT NULL,
    fechasolicitud date NOT NULL,
    sueldo numeric,
    sueldoconyuge numeric,
    otrosingresos numeric,
    totalingresos numeric,
    gastosordinarios numeric,
    otrosgastos numeric,
    otrosabonos numeric,
    totalegresos numeric,
    capacidadpago numeric,
    valorpropiedades numeric,
    totaldeudas numeric,
    abonospropuestos integer,
    montosolicitado numeric,
    periodopagoid integer,
    tasanormal numeric,
    tasamoratorio numeric,
    fecharesultado date,
    fechaentrega date,
    actano character varying(30),
    fechacomite date,
    resolucionid integer,
    entregado integer,
    usuarioid character(20) NOT NULL,
    lastusuarioid character(20) NOT NULL,
    lastupdate date,
    primerpago date,
    empresatrabaja character varying(80),
    jefedirecto character varying(50),
    verificado integer,
    obsinvestigacion text,
    observaciones text,
    presidente character varying(50),
    vicepresidente character varying(50),
    oficialcredito character varying(50),
    analistacredito character varying(50),
    secretario character varying(50),
    dias_de_cobro integer,
    meses_de_cobro integer,
    dia_mes_cobro integer,
    estatus integer,
    obsingresos text,
    tiempoendomicilio integer,
    tiempoentrabajo integer,
    dependienteseconomicos integer,
    calificacionburo integer,
    grupo character(25),
    contratogrupo integer
);


ALTER TABLE sucursal1.solicitudprestamo OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spssolicitudprestamo(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssolicitudprestamo(integer) RETURNS SETOF sucursal1.solicitudprestamo
    AS $_$
declare
  r solicitudprestamo%rowtype;
  pclave alias for $1;
begin

  for r in
    select * 
      from solicitudprestamo where nosolicitud=pclave 
    loop
      return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssolicitudprestamo(integer) OWNER TO sistema;

--
-- Name: spssolicitudprestamou(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssolicitudprestamou(integer) RETURNS SETOF sucursal1.solicitudprestamo
    AS $_$
declare
  r solicitudprestamo%rowtype;
  psocioid alias for $1;

  lsolicitudprestamoid int4;

begin

  select max(solicitudprestamoid)
    into lsolicitudprestamoid
    from solicitudprestamo
   where socioid=psocioid;

  for r in
    select * 
      from solicitudprestamo
     where solicitudprestamoid=lsolicitudprestamoid
    loop
      return next r;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssolicitudprestamou(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: subrango; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE subrango (
    subrangoid integer NOT NULL,
    rangoid integer NOT NULL,
    rangoinicial character(24) NOT NULL,
    rangofinal character(24) NOT NULL,
    operacion integer DEFAULT 1 NOT NULL,
    factor numeric DEFAULT 1 NOT NULL
);


ALTER TABLE sucursal1.subrango OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spssubrango(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssubrango(integer) RETURNS SETOF sucursal1.subrango
    AS $_$
declare
  r subrango%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select subrangoid,rangoid,rangoinicial,rangofinal,operacion,factor
        from subrango where rangoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select subrangoid,rangoid,rangoinicial,rangofinal,operacion,factor
        from subrango order by subrangoid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssubrango(integer) OWNER TO sistema;

--
-- Name: spssucursal(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssucursal(integer) RETURNS SETOF rsucursalesenlace
    AS $_$
declare
  r rsucursalesenlace%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select sucursalid,basededatos from sucursales where sucursalid=pclave order by sucursalid
    loop
      return next r;
    end loop;
  else
    for r in
      select sucursalid,basededatos from sucursales order by sucursalid   
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssucursal(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: sujeto; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE sujeto (
    sujetoid integer NOT NULL,
    paterno character varying(20) NOT NULL,
    materno character varying(20),
    nombre character varying(40) NOT NULL,
    rfc character(16),
    curp character(20),
    edad numeric,
    fecha_nacimiento date,
    razonsocial character varying(60)
);


ALTER TABLE sucursal1.sujeto OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spssujeto(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssujeto(integer) RETURNS SETOF sucursal1.sujeto
    AS $_$
declare
  r sujeto%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select sujetoid,paterno,materno,nombre,rfc,curp,edad,fecha_nacimiento,razonsocial from sujeto where sujetoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select sujetoid,paterno,materno,nombre,rfc,curp,edad,fecha_nacimiento,razonsocial from sujeto order by sujetoid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssujeto(integer) OWNER TO sistema;

--
-- Name: spssujeto(character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssujeto(character, character, character, character) RETURNS text
    AS $_$
declare

  pnombre alias for $1;
  ppaterno alias for $2;
  pmaterno alias for $3;
  prfc alias for $4;

  r record;
  a record;
  b record;
  c record;
  e record;
  s record;
  f record;
  p record;

  stexto text;
begin

  stexto:='';


  raise notice 'Conectando sucursal ALTA';
  for r in 
   select * from
    dblink('host=localhost dbname='||current_database()||' user=sistema',
           'set search_path to '||current_setting('search_path')||';select su.sujetoid,su.paterno,su.materno,su.nombre,su.rfc,su.curp,su.edad,su.fecha_nacimiento,su.razonsocial from sujeto su where rtrim(nombre)='||''''||pnombre||''''||' and rtrim(paterno)='||''''||ppaterno||''''||' and rtrim(materno)='||''''||pmaterno||''''||';' )
      as t2(sujetoid          integer,  
            paterno           varchar(20),
            materno           varchar(20),
            nombre            varchar(40),
            rfc               char(16),    
            curp              char(20),            
            edad              numeric,            
            fecha_nacimiento  date,
            razonsocial       varchar(60))

    loop


      for s in
       select * from
       dblink('host=localhost dbname='||current_database()||' user=sistema',
              'set search_path to '||current_setting('search_path')||';select s.clavesocioint, s.estatussocio,s.socioid from socio s where s.sujetoid='||r.sujetoid||';' )
      as t2(clavesocioint     char(15),
            estatussocio      integer,
            socioid           integer)
      loop
       stexto:=stexto||chr(13)||chr(10)||
                       chr(13)||chr(10)||
                     '  El sujeto es el socio: '||s.clavesocioint||
                     (case when s.estatussocio = 1 then        ', Socio Activo      '
                     else ( case when s.estatussocio = 2 then  ', Socio Dado de Baja'
                            else                               ', Socio Activo      '
                            end)
                      end)

||chr(13)||chr(10)||chr(13)||chr(10);

-- Poner Saldos solo si es socio
        for f in
         select * from
         dblink('host=localhost dbname='||current_database()||' user=sistema',
              'set search_path to '||current_setting('search_path')||';select * from spssaldosmovf('||s.socioid||','||''''||current_date||''''||');' )
          as t2(tipomovimientoid char(2),
                desctipomovimiento   char(30),
                saldo                numeric)
        loop
          stexto:=stexto||f.tipomovimientoid||' '||rpad(f.desctipomovimiento,30,' ')||'     '||
                  to_char(f.saldo,'$999,999.99')||chr(13)||chr(10);
        end loop;

-- Poner prestamos si es que tiene

        stexto:=stexto||chr(13)||chr(10);
  
        for p in
         select referenciaprestamo,montoprestamo,saldoprestamo from
         dblink('host=localhost dbname='||current_database()||' user=sistema',
              'set search_path to '||current_setting('search_path')||';select referenciaprestamo,montoprestamo,saldoprestamo from spsprestamos('||s.socioid||');' )
          as t2(referenciaprestamo   char(18),
                montoprestamo        numeric,
                saldoprestamo        numeric)
        loop
          stexto:=stexto||' Prestamo Actual'||chr(13)||chr(10)||
          'Ref. Prestamo: '||p.referenciaprestamo||',  Monto  del Prestamo: '||to_char(p.montoprestamo,'$999,999.99')||',  Saldo: '||to_char(p.saldoprestamo,'$999,999.99')||chr(13)||chr(10)||chr(13)||chr(10);
        end loop;



     end loop;

     stexto:=stexto|| chr(13)||chr(10)||
                     '  Nombre: '||r.nombre||' '||r.paterno||' '||r.materno||chr(13)||chr(10)||
                     '  RFC: '||r.rfc||',  CURP: '||r.curp||chr(13)||chr(10)||
                     '  Edad: '||r.edad||',  Fecha Nacimiento: '||r.fecha_nacimiento||chr(13)||chr(10)||
                     '  Razon Social: '||r.razonsocial||chr(13)||chr(10)||chr(13)||chr(10);

     raise notice 'SujetoID  %',r.sujetoid;

     -- Verificar si es beneficiario de alguna inversion
     for b in 
     select * from
      dblink('host=localhost dbname='||current_database()||' user=sistema',              
             'set search_path to '||current_setting('search_path')||';select b.beneficiarioid,b.inversionid,b.socioid,s.clavesocioint,i.referenciainversion,i.depositoinversion from beneficiario b,socio s,inversion i where i.inversionid=b.inversionid and s.socioid=i.socioid and b.sujetoid='||r.sujetoid||';' )
      as t2(beneficiarioid      integer,
            inversionid         integer,
            socioid             integer,
            clavesocioint       char(15),
            referenciainversion int4,
            depositoinversion   numeric)

      loop 
        stexto:=stexto||'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||chr(13)||chr(10)||'Es Beneficiario del Socio: '||b.clavesocioint||',  Ref. Inversion: '||to_char(b.referenciainversion,'99999')||',  Dep. Inversion: '||to_char(b.depositoinversion,'$999,999,999.99')||chr(13)||chr(10)||chr(13)||chr(10);
        
      end loop;

     -- Verificar si es aval de algun prestamo

     for a in 
     select * from
      dblink('host=localhost dbname='||current_database()||' user=sistema',
             'set search_path to '||current_setting('search_path')||';select s.clavesocioint,p.referenciaprestamo,p.montoprestamo,a.porcentajeavala,p.saldoprestamo from avales a, prestamos p, socio s where p.prestamoid=a.prestamoid and s.socioid=p.socioid and a.sujetoid='||r.sujetoid||';' )
      as t2(clavesocioint char(15),
            referenciaprestamo char(18),
            montoprestamo numeric,
            porcentajeavala numeric,
            saldoprestamo numeric)

      loop 
        stexto:=stexto||'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||chr(13)||chr(10)||
        'Es Aval  del Socio: '||a.clavesocioint||',  Ref.: '||a.referenciaprestamo||',  Monto: '||to_char(a.montoprestamo,'$999,999,999.99')||',  Avala: '||to_char(a.porcentajeavala,'999.99%')||chr(13)||chr(10)||' Saldo: '||to_char(a.saldoprestamo,'$999,999,999.99')||chr(13)||chr(10)||chr(13)||chr(10);
         
      end loop;


      -- Verificar si es esta relacionado con algun socio

     
     for c in 
     select * from
      dblink('host=localhost dbname='||current_database()||' user=sistema',
             'set search_path to '||current_setting('search_path')||';select s.clavesocioint,si.nosolicitud,re.esbenficiario,re.esreferenciapersonal,re.esrepresentante,re.parentesco,re.porcentaje from relacion re,solicitudingreso si, socio s where si.solicitudingresoid=re.solicitudingresoid and s.socioid=si.socioid and re.sujetoid='||r.sujetoid||';' )
      as t2(clavesocioint        char(15),
            nosolicitud          int4,
            esbenficiario        int4,
            esreferenciapersonal int4,
            esrepresentante      int4,
            parentesco           varchar(20),
            porcentaje           numeric)

      loop

        raise notice 'Entrando a loop';
        stexto:=stexto||'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||chr(13)||chr(10)||
        'Es Relacion del Socio: '||c.clavesocioint||',  NoSolicitud.: '||to_char(c.nosolicitud,'99999')||'';
        if c.esbenficiario=1 then
          stexto:=stexto||',  Es Beneficiario';
        end if;
        if c.esreferenciapersonal=1 then
          stexto:=stexto||',  Es Ref. Personal';
        end if;
        if c.esrepresentante=1 then
          stexto:=stexto||',  Es Representante';
        end if;
        stexto:=stexto||chr(13)||chr(10)||
        'Parentesco: '||c.parentesco||',  Pocentaje:'||to_char(c.porcentaje,'999.99%')||chr(13)||chr(10)||chr(13)||chr(10);
      end loop;



 -- Verificar si es conyugue de  un  socio

     for e in 
     select * from
      dblink('host=localhost dbname='||current_database()||' user=sistema',
             'set search_path to '||current_setting('search_path')||';select s.clavesocioint,si.nosolicitud from solicitudingreso si,sujeto su,socio s where si.conyugeid=su.sujetoid and s.socioid=si.socioid and si.conyugeid='||r.sujetoid||';' )
      as t2(clavesocioint char(15),
            nosolicitud   int4)

      loop 
        stexto:=stexto||'__________________________________________________________________________________________________________________________________'||chr(13)||chr(10)||chr(13)||chr(10)||
'Es Conyugue del Socio: '||e.clavesocioint||',  No Solicitud: '||e.nosolicitud||chr(13)||chr(10)||chr(13)||chr(10);
        
      end loop;

    end loop;

    return stexto;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssujeto(character, character, character, character) OWNER TO sistema;

--
-- Name: spssujetos(character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spssujetos(character varying) RETURNS SETOF sucursal1.sujeto
    AS $_$
declare
  r sujeto%rowtype;
  pclave alias for $1;
  filtro text;
begin

    filtro := pclave || '%';
    for r in
      select s.sujetoid,s.paterno,s.materno,s.nombre,s.rfc,s.curp,s.edad,
             s.fecha_nacimiento,s.razonsocial
        from sujeto s
       where
             not exists (select sujetoid from socio where socio.sujetoid=s.sujetoid) and
             (upper(s.nombre||' '||s.paterno||' '||s.materno) like upper(filtro) or
              upper(s.paterno||' '||s.materno||' '||s.nombre) like upper(filtro) or
             upper(s.nombre)  like upper(filtro) or
             upper(s.paterno) like upper(filtro) or
             upper(s.materno) like upper(filtro))
    loop
      return next r;
    end loop;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spssujetos(character varying) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tablon; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tablon (
    tablonid integer NOT NULL,
    socioid integer NOT NULL,
    fechatablon date NOT NULL,
    textotablon text NOT NULL,
    vigente character(1) DEFAULT 'S'::bpchar NOT NULL,
    usuarioid character(20) NOT NULL,
    fechavigencia date NOT NULL
);


ALTER TABLE sucursal1.tablon OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstablon(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstablon(integer) RETURNS SETOF sucursal1.tablon
    AS $_$
declare

 ptablonid alias for $1;
 r tablon%rowtype;

begin

  if ptablonid>0 then
    for r in
      select * from tablon
       where tablonid=ptablonid
    loop
      return next r;
    end loop;
  else
    for r in
      select * from tablon
       where tablonid=ptablonid and
             vigente='S'
    loop
      return next r;
    end loop;
  end if;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstablon(integer) OWNER TO sistema;

--
-- Name: spstablonsocio(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstablonsocio(integer) RETURNS SETOF sucursal1.tablon
    AS $_$
declare

 psocioid alias for $1;

 stexto text;
 r tablon%rowtype;


 ptablonid int4;
 lprestamoid int4;
 lmoratorio numeric;
 

begin

    select pr.prestamoid
    into lprestamoid
    from prestamos pr
    where saldoprestamo>0 and pr.socioid=psocioid and claveestadocredito<>'008';

    SELECT moratorio
    into lmoratorio
    FROM spscalculopago(lprestamoid)
    where vencidas>0;  

    delete
    from tablon
    where tablonid=1;

    insert into tablon (tablonid,socioid,fechatablon,textotablon,vigente,usuarioid,fechavigencia)
    values (1,200,'2009-09-25','','S','supervisor','2009-09-25');
    
    select tablonid
    into ptablonid
    from tablon
    where tablonid=1;
    
    if lmoratorio>0  then
    
    update tablon
    set socioid=psocioid,
        fechatablon=current_date,
        fechavigencia=current_date,
        textotablon='Estimado CAJERO: Por favor comunique y canalice al GERENTE de sucursal  EJECUTIVO de Crdito, la situacin del socio a la brevedad posible.'
    where tablonid=ptablonid;

        end if;
        
    
    stexto:='';

    for r in
      select *
        from tablon
       where socioid=psocioid and 
             vigente='S'
    loop
      stexto:=stexto||r.textotablon||chr(10)||chr(10);
    end loop;

    r.textotablon:=stexto;
    return next r;
    
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstablonsocio(integer) OWNER TO sistema;

--
-- Name: spstasastipoprestamo(character, numeric, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstasastipoprestamo(character, numeric, integer, character) RETURNS SETOF ttasastipoprestamo
    AS $_$
declare
  ptipoprestamoid alias for $1;
  pmontoprestamo alias for $2;
  psocioid alias for $3;
  preferenciaprestamo alias for $4;
  r ttasastipoprestamo%rowtype;


  nsumaprestamos numeric;
  nreciprocidad numeric;
  ntasanormal numeric;
  ntasamoratoria numeric;
  ntasanormaltasa numeric;
  ntasamoratoriatasa numeric;
  stipomovimientoid char(2);

begin

   select sum(montoprestamo)
     into nsumaprestamos
     from prestamos
    where socioid=psocioid and
          claveestadocredito='001' and
          saldoprestamo > 0 and
          referenciaprestamo <> preferenciaprestamo and tipoprestamoid <> 'N7';



   nsumaprestamos:=coalesce(nsumaprestamos,0);
   nsumaprestamos:=nsumaprestamos+pmontoprestamo;

   select tasa_normal,tasa_mora,tipomovimientoid
     into ntasanormal,ntasamoratoria,stipomovimientoid
     from tipoprestamo
    where tipoprestamoid=ptipoprestamoid;

   select sum(debe)-sum(haber)
     into nreciprocidad
     from movicaja mc, movipolizas mp
    where mc.socioid=psocioid and
          mc.tipomovimientoid in (stipomovimientoid,'AA') and
          mc.movipolizaid = mp.movipolizaid;

   nreciprocidad := coalesce (nreciprocidad,0);
 
   -- raise notice ' antes reciprocidad %  montoprestamo %  tasa % ',nreciprocidad,nsumaprestamos,ntasanormal;

   if nsumaprestamos <> 0 or (select count(*) from tasastipoprestamo where tipoprestamoid=ptipoprestamoid)>0 then

           nreciprocidad:= nreciprocidad / nsumaprestamos * 100;

           select tasanormal,tasamoratoria
             into ntasanormaltasa,ntasamoratoriatasa
             from tasastipoprestamo
            where tipoprestamoid=ptipoprestamoid and
                  reciprocidadinicial<=nreciprocidad and reciprocidadfinal > nreciprocidad;

           ntasanormal := coalesce(ntasanormaltasa,ntasanormal);
           ntasamoratoria := coalesce(ntasamoratoriatasa,ntasamoratoria);
    
   end if;

   --raise notice ' despues reciprocidad %  montoprestamo % tasa % ',nreciprocidad,nsumaprestamos,ntasanormal;

   r.tasanormal   := ntasanormal;
   r.tasamoratoria:= ntasamoratoria;

   return next r;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstasastipoprestamo(character, numeric, integer, character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tipo_garantia; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipo_garantia (
    clavegarantia character(3) NOT NULL,
    descripciongarantia character varying(30) NOT NULL
);


ALTER TABLE sucursal1.tipo_garantia OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstipo_garantia(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstipo_garantia(character) RETURNS SETOF sucursal1.tipo_garantia
    AS $_$
declare
  r tipo_garantia%rowtype;
  pclave alias for $1;
begin

  if pclave<>'   ' then
    for r in
      select clavegarantia,descripciongarantia from tipo_garantia where clavegarantia=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select clavegarantia,descripciongarantia from tipo_garantia order by clavegarantia
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstipo_garantia(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tipoacreditador; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipoacreditador (
    tipoacreditadoid integer NOT NULL,
    descripciontipoacreditado character(30) NOT NULL,
    relacionado integer
);


ALTER TABLE sucursal1.tipoacreditador OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstipoacreditador(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstipoacreditador(integer) RETURNS SETOF sucursal1.tipoacreditador
    AS $_$
declare
  r tipoacreditador%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select tipoacreditadoid,descripciontipoacreditado
        from tipoacreditador where tipocreditadoid=pclave
        
    loop
      return next r;
    end loop;
  else
   for r in
      select tipoacreditadoid,descripciontipoacreditado
        from tipoacreditador order by tipoacreditadoid
        
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstipoacreditador(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tipoasentamiento; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipoasentamiento (
    tipoasentamientoid integer NOT NULL,
    asentamiento character(50) NOT NULL
);


ALTER TABLE sucursal1.tipoasentamiento OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstipoasentamiento(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstipoasentamiento(integer) RETURNS SETOF sucursal1.tipoasentamiento
    AS $_$
declare
  r tipoasentamiento%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from tipoasentamiento where tipoasentamientoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
   select * from tipoasentamiento order by tipoasentamientoid
     loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstipoasentamiento(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tipoaviso; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipoaviso (
    tipoavisoid integer NOT NULL,
    diainicial integer NOT NULL,
    diafinal integer NOT NULL,
    descripciontipoaviso character(60) NOT NULL,
    parasocio integer DEFAULT 0,
    paraaval integer DEFAULT 0,
    textoaviso text,
    tituloaviso text,
    textoaval text
);


ALTER TABLE sucursal1.tipoaviso OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstipoaviso(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstipoaviso(integer) RETURNS SETOF sucursal1.tipoaviso
    AS $_$
declare
  r tipoaviso%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from tipoaviso where tipoavisoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select * from tipoaviso
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstipoaviso(integer) OWNER TO sistema;

--
-- Name: spstipoinversion(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstipoinversion(character) RETURNS SETOF sptipoinversion
    AS $_$
declare
  r sptipoinversion%rowtype;
  pclave alias for $1;
begin

  if pclave<>'  ' then
    for r in
      select tipoinversionid,
                   cuentariesgocred,
                   cuentaintinvernocob,  
                   calculoid,            
                   cuentapasivo,         
                   cuentapasivovencida,  
                   cuentaintinver,       
                   cuentaivainver,       
                   desctipoinversion,    
                   tasa_normal_inversion,
                   plazo,                
                   aplicaivainversion,   
                   aplicaisr,            
                   reinvierteinteres,    
                   tipomovimientoid,     
                   cuentaprovisionisr,
                   clasificacionid,
                   plazomaximo
                   
        from tipoinversion where tipoinversionid=pclave
        order by tipoinversionid
    loop
      return next r;
    end loop;
  else
   for r in
      select  tipoinversionid,
                   cuentariesgocred,
                   cuentaintinvernocob,  
                   calculoid,            
                   cuentapasivo,         
                   cuentapasivovencida,  
                   cuentaintinver,       
                   cuentaivainver,       
                   desctipoinversion,    
                   tasa_normal_inversion,
                   plazo,                
                   aplicaivainversion,   
                   aplicaisr,            
                   reinvierteinteres,    
                   tipomovimientoid,     
                   cuentaprovisionisr,
                   clasificacionid,
                   plazomaximo
        from tipoinversion
        order by tipoinversionid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstipoinversion(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tipomovibanco; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipomovibanco (
    tipomovibancoid character(2) NOT NULL,
    descritipomovibanco character varying(30) NOT NULL,
    operacionsumaresta character(1) NOT NULL
);


ALTER TABLE sucursal1.tipomovibanco OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstipomovibanco(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstipomovibanco(character) RETURNS SETOF sucursal1.tipomovibanco
    AS $_$
declare
  r tipomovibanco%rowtype;
  pclave alias for $1;
begin

  if pclave<>'  ' then
    for r in
      select tipomovibancoid,descritipomovibanco,operacionsumaresta from tipomovibanco where tipomovibancoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select tipomovibancoid,descritipomovibanco,operacionsumaresta from tipomovibanco order by tipomovibancoid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstipomovibanco(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tipomovimiento; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipomovimiento (
    tipomovimientoid character(2) NOT NULL,
    cuentadeposito character(24) NOT NULL,
    cuentaretiro character(24) NOT NULL,
    cuentaintpagado character(24) NOT NULL,
    cuentaintcobrado character(24) NOT NULL,
    cuentaivamovimiento character(24) NOT NULL,
    cuentaisr character(24) NOT NULL,
    desctipomovimiento character(30) NOT NULL,
    aplicasaldo character(1),
    tipopoliza character(1) NOT NULL,
    aceptadeposito character(1),
    aceptaretiro character(1),
    tasainteres numeric,
    cuentaordenacredor character(24),
    cuentaordendeudor character(24),
    cuentaorden character(1),
    cuentaprovisionisr character(24),
    comision numeric,
    porcomision numeric,
    porivacomision numeric,
    cuentacomision character(24),
    cuentaivacomision character(24),
    desglosaiva integer
);


ALTER TABLE sucursal1.tipomovimiento OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstipomovimiento(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstipomovimiento(character) RETURNS SETOF sucursal1.tipomovimiento
    AS $_$
declare
  r tipomovimiento%rowtype;
  pclave alias for $1;
begin

  if pclave<>'  ' then
    for r in
      select tipomovimientoid,cuentadeposito,cuentaretiro,cuentaintpagado,cuentaintcobrado,cuentaivamovimiento,cuentaisr,desctipomovimiento,aplicasaldo,tipopoliza,aceptadeposito,aceptaretiro,tasainteres,cuentaordenacredor,cuentaordendeudor,cuentaorden,cuentaprovisionisr,comision,porcomision,porivacomision,cuentacomision,cuentaivacomision 
        from tipomovimiento where tipomovimientoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select tipomovimientoid,cuentadeposito,cuentaretiro,cuentaintpagado,cuentaintcobrado,cuentaivamovimiento,cuentaisr,desctipomovimiento,aplicasaldo,tipopoliza,aceptadeposito,aceptaretiro,tasainteres,cuentaordenacredor,cuentaordendeudor,cuentaorden,cuentaprovisionisr,comision,porcomision,porivacomision,cuentacomision,cuentaivacomision 
      from tipomovimiento order by tipomovimientoid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstipomovimiento(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tipoprestamo; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipoprestamo (
    tipoprestamoid character(3) NOT NULL,
    cuentaactivo character(24) NOT NULL,
    cuentaactivovencida character(24) NOT NULL,
    cuentaintnormal character(24) NOT NULL,
    cuentaintnormalvencida character(24) NOT NULL,
    cuentaintnormalnocob character(24) NOT NULL,
    cuentaintmora character(24) NOT NULL,
    cuentaintmoravencida character(24) NOT NULL,
    cuentaiva character(24) NOT NULL,
    cuentariesgocred character(24) NOT NULL,
    cuentaordeninteres character(24) NOT NULL,
    cuentaordenaval character(24) NOT NULL,
    tipomovimientoid character(2) NOT NULL,
    desctipoprestamo character(30),
    tantos integer NOT NULL,
    tasa_normal numeric NOT NULL,
    tasa_mora numeric NOT NULL,
    aplicaivaprestamo character(1) NOT NULL,
    diastraspasoavencida integer NOT NULL,
    cuentaintdevnocobres character(24) NOT NULL,
    cuentariesgocredres character(24) NOT NULL,
    cuentaintmoranocobact character(24) NOT NULL,
    cuentaintmoradevnocobres character(24) NOT NULL,
    ordendeudornormalbonificado character(24),
    ordenacredornormalbonificado character(24),
    cuentafondorecuperacion character(24),
    cuentagtosadm character(24),
    cuentaintnormalresvencida character(24),
    ordeninteresacreedor character(24),
    calculonormalid integer NOT NULL,
    calculomoraid integer NOT NULL,
    clavefinalidad character(3) NOT NULL,
    cuentaintnormalresvigente character(24),
    cuentaordenavalacredor character(24),
    cuentagarantiadeudor character(24),
    cuentagarantiaacredor character(24),
    cuentaprovisioniva character(24),
    montomaximo numeric,
    plazomaximo integer,
    montominimo numeric,
    avalesminimos integer,
    periododiasdefault integer,
    estatus integer,
    comision numeric,
    ivacomision numeric,
    cuentacomision character(24),
    cuentaivacomision character(24),
    nivelautorizacion integer,
    reciprocidad numeric,
    prestamogrupal integer DEFAULT 0
);


ALTER TABLE sucursal1.tipoprestamo OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstipoprestamo(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstipoprestamo(character) RETURNS SETOF sucursal1.tipoprestamo
    AS $_$
declare
  r tipoprestamo%rowtype;
  pclave alias for $1;
begin

  if pclave<>'  ' then
    for r in
      select *
        from tipoprestamo
        where tipoprestamoid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select *
        from tipoprestamo
    order by tipoprestamoid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstipoprestamo(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tipopromocion; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipopromocion (
    tipopromocionid integer NOT NULL,
    tipomovimientoid character(2) NOT NULL,
    fechainicial date NOT NULL,
    fechafinal date NOT NULL,
    condicion character varying(80),
    estatus integer NOT NULL,
    descripcion character varying(40) NOT NULL
);


ALTER TABLE sucursal1.tipopromocion OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstipopromocion(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstipopromocion(integer) RETURNS SETOF sucursal1.tipopromocion
    AS $_$
declare
  r tipopromocion%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select tipopromocionid,tipomovimientoid,fechainicial,fechafinal,condicion,estatus,descripcion from tipopromocion where tipopromocionid=pclave

    loop
      return next r;
    end loop;
  else
   for r in
   select tipopromocionid,tipomovimientoid,fechainicial,fechafinal,condicion,estatus,descripcion from tipopromocion order by tipopromocionid   
     loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstipopromocion(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tiposocio; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tiposocio (
    tiposocioid character(2) NOT NULL,
    descritiposocio character varying(30) NOT NULL,
    observaciones character varying(254)
);


ALTER TABLE sucursal1.tiposocio OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstiposocio(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstiposocio(character) RETURNS SETOF sucursal1.tiposocio
    AS $_$
declare
  r tiposocio%rowtype;
  pclave alias for $1;
begin

  if pclave<>'  ' then
    for r in
      select tiposocioid,descritiposocio,observaciones from tiposocio where tiposocioid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select tiposocioid,descritiposocio,observaciones from tiposocio order by tiposocioid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstiposocio(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: tipousuario; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipousuario (
    tipousuarioid character(3) NOT NULL,
    descripciontipousuario character varying(20) NOT NULL
);


ALTER TABLE sucursal1.tipousuario OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spstipousuario(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spstipousuario(character) RETURNS SETOF sucursal1.tipousuario
    AS $_$
declare
  r tipousuario%rowtype;
  pclave alias for $1;
begin

  if pclave<>'  ' then
    for r in
      select tipousuarioid,descripciontipousuario from tipousuario where tipousuarioid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select tipousuarioid,descripciontipousuario from tipousuario order by tipousuarioid
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spstipousuario(character) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: udis; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE udis (
    fecha date NOT NULL,
    valor numeric NOT NULL
);


ALTER TABLE sucursal1.udis OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsudis(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsudis(date) RETURNS SETOF sucursal1.udis
    AS $_$
declare
  r udis%rowtype;
  pclave alias for $1;
begin

  if pclave<>'1900-01-01' then
    for r in
      select fecha,valor from udis where fecha=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select fecha,valor from udis order by fecha
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsudis(date) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: usuarios; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE usuarios (
    usuarioid character(20) NOT NULL,
    tipousuarioid character(3) NOT NULL,
    usu_usuarioid character(20),
    contrasenia character varying(13),
    email character varying(30) NOT NULL,
    dicola character varying(10) NOT NULL,
    obsusuario character varying(254) NOT NULL,
    sujetoid integer NOT NULL,
    promotorid character(20)
);


ALTER TABLE sucursal1.usuarios OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: spsusuario(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsusuario(character) RETURNS SETOF sucursal1.usuarios
    AS $_$
declare
  r usuarios%rowtype;
  pclave alias for $1;
begin

  if pclave<>'  ' then
    for r in
      select usuarioid,tipousuarioid,usu_usuarioid,contrasenia,email,dicola,obsusuario,sujetoid
        from usuarios where usuarioid=pclave
    loop
      return next r;
    end loop;
  else
   for r in
      select usuarioid,tipousuarioid,usu_usuarioid,contrasenia,email,dicola,obsusuario,sujetoid
        from usuarios order by usuarioid,usu_usuarioid desc
    loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsusuario(character) OWNER TO sistema;

--
-- Name: spsvalorrangos(integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spsvalorrangos(integer, integer) RETURNS SETOF rvalorrango
    AS $_$
declare
  m rvalorrango%rowtype;
  pejercicio alias for $1;
  pperiodo   alias for $2;

begin

  for m in
select r.rangoid, r.nombrerango, 
       sum(c.saldo_inic_ejer) as saldoinicial, 
       sum(c.cargos_acum_ejer) as cargos, 
       sum(c.abonos_acum_ejer) as abonos,
       sum(c.saldo_inic_ejer+c.cargos_acum_ejer-c.abonos_acum_ejer) as saldofinal
  from rango r, subrango s, balanza('0','Z',pejercicio,pperiodo) c
 where s.rangoid = r.rangoid and
       c.cuentaid>=s.rangoinicial and c.cuentaid<=s.rangofinal and
       c.tipo_cta='A'
group by r.rangoid,r.nombrerango

  loop
    return next m;
  end loop;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spsvalorrangos(integer, integer) OWNER TO sistema;

--
-- Name: sptablaamor(numeric, date, character, integer, integer, integer, integer, date, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sptablaamor(numeric, date, character, integer, integer, integer, integer, date, numeric) RETURNS SETOF tablaamor
    AS $_$
declare
  pmonto          alias for $1;
  ppago1          alias for $2;
  ptipoprestamoid alias for $3;
  pnoamor         alias for $4;
  pperiododias    alias for $5;
  pmeses          alias for $6;
  pdiames         alias for $7;
  pfechaotorga    alias for $8;
  ptasanormal     alias for $9;

  r tablaamor%rowtype;
  j int;
  i int;
  limporteamor numeric;
  lpago1 numeric;
  itantos int;
  saplicaivaprestamo char(1);
  fsaldo numeric;
  dfechai date;
  dfechaf date;
  ftasa_normal numeric;
  diames int;
  mmes int;
  ames int;
  fmonto numeric;
 
  saplicareciprocidad char(1);
  gIVA numeric;
  gdiasanualesprestamo int4;

  gcobrardiainicial int4;

  ftasasiniva numeric;
  ftasamensual numeric;
  idif int4;

  daytab numeric[2][13]:=array[[31,28,31,30,31,30,31,31,30,31,30,31,31],
                               [31,29,31,30,31,30,31,31,30,31,30,31,31]];
  linteresnormal numeric;
  pprimeraamor numeric;
  lpagou numeric;
  fnoamor numeric; 

begin

  select aplicareciprocidad,iva,diasanualesprestamo,cobrardiainicial
    into saplicareciprocidad,gIVA,gdiasanualesprestamo,gcobrardiainicial
    from empresa
   where empresaid=1;

select tantos,aplicaivaprestamo,tasa_normal
    into itantos,saplicaivaprestamo,ftasa_normal
    from tipoprestamo
   where tipoprestamoid=ptipoprestamoid;

ftasa_normal:=ptasanormal;

if ptipoprestamoid not in ('N5 ','N17','N18') then

  limporteamor := trunc(pmonto/pnoamor);

  if pnoamor>1 then
    if limporteamor*pnoamor=pmonto then
      lpago1 := limporteamor;
    else
      lpago1 := limporteamor + pmonto - pnoamor*trunc(pmonto/pnoamor);
    end if;
  else
    lpago1 := pmonto;
    limporteamor := pmonto;
  end if;
   
    r.numamortizacion      := 1;
    r.fechadepago          := ppago1;
    if saplicareciprocidad='S' then
      r.tasainteres := ftasa_normal;
      if ptipoprestamoid<>'CE1' then
        r.tasainteres          := tasareciprocidad(pmonto,pmonto,ppago1,itantos);
      end if;
      if r.tasainteres>ftasa_normal then
        r.tasainteres := ftasa_normal;
      end if;
    else
      r.tasainteres        := ftasa_normal;
    end if;

    --r.importeamortizacion  := lpago1;
    if pnoamor>1 then      
      r.importeamortizacion  := limporteamor;  -- Para dejar la ultima mayor
    else
      r.importeamortizacion:=pmonto;
    end if;

    if gcobrardiainicial=1 then
      r.interesnormal := round(pmonto*(ppago1-pfechaotorga+1)*r.tasainteres/100/gdiasanualesprestamo,2);
    else
      r.interesnormal := round(pmonto*(ppago1-pfechaotorga)*r.tasainteres/100/gdiasanualesprestamo,2);
    end if;
    if saplicaivaprestamo='S' then
      r.iva := r.interesnormal*gIVA;
    else
      r.iva := 0;
    end if;
    r.saldo_absoluto       := pmonto - limporteamor;
    r.pagototal            := round(limporteamor+r.interesnormal+r.iva,2);

    fsaldo := r.saldo_absoluto;
    return next r;

    dfechai := ppago1;
    if pperiododias>0 then
       dfechaf := dfechai + pperiododias;    
    else
      
       dfechaf := dfechai;
       for i in 1..pmeses
       loop
         select dfechaf + interval '1 month'
           into dfechaf;
       end loop;

       diames:=pdiames;
       mmes:=cast(extract(month from dfechaf) as integer);
       ames:=cast(extract(year from dfechaf) as integer);
       if mmes = 2 and pdiames > 28 then
          diames:=28;
       end if;
       if (mmes = 4 or mmes = 6 or mmes= 9 or mmes = 11 ) and pdiames=31 then 
          diames:=30;
       end if;
       dfechaf := cast(to_char(ames,'9999')||'-'||ltrim(to_char(mmes,'99'))||'-'||ltrim(to_char(diames,'99'))as date);

    end if;

  for j in 2..pnoamor
  loop

    r.numamortizacion      := j;
    r.fechadepago          := dfechaf;
    if saplicareciprocidad='S' then
      if ftasa_normal>0 then
        r.tasainteres := ftasa_normal;
        if ptipoprestamoid<>'CE1' then
          r.tasainteres        := tasareciprocidad(pmonto,fsaldo,ppago1,itantos);
        end if;
      else
        r.tasainteres := 0;
      end if;
    else
      r.tasainteres        := ftasa_normal;
    end if;

    if j<>pnoamor then
      r.importeamortizacion := limporteamor;

    else
      r.importeamortizacion := lpago1;  -- Es la ultima

    end if;
    --raise notice ' % % % %',ftasa_normal,fsaldo,dfechaf,dfechai;
    r.interesnormal        := round(fsaldo*(dfechaf-dfechai)*r.tasainteres/100/gdiasanualesprestamo,2);
    if saplicaivaprestamo='S' then
      r.iva := round(r.interesnormal*gIVA,2);
    else
      r.iva := 0;
    end if;
    r.saldo_absoluto       := fsaldo - r.importeamortizacion;
    r.pagototal            := round(r.importeamortizacion + r.interesnormal+r.iva,2);

    fsaldo := r.saldo_absoluto;

    dfechai := dfechaf;
    if pperiododias>0 then      
       dfechaf := dfechai + pperiododias;
    else

       dfechaf := dfechai;
       for i in 1..pmeses
       loop
         select dfechaf + interval '1 month'
           into dfechaf;
       end loop;

       diames:=pdiames;
       mmes:=cast(extract(month from dfechaf) as integer);
       ames:=cast(extract(year from dfechaf) as integer);
       if mmes = 2 and pdiames > 28 then
          diames:=28;
       end if;
       if (mmes = 4 or mmes = 6 or mmes= 9 or mmes = 11 ) and pdiames=31 then 
          diames:=30;
       end if;
       dfechaf := cast(to_char(ames,'9999')||'-'||ltrim(to_char(mmes,'99'))||'-'||ltrim(to_char(diames,'99'))as date);

    end if;

    return next r;

  end loop;

else

--  raise notice 'pago fijo por formula';
-- Verificar si 


raise notice 'pago fijo';

-- Verificar si 

  select aplicareciprocidad,iva,diasanualesprestamo,cobrardiainicial
    into saplicareciprocidad,gIVA,gdiasanualesprestamo,gcobrardiainicial
    from empresa
   where empresaid=1;

  select tantos,aplicaivaprestamo,tasa_normal
    into itantos,saplicaivaprestamo,ftasa_normal
    from tipoprestamo
   where tipoprestamoid=ptipoprestamoid;

    ftasa_normal:=ptasanormal;

    ftasasiniva:=ftasa_normal/12/100;

    if saplicaivaprestamo='S' then
      ftasamensual:=(1+gIVA)*ftasa_normal/12/100;
    else
      ftasamensual:=ftasa_normal/12/100;
      gIVA:=0.00;
    end if;

    ftasamensual:= pperiododias*ftasamensual/30;
    ftasasiniva := pperiododias*ftasasiniva/30;

   if pperiododias=15 then
   
    if date_part('day',dfechaf)<15 then

     select cast(to_char(date_part('year',dfechaf),'9999')||'-'||trim(to_char(date_part('month',dfechaf),'99'))||'-15' as date) into dfechaf;

     
    else

      select cast(to_char(date_part('year',dfechaf),'9999')||'-'||trim(to_char(date_part('month',dfechaf),'99'))||'-'||trim(to_char(daytab[1][date_part('month',dfechaf)],'99')) as date) into dfechaf;

    end if;
  end if;

  

-- Aplicando formula C=M(i/(1-(1+i)^(-n)))

    limporteamor := pmonto*(ftasamensual/(1-(1+ftasamensual)^(-(pnoamor))));

--raise exception 'Importe amortizacione %',limporteamor;

  dfechaf:=ppago1;
  fsaldo:=pmonto;

  i:=1;
  for j in 1..pnoamor
  loop

    r.numamortizacion      := j;


     if pperiododias=15 then
   
        if date_part('day',dfechaf)<=15 then

           select cast(to_char(date_part('year',dfechaf),'9999')||'-'||trim(to_char(date_part('month',dfechaf),'99'))||'-15' as date) into dfechaf;

     
        else

           select cast(to_char(date_part('year',dfechaf),'9999')||'-'||trim(to_char(date_part('month',dfechaf),'99'))||'-'||trim(to_char(daytab[1][date_part('month',dfechaf)],'99')) as date) into dfechaf;

        end if;

        --raise notice ' 2 -- % % ',dfechaf,r.fechadepago;
            
    end if;


    if ptipoprestamoid='N18' then
      r.fechadepago          := dfechaf+2;
    else
      r.fechadepago          := dfechaf;
    end if;

    --raise notice '% % ',dfechaf,r.fechadepago;

    if j<>pnoamor then

      r.interesnormal        := round(fsaldo*ftasasiniva,2);
      r.iva                  := round(r.interesnormal*gIVA,2);     
      lpago1                 := round(limporteamor-r.interesnormal-r.iva,2);

    else
    
      r.interesnormal        := round(fsaldo*ftasasiniva,2);
      r.iva                  := round(r.interesnormal*gIVA,2);
      lpago1                 := round(fsaldo,2);

    end if;

    r.importeamortizacion  := lpago1;
    r.saldo_absoluto       := fsaldo - lpago1;
    r.pagototal            := lpago1+r.interesnormal+r.iva;
    fsaldo := r.saldo_absoluto;
    
    dfechai := dfechaf;    

   
    dfechaf:=dfechaf+pperiododias;
    
    return next r;


  end loop;


end if;

return;
end
 $_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sptablaamor(numeric, date, character, integer, integer, integer, integer, date, numeric) OWNER TO sistema;

--
-- Name: spuactivo(integer, integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, numeric, date, character, numeric, numeric, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuactivo(integer, integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, numeric, date, character, numeric, numeric, numeric, numeric) RETURNS integer
    AS $_$
declare
  pactivoid alias for $1;
  pdepreciacionid alias for $2;
  pactivoclave alias for $3;
  pactivodescripcion alias for $4;
  pactivo_valor alias for $5;
  pporcenvidautil alias for $6;
  pvalormercado alias for $7;
  plocalizacion alias for $8;
  pactivonoserie alias for $9;
  pfeciniciodepconta alias for $10;
  pactivotasaconta alias for $11;
  pactdepreacumconta alias for $12;
  pactmetododepreconta alias for $13;
  pfeciniciodepfiscal alias for $14;
  pactdeduccioninme alias for $15;
  pactivotasafiscal alias for $16;
  pactdepreacumfiscal alias for $17;
  pactmetododeprefiscal alias for $18;
  pactmonmaxdedufiscal alias for $19;

begin

   update activos
      set depreciacionid = pdepreciacionid,
          activoclave = pactivoclave,
          activodescripcion = pactivodescripcion,
          activo_valor = pactivo_valor,
          porcenvidautil = pporcenvidautil,
          valormercado = pvalormercado,
          localizacion = plocalizacion,
          activonoserie = pactivonoserie,
          feciniciodepconta = pfeciniciodepconta,
          activotasaconta = pactivotasaconta,
          actdepreacumconta = pactdepreacumconta,
          actmetododepreconta = pactmetododepreconta,
          feciniciodepfiscal = pfeciniciodepfiscal,
          actdeduccioninme = pactdeduccioninme,
          activotasafiscal = pactivotasafiscal,
          actdepreacumfiscal = pactdepreacumfiscal,
          actmetododeprefiscal = pactmetododeprefiscal,
          actmonmaxdedufiscal = pactmonmaxdedufiscal
    where activoid = pactivoid;

return pactivoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuactivo(integer, integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, numeric, date, character, numeric, numeric, numeric, numeric) OWNER TO sistema;

--
-- Name: spuactivo(integer, integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, integer, date, character, numeric, numeric, integer, numeric, numeric, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuactivo(integer, integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, integer, date, character, numeric, numeric, integer, numeric, numeric, character, integer) RETURNS integer
    AS $_$
declare
  pactivoid alias for $1;
  pdepreciacionid alias for $2;
  pactivoclave alias for $3;
  pactivodescripcion alias for $4;
  pactivo_valor alias for $5;
  pporcenvidautil alias for $6;
  pvalormercado alias for $7;
  plocalizacion alias for $8;
  pactivonoserie alias for $9;
  pfeciniciodepconta alias for $10;
  pactivotasaconta alias for $11;
  pactdepreacumconta alias for $12;
  pactmetododepreconta alias for $13;
  pfeciniciodepfiscal alias for $14;
  pactdeduccioninme alias for $15;
  pactivotasafiscal alias for $16;
  pactdepreacumfiscal alias for $17;
  pactmetododeprefiscal alias for $18;
  pactmonmaxdedufiscal alias for $19;
  pmontooriginal alias  for $20;
  pmonedaid alias for $21;
  pdepartamento alias for $22;
begin

   update activos
      set depreciacionid = pdepreciacionid,
          activoclave = pactivoclave,
          activodescripcion = pactivodescripcion,
          activo_valor = pactivo_valor,
          porcenvidautil = pporcenvidautil,
          valormercado = pvalormercado,
          localizacion = plocalizacion,
          activonoserie = pactivonoserie,
          feciniciodepconta = pfeciniciodepconta,
          activotasaconta = pactivotasaconta,
          actdepreacumconta = pactdepreacumconta,
          actmetododepreconta = pactmetododepreconta,
          feciniciodepfiscal = pfeciniciodepfiscal,
          actdeduccioninme = pactdeduccioninme,
          activotasafiscal = pactivotasafiscal,
          actdepreacumfiscal = pactdepreacumfiscal,
          actmetododeprefiscal = pactmetododeprefiscal,
          actmonmaxdedufiscal = pactmonmaxdedufiscal,
          montooriginal = pmontooriginal,
          monedaid = pmonedaid,
          departamento = pdepartamento
    where activoid = pactivoid;

return pactivoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuactivo(integer, integer, character, character varying, numeric, numeric, numeric, character, character, date, numeric, numeric, integer, date, character, numeric, numeric, integer, numeric, numeric, character, integer) OWNER TO sistema;

--
-- Name: spuamortizacion(integer, integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuamortizacion(integer, integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date) RETURNS integer
    AS $_$
declare
  pamortizacionid alias for $1;
  pnumprestamo alias for $2;
  pnumamortizacion alias for $3;
  pfechadepago alias for $4;
  pimporteamortizacion alias for $5;
  pinteresnormal alias for $6;
  psaldo_absoluto alias for $7;
  pestatusamortizacion alias for $8;
  pinterespagado alias for $9;
  pabonopagado alias for $10;
  pultimoabono alias for $11;

begin

   update amortizaciones
      set prestamoid = pnumprestamo,
          numamortizacion = pnumamortizacion,
          fechadepago = pfechadepago,
          importeamortizacion = pimporteamortizacion,
          interesnormal = pinteresnormal,
          saldo_absoluto = psaldo_absoluto,
          interespagado = pinterespagado,
          abonopagado = pabonopagado,
          ultimoabono = pultimoabono,
          claveestadocredito = pestatusamortizacion
    where amortizacionid = pamortizacionid;

return pamortizacionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuamortizacion(integer, integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date) OWNER TO sistema;

--
-- Name: spuamortizacion(integer, integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuamortizacion(integer, integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date, numeric, numeric) RETURNS integer
    AS $_$
declare
  pamortizacionid alias for $1;
  pnumprestamo alias for $2;
  pnumamortizacion alias for $3;
  pfechadepago alias for $4;
  pimporteamortizacion alias for $5;
  pinteresnormal alias for $6;
  psaldo_absoluto alias for $7;
  pestatusamortizacion alias for $8;
  pinterespagado alias for $9;
  pabonopagado alias for $10;
  pultimoabono alias for $11;
  piva alias for $12;
  ptotalpago alias for $13;

begin

   update amortizaciones
      set prestamoid = pnumprestamo,
          numamortizacion = pnumamortizacion,
          fechadepago = pfechadepago,
          importeamortizacion = pimporteamortizacion,
          interesnormal = pinteresnormal,
          saldo_absoluto = psaldo_absoluto,
          interespagado = pinterespagado,
          abonopagado = pabonopagado,
          ultimoabono = pultimoabono,
          claveestadocredito = pestatusamortizacion,
          iva = piva,
          totalpago = ptotalpago
    where amortizacionid = pamortizacionid;

return pamortizacionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuamortizacion(integer, integer, integer, date, numeric, numeric, numeric, character, numeric, numeric, date, numeric, numeric) OWNER TO sistema;

--
-- Name: spuasamblea(integer, integer, date, character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuasamblea(integer, integer, date, character, character varying) RETURNS integer
    AS $_$
declare
  pasambleaid alias for 1;
  psocioid alias for $2;
  pfechaasistencia alias for $3;
  pespartecomite alias for $4;
  ppuestoocupado alias for $5;  
begin

   update asamblea
    set socio= psocioid,
        fechaasistencia = pfechaasistencia,
        espartecomite = pespartecomite,
        puestoocupado = ppuestoocupado
   where asamblea = pasambleaid;     

return pasambleaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuasamblea(integer, integer, date, character, character varying) OWNER TO sistema;

--
-- Name: spuasesor(integer, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuasesor(integer, character varying) RETURNS integer
    AS $_$
declare
  pasesorid alias for $1;
  pnomasesor alias for $2;
begin

   update asesor
      set nomasesor = pnomasesor
    where asesorid = pasesorid;

return pasesorid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuasesor(integer, character varying) OWNER TO sistema;

--
-- Name: spuaval(integer, integer, integer, integer, numeric, character varying, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuaval(integer, integer, integer, integer, numeric, character varying, integer) RETURNS integer
    AS $_$
declare
  pavalid alias for $1;
  pprestamoid alias for $2;
  psocioid alias for $3;
  psujetoid alias for $4;
  pporcentajeavala alias for $5;
  prelacionconsocio alias for $6;
  pnoaval alias for $7;

begin

   update avales
      set prestamoid = pprestamoid,
          socioid = psocioid,
          sujetoid = psujetoid,
          porcentajeavala = pporcentajeavala,
          relacionconsocio = prelacionconsocio,
          noaval = pnoaval
    where avalid = pavalid;

return pavalid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuaval(integer, integer, integer, integer, numeric, character varying, integer) OWNER TO sistema;

--
-- Name: spuaval(integer, integer, integer, integer, numeric, character varying, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuaval(integer, integer, integer, integer, numeric, character varying, integer, integer) RETURNS integer
    AS $_$
declare
  pavalid alias for $1;
  pprestamoid alias for $2;
  psocioid alias for $3;
  psujetoid alias for $4;
  pporcentajeavala alias for $5;
  prelacionconsocio alias for $6;
  pnoaval alias for $7;
  psolicitudprestamoid alias for $8;

begin

   update avales
      set prestamoid = pprestamoid,
          socioid = psocioid,
          sujetoid = psujetoid,
          porcentajeavala = pporcentajeavala,
          relacionconsocio = prelacionconsocio,
          noaval = pnoaval,
          solicitudprestamoid = psolicitudprestamoid
    where avalid = pavalid;

return pavalid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuaval(integer, integer, integer, integer, numeric, character varying, integer, integer) OWNER TO sistema;

--
-- Name: spuaviso(integer, integer, integer, date, date, integer, integer, numeric, numeric, text, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuaviso(integer, integer, integer, date, date, integer, integer, numeric, numeric, text, character) RETURNS integer
    AS $_$
declare

  pavisoid                alias for $1;
  ptipoavisoid            alias for $2;
  pprestamoid             alias for $3;
  pfechaenvio             alias for $4;
  pfechacontestacion      alias for $5;
  pdiasatrasoprestamo     alias for $6;
  pamortizacionesvencidas alias for $7;
  pcapitalvencido         alias for $8;
  pinteresvencido         alias for $9;
  pobservacionaviso       alias for $10;
  pestatusaviso           alias for $11;

begin

   update aviso
      set fechacontestacion = pfechacontestacion,
          estatusaviso      = pestatusaviso,
          observacionaviso  = pobservacionaviso
    where avisoid=pavisoid;

return pavisoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuaviso(integer, integer, integer, date, date, integer, integer, numeric, numeric, text, character) OWNER TO sistema;

--
-- Name: spubanco(character, character varying, date, numeric, numeric, numeric, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spubanco(character, character varying, date, numeric, numeric, numeric, character, character, integer) RETURNS character
    AS $_$
declare
  pno_cuenta alias for $1;
  pbanco alias for $2;
  pfecha_inicio alias for $3;
  psaldo_inicial alias for $4;
  psaldo_actual alias for $5;
  psaldo_pen alias for $6;
  pcuentaid alias for $7;
  pseriebanco alias for $8;
  pnocheque alias for $9;

begin

   update bancos
      set banco = pbanco,
          fecha_inicio = pfecha_inicio,
          saldo_inicial = round(psaldo_inicial,2),
          saldo_actual = round(psaldo_actual,2),
          saldo_pen = round(psaldo_pen,2),
          cuentaid = pcuentaid,
          seriebanco = pseriebanco,
          nocheque = pnocheque
    where no_cuenta = pno_cuenta;

return pno_cuenta;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spubanco(character, character varying, date, numeric, numeric, numeric, character, character, integer) OWNER TO sistema;

--
-- Name: spubeneficiario(integer, integer, integer, integer, character varying, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spubeneficiario(integer, integer, integer, integer, character varying, numeric) RETURNS integer
    AS $_$
declare
  pbeneficiarioid alias for $1;
  pinversionid alias for $2;
  psocioid alias for $3;
  psujetoid alias for $4;
  pparentesco alias for $5;
  pporcentajebeneficiario alias for $6;

begin

   update beneficiario
      set inversionid = pinversionid,
          socioid = psocioid,
          sujetoid = psujetoid,
          porcentajebeneficiario = pporcentajebeneficiario,
          parentesco = pparentesco
    where beneficiarioid = pbeneficiarioid;

return pbeneficiarioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spubeneficiario(integer, integer, integer, integer, character varying, numeric) OWNER TO sistema;

--
-- Name: spubienes(integer, integer, character varying, character varying, character varying, character varying, numeric, numeric, numeric, character varying, numeric, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spubienes(integer, integer, character varying, character varying, character varying, character varying, numeric, numeric, numeric, character varying, numeric, character, date) RETURNS integer
    AS $_$
declare

  pbienid alias for $1;
  psujetoid alias for $2;
  ppropietario alias for $3;
  pdescribien alias for $4;
  pcaracteristicas alias for $5;
  pregistropublico alias for $6;
  pvalorcomercial alias for $7;
  pvalorfiscal alias for $8;
  pvalorcatastro alias for $9;
  pdatoshipoteca alias for $10;
  prelaciongarantia alias for $11;
  padjudicado alias for $12;
  pfechaadjudicado alias for $13;

begin

   update bienes
      set sujetoid = psujetoid,
	  propietario =ppropietario,
	  describien = pdescribien,
	  caracteristicas = pcaracteristicas,
	  registropublico = pregistropublico,
	  valorcomercial = pvalorcomercial,
          valorcatastro = pvalorcatastro,
          valorfiscal = pvalorfiscal,
	  datoshipoteca = pdatoshipoteca,
	  relaciongarantia = prelaciongarantia,
	  adjudicado = padjudicado,
	  fechaadjudicado = pfechaadjudicado
    where bienid = pbienid;

return pbienid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spubienes(integer, integer, character varying, character varying, character varying, character varying, numeric, numeric, numeric, character varying, numeric, character, date) OWNER TO sistema;

--
-- Name: spucalculo(integer, character varying, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spucalculo(integer, character varying, text) RETURNS integer
    AS $_$
declare
  pcalculoid alias for $1;
  pdescripcioncalculo alias for $2;
  pformula alias for $3;

begin

   update calculo
      set descripcioncalculo = pdescripcioncalculo,
          formula = pformula
    where calculoid = pcalculoid;

return pcalculoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spucalculo(integer, character varying, text) OWNER TO sistema;

--
-- Name: spucargoprestamo(integer, character, character, character, integer, integer, integer, numeric, numeric, numeric, numeric, integer, integer, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spucargoprestamo(integer, character, character, character, integer, integer, integer, numeric, numeric, numeric, numeric, integer, integer, character, character) RETURNS integer
    AS $_$
declare

  pcargoprestamoid    alias for $1;
  ptipoprestamoid     alias for $2;
  pcuentaid           alias for $3;
  pdescripcioncargo   alias for $4;
  ptipocargo          alias for $5;
  pporamortizacion    alias for $6;
  papertura           alias for $7;
  prangoinicial       alias for $8;
  prangofinal         alias for $9;
  pporcentaje         alias for $10;
  pmontocargo         alias for $11;
  paplicaiva          alias for $12;
  pcalculoporfuncion  alias for $13;
  pfuncion            alias for $14;
  pcuentaiva          alias for $15;

begin

   update cargoprestamo
      set tipoprestamoid    = ptipoprestamoid,
          cuentaid          = pcuentaid,
          descripcioncargo  = pdescripcioncargo,
          tipocargo         = ptipocargo,
          poramortizacion   = pporamortizacion,
          apertura          = papertura,
          rangoinicial      = prangoinicial,
          rangofinal        = prangofinal,
          porcentaje        = pporcentaje,
          montocargo        = pmontocargo,
          aplicaiva         = paplicaiva,
          calculoporfuncion = pcalculoporfuncion,
          funcion           = pfuncion,
	  cuentaiva	    = pcuentaiva
    where cargoprestamoid   = pcargoprestamoid;

return pcargoprestamoid;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spucargoprestamo(integer, character, character, character, integer, integer, integer, numeric, numeric, numeric, numeric, integer, integer, character, character) OWNER TO sistema;

--
-- Name: spucatalogo_ctas(character, character, character, character, character, character, date, date, character, double precision, double precision, double precision, double precision); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spucatalogo_ctas(character, character, character, character, character, character, date, date, character, double precision, double precision, double precision, double precision) RETURNS character
    AS $_$
declare
  pcuentaid         alias for $1;
  pcat_cuentaid     alias for $2;
  pidentificacion   alias for $3; 
  pcuentanombre     alias for $4;
  ptipo_cta         alias for $5;
  pestado_cta       alias for $6;
  pfecha_estado     alias for $7;
  pfecha_ult_mov    alias for $8;
  pnaturaleza       alias for $9;
  pdigito_agrupador alias for $10;
  psaldo_inic_ejer  alias for $11;
  pcargos_acum_ejer alias for $12;
  pabonos_acum_ejer alias for $13;


begin

   update catalogo_ctas
      set identificacion    = pidentificacion,
          cuentanombre      = pcuentanombre,  
          tipo_cta          = ptipo_cta,        
          estado_cta        = pestado_cta,      
          fecha_estado      = pfecha_estado,    
          fecha_ult_mov     = pfecha_ult_mov,   
          naturaleza        = pnaturaleza,      
          digito_agrupador  = pdigito_agrupador,
          saldo_inic_ejer   = psaldo_inic_ejer, 
          cargos_acum_ejer  = pcargos_acum_ejer,
          abonos_acum_ejer  = pabonos_acum_ejer,
          cat_cuentaid      = pcat_cuentaid    
    where cuentaid = pcuentaid;

return pcuentaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spucatalogo_ctas(character, character, character, character, character, character, date, date, character, double precision, double precision, double precision, double precision) OWNER TO sistema;

--
-- Name: spuciudadmex(character, character varying, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuciudadmex(character, character varying, integer, integer) RETURNS integer
    AS $_$
declare
  pclaveciudadmex alias for $1;
  pnombreciudadmex alias for $2;
  pestadomexid alias for $3;
  pciudadmexid alias for $4;
begin

   update ciudadesmex
      set claveciudadmex = pclaveciudadmex,
          nombreciudadmex = pnombreciudadmex,
          estadomexid = pestadomexid
    where ciudadmexid = pciudadmexid;

return pciudadmexid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuciudadmex(character, character varying, integer, integer) OWNER TO sistema;

--
-- Name: spuclasificacioncredito(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuclasificacioncredito(integer, character) RETURNS integer
    AS $_$
declare
   pclasificacioncreditoid alias for $1;
   pdescripcion      alias for $2;

begin


   update clasificacioncredito
      set descripcion = pdescripcion
    where clasificacioncreditoid = pclasificacioncreditoid;

return pclasificacioncreditoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuclasificacioncredito(integer, character) OWNER TO sistema;

--
-- Name: spuclasificacionsocio(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuclasificacionsocio(integer, character) RETURNS integer
    AS $_$
declare
  pclasificacionsocioid           alias for $1;
  pdescripcion      alias for $2;

begin

   update clasificacionsocio
      set descripcion = pdescripcion
    where clasificacionsocioid = pclasificacionsocioid;

return pclasificacionsocioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuclasificacionsocio(integer, character) OWNER TO sistema;

--
-- Name: spucobradores(integer, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spucobradores(integer, character, character, character, character) RETURNS integer
    AS $_$
declare
 
  pcobradorid alias for $1;
  ppaterno alias for $2;
  pmaterno alias for $3;
  pnombre  alias for $4;
  prazonsoc alias for $5;

  psujetoid integer;
begin

  select coalesce(sujetoid,0) into psujetoid from cobradores where cobradorid=pcobradorid;

  update sujeto set paterno=ppaterno,materno=pmaterno,nombre=pnombre,razonsocial=prazonsoc where sujetoid=psujetoid;
return 1;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spucobradores(integer, character, character, character, character) OWNER TO sistema;

--
-- Name: spucolonia(integer, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spucolonia(integer, integer, character) RETURNS integer
    AS $_$
declare
  pcoloniaid alias for $1;
  pciudadmexid alias for $2;
  pnombrecolonia alias for $3;
begin


   update colonia
      set ciudadmexid = pciudadmexid,
          nombrecolonia = pnombrecolonia
    where coloniaid = pcoloniaid;

return pcoloniaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spucolonia(integer, integer, character) OWNER TO sistema;

--
-- Name: spucolonia(integer, integer, character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spucolonia(integer, integer, character, integer, integer) RETURNS integer
    AS $_$
declare
  pcoloniaid alias for $1;
  pciudadmexid alias for $2;
  pnombrecolonia alias for $3;
  pcp alias for $4;
  ptipoasentamientoid alias for $5;
begin


   update colonia
      set ciudadmexid = pciudadmexid,
          nombrecolonia = pnombrecolonia,
          cp = pcp,
          tipoasentamientoid = ptipoasentamientoid
    where coloniaid = pcoloniaid;

return pcoloniaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spucolonia(integer, integer, character, integer, integer) OWNER TO sistema;

--
-- Name: spucomplementarios(integer, integer, integer, integer, integer, integer, integer, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spucomplementarios(integer, integer, integer, integer, integer, integer, integer, date, character) RETURNS integer
    AS $_$
declare

 pprestamoid             alias for $1;
 pnorenovaciones         alias for $2;
 pformalizado            alias for $3;
 pcondicionid            alias for $4;
 pclasificacioncreditoid alias for $5;
 psujetoid               alias for $6;
 ptipoacreditadoid       alias for $7;
 pfechavaluaciongarantia alias for $8;
 pprestamodescontado     alias for $9;


begin

   update prestamos
      set norenovaciones     = pnorenovaciones,
          formalizado        = pformalizado,
          condicionid        = pcondicionid,
          clasificacioncreditoid = pclasificacioncreditoid,
          sujetoid           = psujetoid,
          tipoacreditadoid   = ptipoacreditadoid,
          fechavaluaciongarantia = pfechavaluaciongarantia,
          prestamodescontado = pprestamodescontado
 where prestamoid = pprestamoid;

return pprestamoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spucomplementarios(integer, integer, integer, integer, integer, integer, integer, date, character) OWNER TO sistema;

--
-- Name: spuconceptoscoring(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuconceptoscoring(integer, character) RETURNS integer
    AS $_$
declare
  pconceptoscoringid           alias for $1;
  pconceptoscoring             alias for $2;

begin

   update grupo
      set grupo = pgrupo
    where grupoid = pgrupoid;

return pgrupoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuconceptoscoring(integer, character) OWNER TO sistema;

--
-- Name: spuconsolida(integer, character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuconsolida(integer, character, character, character, character, character, character) RETURNS integer
    AS $_$
declare
  psucursalid alias for $1;
  phost       alias for $2;
  pbasedatos  alias for $3;
  pesquema    alias for $4;
  pusuariodb  alias for $5;
  ppassworddb alias for $6;
  pvigente    alias for $7;
begin


   update sucursales
      set host = phost,
          basededatos  = pbasedatos,
          esquema    = pesquema,
          usuariodb  = pusuariodb,
          passworddb = ppassworddb,
          vigente    = pvigente
    where sucursalid = psucursalid;

return psucursalid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuconsolida(integer, character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: spuconsolida(integer, character, character, character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuconsolida(integer, character, character, character, character, character, character, character, character) RETURNS integer
    AS $_$
declare
  psucursalid alias for $1;
  phost       alias for $2;
  pbasedatos  alias for $3;
  pesquema    alias for $4;
  pusuariodb  alias for $5;
  ppassworddb alias for $6;
  pvigente    alias for $7;
  pcuentaremesas alias for $8;
  pcuentafinanciamiento alias for $9;

begin


   update sucursales
      set host = phost,
          basededatos  = pbasedatos,
          esquema    = pesquema,
          usuariodb  = pusuariodb,
          passworddb = ppassworddb,
          vigente    = pvigente,
          cuentaremesas = pcuentaremesas,
          cuentafinanciamiento = pcuentafinanciamiento
    where sucursalid = psucursalid;

return psucursalid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuconsolida(integer, character, character, character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: spuconvenio(integer, integer, date, text, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuconvenio(integer, integer, date, text, character, character, integer) RETURNS integer
    AS $_$
declare
  pconvenioid     alias for $1;
  pprestamoid     alias for $2;
  pfechaconvenio  alias for $3;
  ptextoconvenio  alias for $4;
  pvigente        alias for $5;
  pusuarioid      alias for $6;
  plugar          alias for $7;

begin

   update convenio
      set prestamoid = pprestamoid,
          fechaconvenio = pfechaconvenio,
          textoconvenio = ptextoconvenio,
          vigente = pvigente,
          usuarioid = pusuarioid,
          lugar = plugar
    where convenioid=pconvenioid;

return pconvenioid;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.spuconvenio(integer, integer, date, text, character, character, integer) OWNER TO sistema;

--
-- Name: spuconvenio(integer, integer, date, text, character, character, integer, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuconvenio(integer, integer, date, text, character, character, integer, date) RETURNS integer
    AS $_$
declare
  pconvenioid     alias for $1;
  pprestamoid     alias for $2;
  pfechaconvenio  alias for $3;
  ptextoconvenio  alias for $4;
  pvigente        alias for $5;
  pusuarioid      alias for $6;
  plugar          alias for $7;
  pfechavigencia  alias for $8;

begin

   if plugar<>0 and plugar<>1 then
     raise exception 'Error en plugar';
   end if;

   update convenio
      set prestamoid = pprestamoid,
          fechaconvenio = pfechaconvenio,
          textoconvenio = ptextoconvenio,
          vigente = pvigente,
          usuarioid = pusuarioid,
          lugar = plugar,
          fechavigencia = pfechavigencia
    where convenioid=pconvenioid;

return pconvenioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuconvenio(integer, integer, date, text, character, character, integer, date) OWNER TO sistema;

--
-- Name: spuconvenio(integer, integer, date, text, character, character, integer, date, character, date, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuconvenio(integer, integer, date, text, character, character, integer, date, character, date, character) RETURNS integer
    AS $_$
declare
  pconvenioid     alias for $1;
  pprestamoid     alias for $2;
  pfechaconvenio  alias for $3;
  ptextoconvenio  alias for $4;
  pvigente        alias for $5;
  pusuarioid      alias for $6;
  plugar          alias for $7;
  pfechavigencia  alias for $8;
  paccion         alias for $9;
  pfechanegociar  alias for $10;
  phoranegociar   alias for $11;

begin

   if plugar<>0 and plugar<>1 then
     raise exception 'Error en plugar';
   end if;

   update convenio
      set prestamoid = pprestamoid,
          fechaconvenio = pfechaconvenio,
          textoconvenio = ptextoconvenio,
          vigente = pvigente,
          usuarioid = pusuarioid,
          lugar = plugar,
          fechavigencia = pfechavigencia,
          accion = paccion,
          fechanegociar = pfechanegociar,
          horanegociar = phoranegociar
    where convenioid=pconvenioid;

return pconvenioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuconvenio(integer, integer, date, text, character, character, integer, date, character, date, character) OWNER TO sistema;

--
-- Name: spudatoingreso(integer, character varying, character varying, character varying, numeric, numeric, integer, numeric, numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spudatoingreso(integer, character varying, character varying, character varying, numeric, numeric, integer, numeric, numeric, integer) RETURNS integer
    AS $_$
declare
  pdatoingresoid alias for $1;
  pnombredelconyuge alias for $2;
  pempresadondetrabaja alias for $3;
  pocupacion alias for $4;
  pingresosmensuales alias for $5;
  potrosingresos alias for $6;
  pno_dependientes alias for $7;
  ptotalegresos alias for $8;
  pahorromensual alias for $9;
  pestadocivil alias for $10;

begin

   update datoingreso
      set nombredelconyuge = pnombredelconyuge,
          empresadondetrabaja = pempresadondetrabaja,
          ocupacion = pocupacion,
          ingresosmensuales = pingresosmensuales,
          otrosingresos = potrosingresos,
          no_dependientes = pno_dependientes,
          totalegresos = ptotalegresos,
          ahorromensual = pahorromensual,
          estadocivil = pestadocivil
    where datoingresoid = pdatoingresoid;

return pdatoingresoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spudatoingreso(integer, character varying, character varying, character varying, numeric, numeric, integer, numeric, numeric, integer) OWNER TO sistema;

--
-- Name: spudepreciacion(character, character, character, character, character, character varying, numeric, numeric, numeric, numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spudepreciacion(character, character, character, character, character, character varying, numeric, numeric, numeric, numeric, integer) RETURNS integer
    AS $_$
declare

pmonedaid          alias for $1;
pdepre_activo      alias for $2;
pdepre_ctadepre    alias for $3;
pdepre_ctagasto    alias for $4;
pdepre_ctabaja     alias for $5;
pdepredescripcion  alias for $6;
pdepretasacontable alias for $7;
pdepretasafiscal   alias for $8;
pmaximodeducible   alias for $9;
pdepreporcentaje   alias for $10;
pdepreciacionid    alias for $11;


begin

   update depreciacion
      set monedaid = pmonedaid,
          depre_activo = pdepre_activo,
          depre_ctadepre = pdepre_ctadepre,
          depre_ctagasto = pdepre_ctagasto,
          depre_ctabaja = pdepre_ctabaja,
          depredescripcion = pdepredescripcion,
          depretasacontable = pdepretasacontable,
          depretasafiscal = pdepretasafiscal,
          maximodeducible = pmaximodeducible,
          depreporcentaje = pdepreporcentaje
    where depreciacionid = pdepreciacionid;

return pdepreciacionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spudepreciacion(character, character, character, character, character, character varying, numeric, numeric, numeric, numeric, integer) OWNER TO sistema;

--
-- Name: spudocumentacion(integer, character, character varying, character, character varying, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spudocumentacion(integer, character, character varying, character, character varying, date) RETURNS integer
    AS $_$
declare
  pdocumentacionid alias for $1;
  pdocucompletasocio alias for $2;
  pdocufaltantesocio alias for $3;
  pdocucompletapres alias for $4;
  pdocufaltantepres alias for $5;
  pfechanotificacion alias for $6;

begin

   update documentacion
      set docucompletasocio = pdocucompletasocio,
          docufaltantesocio = pdocufaltantesocio,
          docucompletapres = pdocucompletapres,
          docufaltantepres = pdocufaltantepres,
          fechanotificacion = pfechanotificacion
    where documentacionid = pdocumentacionid;

return pdocumentacionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spudocumentacion(integer, character, character varying, character, character varying, date) OWNER TO sistema;

--
-- Name: spudomicilio(integer, integer, integer, character varying, character varying, character varying, character varying, integer, character varying, character varying, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spudomicilio(integer, integer, integer, character varying, character varying, character varying, character varying, integer, character varying, character varying, integer) RETURNS integer
    AS $_$
declare
  pdomicilioid alias for $1;
  pciudadmexid alias for $2;
  psujetoid alias for $3;
  pcalle alias for $4;
  pnumero_ext alias for $5;
  pnumero_int alias for $6;
  pcolonia alias for $7;
  pcodpostal alias for $8;
  pcomunidad alias for $9;
  pteldomicilio alias for $10;
  pcoloniaid alias for $11;

  scolonia char(30);
begin

  if pcoloniaid>0 and pcolonia=' ' then
    select substr(nombrecolonia,1,30)
      into scolonia
      from colonia
     where coloniaid=pcoloniaid;
  else
    scolonia:=pcolonia;
  end if;


   update domicilio
    set ciudadmexid = pciudadmexid,
        sujetoid = psujetoid,
        calle =  pcalle,
        numero_ext = pnumero_ext,
        numero_int = pnumero_int,
        colonia = scolonia,
        codpostal = pcodpostal,
        comunidad = pcomunidad,
        teldomicilio = pteldomicilio,
        coloniaid = pcoloniaid
    where domicilioid = pdomicilioid;        

return pdomicilioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spudomicilio(integer, integer, integer, character varying, character varying, character varying, character varying, integer, character varying, character varying, integer) OWNER TO sistema;

--
-- Name: spuestadomex(character, character varying, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuestadomex(character, character varying, integer) RETURNS integer
    AS $_$
declare
  pclaveestadomex alias for $1;
  pnombreestadomex alias for $2;
  pestadomexid alias for $3;
begin

   update estadosmex
      set claveestadomex = pclaveestadomex,
          nombreestadomex = pnombreestadomex
    where estadomexid = pestadomexid;

return pestadomexid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuestadomex(character, character varying, integer) OWNER TO sistema;

--
-- Name: spuestados_credito(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuestados_credito(character, character varying) RETURNS character
    AS $_$
declare
  pclaveestadocredito alias for $1;
  pdescripcionedocredito alias for $2;
begin

   update estados_credito
      set descripcionedocredito = pdescripcionedocredito
    where claveestadocredito = pclaveestadocredito;

return pclaveestadocredito;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuestados_credito(character, character varying) OWNER TO sistema;

--
-- Name: spufinalidades(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spufinalidades(character, character varying) RETURNS character
    AS $_$
declare
  pclavefinalidad alias for $1;
  pdescripcionfinalidad alias for $2;
begin

   update finalidades
      set descripcionfinalidad = pdescripcionfinalidad
    where clavefinalidad = pclavefinalidad;

return pclavefinalidad;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spufinalidades(character, character varying) OWNER TO sistema;

--
-- Name: spugrupo(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spugrupo(integer, character) RETURNS integer
    AS $_$
declare
  pgrupoid           alias for $1;
  pgrupo             alias for $2;

begin

   update grupo
      set grupo = pgrupo
    where grupoid = pgrupoid;

return pgrupoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spugrupo(integer, character) OWNER TO sistema;

--
-- Name: spuhistorial(integer, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuhistorial(integer, text) RETURNS integer
    AS $_$
declare
  pdocumentacionid alias for $1;
  phistorial       alias for $2;
begin

   update documentacion
      set historial = NULL
    where documentacionid = pdocumentacionid;

   update documentacion
      set historial = phistorial
    where documentacionid = pdocumentacionid;

--    update empresa
--       set historico = phistorial
--     where empresaid = 1;

return pdocumentacionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuhistorial(integer, text) OWNER TO sistema;

--
-- Name: spuinpc(integer, integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuinpc(integer, integer, numeric) RETURNS integer
    AS $_$
declare
  pano alias for $1;
  pmes alias for $2;
  pinpc alias for $3;
begin
 
   update inpc
      set inpc = pinpc
    where ano = pano and
          mes = pmes;

return pano;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuinpc(integer, integer, numeric) OWNER TO sistema;

--
-- Name: spuinversion(integer, integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuinversion(integer, integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, integer, integer) RETURNS integer
    AS $_$
declare
  pinversionid                   alias for $1;
  psocioid                       alias for $2;
  ptipoinversionid               alias for $3;
  preferenciainver               alias for $4;
  pserieinver                    alias for $5;
  pdepositoinversion             alias for $6;
  pretiroinversion               alias for $7;
  pinteresinversion              alias for $8;
  pfechainversion                alias for $9;
  pfechavencimiento              alias for $10;
  pultimarenovacion              alias for $11;
  pnoderenovaciones              alias for $12;
  ptasainteresnormalinversion    alias for $13;
  ptasainteresmoratorioinversion alias for $14;
  pfechapagoinversion            alias for $15;
  pfechapagoanterior             alias for $16;
  preinversionautomatica         alias for $17;
  pmanejo                        alias for $18;
  paccionalvencimiento           alias for $19;
  gmodificarinversion   int;

begin

  select modificarinversion into gmodificarinversion from empresa;

  if gmodificarinversion = 0 then 
    update inversion
     set tipoinversionid =  ptipoinversionid,
        socioid = psocioid,
        referenciainversion = preferenciainver,
        serieinversion = pserieinver,
        depositoinversion = pdepositoinversion,
        retiroinversion = pretiroinversion,
        interesinversion = pinteresinversion,
        fechainversion = pfechainversion,
        fechavencimiento = pfechavencimiento,
        ultimarenovacion = pultimarenovacion,
        noderenovaciones = pnoderenovaciones,
        --tasainteresnormalinversion = ptasainteresnormalinversion,
        tasainteresmoratorioinversion = ptasainteresmoratorioinversion,
        fechapagoinversion = pfechapagoinversion,
        fechapagoanterior =  pfechapagoanterior,
        reinversionautomatica = preinversionautomatica,
        manejo = pmanejo,
        accionalvencimiento = paccionalvencimiento
      where inversionid = pinversionid;
   else

    update inversion
     set tipoinversionid =  ptipoinversionid,
        socioid = psocioid,
        referenciainversion = preferenciainver,
        serieinversion = pserieinver,
        depositoinversion = pdepositoinversion,
        retiroinversion = pretiroinversion,
        interesinversion = pinteresinversion,
        fechainversion = pfechainversion,
        fechavencimiento = pfechavencimiento,
        ultimarenovacion = pultimarenovacion,
        noderenovaciones = pnoderenovaciones,
        tasainteresnormalinversion = ptasainteresnormalinversion,
        tasainteresmoratorioinversion = ptasainteresmoratorioinversion,
        fechapagoinversion = pfechapagoinversion,
        fechapagoanterior =  pfechapagoanterior,
        reinversionautomatica = preinversionautomatica,
        manejo = pmanejo,
        accionalvencimiento = paccionalvencimiento
      where inversionid = pinversionid;

   end if;
return pinversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuinversion(integer, integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, integer, integer) OWNER TO sistema;

--
-- Name: spuinversion(integer, integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuinversion(integer, integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric, integer) RETURNS integer
    AS $_$
declare
  pinversionid                   alias for $1;
  psocioid                       alias for $2;
  ptipoinversionid               alias for $3;
  preferenciainver               alias for $4;
  pserieinver                    alias for $5;
  pdepositoinversion             alias for $6;
  pretiroinversion               alias for $7;
  pinteresinversion              alias for $8;
  pfechainversion                alias for $9;
  pfechavencimiento              alias for $10;
  pultimarenovacion              alias for $11;
  pnoderenovaciones              alias for $12;
  ptasainteresnormalinversion    alias for $13;
  ptasainteresmoratorioinversion alias for $14;
  pfechapagoinversion            alias for $15;
  pfechapagoanterior             alias for $16;
  preinversionautomatica         alias for $17;
  pdepositoanteside              alias for $18;
  pide                           alias for $19;
  pmanejo                        alias for $20;
  
  gmodificarinversion   int;

begin

  select modificarinversion into gmodificarinversion from empresa;

  if gmodificarinversion = 0 then 
    update inversion
     set tipoinversionid =  ptipoinversionid,
        socioid = psocioid,
        referenciainversion = preferenciainver,
        serieinversion = pserieinver,
        depositoinversion = pdepositoinversion,
        retiroinversion = pretiroinversion,
        interesinversion = pinteresinversion,
        fechainversion = pfechainversion,
        fechavencimiento = pfechavencimiento,
        ultimarenovacion = pultimarenovacion,
        noderenovaciones = pnoderenovaciones,
        tasainteresnormalinversion = ptasainteresnormalinversion,
        tasainteresmoratorioinversion = ptasainteresmoratorioinversion,
        fechapagoinversion = pfechapagoinversion,
        fechapagoanterior =  pfechapagoanterior,
        reinversionautomatica = preinversionautomatica,
        depositoanteside = pdepositoanteside,
        ide = pide,
        manejo =pmanejo
      where inversionid = pinversionid;
   else

    update inversion
     set tipoinversionid =  ptipoinversionid,
        socioid = psocioid,
        referenciainversion = preferenciainver,
        serieinversion = pserieinver,
        depositoinversion = pdepositoinversion,
        retiroinversion = pretiroinversion,
        interesinversion = pinteresinversion,
        fechainversion = pfechainversion,
        fechavencimiento = pfechavencimiento,
        ultimarenovacion = pultimarenovacion,
        noderenovaciones = pnoderenovaciones,
        tasainteresnormalinversion = ptasainteresnormalinversion,
        tasainteresmoratorioinversion = ptasainteresmoratorioinversion,
        fechapagoinversion = pfechapagoinversion,
        fechapagoanterior =  pfechapagoanterior,
        reinversionautomatica = preinversionautomatica,
        depositoanteside = pdepositoanteside,
        ide = pide,
        manejo = pmanejo
      where inversionid = pinversionid;

   end if;
return pinversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuinversion(integer, integer, character, integer, character, numeric, numeric, numeric, date, date, date, integer, numeric, numeric, date, date, character, numeric, numeric, integer) OWNER TO sistema;

--
-- Name: spumodulo(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spumodulo(character, character varying) RETURNS character
    AS $_$
declare
  pclavemodulo alias for $1;
  pdescripcionmodulos alias for $2;
begin

   update modulos
      set descripcionmodulos = pdescripcionmodulos
    where clavemodulo = pclavemodulo;

return pclavemodulo;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spumodulo(character, character varying) OWNER TO sistema;

--
-- Name: spumoneda(character, character varying, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spumoneda(character, character varying, numeric) RETURNS character
    AS $_$
declare
  pmonedaid alias for $1;
  pmonedadescri alias for $2;
  pmonedavalor alias for $3;
begin

   raise exception 'Ejemplo error';

   update monedas
      set monedadescri = pmonedadescri,
          monedavalor = pmonedavalor
    where monedaid = pmonedaid;

return pmonedaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spumoneda(character, character varying, numeric) OWNER TO sistema;

--
-- Name: spumotivobaja(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spumotivobaja(integer, character) RETURNS integer
    AS $_$
declare
  pmotivobajaid           alias for $1;
  pdescripcionmotivo      alias for $2;

begin

   update motivobaja
      set descripcionmotivo = pdescripcionmotivo
    where motivobajaid = pmotivobajaid;

return pmotivobajaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spumotivobaja(integer, character) OWNER TO sistema;

--
-- Name: spumovibanco(character, integer, character, integer, integer, character, character, character, character, character, date, character, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spumovibanco(character, integer, character, integer, integer, character, character, character, character, character, date, character, integer, integer, integer) RETURNS integer
    AS $_$
declare
   ptipomovibancoid alias for $1;
   pprestamoid      alias for $2;
   pno_cuenta       alias for $3;
   ppolizaid        alias for $4;
   pconsecutivo     alias for $5;
   pserie	    alias for $6;
   preferenciamovi  alias for $7;
   pconcepto	    alias for $8;
   pbeneficiario    alias for $9;
   pconciliado      alias for $10;
   pfecha_pen       alias for $11;
   ppostfechado     alias for $12;
   pmovipolizaid    alias for $13;
   pmovibancoid     alias for $14;
   pprocampoid      alias for $15;

   l integer;
begin

   update movibanco
      set  tipomovibancoid =  ptipomovibancoid,
           prestamoid 	   =  pprestamoid,
           no_cuenta	   =  pno_cuenta,
           polizaid        =  ppolizaid,
           consecutivo     =  pconsecutivo,    	
           serie           =  pserie,       
           referenciamovi  =  preferenciamovi,
           concepto	   =  pconcepto,
           beneficiario	   =  pbeneficiario,
           conciliado	   =  pconciliado,
           fecha_pen   	   =  pfecha_pen,
           postfechado	   =  ppostfechado,
           movipolizaid	   =  pmovipolizaid,
           procampoid      =  pprocampoid
    where movibancoid = pmovibancoid;

    -- Recalcular completamente
   select recalculasaldo(pno_cuenta) into l;

return pmovibancoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spumovibanco(character, integer, character, integer, integer, character, character, character, character, character, date, character, integer, integer, integer) OWNER TO sistema;

--
-- Name: spumovipoliza(integer, integer, character, character, character, numeric, numeric, character, character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spumovipoliza(integer, integer, character, character, character, numeric, numeric, character, character, character varying) RETURNS integer
    AS $_$
declare

   pmovipolizaid      alias for $1;
   ppolizaid          alias for $2;	
   pcuentaid          alias for $3;
   preferencia_mov    alias for $4;
   ptipo_mov          alias for $5;
   pdebe              alias for $6;
   phaber	      alias for $7;
   pdiario_mov        alias for $8;
   pidentific_descr   alias for $9;
   pdescripcion       alias for $10;

begin

   update movipolizas
      set  polizaid = ppolizaid,
           cuentaid = pcuentaid,
           referencia_mov = preferencia_mov,
           tipo_mov = ptipo_mov,	
           debe = round(pdebe,2), 
           haber = round(phaber,2),   
           diario_mov = pdiario_mov,
           identific_descr = pidentific_descr,	
           descripcion = pdescripcion
    where movipolizaid = pmovipolizaid;

return pmovipolizaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spumovipoliza(integer, integer, character, character, character, numeric, numeric, character, character, character varying) OWNER TO sistema;

--
-- Name: spuocupacion(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuocupacion(integer, character) RETURNS integer
    AS $_$
declare
  pocupacionid           alias for $1;
  pocupacion             alias for $2;

begin

   update ocupacion
      set ocupacion = pocupacion
    where ocupacionid = pocupacionid;

return pocupacionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuocupacion(integer, character) OWNER TO sistema;

--
-- Name: spuparametro(character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuparametro(character, character, character) RETURNS integer
    AS $_$
declare
  pusuarioid alias for $1;
  pserieuser alias for $2;
  pcuentaid  alias for $3;

  pexiste int;
begin

   select count(*)
     into pexiste
     from parametros
    where usuarioid=pusuarioid;

  if FOUND then
   update parametros
      set usuarioid = pusuarioid,
          serie_user = pserieuser,
          cuentacaja = pcuentaid
    where usuarioid = pusuarioid;
  else
   insert into parametros(usuarioid,serie_user,cuentacaja)
    values( pusuarioid,
            pserieuser,
            pcuentaid );
            
   return currval('parametros_parametroid_seq');
  end if;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuparametro(character, character, character) OWNER TO sistema;

--
-- Name: spuparametro(character, character, character, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuparametro(character, character, character, character, character, integer) RETURNS integer
    AS $_$
declare

  pusuarioid alias for $1;
  pserieuser alias for $2;
  pcuentaid  alias for $3;
  pimpresoracaja alias for $4;
  pimpresorareporte alias for $5;
  preporteslaser alias for $6;

  pexiste int;
begin

   update parametros
      set usuarioid = pusuarioid,
          serie_user = pserieuser,
          cuentacaja = pcuentaid,
          impresoracaja = pimpresoracaja,
          impresorareporte = pimpresorareporte,
          reporteslaser = preporteslaser
    where usuarioid = pusuarioid;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuparametro(character, character, character, character, character, integer) OWNER TO sistema;

--
-- Name: spuparametro(character, character, character, character, character, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuparametro(character, character, character, character, character, integer, character) RETURNS integer
    AS $_$
declare

  pusuarioid alias for $1;
  pserieuser alias for $2;
  pcuentaid  alias for $3;
  pimpresoracaja alias for $4;
  pimpresorareporte alias for $5;
  preporteslaser alias for $6;
  pclavesocioint alias for $7;

  pexiste int;
begin

   update parametros
      set usuarioid = pusuarioid,
          serie_user = pserieuser,
          cuentacaja = pcuentaid,
          impresoracaja = pimpresoracaja,
          impresorareporte = pimpresorareporte,
          reporteslaser = preporteslaser,
          clavesocioint = pclavesocioint
    where usuarioid = pusuarioid;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuparametro(character, character, character, character, character, integer, character) OWNER TO sistema;

--
-- Name: spupermisomodulo(integer, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spupermisomodulo(integer, character, character, character) RETURNS integer
    AS $_$
declare
  ppermisomoduloid alias for $1;
  pclavemodulo alias for $2;
  pusuarioid alias for $3;
  ppermiso alias for $4;

begin

   update permisosmodulos
      set clavemodulo = pclavemodulo,
          usuarioid = pusuarioid,
          permiso = ppermiso
    where permisomoduloid = ppermisomoduloid;

return ppermisomoduloid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spupermisomodulo(integer, character, character, character) OWNER TO sistema;

--
-- Name: spupoliza(integer, character, character, integer, integer, integer, character, date, character, character, character, text, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spupoliza(integer, character, character, integer, integer, integer, character, date, character, character, character, text, date, integer) RETURNS integer
    AS $_$
declare

  preferencia            alias for $1;
  pserie                 alias for $2;
  ptipo                  alias for $3;
  pnumero_poliza         alias for $4;
  pejercicio             alias for $5;
  pperiodo               alias for $6;
  pidentificacion        alias for $7;
  pfecha                 alias for $8;
  ptipo_poliza           alias for $9;
  pclase_poliza          alias for $10;
  pdiario_agrupador      alias for $11;
  pconcepto_poliza       alias for $12;
  pfecha_fin_aceptacion  alias for $13;
  ppolizaid              alias for $14;

begin

   if periodovalido(pejercicio,pperiodo)=0 then
     raise exception 'El periodo % del Ejercicio % se encuentra CERRADO !!!',pperiodo,pejercicio;
   end if;


   update polizas
      set  referencia            = preferencia,
           seriepoliza           = pserie,          
           tipo                  = ptipo,               
--           numero_poliza         = pnumero_poliza,
--           ejercicio             = pejercicio,       
--           periodo               = pperiodo,           
--           fechapoliza           = pfecha,      
--           tipo_poliza           = ptipo_poliza,
           clase_poliza          = pclase_poliza,         
           diario_agrupador      = pdiario_agrupador,
           concepto_poliza       = pconcepto_poliza,    
           fecha_fin_aceptacion  = pfecha_fin_aceptacion
    where polizaid = ppolizaid;

return ppolizaid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spupoliza(integer, character, character, integer, integer, integer, character, date, character, character, character, text, date, integer) OWNER TO sistema;

--
-- Name: spuprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, integer) RETURNS integer
    AS $_$
declare

 preferenciaprestamo alias for $1;
 pmontoprestamo      alias for $2;
 psaldoprestamo      alias for $3;
 pnumero_de_amor     alias for $4;
 pfecha_otorga       alias for $5;
 pfecha_vencimiento  alias for $6;
 ptipoprestamoid     alias for $7;
 ptasanormal         alias for $8;
 ptasa_moratoria     alias for $9;
 psocioid            alias for $10;
 pdias_de_cobro      alias for $11;
 pmeses_de_cobro     alias for $12;
 pdia_mes_cobro      alias for $13;
 pfecha_1er_pago     alias for $14;
 pclavegarantia      alias for $15;
 pmonto_garantia     alias for $16;
 pclaveestadocredito alias for $17;
 pautorizaprestamo   alias for $18;
 pfinalidadprestamo  alias for $19;
 poperacion          alias for $20;
 pcalculonormalid    alias for $21;
 pcalculomoratorioid alias for $22;
 psolicitudprestamoid alias for $23;
 pnorenovaciones     alias for $24;
 pformalizado        alias for $25;
 pcondicionid        alias for $26;
 pclasificacioncreditoid alias for $27;
 psujetoid            alias for $28;
 ptipoacreditadoid   alias for $29;
 pfechavaluaciongarantia alias for $30;
 pprestamodescontado alias for $31;
 pinversionid alias for $32;

 lgenero int4;
begin

   -- Validar que ya no se pueda modificar si tiene movimientos
   select count(*)
     into lgenero
     from movicaja
    where prestamoid = poperacion;

   lgenero := coalesce(lgenero,0);
   if lgenero>0 then
     raise exception 'No se pueden realizar cambios en un prestamo que ya realizo movimientos en caja';
   end if;


  if psujetoid>0 then
   update prestamos
      set referenciaprestamo = preferenciaprestamo,
          montoprestamo      = pmontoprestamo,
          saldoprestamo      = psaldoprestamo,
          numero_de_amor     = pnumero_de_amor,
          fecha_otorga       = pfecha_otorga,
          fechaultimopago    = pfecha_otorga,
          fecha_vencimiento  = pfecha_vencimiento,     
          tipoprestamoid     = ptipoprestamoid,
          tasanormal         = ptasanormal,
          tasa_moratoria     = ptasa_moratoria,
          socioid            = psocioid,
          dias_de_cobro      = pdias_de_cobro,
          meses_de_cobro     = pmeses_de_cobro,
          dia_mes_cobro      = pdia_mes_cobro,
          fecha_1er_pago     = pfecha_1er_pago,
          clavegarantia      = pclavegarantia,
          monto_garantia     = pmonto_garantia,
          claveestadocredito = pclaveestadocredito,
          usuarioid          = pautorizaprestamo,
          clavefinalidad     = pfinalidadprestamo,
          calculonormalid    = pcalculonormalid,
          calculomoratorioid = pcalculomoratorioid,
          solicitudprestamoid = psolicitudprestamoid,
          norenovaciones     = pnorenovaciones,
          formalizado        = pformalizado,
          condicionid        = pcondicionid,
          clasificacioncreditoid = pclasificacioncreditoid,
          sujetoid           = psujetoid,
          tipoacreditadoid   = ptipoacreditadoid,
          fechavaluaciongarantia = pfechavaluaciongarantia,
          prestamodescontado = pprestamodescontado

 where prestamoid = poperacion;
  else


   update prestamos
      set referenciaprestamo = preferenciaprestamo,
          montoprestamo      = pmontoprestamo,
          saldoprestamo      = psaldoprestamo,
          numero_de_amor     = pnumero_de_amor,
          fecha_otorga       = pfecha_otorga,
          fechaultimopago    = pfecha_otorga,
          fecha_vencimiento  = pfecha_vencimiento,     
          tipoprestamoid     = ptipoprestamoid,
          tasanormal         = ptasanormal,
          tasa_moratoria     = ptasa_moratoria,
          socioid            = psocioid,
          dias_de_cobro      = pdias_de_cobro,
          meses_de_cobro     = pmeses_de_cobro,
          dia_mes_cobro      = pdia_mes_cobro,
          fecha_1er_pago     = pfecha_1er_pago,
          clavegarantia      = pclavegarantia,
          monto_garantia     = pmonto_garantia,
          claveestadocredito = pclaveestadocredito,
          usuarioid          = pautorizaprestamo,
          clavefinalidad     = pfinalidadprestamo,
          calculonormalid    = pcalculonormalid,
          calculomoratorioid = pcalculomoratorioid,
          solicitudprestamoid = psolicitudprestamoid,
          norenovaciones     = pnorenovaciones,
          formalizado        = pformalizado,
          condicionid        = pcondicionid,
          clasificacioncreditoid = pclasificacioncreditoid,
--          sujetoid           = psujetoid,
          tipoacreditadoid   = ptipoacreditadoid,
          fechavaluaciongarantia = pfechavaluaciongarantia,
          prestamodescontado = pprestamodescontado

 where prestamoid = poperacion;

  end if;

    delete from amortizaciones where prestamoid=poperacion;
    -- Generar las amortizaciones aqui
    select * INTO lgenero
      from generaramortizaciones(preferenciaprestamo,0,pfecha_otorga);


return poperacion;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, integer) OWNER TO sistema;

--
-- Name: spuprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, numeric, integer, numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, numeric, integer, numeric, integer) RETURNS integer
    AS $_$
declare

 preferenciaprestamo alias for $1;
 pmontoprestamo      alias for $2;
 psaldoprestamo      alias for $3;
 pnumero_de_amor     alias for $4;
 pfecha_otorga       alias for $5;
 pfecha_vencimiento  alias for $6;
 ptipoprestamoid     alias for $7;
 ptasanormal         alias for $8;
 ptasa_moratoria     alias for $9;
 psocioid            alias for $10;
 pdias_de_cobro      alias for $11;
 pmeses_de_cobro     alias for $12;
 pdia_mes_cobro      alias for $13;
 pfecha_1er_pago     alias for $14;
 pclavegarantia      alias for $15;
 pmonto_garantia     alias for $16;
 pclaveestadocredito alias for $17;
 pautorizaprestamo   alias for $18;
 pfinalidadprestamo  alias for $19;
 poperacion          alias for $20;
 pcalculonormalid    alias for $21;
 pcalculomoratorioid alias for $22;
 psolicitudprestamoid alias for $23;
 pnorenovaciones     alias for $24;
 pformalizado        alias for $25;
 pcondicionid        alias for $26;
 pclasificacioncreditoid alias for $27;
 psujetoid            alias for $28;
 ptipoacreditadoid   alias for $29;
 pfechavaluaciongarantia alias for $30;
 pprestamodescontado alias for $31;
 pcomision alias for $32;
 ptipocobrocomision alias for $33;
 pahorrocompromiso alias for $34;
 pinteresanticipado alias for $35;      
 
 lgenero int4;
 nmontosolicitado numeric;

 ptasanormal1 numeric;
 ptasa_moratoria1 numeric;
 
begin

   -- Validar que ya no se pueda modificar si tiene movimientos
   select count(*)
     into lgenero
     from movicaja
    where prestamoid = poperacion;


   select montosolicitado into nmontosolicitado from solicitudprestamo where solicitudprestamoid=psolicitudprestamoid;

   if nmontosolicitado <> pmontoprestamo then
     raise exception 'No se puede realizar cambio en el monto autorizado';
   end if;

   lgenero := coalesce(lgenero,0);
   if lgenero>0 then
     raise exception 'No se pueden realizar cambios en un prestamo que ya realizo movimientos en caja';
   end if;

   select tasanormal,tasamoratoria into ptasanormal1,ptasa_moratoria1 from spstasastipoprestamo(ptipoprestamoid,pmontoprestamo,psocioid,preferenciaprestamo);

   ptasanormal1:=coalesce(ptasanormal1,ptasanormal);
   ptasa_moratoria1:=coalesce(ptasa_moratoria1,ptasa_moratoria);


  if psujetoid>0 then
   update prestamos
      set referenciaprestamo = preferenciaprestamo,
          montoprestamo      = pmontoprestamo,
          saldoprestamo      = psaldoprestamo,
          numero_de_amor     = pnumero_de_amor,
          fecha_otorga       = pfecha_otorga,
          fechaultimopago    = pfecha_otorga,
          fecha_vencimiento  = pfecha_vencimiento,     
          tipoprestamoid     = ptipoprestamoid,
          tasanormal         = ptasanormal1,
          tasa_moratoria     = ptasa_moratoria1,
          socioid            = psocioid,
          dias_de_cobro      = pdias_de_cobro,
          meses_de_cobro     = pmeses_de_cobro,
          dia_mes_cobro      = pdia_mes_cobro,
          fecha_1er_pago     = pfecha_1er_pago,
          clavegarantia      = pclavegarantia,
          monto_garantia     = pmonto_garantia,
          claveestadocredito = pclaveestadocredito,
          usuarioid          = pautorizaprestamo,
          clavefinalidad     = pfinalidadprestamo,
          calculonormalid    = pcalculonormalid,
          calculomoratorioid = pcalculomoratorioid,
          solicitudprestamoid = psolicitudprestamoid,
          norenovaciones     = pnorenovaciones,
          formalizado        = pformalizado,
          condicionid        = pcondicionid,
          clasificacioncreditoid = pclasificacioncreditoid,
          sujetoid           = psujetoid,
          tipoacreditadoid   = ptipoacreditadoid,
          fechavaluaciongarantia = pfechavaluaciongarantia,
          prestamodescontado = pprestamodescontado,
          comision = pcomision,
          tipocobrocomision = ptipocobrocomision,
          ahorrocompromiso = pahorrocompromiso,
          interesanticipado = pinteresanticipado

 where prestamoid = poperacion;
  else


   update prestamos
      set referenciaprestamo = preferenciaprestamo,
          montoprestamo      = pmontoprestamo,
          saldoprestamo      = psaldoprestamo,
          numero_de_amor     = pnumero_de_amor,
          fecha_otorga       = pfecha_otorga,
          fechaultimopago    = pfecha_otorga,
          fecha_vencimiento  = pfecha_vencimiento,     
          tipoprestamoid     = ptipoprestamoid,
          tasanormal         = ptasanormal1,
          tasa_moratoria     = ptasa_moratoria1,
          socioid            = psocioid,
          dias_de_cobro      = pdias_de_cobro,
          meses_de_cobro     = pmeses_de_cobro,
          dia_mes_cobro      = pdia_mes_cobro,
          fecha_1er_pago     = pfecha_1er_pago,
          clavegarantia      = pclavegarantia,
          monto_garantia     = pmonto_garantia,
          claveestadocredito = pclaveestadocredito,
          usuarioid          = pautorizaprestamo,
          clavefinalidad     = pfinalidadprestamo,
          calculonormalid    = pcalculonormalid,
          calculomoratorioid = pcalculomoratorioid,
          solicitudprestamoid = psolicitudprestamoid,
          norenovaciones     = pnorenovaciones,
          formalizado        = pformalizado,
          condicionid        = pcondicionid,
          clasificacioncreditoid = pclasificacioncreditoid,
--          sujetoid           = psujetoid,
          tipoacreditadoid   = ptipoacreditadoid,
          fechavaluaciongarantia = pfechavaluaciongarantia,
          prestamodescontado = pprestamodescontado,
          comision = pcomision,
          tipocobrocomision = ptipocobrocomision,
          ahorrocompromiso = pahorrocompromiso,
          interesanticipado= pinteresanticipado
          
 where prestamoid = poperacion;

  end if;

    delete from amortizaciones where prestamoid=poperacion;
    -- Generar las amortizaciones aqui
    select * INTO lgenero
      from generaramortizaciones(preferenciaprestamo,0,pfecha_otorga);


return poperacion;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuprestamos(character, numeric, numeric, integer, date, date, character, numeric, numeric, integer, integer, integer, integer, date, character, numeric, character, character, character, integer, integer, integer, integer, integer, integer, integer, integer, integer, integer, date, character, numeric, integer, numeric, integer) OWNER TO sistema;

--
-- Name: spuprocampo(integer, character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuprocampo(integer, character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric) RETURNS integer
    AS $_$
declare
 pprocampoid         alias for $1; 
 ptipoprestamoid     alias for $2; 
 pbeneficiarioid     alias for $3; 
 psujetoid           alias for $4; 
 preferenciaprestamo alias for $5; 
 pmontoprestamo      alias for $6; 
 psaldoprestamo      alias for $7; 
 pnumero_de_amor     alias for $8; 
 pfecha_otorga       alias for $9; 
 pfecha_vencimiento  alias for $10;
 ptasanormal         alias for $11;
 ptasa_moratoria     alias for $12;
 pdias_de_cobro      alias for $13;
 pmeses_de_cobro     alias for $14;
 pdia_mes_cobro      alias for $15;
 pfecha_1er_pago     alias for $16;
 pfechaultimopago    alias for $17;
 pnohectareas        alias for $18;
 pcredxhec           alias for $19;
 pcomxhec            alias for $20;
 pcomxch             alias for $21;
 pinteres            alias for $22;
 pmontoentregado     alias for $23;

begin

   update procampo
      set TipoPrestamoID     = ptipoprestamoid,
          BeneficiarioID     = pbeneficiarioid,   
          SujetoID           = psujetoid,
          referenciaprestamo = preferenciaprestamo,
          montoprestamo      = pmontoprestamo,
          saldoprestamo      = psaldoprestamo,     
          numero_de_amor     = pnumero_de_amor,    
          fecha_otorga       = pfecha_otorga,      
          fecha_vencimiento  = pfecha_vencimiento, 
          tasanormal         = ptasanormal,        
          tasa_moratoria     = ptasa_moratoria,    
          dias_de_cobro      = pdias_de_cobro,     
          meses_de_cobro     = pmeses_de_cobro,    
          dia_mes_cobro      = pdia_mes_cobro,     
          fecha_1er_pago     = pfecha_1er_pago,    
          fechaultimopago    = pfechaultimopago,   
          nohectareas        = pnohectareas,       
          credxhec           = pcredxhec,          
          comxhec            = pcomxhec,           
          comxch             = pcomxch,            
          interes            = pinteres,           
          montoentregado     = pmontoentregado    
    where procampoid = pprocampoid;

return pprocampoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuprocampo(integer, character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric) OWNER TO sistema;

--
-- Name: spuprocampo(integer, character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuprocampo(integer, character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric) RETURNS integer
    AS $_$
declare
 pprocampoid         alias for $1; 
 ptipoprestamoid     alias for $2; 
 pbeneficiarioid     alias for $3; 
 psujetoid           alias for $4; 
 preferenciaprestamo alias for $5; 
 pmontoprestamo      alias for $6; 
 psaldoprestamo      alias for $7; 
 pnumero_de_amor     alias for $8; 
 pfecha_otorga       alias for $9; 
 pfecha_vencimiento  alias for $10;
 ptasanormal         alias for $11;
 ptasa_moratoria     alias for $12;
 pdias_de_cobro      alias for $13;
 pmeses_de_cobro     alias for $14;
 pdia_mes_cobro      alias for $15;
 pfecha_1er_pago     alias for $16;
 pfechaultimopago    alias for $17;
 pnohectareas        alias for $18;
 pcredxhec           alias for $19;
 pcomxhec            alias for $20;
 pcomxch             alias for $21;
 pinteres            alias for $22;
 pmontoentregado     alias for $23;
 pasesorid           alias for $24;
 pcomisionasesor     alias for $25;

begin

   update procampo
      set TipoPrestamoID     = ptipoprestamoid,
          BeneficiarioID     = pbeneficiarioid,   
          SujetoID           = psujetoid,
          referenciaprestamo = preferenciaprestamo,
          montoprestamo      = pmontoprestamo,
          saldoprestamo      = psaldoprestamo,     
          numero_de_amor     = pnumero_de_amor,    
          fecha_otorga       = pfecha_otorga,      
          fecha_vencimiento  = pfecha_vencimiento, 
          tasanormal         = ptasanormal,        
          tasa_moratoria     = ptasa_moratoria,    
          dias_de_cobro      = pdias_de_cobro,     
          meses_de_cobro     = pmeses_de_cobro,    
          dia_mes_cobro      = pdia_mes_cobro,     
          fecha_1er_pago     = pfecha_1er_pago,    
          fechaultimopago    = pfechaultimopago,   
          nohectareas        = pnohectareas,       
          credxhec           = pcredxhec,          
          comxhec            = pcomxhec,           
          comxch             = pcomxch,            
          interes            = pinteres,           
          montoentregado     = pmontoentregado,
          asesorid           = pasesorid,
          comisionasesor     = pcomisionasesor
    where procampoid = pprocampoid;

return pprocampoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuprocampo(integer, character, integer, integer, character, numeric, numeric, integer, date, date, numeric, numeric, integer, integer, integer, date, date, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric) OWNER TO sistema;

--
-- Name: spupromocion(integer, integer, integer, date, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spupromocion(integer, integer, integer, date, date, integer) RETURNS integer
    AS $_$
declare
  ppromocionid     alias for $1;
  ptipopromocionid alias for $2;
  psocioid         alias for $3;
  pfechaalta       alias for $4;
  pfechabaja       alias for $5;
  pestatus         alias for $6;

begin


   update promocion
      set tipopromocionid = ptipopromocionid,
          socioid = psocioid,
          fechaalta = pfechaalta,
          fechabaja = pfechabaja,
          estatus = pestatus
   where promocionid = ppromocionid;

return ppromocionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spupromocion(integer, integer, integer, date, date, integer) OWNER TO sistema;

--
-- Name: spurango(integer, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spurango(integer, character varying) RETURNS integer
    AS $_$
declare
  prangoid alias for $1;
  pnombrerango alias for $2;
begin


   update rango
      set nombrerango = pnombrerango
    where rangoid = prangoid;

return prangoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spurango(integer, character varying) OWNER TO sistema;

--
-- Name: spurecargos(integer, integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spurecargos(integer, integer, numeric) RETURNS integer
    AS $_$
declare
  pano alias for $1;
  pmes alias for $2;
  pporcentaje alias for $3;
begin

 
   update recargos
      set porcentaje = pporcentaje
    where ano = pano and mes = pmes;

return pano;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spurecargos(integer, integer, numeric) OWNER TO sistema;

--
-- Name: spurelacion(integer, integer, integer, integer, character varying, numeric, integer, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spurelacion(integer, integer, integer, integer, character varying, numeric, integer, integer, integer, integer) RETURNS integer
    AS $_$
declare
  prelacionid alias for $1;
  psolicitudingresoid alias for $2;
  psujetoid alias for $3;
  psocioid alias for $4;
  pparentesco alias for $5;
  pporcentaje alias for $6;
  pesbeneficiario alias for $7;
  pesreferenciapersonal alias for $8;
  pesrepresentante alias for $9;
  pescotitular alias for $10;

  tsocioid int4;
  tsujetoid int4;

begin

   select socioid,sujetoid
     into tsocioid,tsujetoid
     from solicitudingreso
    where solicitudingresoid =  psolicitudingresoid;

   tsocioid:=coalesce(tsocioid,0);
   tsujetoid:=coalesce(tsujetoid,0);

   if tsocioid=psocioid or tsujetoid=psujetoid then
     raise exception 'El mismo socio no puede ser su propia relacion, Verifique su captura !!!';
   end if;

   update relacion
      set solicitudingresoid = psolicitudingresoid,
          sujetoid = psujetoid,
          socioid = psocioid,
          parentesco = pparentesco,
          porcentaje = pporcentaje,
          esbenficiario = pesbeneficiario,
          esreferenciapersonal = pesreferenciapersonal,
          esrepresentante = pesrepresentante,
          escotitular = pescotitular
    where relacionid = prelacionid;

return prelacionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spurelacion(integer, integer, integer, integer, character varying, numeric, integer, integer, integer, integer) OWNER TO sistema;

--
-- Name: spurelacion(integer, integer, integer, integer, character varying, numeric, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spurelacion(integer, integer, integer, integer, character varying, numeric, integer, integer, integer) RETURNS integer
    AS $_$
declare
  prelacionid alias for $1;
  psolicitudingresoid alias for $2;
  psujetoid alias for $3;
  psocioid alias for $4;
  pparentesco alias for $5;
  pporcentaje alias for $6;
  pesbeneficiario alias for $7;
  pesreferenciapersonal alias for $8;
  pesrepresentante alias for $9;

  tsocioid int4;
  tsujetoid int4;

begin

   select socioid,sujetoid
     into tsocioid,tsujetoid
     from solicitudingreso
    where solicitudingresoid =  psolicitudingresoid;

   tsocioid:=coalesce(tsocioid,0);
   tsujetoid:=coalesce(tsujetoid,0);

   if tsocioid=psocioid or tsujetoid=psujetoid then
     raise exception 'El mismo socio no puede ser su propia relacion, Verifique su captura !!!';
   end if;

   update relacion
      set solicitudingresoid = psolicitudingresoid,
          sujetoid = psujetoid,
          socioid = psocioid,
          parentesco = pparentesco,
          porcentaje = pporcentaje,
          esbenficiario = pesbeneficiario,
          esreferenciapersonal = pesreferenciapersonal,
          esrepresentante = pesrepresentante
    where relacionid = prelacionid;

return prelacionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spurelacion(integer, integer, integer, integer, character varying, numeric, integer, integer, integer) OWNER TO sistema;

--
-- Name: spuscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, integer) RETURNS integer
    AS $_$
declare

  psolicitudprestamoid    alias for $1;
  pavalid alias for $2;
  pgenero alias for $3,
  pestadocivil alias for $4;
  ptipovivienda alias for $5;
  ptiempoendomicilio alias for $6;
  pingresomensual alias for $7;
  pegresomensual alias for $8;
  pdependienteseconomicos alias for $9;
  pcalificacionburo alias for $10;
  psocoringid alias for $11;

begin

   update scoring
      set solicitudprestamoid = psolicitudprestamoid,
          avalid = pavalid,
          genero = pgenero,
          estadocivil = pestadocivil,
          tipovivienda = ptipovivienda,
          tiempoendomicilio = ptiempoendomicilio,
          ingresomensual = pingresomensual,
          egresomensual = pegresomensual,
          dependienteseconomicos = pdependienteseconomicos,
          calificacionburo = pcalificacionburo
    where scoringid = pscoringid;

return pgrupoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, integer) OWNER TO sistema;

--
-- Name: spuscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, character, character, character, character, integer, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, character, character, character, character, integer, character, integer) RETURNS integer
    AS $_$
declare

  psolicitudprestamoid    alias for $1;
  pavalid alias for $2;
  pgenero alias for $3;
  pestadocivil alias for $4;
  ptipovivienda alias for $5;
  ptiempoendomicilio alias for $6;
  pingresomensual alias for $7;
  pegresomensual alias for $8;
  pdependienteseconomicos alias for $9;
  pcalificacionburo alias for $10;

  ptelefono1 alias for $11;
  ptelefono2 alias for $12;
  pfuenteingreso alias for $13;
  pactividad alias for $14;
  pverificado alias for $15;
  pobs alias for $16;

  psocoringid alias for $17;

begin

   update scoring
      set solicitudprestamoid = psolicitudprestamoid,
          avalid = pavalid,
          genero = pgenero,
          estadocivil = pestadocivil,
          tipovivienda = ptipovivienda,
          tiempoendomicilio = ptiempoendomicilio,
          ingresomensual = pingresomensual,
          egresomensual = pegresomensual,
          dependienteseconomicos = pdependienteseconomicos,
          calificacionburo = pcalificacionburo,
          telefono1 = ptelefono1,
          telefono2 = ptelefono2,
          fuenteingreso = pfuenteingreso,
          actividad = pactividad,
          verificado = pverificado,
          obs = pobs
    where scoringid = pscoringid;

return pgrupoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuscoring(integer, integer, integer, integer, integer, integer, integer, numeric, numeric, integer, character, character, character, character, integer, character, integer) OWNER TO sistema;

--
-- Name: spusocio(integer, integer, character, integer, integer, character, date, date, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spusocio(integer, integer, character, integer, integer, character, date, date, integer, integer) RETURNS integer
    AS $_$
declare

  psocioid alias for $1;
  psujetoid alias for $2;
  ptiposocioid alias for $3;
  pdocumentacionid alias for $4;
  pdatoingresoid alias for $5;
  pclavesocioint alias for $6;
  pfechaalta alias for $7;
  pfechabaja alias for $8;
  prepresentanteid alias for $9;
  pestatussocio    alias for $10;

  oldestatus int4;
  lsaldo numeric;
  lsaldop numeric;
  itiposocioid int4;
  lrepresentanteid int4;
begin

   select estatussocio,tiposocioid,representanteid
     into oldestatus,itiposocioid,lrepresentanteid
     from socio
    where socioid=psocioid;

   if lrepresentanteid<>prepresentanteid then
--   raise exception 'El representante del socio CAMBIO !!! Nuevo=%',prepresentanteid;
   end if;

   if oldestatus=1 and pestatussocio=2 and itiposocioid=2 then
     -- Validar que no tenga ni prestamos ni saldos en movimientos
     select saldo into lsaldo
       from spssaldosmov(psocioid)
      where tipomovimientoid<>'PA';

     lsaldo:=coalesce(lsaldo,0);

     if lsaldo>0 then
       raise exception 'El socio debe tener saldos de 0 para poder realizar la BAJA, excepto en Parte Social.';
     end if;

     select sum(saldoprestamo) into lsaldop
       from prestamos
      where socioid=psocioid and claveestadocredito='001' and saldoprestamo>0;

     lsaldop := coalesce(lsaldop,0);

     if lsaldop>0 then
       raise exception 'El socio no debe tener adeudos de prestamos para realizar la BAJA, Verifiquelo !!!';
     end if;

   end if;

   update socio
    set sujetoid = psujetoid,
        tiposocioid = ptiposocioid,
        documentacionid = pdocumentacionid,
        datoingresoid = pdatoingresoid,
        clavesocioint = pclavesocioint,
        fechaalta = pfechaalta,
        fechabaja = pfechabaja,
        representanteid = prepresentanteid,
        estatussocio = pestatussocio
   where socioid = psocioid;     

return psocioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spusocio(integer, integer, character, integer, integer, character, date, date, integer, integer) OWNER TO sistema;

--
-- Name: spusocio(integer, integer, character, character, date, date, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spusocio(integer, integer, character, character, date, date, integer, integer, integer) RETURNS integer
    AS $_$
declare

  psocioid alias for $1;
  psujetoid alias for $2;
  ptiposocioid alias for $3;
  pclavesocioint alias for $4;
  pfechaalta alias for $5;
  pfechabaja alias for $6;
  pestatussocio    alias for $7;
  psolicitudingresoid alias for $8;
  pmotivobajaid alias for $9;

  oldestatus int4;
  lsaldo numeric;
  lsaldop numeric;
  itiposocioid int4;

  fsaldoaval numeric;
begin

   select estatussocio,tiposocioid
     into oldestatus,itiposocioid
     from socio
    where socioid=psocioid;

   if oldestatus=1 and pestatussocio=2 and itiposocioid=2 then
     -- Validar que no tenga ni prestamos ni saldos en movimientos
     select saldo into lsaldo
       from spssaldosmov(psocioid)
      where tipomovimientoid<>'PA';

     lsaldo:=coalesce(lsaldo,0);

     if lsaldo>0 then
       raise exception 'El socio debe tener saldos de 0 para poder realizar la BAJA, excepto en Parte Social.';
     end if;

     select sum(saldoprestamo) into lsaldop
       from prestamos
      where socioid=psocioid and claveestadocredito='001' and saldoprestamo>0;

     lsaldop := coalesce(lsaldop,0);

     if lsaldop>0 then
       raise exception 'El socio no debe tener adeudos de prestamos para realizar la BAJA, Verifiquelo !!!';
     end if;

     fsaldoaval:=0;

     select sum(p.saldoprestamo)
       into fsaldoaval
       from prestamos p, avales a
      where a.socioid=psocioid and
            a.prestamoid is not null and
            p.prestamoid=a.prestamoid and
            p.saldoprestamo>0 and
            p.claveestadocredito<>'008' and
            p.claveestadocredito<>'002';

     fsaldoaval:=coalesce(fsaldoaval,0);
     if fsaldoaval>0 then
        raise exception 'El socio es AVAL de prestamos no liquidados, Verifiquelo !';
     end if;

   end if;


   update socio
    set tiposocioid = ptiposocioid,
        clavesocioint = pclavesocioint,
        fechaalta = pfechaalta,
        fechabaja = pfechabaja,
        estatussocio = pestatussocio,
        --solicitudingresoid = psolicitudingresoid,
        motivobajaid = pmotivobajaid
   where socioid = psocioid;     

return psocioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spusocio(integer, integer, character, character, date, date, integer, integer, integer) OWNER TO sistema;

--
-- Name: spusolicitudingreso(integer, integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spusolicitudingreso(integer, integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text) RETURNS integer
    AS $_$
declare

  psolicitudingresoid     alias for $1; 
  pnosolicitud            alias for $2; 
  pfechasolicitud         alias for $3; 
  pfechaingreso           alias for $4; 
  psocioid                alias for $5; 
  psujetoid               alias for $6; 
  pciudadmexid            alias for $7; 
  psexo                   alias for $8; 
  pnivelestudios          alias for $9; 
  pprofesion              alias for $10;
  pocupacion              alias for $11;
  ptipocasaid             alias for $12;
  pestadocivilid          alias for $13;
  pconyugeid              alias for $14;
  pregimenmatrimonial     alias for $15;
  ptiempovivirendomicilio alias for $16;
  pmotivoingresoid        alias for $17;
  pmedioseenteroid        alias for $18;
  pperteneceaotracaja     alias for $19;
  potracaja               alias for $20;
  pclaveescuela           alias for $21;
  pnombreescuela          alias for $22;
  ppersonaautorizadaid    alias for $23;
  pusuarioid              alias for $24;
  plastusuarioid          alias for $25;
  plastupdate             alias for $26;
  ptiposocioid            alias for $27;
  pobservaciones          alias for $28;

begin

  update solicitudingreso
     set nosolicitud           = pnosolicitud,           
         fechasolicitud        = pfechasolicitud,        
         fechaingreso          = pfechaingreso,          
--         socioid               = psocioid,               
         sujetoid              = psujetoid,              
         ciudadmexid           = pciudadmexid,           
         sexo                  = psexo,                  
         nivelestudiosid       = pnivelestudios,         
         profesion             = pprofesion,             
         ocupacion             = pocupacion,             
         tipocasaid            = ptipocasaid,            
         estadocivilid         = pestadocivilid,         
--         conyugeid             = pconyugeid,             
         regimenmatrimonial    = pregimenmatrimonial,    
         tiempovivirendomicilio= ptiempovivirendomicilio,
         motivoingresoid       = pmotivoingresoid,       
         medioseenteroid       = pmedioseenteroid,       
         perteneceaotracaja    = pperteneceaotracaja,    
         otracaja              = potracaja,              
         claveescuela          = pclaveescuela,          
         nombreescuela         = pnombreescuela,         
--         personaautorizadaid   = ppersonaautorizadaid,   
         usuarioid             = pusuarioid,             
         lastusuarioid         = plastusuarioid,         
         lastupdate            = plastupdate,
         tiposocioid           = ptiposocioid,
         observaciones         = pobservaciones
   where solicitudingresoid=psolicitudingresoid;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spusolicitudingreso(integer, integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text) OWNER TO sistema;

--
-- Name: spusolicitudingreso(integer, integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text, integer, text, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spusolicitudingreso(integer, integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text, integer, text, integer) RETURNS integer
    AS $_$
declare

  psolicitudingresoid     alias for $1; 
  pnosolicitud            alias for $2; 
  pfechasolicitud         alias for $3; 
  pfechaingreso           alias for $4; 
  psocioid                alias for $5; 
  psujetoid               alias for $6; 
  pciudadmexid            alias for $7; 
  psexo                   alias for $8; 
  pnivelestudios          alias for $9; 
  pprofesion              alias for $10;
  pocupacion              alias for $11;
  ptipocasaid             alias for $12;
  pestadocivilid          alias for $13;
  pconyugeid              alias for $14;
  pregimenmatrimonial     alias for $15;
  ptiempovivirendomicilio alias for $16;
  pmotivoingresoid        alias for $17;
  pmedioseenteroid        alias for $18;
  pperteneceaotracaja     alias for $19;
  potracaja               alias for $20;
  pclaveescuela           alias for $21;
  pnombreescuela          alias for $22;
  ppersonaautorizadaid    alias for $23;
  pusuarioid              alias for $24;
  plastusuarioid          alias for $25;
  plastupdate             alias for $26;
  ptiposocioid            alias for $27;
  pobservaciones          alias for $28;

  pdoccompleta            alias for $29;
  pdocfaltante            alias for $30;
  ppersonajuridicaid      alias for $31;
begin

   if  pestadocivilid = 1 and pconyugeid is NULL then
     raise exception 'Debe teclear el conyuge si la persona es casada';
   end if;

  update solicitudingreso
     set nosolicitud           = pnosolicitud,           
         fechasolicitud        = pfechasolicitud,        
         fechaingreso          = pfechaingreso,          
--         socioid               = psocioid,               
         sujetoid              = psujetoid,              
         ciudadmexid           = pciudadmexid,           
         sexo                  = psexo,                  
         nivelestudiosid       = pnivelestudios,         
         profesion             = pprofesion,             
         ocupacion             = pocupacion,             
         tipocasaid            = ptipocasaid,            
         estadocivilid         = pestadocivilid,         
         conyugeid             = pconyugeid,             
         regimenmatrimonial    = pregimenmatrimonial,    
         tiempovivirendomicilio= ptiempovivirendomicilio,
         motivoingresoid       = pmotivoingresoid,       
         medioseenteroid       = pmedioseenteroid,       
         perteneceaotracaja    = pperteneceaotracaja,    
         otracaja              = potracaja,              
         claveescuela          = pclaveescuela,          
         nombreescuela         = pnombreescuela,         
--         personaautorizadaid   = ppersonaautorizadaid,   
         usuarioid             = pusuarioid,             
         lastusuarioid         = plastusuarioid,         
         lastupdate            = plastupdate,
         tiposocioid           = ptiposocioid,
         observaciones         = pobservaciones,
         doccompleta           = pdoccompleta,
         docfaltante           = pdocfaltante,
         personajuridicaid     = ppersonajuridicaid
   where solicitudingresoid=psolicitudingresoid;


if psocioid is not null then
  update socio
     set tiposocioid=ptiposocioid
   where socioid=psocioid;
end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spusolicitudingreso(integer, integer, date, date, integer, integer, integer, integer, integer, character varying, character varying, integer, integer, integer, integer, character varying, integer, integer, integer, character varying, character varying, character varying, integer, character, character, date, character, text, integer, text, integer) OWNER TO sistema;

--
-- Name: spusolicitudprestamo(integer, integer, integer, character, character, character, integer, integer, date, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric, integer, numeric, numeric, date, date, character varying, date, integer, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spusolicitudprestamo(integer, integer, integer, character, character, character, integer, integer, date, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric, integer, numeric, numeric, date, date, character varying, date, integer, integer, character) RETURNS integer
    AS $_$
declare
  
  psolicitudprestamoid alias for $1;
  psocioid alias for $2;
  psujetoid alias for $3;
  ptipoprestamoid alias for $4;
  pclavefinalidad alias for $5;
  pclavegarantia alias for $6;
  pdomicilioid alias for $7;
  pnosolicitud alias for $8;
  pfechasolicitud alias for $9;
  psueldo alias for $10;
  psueldoconyuge alias for $11;
  potrosingresos alias for $12;
  ptotalingresos alias for $13;
  pgastosordinarios alias for $14;
  potrosgastos alias for $15;
  potrosabonos alias for $16;
  ptotalegresos alias for $17;
  pcapacidadpago alias for $18;
  pvalorpropiedades alias for $19;
  ptotaldeudas alias for $20;
  pabonospropuestos alias for $21;
  pmontosolicitado alias for $22;
  pperiodopagoid alias for $23;
  ptasanormal alias for $24;
  ptasamoratorio alias for $25;
  pfecharesultado alias for $26;
  pfechaentrega alias for $27;
  pactano alias for $28;
  pfechacomite alias for $29;
  presolucionid alias for $30;
  pentregado alias for $31;
  pusuarioid alias for $32;
--  plastusuarioid alias for $33;
--  plastupdate alias for $34;
--  pprimerpago alias for $35;
--  pempresatrabaja alias for $36;
--  pjefedirecto alias for $37;
--  pverificado alias for $38;
--  pobsinvestigaion alias for $39;
--  pobservaciones alias for $40;

  ptasanormal1 numeric;
  ptasamoratorio1 numeric;

begin

  raise notice ' 1 % % ',ptasanormal1,ptasamoratorio1;


  if   ptotalingresos <=  ptotalegresos then 
    raise exception 'Los egresos son mayores a los ingresos.';
  end if;

  if exists (select prestamoid from prestamos where solicitudprestamoid=psolicitudprestamoid) then
      raise exception 'No se pueden modificar solicitudes ya autorizadas !';
  end if;


  select tasanormal,tasamoratoria into ptasanormal1,ptasamoratorio1 from spstasastipoprestamo(ptipoprestamoid,pmontosolicitado,psocioid,' ');

  ptasanormal1:=coalesce(ptasanormal1,ptasanormal);
  ptasamoratorio1:=coalesce(ptasamoratorio1,ptasamoratorio);

  raise notice ' 2 % % ',ptasanormal1,ptasamoratorio1;


  update solicitudprestamo
     set socioid=psocioid,            
      sujetoid=psujetoid,           
      tipoprestamoid=ptipoprestamoid,     
      clavefinalidad=pclavefinalidad,     
      clavegarantia=pclavegarantia,      
      domicilioid=pdomicilioid,        
--      nosolicitud=pnosolicitud,        
      fechasolicitud=pfechasolicitud,     
      sueldo=psueldo,             
      sueldoconyuge=psueldoconyuge,      
      otrosingresos=potrosingresos,      
      totalingresos=ptotalingresos,      
      gastosordinarios=pgastosordinarios,   
      otrosgastos=potrosgastos,        
      otrosabonos=potrosabonos,        
      totalegresos=ptotalegresos,       
      capacidadpago=pcapacidadpago,      
      valorpropiedades=pvalorpropiedades,   
      totaldeudas=ptotaldeudas,        
      abonospropuestos=pabonospropuestos,   
      montosolicitado=pmontosolicitado,    
      periodopagoid=pperiodopagoid,      
      tasanormal=ptasanormal,         
      tasamoratorio=ptasamoratorio,      
      fecharesultado=pfecharesultado,     
      fechaentrega=pfechaentrega,       
      actano=pactano,             
      fechacomite=pfechacomite,        
      resolucionid=presolucionid,       
      entregado=pentregado,          
      usuarioid=pusuarioid,
      lastusuarioid=pusuarioid
--      lastusuarioid=plastusuarioid,      
--      lastupdate=plastupdate,         
--      primerpago=pprimerpago,         
--      empresatrabaja=pempresatrabaja,     
--      jefedirecto=pjefedirecto,        
--      verificado=pverificado,         
--      obsinvestigacion=pobsinvestigacion,   
--      observaciones=pobservaciones
  where solicitudprestamoid=psolicitudprestamoid;


return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spusolicitudprestamo(integer, integer, integer, character, character, character, integer, integer, date, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, numeric, integer, numeric, integer, numeric, numeric, date, date, character varying, date, integer, integer, character) OWNER TO sistema;

--
-- Name: spusubrango(integer, integer, character, character, integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spusubrango(integer, integer, character, character, integer, numeric) RETURNS character
    AS $_$
declare

  psubrangoid alias for $1;
  prangoid alias for $2;
  prangoinicial alias for $3;
  prangofinal alias for $4;
  poperacion alias for $5;
  pfactor alias for $6;

begin

   update subrango
      set rangoid = prangoid,
          rangoinicial = prangoinicial,
          rangofinal = prangofinal,
          operacion = poperacion,
          factor = pfactor
    where subrangoid = psubrangoid;

return psubrangoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spusubrango(integer, integer, character, character, integer, numeric) OWNER TO sistema;

--
-- Name: spusujeto(integer, character varying, character varying, character varying, character, character, integer, date, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spusujeto(integer, character varying, character varying, character varying, character, character, integer, date, character varying) RETURNS integer
    AS $_$
declare
  psujetoid alias for $1;
  ppaterno alias for $2;
  pmaterno alias for $3;
  pnombre alias for $4;
  prfc alias for $5;
  pcurp alias for $6;
  pedad alias for $7;
  pfecha_nacimiento alias for $8;
  prazonsocial alias for $9;

begin

   if pfecha_nacimiento='01-01-1900' then
--     raise exception 'La fecha de nacimiento es incorrecta, Verifique !!!';
   end if;

   update sujeto
      set paterno = ppaterno,
          materno = pmaterno,
          nombre = pnombre,
          rfc = prfc,
          curp = pcurp,
          edad = pedad,
          fecha_nacimiento = pfecha_nacimiento,
          razonsocial = prazonsocial
    where sujetoid = psujetoid;

return psujetoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spusujeto(integer, character varying, character varying, character varying, character, character, integer, date, character varying) OWNER TO sistema;

--
-- Name: sputablon(integer, integer, date, text, character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputablon(integer, integer, date, text, character, character, date) RETURNS integer
    AS $_$
declare

  ptablonid       alias for $1;
  psocioid        alias for $2;
  pfechatablon    alias for $3;
  ptextotablon    alias for $4;
  pvigente        alias for $5;
  pusuarioid      alias for $6;
  pfechavigencia  alias for $7;

begin


   update tablon
      set socioid = psocioid,
          fechatablon = pfechatablon,
          textotablon = ptextotablon,
          vigente = pvigente,
          usuarioid = pusuarioid,
          fechavigencia = pfechavigencia
    where tablonid=ptablonid;

return ptablonid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputablon(integer, integer, date, text, character, character, date) OWNER TO sistema;

--
-- Name: sputipo_garantia(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipo_garantia(character, character varying) RETURNS character
    AS $_$
declare
  pclavegarantia alias for $1;
  pdescripciongarantia alias for $2;
begin

   update tipo_garantia
      set descripciongarantia = pdescripciongarantia
    where clavegarantia = pclavegarantia;

return pclavegarantia;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipo_garantia(character, character varying) OWNER TO sistema;

--
-- Name: sputipoacreditador(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipoacreditador(integer, character) RETURNS integer
    AS $_$
declare
  ptipocreditadoid           alias for $1;
  pdescripciontipoacreditado alias for $2;
begin


   update tipoacreditador
      set descripciontipoacreditado = pdescripciontipoacreditado,
    where tipocreditadoid = ptipocreditadoid;

return ptipocreditadoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipoacreditador(integer, character) OWNER TO sistema;

--
-- Name: sputipoaviso(integer, character, character, integer, integer, character, integer, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipoaviso(integer, character, character, integer, integer, character, integer, integer) RETURNS integer
    AS $_$
declare
  ptipoavisoid alias for $1;
  pdescripciontipoaviso alias for $2;
  pprocedimientoaimprimir alias for $3;
  pdiainicial alias for $4;
  pdiafinal alias for $5;
  pclasificacion alias for $6;
  pparasocio alias for $7;
  pparaaval alias for $8;

begin

   update tipoaviso
      set descripciontipoaviso = pdescripciontipoaviso,
          procedimientoaimprimir = pprocedimientoaimprimir,
          diainicial = pdiainicial,
          diafinal = pdiafinal,
          clasificacion = pclasificacion,
          parasocio = pparasocio,
          paraaval = pparaaval
    where tipoavisoid = ptipoavisoid;

return ptipoavisoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipoaviso(integer, character, character, integer, integer, character, integer, integer) OWNER TO sistema;

--
-- Name: sputipoinversion(character, character varying, numeric, integer, character, character, character, character, character, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipoinversion(character, character varying, numeric, integer, character, character, character, character, character, character, character, integer) RETURNS character
    AS $_$
declare

  ptipoinversionid alias for $1;
  pdesctipoinversion alias for $2;
  ptasa_normal_inversion alias for $3;
  pplazo alias for $4;
  pcuentapasivo alias for $5;
  pcuentapasivovencida alias for $6;
  pcuentaintinver alias for $7;
  pcuentaintinvernocob alias for $8;
  pcuentaivainver alias for $9;
  pcuentariesgocred alias for $10;
  paplicaivainversion alias for $11;
  pcalculoid alias for $12;

begin

   update tipoinversion
      set desctipoinversion    = pdesctipoinversion,  
          tasa_normal_inversion = ptasa_normal_inversion,        
          plazo                = pplazo,              
          cuentapasivo         = pcuentapasivo,       
          cuentapasivovencida  = pcuentapasivovencida,
          cuentaintinver       = pcuentaintinver,     
          cuentaintinvernocob  = pcuentaintinvernocob,
          cuentaivainver       = pcuentaivainver,     
          cuentariesgocred     = pcuentariesgocred,   
          aplicaivainversion   = paplicaivainversion,
          calculoid            = pcalculoid
    where tipoinversionid = ptipoinversionid;

return ptipoinversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipoinversion(character, character varying, numeric, integer, character, character, character, character, character, character, character, integer) OWNER TO sistema;

--
-- Name: sputipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character) RETURNS character
    AS $_$
declare

  ptipoinversionid alias for $1;
  pcuentariesgocred alias for $2;
  pcuentaintinvernocob alias for $3;
  pcalculoid alias for $4;
  pcuentapasivo alias for $5;
  pcuentapasivovencida alias for $6;
  pcuentaintinver alias for $7;
  pcuentaivainver alias for $8;
  pdesctipoinversion alias for $9;
  ptasa_normal_inversion alias for $10;
  pplazo alias for $11;
  paplicaivainversion alias for $12;
  paplicaisr alias for $13;
  preinvierteinteres alias for $14;
  ptipomovimientoid alias for $15;
  pcuentaprovisionisr alias for $16;

begin

   update tipoinversion
      set cuentariesgocred     =pcuentariesgocred     ,
          cuentaintinvernocob  =pcuentaintinvernocob  ,  
          calculoid            =pcalculoid            ,            
          cuentapasivo         =pcuentapasivo         ,         
          cuentapasivovencida  =pcuentapasivovencida  ,  
          cuentaintinver       =pcuentaintinver       ,       
          cuentaivainver       =pcuentaivainver       ,       
          desctipoinversion    =pdesctipoinversion    ,    
          tasa_normal_inversion=ptasa_normal_inversion,
          plazo                =pplazo                ,                
          aplicaivainversion   =paplicaivainversion   ,   
          aplicaisr            =paplicaisr            ,            
          reinvierteinteres    =preinvierteinteres    ,    
          tipomovimientoid     =ptipomovimientoid     ,     
          cuentaprovisionisr   =pcuentaprovisionisr   
    where tipoinversionid = ptipoinversionid;

return ptipoinversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character) OWNER TO sistema;

--
-- Name: sputipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character, integer) RETURNS character
    AS $_$
declare

  ptipoinversionid alias for $1;
  pcuentariesgocred alias for $2;
  pcuentaintinvernocob alias for $3;
  pcalculoid alias for $4;
  pcuentapasivo alias for $5;
  pcuentapasivovencida alias for $6;
  pcuentaintinver alias for $7;
  pcuentaivainver alias for $8;
  pdesctipoinversion alias for $9;
  ptasa_normal_inversion alias for $10;
  pplazo alias for $11;
  paplicaivainversion alias for $12;
  paplicaisr alias for $13;
  preinvierteinteres alias for $14;
  ptipomovimientoid alias for $15;
  pcuentaprovisionisr alias for $16;
  pclasificacionid alias for $17;

begin

   update tipoinversion
      set cuentariesgocred     =pcuentariesgocred     ,
          cuentaintinvernocob  =pcuentaintinvernocob  ,  
          calculoid            =pcalculoid            ,            
          cuentapasivo         =pcuentapasivo         ,         
          cuentapasivovencida  =pcuentapasivovencida  ,  
          cuentaintinver       =pcuentaintinver       ,       
          cuentaivainver       =pcuentaivainver       ,       
          desctipoinversion    =pdesctipoinversion    ,    
          tasa_normal_inversion=ptasa_normal_inversion,
          plazo                =pplazo                ,                
          aplicaivainversion   =paplicaivainversion   ,   
          aplicaisr            =paplicaisr            ,            
          reinvierteinteres    =preinvierteinteres    ,    
          tipomovimientoid     =ptipomovimientoid     ,     
          cuentaprovisionisr   =pcuentaprovisionisr   ,
          clasificacionid      =pclasificacionid
    where tipoinversionid = ptipoinversionid;

return ptipoinversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipoinversion(character, character, character, integer, character, character, character, character, character, numeric, integer, character, integer, integer, character, character, integer) OWNER TO sistema;

--
-- Name: sputipomovibanco(character, character varying, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipomovibanco(character, character varying, character) RETURNS character
    AS $_$
declare
  ptipomovibancoid alias for $1;
  pdescritipomovibanco alias for $2;
  poperacionsumaresta alias for $3;
begin

   update tipomovibanco
      set descritipomovibanco = pdescritipomovibanco,
          operacionsumaresta = poperacionsumaresta
    where tipomovibancoid = ptipomovibancoid;

return ptipomovibancoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipomovibanco(character, character varying, character) OWNER TO sistema;

--
-- Name: sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character) RETURNS character
    AS $_$
declare

  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro alias for $12;

begin

   update tipomovimiento
      set desctipomovimiento = pdesctipomovimiento,
          aplicasaldo = paplicasaldo,
          cuentadeposito = pcuentadeposito,
          cuentaretiro = pcuentaretiro,
          cuentaintpagado = pcuentaintpagado,
          cuentaintcobrado = pcuentaintcobrado,
          cuentaivamovimiento = pcuentaivamovimiento,
          cuentaisr = pcuentaisr,
          tipopoliza = ptipopoliza,
          aceptadeposito = paceptadeposito,
          aceptaretiro = paceptaretiro
    where tipomovimientoid = ptipomovimientoid;

return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric) RETURNS character
    AS $_$
declare

  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro alias for $12;
  ptasainteres alias for $13;

begin

   update tipomovimiento
      set desctipomovimiento = pdesctipomovimiento,
          aplicasaldo = paplicasaldo,
          cuentadeposito = pcuentadeposito,
          cuentaretiro = pcuentaretiro,
          cuentaintpagado = pcuentaintpagado,
          cuentaintcobrado = pcuentaintcobrado,
          cuentaivamovimiento = pcuentaivamovimiento,
          cuentaisr = pcuentaisr,
          tipopoliza = ptipopoliza,
          aceptadeposito = paceptadeposito,
          aceptaretiro = paceptaretiro,
          tasainteres = ptasainteres
    where tipomovimientoid = ptipomovimientoid;

return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric) OWNER TO sistema;

--
-- Name: sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character) RETURNS character
    AS $_$
declare

  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro alias for $12;
  ptasainteres alias for $13;
  pcuentaordenacredor alias for $14;
  pcuentaordendeudor alias for $15;
  pcuentaorden alias for $16;

begin

   update tipomovimiento
      set desctipomovimiento = pdesctipomovimiento,
          aplicasaldo = paplicasaldo,
          cuentadeposito = pcuentadeposito,
          cuentaretiro = pcuentaretiro,
          cuentaintpagado = pcuentaintpagado,
          cuentaintcobrado = pcuentaintcobrado,
          cuentaivamovimiento = pcuentaivamovimiento,
          cuentaisr = pcuentaisr,
          tipopoliza = ptipopoliza,
          aceptadeposito = paceptadeposito,
          aceptaretiro = paceptaretiro,
          tasainteres = ptasainteres,
          cuentaordenacredor = pcuentaordenacredor,           
          cuentaordendeudor = pcuentaordendeudor,
          cuentaorden = pcuentaorden
    where tipomovimientoid = ptipomovimientoid;

return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character) OWNER TO sistema;

--
-- Name: sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character) RETURNS character
    AS $_$
declare

  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro alias for $12;
  ptasainteres alias for $13;
  pcuentaordenacredor alias for $14;
  pcuentaordendeudor alias for $15;
  pcuentaorden alias for $16;
  pcuentaprovisionisr alias for $17;

begin

   update tipomovimiento
      set desctipomovimiento = pdesctipomovimiento,
          aplicasaldo = paplicasaldo,
          cuentadeposito = pcuentadeposito,
          cuentaretiro = pcuentaretiro,
          cuentaintpagado = pcuentaintpagado,
          cuentaintcobrado = pcuentaintcobrado,
          cuentaivamovimiento = pcuentaivamovimiento,
          cuentaisr = pcuentaisr,
          tipopoliza = ptipopoliza,
          aceptadeposito = paceptadeposito,
          aceptaretiro = paceptaretiro,
          tasainteres = ptasainteres,
          cuentaordenacredor = pcuentaordenacredor,           
          cuentaordendeudor = pcuentaordendeudor,
          cuentaorden = pcuentaorden,
          cuentaprovisionisr = pcuentaprovisionisr
    where tipomovimientoid = ptipomovimientoid;

return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character) OWNER TO sistema;

--
-- Name: sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character, character) RETURNS character
    AS $_$
declare

  ptipomovimientoid alias for $1;
  pdesctipomovimiento alias for $2;
  paplicasaldo alias for $3;
  pcuentadeposito alias for $4;
  pcuentaretiro alias for $5;
  pcuentaintpagado alias for $6;
  pcuentaintcobrado alias for $7;
  pcuentaivamovimiento alias for $8;
  pcuentaisr alias for $9;
  ptipopoliza alias for $10;
  paceptadeposito alias for $11;
  paceptaretiro alias for $12;
  ptasainteres alias for $13;
  pcuentaordenacredor alias for $14;
  pcuentaordendeudor alias for $15;
  pcuentaorden alias for $16;
  pcuentaprovisionisr alias for $17;
  pcuentacxcide alias for $18;

begin

   update tipomovimiento
      set desctipomovimiento = pdesctipomovimiento,
          aplicasaldo = paplicasaldo,
          cuentadeposito = pcuentadeposito,
          cuentaretiro = pcuentaretiro,
          cuentaintpagado = pcuentaintpagado,
          cuentaintcobrado = pcuentaintcobrado,
          cuentaivamovimiento = pcuentaivamovimiento,
          cuentaisr = pcuentaisr,
          tipopoliza = ptipopoliza,
          aceptadeposito = paceptadeposito,
          aceptaretiro = paceptaretiro,
          tasainteres = ptasainteres,
          cuentaordenacredor = pcuentaordenacredor,           
          cuentaordendeudor = pcuentaordendeudor,
          cuentaorden = pcuentaorden,
          cuentaprovisionisr = pcuentaprovisionisr,
          cuentacxcide = pcuentacxcide
    where tipomovimientoid = ptipomovimientoid;



return ptipomovimientoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipomovimiento(character, character varying, character, character, character, character, character, character, character, character, character, character, numeric, character, character, character, character, character) OWNER TO sistema;

--
-- Name: sputipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character) RETURNS character
    AS $_$
declare
  ptipoprestamoid alias for $1;
  pdesctipoprestamo alias for $2;
  ptantos alias for $3;
  ptasa_normal alias for $4;
  ptasa_mora alias for $5;
  ptipomovimientoid alias for $6;
  pcuentaactivo alias for $7;
  pcuentaactivovencida alias for $8;
  pcuentaintnormal alias for $9;
  pcuentaintnormalvencida alias for $10;
  pcuentaintnormalnocob alias for $11;
  pcuentaintmora alias for $12;
  pcuentaintmoravencida alias for $13;
  pcuentaiva alias for $14;
  pcuentariesgocred alias for $15;
  pcuentaordenaval alias for $16;
  pcuentaordeninteres alias for $17;
  paplicaivaprestamo alias for $18;
  pdiastraspasoavencida alias for $19;
  pcuentaintdevnocobres alias for $20;
  pcuentariesgocredres alias for $21;
  pcuentaintmoranocobact alias for $22;
  pcuentaintmoradevnocobres alias for $23;

  pordendeudornormalbonificado  alias for $24;
  pordenacredornormalbonificado alias for $25;

  pcuentafondorecuperacion alias for $26;
  pcuentagtosadm alias for $27;

begin

   update tipoprestamo
      set desctipoprestamo = pdesctipoprestamo,
          tantos = ptantos,
          tasa_normal = ptasa_normal,
          tasa_mora = ptasa_mora, 
          tipomovimientoid = ptipomovimientoid,
          cuentaactivo = pcuentaactivo, 
          cuentaactivovencida = pcuentaactivovencida,
          cuentaintnormal = pcuentaintnormal , 
          cuentaintnormalvencida = pcuentaintnormalvencida,
          cuentaintnormalnocob = pcuentaintnormalnocob,
          cuentaintmora = pcuentaintmora, 
          cuentaintmoravencida = pcuentaintmoravencida,
          cuentaiva = pcuentaiva, 
          cuentariesgocred = pcuentariesgocred,
          cuentaordenaval = pcuentaordenaval, 
          cuentaordeninteres = pcuentaordeninteres,
          aplicaivaprestamo = paplicaivaprestamo,
          diastraspasoavencida = pdiastraspasoavencida,
          cuentaintdevnocobres = pcuentaintdevnocobres,
          cuentariesgocredres = pcuentariesgocredres,
          cuentaintmoranocobact = pcuentaintmoranocobact,
          cuentaintmoradevnocobres = pcuentaintmoradevnocobres,
          ordendeudornormalbonificado = pordendeudornormalbonificado,
          ordenacredornormalbonificado = pordenacredornormalbonificado,
          cuentafondorecuperacion = pcuentafondorecuperacion,
          cuentagtosadm = pcuentagtosadm
    where tipoprestamoid = ptipoprestamoid;

return ptipoprestamoid;
end
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.sputipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: sputipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character) RETURNS character
    AS $_$
declare
  ptipoprestamoid alias for $1;
  pdesctipoprestamo alias for $2;
  ptantos alias for $3;
  ptasa_normal alias for $4;
  ptasa_mora alias for $5;
  ptipomovimientoid alias for $6;
  pcuentaactivo alias for $7;
  pcuentaactivovencida alias for $8;
  pcuentaintnormal alias for $9;
  pcuentaintnormalvencida alias for $10;
  pcuentaintnormalnocob alias for $11;
  pcuentaintmora alias for $12;
  pcuentaintmoravencida alias for $13;
  pcuentaiva alias for $14;
  pcuentariesgocred alias for $15;
  pcuentaordenaval alias for $16;
  pcuentaordeninteres alias for $17;
  paplicaivaprestamo alias for $18;
  pdiastraspasoavencida alias for $19;
  pcuentaintdevnocobres alias for $20;
  pcuentariesgocredres alias for $21;
  pcuentaintmoranocobact alias for $22;
  pcuentaintmoradevnocobres alias for $23;

  pordendeudornormalbonificado  alias for $24;
  pordenacredornormalbonificado alias for $25;

  pcuentafondorecuperacion alias for $26;
  pcuentagtosadm alias for $27;

  pcuentaintnormalresvencida alias for $28;
  pordeninteresacreedor alias for $29;

begin

   update tipoprestamo
      set desctipoprestamo = pdesctipoprestamo,
          tantos = ptantos,
          tasa_normal = ptasa_normal,
          tasa_mora = ptasa_mora, 
          tipomovimientoid = ptipomovimientoid,
          cuentaactivo = pcuentaactivo, 
          cuentaactivovencida = pcuentaactivovencida,
          cuentaintnormal = pcuentaintnormal , 
          cuentaintnormalvencida = pcuentaintnormalvencida,
          cuentaintnormalnocob = pcuentaintnormalnocob,
          cuentaintmora = pcuentaintmora, 
          cuentaintmoravencida = pcuentaintmoravencida,
          cuentaiva = pcuentaiva, 
          cuentariesgocred = pcuentariesgocred,
          cuentaordenaval = pcuentaordenaval, 
          cuentaordeninteres = pcuentaordeninteres,
          aplicaivaprestamo = paplicaivaprestamo,
          diastraspasoavencida = pdiastraspasoavencida,
          cuentaintdevnocobres = pcuentaintdevnocobres,
          cuentariesgocredres = pcuentariesgocredres,
          cuentaintmoranocobact = pcuentaintmoranocobact,
          cuentaintmoradevnocobres = pcuentaintmoradevnocobres,
          ordendeudornormalbonificado = pordendeudornormalbonificado,
          ordenacredornormalbonificado = pordenacredornormalbonificado,
          cuentafondorecuperacion = pcuentafondorecuperacion,
          cuentagtosadm = pcuentagtosadm,
          cuentaintnormalresvencida = pcuentaintnormalresvencida,
          ordeninteresacreedor = pordeninteresacreedor
    where tipoprestamoid = ptipoprestamoid;

return ptipoprestamoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character) OWNER TO sistema;

--
-- Name: sputipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character, integer, integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character, integer, integer, character) RETURNS character
    AS $_$
declare
  ptipoprestamoid alias for $1;
  pdesctipoprestamo alias for $2;
  ptantos alias for $3;
  ptasa_normal alias for $4;
  ptasa_mora alias for $5;
  ptipomovimientoid alias for $6;
  pcuentaactivo alias for $7;
  pcuentaactivovencida alias for $8;
  pcuentaintnormal alias for $9;
  pcuentaintnormalvencida alias for $10;
  pcuentaintnormalnocob alias for $11;
  pcuentaintmora alias for $12;
  pcuentaintmoravencida alias for $13;
  pcuentaiva alias for $14;
  pcuentariesgocred alias for $15;
  pcuentaordenaval alias for $16;
  pcuentaordeninteres alias for $17;
  paplicaivaprestamo alias for $18;
  pdiastraspasoavencida alias for $19;
  pcuentaintdevnocobres alias for $20;
  pcuentariesgocredres alias for $21;
  pcuentaintmoranocobact alias for $22;
  pcuentaintmoradevnocobres alias for $23;

  pordendeudornormalbonificado  alias for $24;
  pordenacredornormalbonificado alias for $25;

  pcuentafondorecuperacion alias for $26;
  pcuentagtosadm alias for $27;

  pcuentaintnormalresvencida alias for $28;
  pordeninteresacreedor alias for $29;

  pcalculonormalid alias for $30;
  pcalculomoraid alias for $31;
  pclavefinalidad alias for $32;

begin

   update tipoprestamo
      set desctipoprestamo = pdesctipoprestamo,
          tantos = ptantos,
          tasa_normal = ptasa_normal,
          tasa_mora = ptasa_mora, 
          tipomovimientoid = ptipomovimientoid,
          cuentaactivo = pcuentaactivo, 
          cuentaactivovencida = pcuentaactivovencida,
          cuentaintnormal = pcuentaintnormal , 
          cuentaintnormalvencida = pcuentaintnormalvencida,
          cuentaintnormalnocob = pcuentaintnormalnocob,
          cuentaintmora = pcuentaintmora, 
          cuentaintmoravencida = pcuentaintmoravencida,
          cuentaiva = pcuentaiva, 
          cuentariesgocred = pcuentariesgocred,
          cuentaordenaval = pcuentaordenaval, 
          cuentaordeninteres = pcuentaordeninteres,
          aplicaivaprestamo = paplicaivaprestamo,
          diastraspasoavencida = pdiastraspasoavencida,
          cuentaintdevnocobres = pcuentaintdevnocobres,
          cuentariesgocredres = pcuentariesgocredres,
          cuentaintmoranocobact = pcuentaintmoranocobact,
          cuentaintmoradevnocobres = pcuentaintmoradevnocobres,
          ordendeudornormalbonificado = pordendeudornormalbonificado,
          ordenacredornormalbonificado = pordenacredornormalbonificado,
          cuentafondorecuperacion = pcuentafondorecuperacion,
          cuentagtosadm = pcuentagtosadm,
          cuentaintnormalresvencida = pcuentaintnormalresvencida,
          ordeninteresacreedor = pordeninteresacreedor,
          calculonormalid = pcalculonormalid,
          calculomoraid = pcalculomoraid,
          clavefinalidad = pclavefinalidad
    where tipoprestamoid = ptipoprestamoid;

return ptipoprestamoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipoprestamo(character, character, integer, numeric, numeric, character, character, character, character, character, character, character, character, character, character, character, character, character, integer, character, character, character, character, character, character, character, character, character, character, integer, integer, character) OWNER TO sistema;

--
-- Name: sputipopromocion(integer, character, date, date, character varying, integer, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipopromocion(integer, character, date, date, character varying, integer, character varying) RETURNS integer
    AS $_$
declare
  ptipopromocionid  alias for $1;
  ptipomovimientoid alias for $2;
  pfechainicial     alias for $3;
  pfechafinal       alias for $4;
  pcondicion        alias for $5;
  pestatus          alias for $6;
  pdescripcion      alias for $7;

begin


   update tipopromocion
      set tipomovimientoid = ptipomovimientoid,
          fechainicial = pfechainicial,
          fechafinal = pfechafinal,
          condicion = pcondicion,
          estatus = pestatus,
          descripcion = pdescripcion
    where tipopromocionid = ptipopromocionid;

return ptipopromocionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipopromocion(integer, character, date, date, character varying, integer, character varying) OWNER TO sistema;

--
-- Name: sputiposocio(character, character varying, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputiposocio(character, character varying, character varying) RETURNS character
    AS $_$
declare
  ptiposocioid alias for $1;
  pdescritiposocio alias for $2;
  pobservaciones alias for $3;
begin

   update tiposocio
      set descritiposocio = pdescritiposocio,
          observaciones = pobservaciones
    where tiposocioid = ptiposocioid;

return ptiposocioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputiposocio(character, character varying, character varying) OWNER TO sistema;

--
-- Name: sputipousuario(character, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sputipousuario(character, character varying) RETURNS character
    AS $_$
declare
  ptipousuarioid alias for $1;
  pdescripciontipousuario alias for $2;
begin

   update tipousuario
      set descripciontipousuario = pdescripciontipousuario
    where tipousuarioid = ptipousuarioid;

return ptipousuarioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sputipousuario(character, character varying) OWNER TO sistema;

--
-- Name: spuudis(date, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuudis(date, numeric) RETURNS date
    AS $_$
declare
  pfecha alias for $1;
  pvalor alias for $2;
begin


   update udis
      set valor = pvalor
    where fecha = pfecha;

return pfecha;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuudis(date, numeric) OWNER TO sistema;

--
-- Name: spuusuario(character, character, character, character varying, character varying, character varying, character varying, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION spuusuario(character, character, character, character varying, character varying, character varying, character varying, integer) RETURNS character
    AS $_$
declare
 pusuarioid      alias for $1;
 ptipousuarioid  alias for $2;
 pusu_usuarioid  alias for $3;
 pcontrasenia    alias for $4;
 pemail          alias for $5;
 pdicola         alias for $6;
 pobsusuario     alias for $7;
 psujetoid       alias for $8;

begin

   update usuarios
      set  tipousuarioid  =  ptipousuarioid,
           usu_usuarioid  =  pusu_usuarioid,
           contrasenia    =  pcontrasenia,  
           email          =  pemail,        
           dicola         =  pdicola,       
           obsusuario     =  pobsusuario,
           sujetoid       =  psujetoid     
    where usuarioid = pusuarioid;

return pusuarioid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.spuusuario(character, character, character, character varying, character varying, character varying, character varying, integer) OWNER TO sistema;

--
-- Name: srptintdevxtipo(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION srptintdevxtipo(date) RETURNS SETOF rptintdevxtipo
    AS $_$
declare
 pfecha alias for $1;
 r rptintdevxtipo%rowtype;

 scuentaid char(24);
 fsaldo1 numeric;
 fsaldo2 numeric;
 fsaldo3 numeric;

 ftotal1 numeric;
 ftotal2 numeric;
begin


  ftotal1:=0;
  ftotal2:=0;

  for r in
    select p.tipoprestamoid,t.desctipoprestamo,
           sum(p.interesdevengadomenoravencido+p.interesdevmormenor),
           sum(p.interesdevengadomayoravencido+p.interesdevmormayor)
      from precorte p, tipoprestamo t
     where p.fechacierre=pfecha and
           t.tipoprestamoid=p.tipoprestamoid
   group by p.tipoprestamoid,t.desctipoprestamo
   order by p.tipoprestamoid
  loop
    ftotal1:=ftotal1+coalesce(r.intdevvigente,0);
    ftotal2:=ftotal2+coalesce(r.intdevvencido,0);
    return next r;
  end loop;

    r.tipoprestamoid:='XXX';
    r.desctipoprestamo:='TOTALES ...';
    r.intdevvigente:=ftotal1;
    r.intdevvencido:=ftotal2;
    return next r;


    select sum(m.debe-m.haber)
      into fsaldo1
      from movipolizas m, polizas p
     where m.cuentaid in (select cuentaintdevnocobres
              from tipoprestamo
             where tipoprestamoid not in ('E1 ','PRO')
             group by cuentaintdevnocobres) and
           p.polizaid=m.polizaid and
           p.fechapoliza<pfecha+1;

    select sum(m.debe-m.haber)
      into fsaldo2
      from polizas p, movipolizas m,
           (select cuentaintnormalvencida
              from tipoprestamo
             where tipoprestamoid not in ('E1 ','PRO')
             group by cuentaintnormalvencida) as t
     where p.fechapoliza<pfecha+1 and
           m.polizaid=p.polizaid and
           m.cuentaid=t.cuentaintnormalvencida;

    select sum(m.debe-m.haber)
      into fsaldo3
      from movipolizas m, polizas p
     where m.cuentaid in (select cuentaordeninteres
              from tipoprestamo
             where tipoprestamoid not in ('E1 ','PRO')
             group by cuentaordeninteres) and
           p.polizaid=m.polizaid and
           p.fechapoliza<pfecha+1;



    fsaldo1:=coalesce(fsaldo1,0);
    fsaldo2:=coalesce(fsaldo2,0);
    fsaldo3:=coalesce(fsaldo3,0);

    r.tipoprestamoid:='ZZZ';
    r.desctipoprestamo:='Saldo Contable';
    r.intdevvigente:=fsaldo1+fsaldo2;
    r.intdevvencido:=fsaldo3;
    return next r;

return;
end;
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.srptintdevxtipo(date) OWNER TO sistema;

--
-- Name: sscoring(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sscoring(integer) RETURNS SETOF tscoring
    AS $_$
declare

  psolicitudprestamoid alias for $1;

  i int4;
  r tscoring%rowtype;

  fmontosolicitado numeric;
  fmontoindividual numeric;
  j int4;

  stelefono char(20);

begin

  select count(*) into j
    from scoring
   where solicitudprestamoid = psolicitudprestamoid;

  j:=coalesce(j,0);

raise notice 'j==% %',j,psolicitudprestamoid;

  if j>0 then

    select montosolicitado
      into fmontosolicitado
      from solicitudprestamo
     where solicitudprestamoid = psolicitudprestamoid;


    fmontoindividual:= fmontosolicitado/j;
    i:=1;

    for r in
     select 0 as no,
            su.nombre||' '||su.paterno||' '||su.materno as nombre,
            0 as montosolicitado,
            (case when s.genero=0 then 7 else 10 end) as genero,
            (case when su.edad>17 and su.edad<25 then 6
                  else (case when su.edad>24 and su.edad<56 then 10
                             else 7 end) end) as edad,
            s.estadocivil,
            s.tipovivienda as tipocasa,
            s.tiempoendomicilio,
            0 as telefono,
            s.tiempoentrabajo as tiempoennegocio,
            s.ingresomensual,
            s.dependienteseconomicos,
            s.calificacionburo,
            0 as totalscoring,
            s.avalid          
       from scoring s, avales a, sujeto su
      where s.solicitudprestamoid = psolicitudprestamoid and
            a.avalid = s.avalid and
            su.sujetoid = a.sujetoid
    loop


raise notice 'Llega bien aqui';

      r.no:=i;
      r.montosolicitado:=fmontoindividual;

      if r.estadocivil=0 then
        r.estadocivil:=6;
      end if;
      if r.estadocivil=1 then
        r.estadocivil:=10;
      end if;
      if r.estadocivil=2 then
        r.estadocivil:=9;
      end if;
      if r.estadocivil=3 then
        r.estadocivil:=7;
      end if;
      if r.estadocivil=4 then
        r.estadocivil:=8;
      end if;


      if r.tipocasa=0 then
        r.tipocasa:=10;
      end if;
      if r.tipocasa=1 then
        r.tipocasa:=7;
      end if;
      if r.tipocasa=2 then
        r.tipocasa:=5;
      end if;

      if r.tiempoendomicilio=0 then
        r.tiempoendomicilio:=5;
      end if;

      if r.tiempoendomicilio=1 then
        r.tiempoendomicilio:=8;
      end if;

      if r.tiempoendomicilio=2 then
        r.tiempoendomicilio:=9;
      end if;

      if r.tiempoendomicilio=3 then
        r.tiempoendomicilio:=10;
      end if;

      -- Telefono
      select d.teldomicilio
        into stelefono
       from avales a, domicilio d
      where a.avalid=r.avalid and
            d.sujetoid=a.sujetoid;

      stelefono:=trim(stelefono);

      if length(stelefono)>6 then
        r.telefono:=10;
      else
        r.telefono:=0;
      end if;

      if r.tiempoennegocio=0 then
        r.tiempoennegocio:=5;
      end if;

      if r.tiempoennegocio=1 then
        r.tiempoennegocio:=8;
      end if;

      if r.tiempoennegocio=2 then
        r.tiempoennegocio:=9;
      end if;

      if r.tiempoennegocio=3 then
        r.tiempoennegocio:=10;
      end if;


      if r.ingresomensual<3000 then
        r.ingresomensual:=0;
      end if;

      if r.ingresomensual>2000 and r.ingresomensual<5000 then
        r.ingresomensual:=7;
      end if;

      if r.ingresomensual>4999 and r.ingresomensual<7000 then
        r.ingresomensual:=8;
      end if;


      if r.ingresomensual>6999then
        r.ingresomensual:=10;
      end if;


      if r.dependienteseconomicos=0 then
        r.dependienteseconomicos:=5;
      end if;

      if r.dependienteseconomicos=1 then
        r.dependienteseconomicos:=7;
      end if;

      if r.dependienteseconomicos=2 then
        r.dependienteseconomicos:=8;
      end if;

      if r.dependienteseconomicos=3 then
        r.dependienteseconomicos:=10;
      end if;

      if r.dependienteseconomicos>3 then
        r.dependienteseconomicos:=6;
      end if;


      if r.calificacionburo=0 then
        r.calificacionburo:=10;
      end if;

      if r.calificacionburo=1 then
        r.calificacionburo:=8;
      end if;

      if r.calificacionburo=2 then
        r.calificacionburo:=6;
      end if;

      if r.calificacionburo=3 then
        r.calificacionburo:=0;
      end if;

      r.totalscoring:=r.genero+r.edad+r.estadocivil+r.tipocasa+r.tiempoendomicilio+r.telefono+r.tiempoennegocio+r.ingresomensual+r.dependienteseconomicos+r.calificacionburo;



      return next r;

      i:=i+1;
    end loop;

  end if;


return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sscoring(integer) OWNER TO sistema;

--
-- Name: stipoinversion(numeric, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION stipoinversion(numeric, character) RETURNS character
    AS $_$
declare
  pmonto alias for $1;
  ptipoinversionid alias for $2;

  stipoinversionid char(3);

begin

  stipoinversionid = ptipoinversionid;

  if substr(stipoinversionid,1,1)='A' and pmonto>=10001 and pmonto<50001 then
    stipoinversionid := 'B'||substr(stipoinversionid,2,2);
  end if;
  if substr(stipoinversionid,1,1)='B' and pmonto>=50001 and pmonto<96239.70 then
    stipoinversionid := 'C'||substr(stipoinversionid,2,2);
  end if;
  if substr(stipoinversionid,1,1)='C' and pmonto>=96239.71 and pmonto<250001 then
    stipoinversionid := 'D'||substr(stipoinversionid,2,2);
  end if;
  if substr(stipoinversionid,1,1)='D' and pmonto>=250001 and pmonto<500001 then
    stipoinversionid := 'E'||substr(stipoinversionid,2,2);
  end if;
  if substr(stipoinversionid,1,1)='E' and pmonto>=500001 then
    stipoinversionid := 'F'||substr(stipoinversionid,2,2);
  end if;

  if substr(stipoinversionid,1,1)='G' and pmonto>=96239.71 then
    stipoinversionid := 'H'||substr(stipoinversionid,2,2);
  end if;

  if substr(stipoinversionid,1,1)='I' and pmonto>=96239.71 then
    stipoinversionid := 'J'||substr(stipoinversionid,2,2);
  end if;


  stipoinversionid := replace(stipoinversionid,' ','');

return stipoinversionid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.stipoinversion(numeric, character) OWNER TO sistema;

--
-- Name: subcuentas(character, numeric, numeric, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION subcuentas(character, numeric, numeric, numeric) RETURNS SETOF sucursal1.catalogo_ctas
    AS $_$
 DECLARE
 r catalogo_ctas%ROWTYPE;
 id ALIAS FOR $1;
 saldoinicial ALIAS FOR $2;
 totalcargos ALIAS FOR $3;
 totalabonos ALIAS FOR $4;

BEGIN
 
 FOR r IN SELECT *
            FROM catalogo_ctas
           WHERE cuentaid = id 
 LOOP

   r.saldo_inic_ejer  := r.saldo_inic_ejer  + saldoinicial;
   r.cargos_acum_ejer := r.cargos_acum_ejer + totalcargos;
   r.abonos_acum_ejer := r.abonos_acum_ejer + totalabonos;

   RETURN NEXT r;

   FOR r IN SELECT *
              FROM subcuentas(r.cat_cuentaid,
                              r.saldo_inic_ejer,
                              r.cargos_acum_ejer,
                              r.abonos_acum_ejer)
   LOOP
      RETURN NEXT r;
   END LOOP;

 END LOOP;

RETURN;
END
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.subcuentas(character, numeric, numeric, numeric) OWNER TO sistema;

--
-- Name: sujetosrepetidos(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sujetosrepetidos() RETURNS SETOF integer
    AS $$
declare
  r record;
  m record;

begin


    for r in
select paterno,materno,nombre from sujeto 
group by paterno,materno,nombre having count(*)>1

    loop
      for m in
        select sujetoid from sujeto
         where paterno=r.paterno and materno=r.materno and nombre=r.nombre
      loop
        return next m.sujetoid;
      end loop;
    end loop;


return;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sujetosrepetidos() OWNER TO sistema;

--
-- Name: sumaactivoprestamo(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sumaactivoprestamo(character) RETURNS numeric
    AS $_$
declare
  preferenciaprestamo alias for $1;
 
  r record;
  ptotaldebe numeric;
  ptotaldebe2 numeric;
  pcuentaactivo char(24);


begin

  for r in 
  select prestamoid,referenciaprestamo,tipoprestamoid from prestamos where referenciaprestamo=preferenciaprestamo

  loop
 
      select cuentaactivo into pcuentaactivo from tipoprestamo where tipoprestamoid=r.tipoprestamoid;

      select sum(debe) into ptotaldebe from movipolizas where cuentaid=pcuentaactivo and polizaid in (select mc.polizaid from movicaja mc, polizas po where mc.polizaid=po.polizaid and mc.prestamoid=r.prestamoid);
      ptotaldebe:= coalesce(ptotaldebe,0);


      select sum(debe) into ptotaldebe2 from movipolizas where cuentaid=pcuentaactivo and polizaid in (select mc.polizaid from movibanco mc, polizas po where mc.polizaid=po.polizaid and mc.prestamoid=r.prestamoid );
      ptotaldebe2:= coalesce(ptotaldebe2,0);

     
  end loop;
   

return ptotaldebe+ptotaldebe2;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sumaactivoprestamo(character) OWNER TO sistema;

--
-- Name: sumadepositos(character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sumadepositos(character, date, integer) RETURNS numeric
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pfecha alias for $2;
  psocioid alias for $3;
 
  periodo integer;
  ejercicio integer;

  fdeposito numeric;
 
begin


  ejercicio:=cast(date_part('year',pfecha) as int);
  periodo:=cast(date_part('month',pfecha) as int);

  select sum(mp.debe) into fdeposito
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=psocioid and mc.efectivo=1 and
             ( mc.tipomovimientoid in ((select tipomovimientoid from tipomovimiento where tipomovimientoid<>'CI' and tipomovimientoid<>'IP' and ptipomovimientoid<>'AH' and  tipomovimientoid<>'RE' and aplicasaldo='S') union (select (case when exists (select socioid from datosfiscales where socioid =psocioid) then '**' else '00' end) ))) and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.ejercicio=ejercicio and p.periodo=periodo ;

  fdeposito:=coalesce(fdeposito,0);

return fdeposito;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sumadepositos(character, date, integer) OWNER TO sistema;

--
-- Name: sumadepositosold(character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sumadepositosold(character, date, integer) RETURNS numeric
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pfecha alias for $2;
  psocioid alias for $3;
 
  periodo integer;
  ejercicio integer;

  fdeposito numeric;
 
begin


  ejercicio:=cast(date_part('year',pfecha) as int);

  periodo:=cast(date_part('month',pfecha) as int);

     select sum(mp.debe) into fdeposito
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=psocioid and mc.efectivo=1 and
             ( mc.tipomovimientoid in (select tipomovimientoid from tipomovimiento where tipomovimientoid<>'CI' and tipomovimientoid<>'IP'  and tipomovimientoid<>'RE' and aplicasaldo='S')) and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.ejercicio=ejercicio and p.periodo=periodo ;

    fdeposito:=coalesce(fdeposito,0);

   
return fdeposito;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sumadepositosold(character, date, integer) OWNER TO sistema;

--
-- Name: sumadepositosreporte(character, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sumadepositosreporte(character, date, integer) RETURNS numeric
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pfecha alias for $2;
  psocioid alias for $3;
 
  periodo integer;
  ejercicio integer;

  fdeposito numeric;
 
begin


  ejercicio:=cast(date_part('year',pfecha) as int);
  periodo:=cast(date_part('month',pfecha) as int);

  select sum(mp.debe) into fdeposito
        from movicaja mc, movipolizas mp, polizas p
       where mc.socioid=psocioid and mc.efectivo=1 and
             ( mc.tipomovimientoid in ((select tipomovimientoid from tipomovimiento where tipomovimientoid<>'CI' and tipomovimientoid<>'IP' and ptipomovimientoid<>'AH' and  tipomovimientoid<>'RE' and tipomovimientoid<>'RE' and tipomovimientoid<>'ID' and aplicasaldo='S') union (select (case when exists (select socioid from datosfiscales where socioid =psocioid) then '**' else '00' end) ))) and
             p.polizaid = mc.polizaid and
             mp.movipolizaid=mc.movipolizaid and
             p.ejercicio=ejercicio and p.periodo=periodo ;

  fdeposito:=coalesce(fdeposito,0);

return fdeposito;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sumadepositosreporte(character, date, integer) OWNER TO sistema;

--
-- Name: sumafecha(date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION sumafecha(date, integer) RETURNS date
    AS $_$
declare
   pfecha alias for $1;
   pdias alias for $2;

begin

   return pfecha+pdias;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.sumafecha(date, integer) OWNER TO sistema;

--
-- Name: tasareciprocidad(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION tasareciprocidad(integer) RETURNS numeric
    AS $_$
declare
  lprestamoid alias for $1;
  r reciprocidad%rowtype;
  dfecha_otorga date;
  fmontoprestamo numeric;
  fsaldoprestamo numeric;
  ftasanormal numeric;
  itantos integer;

  ftasa1 numeric;
  ftasa2 numeric;
  ftasa3 numeric;
  ftasa4 numeric;
  ftasa5 numeric;
  ftasa6 numeric;
  
  freciprocidad numeric;

  ftasa numeric;

  saplicareciprocidad char(1);

  stipoprestamoid char(3);

begin

  select aplicareciprocidad
    into saplicareciprocidad
    from empresa
   where empresaid=1;

if saplicareciprocidad='S' then
  ftasa := 0;

  select p.fecha_otorga,p.montoprestamo,p.saldoprestamo,p.tasanormal,t.tantos,
         p.tipoprestamoid
    into dfecha_otorga,fmontoprestamo,fsaldoprestamo,ftasanormal,itantos,
         stipoprestamoid
    from prestamos p, tipoprestamo t
   where p.prestamoid = lprestamoid and
         t.tipoprestamoid = p.tipoprestamoid;

   if NOT FOUND then
     raise exception 'No encontre tipo de prestamo';
   end if;

  select tasa1,tasa2,tasa3,tasa4,tasa5,tasa6
    into ftasa1,ftasa2,ftasa3,ftasa4,ftasa5,ftasa6
    from reciprocidad
   where dfecha_otorga between fechainicial and fechafinal;

   if NOT FOUND then
      raise exception 'No encontre tasa de reciprocidad';
   end if;

   itantos:=coalesce(itantos,1);
   if itantos>0 then
     freciprocidad := fmontoprestamo/itantos;
   else
     freciprocidad := fmontoprestamo;
   end if;

   --Tasa de default
   ftasa:=ftasa6;
   if freciprocidad>=fsaldoprestamo then
     -- No cobrar moratorios en reciprocidad 1
     ftasa:=ftasa1;     
   end if;
   if freciprocidad*2>=fsaldoprestamo and freciprocidad<fsaldoprestamo then
     ftasa:=ftasa2;
   end if;
   if freciprocidad*3>=fsaldoprestamo and freciprocidad*2<fsaldoprestamo then
     ftasa:=ftasa3;
   end if;
   if freciprocidad*4>=fsaldoprestamo and freciprocidad*3<fsaldoprestamo then
     ftasa:=ftasa4;
   end if;
   if freciprocidad*5>=fsaldoprestamo and freciprocidad*4<fsaldoprestamo then
     ftasa:=ftasa5;
   end if;
   if freciprocidad*6>=fsaldoprestamo and freciprocidad*5<fsaldoprestamo then
     ftasa:=ftasa6;
   end if;
   if ftasa>ftasanormal then
     ftasa:=ftasanormal;
   end if;
   if ftasa=0 then
     ftasa:=ftasanormal;
   end if;

   if stipoprestamoid='CE1' then
     ftasa:=ftasanormal;
   end if;

else

  select tasanormal into ftasa from prestamos where prestamoid=lprestamoid;

end if;

return round(ftasa,2);
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.tasareciprocidad(integer) OWNER TO sistema;

--
-- Name: tasareciprocidad(numeric, numeric, date, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION tasareciprocidad(numeric, numeric, date, integer) RETURNS numeric
    AS $_$
declare

  fmontoprestamo alias for $1;
  fsaldoprestamo alias for $2;
  dfecha_otorga  alias for $3;
  itantos        alias for $4;

  ftasa1 numeric;
  ftasa2 numeric;
  ftasa3 numeric;
  ftasa4 numeric;
  ftasa5 numeric;
  ftasa6 numeric;
  
  freciprocidad numeric;

  ftasa numeric;


begin

  ftasa := 0;

  select tasa1,tasa2,tasa3,tasa4,tasa5,tasa6
    into ftasa1,ftasa2,ftasa3,ftasa4,ftasa5,ftasa6
    from reciprocidad
   where dfecha_otorga>=fechainicial and dfecha_otorga<=fechafinal;

   if itantos>0 then
     freciprocidad := fmontoprestamo/itantos;
   else
     freciprocidad := fmontoprestamo;
   end if;

   --Tasa de default
   ftasa:=ftasa6;
   if freciprocidad>=fsaldoprestamo then
     -- No cobrar moratorios en reciprocidad 1
     ftasa:=ftasa1;     
   end if;
   if freciprocidad*2>=fsaldoprestamo and freciprocidad<fsaldoprestamo then
     ftasa:=ftasa2;
   end if;
   if freciprocidad*3>=fsaldoprestamo and freciprocidad*2<fsaldoprestamo then
     ftasa:=ftasa3;
   end if;
   if freciprocidad*4>=fsaldoprestamo and freciprocidad*3<fsaldoprestamo then
     ftasa:=ftasa4;
   end if;
   if freciprocidad*5>=fsaldoprestamo and freciprocidad*4<fsaldoprestamo then
     ftasa:=ftasa5;
   end if;
   if freciprocidad*6>=fsaldoprestamo and freciprocidad*5<fsaldoprestamo then
     ftasa:=ftasa6;
   end if;


return round(ftasa,2);
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.tasareciprocidad(numeric, numeric, date, integer) OWNER TO sistema;

--
-- Name: textoaviso(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION textoaviso(integer) RETURNS text
    AS $_$
declare

  pavisoid alias for $1;
  pformato text;
  ptexto text;

  pprocedimiento text; 

  pnombre varchar;
  pdomicilio varchar;  
  pprestamoid int4;
  psocioid int4;
  pclavesocioint char(15);
  pciudadmex varchar(50);
  pestadomex varchar(50);
  dsiguientefechapago date;
  
  pmes int;
  psmes varchar;
  pdia char(2);
  pano char(4);  
  pmes1 int;
  psmesp varchar;
  psmes1 varchar;
  pdia1 char(2);
  pano1 char(4);    
  dfecha_otorga date;  
  pdiascobro int;
  psdiascobro varchar;
  pocupacion varchar(40);
  pfechac date;
  dfechaenvio date;
  spnombre varchar(80);

  
  pcapital numeric;
  pmontoprestamo numeric;
  pnumero_de_amor numeric;
  fsaldoahorro numeric;
  fsaldoctacor numeric;
  fsaldoinver  numeric;
  fsaldoparte numeric;
  r datoaval%rowtype;
  x record;
  snosocioaval text;
  snombreaval text;
  stelefonoaval text;
  snosocioaval2 text;
  snombreaval2 text;
  stelefonoaval2 text;  
  i integer;
  rr record;
  

  sclavesocioint char(15);
  sucursal char(5);
  domiciliocaja char(100);

  
begin

  snosocioaval:= '';
  snombreaval:= '';
  stelefonoaval:= '';
  snosocioaval2:= '';
  snombreaval2:= '';
  stelefonoaval2:= '';  

  select sucid,direccioncaja 
        into sucursal,domiciliocaja 
  from empresa;

  i:=0;
  for x in
   select a.socioid,
          s.nombre,s.paterno,s.materno,
          d.calle,d.numero_ext,d.colonia,d.comunidad,s.sujetoid,
	  c.nombreciudadmex,e.nombreestadomex,d.teldomicilio
    from aviso av, avales a,sujeto s,domicilio d,ciudadesmex c, estadosmex e
   where av.avisoid = pavisoid and
         a.prestamoid = av.prestamoid and
         s.sujetoid = a.sujetoid and
         d.sujetoid = a.sujetoid and
	 d.ciudadmexid = c.ciudadmexid and 
	 c.estadomexid = e.estadomexid
   order by a.noaval
  loop
     if i < 2 then
        -- Verificar si es socio
        if x.socioid IS NOT NULL then
          select clavesocioint
            into sclavesocioint
            from socio
           where socioid=x.socioid;
           snosocioaval:=snosocioaval||(rpad(sclavesocioint,35,' '));
        else
          -- Cuando el aval es socio
          snosocioaval:=snosocioaval||(rpad('NS-'||to_char(x.sujetoid,'000000'),35,' '));
        end if;
        snombreaval:=snombreaval||substr(rpad(trim(x.nombre)||' '||trim(x.paterno)||' '||trim(x.materno),45,' '),1,30);
        stelefonoaval:=stelefonoaval||rpad(x.teldomicilio,30,' ');
        i:=i+1;

      else
        -- Verificar si es socio
        if x.socioid IS NOT NULL then
          select clavesocioint
            into sclavesocioint
            from socio
           where socioid=x.socioid;
           snosocioaval2:=snosocioaval2||(rpad(sclavesocioint,35,' '));
        else
          -- Cuando el aval es socio
          snosocioaval2:=snosocioaval2||(rpad('NS-'||to_char(x.sujetoid,'000000'),35,' '));
        end if;
        snombreaval2:=snombreaval2||substr(rpad(trim(x.nombre)||' '||trim(x.paterno)||' '||trim(x.materno),45,' '),1,30);
        stelefonoaval2:=stelefonoaval2||rpad(x.teldomicilio,30,' ');
        i:=i+1;
      end if;      
    exit when i > 4;
  end loop;


  pfechac:=CURRENT_DATE;
  select a.prestamoid, t.nombre||' '||t.paterno||' '||t.materno,s.clavesocioint,
         rtrim(d.calle)||' '||rtrim(d.numero_ext)||' '||rtrim(d.colonia),
	 rtrim(c.nombreciudadmex), rtrim(e.nombreestadomex), p.montoprestamo, p.numero_de_amor, p.socioid
         into pprestamoid, pnombre, pclavesocioint, pdomicilio, pciudadmex, pestadomex, pmontoprestamo, pnumero_de_amor, psocioid
    from aviso a, prestamos p, socio s, sujeto t, domicilio d, ciudadesmex c,
         solicitudingreso so, estadosmex e
   where a.avisoid = pavisoid and
         p.prestamoid = a.prestamoid and
         s.socioid = p.socioid and
         t.sujetoid = s.sujetoid and
	 t.sujetoid = d.sujetoid and
	 s.socioid = so.socioid and
	 so.ciudadmexid = c.ciudadmexid and
	 c.estadomexid = e.estadomexid;

   select capital from spscalculopago(pprestamoid) into pcapital;

   select fechadepago into dsiguientefechapago 
     from amortizaciones 
    where prestamoid=pprestamoid and fechadepago >= CURRENT_DATE and 
          fechadepago <= CURRENT_DATE+29;
	  
    dsiguientefechapago:=coalesce(dsiguientefechapago,CURRENT_DATE);

 select sum(mp.debe)-sum(mp.haber) into fsaldoahorro
        from movicaja mc, movipolizas mp
        where mc.socioid=psocioid and
          mc.tipomovimientoid='AA' and
          mp.movipolizaid=mc.movipolizaid;
         fsaldoahorro:=coalesce(fsaldoahorro,0);

 select sum(mp.debe)-sum(mp.haber) into fsaldoctacor
        from movicaja mc, movipolizas mp
        where mc.socioid=psocioid and
          mc.tipomovimientoid='CU' and
          mp.movipolizaid=mc.movipolizaid;
         fsaldoctacor:=coalesce(fsaldoctacor,0);

 select sum(mp.debe)-sum(mp.haber) into fsaldoinver
        from movicaja mc, movipolizas mp
        where mc.socioid=psocioid and
          mc.tipomovimientoid='IN' and
          mp.movipolizaid=mc.movipolizaid;
         fsaldoinver:=coalesce(fsaldoinver,0);

 select sum(mp.debe)-sum(mp.haber) into fsaldoparte
        from movicaja mc, movipolizas mp
        where mc.socioid=psocioid and
          mc.tipomovimientoid='PA' and
          mp.movipolizaid=mc.movipolizaid;
         fsaldoparte:=coalesce(fsaldoparte,0);


--  raise notice ' siguiente pago % ',dsiguientefechapago;

  select fecha_otorga into dfecha_otorga
    from prestamos
   where prestamoid=pprestamoid;
   
  select fechaenvio into dfechaenvio
    from aviso
   where avisoid=pavisoid;   

  pmes:=cast(date_part('month',dfecha_otorga) as int);
  pdia:=cast(date_part('day',dfecha_otorga) as char(2));
  pano:=cast(date_part('year',dfecha_otorga) as char(4));

  if pmes=1 then
    psmes := 'ENERO     ';
  end if;
  if pmes=2 then
    psmes := 'FEBRERO   ';
  end if;
  if pmes=3 then
    psmes := 'MARZO     ';
  end if;
  if pmes=4 then
    psmes := 'ABRIL     ';
  end if;
  if pmes=5 then
    psmes := 'MAYO      ';
  end if;
  if pmes=6 then
    psmes := 'JUNIO     ';
  end if;
  if pmes=7 then
    psmes := 'JULIO     ';
  end if;
  if pmes=8 then
    psmes := 'AGOSTO    ';
  end if;
  if pmes=9 then
    psmes := 'SEPTIEMBRE';
  end if;
  if pmes=10 then
    psmes := 'OCTUBRE   ';
  end if;
  if pmes=11 then
    psmes := 'NOVIEMBRE ';
  end if;
  if pmes=12 then
    psmes := 'DICIEMBRE ';
  end if;

  psmes := rtrim(psmes);

  pmes1:=cast(date_part('month',dfechaenvio) as int);
  pdia1:=cast(date_part('day',dfechaenvio) as char(2));
  pano1:=cast(date_part('year',dfechaenvio) as char(4));

  if pmes1=1 then
    psmes1 := 'ENERO     ';
    psmesp := '      ';
  end if;
  if pmes1=2 then
    psmes1 := 'FEBRERO   ';
    psmesp := '    ';    
  end if;
  if pmes1=3 then
    psmes1 := 'MARZO     ';
    psmesp := '      ';    
  end if;
  if pmes1=4 then
    psmes1 := 'ABRIL     ';
    psmesp := '      ';    
  end if;
  if pmes1=5 then
    psmes1 := 'MAYO      ';
    psmesp := '       ';    
  end if;
  if pmes1=6 then
    psmes1 := 'JUNIO     ';
    psmesp := '      ';    
  end if;
  if pmes1=7 then
    psmes1 := 'JULIO     ';
    psmesp := '      ';    
  end if;
  if pmes1=8 then
    psmes1 := 'AGOSTO    ';
    psmesp := '     ';    
  end if;
  if pmes1=9 then
    psmes1 := 'SEPTIEMBRE';
    psmesp := ' ';    
  end if;
  if pmes1=10 then
    psmes1 := 'OCTUBRE   ';
    psmesp := '    ';    
  end if;
  if pmes1=11 then
    psmes1 := 'NOVIEMBRE ';
    psmesp := '  ';    
  end if;
  if pmes1=12 then
    psmes1 := 'DICIEMBRE ';
    psmesp := '  ';    
  end if;

  psmes1 := rtrim(psmes1);



  pformato := chr(18)||chr(13)||chr(10)||
--              chr(13)||chr(10)||
--              chr(13)||chr(10)||
--              chr(13)||chr(10)||
              chr(13)||chr(10);


-- Determinar el tipo de Aviso
  select t.procedimientoaimprimir
    into pprocedimiento
    from tipoaviso t, aviso a
   where a.avisoid = pavisoid and
         t.tipoavisoid = a.tipoavisoid;


   SELECT p.dias_de_cobro into pdiascobro
     FROM aviso a, prestamos p
    WHERE a.avisoid = pavisoid and
          p.prestamoid = a.prestamoid;
	  
   SELECT s.ocupacion into pocupacion
     FROM aviso a, prestamos p, solicitudingreso s
    WHERE a.avisoid = pavisoid and
          p.prestamoid = a.prestamoid and
          p.socioid = s.socioid;


  if pdiascobro=7 then
    psdiascobro := 'SEMANALES  ';
  end if;
  if pdiascobro=15 then
    psdiascobro := 'QUINCENALES'; 
  end if;
  if pdiascobro=30 then
    psdiascobro := 'MENSUALES  ';
  end if;


   spnombre:='';

 select rtrim(su.nombre)||' '||rtrim(su.paterno)||' '||rtrim(su.materno)
   into spnombre
   from aviso a, prestamos p, socio s, sujeto su 
  where a.avisoid = pavisoid and
        a.prestamoid = p.prestamoid and
        p.socioid = s.socioid and
        su.sujetoid = s.sujetoid;

-- Aviso 1
if rtrim(pprocedimiento)='1' then


SELECT
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||lpad('COOPERATIVA YOLOMECATL, S.C. DE R.L. DE C.V.',72,' ')||
chr(13)||chr(10)||lpad('DEPARTAMENTO DE COBRANZA',52,' ')||
chr(13)||chr(10)||lpad('SUCURSAL '||sucursal,41,' ')||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
lpad('ASUNTO: Recordatorio',72,' ')||chr(13)||chr(10)||chr(13)||chr(10)||
lpad('Oaxaca de Jurez, Oax., a '||pdia1||' de '||psmes1||' de '||pano1,72,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'   C. '||su.nombre||' '||su.paterno||' '||su.materno||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Estimado Socio:'||chr(13)||chr(10)||
chr(13)||chr(10)||
'     Es un placer saludarlo y ponernos a sus rdenes para asesorarlo en un'||chr(13)||chr(10)||
'   mejor  manejo de su  crdito, y as mismo  aprovecho  la  ocasin  para'||chr(13)||chr(10)||
'   recordarle  que su abono  est  por  vencer,  para  que  por  favor  lo'||chr(13)||chr(10)||
'   realice  antes de la  fecha  de vencimiento  y continue  siendo nuestro'||chr(13)||chr(10)||
'   mejor socio.'||chr(13)||chr(10)||
' '||chr(13)||chr(10)||
' '||chr(13)||chr(10)||
chr(13)||chr(10)||
'     De antemano la Cooperativa, agradece su puntual y oportuno pago'||chr(13)||chr(10)||

chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                       LA SOLUCIN A TUS NECESIDADES'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                           A T E N T A M E N T E'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--'                                          ___________________________________'||chr(13)||chr(10)||
'                             RESP. DEPARTAMENTO'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)
INTO ptexto
FROM aviso a, prestamos p, tipoprestamo tp, socio s, sujeto su, domicilio d, ciudadesmex c, estadosmex e, solicitudingreso si, colonia co,
     spscalculopago(pprestamoid) as ca
WHERE a.avisoid = pavisoid and
      p.prestamoid = a.prestamoid and
      tp.tipoprestamoid = p.tipoprestamoid and
      s.socioid = p.socioid and
      su.sujetoid = s.sujetoid and
      su.sujetoid = si.sujetoid and
      d.sujetoid = s.sujetoid and
      d.coloniaid=co.coloniaid and
      c.ciudadmexid = d.ciudadmexid and
      e.estadomexid = c.estadomexid;

  pformato := pformato||ptexto;




end if;


-- Aviso 2

if rtrim(pprocedimiento)='2' then

SELECT 

chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
chr(13)||chr(10)||lpad('COOPERATIVA YOLOMECATL, S.C. DE R.L. DE C.V.',72,' ')||
chr(13)||chr(10)||lpad('DEPARTAMENTO DE COBRANZA',52,' ')||
chr(13)||chr(10)||lpad('SUCURSAL '||sucursal,41,' ')||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
lpad('Oaxaca de Jurez, Oax., a '||pdia1||' de '||psmes1||' de '||pano1,72,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
'   SOCIO NO:      '||s.clavesocioint||chr(13)||chr(10)|| 
'   NOMBRE:        '||su.nombre||' '||su.paterno||' '||su.materno||chr(13)||chr(10)||
'   DIRECCION:     '||rpad(rtrim(coalesce(d.calle,''))||' '||rtrim(d.numero_ext)||', Int.'||rtrim(d.numero_int),40,' ')||' Tel: '||d.teldomicilio||chr(13)||chr(10)||
--'ENTRE          '||chr(13)||chr(10)||
'   COLONIA:       '||coalesce(rtrim(co.nombrecolonia),'')||', '||rtrim(d.comunidad)||chr(13)||chr(10)||
'   CODIGO POSTAL: '||rtrim(d.codpostal)||chr(13)||chr(10)||
'   CIUDAD:        '||rtrim(c.nombreciudadmex)||', '||e.nombreestadomex||
chr(13)||chr(10)||
chr(13)||chr(10)||
lpad(tp.desctipoprestamo,20,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--chr(13)||chr(10)||
'   No. de Prstamo:        '||lpad(p.referenciaprestamo,8,' ')||lpad('Saldo del prstamo:  ',27,' ')||to_char(p.saldoprestamo,'$99,999,999.99')||chr(13)||chr(10)||
'   No. de abonos vencidos:  '||a.amortizacionesvencidas||
lpad('Importe vencido      ',33,' ')||to_char(ca.capital,'$99,999,999.99')||chr(13)||chr(10)||
lpad('Interes ordinario    ',62,' ')||to_char(ca.interes,'$99,999,999.99')||chr(13)||chr(10)||
lpad('Interes Moratorio    ',62,' ')||to_char(ca.moratorio,'$99,999,999.99')||chr(13)||chr(10)||
'   Estimado Socio:'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Por medio de la presente le hacemos de su conocimiento que el crdito que'||chr(13)||chr(10)||
'   usted tiene en  Cooperativa Yolomecatl, S.C. de R.L. de C.V. presenta  un'||chr(13)||chr(10)||
'   abono vencido, por lo que con la finalidad de seguir  manteniendo un buen'||chr(13)||chr(10)||
'   historial de crdito que sin duda lo beneficiar en  crditos futuros, lo'||chr(13)||chr(10)||
'   invitamos a cubrir su pago en un plazo no  mayor a tres das a  partir de'||chr(13)||chr(10)||
'   la recepcin del presente.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Confiando  en su  buena solvencia moral y persona cumplida que es  usted,'||chr(13)||chr(10)||
'   lo esperamos en nuestra sucursal en das y horas hbiles para recibir  su'||chr(13)||chr(10)||
'   pago.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Si  usted  ya  esta  al  corriente  le  pedimos  una disculpa; omita este'||chr(13)||chr(10)||
'   citatorio y comunquese inmediatamente con nosotros.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Sin  otro  particular  de antemano  le agradecemos su buen cumplimiento y'||chr(13)||chr(10)||
'   seguir atendindole como usted se merece.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Esperando  que en  esta ocasin  obtengamos una respuesta favorable de su'||chr(13)||chr(10)||
'   parte, quedamos a  Usted.'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                      LA SOLUCIN A TUS NECESIDADES'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                          A T E N T A M E N T E'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--'                                          ___________________________________'||chr(13)||chr(10)||
'DEPTO. DE COBRANZA                             NOMBRE Y FIRMA DE QUIEN RECIBE'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)

INTO ptexto
FROM aviso a, prestamos p, tipoprestamo tp, socio s, sujeto su, domicilio d, ciudadesmex c, estadosmex e, solicitudingreso si, colonia co,
     spscalculopago(pprestamoid) as ca
WHERE a.avisoid = pavisoid and
      p.prestamoid = a.prestamoid and
      tp.tipoprestamoid = p.tipoprestamoid and
      s.socioid = p.socioid and
      su.sujetoid = s.sujetoid and
      su.sujetoid = si.sujetoid and
      d.sujetoid = s.sujetoid and
      c.ciudadmexid = d.ciudadmexid and
      d.coloniaid = co.coloniaid and
      e.estadomexid = c.estadomexid;

  pformato := pformato||ptexto;




end if;

-- Aviso 3

if rtrim(pprocedimiento)='3' then

SELECT

--chr(13)||chr(10)||
--chr(13)||chr(10)||
chr(13)||chr(10)||lpad('COOPERATIVA YOLOMECATL, S.C. DE R.L. DE C.V.',72,' ')||
chr(13)||chr(10)||lpad('DEPARTAMENTO DE COBRANZA',52,' ')||
chr(13)||chr(10)||lpad('SUCURSAL '||sucursal,41,' ')||
chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
lpad('Oaxaca de Jurez, Oax., a '||pdia1||' de '||psmes1||' de '||pano1,72,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
'   SOCIO NO:      '||s.clavesocioint||chr(13)||chr(10)|| 
'   NOMBRE:        '||su.nombre||' '||su.paterno||' '||su.materno||chr(13)||chr(10)||
'   DOMICILIO:     '||rpad(rtrim(coalesce(d.calle,''))||' '||rtrim(d.numero_ext)||', Int.'||rtrim(d.numero_int),40,' ')||' Tel: '||d.teldomicilio||chr(13)||chr(10)||
--'ENTRE          '||chr(13)||chr(10)||
'   COLONIA        '||coalesce(rtrim(co.nombrecolonia),'')||', '||rtrim(d.comunidad)||chr(13)||chr(10)||
'   CODIGO POSTAL: '||rtrim(d.codpostal)||chr(13)||chr(10)||
'   CIUDAD:        '||rtrim(c.nombreciudadmex)||', '||e.nombreestadomex||
chr(13)||chr(10)||
chr(13)||chr(10)||
lpad(tp.desctipoprestamo,21,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
'   No. de Prstamo:        '||p.referenciaprestamo||lpad('Saldo del prstamo:  ',28,' ')||to_char(p.saldoprestamo,'$99,999,999.99')||chr(13)||chr(10)||
'   No. de abonos vencidos:  '||a.amortizacionesvencidas||
lpad('Importe vencido      ',33,' ')||to_char(ca.capital,'$99,999,999.99')||chr(13)||chr(10)||
lpad('Interes ordinario    ',62,' ')||to_char(ca.interes,'$99,999,999.99')||chr(13)||chr(10)||
lpad('Interes Moratorio    ',62,' ')||to_char(ca.moratorio,'$99,999,999.99')||chr(13)||chr(10)||

'   Estimado Socio:'||chr(13)||chr(10)||
chr(13)||chr(10)||

'   En das pasados recibi de Cooperativa Yolomecatl, S.C. de R.L. de C.V. un'||chr(13)||chr(10)||
'   aviso  donde se le  informa que  presenta dos  abonos vencidos, del cual a'||chr(13)||chr(10)||
'   la  fecha  no  hemos recibido  el pago  o su presencia el la sucursal para'||chr(13)||chr(10)||
'   realizar un convenio, de nueva cuenat le pedimos acuda a realizar  el pago'||chr(13)||chr(10)||
'   en un  lapso no  mayor a  3 das a  partir  de hoy,  en caso  de no acudir'||chr(13)||chr(10)||
'   estaremos  informando a sus avales de  su falta  de voluntad para resolver'||chr(13)||chr(10)||
'   su problema, recuerde  que el  crdito siempre  se necesita, no  se cierre'||chr(13)||chr(10)||
'   las puertas usted solo.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Para  mayor comodidad  el pago lo puede realizar en cualquiera de nuestras'||chr(13)||chr(10)||
'   oficinas sucursales  y cumplir  con el  compromiso firmado  en el  plan de'||chr(13)||chr(10)||
'   pagos y el pagar.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Cabe mencionar que en caso de incumplimiento el prximo requerimiento ser'||chr(13)||chr(10)||
'   con copia a los avales.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Sin  otro  particular  la  Cooperativa  y los SOCIOS  que  apoyaron con su'||chr(13)||chr(10)||
'   ahorro para a entregarle a usted su crdito, le agradecemos lo devuelva en'||chr(13)||chr(10)||
'   las condiciones pactadas y a la brevedad posible.'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                      LA SOLUCIN A TUS NECESIDADES'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||




'                          A T E N T A M E N T E'||chr(13)||chr(10)||

chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--'                                          ___________________________________'||chr(13)||chr(10)||
'DEPTO. DE COBRANZA                              NOMBRE Y FIRMA DE QUIEN RECIBE'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)

INTO ptexto
FROM aviso a, prestamos p, tipoprestamo tp, socio s, sujeto su, domicilio d, ciudadesmex c, estadosmex e, solicitudingreso si,colonia co,
     spscalculopago(pprestamoid) as ca
WHERE a.avisoid = pavisoid and
      p.prestamoid = a.prestamoid and
      tp.tipoprestamoid = p.tipoprestamoid and
      s.socioid = p.socioid and
      su.sujetoid = s.sujetoid and
      su.sujetoid = si.sujetoid and 
      d.sujetoid = s.sujetoid and
      c.ciudadmexid = d.ciudadmexid and
      d.coloniaid = co.coloniaid and
      e.estadomexid = c.estadomexid;

  pformato := pformato||ptexto;


end if;

-- Aviso 4
if rtrim(pprocedimiento)='4' then

SELECT
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||lpad('COOPERATIVA YOLOMECATL, S.C. DE R.L. DE C.V.',72,' ')||
chr(13)||chr(10)||lpad('DEPARTAMENTO DE COBRANZA',52,' ')||
chr(13)||chr(10)||lpad('SUCURSAL '||sucursal,41,' ')||
chr(13)||chr(10)||
chr(13)||chr(10)||
lpad('Oaxaca de Jurez, Oax., a '||pdia1||' de '||psmes1||' de '||pano1,72,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
'   SOCIO NO:     '||s.clavesocioint||chr(13)||chr(10)|| 
'   NOMBRE:       '||su.nombre||' '||su.paterno||' '||su.materno||chr(13)||chr(10)||
'   DOMICILIO:    '||rpad(rtrim(coalesce(d.calle,''))||' '||rtrim(d.numero_ext)||', Int.'||rtrim(d.numero_int),40,' ')||' Tel: '||d.teldomicilio||chr(13)||chr(10)||
--'   ENTRE         '||chr(13)||chr(10)||
'   COLONIA       '||coalesce(rtrim(co.nombrecolonia),'')||', '||rtrim(d.comunidad)||chr(13)||chr(10)||
'   CODIGO POSTAL '||rtrim(d.codpostal)||chr(13)||chr(10)||
'   CIUDAD:       '||rtrim(c.nombreciudadmex)||', '||e.nombreestadomex||
chr(13)||chr(10)||
chr(13)||chr(10)||
lpad(tp.desctipoprestamo,19,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'   No. de Prstamo:        '||substr(p.referenciaprestamo,1,8)||lpad('Saldo del prstamo:  ',27,' ')||to_char(p.saldoprestamo,'$99,999,999.99')||chr(13)||chr(10)||
'   No. de abonos vencidos: '||a.amortizacionesvencidas||
lpad('Importe vencido      ',34,' ')||to_char(ca.capital,'$99,999,999.99')||chr(13)||chr(10)||
lpad('Interes ordinario    ',62,' ')||to_char(ca.interes,'$99,999,999.99')||chr(13)||chr(10)||
lpad('Interes Moratorio    ',62,' ')||to_char(ca.moratorio,'$99,999,999.99')||chr(13)||chr(10)||

'   Estimado Socio:'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Este es el TERCER  aviso que le enviamos y ha hecho caso omiso a nuestros'||chr(13)||chr(10)||
'   requerimientos,  con  el fin  de  dar  solucin  a su problema se cita en'||chr(13)||chr(10)||
'   nuestras oficinas sucursales en las prximas 72 a la recepcin del mismo,'||chr(13)||chr(10)||
'   en  caso  de  no  acudir  se  tomar  como  una negativa de su parte y se'||chr(13)||chr(10)||
'   realizar el cobro de su adeudo a sus avales.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Cuando  usted  solicito este prstamo, informo al departamento de crdito'||chr(13)||chr(10)||
'   que contaba con la suficiente solvencia moral y ecnomica  para cubrir al'||chr(13)||chr(10)||
'   pie  de la  letra los abonos, permtanos ayudarle  a resolver su problema'||chr(13)||chr(10)||
'   y evitar  una mala atencin de nuestra parte.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Sin  otro  particular,  lo esperamos en la sucursal y seguir atendindole'||chr(13)||chr(10)||
'   como se merece.'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'   Nota: El presente citatorio se enva con copia a los avales.'||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                     LA SOLUCIN A TUS NECESIDADES'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||

'                         A T E N T A M E N T E'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--'                                          ______________________________________'||chr(13)||chr(10)||
'DEPTO. DE COBRANZA                             NOMBRE Y FIRMA DE QUIEN RECIBE'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)

INTO ptexto
FROM aviso a, prestamos p, tipoprestamo tp, socio s, sujeto su, domicilio d, ciudadesmex c, estadosmex e, solicitudingreso si, colonia co,
     spscalculopago(pprestamoid) as ca
WHERE a.avisoid = pavisoid and
      p.prestamoid = a.prestamoid and
      tp.tipoprestamoid = p.tipoprestamoid and
      s.socioid = p.socioid and
      su.sujetoid = s.sujetoid and
      su.sujetoid = si.sujetoid and
      d.sujetoid = s.sujetoid and
      d.coloniaid=co.coloniaid and
      c.ciudadmexid = d.ciudadmexid and
      e.estadomexid = c.estadomexid;

  pformato := pformato||ptexto;

-- AVALES
-- CITATORIO URGENTE
for r in
  select su.nombre||' '||su.paterno||' '||su.materno as nombre,
       d.calle||' '||rtrim(d.numero_ext)||' '||rtrim(co.nombrecolonia)||' '||rtrim(d.comunidad) as domicilio,
       substr(c.nombreciudadmex,1,20) as ciudad, substr(e.nombreestadomex,1,20) as estado,
       ca.interes as interes,
       ca.moratorio as moratorio,
       ca.capital as capital,
       --ca.iva as  iva,
       ca.diasint as diasinteres,
       p.montoprestamo as montopres,
       p.fecha_otorga as fechaotor,
       p.referenciaprestamo as referencia,
       p.tipoprestamoid as tipoprestamo,
       p.saldoprestamo,
       p.fechaultimopago,
       a.amortizacionesvencidas
  from aviso a, prestamos p, avales av, sujeto su, domicilio d, ciudadesmex c, estadosmex e,
       spscalculopago(pprestamoid) as ca, colonia co
  where a.avisoid = pavisoid and
        p.prestamoid = a.prestamoid and
        av.prestamoid = p.prestamoid and
        su.sujetoid = av.sujetoid and
        d.sujetoid = av.sujetoid and
        co.coloniaid = d.coloniaid and
        c.ciudadmexid = d.ciudadmexid and
        e.estadomexid = c.estadomexid

loop

  ptexto :=

chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||lpad('COOPERATIVA YOLOMECATL, S.C. DE R.L. DE C.V.',72,' ')||
chr(13)||chr(10)||lpad('DEPARTAMENTO DE COBRANZA',52,' ')||
chr(13)||chr(10)||lpad('SUCURSAL '||sucursal,41,' ')||
chr(13)||chr(10)||
chr(13)||chr(10)||
lpad('ASUNTO:  CITATORIO URGENTE',72,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
lpad('Oaxaca de Jurez, Oax., a '||pdia1||' de '||psmes1||' de '||pano1,72,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'   C.                    '||r.nombre||chr(13)||chr(10)||
'   AVAL DE SOCIO NO:     '||pclavesocioint||chr(13)||chr(10)||
'   P R E S E N T E'||chr(13)||chr(10)||

chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'   Por este medio me permito citar  a Usted con el carcter de urgente, para'||chr(13)||chr(10)||
'   que   se   presente   en   nuestras   oficinas    ubicadas    en    Calle'||chr(13)||chr(10)||
'   '||substr(domiciliocaja,1,20)||'  el da ___  de ______   de 200__  a las ____ horas,'||chr(13)||chr(10)||
'   para  tratar  lo relacionado con el crdito que le otorgo la Cooperativa,'||chr(13)||chr(10)||
'   a su avalado el  C: '||substring(pnombre,1,80)||'  lo anterior con virtud  de  que'||chr(13)||chr(10)||
'   se  encuentra  en la  clasificacin de clientes  Morosos.  En caso  de no'||chr(13)||chr(10)||
'   acudir se enviar el Expediente al Departamento Legal  de la empresa para'||chr(13)||chr(10)||
'   que  proceda  de inmediato a la cobranza LEGAL para con ustedes, debido a'||chr(13)||chr(10)||
'   la actitud negativa que ha mostrado su avalado ante los requerimientos de'||chr(13)||chr(10)||
'   pago realizados con anterioridad.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   En  caso  de  no  presentarse  en  el  termino  sealado, se entender su'||chr(13)||chr(10)||
'   negativa para llegar a una conciliacin que resuelva  este  problema, por'||chr(13)||chr(10)||
'   lo que la institucin proceder por la  va Judicial con fundamento en lo'||chr(13)||chr(10)||
'   establecido por los artculos 150 fraccin II y 152  fracciones I y II de'||chr(13)||chr(10)||
'   la Ley General de Ttulos y Operaciones de Crdito. '||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                      LA SOLUCIN A TUS NECESIDADES'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||

'                         A T E N T A M E N T E'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--'                                          ______________________________________'||chr(13)||chr(10)||
'                        GERENTE DE LA SUCURSAL'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10);

  pformato := pformato||ptexto;

end loop;
end if;

-- SIN TITULO
if rtrim(pprocedimiento)='5' then

SELECT
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||lpad('COOPERATIVA YOLOMECATL, S.C. DE R.L. DE C.V.',72,' ')||
chr(13)||chr(10)||lpad('DEPARTAMENTO DE COBRANZA',52,' ')||
chr(13)||chr(10)||lpad('SUCURSAL '||sucursal,41,' ')||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
lpad('SOCIO: '||su.nombre||' '||su.paterno||' '||su.materno,40,' ')||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
--chr(13)||chr(10)||
'   Estimado  Socio me dirijo a usted con el fin de saludarlo en  mi carcter'||chr(13)||chr(10)||
'   de  Gerente  General De la  Cooperativa YOLOMECATL, S.C. DE R.L. DE C.V.,'||chr(13)||chr(10)||
'   para  hacerle  de su  conocimiento  el Nacimiento de nuestro DEPARTAMENTO'||chr(13)||chr(10)||
'   LEGAL  DE  CRDITO Y COBRANZA, para que por medio de l, esta Cooperativa'||chr(13)||chr(10)||
'   realice con mayor efectividad las funciones para la que fue creada.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Este  Departamento  nace  con  la  finalidad  de  darle a usted una mejor'||chr(13)||chr(10)||
'   atencin con el objeto de que lleguen a l todas las quejas o sugerencias'||chr(13)||chr(10)||
'   relacionadas con nuestros Auxiliares y Ejecutivos de Crdito y Cobranza y'||chr(13)||chr(10)||
'   encargados  y  Gerentes  de Sucursal, ya que a la fecha encontramos en su'||chr(13)||chr(10)||
'   cuenta  morosidad,  creyendo  que  esto  se  deba  nicamente  a una mala'||chr(13)||chr(10)||
'   atencin  por parte  de nuestro personal. Para la cual de ser as le pido'||chr(13)||chr(10)||
'   que se comunique con la Lic. ROSA ICELA ROJAS MORENO, quien es la persona'||chr(13)||chr(10)||
'   que  tendr  a  su  cargo  este  Departamento,  quien  atender  de forma'||chr(13)||chr(10)||
'   inmediata cualquier queja.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   De  no tener ninguna queja con nuestro personal, le ruego nos ayude de la'||chr(13)||chr(10)||
'   manera ms  atenta a  ponerse al  corriente en  sus pagos, como lo estaba'||chr(13)||chr(10)||
'   haciendo  con  anterioridad,  procurando  que  su cuenta  no entre en ms'||chr(13)||chr(10)||
'   morosidad.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Ya  que de  lo contrario  si no se cubre esa morosidad su cuenta pasar a'||chr(13)||chr(10)||
'   nuestro  Departamento Legal, en forma inmediata, a manos de cualquiera de'||chr(13)||chr(10)||
'   nuestros Licenciados en Cobranza, para que junto con usted le  encuentren'||chr(13)||chr(10)||
'   una solucin a su situacin Econmica.'||chr(13)||chr(10)||
chr(13)||chr(10)||
'   Sin mas por el momento y  en espera de su comprensin y  ayuda para poder'||chr(13)||chr(10)||
'   brindarle  el  mejor  de  nuestro  servicios, me despido de usted como su'||chr(13)||chr(10)||
'   atento y seguro Servidor. '||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
'                         LA SOLUCIN A TUS NECESIDADES'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||

'                              A T E N T A M E N T E'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
--'                                          ______________________________________'||chr(13)||chr(10)||
'                              GERENTE DE LA SUCURSAL'||chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||
chr(13)||chr(10)||

chr(13)||chr(10)

INTO ptexto
FROM aviso a, prestamos p, socio s, sujeto su, domicilio d, ciudadesmex c, estadosmex e, solicitudingreso si, colonia co,
     spscalculopago(pprestamoid) as ca
WHERE a.avisoid = pavisoid and
      p.prestamoid = a.prestamoid and
      s.socioid = p.socioid and
      su.sujetoid = s.sujetoid and
      su.sujetoid = si.sujetoid and
      d.sujetoid = s.sujetoid and
      d.coloniaid=co.coloniaid and
      c.ciudadmexid = d.ciudadmexid and
      e.estadomexid = c.estadomexid;

  pformato := pformato||ptexto;


end if;




return pformato;

end;
$_$
    LANGUAGE plpgsql;


ALTER FUNCTION public.textoaviso(integer) OWNER TO sistema;

--
-- Name: tipocasa(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION tipocasa(integer) RETURNS text
    AS $_$
declare
ptipocasa alias for $1;

ptexto text;

begin
  
  if ptipocasa=0 then
    ptexto := 'RENTADA     ';
  end if;
  if ptipocasa=1 then
    ptexto := 'PROPIA   ';
  end if;
    if ptipocasa=2 then
    ptexto := 'FAMILIAR     ';
  end if;
  if ptipocasa=3 then
    ptexto := 'COMPARTIDA ';
  end if;
  if ptipocasa=4 then
    ptexto := 'OTRA     ';
  end if;

  return ptexto;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.tipocasa(integer) OWNER TO sistema;

--
-- Name: totalabonos(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION totalabonos(integer) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;

  scuentaactivo char(24);
  lsocioid int4;
  ltotalabonos numeric;
begin
  
  select p.socioid,tp.cuentaactivo
    into lsocioid,scuentaactivo
    from prestamos p, tipoprestamo tp
   where p.prestamoid = pprestamoid and
         tp.tipoprestamoid = p.tipoprestamoid;


  select sum(mp.haber)
    into ltotalabonos
    from movicaja mc, movipolizas mp
   where mc.socioid = lsocioid and
         mc.prestamoid = pprestamoid and
         mc.tipomovimientoid = '00' and
         mp.polizaid = mc.polizaid and
         mp.cuentaid = scuentaactivo;

   ltotalabonos := coalesce(ltotalabonos,0);

return ltotalabonos;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.totalabonos(integer) OWNER TO sistema;

--
-- Name: traspasa_cobradores(character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasa_cobradores(character, character, character) RETURNS integer
    AS $_$
declare
  
  phost alias for $1;
  pdb alias for $2;
  psucursal alias for $3;

  r record;
  psujetoid integer;
begin
 raise notice 'Inicio Traspaso de cobradores'; 

 for r in
      select * from
 dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema  password=1sc4pslu2',
        'set search_path to public,'||''''||psucursal||''''||';
                   select cobradorid,paterno,materno,nombre,razonsocial from cobradores NATURAL JOIN sujeto;')
            as t(cobradorid integer,  paterno character varying(20), materno character varying(20), nombre  character varying(40), razonsocial   character varying(60))

  loop
          raise notice 'Insertando sujeto ';
          insert into sujeto (paterno,materno,nombre,razonsocial) values(r.paterno,r.materno,r.nombre,r.razonsocial);
		
	  raise notice 'Insertando cobradorid % ',r.cobradorid;
	  select max(sujetoid) into psujetoid from sujeto;
          insert into cobradores (cobradorid,sujetoid) values(r.cobradorid,psujetoid);
  end loop;

  raise notice 'Termine Cobradores';


return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasa_cobradores(character, character, character) OWNER TO sistema;

--
-- Name: traspasabancos(character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasabancos(character, character, character) RETURNS integer
    AS $_$
declare
  
  phost alias for $1;
  pdb alias for $2;
  psucursal alias for $3;

  r record;

begin

 raise notice 'Inicio Traspaso de bancos'; 

 for r in
      select * from
 dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema  password=1sc4pslu2',
        'set search_path to public,'||''''||psucursal||''''||';
          select no_cuenta,cuentaid,banco,fecha_inicio,saldo_inicial,saldo_actual,saldo_pen,seriebanco,nocheque from bancos order by no_cuenta;')
            as t(
    no_cuenta character(15) ,
    cuentaid character(24) ,
    banco character(25) ,
    fecha_inicio date ,
    saldo_inicial numeric ,
    saldo_actual numeric ,
    saldo_pen numeric ,
    seriebanco character(2),
    nocheque integer)

  loop

      if r.no_cuenta not in (select no_cuenta from bancos where no_cuenta=r.no_cuenta)
       then
          raise notice 'cuenta % es ',r.no_cuenta;
          insert into bancos(no_cuenta,cuentaid,banco,fecha_inicio,saldo_inicial,saldo_actual,saldo_pen,seriebanco,nocheque)
          values(r.no_cuenta,r.cuentaid,r.banco,r.fecha_inicio,r.saldo_inicial,r.saldo_actual,r.saldo_pen,r.seriebanco,r.nocheque);
    
     end if;
  end loop;

  raise notice 'Termine Bancos';

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasabancos(character, character, character) OWNER TO sistema;

--
-- Name: traspasacatalogo_ctas(character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasacatalogo_ctas(character, character, character) RETURNS integer
    AS $_$
declare
  
  phost alias for $1;
  pdb alias for $2;
  psucursal alias for $3;

  r record;
--  phost char(30);
--  pdb char(30);
--  psucursal char(30);
  pretirosocio integer;

begin

-- phost :='valle001.vallesistemas.com';
-- pdb   := 'valle001';
-- psucursal := 'sucursal1';
 raise notice 'Inicio Traspaso de cuentas'; 

 for r in
      select * from
 dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema  password=1sc4pslu2',
        'set search_path to public,'||''''||psucursal||''''||';
                   select cuentaid, cat_cuentaid, identificacion, cuentanombre,
 tipo_cta, estado_cta, fecha_estado, fecha_ult_mov, naturaleza, digito_agrupador, saldo_inic_ejer, cargos_acum_ejer, abonos_acum_ejer from catalogo_ctas;')
            as t(cuentaid character(24), cat_cuentaid character(24), identificacion character(1), cuentanombre character(100), tipo_cta character(1), estado_cta character(1), fecha_estado date, fecha_ult_mov date, naturaleza character(1), digito_agrupador numeric, saldo_inic_ejer numeric, cargos_acum_ejer  numeric, abonos_acum_ejer  numeric)

  loop

      if r.cuentaid not in (select cuentaid from catalogo_ctas where cuentaid=r.cuentaid)
       then
          raise notice 'cuentaid % es nueva',r.cuentaid;
          insert into catalogo_ctas (cuentaid,cat_cuentaid,identificacion,cuentanombre,tipo_cta,estado_cta,fecha_estado,fecha_ult_mov,naturaleza,digito_agrupador,saldo_inic_ejer)
          values(r.cuentaid,r.cat_cuentaid,r.identificacion,r.cuentanombre,r.tipo_cta,r.estado_cta,r.fecha_estado,r.fecha_ult_mov,r.naturaleza,r.digito_agrupador,r.saldo_inic_ejer);

     else

       raise notice 'actualizando cuentaid % ',r.cuentaid;
       update  catalogo_ctas set cat_cuentaid=r.cat_cuentaid, identificacion=r.identificacion, cuentanombre=r.cuentanombre, tipo_cta=r.tipo_cta, estado_cta=r.estado_cta, fecha_estado=r.fecha_estado, fecha_ult_mov=r.fecha_ult_mov, naturaleza=r.naturaleza, digito_agrupador=r.digito_agrupador, saldo_inic_ejer=r.saldo_inic_ejer where cuentaid=r.cuentaid;

     end if;
  end loop;

  raise notice 'Termine Cuentas';


return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasacatalogo_ctas(character, character, character) OWNER TO sistema;

--
-- Name: traspasaclaveconapo(character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasaclaveconapo(character, character, character) RETURNS integer
    AS $_$
declare
  
  phost alias for $1;
  pdb alias for $2;
  psucursal alias for $3;

  r record;

  pretirosocio integer;

begin

 raise notice 'Inicio Traspaso de colonias'; 

 for r in
      select * from
 dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema  password=1sc4pslu2',
        'set search_path to public,'||''''||psucursal||''''||';
                   select coloniaid,claveconapo from colonia where claveconapo is not null;')
            as t(coloniaid integer, claveconapo character(10))

  loop

     update colonia set claveconapo = r.claveconapo where coloniaid=r.coloniaid;
   
  end loop;

  raise notice 'Termine Colonias';

 raise notice 'Inicio Traspaso de ciudades'; 

 for r in
      select * from
 dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema  password=1sc4pslu2',
        'set search_path to public,'||''''||psucursal||''''||';
                   select ciudadmexid,claveconapo from ciudadesmex where claveconapo is not null ;')
            as t(ciudadmexid integer, claveconapo character(10))

  loop

     update ciudadesmex set claveconapo = r.claveconapo where ciudadmexid=r.ciudadmexid;
   
  end loop;

  raise notice 'Termine Ciudades';



return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasaclaveconapo(character, character, character) OWNER TO sistema;

--
-- Name: traspasareciprocidad(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasareciprocidad() RETURNS integer
    AS $$
declare

 iperiodo1 int4;
 iano1 int4;
 iseq int4;
 iseq2 int4;
 lmovipolizaid int4;
 scuenta char(24);
 dfecha date;
 dpoliza date;
 lmv int4;
begin

  --
  -- fecha hasta donde se toman los prestamos
  --
  dfecha:='31-10-2005';

  --
  -- fecha de la poliza, mal hecho por que queda con fecha
  -- posterior a la del ultimo prestamo
  --
  dpoliza:='01-10-2005';

  raise notice 'Comenzando traspaso';

  iperiodo1 := cast(date_part('month',dfecha) as int);
  iano1 := cast(date_part('year',dfecha) as int);

  select setval('seqnopoliza',max(numero_poliza))
    into iseq
    from polizas where tipo_poliza='D';
  select currval('seqnopoliza')
    into iseq;
  select setval('seqreferencia',1)
    into iseq2;


  -- Realizar las polizas por cada socio

  insert into polizas( numero_poliza,seriepoliza,tipo,referencia,ejercicio,periodo,
                       fechapoliza,tipo_poliza,clase_poliza,diario_agrupador,
                       concepto_poliza,fecha_fin_aceptacion )
  select nextval('seqnopoliza') as numero_poliza,
         'ZA' as seriepoliza,
         'J' as tipo,
         nextval('seqreferencia') as referencia,
         iano1 as ejercicio,
         iperiodo1 as periodo,
         dfecha as fechapoliza,
         'D' as tipo_poliza,
         ' ' as clase_poliza,
         ' ' as diario_agrupador,
         a.referenciaprestamo as concepto_poliza,
         dfecha as fecha_fin_aceptacion
    from (

select p.socioid,p.prestamoid,p.referenciaprestamo, 
       p.saldoprestamo,
       tp.tantos, p.montoprestamo, ROUND(p.montoprestamo/tp.tantos,2) as reciprocidad,
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha) as saldorg,
       (case when ROUND(p.montoprestamo/tp.tantos,2)<=saldodemov(p.socioid,tp.tipomovimientoid,dfecha)
             then ROUND(p.montoprestamo/tp.tantos,2)
             else saldodemov(p.socioid,tp.tipomovimientoid,dfecha) end) as cantidad,
       tp.tipomovimientoid, tm.cuentadeposito,tm.cuentaretiro
    from prestamos p, tipoprestamo tp, tipomovimiento tm
   where p.claveestadocredito<>'008' and p.tipoprestamoid<>'E1 ' and
         p.fecha_otorga<=dfecha and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tantos>0 and
         tm.tipomovimientoid=tp.tipomovimientoid
having p.saldoprestamo>0 and
       saldodemov(p.socioid,tp.tipomovimientoid,current_date)>=saldodemov(p.socioid,tp.tipomovimientoid,dfecha) and
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha)>0       
order by p.socioid 

) as a;



  select nextval('movipolizas_movipolizaid_seq')
    into lmovipolizaid;

  select CURRVAL('movipolizas_movipolizaid_seq')
    into lmovipolizaid;


  insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)

 select r.polizaid,b.cuentaretiro,' ','C',b.cantidad,0,' ',' ',
        b.referenciaprestamo
   from polizas r, (

select p.socioid,p.prestamoid,p.referenciaprestamo, 
       p.saldoprestamo,
       tp.tantos, p.montoprestamo, ROUND(p.montoprestamo/tp.tantos,2) as reciprocidad,
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha) as saldorg,
       (case when ROUND(p.montoprestamo/tp.tantos,2)<=saldodemov(p.socioid,tp.tipomovimientoid,dfecha)
             then ROUND(p.montoprestamo/tp.tantos,2)
             else saldodemov(p.socioid,tp.tipomovimientoid,dfecha) end) as cantidad,
       tp.tipomovimientoid, tm.cuentadeposito,tm.cuentaretiro
    from prestamos p, tipoprestamo tp, tipomovimiento tm
   where p.claveestadocredito<>'008' and p.tipoprestamoid<>'E1 ' and
         p.fecha_otorga<=dfecha and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tantos>0 and
         tm.tipomovimientoid=tp.tipomovimientoid
having p.saldoprestamo>0 and
       saldodemov(p.socioid,tp.tipomovimientoid,current_date)>=saldodemov(p.socioid,tp.tipomovimientoid,dfecha) and
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha)>0       
order by p.socioid 

) as b
where r.fechapoliza=dfecha and r.tipo='J' and
      substr(r.concepto_poliza,1,18)=b.referenciaprestamo
order by r.polizaid;


  select cuentadeposito
    into scuenta
    from tipomovimiento
   where tipomovimientoid='RG';

  select currval('movipolizas_movipolizaid_seq')
    into lmv;

  insert into movipolizas(polizaid,cuentaid,referencia_mov,tipo_mov,debe,haber,diario_mov,identific_descr,descripcion)

 select r.polizaid,scuenta,' ','A',0,b.cantidad,' ',' ',
        b.referenciaprestamo
   from polizas r, (

select p.socioid,p.prestamoid,p.referenciaprestamo, 
       p.saldoprestamo,
       tp.tantos, p.montoprestamo, ROUND(p.montoprestamo/tp.tantos,2) as reciprocidad,
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha) as saldorg,
       (case when ROUND(p.montoprestamo/tp.tantos,2)<=saldodemov(p.socioid,tp.tipomovimientoid,dfecha)
             then ROUND(p.montoprestamo/tp.tantos,2)
             else saldodemov(p.socioid,tp.tipomovimientoid,dfecha) end) as cantidad,
       tp.tipomovimientoid, tm.cuentadeposito,tm.cuentaretiro
    from prestamos p, tipoprestamo tp, tipomovimiento tm
   where p.claveestadocredito<>'008' and p.tipoprestamoid<>'E1 ' and
         p.fecha_otorga<=dfecha and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tantos>0 and
         tm.tipomovimientoid=tp.tipomovimientoid
having p.saldoprestamo>0 and
       saldodemov(p.socioid,tp.tipomovimientoid,current_date)>=saldodemov(p.socioid,tp.tipomovimientoid,dfecha) and
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha)>0       
order by p.socioid 

) as b
where r.fechapoliza=dfecha and r.tipo='J' and
      substr(r.concepto_poliza,1,18)=b.referenciaprestamo
order by r.polizaid;


  select setval('seqnopoliza',lmovipolizaid)
    into iseq2;
  select setval('seqreferencia',1)
    into iseq2;


insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,estatusmovicaja,prestamoid)

 select b.socioid,'RG',r.polizaid,1,'ZA',nextval('seqnopoliza'),'A',b.prestamoid
   from polizas r, (

select p.socioid,p.prestamoid,p.referenciaprestamo, 
       p.saldoprestamo,
       tp.tantos, p.montoprestamo, ROUND(p.montoprestamo/tp.tantos,2) as reciprocidad,
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha) as saldorg,
       (case when ROUND(p.montoprestamo/tp.tantos,2)<=saldodemov(p.socioid,tp.tipomovimientoid,dfecha)
             then ROUND(p.montoprestamo/tp.tantos,2)
             else saldodemov(p.socioid,tp.tipomovimientoid,dfecha) end) as cantidad,
       tp.tipomovimientoid, tm.cuentadeposito,tm.cuentaretiro
    from prestamos p, tipoprestamo tp, tipomovimiento tm
   where p.claveestadocredito<>'008' and p.tipoprestamoid<>'E1 ' and
         p.fecha_otorga<=dfecha and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tantos>0 and
         tm.tipomovimientoid=tp.tipomovimientoid
having p.saldoprestamo>0 and p.tipoprestamoid<>'E1 ' and
       p.fecha_otorga<=dfecha and
       saldodemov(p.socioid,tp.tipomovimientoid,current_date)>=saldodemov(p.socioid,tp.tipomovimientoid,dfecha) and
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha)>0       
order by p.socioid 

) as b
where r.fechapoliza=dfecha and r.tipo='J' and
      substr(r.concepto_poliza,1,18)=b.referenciaprestamo
order by r.polizaid;





  select setval('seqnopoliza',lmv)
    into iseq2;
  select setval('seqreferencia',1)
    into iseq2;

insert into movicaja(socioid,tipomovimientoid,polizaid,referenciacaja,seriecaja,movipolizaid,estatusmovicaja,prestamoid)

 select b.socioid,b.tipomovimientoid,r.polizaid,1,'ZA',nextval('seqnopoliza'),'A',b.prestamoid
   from polizas r, (

select p.socioid,p.prestamoid,p.referenciaprestamo, 
       p.saldoprestamo,
       tp.tantos, p.montoprestamo, ROUND(p.montoprestamo/tp.tantos,2) as reciprocidad,
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha) as saldorg,
       (case when ROUND(p.montoprestamo/tp.tantos,2)<=saldodemov(p.socioid,tp.tipomovimientoid,dfecha)
             then ROUND(p.montoprestamo/tp.tantos,2)
             else saldodemov(p.socioid,tp.tipomovimientoid,dfecha) end) as cantidad,
       tp.tipomovimientoid, tm.cuentadeposito,tm.cuentaretiro
    from prestamos p, tipoprestamo tp, tipomovimiento tm
   where p.claveestadocredito<>'008' and p.tipoprestamoid<>'E1 ' and
         p.fecha_otorga<=dfecha and
         tp.tipoprestamoid = p.tipoprestamoid and
         tp.tantos>0 and
         tm.tipomovimientoid=tp.tipomovimientoid
having p.saldoprestamo>0 and p.tipoprestamoid<>'E1 ' and
       p.fecha_otorga<=dfecha and
       saldodemov(p.socioid,tp.tipomovimientoid,current_date)>=saldodemov(p.socioid,tp.tipomovimientoid,dfecha) and
       saldodemov(p.socioid,tp.tipomovimientoid,dfecha)>0       
order by p.socioid 

) as b
where r.fechapoliza=dfecha and r.tipo='J' and
      substr(r.concepto_poliza,1,18)=b.referenciaprestamo
order by r.polizaid;



return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasareciprocidad() OWNER TO sistema;

--
-- Name: traspasasocioutil(character, character varying, character varying, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasasocioutil(character, character varying, character varying, character varying) RETURNS integer
    AS $_$
declare
  pclavesocioint alias for $1;
  phost alias for $2;
  pdb alias for $3;
  psucursal alias for $4;

  lsocioid char(20);
  lsocioid1 int4;
  lsujetoid int4;
  ldomicilioid int4;
  lnosolicitud integer;

  spaterno varchar(20);
  smaterno varchar(20);
  snombre varchar(40);
  srfc char(16);
  sresujetoid int4;
  sresujetoid1 int4;
  lrelacionid int4;
  lresujetoid int4;

  setdomicilio int4;
  setsujeto int4;
  setsocio int4;
  setrelacion int4;
  setsolingreso int4;
  
  sclavesocioint char(15);
  stiposocioid char(2);
  lsolicitudingresoid int4;
  fsocioid int4;

begin

  select socioid into lsocioid from socio where socioid=pclavesocioint;
  lsocioid := COALESCE ( lsocioid,' ' );

  if lsocioid = ' ' then

  select paterno,materno,nombre,rfc,sujetoid into spaterno,smaterno,snombre,srfc,sresujetoid1 from
     dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
        'set search_path to public,'||''''||psucursal||''''||';
                   select paterno,materno,nombre,rfc,su.sujetoid
                     from sujeto su, socio s 
                    where s.clavesocioint='||''''||pclavesocioint||''''||' and
                          su.sujetoid=s.sujetoid;')
            as t(paterno varchar(20), materno varchar(20), nombre varchar(40),rfc char(16), sujetoid int4);

  raise notice ' Nombre: % % %',spaterno,smaterno,snombre;

  select su.sujetoid,d.domicilioid into lsujetoid,ldomicilioid from sujeto su, domicilio d where paterno=spaterno and materno=smaterno and nombre=snombre and rfc=srfc and su.sujetoid=d.sujetoid;

  lsujetoid := COALESCE ( lsujetoid, 0 );

  if lsujetoid= 0 then

           -- Migrando Sujeto
            raise notice 'Migrando sujeto';

           insert into sujeto (paterno,materno,nombre,rfc,curp,edad,fecha_nacimiento,razonsocial)
           SELECT paterno,materno,nombre,rfc,curp,edad,fecha_nacimiento,razonsocial
           FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
                 'set search_path to public,'||''''||psucursal||''''||';
                   select su.paterno,su.materno,su.nombre,su.rfc,su.curp,su.edad,
                          su.fecha_nacimiento,su.razonsocial
                     from sujeto su, socio s
                    where s.clavesocioint='||''''||pclavesocioint||''''||' and
                          su.sujetoid=s.sujetoid;')
            as t(paterno varchar(20),materno varchar(20),nombre varchar(40),
                 rfc char(16),curp char(20),edad numeric,fecha_nacimiento date,
                 razonsocial varchar(60));

            lsujetoid:=currval('sujeto_sujetoid_seq');
            raise notice 'SujetoID= %',lsujetoid;

            -- Migrando Domicilio
            raise notice 'Migrando Domicilio';

            insert into domicilio (ciudadmexid,sujetoid,calle,numero_ext,numero_int,colonia,
                         codpostal,comunidad,teldomicilio)
            SELECT existeciudad(ciudadmexid),lsujetoid,calle,numer_ext,numero_int,colonia,codpostal,
            comunidad,teldomicilio
            FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
                 'set search_path to public,'||''''||psucursal||''''||';
                   select d.ciudadmexid,d.sujetoid,d.calle,d.numero_ext,d.numero_int,
                          d.colonia,d.codpostal,d.comunidad,d.teldomicilio
                     from socio s,domicilio d
                    where s.clavesocioint='||''''||pclavesocioint||''''||' and
                          d.sujetoid=s.sujetoid;')
            as t(ciudadmexid int4,sujetoid int4,calle varchar(30),numer_ext varchar(15),
                 numero_int varchar(15),colonia varchar(30),codpostal int4,
                 comunidad varchar(50),teldomicilio varchar(20));   

            ldomicilioid:=currval('domicilio_domicilioid_seq');
            raise notice 'DomicilioID= %',ldomicilioid;
			
			
			-- Migrando Solicitudingreso
			raise notice 'Migrando Solicitudingreso';
			select max(coalesce(nosolicitud,0)+1)
			into lnosolicitud
			from solicitudingreso;
			lnosolicitud:=coalesce(lnosolicitud,1);
   
			raise notice 'Insertando solicitud --> %',lnosolicitud;
   
			insert into solicitudingreso(nosolicitud,fechasolicitud,fechaingreso,sujetoid,ciudadmexid,sexo,nivelestudiosid,profesion,ocupacion,tipocasaid,estadocivilid,regimenmatrimonial,tiempovivirendomicilio,motivoingresoid,medioseenteroid,perteneceaotracaja,usuarioid,lastusuarioid,lastupdate,tiposocioid,doccompleta,personajuridicaid,grupo)
			SELECT lnosolicitud, fechasolicitud,fechaingreso,lsujetoid,ciudadmexid,sexo,nivelestudiosid,profesion,ocupacion,tipocasaid,estadocivilid,regimenmatrimonial,tiempovivirendomicilio,motivoingresoid,medioseenteroid,perteneceaotracaja,usuarioid,lastusuarioid,lastupdate,tiposocioid,doccompleta,personajuridicaid,grupo
			FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
                 'set search_path to public,'||''''||psucursal||''''||';
                   select nosolicitud, si.fechasolicitud,si.fechaingreso,si.sujetoid,si.ciudadmexid,si.sexo,si.nivelestudiosid,si.profesion,si.ocupacion,si.tipocasaid,si.estadocivilid,si.regimenmatrimonial,si.tiempovivirendomicilio,si.motivoingresoid,si.medioseenteroid,si.perteneceaotracaja,si.usuarioid,si.lastusuarioid,si.lastupdate,si.tiposocioid,si.doccompleta,si.personajuridicaid,si.grupo
                   from  socio s, solicitudingreso si
                   where clavesocioint='||''''||pclavesocioint||''''||' and
				   s.sujetoid=si.sujetoid;')
            as t( nosolicitud integer,
			fechasolicitud           date                  ,
			fechaingreso            date                  ,
			sujetoid                integer               ,
			ciudadmexid             integer               ,
			sexo                    integer               ,
			nivelestudiosid         integer               ,
			profesion               character varying(40) ,
			ocupacion               character varying(40) ,
			tipocasaid              integer               ,
			estadocivilid           integer               ,
			regimenmatrimonial      integer               ,
			tiempovivirendomicilio  character varying(15) ,
			motivoingresoid         integer               ,
			medioseenteroid         integer               ,
			perteneceaotracaja      integer               ,
			usuarioid               character(20)         ,
			lastusuarioid           character(20)         ,
			lastupdate              date                  ,
			tiposocioid             character(2)          ,
			doccompleta             integer               ,
			personajuridicaid       integer               ,
			grupo                   character(25)         
		);

			raise notice 'socioid = %',pclavesocioint;

		-- Generando Socio
		--select generasocio(lnosolicitud,'');

		raise notice 'Empieza la generacion ';

		select sujetoid,tiposocioid,solicitudingresoid
		into lsujetoid,stiposocioid,lsolicitudingresoid
		from solicitudingreso
		where nosolicitud=lnosolicitud;

		if stiposocioid='01' then
			raise notice 'Es un socio menor ...';
		else
			 raise notice 'Generando socio ...';
			select nextsocio()
         into sclavesocioint;
		end if;
		
		raise notice 'd = % - % - % - % - %',lsocioid1,lsujetoid,stiposocioid,sclavesocioint,lsolicitudingresoid;
		-- Insertar el socio
		select * into lsocioid1 from spisocio(lsocioid1,lsujetoid,stiposocioid,sclavesocioint,CURRENT_DATE,NULL,1,lsolicitudingresoid,NULL);
		--spisocio(integer, integer, character, integer, integer, character, date, date, integer, integer)

		update solicitudingreso
        set socioid=lsocioid1
		where nosolicitud=lnosolicitud;
  



  end if;



/*
-- Migrando Parametros

  raise notice 'Migrando Parametros';

 insert into parametros(parametroid,socioid,serie_user,cuentacaja,impresoracaja,impresorareporte,reporteslaser)
  SELECT parametroid,socioid,serie_user,cuentacaja,impresoracaja,impresorareporte,reporteslaser
  FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
                 'set search_path to public,'||''''||psucursal||''''||';
                   select parametroid,socioid,serie_user,cuentacaja,impresoracaja,impresorareporte,reporteslaser
                   from parametros s
                   where socioid='||''''||pclavesocioint||''''||';')
            as t(parametroid int4,socioid char(20),serie_user char(2),cuentacaja char(24),impresoracaja char(50), impresorareporte char(50), reporteslaser int4);

  raise notice ' Parametro socioid = %',pclavesocioint;

  -- Migrando Permisos modulos

  raise notice 'Migrando Permisos';

 insert into permisosmodulos(clavemodulo,socioid,permiso)
  SELECT clavemodulo,socioid,permiso
  FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
                 'set search_path to public,'||''''||psucursal||''''||';
                   select clavemodulo,socioid,permiso
                   from permisosmodulos s
                   where socioid='||''''||pclavesocioint||''''||';')
            as t(clavemodulo char(10),socioid char(20),permiso char(1));

  raise notice ' Permisos socioid = %',pclavesocioint;*/

  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasasocioutil(character, character varying, character varying, character varying) OWNER TO sistema;

--
-- Name: traspasaunacuenta(character, character, character, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasaunacuenta(character, character, character, character) RETURNS integer
    AS $_$
declare

  pcuenta alias for $1;
  phost alias for $2;
  pdb alias for $3;
  psucursal alias for $4;

  r record;

  pretirosocio integer;

begin

 raise notice 'Inicio Traspaso de cuentas'; 

 for r in
      select * from
 dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema  password=1sc4pslu2',
        'set search_path to public,'||''''||psucursal||''''||';
                   select cuentaid, cat_cuentaid, identificacion, cuentanombre,
 tipo_cta, estado_cta, fecha_estado, fecha_ult_mov, naturaleza, digito_agrupador, saldo_inic_ejer, cargos_acum_ejer, abonos_acum_ejer from catalogo_ctas where cuentaid='||''''||pcuenta||''''||' order by cuentaid;')
            as t(cuentaid character(24), cat_cuentaid character(24), identificacion character(1), cuentanombre character(100), tipo_cta character(1), estado_cta character(1), fecha_estado date, fecha_ult_mov date, naturaleza character(1), digito_agrupador numeric, saldo_inic_ejer numeric, cargos_acum_ejer  numeric, abonos_acum_ejer  numeric)

  loop

      if r.cuentaid not in (select cuentaid from catalogo_ctas where cuentaid=r.cuentaid)
       then
          raise notice 'cuentaid % es nueva',r.cuentaid;
          insert into catalogo_ctas (cuentaid,cat_cuentaid,identificacion,cuentanombre,tipo_cta,estado_cta,fecha_estado,fecha_ult_mov,naturaleza,digito_agrupador,saldo_inic_ejer)
          values(r.cuentaid,r.cat_cuentaid,r.identificacion,r.cuentanombre,r.tipo_cta,r.estado_cta,r.fecha_estado,r.fecha_ult_mov,r.naturaleza,r.digito_agrupador,r.saldo_inic_ejer);

     else

       raise notice 'actualizando cuentaid % ',r.cuentaid;
       update  catalogo_ctas set cat_cuentaid=r.cat_cuentaid, identificacion=r.identificacion, cuentanombre=r.cuentanombre, tipo_cta=r.tipo_cta, estado_cta=r.estado_cta, fecha_estado=r.fecha_estado, fecha_ult_mov=r.fecha_ult_mov, naturaleza=r.naturaleza, digito_agrupador=r.digito_agrupador, saldo_inic_ejer=r.saldo_inic_ejer where cuentaid=r.cuentaid;

     end if;
  end loop;

  raise notice 'Termine Cuentas';

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasaunacuenta(character, character, character, character) OWNER TO sistema;

--
-- Name: traspasausuario(character, character varying, character varying, character varying); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasausuario(character, character varying, character varying, character varying) RETURNS integer
    AS $_$
declare
  pusuarioid alias for $1;
  phost alias for $2;
  pdb alias for $3;
  psucursal alias for $4;

  lusuarioid char(20);
  lsujetoid int4;
  ldomicilioid int4;

  spaterno varchar(20);
  smaterno varchar(20);
  snombre varchar(40);
  srfc char(16);
  sresujetoid int4;
  sresujetoid1 int4;
  lrelacionid int4;
  lresujetoid int4;

  setdomicilio int4;
  setsujeto int4;
  setsocio int4;
  setrelacion int4;
  setsolingreso int4;

begin

  select usuarioid into lusuarioid from usuarios where usuarioid=pusuarioid;
  lusuarioid := COALESCE ( lusuarioid,' ' );

  if lusuarioid = ' ' then

  select paterno,materno,nombre,rfc,sujetoid into spaterno,smaterno,snombre,srfc,sresujetoid1 from
     dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
        'set search_path to public,'||''''||psucursal||''''||';
                   select paterno,materno,nombre,rfc,su.sujetoid
                     from sujeto su, usuarios s 
                    where s.usuarioid='||''''||pusuarioid||''''||' and
                          su.sujetoid=s.sujetoid;')
            as t(paterno varchar(20), materno varchar(20), nombre varchar(40),rfc char(16), sujetoid int4);

  raise notice ' Nombre: % % %',spaterno,smaterno,snombre;

  select su.sujetoid,d.domicilioid into lsujetoid,ldomicilioid from sujeto su, domicilio d where paterno=spaterno and materno=smaterno and nombre=snombre and rfc=srfc and su.sujetoid=d.sujetoid;

  lsujetoid := COALESCE ( lsujetoid, 0 );

  if lsujetoid= 0 then

           -- Migrando Sujeto
            raise notice 'Migrando sujeto';

           insert into sujeto (paterno,materno,nombre,rfc,curp,edad,fecha_nacimiento,razonsocial)
           SELECT paterno,materno,nombre,rfc,curp,edad,fecha_nacimiento,razonsocial
           FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
                 'set search_path to public,'||''''||psucursal||''''||';
                   select su.paterno,su.materno,su.nombre,su.rfc,su.curp,su.edad,
                          su.fecha_nacimiento,su.razonsocial
                     from usuarios s,sujeto su
                    where s.usuarioid='||''''||pusuarioid||''''||' and
                          su.sujetoid=s.sujetoid;')
            as t(paterno varchar(20),materno varchar(20),nombre varchar(40),
                 rfc char(16),curp char(20),edad numeric,fecha_nacimiento date,
                 razonsocial varchar(60));

            lsujetoid:=currval('sujeto_sujetoid_seq');
            raise notice 'SujetoID= %',lsujetoid;

            -- Migrando Domicilio
            raise notice 'Migrando Domicilio';

            insert into domicilio (ciudadmexid,sujetoid,calle,numero_ext,numero_int,colonia,
                         codpostal,comunidad,teldomicilio)
            SELECT existeciudad(ciudadmexid),lsujetoid,calle,numer_ext,numero_int,colonia,codpostal,
            comunidad,teldomicilio
            FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
                 'set search_path to public,'||''''||psucursal||''''||';
                   select d.ciudadmexid,d.sujetoid,d.calle,d.numero_ext,d.numero_int,
                          d.colonia,d.codpostal,d.comunidad,d.teldomicilio
                     from usuarios s,domicilio d
                    where s.usuarioid='||''''||pusuarioid||''''||' and
                          d.sujetoid=s.sujetoid;')
            as t(ciudadmexid int4,sujetoid int4,calle varchar(30),numer_ext varchar(15),
                 numero_int varchar(15),colonia varchar(30),codpostal int4,
                 comunidad varchar(50),teldomicilio varchar(20));   

            ldomicilioid:=currval('domicilio_domicilioid_seq');
            raise notice 'DomicilioID= %',ldomicilioid;

  end if;

-- Migrando Usuario
  raise notice 'Migrando Usuario';

  insert into usuarios(usuarioid,tipousuarioid,usu_usuarioid,contrasenia,email,dicola,obsusuario,sujetoid)
  SELECT usuarioid,tipousuarioid,usu_usuarioid,contrasenia,email,dicola,obsusuario,lsujetoid
  FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
                 'set search_path to public,'||''''||psucursal||''''||';
                   select usuarioid,tipousuarioid,usu_usuarioid,contrasenia,email,dicola,obsusuario,sujetoid
                   from usuarios s
                   where usuarioid='||''''||pusuarioid||''''||';')
            as t(usuarioid char(20),tipousuarioid char(3),usu_usuarioid char(20),contrasenia varchar(13), email varchar(30), dicola varchar(10), obsusuario varchar(254),sujetoid int4);

  raise notice 'Usuarioid = %',pusuarioid;


-- Migrando Parametros

  raise notice 'Migrando Parametros';

 insert into parametros(parametroid,usuarioid,serie_user,cuentacaja,impresoracaja,impresorareporte,reporteslaser)
  SELECT parametroid,usuarioid,serie_user,cuentacaja,impresoracaja,impresorareporte,reporteslaser
  FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
                 'set search_path to public,'||''''||psucursal||''''||';
                   select parametroid,usuarioid,serie_user,cuentacaja,impresoracaja,impresorareporte,reporteslaser
                   from parametros s
                   where usuarioid='||''''||pusuarioid||''''||';')
            as t(parametroid int4,usuarioid char(20),serie_user char(2),cuentacaja char(24),impresoracaja char(50), impresorareporte char(50), reporteslaser int4);

  raise notice ' Parametro Usuarioid = %',pusuarioid;

  -- Migrando Permisos modulos

  raise notice 'Migrando Permisos';

 insert into permisosmodulos(clavemodulo,usuarioid,permiso)
  SELECT clavemodulo,usuarioid,permiso
  FROM dblink('host='||''''||phost||''''||' dbname='||''''||pdb||''''||' user=sistema password=1sc4pslu2',
                 'set search_path to public,'||''''||psucursal||''''||';
                   select clavemodulo,usuarioid,permiso
                   from permisosmodulos s
                   where usuarioid='||''''||pusuarioid||''''||';')
            as t(clavemodulo char(10),usuarioid char(20),permiso char(1));

  raise notice ' Permisos Usuarioid = %',pusuarioid;

  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasausuario(character, character varying, character varying, character varying) OWNER TO sistema;

--
-- Name: traspasoip(character, character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasoip(character, character, character, date) RETURNS integer
    AS $_$
declare

  pserie alias for $1;
  ptipomovimientoid1 alias for $2;
  ptipomovimientoid2 alias for $3;
  pfecha alias for $4;

  r record;
  j int4;
  
  scuentacaja   char(24);
  msaldoahorro  numeric;
  msaldoparte   numeric;
  pparte        numeric;
  pretiromov    int4;
  pdepositomov  int4;
  pfechamovi    date;

begin

pfechamovi := pfecha;

select cuentacaja into scuentacaja from parametros where serie_user=pserie;

j:=0;

for r in
    select p.saldoprestamo,s.clavesocioint,s.socioid,p.diasvencidos,pr.prestamoid from precorte p, prestamos pr, socio s where p.fechacierre=pfecha and p.saldoprestamo>0 and p.prestamoid=pr.prestamoid and pr.socioid=s.socioid

    loop

    -- Retirar de ahorro la parte necesaria para acompletar en parte social la cantidad traspasada

    --if r.diasvencidos > 119 then 

       select saldomov into msaldoparte from
          saldomov(r.socioid,ptipomovimientoid1,pfechamovi);
          msaldoparte := COALESCE (msaldoparte,0);

       if msaldoparte > 0 then 

          j:=j+1;

          select retiromovseguro into pretiromov
                from retiromovseguro(r.clavesocioint,pfechamovi,msaldoparte,ptipomovimientoid1,pserie,scuentacaja);
                raise notice ' Retirando movimiento 1  % % % ',r.clavesocioint,ptipomovimientoid1,msaldoparte;

          select depositomovseguro into pdepositomov
                from depositomovseguro(r.clavesocioint,pfechamovi,msaldoparte,ptipomovimientoid2,pserie,scuentacaja);
                raise notice ' Depositando el movimiento 1  % % % ',r.clavesocioint,ptipomovimientoid2,msaldoparte;

          update prestamos set monto_garantia=monto_garantia+msaldoparte where prestamoid=r.prestamoid;

       end if;

    --end if;

  end loop;

return j;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasoip(character, character, character, date) OWNER TO sistema;

--
-- Name: traspasop3(character, character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasop3(character, character, character, date) RETURNS integer
    AS $_$
declare

  pserie alias for $1;
  ptipomovimientoid1 alias for $2;
  ptipomovimientoid2 alias for $3;
  pfecha alias for $4;

  r record;
  j int4;
  
  scuentacaja   char(24);
  msaldoahorro  numeric;
  msaldoparte   numeric;
  pparte        numeric;
  pretiromov    int4;
  pdepositomov  int4;
  pfechamovi    date;

begin

pfechamovi := pfecha;

select cuentacaja into scuentacaja from parametros where serie_user=pserie;

j:=0;

for r in
    select p.saldoprestamo,s.clavesocioint,s.socioid,p.diasvencidos,pr.prestamoid,p.depositogarantia from precorte p, prestamos pr, socio s where p.fechacierre=pfecha and p.saldoprestamo>0 and p.prestamoid=pr.prestamoid and pr.socioid=s.socioid

    loop

    -- Retirar de ahorro la parte necesaria para acompletar en parte social la cantidad traspasada   

       select saldomov into msaldoparte from
          saldomov(r.socioid,ptipomovimientoid1,pfechamovi);
          msaldoparte := COALESCE (msaldoparte,0);

          msaldoparte := trunc(msaldoparte/500)*500;

       if msaldoparte > 0 then 

          j:=j+1;

          select retiromovseguro into pretiromov
                from retiromovseguro(r.clavesocioint,pfechamovi,msaldoparte,ptipomovimientoid1,pserie,scuentacaja);
                raise notice ' Retirando movimiento 1  % % % ',r.clavesocioint,ptipomovimientoid1,msaldoparte;

          select depositomovseguro into pdepositomov
                from depositomovseguro(r.clavesocioint,pfechamovi,msaldoparte,ptipomovimientoid2,pserie,scuentacaja);
                raise notice ' Depositando el movimiento 1  % % % ',r.clavesocioint,ptipomovimientoid2,msaldoparte;

         -- update prestamos set monto_garantia=monto_garantia+msaldoparte where prestamoid=r.prestamoid;

       end if;   

  end loop;

return j;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasop3(character, character, character, date) OWNER TO sistema;

--
-- Name: traspasoreciprocidad(character, character, character, date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION traspasoreciprocidad(character, character, character, date) RETURNS integer
    AS $_$
declare

  pserie alias for $1;
  ptipomovimientoid1 alias for $2;
  ptipomovimientoid2 alias for $3;
  pfecha alias for $4;

  r record;
  j int4;
  
  scuentacaja   char(24);
  msaldoahorro  numeric;
  msaldoparte   numeric;
  pparte        numeric;
  pretiromov    int4;
  pdepositomov  int4;
  pfechamovi    date;

begin

pfechamovi := pfecha;

select cuentacaja into scuentacaja from parametros where serie_user=pserie;

j:=0;

for r in
    select p.saldoprestamo,s.clavesocioint,s.socioid,p.diasvencidos,pr.prestamoid from precorte p, prestamos pr, socio s where p.fechacierre=pfecha and p.saldoprestamo>0 and p.prestamoid=pr.prestamoid and pr.socioid=s.socioid

    loop

    -- Retirar de ahorro la parte necesaria para acompletar en parte social la cantidad traspasada

    if r.diasvencidos > 119 then 

       select saldomov into msaldoparte from
          saldomov(r.socioid,ptipomovimientoid1,pfechamovi);
          msaldoparte := COALESCE (msaldoparte,0);

       if msaldoparte > 0 then 

          j:=j+1;

          select retiromovseguro into pretiromov
                from retiromovseguro(r.clavesocioint,pfechamovi,msaldoparte,ptipomovimientoid1,pserie,scuentacaja);
                raise notice ' Retirando movimiento 1  % % % ',r.clavesocioint,ptipomovimientoid1,msaldoparte;

          select depositomovseguro into pdepositomov
                from depositomovseguro(r.clavesocioint,pfechamovi,msaldoparte,ptipomovimientoid2,pserie,scuentacaja);
                raise notice ' Depositando el movimiento 1  % % % ',r.clavesocioint,ptipomovimientoid2,msaldoparte;

          update prestamos set monto_garantia=monto_garantia+msaldoparte where prestamoid=r.prestamoid;

       end if;

    end if;

  end loop;

return j;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.traspasoreciprocidad(character, character, character, date) OWNER TO sistema;

--
-- Name: trigger_insert_update_amortizacion(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION trigger_insert_update_amortizacion() RETURNS "trigger"
    AS $$
DECLARE
	idia  INTEGER;
BEGIN

	-- Checar si vencimiento es inhabil
	IF NEW.fechadepago IS NOT NULL THEN
          while exists( select fecha from inabil where fecha=NEW.fechadepago)
          loop 
             if exists( select fecha from inabil where fecha=NEW.fechadepago) then
                NEW.fechadepago:=NEW.fechadepago+1;
             end if;
          end loop;

        end if;
	RETURN NEW;

END;$$
    LANGUAGE plpgsql;


ALTER FUNCTION public.trigger_insert_update_amortizacion() OWNER TO sistema;

--
-- Name: trigger_insert_update_inversion(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION trigger_insert_update_inversion() RETURNS "trigger"
    AS $$
DECLARE
	idia  INTEGER;
BEGIN

	-- Checar si vencimiento es inhabil
	IF NEW.fechavencimiento IS NOT NULL THEN
          while exists( select fecha from inabil where fecha=NEW.fechavencimiento)
          loop 
             if exists( select fecha from inabil where fecha=NEW.fechavencimiento) then
                NEW.fechavencimiento:=NEW.fechavencimiento+1;
             end if;
          end loop;

        end if;
	RETURN NEW;

END;$$
    LANGUAGE plpgsql;


ALTER FUNCTION public.trigger_insert_update_inversion() OWNER TO sistema;

--
-- Name: trigger_insert_update_prestamo(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION trigger_insert_update_prestamo() RETURNS "trigger"
    AS $$
DECLARE
	idia  INTEGER;
BEGIN

	-- Checar si vencimiento es inhabil
	IF NEW.fecha_vencimiento IS NOT NULL THEN
          while exists( select fecha from inabil where fecha=NEW.fecha_vencimiento)
          loop 
             if exists( select fecha from inabil where fecha=NEW.fecha_vencimiento) then
                NEW.fecha_vencimiento:=NEW.fecha_vencimiento+1;
             end if;
          end loop;

        end if;

	IF NEW.fecha_1er_pago IS NOT NULL THEN
          while exists( select fecha from inabil where fecha=NEW.fecha_1er_pago)
          loop 
             if exists( select fecha from inabil where fecha=NEW.fecha_1er_pago) then
                NEW.fecha_1er_pago:=NEW.fecha_1er_pago+1;
             end if;
          end loop;

        end if;

	IF NEW.calculonormalid IS NOT NULL THEN
          NEW.calculonormalid:= (select calculonormalid from tipoprestamo where tipoprestamoid=NEW.tipoprestamoid);
        end if;

	IF NEW.calculomoratorioid IS NOT NULL THEN
          NEW.calculomoratorioid:= (select calculomoraid from tipoprestamo where tipoprestamoid=NEW.tipoprestamoid);
        end if;

	RETURN NEW;


END;

$$
    LANGUAGE plpgsql;


ALTER FUNCTION public.trigger_insert_update_prestamo() OWNER TO sistema;

--
-- Name: udi(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION udi(date) RETURNS numeric
    AS $_$
declare
  pfecha alias for $1;

  fudi numeric;
begin

  select valor into fudi from udis where fecha=pfecha;

  fudi:=coalesce(fudi,1);

return fudi;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.udi(date) OWNER TO sistema;

--
-- Name: ultimoabono(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION ultimoabono(integer) RETURNS date
    AS $_$
declare
  pprestamoid alias for $1;

  scuentaactivo char(24);
  lsocioid int4;
  dultimoabono date;
  dfecha_otorga date;
begin
  
  select p.socioid,tp.cuentaactivo,p.fecha_otorga
    into lsocioid,scuentaactivo,dfecha_otorga
    from prestamos p, tipoprestamo tp
   where p.prestamoid = pprestamoid and
         tp.tipoprestamoid = p.tipoprestamoid;


  select max(p.fechapoliza)
    into dultimoabono
    from movicaja mc, movipolizas mp, polizas p
   where mc.socioid = lsocioid and
         mc.prestamoid = pprestamoid and
         mc.tipomovimientoid = '00' and
         mp.polizaid = mc.polizaid and
         mp.cuentaid = scuentaactivo and
         p.polizaid = mc.polizaid and
         mc.estatusmovicaja<>'C';

   dultimoabono := coalesce(dultimoabono,dfecha_otorga);

return dultimoabono;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.ultimoabono(integer) OWNER TO sistema;

--
-- Name: validapromocion(integer, character, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION validapromocion(integer, character, numeric) RETURNS boolean
    AS $_$
declare

  psocioid alias for $1;
  ptipomovimientoid alias for $2;
  pretiro alias for $3;

  lpromocionid int4;
  itipopromocionid int4;

begin

  select p.promocionid,t.tipopromocionid
    into lpromocionid,itipopromocionid
    from promocion p, tipopromocion t
   where p.socioid=psocioid and
         t.tipopromocionid=p.tipopromocionid and
         t.tipomovimientoid = ptipomovimientoid and
         p.estatus=0 ;
         
  lpromocionid:=coalesce(lpromocionid,0);

  if lpromocionid>0 then
    return false;
  end if;

return true;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.validapromocion(integer, character, numeric) OWNER TO sistema;

--
-- Name: validaraperturadecajas(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION validaraperturadecajas(date) RETURNS integer
    AS $_$
declare
  pfechaapertura alias for $1;
  scuentacaja character(24);
  r record;
  fsaldocuenta numeric;

begin

fsaldocuenta:=0;
for r in 
select usuarioid,serie_user,cuentacaja from parametros  
loop

   select sum(debe)-sum(haber) as saldocuenta into fsaldocuenta from movipolizas where cuentaid=r.cuentacaja and polizaid in (select polizaid from polizas where fechapoliza < pfechaapertura);

   fsaldocuenta:=coalesce(fsaldocuenta,0);

   if exists (select usuarioid,serie_user,cuentacaja,fechaapertura from cerrarabrircaja where usuarioid=r.usuarioid and serie_user=r.serie_user and cuentacaja=r.cuentacaja and fechaapertura=pfechaapertura ) then 

        if fsaldocuenta = 0  then 
           update cerrarabrircaja set saldoapertura=fsaldocuenta, permitirapertura=1 where usuarioid=r.usuarioid and serie_user=r.serie_user and cuentacaja=r.cuentacaja and fechaapertura=pfechaapertura;
        else 
           update cerrarabrircaja set saldoapertura=fsaldocuenta, permitirapertura=0 where usuarioid=r.usuarioid and serie_user=r.serie_user and cuentacaja=r.cuentacaja and fechaapertura=pfechaapertura;
        end if;
   else
        if fsaldocuenta = 0  then 
           insert into cerrarabrircaja(usuarioid,serie_user,cuentacaja,fechaapertura,permitirapertura,saldoapertura,permitirsupervisor) values (r.usuarioid,r.serie_user,r.cuentacaja,pfechaapertura,1,fsaldocuenta,1);
        else
           insert into cerrarabrircaja(usuarioid,serie_user,cuentacaja,fechaapertura,permitirapertura,saldoapertura,permitirsupervisor) values (r.usuarioid,r.serie_user,r.cuentacaja,pfechaapertura,0,fsaldocuenta,0);
        end if;
   end if; 


end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.validaraperturadecajas(date) OWNER TO sistema;

--
-- Name: validarcierredecajas(date); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION validarcierredecajas(date) RETURNS integer
    AS $_$
declare
  pfechacierre alias for $1;
  scuentacaja character(24);
  r record;
  fsaldocuenta numeric;

begin

fsaldocuenta:=0;
for r in 
select usuarioid,serie_user,cuentacaja from parametros  
loop

   select sum(debe)-sum(haber) as saldocuenta into fsaldocuenta from movipolizas where cuentaid=r.cuentacaja and polizaid in (select polizaid from polizas where fechapoliza <= pfechacierre);

   fsaldocuenta:=coalesce(fsaldocuenta,0);

   if exists (select usuarioid,serie_user,cuentacaja,fechacierre from cerrarabrircaja where usuarioid=r.usuarioid and serie_user=r.serie_user and cuentacaja=r.cuentacaja and fechacierre=pfechacierre ) then 

        if fsaldocuenta = 0  then 
           update cerrarabrircaja set saldoalcierre=fsaldocuenta, permitircierre=1 where usuarioid=r.usuarioid and serie_user=r.serie_user and cuentacaja=r.cuentacaja and fechacierre=pfechacierre;
        else 
           update cerrarabrircaja set saldoalcierre=fsaldocuenta, permitircierre=0 where usuarioid=r.usuarioid and serie_user=r.serie_user and cuentacaja=r.cuentacaja and fechacierre=pfechacierre;
        end if;
   else
        if fsaldocuenta = 0  then 
           insert into cerrarabrircaja(usuarioid,serie_user,cuentacaja,fechacierre,permitircierre,saldoalcierre) values (r.usuarioid,r.serie_user,r.cuentacaja,pfechacierre,1,fsaldocuenta);
        else
           insert into cerrarabrircaja(usuarioid,serie_user,cuentacaja,fechacierre,permitircierre,saldoalcierre) values (r.usuarioid,r.serie_user,r.cuentacaja,pfechacierre,0,fsaldocuenta);
        end if;
   end if; 

end loop;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.validarcierredecajas(date) OWNER TO sistema;

--
-- Name: verificaahorro(integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificaahorro(integer, numeric) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;
    pbonifica alias for $2;
  fahorro numeric;
 
begin

select sum(ahorro)-sum(ahorropagado) into fahorro from amortizaciones where prestamoid=pprestamoid and fechadepago <= current_date ;
fahorro:=coalesce(fahorro,0);

return fahorro-pbonifica;


end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificaahorro(integer, numeric) OWNER TO sistema;

--
-- Name: verificaahorroapertura(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificaahorroapertura(integer) RETURNS numeric
    AS $_$
declare
  pprestamoid alias for $1;
   
  fcomision numeric;
  itipocobrocomision integer;
 
  fmontoprestamo numeric;
  pporcentaje numeric;
  ptipoprestamoid char(3);
  fsaldoprestamo numeric;
  fahorro numeric;
  
begin

--comision                
--tipocobrocomision 0= al otorgamiento, 1 ala primera amortizacion, 2 al vencimiento.

select montoprestamo,tipoprestamoid,saldoprestamo into fmontoprestamo,ptipoprestamoid,fsaldoprestamo from prestamos where prestamoid=pprestamoid;

select porcentaje into pporcentaje from cargoprestamo where tipoprestamoid = ptipoprestamoid and apertura=1 and tipocargo = 2 and fmontoprestamo > rangoinicial and fmontoprestamo < rangofinal;

pporcentaje := coalesce(pporcentaje,0);
fahorro:=fmontoprestamo*pporcentaje/100;


return fahorro;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificaahorroapertura(integer) OWNER TO sistema;

--
-- Name: verificaamortizacionpagada(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificaamortizacionpagada(character) RETURNS integer
    AS $_$
declare
  preferenciaprestamo alias for $1;

  fAbono numeric;
  fAplicar numeric;
  amor record;
  pprestamoid int4;

  lsaldoprestamo numeric;

  finteres numeric;
  fintpag numeric;
  
begin

select prestamoid into pprestamoid from prestamos where referenciaprestamo=preferenciaprestamo;

-- Actualizar interes pagado

  select sum(case when m.cuentaid=t.cuentaactivo then m.haber else 0 end) as interes into finteres from movicaja mc, movipolizas m, prestamos pr,  tipoprestamo t where mc.prestamoid=pprestamoid and mc.tipomovimientoid='00' and pr.prestamoid = mc.prestamoid and t.tipoprestamoid = pr.tipoprestamoid and m.polizaid = mc.polizaid;

  update amortizaciones set abonopagado=0 where prestamoid=pprestamoid;

  raise notice ' Pago Capital % prestamoid %',finteres,pprestamoid;

  if finteres > 0 then
    for amor in 
        select *
          from amortizaciones
         where prestamoid=pprestamoid 
      order by fechadepago
    loop

      if finteres > amor.importeamortizacion then
         update amortizaciones set abonopagado=amor.importeamortizacion 
         where amortizacionid=amor.amortizacionid;
         finteres:=finteres-amor.importeamortizacion ;
      else
        if finteres > 0 then
          if amor.abonopagado = amor.importeamortizacion then 
          --    update amortizaciones set importeamortizacion=finteres 
          --   where amortizacionid=amor.amortizacionid;
          end if;
          update amortizaciones set abonopagado=finteres 
          where amortizacionid=amor.amortizacionid;
          finteres:=0;
        end if;
      end if;
      --raise notice ' interes % ',finteres;
    end loop;
  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificaamortizacionpagada(character) OWNER TO sistema;

--
-- Name: verificacobranza(integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificacobranza(integer, numeric) RETURNS SETOF rcobranza
    AS $_$
declare
  pprestamoid alias for $1;
  pbonifica alias for $2;
  
  r rcobranza%rowtype;
 
  fdias integer;
  fiva numeric;
  fcobranza numeric;
  
begin

select iva into fiva from empresa; 

select sum(cobranza)-sum(cobranzapagado) into fcobranza from amortizaciones where prestamoid=pprestamoid and fechadepago < current_date and importeamortizacion > abonopagado;

fcobranza:=coalesce(fcobranza,0);

r.cobranza:=fcobranza-pbonifica;
r.ivacobranza:=r.cobranza*fiva;

return next r;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificacobranza(integer, numeric) OWNER TO sistema;

--
-- Name: verificacomisionmovimiento(character, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificacomisionmovimiento(character, numeric) RETURNS SETOF rcomision
    AS $_$
declare
  ptipomovimientoid alias for $1;
  pdeposito alias for $2;
  
  r rcomision%rowtype;

  montocomision numeric;
  nporcomision numeric;
  nporivacomision numeric;
  
  fcomision numeric;
  fivacomision numeric;
  idesglosaiva integer;
 
  
begin

--return 50;

select comision,porcomision,porivacomision,desglosaiva into montocomision,nporcomision,nporivacomision,idesglosaiva from tipomovimiento where tipomovimientoid=ptipomovimientoid;

if idesglosaiva = 1 then
      raise notice ' %  %  %  %',montocomision,nporcomision,nporivacomision,pdeposito;
      r.comision:=0;
      r.ivacomision:= round(((pdeposito * nporivacomision)/100),2);
      return next r;

else
   if nporcomision>0 then
  
      r.comision:=(nporcomision/100)*pdeposito;
      r.ivacomision:=(nporcomision/100)*pdeposito*(nporivacomision/100);
      return next r;

      --raise notice ' %  %  %  %',montocomision,nporcomision,nporivacomision,pdeposito;
    
   else

      r.comision:=montocomision;
      r.ivacomision:=montocomision*(nporivacomision/100);
      return next r;

   end if;
   
end if;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificacomisionmovimiento(character, numeric) OWNER TO sistema;

--
-- Name: verificacomisionprestamo(integer, integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificacomisionprestamo(integer, integer, numeric) RETURNS SETOF rcomision
    AS $_$
declare
  pprestamoid alias for $1;
  ptipocobro alias for $2;
  pbonifica alias for $3;
  
  r rcomision%rowtype;
   
  fcomision numeric;
  itipocobrocomision integer;
 
  fmontoprestamo numeric;
  pporcentaje numeric;
  ptipoprestamoid char(3);
  fsaldoprestamo numeric;
  fiva numeric;
  fperiodicidad integer;
begin

--comision                
--tipocobrocomision 0= al otorgamiento, 1 ala primera amortizacion, 2 al vencimiento.

select iva into fiva from empresa;

select montoprestamo,tipoprestamoid,saldoprestamo, (case when dias_de_cobro > 0 then dias_de_cobro else meses_de_cobro * 30 end) into fmontoprestamo,ptipoprestamoid,fsaldoprestamo,fperiodicidad from prestamos where prestamoid=pprestamoid;

select porcentaje into pporcentaje from cargoprestamo where tipoprestamoid = ptipoprestamoid and apertura=1 and tipocargo = 0 and fmontoprestamo > rangoinicial and fmontoprestamo < rangofinal;

pporcentaje := coalesce(pporcentaje,0);


if ptipocobro=0 and fsaldoprestamo=fmontoprestamo then
 
   r.comision=pporcentaje/100*fmontoprestamo;  
   r.comision=round(r.comision-pbonifica,2);
   r.ivacomision=round(r.comision*fiva,2);
   
else

   r.comision:=0;
   r.ivacomision:=0;
   
end if;

return next r;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificacomisionprestamo(integer, integer, numeric) OWNER TO sistema;

--
-- Name: verificainteresnormal(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificainteresnormal() RETURNS integer
    AS $$
declare
r record;
sreferenciaprestamo integer;

begin
for r in select referenciaprestamo,fecha_otorga from prestamos where prestamoid in (select prestamoid from amortizaciones group by prestamoid having sum(interesnormal) = 0)
loop
  select generaramortizaciones into sreferenciaprestamo from generaramortizaciones(r.referenciaprestamo,0,r.fecha_otorga);
end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificainteresnormal() OWNER TO sistema;

--
-- Name: verificainterespagado(character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificainterespagado(character) RETURNS integer
    AS $_$
declare
  preferenciaprestamo alias for $1;

  fAbono numeric;
  fAplicar numeric;
  amor record;
  pprestamoid int4;

  lsaldoprestamo numeric;

  finteres numeric;
  fintpag numeric;
  
begin

select prestamoid into pprestamoid from prestamos where referenciaprestamo=preferenciaprestamo;

-- Actualizar interes pagado

  select sum(case when m.cuentaid=t.cuentaintnormal then m.haber else 0 end) as interes into finteres from movicaja mc, movipolizas m, prestamos pr,  tipoprestamo t where mc.prestamoid=pprestamoid and mc.tipomovimientoid='00' and pr.prestamoid = mc.prestamoid and t.tipoprestamoid = pr.tipoprestamoid and m.polizaid = mc.polizaid;

  update amortizaciones set interespagado=0 where prestamoid=pprestamoid;

  raise notice ' Interes % prestamoid %',finteres,pprestamoid;

  if finteres > 0 then
    for amor in 
        select *
          from amortizaciones
         where prestamoid=pprestamoid 
      order by fechadepago
    loop

      if finteres > amor.interesnormal then
         update amortizaciones set interespagado=amor.interesnormal 
         where amortizacionid=amor.amortizacionid;
         finteres:=finteres-amor.interesnormal ;
      else
        if finteres > 0 then
          if amor.abonopagado = amor.importeamortizacion then 
          --    update amortizaciones set interesnormal=finteres 
          --   where amortizacionid=amor.amortizacionid;
          end if;
          update amortizaciones set interespagado=finteres 
          where amortizacionid=amor.amortizacionid;
          finteres:=0;
        end if;
      end if;
      --raise notice ' interes % ',finteres;
    end loop;
  end if;

return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificainterespagado(character) OWNER TO sistema;

--
-- Name: verificalavado(numeric, integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificalavado(numeric, integer) RETURNS text
    AS $_$
declare
  pmontoaverificar alias for $1;
  psocioid alias for $2;
  filtro text;
begin
  if pmontoaverificar > 103000 then 
     filtro := 'RELEVANTE';
  else
     filtro := 'NORMAL';
  end if;
    
return filtro;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificalavado(numeric, integer) OWNER TO sistema;

--
-- Name: verificapagoamortizaciones(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificapagoamortizaciones() RETURNS integer
    AS $$
declare
r record;
sreferenciaprestamo integer;

begin
for r in select referenciaprestamo from prestamos where tipoprestamoid='N5'
loop

 select verificaamortizacionpagada into sreferenciaprestamo from verificaamortizacionpagada(r.referenciaprestamo);

end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificapagoamortizaciones() OWNER TO sistema;

--
-- Name: verificapagointeresamortizaciones(); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificapagointeresamortizaciones() RETURNS integer
    AS $$
declare
r record;
sreferenciaprestamo integer;

begin
for r in select referenciaprestamo,prestamoid from prestamos where tipoprestamoid='N5'
loop
  update amortizaciones set importeamortizacion=round(importeamortizacion,2),interesnormal=round(interesnormal,2),iva=round(iva,2),totalpago=importeamortizacion+interesnormal+iva where prestamoid=r.prestamoid;
  select verificainterespagado into sreferenciaprestamo from verificainterespagado(r.referenciaprestamo);

end loop;

return 1;
end
$$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificapagointeresamortizaciones() OWNER TO sistema;

--
-- Name: verificaprestamosgrupal(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificaprestamosgrupal(integer) RETURNS SETOF prestamogrupal
    AS $_$    
declare  
  r prestamogrupal%rowtype;
  pprestamoid alias for $1;
  sgrupo char(25);
  icontratogrupo integer;

begin

    select grupo,contratogrupo into sgrupo,icontratogrupo from solicitudprestamo where solicitudprestamoid in (select solicitudprestamoid from prestamos where prestamoid=pprestamoid);
    
    for r in

        select prestamoid,tipoprestamoid,montoprestamo,comision,sgrupo,icontratogrupo from prestamos  where solicitudprestamoid in ( select solicitudprestamoid from solicitudprestamo where grupo=sgrupo and contratogrupo=icontratogrupo)
        loop
          return next r;
        end loop;
return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificaprestamosgrupal(integer) OWNER TO sistema;

--
-- Name: verificaprevencion(integer, character); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificaprevencion(integer, character) RETURNS text
    AS $_$
declare
  preferenciacaja alias for $1;
  pseriecaja alias for $2;
  filtro text;
  pmontorelevante numeric;
  pmontoinusual numeric;
  pdeposito numeric;
  pinusual numeric;
  isocioid integer;
  dfecha date;
  stipomovimientoid char(2);
    
begin

  filtro := 'NORMAL';
  pmontorelevante:= 130000;
  pmontoinusual:= 39000;
  select current_date into dfecha;
  
  select socioid,tipomovimientoid into isocioid,stipomovimientoid from movicaja where referenciacaja =preferenciacaja and seriecaja=pseriecaja;

  if stipomovimientoid not in ('RE') then
  
     select coalesce(sum(valor),0) into pdeposito from sabana where referenciacaja =preferenciacaja and seriecaja=pseriecaja and entradasalida=0;

     select coalesce(sum(valor),0) into pinusual from sabana where socioid = isocioid and fecha > dfecha-7;
  
     --raise notice ' % %',pinusual,pdeposito;

     if pinusual > pmontoinusual then 
        filtro := 'INUSUAL';
     end if;
  
     if pdeposito > pmontorelevante then 
        filtro := 'RELEVANTE';
     end if;
  
  end if;
  filtro := 'NORMAL';       
     
return filtro;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificaprevencion(integer, character) OWNER TO sistema;

--
-- Name: verificaseguro(integer, numeric); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificaseguro(integer, numeric) RETURNS SETOF rseguro
    AS $_$
declare
  pprestamoid alias for $1;
  pbonifica alias for $2;
    
  r rseguro%rowtype;
    
  fdias integer;
  fiva numeric;
  fseguro numeric;
  stipoprestamoid char(3);
  pmonto numeric;
  iaplicaiva integer;
  
begin

select iva into fiva from empresa;
select tipoprestamoid,montoprestamo into stipoprestamoid,pmonto from prestamos where pprestamoid=prestamoid;

select aplicaiva into iaplicaiva from cargoprestamo where tipoprestamoid = stipoprestamoid and poramortizacion = 1 and tipocargo = 1 and pmonto > rangoinicial and pmonto < rangofinal;

select sum(seguro)-sum(seguropagado) into fseguro from amortizaciones where prestamoid=pprestamoid and fechadepago <= current_date;

fseguro:=coalesce(fseguro,0);

if fseguro=0 then
  raise notice 'seguro % ',fseguro;
  select sum(seguro)-sum(seguropagado) into fseguro from amortizaciones where prestamoid=pprestamoid and fechadepago in (select min(fechadepago) from amortizaciones where seguropagado < seguro and prestamoid=pprestamoid );
  fseguro:=coalesce(fseguro,0);
  
end if; 

r.seguro:=fseguro-pbonifica;

if iaplicaiva =1 then 
   r.ivaseguro:=r.seguro*fiva;
else
   r.ivaseguro:=0;
end if;

return next r;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificaseguro(integer, numeric) OWNER TO sistema;

--
-- Name: verificaseguroapertura(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION verificaseguroapertura(integer) RETURNS SETOF rseguro
    AS $_$
declare
  pprestamoid alias for $1;
    
  r rseguro%rowtype;
    
  fdias integer;
  fiva numeric;
  fseguro numeric;
  stipoprestamoid char(3);
  pmonto numeric;
  iaplicaiva integer;
  pporcentaje numeric;
  
begin

select iva into fiva from empresa;
select tipoprestamoid,montoprestamo into stipoprestamoid,pmonto from prestamos where pprestamoid=prestamoid;

select aplicaiva,porcentaje into iaplicaiva,pporcentaje from cargoprestamo where tipoprestamoid = stipoprestamoid and apertura = 1 and tipocargo = 1 and pmonto > rangoinicial and pmonto < rangofinal;

fseguro:=round(pmonto*pporcentaje/100,2); 

fseguro:=coalesce(fseguro,0);

raise notice 'seguro % % %',fseguro,pmonto,stipoprestamoid;

if fseguro=0 then
  raise notice 'seguro % ',fseguro;
  --select sum(seguro)-sum(seguropagado) into fseguro from amortizaciones where prestamoid=pprestamoid and fechadepago in (select min(fechadepago) from amortizaciones where seguropagado < seguro);
  --fseguro:=coalesce(fseguro,0);
end if; 

r.seguro:=fseguro;

if iaplicaiva =1 then 
   r.ivaseguro:=r.seguro*fiva;
else
   r.ivaseguro:=0;
end if;

return next r;

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.verificaseguroapertura(integer) OWNER TO sistema;

--
-- Name: zonamarginada(integer); Type: FUNCTION; Schema: public; Owner: sistema
--

CREATE FUNCTION zonamarginada(integer) RETURNS character
    AS $_$
declare
psocioid alias for $1;
cmarginacion character(15);
ipoblacion integer;
zona character(2);

begin

  select marginacion,poblacion into cmarginacion,ipoblacion  from  comunidadconapo where claveconapo = (select claveconapo from ciudadesmex c, domicilio d, sujeto su, socio so  where so.socioid=psocioid and so.sujetoid=su.sujetoid and d.sujetoid=su.sujetoid and c.ciudadmexid = d.ciudadmexid);

  zona:= 'NO';

  if cmarginacion='Medio' and ipoblacion < 15000 then 
   zona:= 'SI';
  end if;

  if cmarginacion='Alto' or cmarginacion='Muy Alto' then 
   zona:= 'SI';
  end if;

  return zona;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION public.zonamarginada(integer) OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: spdgrupo(integer); Type: FUNCTION; Schema: sucursal1; Owner: sistema
--

CREATE FUNCTION spdgrupo(integer) RETURNS integer
    AS $_$
declare
  pclave alias for $1;
begin
  delete from grupo where grupoid=pclave;
return 1;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION sucursal1.spdgrupo(integer) OWNER TO sistema;

--
-- Name: spigrupo(character); Type: FUNCTION; Schema: sucursal1; Owner: sistema
--

CREATE FUNCTION spigrupo(character) RETURNS integer
    AS $_$
declare
  pgrupo      alias for $1;

 
begin

  insert into grupo(grupo)
    values(pgrupo );

        
return currval('grupo_grupoid_seq');

end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION sucursal1.spigrupo(character) OWNER TO sistema;

--
-- Name: spsgrupo(integer); Type: FUNCTION; Schema: sucursal1; Owner: sistema
--

CREATE FUNCTION spsgrupo(integer) RETURNS SETOF grupo
    AS $_$
declare
  r grupo%rowtype;
  pclave alias for $1;
begin

  if pclave<>0 then
    for r in
      select * from grupo where grupoid=pclave

    loop
      return next r;
    end loop;
  else
   for r in
   select * from grupo order by grupoid   
     loop
      return next r;
    end loop;
  end if;

return;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION sucursal1.spsgrupo(integer) OWNER TO sistema;

--
-- Name: spugrupo(integer, character); Type: FUNCTION; Schema: sucursal1; Owner: sistema
--

CREATE FUNCTION spugrupo(integer, character) RETURNS integer
    AS $_$
declare
  pgrupoid           alias for $1;
  pgrupo             alias for $2;

begin

   update grupo
      set grupo = pgrupo
    where grupoid = pgrupoid;

return pgrupoid;
end
$_$
    LANGUAGE plpgsql SECURITY DEFINER;


ALTER FUNCTION sucursal1.spugrupo(integer, character) OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: carteracobrador; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE carteracobrador (
    cobradorid integer,
    prestamoid integer
);


ALTER TABLE public.carteracobrador OWNER TO sistema;

--
-- Name: clasificacionsocio_clasificacionsocioid_seq; Type: SEQUENCE; Schema: public; Owner: sistema
--

CREATE SEQUENCE clasificacionsocio_clasificacionsocioid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.clasificacionsocio_clasificacionsocioid_seq OWNER TO sistema;

--
-- Name: clasificacionsocio_clasificacionsocioid_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sistema
--

ALTER SEQUENCE clasificacionsocio_clasificacionsocioid_seq OWNED BY clasificacionsocio.clasificacionsocioid;


--
-- Name: cobradores; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE cobradores (
    cobradorid integer NOT NULL,
    sujetoid integer
);


ALTER TABLE public.cobradores OWNER TO sistema;

--
-- Name: datosfiscales; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE datosfiscales (
    datofiscaid integer NOT NULL,
    socioid integer,
    rfc_con_homoclave character(15),
    clave_actividad character(10),
    descripcion_actividad character varying(100),
    clave_regimen_fiscal character(10),
    descripcion_regimen_fiscal character varying(3),
    fecha_alta date,
    observaciones text
);


ALTER TABLE public.datosfiscales OWNER TO sistema;

--
-- Name: datosfiscales_datofiscaid_seq; Type: SEQUENCE; Schema: public; Owner: sistema
--

CREATE SEQUENCE datosfiscales_datofiscaid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.datosfiscales_datofiscaid_seq OWNER TO sistema;

--
-- Name: datosfiscales_datofiscaid_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sistema
--

ALTER SEQUENCE datosfiscales_datofiscaid_seq OWNED BY datosfiscales.datofiscaid;


--
-- Name: modulostmp; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE modulostmp (
    clavemodulo character(10),
    descripcionmodulos character varying(80)
);


ALTER TABLE public.modulostmp OWNER TO sistema;

SET search_path = sucursal1, pg_catalog;

--
-- Name: movicaja; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE movicaja (
    movicajaid integer NOT NULL,
    socioid integer NOT NULL,
    tipomovimientoid character(2) NOT NULL,
    polizaid integer NOT NULL,
    referenciacaja integer NOT NULL,
    seriecaja character(2) NOT NULL,
    movipolizaid integer NOT NULL,
    prestamoid integer,
    estatusmovicaja character(1) NOT NULL,
    inversionid integer,
    saldoactual integer,
    efectivo integer,
    fechahora timestamp without time zone DEFAULT now(),
    contratoid integer
);


ALTER TABLE sucursal1.movicaja OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: movicajag; Type: VIEW; Schema: public; Owner: sistema
--

CREATE VIEW movicajag AS
    SELECT movicaja.socioid, movicaja.tipomovimientoid, movicaja.polizaid, movicaja.referenciacaja, movicaja.seriecaja FROM sucursal1.movicaja GROUP BY movicaja.socioid, movicaja.tipomovimientoid, movicaja.polizaid, movicaja.referenciacaja, movicaja.seriecaja;


ALTER TABLE public.movicajag OWNER TO sistema;

--
-- Name: pga_diagrams; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE pga_diagrams (
    diagramname character varying(64) NOT NULL,
    diagramtables text,
    diagramlinks text
);


ALTER TABLE public.pga_diagrams OWNER TO sistema;

--
-- Name: pga_forms; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE pga_forms (
    formname character varying(64) NOT NULL,
    formsource text
);


ALTER TABLE public.pga_forms OWNER TO sistema;

--
-- Name: pga_graphs; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE pga_graphs (
    graphname character varying(64) NOT NULL,
    graphsource text,
    graphcode text
);


ALTER TABLE public.pga_graphs OWNER TO sistema;

--
-- Name: pga_images; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE pga_images (
    imagename character varying(64) NOT NULL,
    imagesource text
);


ALTER TABLE public.pga_images OWNER TO sistema;

--
-- Name: pga_layout; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE pga_layout (
    tablename character varying(64) NOT NULL,
    nrcols smallint,
    colnames text,
    colwidth text
);


ALTER TABLE public.pga_layout OWNER TO sistema;

--
-- Name: pga_queries; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE pga_queries (
    queryname character varying(64) NOT NULL,
    querytype character(1),
    querycommand text,
    querytables text,
    querylinks text,
    queryresults text,
    querycomments text
);


ALTER TABLE public.pga_queries OWNER TO sistema;

--
-- Name: pga_reports; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE pga_reports (
    reportname character varying(64) NOT NULL,
    reportsource text,
    reportbody text,
    reportprocs text,
    reportoptions text
);


ALTER TABLE public.pga_reports OWNER TO sistema;

--
-- Name: pga_scripts; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE pga_scripts (
    scriptname character varying(64) NOT NULL,
    scriptsource text
);


ALTER TABLE public.pga_scripts OWNER TO sistema;

--
-- Name: reportes; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE reportes (
    reporteid integer NOT NULL,
    descripcion character(60),
    valor1 character(20),
    y1 integer,
    n1 integer,
    valor2 character(20),
    y2 integer,
    n2 integer,
    valor3 character(20),
    y3 integer,
    n3 integer,
    valor4 character(20),
    y4 integer,
    n4 integer,
    valor5 character(20),
    y5 integer,
    n5 integer,
    valor6 character(20),
    y6 integer,
    n6 integer,
    valor7 character(20),
    y7 integer,
    n7 integer,
    valor8 character(20),
    y8 integer,
    n8 integer,
    valor9 character(20),
    y9 integer,
    n9 integer,
    valor10 character(20),
    y10 integer,
    n10 integer,
    orden1 character(20),
    query text,
    t1 integer,
    t2 integer,
    t3 integer,
    t4 integer,
    t5 integer,
    t6 integer,
    t7 integer,
    t8 integer,
    t9 integer,
    t10 integer,
    largo numeric,
    ancho numeric,
    orientacion integer
);


ALTER TABLE public.reportes OWNER TO sistema;

--
-- Name: reportes_reporteid_seq; Type: SEQUENCE; Schema: public; Owner: sistema
--

CREATE SEQUENCE reportes_reporteid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.reportes_reporteid_seq OWNER TO sistema;

--
-- Name: reportes_reporteid_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sistema
--

ALTER SEQUENCE reportes_reporteid_seq OWNED BY reportes.reporteid;


--
-- Name: seqnopoliza; Type: SEQUENCE; Schema: public; Owner: sistema
--

CREATE SEQUENCE seqnopoliza
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.seqnopoliza OWNER TO sistema;

--
-- Name: seqreferencia; Type: SEQUENCE; Schema: public; Owner: sistema
--

CREATE SEQUENCE seqreferencia
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.seqreferencia OWNER TO sistema;

--
-- Name: sessions; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE sessions (
    id character(32) NOT NULL,
    a_session text
);


ALTER TABLE public.sessions OWNER TO sistema;

--
-- Name: socioeconomico; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE socioeconomico (
    socioeconomicoid integer NOT NULL,
    socioid integer,
    aguapotable smallint DEFAULT 0,
    electricidad smallint DEFAULT 0,
    telefono smallint DEFAULT 0,
    drenaje smallint DEFAULT 0,
    antena smallint DEFAULT 0,
    tipocasa character varying(15),
    hacinamiento character varying(12),
    nopersonas smallint DEFAULT 0,
    sala smallint DEFAULT 0,
    comedor smallint DEFAULT 0,
    cocina smallint DEFAULT 0,
    banio smallint DEFAULT 0,
    norecamaras smallint DEFAULT 0,
    tipocons character varying(20),
    tiposuelo character varying(30),
    tipotecho character varying(20),
    tele smallint DEFAULT 0,
    lavadora smallint DEFAULT 0,
    refri smallint DEFAULT 0,
    estereo smallint DEFAULT 0,
    estufa smallint DEFAULT 0,
    compu smallint DEFAULT 0,
    fecha date,
    hora time without time zone,
    obser character varying(50),
    descotrostc character varying(40),
    descotrosth character varying(40)
);


ALTER TABLE public.socioeconomico OWNER TO sistema;

--
-- Name: socioeconomico_socioeconomicoid_seq; Type: SEQUENCE; Schema: public; Owner: sistema
--

CREATE SEQUENCE socioeconomico_socioeconomicoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.socioeconomico_socioeconomicoid_seq OWNER TO sistema;

--
-- Name: socioeconomico_socioeconomicoid_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sistema
--

ALTER SEQUENCE socioeconomico_socioeconomicoid_seq OWNED BY socioeconomico.socioeconomicoid;


--
-- Name: tasastipoprestamo; Type: TABLE; Schema: public; Owner: sistema; Tablespace: 
--

CREATE TABLE tasastipoprestamo (
    tasatipoprestamoid integer NOT NULL,
    tipoprestamoid character(3) NOT NULL,
    reciprocidadinicial numeric,
    reciprocidadfinal numeric,
    tasanormal numeric,
    tasamoratoria numeric
);


ALTER TABLE public.tasastipoprestamo OWNER TO sistema;

--
-- Name: tasastipoprestamo_tasatipoprestamoid_seq; Type: SEQUENCE; Schema: public; Owner: sistema
--

CREATE SEQUENCE tasastipoprestamo_tasatipoprestamoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.tasastipoprestamo_tasatipoprestamoid_seq OWNER TO sistema;

--
-- Name: tasastipoprestamo_tasatipoprestamoid_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sistema
--

ALTER SEQUENCE tasastipoprestamo_tasatipoprestamoid_seq OWNED BY tasastipoprestamo.tasatipoprestamoid;


SET search_path = sucursal1, pg_catalog;

--
-- Name: activos_activoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE activos_activoid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.activos_activoid_seq OWNER TO sistema;

--
-- Name: activos_activoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE activos_activoid_seq OWNED BY activos.activoid;


--
-- Name: alertasprevencion; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE alertasprevencion (
    alertaid integer NOT NULL,
    socioid integer,
    movicajaid integer,
    clavesocioint character(15),
    tipomovimientoid character(2),
    monto numeric,
    moneda character(3),
    fecha_operacion date,
    fecha_deteccion date,
    observaciones text,
    administrar character(1)
);


ALTER TABLE sucursal1.alertasprevencion OWNER TO sistema;

--
-- Name: alertasprevencion_alertaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE alertasprevencion_alertaid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.alertasprevencion_alertaid_seq OWNER TO sistema;

--
-- Name: alertasprevencion_alertaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE alertasprevencion_alertaid_seq OWNED BY alertasprevencion.alertaid;


--
-- Name: amortizaciones_amortizacionid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE amortizaciones_amortizacionid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.amortizaciones_amortizacionid_seq OWNER TO sistema;

--
-- Name: amortizaciones_amortizacionid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE amortizaciones_amortizacionid_seq OWNED BY amortizaciones.amortizacionid;


--
-- Name: asesor_asesorid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE asesor_asesorid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.asesor_asesorid_seq OWNER TO sistema;

--
-- Name: asesor_asesorid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE asesor_asesorid_seq OWNED BY asesor.asesorid;


--
-- Name: autorizabonificacion; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE autorizabonificacion (
    autorizacionid integer NOT NULL,
    fecha date,
    serie character(2),
    inormal numeric,
    imoratorio numeric,
    cobranza numeric,
    seguro numeric,
    comision numeric,
    ahorro numeric,
    movicajaid integer DEFAULT 0,
    aplicado integer DEFAULT 0,
    usuarioid character(20)
);


ALTER TABLE sucursal1.autorizabonificacion OWNER TO sistema;

--
-- Name: autorizabonificacion_autorizacionid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE autorizabonificacion_autorizacionid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.autorizabonificacion_autorizacionid_seq OWNER TO sistema;

--
-- Name: autorizabonificacion_autorizacionid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE autorizabonificacion_autorizacionid_seq OWNED BY autorizabonificacion.autorizacionid;


--
-- Name: avales_avalid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE avales_avalid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.avales_avalid_seq OWNER TO sistema;

--
-- Name: avales_avalid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE avales_avalid_seq OWNED BY avales.avalid;


--
-- Name: aviso; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE aviso (
    avisoid integer NOT NULL,
    tipoavisoid integer NOT NULL,
    prestamoid integer NOT NULL,
    fechaenvio date NOT NULL,
    fechacontestacion date,
    diasatrasoprestamo integer NOT NULL,
    amortizacionesvencidas integer NOT NULL,
    capitalvencido numeric NOT NULL,
    interesvencido numeric NOT NULL,
    observacionaviso text,
    estatusaviso character(1)
);


ALTER TABLE sucursal1.aviso OWNER TO sistema;

--
-- Name: aviso_avisoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE aviso_avisoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.aviso_avisoid_seq OWNER TO sistema;

--
-- Name: aviso_avisoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE aviso_avisoid_seq OWNED BY aviso.avisoid;


--
-- Name: beneficiario_beneficiarioid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE beneficiario_beneficiarioid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.beneficiario_beneficiarioid_seq OWNER TO sistema;

--
-- Name: beneficiario_beneficiarioid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE beneficiario_beneficiarioid_seq OWNED BY beneficiario.beneficiarioid;


--
-- Name: bienes_bienid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE bienes_bienid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.bienes_bienid_seq OWNER TO sistema;

--
-- Name: bienes_bienid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE bienes_bienid_seq OWNED BY bienes.bienid;


--
-- Name: calculo_calculoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE calculo_calculoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.calculo_calculoid_seq OWNER TO sistema;

--
-- Name: calculo_calculoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE calculo_calculoid_seq OWNED BY calculo.calculoid;


--
-- Name: captaciontotal; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE captaciontotal (
    captaciontotalid integer NOT NULL,
    fechadegeneracion date,
    sucursal character(4),
    desctipoinversion character(30),
    clavesocioint character(18),
    nombresocio character varying(80),
    inversionid integer,
    fechainversion date,
    fechavencimiento date,
    tasainteresnormalinversion numeric,
    plazo integer,
    deposito numeric,
    diasvencimiento integer,
    formapagorendimiento integer,
    intdevmensual numeric,
    intdevacumulado numeric,
    saldototal numeric,
    saldopromedio numeric,
    fechapagoinversion date,
    tipomovimientoid character(2),
    cuentaid character(24),
    localidad integer,
    socioid integer,
    grupo character(25),
    diaspromedio integer,
    isr numeric,
    nocontrato integer
);


ALTER TABLE sucursal1.captaciontotal OWNER TO sistema;

--
-- Name: captaciontotal_captaciontotalid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE captaciontotal_captaciontotalid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.captaciontotal_captaciontotalid_seq OWNER TO sistema;

--
-- Name: captaciontotal_captaciontotalid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE captaciontotal_captaciontotalid_seq OWNED BY captaciontotal.captaciontotalid;


--
-- Name: cargoprestamo_cargoprestamoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE cargoprestamo_cargoprestamoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.cargoprestamo_cargoprestamoid_seq OWNER TO sistema;

--
-- Name: cargoprestamo_cargoprestamoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE cargoprestamo_cargoprestamoid_seq OWNED BY cargoprestamo.cargoprestamoid;


--
-- Name: carteracomunidadfecha_carteraid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE carteracomunidadfecha_carteraid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.carteracomunidadfecha_carteraid_seq OWNER TO sistema;

--
-- Name: carteracomunidadfecha_carteraid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE carteracomunidadfecha_carteraid_seq OWNED BY carteracomunidadfecha.carteraid;


--
-- Name: catalogominimo2; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE catalogominimo2 (
    catalogoid integer NOT NULL,
    cuentasiti character(24),
    c1 character varying,
    c2 character varying,
    c3 character varying,
    c4 character varying,
    nivel integer,
    cuentaid character(24)
);


ALTER TABLE sucursal1.catalogominimo2 OWNER TO sistema;

--
-- Name: catalogominimo2_catalogoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE catalogominimo2_catalogoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.catalogominimo2_catalogoid_seq OWNER TO sistema;

--
-- Name: catalogominimo2_catalogoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE catalogominimo2_catalogoid_seq OWNED BY catalogominimo2.catalogoid;


--
-- Name: cerrarabrircaja; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE cerrarabrircaja (
    cerrarabririd integer NOT NULL,
    usuarioid character(20),
    serie_user character(2),
    cuentacaja character(24),
    fechacierre date,
    fechaapertura date,
    saldoapertura numeric,
    saldoalcierre numeric,
    sobranteofaltante numeric,
    permitircierre integer,
    permitirapertura integer,
    permitirsupervisor integer
);


ALTER TABLE sucursal1.cerrarabrircaja OWNER TO sistema;

--
-- Name: cerrarabrircaja_cerrarabririd_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE cerrarabrircaja_cerrarabririd_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.cerrarabrircaja_cerrarabririd_seq OWNER TO sistema;

--
-- Name: cerrarabrircaja_cerrarabririd_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE cerrarabrircaja_cerrarabririd_seq OWNED BY cerrarabrircaja.cerrarabririd;


--
-- Name: ciudadesmex_ciudadmexid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE ciudadesmex_ciudadmexid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.ciudadesmex_ciudadmexid_seq OWNER TO sistema;

--
-- Name: ciudadesmex_ciudadmexid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE ciudadesmex_ciudadmexid_seq OWNED BY ciudadesmex.ciudadmexid;


--
-- Name: claseeconomico; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE claseeconomico (
    claseeconomicoid integer,
    descripcion character(60),
    ramaeconomicoid integer
);


ALTER TABLE sucursal1.claseeconomico OWNER TO sistema;

--
-- Name: clasificacioncredito_clasificacioncreditoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE clasificacioncredito_clasificacioncreditoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.clasificacioncredito_clasificacioncreditoid_seq OWNER TO sistema;

--
-- Name: clasificacioncredito_clasificacioncreditoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE clasificacioncredito_clasificacioncreditoid_seq OWNED BY clasificacioncredito.clasificacioncreditoid;


--
-- Name: cnbvlavado; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE cnbvlavado (
    cnbvlavadoid character(10),
    sucid character(4),
    organo_supervisor character(6),
    clave_del_sujeto_obligado character(6),
    localidad character(8),
    clavesucursal character(8),
    nombresucursal character(50),
    entidad_rfc character(13),
    entidad_curp character(20)
);


ALTER TABLE sucursal1.cnbvlavado OWNER TO sistema;

--
-- Name: cobrador; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE cobrador (
    cobradorid integer NOT NULL,
    sujetoid integer,
    descripcion character(50),
    comision1 numeric,
    comision2 numeric
);


ALTER TABLE sucursal1.cobrador OWNER TO sistema;

--
-- Name: cobrador_cobradorid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE cobrador_cobradorid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.cobrador_cobradorid_seq OWNER TO sistema;

--
-- Name: cobrador_cobradorid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE cobrador_cobradorid_seq OWNED BY cobrador.cobradorid;


--
-- Name: colonia_coloniaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE colonia_coloniaid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.colonia_coloniaid_seq OWNER TO sistema;

--
-- Name: colonia_coloniaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE colonia_coloniaid_seq OWNED BY colonia.coloniaid;


--
-- Name: comunidadconapo; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE comunidadconapo (
    claveconapo character(10),
    claveestado character(4),
    clavemunicipio character(4),
    clavelocalidad character(5),
    nombremun character varying(100),
    nombre character varying(100),
    poblacion integer,
    marginacion character(15)
);


ALTER TABLE sucursal1.comunidadconapo OWNER TO sistema;

--
-- Name: conoceatucliente; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE conoceatucliente (
    conoceatuclienteid integer NOT NULL,
    sujetoid integer,
    socioid integer,
    nodoctoidentificacion character(15),
    descomprobantedomicilio character(50),
    correoelectronico character varying(50),
    comunidadconapo character(10),
    empresatrabaja character(100),
    nombrejefe character(50),
    puestoenempresa character(50),
    domicilioempresaid integer,
    fechaingresotrabajo date,
    salariomensual numeric,
    otrosingresos numeric,
    ingresosfamiliares numeric,
    egresosmensuales numeric,
    egresosfamiliares numeric,
    ahorromensual numeric,
    valormuebles numeric,
    descripcionmuebles text,
    valorinmuebles numeric,
    descripcioninmuebles text,
    dependienteseconomicos integer,
    deppromedio numeric,
    retpromedio numeric,
    pagpromedio numeric,
    politicamenteexpuesto character(1),
    tieneantecedentes character(1),
    actividad character(100),
    poblacionindigena character(2),
    subclaseeconomicoid integer,
    tipoderiesgoid integer,
    ultimafecactexpediente date,
    referenciaubicacion text,
    ocupacionconyuge character(40),
    empresadondetrabajaconyuge character(80),
    antiguedadtrabajoconyuge character(40),
    domiciliotrabajoconyuge text,
    telfaxtrabajoconyuge character(60),
    fconstitucion date,
    numacta character(40),
    actualizacionacta date,
    numactaultima character(40),
    giro text,
    estatus character varying(20) DEFAULT 'Socio'::character varying,
    descidentificacion character varying(35) DEFAULT ''::character varying
);


ALTER TABLE sucursal1.conoceatucliente OWNER TO sistema;

--
-- Name: conoceatucliente_conoceatuclienteid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE conoceatucliente_conoceatuclienteid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.conoceatucliente_conoceatuclienteid_seq OWNER TO sistema;

--
-- Name: conoceatucliente_conoceatuclienteid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE conoceatucliente_conoceatuclienteid_seq OWNED BY conoceatucliente.conoceatuclienteid;


--
-- Name: consolida; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE consolida (
    sucursalid integer NOT NULL,
    host character(40),
    basedatos character(20),
    esquema character(20) NOT NULL,
    usuariodb character(20),
    passworddb character(20),
    vigente character(1) DEFAULT 'S'::bpchar
);


ALTER TABLE sucursal1.consolida OWNER TO sistema;

--
-- Name: consolida_sucursalid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE consolida_sucursalid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.consolida_sucursalid_seq OWNER TO sistema;

--
-- Name: consolida_sucursalid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE consolida_sucursalid_seq OWNED BY consolida.sucursalid;


--
-- Name: convenio_convenioid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE convenio_convenioid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.convenio_convenioid_seq OWNER TO sistema;

--
-- Name: convenio_convenioid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE convenio_convenioid_seq OWNED BY convenio.convenioid;


--
-- Name: datosfiscales; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE datosfiscales (
    datofiscalid integer NOT NULL,
    socioid integer,
    rfc_con_homoclave character(15),
    clave_actividad character(10),
    descripcion_actividad character varying(100),
    clave_regimen_fiscal character(10),
    descripcion_regimen_fiscal character varying(100),
    fecha_alta date,
    observaciones text
);


ALTER TABLE sucursal1.datosfiscales OWNER TO sistema;

--
-- Name: datosfiscales_datofiscalid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE datosfiscales_datofiscalid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.datosfiscales_datofiscalid_seq OWNER TO sistema;

--
-- Name: datosfiscales_datofiscalid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE datosfiscales_datofiscalid_seq OWNED BY datosfiscales.datofiscalid;


--
-- Name: denominacion; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE denominacion (
    denominacionid integer NOT NULL,
    descripciondenominacion character(10) NOT NULL,
    valor numeric NOT NULL,
    efectivo integer NOT NULL
);


ALTER TABLE sucursal1.denominacion OWNER TO sistema;

--
-- Name: denominacion_denominacionid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE denominacion_denominacionid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.denominacion_denominacionid_seq OWNER TO sistema;

--
-- Name: denominacion_denominacionid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE denominacion_denominacionid_seq OWNED BY denominacion.denominacionid;


--
-- Name: depreciacion_depreciacionid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE depreciacion_depreciacionid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.depreciacion_depreciacionid_seq OWNER TO sistema;

--
-- Name: depreciacion_depreciacionid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE depreciacion_depreciacionid_seq OWNED BY depreciacion.depreciacionid;


--
-- Name: domicilio_domicilioid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE domicilio_domicilioid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.domicilio_domicilioid_seq OWNER TO sistema;

--
-- Name: domicilio_domicilioid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE domicilio_domicilioid_seq OWNED BY domicilio.domicilioid;


--
-- Name: empresa; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE empresa (
    empresaid integer NOT NULL,
    domicilioid integer,
    cuentaid character(24),
    nombrecaja character varying(80),
    rfccaja character varying(20),
    sucid character(4) NOT NULL,
    historial text,
    interesminimo numeric DEFAULT 7 NOT NULL,
    formatocuenta character(24),
    aplicareciprocidad character(1),
    gerente character(80),
    presidenteadmon character(80),
    contador character(80),
    direccioncaja character(100),
    contadorsucursal character(80),
    niveloperaciones character(80),
    lineasiniciales integer,
    iniciadevengamiento date,
    generasocio character(1),
    calculaisrinversion integer,
    inversionexenta numeric,
    porcentajeisrinversion numeric,
    ccpresidente character(50),
    ccvicepresidente character(50),
    ccoficial character(50),
    ccanalista character(50),
    ccsecretario character(50),
    bonificaenpagopuntual integer,
    porcentajebonifica numeric,
    preguntaperiodo integer,
    sabana integer,
    iva numeric,
    reciboconquery integer,
    altasucursales integer,
    cobrardiainicial integer,
    diasanualesprestamo integer,
    diasanualesinversion integer,
    diasanualesmov integer,
    devengamoratorio character(1),
    tomaintervalo character(1),
    impresoracaja character(50),
    impresorareporte character(50),
    reporteslaser integer,
    ciudadcaja character(50),
    solodiaspactados character(1),
    fechacobroiva date,
    ordenaval integer,
    lineasfinales integer,
    foliocertificado integer,
    nombresucursal character(50),
    version character(20),
    montopartesocial numeric,
    partesocialcompleta integer,
    "password" character(20),
    retirareciprocidad integer,
    nivel integer,
    noavalesxprestamo integer,
    avisoxamortiza integer,
    modificarinversion integer,
    clavefederacion character(10),
    claveentidad character(6),
    formatopoliza integer,
    ciudadmexid integer,
    nivelciti character(6),
    entidadciti character(6),
    textorecibo text,
    moratoriopormonto integer,
    diasmoratoriopormonto integer,
    vigenciapasswd integer,
    foliopdf integer,
    retirainteresinversion integer,
    ideexento numeric,
    poride numeric,
    modificatasas integer,
    interesamortiza integer,
    comisionacreditos integer,
    porcentajecomision numeric,
    nconcurrencias integer,
    iniciadevengainversion date,
    diaspagoinversion integer,
    periodopagoinversion integer,
    abonointeres integer,
    manejochequegrupal integer,
    manejopagoamortizacion integer,
    usomultisucursal integer,
    vicepresidenteadmon character varying(80),
    secreadmon character varying(80),
    prosecreadmon character varying(80),
    vocaladmon character varying(80),
    presidentevigilancia character varying(80),
    secrevigilancia character varying(80),
    vocalvigilancia character varying(80),
    manejopagoseguro integer,
    manejoplazoinversion integer,
    manejocargosprestamo integer,
    cortecajaagrupado integer
);


ALTER TABLE sucursal1.empresa OWNER TO sistema;

--
-- Name: empresa_empresaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE empresa_empresaid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.empresa_empresaid_seq OWNER TO sistema;

--
-- Name: empresa_empresaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE empresa_empresaid_seq OWNED BY empresa.empresaid;


--
-- Name: estadosmex_estadomexid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE estadosmex_estadomexid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.estadosmex_estadomexid_seq OWNER TO sistema;

--
-- Name: estadosmex_estadomexid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE estadosmex_estadomexid_seq OWNED BY estadosmex.estadomexid;


--
-- Name: eventoscobranza; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE eventoscobranza (
    cobradorid integer NOT NULL,
    prestamoid integer,
    descripcion text,
    fechaevento date,
    resultado text
);


ALTER TABLE sucursal1.eventoscobranza OWNER TO sistema;

--
-- Name: eventoscobranza_cobradorid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE eventoscobranza_cobradorid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.eventoscobranza_cobradorid_seq OWNER TO sistema;

--
-- Name: eventoscobranza_cobradorid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE eventoscobranza_cobradorid_seq OWNED BY eventoscobranza.cobradorid;


--
-- Name: firma; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE firma (
    solicitudingresoid integer,
    foto oid
);


ALTER TABLE sucursal1.firma OWNER TO sistema;

--
-- Name: foto; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE foto (
    solicitudingresoid integer,
    foto oid
);


ALTER TABLE sucursal1.foto OWNER TO sistema;

--
-- Name: garantia; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE garantia (
    garantiaid integer NOT NULL,
    solicitudprestamoid integer,
    prestamoid integer,
    inversionid integer,
    nohip character varying(30),
    folio character varying(30),
    fecharegistro date,
    fechavencimiento date,
    descripcion text
);


ALTER TABLE sucursal1.garantia OWNER TO sistema;

--
-- Name: garantia_garantiaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE garantia_garantiaid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.garantia_garantiaid_seq OWNER TO sistema;

--
-- Name: garantia_garantiaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE garantia_garantiaid_seq OWNED BY garantia.garantiaid;


--
-- Name: garantias; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE garantias (
    garantiaid integer NOT NULL,
    solicitudprestamoid integer,
    prestamoid integer,
    inversionid integer,
    montogarantiahaber numeric,
    tipodemuebleid character(5),
    marca character(20),
    modelo character(10),
    tiempodeuso character(15),
    descripcionmueble text,
    valorcomercialmueble numeric,
    montogarantiamueble numeric,
    tipodeinmuebleid character(5),
    propietario character varying(60),
    descripcionubicacion text,
    escriturapublica character varying(60),
    registropubpropiedad character varying(40),
    descripciondegravamen text,
    medidasycolindancias text,
    datosdehipoteca text,
    valorfiscal numeric,
    valorcatastral numeric,
    valorcomercialinmueble numeric,
    montogarantiainmueble numeric
);


ALTER TABLE sucursal1.garantias OWNER TO sistema;

--
-- Name: garantias_garantiaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE garantias_garantiaid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.garantias_garantiaid_seq OWNER TO sistema;

--
-- Name: garantias_garantiaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE garantias_garantiaid_seq OWNED BY garantias.garantiaid;


--
-- Name: grupo_grupoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE grupo_grupoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.grupo_grupoid_seq OWNER TO sistema;

--
-- Name: grupo_grupoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE grupo_grupoid_seq OWNED BY grupo.grupoid;


--
-- Name: hoja; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE hoja (
    solicitudprestamoid integer,
    archivo oid
);


ALTER TABLE sucursal1.hoja OWNER TO sistema;

--
-- Name: inabil; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE inabil (
    fecha date
);


ALTER TABLE sucursal1.inabil OWNER TO sistema;

--
-- Name: indicador; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE indicador (
    indicadorid integer NOT NULL,
    descripcion character(20) NOT NULL,
    fechainicial date NOT NULL,
    fechafinal date NOT NULL,
    valor numeric NOT NULL,
    porcentajeaplicado numeric
);


ALTER TABLE sucursal1.indicador OWNER TO sistema;

--
-- Name: indicador_indicadorid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE indicador_indicadorid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.indicador_indicadorid_seq OWNER TO sistema;

--
-- Name: indicador_indicadorid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE indicador_indicadorid_seq OWNED BY indicador.indicadorid;


--
-- Name: inpc_ano_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE inpc_ano_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.inpc_ano_seq OWNER TO sistema;

--
-- Name: inpc_ano_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE inpc_ano_seq OWNED BY inpc.ano;


--
-- Name: invenvalor; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE invenvalor (
    invenvalor integer NOT NULL,
    institucion character(50),
    tipoenvalorid integer,
    fechacontrato date,
    fechavencimiento date,
    monto numeric,
    rendimiento numeric,
    isr numeric,
    estatus character(1),
    tipoinversion integer
);


ALTER TABLE sucursal1.invenvalor OWNER TO sistema;

--
-- Name: invenvalor_invenvalor_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE invenvalor_invenvalor_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.invenvalor_invenvalor_seq OWNER TO sistema;

--
-- Name: invenvalor_invenvalor_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE invenvalor_invenvalor_seq OWNED BY invenvalor.invenvalor;


--
-- Name: inversion_inversionid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE inversion_inversionid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.inversion_inversionid_seq OWNER TO sistema;

--
-- Name: inversion_inversionid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE inversion_inversionid_seq OWNED BY inversion.inversionid;


--
-- Name: logpoliza; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE logpoliza (
    fecha timestamp without time zone NOT NULL,
    polizaid integer NOT NULL,
    usuarioid character(20) NOT NULL,
    movimiento character(1) NOT NULL
);


ALTER TABLE sucursal1.logpoliza OWNER TO sistema;

--
-- Name: ministrar; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE ministrar (
    ministrarid integer NOT NULL,
    tipomovimientoid character(2),
    fechaministracion date,
    monto numeric,
    prestamoid integer,
    polizaid integer,
    movibancoid integer,
    referenciacaja integer,
    seriecaja character(2)
);


ALTER TABLE sucursal1.ministrar OWNER TO sistema;

--
-- Name: ministrar_ministrarid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE ministrar_ministrarid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.ministrar_ministrarid_seq OWNER TO sistema;

--
-- Name: ministrar_ministrarid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE ministrar_ministrarid_seq OWNED BY ministrar.ministrarid;


--
-- Name: motivobaja_motivobajaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE motivobaja_motivobajaid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.motivobaja_motivobajaid_seq OWNER TO sistema;

--
-- Name: motivobaja_motivobajaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE motivobaja_motivobajaid_seq OWNED BY motivobaja.motivobajaid;


--
-- Name: movibanco_movibancoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE movibanco_movibancoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.movibanco_movibancoid_seq OWNER TO sistema;

--
-- Name: movibanco_movibancoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE movibanco_movibancoid_seq OWNED BY movibanco.movibancoid;


--
-- Name: movicaja_movicajaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE movicaja_movicajaid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.movicaja_movicajaid_seq OWNER TO sistema;

--
-- Name: movicaja_movicajaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE movicaja_movicajaid_seq OWNED BY movicaja.movicajaid;


--
-- Name: movicajag; Type: VIEW; Schema: sucursal1; Owner: sistema
--

CREATE VIEW movicajag AS
    SELECT movicaja.socioid, movicaja.tipomovimientoid, movicaja.polizaid, movicaja.referenciacaja, movicaja.seriecaja FROM movicaja GROUP BY movicaja.socioid, movicaja.tipomovimientoid, movicaja.polizaid, movicaja.referenciacaja, movicaja.seriecaja;


ALTER TABLE sucursal1.movicajag OWNER TO sistema;

--
-- Name: movipolizas_movipolizaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE movipolizas_movipolizaid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.movipolizas_movipolizaid_seq OWNER TO sistema;

--
-- Name: movipolizas_movipolizaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE movipolizas_movipolizaid_seq OWNED BY movipolizas.movipolizaid;


--
-- Name: nivelderiesgo; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE nivelderiesgo (
    nivelriesgoid integer NOT NULL,
    descripcion character(30),
    nivel integer
);


ALTER TABLE sucursal1.nivelderiesgo OWNER TO sistema;

--
-- Name: nivelderiesgo_nivelriesgoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE nivelderiesgo_nivelriesgoid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.nivelderiesgo_nivelriesgoid_seq OWNER TO sistema;

--
-- Name: nivelderiesgo_nivelriesgoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE nivelderiesgo_nivelriesgoid_seq OWNED BY nivelderiesgo.nivelriesgoid;


--
-- Name: ocupacion_ocupacionid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE ocupacion_ocupacionid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.ocupacion_ocupacionid_seq OWNER TO sistema;

--
-- Name: ocupacion_ocupacionid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE ocupacion_ocupacionid_seq OWNED BY ocupacion.ocupacionid;


--
-- Name: operacionlavado; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE operacionlavado (
    operacionlavadoid integer NOT NULL,
    fechainicial date,
    fechafinal date,
    tipooperacioninicial character(1),
    tipo_de_reporte character(1),
    periodo_del_reporte character(8),
    folio integer,
    organo_supervisor character(6),
    clave_del_sujeto_obligado character(6),
    localidad character(8),
    sucursal character(8),
    tipo_de_operacion character(2),
    instrumento_monetario character(2),
    numero_de_cuenta character(16),
    monto numeric,
    moneda character(3),
    fecha_de_la_operacion character(8),
    fecha_de_deteccion character(8),
    nacionalidad character(1),
    tipodepersona character(1),
    razonsocial character(60),
    nombre character(40),
    apellido_paterno character(40),
    apellido_materno character(40),
    rfc character(13),
    curp character(20),
    fnacimientoconstitucion character(8),
    domicilio character(60),
    colonia character(30),
    ciudadopoblacion character(8),
    telefono character(40),
    actividadeconomica character(7),
    agenteseg_nombre character(60),
    agenteseg_paterno character(60),
    agenteseg_materno character(60),
    entidad_rfc character(13),
    entidad_curp character(20),
    cta_persona_relacionada integer,
    numero_per_relacionada character(16),
    clavedelsujetoobligado character(6),
    personarel_nombre character(30),
    personarel_paterno character(30),
    personarel_materno character(30),
    descripcion_operacion text,
    razones_inusual_preopupante text,
    reportarautoridad character(1),
    movicajaid integer
);


ALTER TABLE sucursal1.operacionlavado OWNER TO sistema;

--
-- Name: operacionlavado_operacionlavadoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE operacionlavado_operacionlavadoid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.operacionlavado_operacionlavadoid_seq OWNER TO sistema;

--
-- Name: operacionlavado_operacionlavadoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE operacionlavado_operacionlavadoid_seq OWNED BY operacionlavado.operacionlavadoid;


--
-- Name: parametros_parametroid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE parametros_parametroid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.parametros_parametroid_seq OWNER TO sistema;

--
-- Name: parametros_parametroid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE parametros_parametroid_seq OWNED BY parametros.parametroid;


--
-- Name: periodo; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE periodo (
    periodoid integer NOT NULL,
    ejercicio integer NOT NULL,
    periodo integer,
    estatus character(1)
);


ALTER TABLE sucursal1.periodo OWNER TO sistema;

--
-- Name: periodo_periodoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE periodo_periodoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.periodo_periodoid_seq OWNER TO sistema;

--
-- Name: periodo_periodoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE periodo_periodoid_seq OWNED BY periodo.periodoid;


--
-- Name: permisosmodulos; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE permisosmodulos (
    permisomoduloid integer NOT NULL,
    clavemodulo character(10) NOT NULL,
    usuarioid character(20) NOT NULL,
    permiso character(1)
);


ALTER TABLE sucursal1.permisosmodulos OWNER TO sistema;

--
-- Name: permisosmodulos_permisomoduloid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE permisosmodulos_permisomoduloid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.permisosmodulos_permisomoduloid_seq OWNER TO sistema;

--
-- Name: permisosmodulos_permisomoduloid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE permisosmodulos_permisomoduloid_seq OWNED BY permisosmodulos.permisomoduloid;


--
-- Name: polizas_polizaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE polizas_polizaid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.polizas_polizaid_seq OWNER TO sistema;

--
-- Name: polizas_polizaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE polizas_polizaid_seq OWNED BY polizas.polizaid;


--
-- Name: precorte; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE precorte (
    precorteid integer NOT NULL,
    tablareservaid integer,
    prestamoid integer NOT NULL,
    ejercicio integer,
    periodo integer,
    fechacierre date,
    diasvencidos integer DEFAULT 0,
    porcentajeaplicado numeric DEFAULT 0,
    factoraplicado numeric DEFAULT 0,
    saldoprestamo numeric DEFAULT 0,
    reservacalculada numeric DEFAULT 0,
    interesdevengadomenoravencido numeric DEFAULT 0,
    interesdevengadomayoravencido numeric DEFAULT 0,
    pagocapitalenperiodo numeric DEFAULT 0,
    pagointeresenperiodo numeric DEFAULT 0,
    pagomoratorioenperiodo numeric DEFAULT 0,
    bonificacionintenperiodo numeric DEFAULT 0,
    bonificacionmorenperiodo numeric DEFAULT 0,
    noamorvencidas integer DEFAULT 0,
    saldovencidomenoravencido numeric DEFAULT 0,
    saldovencidomayoravencido numeric DEFAULT 0,
    fechaultamorpagada date,
    tipoprestamoid character(3),
    montoprestamo numeric,
    clavefinalidad character(3),
    tasanormal numeric,
    tasa_moratoria numeric,
    ultimoabono date,
    diastraspasoavencida integer,
    fecha_vencimiento date,
    ultimoabonointeres date,
    interesdevmormenor numeric,
    interesdevmormayor numeric,
    saldopromedio numeric,
    dias_de_cobro integer,
    meses_de_cobro integer,
    depositogarantia numeric,
    pagosvencidos integer,
    finalidaddefault character(3),
    saldopromediodelmes numeric,
    interesdevengadomes numeric,
    primerincumplimiento date,
    diasinteres integer,
    diascapital integer,
    reservaidnc numeric,
    frecuencia integer,
    fecha_otorga date,
    estatusvive integer,
    zonamarginada character(2),
    importeultimaamort numeric,
    importevencidoamort numeric
);


ALTER TABLE sucursal1.precorte OWNER TO sistema;

--
-- Name: precorte_precorteid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE precorte_precorteid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.precorte_precorteid_seq OWNER TO sistema;

--
-- Name: precorte_precorteid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE precorte_precorteid_seq OWNED BY precorte.precorteid;


--
-- Name: premovipolizas; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE premovipolizas (
    premovipolizaid integer NOT NULL,
    prepolizaid integer NOT NULL,
    cuentaid character(24) NOT NULL,
    referencia_mov character(8),
    tipo_mov character(1) NOT NULL,
    debe numeric NOT NULL,
    haber numeric NOT NULL,
    diario_mov character(3),
    identific_descr character(1),
    descripcion character varying(29)
);


ALTER TABLE sucursal1.premovipolizas OWNER TO sistema;

--
-- Name: premovipolizas_premovipolizaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE premovipolizas_premovipolizaid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.premovipolizas_premovipolizaid_seq OWNER TO sistema;

--
-- Name: premovipolizas_premovipolizaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE premovipolizas_premovipolizaid_seq OWNED BY premovipolizas.premovipolizaid;


--
-- Name: prepolizas; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE prepolizas (
    prepolizaid integer NOT NULL,
    referencia integer NOT NULL,
    seriepoliza character(2) NOT NULL,
    tipo character(1) NOT NULL,
    numero_poliza integer NOT NULL,
    ejercicio integer NOT NULL,
    periodo integer NOT NULL,
    fechapoliza date,
    tipo_poliza character(1) NOT NULL,
    clase_poliza character(1),
    diario_agrupador character(3),
    concepto_poliza character varying(255),
    fecha_fin_aceptacion date
);


ALTER TABLE sucursal1.prepolizas OWNER TO sistema;

--
-- Name: prepolizas_prepolizaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE prepolizas_prepolizaid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.prepolizas_prepolizaid_seq OWNER TO sistema;

--
-- Name: prepolizas_prepolizaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE prepolizas_prepolizaid_seq OWNED BY prepolizas.prepolizaid;


--
-- Name: prestamobancario; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE prestamobancario (
    prestamobancarioid integer NOT NULL,
    fondeador character(40),
    banco character(40),
    fechapagare date,
    fechavencimiento date,
    montooriginal numeric,
    saldoinsoluto numeric,
    saldoinsolutoredescontado numeric,
    tasa character(10),
    conredescuento character(2),
    garantiaefectiva numeric,
    estatus character(1)
);


ALTER TABLE sucursal1.prestamobancario OWNER TO sistema;

--
-- Name: prestamobancario_prestamobancarioid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE prestamobancario_prestamobancarioid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.prestamobancario_prestamobancarioid_seq OWNER TO sistema;

--
-- Name: prestamobancario_prestamobancarioid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE prestamobancario_prestamobancarioid_seq OWNED BY prestamobancario.prestamobancarioid;


--
-- Name: prestamos_prestamoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE prestamos_prestamoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.prestamos_prestamoid_seq OWNER TO sistema;

--
-- Name: prestamos_prestamoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE prestamos_prestamoid_seq OWNED BY prestamos.prestamoid;


--
-- Name: procampo_procampoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE procampo_procampoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.procampo_procampoid_seq OWNER TO sistema;

--
-- Name: procampo_procampoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE procampo_procampoid_seq OWNED BY procampo.procampoid;


--
-- Name: promocion_promocionid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE promocion_promocionid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.promocion_promocionid_seq OWNER TO sistema;

--
-- Name: promocion_promocionid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE promocion_promocionid_seq OWNED BY promocion.promocionid;


--
-- Name: promotor; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE promotor (
    promotorid integer NOT NULL,
    sujetoid integer,
    descripcion character(50),
    comision1 numeric,
    comision2 numeric
);


ALTER TABLE sucursal1.promotor OWNER TO sistema;

--
-- Name: promotor_promotorid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE promotor_promotorid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.promotor_promotorid_seq OWNER TO sistema;

--
-- Name: promotor_promotorid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE promotor_promotorid_seq OWNED BY promotor.promotorid;


--
-- Name: ramaeconomico; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE ramaeconomico (
    ramaeconomicoid integer,
    descripcion character(60),
    subsectoreconomicoid integer
);


ALTER TABLE sucursal1.ramaeconomico OWNER TO sistema;

--
-- Name: rango_rangoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE rango_rangoid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.rango_rangoid_seq OWNER TO sistema;

--
-- Name: rango_rangoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE rango_rangoid_seq OWNED BY rango.rangoid;


--
-- Name: reciprocidad; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE reciprocidad (
    reciprocidadid integer NOT NULL,
    tasa1 numeric NOT NULL,
    tasa2 numeric NOT NULL,
    tasa3 numeric NOT NULL,
    tasa4 numeric NOT NULL,
    tasa5 numeric NOT NULL,
    tasa6 numeric NOT NULL,
    fechainicial date NOT NULL,
    fechafinal date NOT NULL
);


ALTER TABLE sucursal1.reciprocidad OWNER TO sistema;

--
-- Name: reciprocidad_reciprocidadid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE reciprocidad_reciprocidadid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.reciprocidad_reciprocidadid_seq OWNER TO sistema;

--
-- Name: reciprocidad_reciprocidadid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE reciprocidad_reciprocidadid_seq OWNED BY reciprocidad.reciprocidadid;


--
-- Name: relacion_relacionid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE relacion_relacionid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.relacion_relacionid_seq OWNER TO sistema;

--
-- Name: relacion_relacionid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE relacion_relacionid_seq OWNED BY relacion.relacionid;


--
-- Name: sabana; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE sabana (
    sabanaid integer NOT NULL,
    denominacionid integer NOT NULL,
    socioid integer NOT NULL,
    seriecaja character(2) NOT NULL,
    referenciacaja integer NOT NULL,
    fecha date NOT NULL,
    valor numeric NOT NULL,
    cantidad integer NOT NULL,
    entradasalida integer NOT NULL,
    numcheque character varying(10),
    banco text,
    nocta character varying(20)
);


ALTER TABLE sucursal1.sabana OWNER TO sistema;

--
-- Name: sabana_sabanaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE sabana_sabanaid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.sabana_sabanaid_seq OWNER TO sistema;

--
-- Name: sabana_sabanaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE sabana_sabanaid_seq OWNED BY sabana.sabanaid;


--
-- Name: saldos_saldoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE saldos_saldoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.saldos_saldoid_seq OWNER TO sistema;

--
-- Name: saldos_saldoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE saldos_saldoid_seq OWNED BY saldos.saldoid;


--
-- Name: saldosc; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE saldosc (
    saldocid integer NOT NULL,
    cuentaid character(24) NOT NULL,
    ejercicio integer NOT NULL,
    periodo integer NOT NULL,
    saldoinicialperiodo numeric NOT NULL,
    cargosdelperiodo numeric NOT NULL,
    abonosdelperiodo numeric NOT NULL
);


ALTER TABLE sucursal1.saldosc OWNER TO sistema;

--
-- Name: saldosc_saldocid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE saldosc_saldocid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.saldosc_saldocid_seq OWNER TO sistema;

--
-- Name: saldosc_saldocid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE saldosc_saldocid_seq OWNED BY saldosc.saldocid;


--
-- Name: scoring_scoringid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE scoring_scoringid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.scoring_scoringid_seq OWNER TO sistema;

--
-- Name: scoring_scoringid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE scoring_scoringid_seq OWNED BY scoring.scoringid;


--
-- Name: sectoreconomico; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE sectoreconomico (
    sectoreconomicoid integer,
    descripcion character(50)
);


ALTER TABLE sucursal1.sectoreconomico OWNER TO sistema;

--
-- Name: socio_socioid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE socio_socioid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.socio_socioid_seq OWNER TO sistema;

--
-- Name: socio_socioid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE socio_socioid_seq OWNED BY socio.socioid;


--
-- Name: solicitudingreso_solicitudingresoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE solicitudingreso_solicitudingresoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.solicitudingreso_solicitudingresoid_seq OWNER TO sistema;

--
-- Name: solicitudingreso_solicitudingresoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE solicitudingreso_solicitudingresoid_seq OWNED BY solicitudingreso.solicitudingresoid;


--
-- Name: solicitudprestamo_solicitudprestamoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE solicitudprestamo_solicitudprestamoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.solicitudprestamo_solicitudprestamoid_seq OWNER TO sistema;

--
-- Name: solicitudprestamo_solicitudprestamoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE solicitudprestamo_solicitudprestamoid_seq OWNED BY solicitudprestamo.solicitudprestamoid;


--
-- Name: subclaseeconomico; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE subclaseeconomico (
    subclaseeconomicoid integer,
    descripcion character(60),
    claseeconomicoid integer
);


ALTER TABLE sucursal1.subclaseeconomico OWNER TO sistema;

--
-- Name: subrango_subrangoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE subrango_subrangoid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.subrango_subrangoid_seq OWNER TO sistema;

--
-- Name: subrango_subrangoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE subrango_subrangoid_seq OWNED BY subrango.subrangoid;


--
-- Name: subsectoreconomico; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE subsectoreconomico (
    subsectoreconomicoid integer,
    descripcion character(60),
    sectoreconomicoid integer
);


ALTER TABLE sucursal1.subsectoreconomico OWNER TO sistema;

--
-- Name: sucursales_sucursalid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE sucursales_sucursalid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.sucursales_sucursalid_seq OWNER TO sistema;

--
-- Name: sucursales_sucursalid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE sucursales_sucursalid_seq OWNED BY sucursales.sucursalid;


--
-- Name: sujeto_sujetoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE sujeto_sujetoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.sujeto_sujetoid_seq OWNER TO sistema;

--
-- Name: sujeto_sujetoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE sujeto_sujetoid_seq OWNED BY sujeto.sujetoid;


--
-- Name: tablareserva; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tablareserva (
    tablareservaid integer NOT NULL,
    descripcion character varying(60) NOT NULL,
    diainicial integer NOT NULL,
    diafinal integer NOT NULL,
    porcentajereserva numeric DEFAULT 0 NOT NULL,
    factordisminucion numeric DEFAULT 0 NOT NULL,
    finalidaddefault character(3)
);


ALTER TABLE sucursal1.tablareserva OWNER TO sistema;

--
-- Name: tablareserva_tablareservaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE tablareserva_tablareservaid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.tablareserva_tablareservaid_seq OWNER TO sistema;

--
-- Name: tablareserva_tablareservaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE tablareserva_tablareservaid_seq OWNED BY tablareserva.tablareservaid;


--
-- Name: tablon_tablonid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE tablon_tablonid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.tablon_tablonid_seq OWNER TO sistema;

--
-- Name: tablon_tablonid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE tablon_tablonid_seq OWNED BY tablon.tablonid;


--
-- Name: tasa; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tasa (
    tasaid integer NOT NULL,
    tipoprestamoid character(3),
    tipoinversionid character(3),
    tipomovimientoid character(2),
    fechainicial date NOT NULL,
    fechafinal date NOT NULL,
    tasanormal numeric NOT NULL,
    tasamoratorio numeric NOT NULL
);


ALTER TABLE sucursal1.tasa OWNER TO sistema;

--
-- Name: tasa_tasaid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE tasa_tasaid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.tasa_tasaid_seq OWNER TO sistema;

--
-- Name: tasa_tasaid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE tasa_tasaid_seq OWNED BY tasa.tasaid;


--
-- Name: tipoacreditador_tipoacreditadoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE tipoacreditador_tipoacreditadoid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.tipoacreditador_tipoacreditadoid_seq OWNER TO sistema;

--
-- Name: tipoacreditador_tipoacreditadoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE tipoacreditador_tipoacreditadoid_seq OWNED BY tipoacreditador.tipoacreditadoid;


--
-- Name: tipoasentamiento_tipoasentamientoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE tipoasentamiento_tipoasentamientoid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.tipoasentamiento_tipoasentamientoid_seq OWNER TO sistema;

--
-- Name: tipoasentamiento_tipoasentamientoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE tipoasentamiento_tipoasentamientoid_seq OWNED BY tipoasentamiento.tipoasentamientoid;


--
-- Name: tipoaviso_tipoavisoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE tipoaviso_tipoavisoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.tipoaviso_tipoavisoid_seq OWNER TO sistema;

--
-- Name: tipoaviso_tipoavisoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE tipoaviso_tipoavisoid_seq OWNED BY tipoaviso.tipoavisoid;


--
-- Name: tipodeinmueble; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipodeinmueble (
    tipodeinmuebleid character(5),
    descripcion character varying(40)
);


ALTER TABLE sucursal1.tipodeinmueble OWNER TO sistema;

--
-- Name: tipodemueble; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipodemueble (
    tipodemuebleid character(5),
    descripcion character varying(40)
);


ALTER TABLE sucursal1.tipodemueble OWNER TO sistema;

--
-- Name: tipoderiesgo; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipoderiesgo (
    tipoderiesgoid integer NOT NULL,
    descripcion character(30),
    query text,
    nivelderiesgoid integer
);


ALTER TABLE sucursal1.tipoderiesgo OWNER TO sistema;

--
-- Name: tipoderiesgo_tipoderiesgoid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE tipoderiesgo_tipoderiesgoid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.tipoderiesgo_tipoderiesgoid_seq OWNER TO sistema;

--
-- Name: tipoderiesgo_tipoderiesgoid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE tipoderiesgo_tipoderiesgoid_seq OWNED BY tipoderiesgo.tipoderiesgoid;


--
-- Name: tipoinversion; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tipoinversion (
    tipoinversionid character(3) NOT NULL,
    cuentariesgocred character(24) NOT NULL,
    cuentaintinvernocob character(24) NOT NULL,
    calculoid integer NOT NULL,
    cuentapasivo character(24) NOT NULL,
    cuentapasivovencida character(24) NOT NULL,
    cuentaintinver character(24) NOT NULL,
    cuentaivainver character(24) NOT NULL,
    desctipoinversion character(30),
    tasa_normal_inversion numeric NOT NULL,
    plazo integer NOT NULL,
    aplicaivainversion character(1) NOT NULL,
    aplicaisr integer,
    reinvierteinteres integer,
    tipomovimientoid character(2),
    cuentaprovisionisr character(24),
    clasificacionid integer,
    montomaximo numeric,
    montominimo numeric,
    plazomaximo integer,
    indicadorid integer
);


ALTER TABLE sucursal1.tipoinversion OWNER TO sistema;

--
-- Name: tipopromocion_tipopromocionid_seq; Type: SEQUENCE; Schema: sucursal1; Owner: sistema
--

CREATE SEQUENCE tipopromocion_tipopromocionid_seq
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE sucursal1.tipopromocion_tipopromocionid_seq OWNER TO sistema;

--
-- Name: tipopromocion_tipopromocionid_seq; Type: SEQUENCE OWNED BY; Schema: sucursal1; Owner: sistema
--

ALTER SEQUENCE tipopromocion_tipopromocionid_seq OWNED BY tipopromocion.tipopromocionid;


--
-- Name: tmpsofi; Type: TABLE; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE TABLE tmpsofi (
    clavesocioint character(15),
    referenciaprestamo character(18),
    abono numeric
);


ALTER TABLE sucursal1.tmpsofi OWNER TO sistema;

SET search_path = public, pg_catalog;

--
-- Name: clasificacionsocioid; Type: DEFAULT; Schema: public; Owner: sistema
--

ALTER TABLE clasificacionsocio ALTER COLUMN clasificacionsocioid SET DEFAULT nextval('clasificacionsocio_clasificacionsocioid_seq'::regclass);


--
-- Name: datofiscaid; Type: DEFAULT; Schema: public; Owner: sistema
--

ALTER TABLE datosfiscales ALTER COLUMN datofiscaid SET DEFAULT nextval('datosfiscales_datofiscaid_seq'::regclass);


--
-- Name: reporteid; Type: DEFAULT; Schema: public; Owner: sistema
--

ALTER TABLE reportes ALTER COLUMN reporteid SET DEFAULT nextval('reportes_reporteid_seq'::regclass);


--
-- Name: socioeconomicoid; Type: DEFAULT; Schema: public; Owner: sistema
--

ALTER TABLE socioeconomico ALTER COLUMN socioeconomicoid SET DEFAULT nextval('socioeconomico_socioeconomicoid_seq'::regclass);


--
-- Name: tasatipoprestamoid; Type: DEFAULT; Schema: public; Owner: sistema
--

ALTER TABLE tasastipoprestamo ALTER COLUMN tasatipoprestamoid SET DEFAULT nextval('tasastipoprestamo_tasatipoprestamoid_seq'::regclass);


SET search_path = sucursal1, pg_catalog;

--
-- Name: activoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE activos ALTER COLUMN activoid SET DEFAULT nextval('activos_activoid_seq'::regclass);


--
-- Name: alertaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE alertasprevencion ALTER COLUMN alertaid SET DEFAULT nextval('alertasprevencion_alertaid_seq'::regclass);


--
-- Name: amortizacionid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE amortizaciones ALTER COLUMN amortizacionid SET DEFAULT nextval('amortizaciones_amortizacionid_seq'::regclass);


--
-- Name: asesorid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE asesor ALTER COLUMN asesorid SET DEFAULT nextval('asesor_asesorid_seq'::regclass);


--
-- Name: autorizacionid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE autorizabonificacion ALTER COLUMN autorizacionid SET DEFAULT nextval('autorizabonificacion_autorizacionid_seq'::regclass);


--
-- Name: avalid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE avales ALTER COLUMN avalid SET DEFAULT nextval('avales_avalid_seq'::regclass);


--
-- Name: avisoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE aviso ALTER COLUMN avisoid SET DEFAULT nextval('aviso_avisoid_seq'::regclass);


--
-- Name: beneficiarioid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE beneficiario ALTER COLUMN beneficiarioid SET DEFAULT nextval('beneficiario_beneficiarioid_seq'::regclass);


--
-- Name: bienid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE bienes ALTER COLUMN bienid SET DEFAULT nextval('bienes_bienid_seq'::regclass);


--
-- Name: calculoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE calculo ALTER COLUMN calculoid SET DEFAULT nextval('calculo_calculoid_seq'::regclass);


--
-- Name: captaciontotalid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE captaciontotal ALTER COLUMN captaciontotalid SET DEFAULT nextval('captaciontotal_captaciontotalid_seq'::regclass);


--
-- Name: cargoprestamoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE cargoprestamo ALTER COLUMN cargoprestamoid SET DEFAULT nextval('cargoprestamo_cargoprestamoid_seq'::regclass);


--
-- Name: carteraid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE carteracomunidadfecha ALTER COLUMN carteraid SET DEFAULT nextval('carteracomunidadfecha_carteraid_seq'::regclass);


--
-- Name: catalogoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE catalogominimo2 ALTER COLUMN catalogoid SET DEFAULT nextval('catalogominimo2_catalogoid_seq'::regclass);


--
-- Name: cerrarabririd; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE cerrarabrircaja ALTER COLUMN cerrarabririd SET DEFAULT nextval('cerrarabrircaja_cerrarabririd_seq'::regclass);


--
-- Name: ciudadmexid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ciudadesmex ALTER COLUMN ciudadmexid SET DEFAULT nextval('ciudadesmex_ciudadmexid_seq'::regclass);


--
-- Name: clasificacioncreditoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE clasificacioncredito ALTER COLUMN clasificacioncreditoid SET DEFAULT nextval('clasificacioncredito_clasificacioncreditoid_seq'::regclass);


--
-- Name: cobradorid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE cobrador ALTER COLUMN cobradorid SET DEFAULT nextval('cobrador_cobradorid_seq'::regclass);


--
-- Name: coloniaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE colonia ALTER COLUMN coloniaid SET DEFAULT nextval('colonia_coloniaid_seq'::regclass);


--
-- Name: conoceatuclienteid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE conoceatucliente ALTER COLUMN conoceatuclienteid SET DEFAULT nextval('conoceatucliente_conoceatuclienteid_seq'::regclass);


--
-- Name: sucursalid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE consolida ALTER COLUMN sucursalid SET DEFAULT nextval('consolida_sucursalid_seq'::regclass);


--
-- Name: convenioid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE convenio ALTER COLUMN convenioid SET DEFAULT nextval('convenio_convenioid_seq'::regclass);


--
-- Name: datofiscalid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE datosfiscales ALTER COLUMN datofiscalid SET DEFAULT nextval('datosfiscales_datofiscalid_seq'::regclass);


--
-- Name: denominacionid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE denominacion ALTER COLUMN denominacionid SET DEFAULT nextval('denominacion_denominacionid_seq'::regclass);


--
-- Name: depreciacionid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE depreciacion ALTER COLUMN depreciacionid SET DEFAULT nextval('depreciacion_depreciacionid_seq'::regclass);


--
-- Name: domicilioid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE domicilio ALTER COLUMN domicilioid SET DEFAULT nextval('domicilio_domicilioid_seq'::regclass);


--
-- Name: empresaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE empresa ALTER COLUMN empresaid SET DEFAULT nextval('empresa_empresaid_seq'::regclass);


--
-- Name: estadomexid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE estadosmex ALTER COLUMN estadomexid SET DEFAULT nextval('estadosmex_estadomexid_seq'::regclass);


--
-- Name: cobradorid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE eventoscobranza ALTER COLUMN cobradorid SET DEFAULT nextval('eventoscobranza_cobradorid_seq'::regclass);


--
-- Name: garantiaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE garantia ALTER COLUMN garantiaid SET DEFAULT nextval('garantia_garantiaid_seq'::regclass);


--
-- Name: garantiaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE garantias ALTER COLUMN garantiaid SET DEFAULT nextval('garantias_garantiaid_seq'::regclass);


--
-- Name: grupoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE grupo ALTER COLUMN grupoid SET DEFAULT nextval('grupo_grupoid_seq'::regclass);


--
-- Name: indicadorid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE indicador ALTER COLUMN indicadorid SET DEFAULT nextval('indicador_indicadorid_seq'::regclass);


--
-- Name: ano; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE inpc ALTER COLUMN ano SET DEFAULT nextval('inpc_ano_seq'::regclass);


--
-- Name: invenvalor; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE invenvalor ALTER COLUMN invenvalor SET DEFAULT nextval('invenvalor_invenvalor_seq'::regclass);


--
-- Name: inversionid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE inversion ALTER COLUMN inversionid SET DEFAULT nextval('inversion_inversionid_seq'::regclass);


--
-- Name: ministrarid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ministrar ALTER COLUMN ministrarid SET DEFAULT nextval('ministrar_ministrarid_seq'::regclass);


--
-- Name: motivobajaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE motivobaja ALTER COLUMN motivobajaid SET DEFAULT nextval('motivobaja_motivobajaid_seq'::regclass);


--
-- Name: movibancoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE movibanco ALTER COLUMN movibancoid SET DEFAULT nextval('movibanco_movibancoid_seq'::regclass);


--
-- Name: movicajaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE movicaja ALTER COLUMN movicajaid SET DEFAULT nextval('movicaja_movicajaid_seq'::regclass);


--
-- Name: movipolizaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE movipolizas ALTER COLUMN movipolizaid SET DEFAULT nextval('movipolizas_movipolizaid_seq'::regclass);


--
-- Name: nivelriesgoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE nivelderiesgo ALTER COLUMN nivelriesgoid SET DEFAULT nextval('nivelderiesgo_nivelriesgoid_seq'::regclass);


--
-- Name: ocupacionid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ocupacion ALTER COLUMN ocupacionid SET DEFAULT nextval('ocupacion_ocupacionid_seq'::regclass);


--
-- Name: operacionlavadoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE operacionlavado ALTER COLUMN operacionlavadoid SET DEFAULT nextval('operacionlavado_operacionlavadoid_seq'::regclass);


--
-- Name: parametroid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE parametros ALTER COLUMN parametroid SET DEFAULT nextval('parametros_parametroid_seq'::regclass);


--
-- Name: periodoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE periodo ALTER COLUMN periodoid SET DEFAULT nextval('periodo_periodoid_seq'::regclass);


--
-- Name: permisomoduloid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE permisosmodulos ALTER COLUMN permisomoduloid SET DEFAULT nextval('permisosmodulos_permisomoduloid_seq'::regclass);


--
-- Name: polizaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE polizas ALTER COLUMN polizaid SET DEFAULT nextval('polizas_polizaid_seq'::regclass);


--
-- Name: precorteid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE precorte ALTER COLUMN precorteid SET DEFAULT nextval('precorte_precorteid_seq'::regclass);


--
-- Name: premovipolizaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE premovipolizas ALTER COLUMN premovipolizaid SET DEFAULT nextval('premovipolizas_premovipolizaid_seq'::regclass);


--
-- Name: prepolizaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE prepolizas ALTER COLUMN prepolizaid SET DEFAULT nextval('prepolizas_prepolizaid_seq'::regclass);


--
-- Name: prestamobancarioid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE prestamobancario ALTER COLUMN prestamobancarioid SET DEFAULT nextval('prestamobancario_prestamobancarioid_seq'::regclass);


--
-- Name: prestamoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE prestamos ALTER COLUMN prestamoid SET DEFAULT nextval('prestamos_prestamoid_seq'::regclass);


--
-- Name: procampoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE procampo ALTER COLUMN procampoid SET DEFAULT nextval('procampo_procampoid_seq'::regclass);


--
-- Name: promocionid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE promocion ALTER COLUMN promocionid SET DEFAULT nextval('promocion_promocionid_seq'::regclass);


--
-- Name: promotorid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE promotor ALTER COLUMN promotorid SET DEFAULT nextval('promotor_promotorid_seq'::regclass);


--
-- Name: rangoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE rango ALTER COLUMN rangoid SET DEFAULT nextval('rango_rangoid_seq'::regclass);


--
-- Name: reciprocidadid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE reciprocidad ALTER COLUMN reciprocidadid SET DEFAULT nextval('reciprocidad_reciprocidadid_seq'::regclass);


--
-- Name: relacionid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE relacion ALTER COLUMN relacionid SET DEFAULT nextval('relacion_relacionid_seq'::regclass);


--
-- Name: sabanaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE sabana ALTER COLUMN sabanaid SET DEFAULT nextval('sabana_sabanaid_seq'::regclass);


--
-- Name: saldoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE saldos ALTER COLUMN saldoid SET DEFAULT nextval('saldos_saldoid_seq'::regclass);


--
-- Name: saldocid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE saldosc ALTER COLUMN saldocid SET DEFAULT nextval('saldosc_saldocid_seq'::regclass);


--
-- Name: scoringid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE scoring ALTER COLUMN scoringid SET DEFAULT nextval('scoring_scoringid_seq'::regclass);


--
-- Name: socioid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE socio ALTER COLUMN socioid SET DEFAULT nextval('socio_socioid_seq'::regclass);


--
-- Name: solicitudingresoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE solicitudingreso ALTER COLUMN solicitudingresoid SET DEFAULT nextval('solicitudingreso_solicitudingresoid_seq'::regclass);


--
-- Name: solicitudprestamoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE solicitudprestamo ALTER COLUMN solicitudprestamoid SET DEFAULT nextval('solicitudprestamo_solicitudprestamoid_seq'::regclass);


--
-- Name: subrangoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE subrango ALTER COLUMN subrangoid SET DEFAULT nextval('subrango_subrangoid_seq'::regclass);


--
-- Name: sucursalid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE sucursales ALTER COLUMN sucursalid SET DEFAULT nextval('sucursales_sucursalid_seq'::regclass);


--
-- Name: sujetoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE sujeto ALTER COLUMN sujetoid SET DEFAULT nextval('sujeto_sujetoid_seq'::regclass);


--
-- Name: tablareservaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE tablareserva ALTER COLUMN tablareservaid SET DEFAULT nextval('tablareserva_tablareservaid_seq'::regclass);


--
-- Name: tablonid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE tablon ALTER COLUMN tablonid SET DEFAULT nextval('tablon_tablonid_seq'::regclass);


--
-- Name: tasaid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE tasa ALTER COLUMN tasaid SET DEFAULT nextval('tasa_tasaid_seq'::regclass);


--
-- Name: tipoacreditadoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE tipoacreditador ALTER COLUMN tipoacreditadoid SET DEFAULT nextval('tipoacreditador_tipoacreditadoid_seq'::regclass);


--
-- Name: tipoasentamientoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE tipoasentamiento ALTER COLUMN tipoasentamientoid SET DEFAULT nextval('tipoasentamiento_tipoasentamientoid_seq'::regclass);


--
-- Name: tipoavisoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE tipoaviso ALTER COLUMN tipoavisoid SET DEFAULT nextval('tipoaviso_tipoavisoid_seq'::regclass);


--
-- Name: tipoderiesgoid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE tipoderiesgo ALTER COLUMN tipoderiesgoid SET DEFAULT nextval('tipoderiesgo_tipoderiesgoid_seq'::regclass);


--
-- Name: tipopromocionid; Type: DEFAULT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE tipopromocion ALTER COLUMN tipopromocionid SET DEFAULT nextval('tipopromocion_tipopromocionid_seq'::regclass);


SET search_path = public, pg_catalog;

--
-- Name: clasificacionsocio_pk; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY clasificacionsocio
    ADD CONSTRAINT clasificacionsocio_pk PRIMARY KEY (clasificacionsocioid);


--
-- Name: cobradores_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY cobradores
    ADD CONSTRAINT cobradores_pkey PRIMARY KEY (cobradorid);


--
-- Name: pga_diagrams_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY pga_diagrams
    ADD CONSTRAINT pga_diagrams_pkey PRIMARY KEY (diagramname);


--
-- Name: pga_forms_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY pga_forms
    ADD CONSTRAINT pga_forms_pkey PRIMARY KEY (formname);


--
-- Name: pga_graphs_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY pga_graphs
    ADD CONSTRAINT pga_graphs_pkey PRIMARY KEY (graphname);


--
-- Name: pga_images_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY pga_images
    ADD CONSTRAINT pga_images_pkey PRIMARY KEY (imagename);


--
-- Name: pga_layout_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY pga_layout
    ADD CONSTRAINT pga_layout_pkey PRIMARY KEY (tablename);


--
-- Name: pga_queries_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY pga_queries
    ADD CONSTRAINT pga_queries_pkey PRIMARY KEY (queryname);


--
-- Name: pga_reports_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY pga_reports
    ADD CONSTRAINT pga_reports_pkey PRIMARY KEY (reportname);


--
-- Name: pga_scripts_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY pga_scripts
    ADD CONSTRAINT pga_scripts_pkey PRIMARY KEY (scriptname);


--
-- Name: sessions_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY sessions
    ADD CONSTRAINT sessions_pkey PRIMARY KEY (id);


--
-- Name: socioeconomico_pkey; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY socioeconomico
    ADD CONSTRAINT socioeconomico_pkey PRIMARY KEY (socioeconomicoid);


--
-- Name: socioeconomico_socioid_key; Type: CONSTRAINT; Schema: public; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY socioeconomico
    ADD CONSTRAINT socioeconomico_socioid_key UNIQUE (socioid);


SET search_path = sucursal1, pg_catalog;

--
-- Name: activos_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY activos
    ADD CONSTRAINT activos_pk PRIMARY KEY (activoid);


--
-- Name: amortizaciones_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY amortizaciones
    ADD CONSTRAINT amortizaciones_pk PRIMARY KEY (amortizacionid);


--
-- Name: asesor_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY asesor
    ADD CONSTRAINT asesor_pk PRIMARY KEY (asesorid);


--
-- Name: autorizabonificacion_pkey; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY autorizabonificacion
    ADD CONSTRAINT autorizabonificacion_pkey PRIMARY KEY (autorizacionid);


--
-- Name: avales_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY avales
    ADD CONSTRAINT avales_pk PRIMARY KEY (avalid);


--
-- Name: aviso_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY aviso
    ADD CONSTRAINT aviso_pk PRIMARY KEY (avisoid);


--
-- Name: bancos_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY bancos
    ADD CONSTRAINT bancos_pk PRIMARY KEY (no_cuenta);


--
-- Name: beneficiario_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY beneficiario
    ADD CONSTRAINT beneficiario_pk PRIMARY KEY (beneficiarioid);


--
-- Name: bienes_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY bienes
    ADD CONSTRAINT bienes_pk PRIMARY KEY (bienid);


--
-- Name: calculo_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY calculo
    ADD CONSTRAINT calculo_pk PRIMARY KEY (calculoid);


--
-- Name: catalogo_ctas_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY catalogo_ctas
    ADD CONSTRAINT catalogo_ctas_pk PRIMARY KEY (cuentaid);


--
-- Name: ciudadesmex_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY ciudadesmex
    ADD CONSTRAINT ciudadesmex_pk PRIMARY KEY (ciudadmexid);


--
-- Name: clasificacioncredito_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY clasificacioncredito
    ADD CONSTRAINT clasificacioncredito_pk PRIMARY KEY (clasificacioncreditoid);


--
-- Name: colonia_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY colonia
    ADD CONSTRAINT colonia_pk PRIMARY KEY (coloniaid);


--
-- Name: consolida_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY consolida
    ADD CONSTRAINT consolida_pk PRIMARY KEY (sucursalid);


--
-- Name: convenio_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY convenio
    ADD CONSTRAINT convenio_pk PRIMARY KEY (convenioid);


--
-- Name: denominacion_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY denominacion
    ADD CONSTRAINT denominacion_pk PRIMARY KEY (denominacionid);


--
-- Name: depreciacion_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY depreciacion
    ADD CONSTRAINT depreciacion_pk PRIMARY KEY (depreciacionid);


--
-- Name: domicilio_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY domicilio
    ADD CONSTRAINT domicilio_pk PRIMARY KEY (domicilioid);


--
-- Name: empresa_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY empresa
    ADD CONSTRAINT empresa_pk PRIMARY KEY (empresaid);


--
-- Name: estados_credito_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY estados_credito
    ADD CONSTRAINT estados_credito_pk PRIMARY KEY (claveestadocredito);


--
-- Name: estadosmex_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY estadosmex
    ADD CONSTRAINT estadosmex_pk PRIMARY KEY (estadomexid);


--
-- Name: finalidades_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY finalidades
    ADD CONSTRAINT finalidades_pk PRIMARY KEY (clavefinalidad);


--
-- Name: garantia_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY garantia
    ADD CONSTRAINT garantia_pk PRIMARY KEY (garantiaid);


--
-- Name: grupo_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY grupo
    ADD CONSTRAINT grupo_pk PRIMARY KEY (grupoid);


--
-- Name: inpc_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY inpc
    ADD CONSTRAINT inpc_pk PRIMARY KEY (ano, mes);


--
-- Name: inversion_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY inversion
    ADD CONSTRAINT inversion_pk PRIMARY KEY (inversionid);


--
-- Name: modulos_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY modulos
    ADD CONSTRAINT modulos_pk PRIMARY KEY (clavemodulo);


--
-- Name: monedas_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY monedas
    ADD CONSTRAINT monedas_pk PRIMARY KEY (monedaid);


--
-- Name: motivobaja_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY motivobaja
    ADD CONSTRAINT motivobaja_pk PRIMARY KEY (motivobajaid);


--
-- Name: movibanco_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY movibanco
    ADD CONSTRAINT movibanco_pk PRIMARY KEY (movibancoid);


--
-- Name: movicaja_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY movicaja
    ADD CONSTRAINT movicaja_pk PRIMARY KEY (movicajaid);


--
-- Name: movipolizas_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY movipolizas
    ADD CONSTRAINT movipolizas_pk PRIMARY KEY (movipolizaid);


--
-- Name: ocupacion_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY ocupacion
    ADD CONSTRAINT ocupacion_pk PRIMARY KEY (ocupacionid);


--
-- Name: parametros_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY parametros
    ADD CONSTRAINT parametros_pk PRIMARY KEY (parametroid);


--
-- Name: periodo_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY periodo
    ADD CONSTRAINT periodo_pk PRIMARY KEY (periodoid);


--
-- Name: permisosmodulos_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY permisosmodulos
    ADD CONSTRAINT permisosmodulos_pk PRIMARY KEY (permisomoduloid);


--
-- Name: polizas_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY polizas
    ADD CONSTRAINT polizas_pk PRIMARY KEY (polizaid);


--
-- Name: precorte_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY precorte
    ADD CONSTRAINT precorte_pk PRIMARY KEY (precorteid);


--
-- Name: prestamos_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT prestamos_pk PRIMARY KEY (prestamoid);


--
-- Name: procampo_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY procampo
    ADD CONSTRAINT procampo_pk PRIMARY KEY (procampoid);


--
-- Name: promocion_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY promocion
    ADD CONSTRAINT promocion_pk PRIMARY KEY (promocionid);


--
-- Name: rango_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY rango
    ADD CONSTRAINT rango_pk PRIMARY KEY (rangoid);


--
-- Name: reciprocidad_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY reciprocidad
    ADD CONSTRAINT reciprocidad_pk PRIMARY KEY (reciprocidadid);


--
-- Name: relacion_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY relacion
    ADD CONSTRAINT relacion_pk PRIMARY KEY (relacionid);


--
-- Name: sabana_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY sabana
    ADD CONSTRAINT sabana_pk PRIMARY KEY (sabanaid);


--
-- Name: saldos_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY saldos
    ADD CONSTRAINT saldos_pk PRIMARY KEY (saldoid);


--
-- Name: saldosc_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY saldosc
    ADD CONSTRAINT saldosc_pk PRIMARY KEY (saldocid);


--
-- Name: scoring_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY scoring
    ADD CONSTRAINT scoring_pk PRIMARY KEY (scoringid);


--
-- Name: socio_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY socio
    ADD CONSTRAINT socio_pk PRIMARY KEY (socioid);


--
-- Name: solicitudingreso_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY solicitudingreso
    ADD CONSTRAINT solicitudingreso_pk PRIMARY KEY (solicitudingresoid);


--
-- Name: solicitudprestamo_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY solicitudprestamo
    ADD CONSTRAINT solicitudprestamo_pk PRIMARY KEY (solicitudprestamoid);


--
-- Name: subrango_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY subrango
    ADD CONSTRAINT subrango_pk PRIMARY KEY (subrangoid);


--
-- Name: sucursales_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY sucursales
    ADD CONSTRAINT sucursales_pk PRIMARY KEY (sucursalid);


--
-- Name: sujeto_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY sujeto
    ADD CONSTRAINT sujeto_pk PRIMARY KEY (sujetoid);


--
-- Name: tablareserva_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tablareserva
    ADD CONSTRAINT tablareserva_pk PRIMARY KEY (tablareservaid);


--
-- Name: tablon_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tablon
    ADD CONSTRAINT tablon_pk PRIMARY KEY (tablonid);


--
-- Name: tasa_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tasa
    ADD CONSTRAINT tasa_pk PRIMARY KEY (tasaid);


--
-- Name: tipo_garantia_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tipo_garantia
    ADD CONSTRAINT tipo_garantia_pk PRIMARY KEY (clavegarantia);


--
-- Name: tipoacreditador_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tipoacreditador
    ADD CONSTRAINT tipoacreditador_pk PRIMARY KEY (tipoacreditadoid);


--
-- Name: tipoasentamiento_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tipoasentamiento
    ADD CONSTRAINT tipoasentamiento_pk PRIMARY KEY (tipoasentamientoid);


--
-- Name: tipoaviso_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tipoaviso
    ADD CONSTRAINT tipoaviso_pk PRIMARY KEY (tipoavisoid);


--
-- Name: tipoinversion_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tipoinversion
    ADD CONSTRAINT tipoinversion_pk PRIMARY KEY (tipoinversionid);


--
-- Name: tipomovibanco_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tipomovibanco
    ADD CONSTRAINT tipomovibanco_pk PRIMARY KEY (tipomovibancoid);


--
-- Name: tipomovimiento_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tipomovimiento
    ADD CONSTRAINT tipomovimiento_pk PRIMARY KEY (tipomovimientoid);


--
-- Name: tipoprestamo_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tipoprestamo
    ADD CONSTRAINT tipoprestamo_pk PRIMARY KEY (tipoprestamoid);


--
-- Name: tipopromocion_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tipopromocion
    ADD CONSTRAINT tipopromocion_pk PRIMARY KEY (tipopromocionid);


--
-- Name: tiposocio_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tiposocio
    ADD CONSTRAINT tiposocio_pk PRIMARY KEY (tiposocioid);


--
-- Name: tipousuario_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY tipousuario
    ADD CONSTRAINT tipousuario_pk PRIMARY KEY (tipousuarioid);


--
-- Name: udis_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY udis
    ADD CONSTRAINT udis_pk PRIMARY KEY (fecha);


--
-- Name: usuarios_pk; Type: CONSTRAINT; Schema: sucursal1; Owner: sistema; Tablespace: 
--

ALTER TABLE ONLY usuarios
    ADD CONSTRAINT usuarios_pk PRIMARY KEY (usuarioid);


--
-- Name: activos_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX activos_fkindex1 ON activos USING btree (depreciacionid);


--
-- Name: amortizaciones_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX amortizaciones_fkindex1 ON amortizaciones USING btree (prestamoid);


--
-- Name: amortizaciones_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX amortizaciones_fkindex2 ON amortizaciones USING btree (claveestadocredito);


--
-- Name: avales_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX avales_fkindex1 ON avales USING btree (prestamoid);


--
-- Name: avales_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX avales_fkindex2 ON avales USING btree (socioid);


--
-- Name: avales_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX avales_fkindex3 ON avales USING btree (sujetoid);


--
-- Name: avales_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX avales_fkindex4 ON avales USING btree (solicitudprestamoid);


--
-- Name: avalprestamo; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX avalprestamo ON avales USING btree (sujetoid, prestamoid);


--
-- Name: avalsolicitud; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX avalsolicitud ON avales USING btree (sujetoid, solicitudprestamoid);


--
-- Name: aviso_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX aviso_fkindex1 ON aviso USING btree (prestamoid);


--
-- Name: aviso_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX aviso_fkindex2 ON aviso USING btree (tipoavisoid);


--
-- Name: bancos_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX bancos_fkindex1 ON bancos USING btree (cuentaid);


--
-- Name: bancos_seriebanco_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX bancos_seriebanco_key ON bancos USING btree (seriebanco);


--
-- Name: beneficiario_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX beneficiario_fkindex1 ON beneficiario USING btree (inversionid);


--
-- Name: beneficiario_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX beneficiario_fkindex2 ON beneficiario USING btree (socioid);


--
-- Name: beneficiario_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX beneficiario_fkindex3 ON beneficiario USING btree (sujetoid);


--
-- Name: bienes_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX bienes_fkindex1 ON bienes USING btree (sujetoid);


--
-- Name: captaciontotal_fechadegeneracion; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX captaciontotal_fechadegeneracion ON captaciontotal USING btree (fechadegeneracion);


--
-- Name: captaciontotal_fechadegeneracion_socio; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX captaciontotal_fechadegeneracion_socio ON captaciontotal USING btree (fechadegeneracion, clavesocioint);


--
-- Name: carteracomunidadfecha_fechadegeneracion; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX carteracomunidadfecha_fechadegeneracion ON carteracomunidadfecha USING btree (fechadegeneracion);


--
-- Name: carteracomunidadfecha_fechadegeneracion_socio; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX carteracomunidadfecha_fechadegeneracion_socio ON carteracomunidadfecha USING btree (fechadegeneracion, clavesocioint);


--
-- Name: carteracomunidadfecha_prestamoid_fechadegeneracion; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX carteracomunidadfecha_prestamoid_fechadegeneracion ON carteracomunidadfecha USING btree (prestamoid, fechadegeneracion);


--
-- Name: catalogo_ctasmovipolizas_fk; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX catalogo_ctasmovipolizas_fk ON movipolizas USING btree (cuentaid);


--
-- Name: ciudadesmex_claveciudadmex_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX ciudadesmex_claveciudadmex_key ON ciudadesmex USING btree (claveciudadmex);


--
-- Name: ciudadesmex_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX ciudadesmex_fkindex1 ON ciudadesmex USING btree (estadomexid);


--
-- Name: colonia_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX colonia_fkindex1 ON colonia USING btree (ciudadmexid);


--
-- Name: colonia_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX colonia_fkindex2 ON colonia USING btree (tipoasentamientoid);


--
-- Name: conoceatucliente_sujetoid_socioid; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX conoceatucliente_sujetoid_socioid ON conoceatucliente USING btree (sujetoid, socioid);


--
-- Name: conspoliza; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX conspoliza ON polizas USING btree (ejercicio, periodo, tipo_poliza, numero_poliza);


--
-- Name: convenio_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX convenio_fkindex1 ON convenio USING btree (prestamoid);


--
-- Name: convenio_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX convenio_fkindex2 ON convenio USING btree (usuarioid);


--
-- Name: datosfiscales_socioid; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX datosfiscales_socioid ON datosfiscales USING btree (socioid);


--
-- Name: depreciacion_depredescripcion_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX depreciacion_depredescripcion_key ON depreciacion USING btree (depredescripcion);


--
-- Name: depreciacion_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX depreciacion_fkindex2 ON depreciacion USING btree (depre_activo);


--
-- Name: depreciacion_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX depreciacion_fkindex3 ON depreciacion USING btree (depre_ctadepre);


--
-- Name: depreciacion_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX depreciacion_fkindex4 ON depreciacion USING btree (depre_ctagasto);


--
-- Name: depreciacion_fkindex5; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX depreciacion_fkindex5 ON depreciacion USING btree (depre_ctabaja);


--
-- Name: domicilio_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX domicilio_fkindex1 ON domicilio USING btree (sujetoid);


--
-- Name: ejercicioperiodo; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX ejercicioperiodo ON periodo USING btree (ejercicio, periodo);


--
-- Name: empresa_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX empresa_fkindex1 ON empresa USING btree (domicilioid);


--
-- Name: empresa_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX empresa_fkindex2 ON empresa USING btree (cuentaid);


--
-- Name: estados_credito_descripcionedocredito_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX estados_credito_descripcionedocredito_key ON estados_credito USING btree (descripcionedocredito);


--
-- Name: estadosmex_claveestadomex_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX estadosmex_claveestadomex_key ON estadosmex USING btree (claveestadomex);


--
-- Name: estadosmex_nombreestadomex_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX estadosmex_nombreestadomex_key ON estadosmex USING btree (nombreestadomex);


--
-- Name: fechaprecorte; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX fechaprecorte ON precorte USING btree (fechacierre);


--
-- Name: finalidades_descripcionfinalidad_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX finalidades_descripcionfinalidad_key ON finalidades USING btree (descripcionfinalidad);


--
-- Name: fotosolicitud; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX fotosolicitud ON foto USING btree (solicitudingresoid);


--
-- Name: garantia_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX garantia_fkindex3 ON garantia USING btree (inversionid);


--
-- Name: grupoi; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX grupoi ON grupo USING btree (grupo);


--
-- Name: hipoteca_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX hipoteca_fkindex1 ON garantia USING btree (solicitudprestamoid);


--
-- Name: hipoteca_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX hipoteca_fkindex2 ON garantia USING btree (prestamoid);


--
-- Name: inabili; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX inabili ON inabil USING btree (fecha);


--
-- Name: index_claseeconomico; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX index_claseeconomico ON claseeconomico USING btree (claseeconomicoid);


--
-- Name: index_cnbvlavado; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX index_cnbvlavado ON cnbvlavado USING btree (cnbvlavadoid);


--
-- Name: index_comunidadconapo; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX index_comunidadconapo ON comunidadconapo USING btree (claveconapo);


--
-- Name: index_movicajaid; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX index_movicajaid ON alertasprevencion USING btree (movicajaid);


--
-- Name: index_subclaseeconomico; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX index_subclaseeconomico ON subclaseeconomico USING btree (subclaseeconomicoid);


--
-- Name: index_subsectoreconomico; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX index_subsectoreconomico ON subsectoreconomico USING btree (subsectoreconomicoid);


--
-- Name: inpc_unico; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX inpc_unico ON inpc USING btree (ano, mes);


--
-- Name: inversion_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX inversion_fkindex1 ON inversion USING btree (tipoinversionid);


--
-- Name: inversion_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX inversion_fkindex2 ON inversion USING btree (socioid);


--
-- Name: inversionsujeto; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX inversionsujeto ON beneficiario USING btree (inversionid, sujetoid);


--
-- Name: irefereciaprestamo; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX irefereciaprestamo ON prestamos USING btree (referenciaprestamo);


--
-- Name: iseries; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX iseries ON parametros USING btree (serie_user);


--
-- Name: logpoliza_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX logpoliza_fkindex1 ON logpoliza USING btree (polizaid);


--
-- Name: logpoliza_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX logpoliza_fkindex2 ON logpoliza USING btree (usuarioid);


--
-- Name: modulos_descripcionmodulos_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX modulos_descripcionmodulos_key ON modulos USING btree (descripcionmodulos);


--
-- Name: modulostmp; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX modulostmp ON modulos USING btree (clavemodulo);


--
-- Name: monedas_monedadescri; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX monedas_monedadescri ON monedas USING btree (monedadescri);


--
-- Name: monedasdepreciacion; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX monedasdepreciacion ON depreciacion USING btree (monedaid);


--
-- Name: movibanco_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movibanco_fkindex1 ON movibanco USING btree (no_cuenta);


--
-- Name: movibanco_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movibanco_fkindex2 ON movibanco USING btree (tipomovibancoid);


--
-- Name: movibanco_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movibanco_fkindex3 ON movibanco USING btree (polizaid);


--
-- Name: movibanco_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movibanco_fkindex4 ON movibanco USING btree (movipolizaid);


--
-- Name: movibanco_fkindex5; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movibanco_fkindex5 ON movibanco USING btree (prestamoid);


--
-- Name: movibanco_fkindex6; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movibanco_fkindex6 ON movibanco USING btree (procampoid);


--
-- Name: movicaja_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movicaja_fkindex1 ON movicaja USING btree (inversionid);


--
-- Name: movicaja_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movicaja_fkindex2 ON movicaja USING btree (movipolizaid);


--
-- Name: movicaja_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movicaja_fkindex3 ON movicaja USING btree (tipomovimientoid);


--
-- Name: movicaja_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movicaja_fkindex4 ON movicaja USING btree (socioid);


--
-- Name: movicaja_fkindex5; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movicaja_fkindex5 ON movicaja USING btree (prestamoid);


--
-- Name: movicaja_fkindex6; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX movicaja_fkindex6 ON movicaja USING btree (polizaid);


--
-- Name: nosolicitudingreso; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX nosolicitudingreso ON solicitudingreso USING btree (nosolicitud);


--
-- Name: ocupacion_ocupacion; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX ocupacion_ocupacion ON ocupacion USING btree (ocupacion);


--
-- Name: parametros_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX parametros_fkindex1 ON parametros USING btree (usuarioid);


--
-- Name: parametros_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX parametros_fkindex2 ON parametros USING btree (cuentacaja);


--
-- Name: parametros_serie; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX parametros_serie ON parametros USING btree (serie_user);


--
-- Name: permisosmodulos_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX permisosmodulos_fkindex1 ON permisosmodulos USING btree (usuarioid);


--
-- Name: permisosmodulos_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX permisosmodulos_fkindex2 ON permisosmodulos USING btree (clavemodulo);


--
-- Name: polizasmovipolizas_fk; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX polizasmovipolizas_fk ON movipolizas USING btree (polizaid);


--
-- Name: precorte_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX precorte_fkindex1 ON precorte USING btree (prestamoid);


--
-- Name: precorte_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX precorte_fkindex2 ON precorte USING btree (tablareservaid);


--
-- Name: premovipolizas_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX premovipolizas_fkindex1 ON premovipolizas USING btree (prepolizaid);


--
-- Name: premovipolizas_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX premovipolizas_fkindex2 ON premovipolizas USING btree (cuentaid);


--
-- Name: prestamos_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex1 ON prestamos USING btree (tipoprestamoid);


--
-- Name: prestamos_fkindex10; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex10 ON prestamos USING btree (clasificacioncreditoid);


--
-- Name: prestamos_fkindex11; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex11 ON prestamos USING btree (sujetoid);


--
-- Name: prestamos_fkindex12; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex12 ON prestamos USING btree (tipoacreditadoid);


--
-- Name: prestamos_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex2 ON prestamos USING btree (socioid);


--
-- Name: prestamos_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex3 ON prestamos USING btree (claveestadocredito);


--
-- Name: prestamos_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex4 ON prestamos USING btree (clavefinalidad);


--
-- Name: prestamos_fkindex5; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex5 ON prestamos USING btree (clavegarantia);


--
-- Name: prestamos_fkindex6; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex6 ON prestamos USING btree (calculonormalid);


--
-- Name: prestamos_fkindex7; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex7 ON prestamos USING btree (calculomoratorioid);


--
-- Name: prestamos_fkindex8; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex8 ON prestamos USING btree (usuarioid);


--
-- Name: prestamos_fkindex9; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_fkindex9 ON prestamos USING btree (solicitudprestamoid);


--
-- Name: prestamos_referenciaprestamo_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX prestamos_referenciaprestamo_key ON prestamos USING btree (referenciaprestamo);


--
-- Name: procampo_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX procampo_fkindex1 ON procampo USING btree (beneficiarioid);


--
-- Name: procampo_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX procampo_fkindex2 ON procampo USING btree (sujetoid);


--
-- Name: procampo_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX procampo_fkindex3 ON procampo USING btree (tipoprestamoid);


--
-- Name: procampo_referenciaprestamo; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX procampo_referenciaprestamo ON procampo USING btree (referenciaprestamo);


--
-- Name: promocion_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX promocion_fkindex1 ON promocion USING btree (tipopromocionid);


--
-- Name: promocion_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX promocion_fkindex2 ON promocion USING btree (socioid);


--
-- Name: rango_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX rango_fkindex1 ON subrango USING btree (rangoinicial);


--
-- Name: rango_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX rango_fkindex2 ON subrango USING btree (rangofinal);


--
-- Name: recargos_unico; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX recargos_unico ON recargos USING btree (ano, mes);


--
-- Name: relacion_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX relacion_fkindex1 ON relacion USING btree (sujetoid);


--
-- Name: relacion_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX relacion_fkindex2 ON relacion USING btree (solicitudingresoid);


--
-- Name: relacion_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX relacion_fkindex3 ON relacion USING btree (socioid);


--
-- Name: relacionsujeto; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX relacionsujeto ON relacion USING btree (solicitudingresoid, sujetoid);


--
-- Name: sabana_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX sabana_fkindex1 ON sabana USING btree (denominacionid);


--
-- Name: sabana_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX sabana_fkindex2 ON sabana USING btree (socioid);


--
-- Name: saldos_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX saldos_fkindex1 ON saldos USING btree (cuentaid);


--
-- Name: saldosc_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX saldosc_fkindex1 ON saldosc USING btree (cuentaid);


--
-- Name: scoring_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX scoring_fkindex1 ON scoring USING btree (solicitudprestamoid);


--
-- Name: scoring_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX scoring_fkindex2 ON scoring USING btree (avalid);


--
-- Name: socio_clavesocioint_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX socio_clavesocioint_key ON socio USING btree (clavesocioint);


--
-- Name: socio_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX socio_fkindex4 ON socio USING btree (motivobajaid);


--
-- Name: socio_sujetoid; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX socio_sujetoid ON socio USING btree (clavesocioint, sujetoid);


--
-- Name: sociofirma; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX sociofirma ON firma USING btree (solicitudingresoid);


--
-- Name: sociosolicitud; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX sociosolicitud ON socio USING btree (solicitudingresoid);


--
-- Name: sociosujeto; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX sociosujeto ON socio USING btree (sujetoid);


--
-- Name: solicitudingreso_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudingreso_fkindex1 ON solicitudingreso USING btree (sujetoid);


--
-- Name: solicitudingreso_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudingreso_fkindex2 ON solicitudingreso USING btree (conyugeid);


--
-- Name: solicitudingreso_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudingreso_fkindex3 ON solicitudingreso USING btree (ciudadmexid);


--
-- Name: solicitudingreso_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudingreso_fkindex4 ON solicitudingreso USING btree (personaautorizadaid);


--
-- Name: solicitudingreso_fkindex5; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudingreso_fkindex5 ON solicitudingreso USING btree (usuarioid);


--
-- Name: solicitudingreso_fkindex6; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudingreso_fkindex6 ON solicitudingreso USING btree (lastusuarioid);


--
-- Name: solicitudingreso_fkindex7; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX solicitudingreso_fkindex7 ON solicitudingreso USING btree (socioid);


--
-- Name: solicitudprestamo_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudprestamo_fkindex1 ON solicitudprestamo USING btree (socioid);


--
-- Name: solicitudprestamo_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudprestamo_fkindex3 ON solicitudprestamo USING btree (lastusuarioid);


--
-- Name: solicitudprestamo_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudprestamo_fkindex4 ON solicitudprestamo USING btree (clavefinalidad);


--
-- Name: solicitudprestamo_fkindex5; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudprestamo_fkindex5 ON solicitudprestamo USING btree (tipoprestamoid);


--
-- Name: solicitudprestamo_fkindex6; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudprestamo_fkindex6 ON solicitudprestamo USING btree (sujetoid);


--
-- Name: solicitudprestamo_fkindex7; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudprestamo_fkindex7 ON solicitudprestamo USING btree (usuarioid);


--
-- Name: solicitudprestamo_fkindex8; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX solicitudprestamo_fkindex8 ON solicitudprestamo USING btree (domicilioid);


--
-- Name: solicitudprestamonosolicitud; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX solicitudprestamonosolicitud ON solicitudprestamo USING btree (nosolicitud);


--
-- Name: subcuenta; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX subcuenta ON catalogo_ctas USING btree (cat_cuentaid);


--
-- Name: subrango_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX subrango_fkindex3 ON subrango USING btree (rangoid);


--
-- Name: sujeto_unico; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX sujeto_unico ON sujeto USING btree (nombre, paterno, materno, rfc);


--
-- Name: sujetosocio_fk; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX sujetosocio_fk ON socio USING btree (sujetoid);


--
-- Name: tablon_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tablon_fkindex1 ON tablon USING btree (socioid);


--
-- Name: tablon_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tablon_fkindex2 ON tablon USING btree (usuarioid);


--
-- Name: tasa_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tasa_fkindex1 ON tasa USING btree (tipomovimientoid);


--
-- Name: tasa_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tasa_fkindex2 ON tasa USING btree (tipoinversionid);


--
-- Name: tasa_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tasa_fkindex3 ON tasa USING btree (tipoprestamoid);


--
-- Name: tipo_garantia_descripciongarantia_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX tipo_garantia_descripciongarantia_key ON tipo_garantia USING btree (descripciongarantia);


--
-- Name: tipodeinmueble_tipodeinmuebleid; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX tipodeinmueble_tipodeinmuebleid ON tipodeinmueble USING btree (tipodeinmuebleid);


--
-- Name: tipodemueble_tipodemuebleid; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX tipodemueble_tipodemuebleid ON tipodemueble USING btree (tipodemuebleid);


--
-- Name: tipoinversion_desctipoinversion_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoinversion_desctipoinversion_key ON tipoinversion USING btree (desctipoinversion);


--
-- Name: tipoinversion_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoinversion_fkindex1 ON tipoinversion USING btree (cuentapasivovencida);


--
-- Name: tipoinversion_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoinversion_fkindex2 ON tipoinversion USING btree (cuentaintinver);


--
-- Name: tipoinversion_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoinversion_fkindex3 ON tipoinversion USING btree (cuentaintinvernocob);


--
-- Name: tipoinversion_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoinversion_fkindex4 ON tipoinversion USING btree (cuentariesgocred);


--
-- Name: tipoinversion_fkindex5; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoinversion_fkindex5 ON tipoinversion USING btree (cuentaivainver);


--
-- Name: tipoinversion_fkindex6; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoinversion_fkindex6 ON tipoinversion USING btree (calculoid);


--
-- Name: tipoinversion_fkindex8; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoinversion_fkindex8 ON tipoinversion USING btree (cuentaprovisionisr);


--
-- Name: tipomovibanco_descritipomovibanco_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX tipomovibanco_descritipomovibanco_key ON tipomovibanco USING btree (descritipomovibanco);


--
-- Name: tipomovimiento_desctipomovimiento_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_desctipomovimiento_key ON tipomovimiento USING btree (desctipomovimiento);


--
-- Name: tipomovimiento_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_fkindex1 ON tipomovimiento USING btree (cuentadeposito);


--
-- Name: tipomovimiento_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_fkindex2 ON tipomovimiento USING btree (cuentaretiro);


--
-- Name: tipomovimiento_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_fkindex3 ON tipomovimiento USING btree (cuentaintpagado);


--
-- Name: tipomovimiento_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_fkindex4 ON tipomovimiento USING btree (cuentaintcobrado);


--
-- Name: tipomovimiento_fkindex5; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_fkindex5 ON tipomovimiento USING btree (cuentaivamovimiento);


--
-- Name: tipomovimiento_fkindex6; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_fkindex6 ON tipomovimiento USING btree (cuentaisr);


--
-- Name: tipomovimiento_fkindex7; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_fkindex7 ON tipomovimiento USING btree (cuentaordendeudor);


--
-- Name: tipomovimiento_fkindex8; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_fkindex8 ON tipomovimiento USING btree (cuentaordenacredor);


--
-- Name: tipomovimiento_fkindex9; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_fkindex9 ON tipomovimiento USING btree (cuentaprovisionisr);


--
-- Name: tipomovimiento_tipopoliza_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipomovimiento_tipopoliza_key ON tipomovimiento USING btree (tipopoliza);


--
-- Name: tipoprestamo_desctipoprestamo_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_desctipoprestamo_key ON tipoprestamo USING btree (desctipoprestamo);


--
-- Name: tipoprestamo_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex1 ON tipoprestamo USING btree (cuentaactivo);


--
-- Name: tipoprestamo_fkindex10; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex10 ON tipoprestamo USING btree (cuentaordeninteres);


--
-- Name: tipoprestamo_fkindex11; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex11 ON tipoprestamo USING btree (cuentariesgocred);


--
-- Name: tipoprestamo_fkindex12; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex12 ON tipoprestamo USING btree (tipomovimientoid);


--
-- Name: tipoprestamo_fkindex13; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex13 ON tipoprestamo USING btree (cuentaintdevnocobres);


--
-- Name: tipoprestamo_fkindex14; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex14 ON tipoprestamo USING btree (cuentariesgocredres);


--
-- Name: tipoprestamo_fkindex15; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex15 ON tipoprestamo USING btree (cuentaintmoranocobact);


--
-- Name: tipoprestamo_fkindex16; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex16 ON tipoprestamo USING btree (cuentaintmoradevnocobres);


--
-- Name: tipoprestamo_fkindex17; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex17 ON tipoprestamo USING btree (ordendeudornormalbonificado);


--
-- Name: tipoprestamo_fkindex18; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex18 ON tipoprestamo USING btree (ordenacredornormalbonificado);


--
-- Name: tipoprestamo_fkindex19; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex19 ON tipoprestamo USING btree (cuentafondorecuperacion);


--
-- Name: tipoprestamo_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex2 ON tipoprestamo USING btree (cuentaactivovencida);


--
-- Name: tipoprestamo_fkindex20; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex20 ON tipoprestamo USING btree (cuentagtosadm);


--
-- Name: tipoprestamo_fkindex21; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex21 ON tipoprestamo USING btree (cuentaintnormalresvencida);


--
-- Name: tipoprestamo_fkindex22; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex22 ON tipoprestamo USING btree (cuentaintnormalresvencida);


--
-- Name: tipoprestamo_fkindex23; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex23 ON tipoprestamo USING btree (ordeninteresacreedor);


--
-- Name: tipoprestamo_fkindex24; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex24 ON tipoprestamo USING btree (calculonormalid);


--
-- Name: tipoprestamo_fkindex25; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex25 ON tipoprestamo USING btree (calculomoraid);


--
-- Name: tipoprestamo_fkindex26; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex26 ON tipoprestamo USING btree (clavefinalidad);


--
-- Name: tipoprestamo_fkindex27; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex27 ON tipoprestamo USING btree (cuentaprovisioniva);


--
-- Name: tipoprestamo_fkindex29; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex29 ON tipoprestamo USING btree (cuentaordenavalacredor);


--
-- Name: tipoprestamo_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex3 ON tipoprestamo USING btree (cuentaintmora);


--
-- Name: tipoprestamo_fkindex30; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex30 ON tipoprestamo USING btree (cuentagarantiadeudor);


--
-- Name: tipoprestamo_fkindex31; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex31 ON tipoprestamo USING btree (cuentagarantiaacredor);


--
-- Name: tipoprestamo_fkindex32; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex32 ON tipoprestamo USING btree (cuentaprovisioniva);


--
-- Name: tipoprestamo_fkindex4; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex4 ON tipoprestamo USING btree (cuentaintmoravencida);


--
-- Name: tipoprestamo_fkindex5; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex5 ON tipoprestamo USING btree (cuentaintnormal);


--
-- Name: tipoprestamo_fkindex6; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex6 ON tipoprestamo USING btree (cuentaintnormalnocob);


--
-- Name: tipoprestamo_fkindex7; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex7 ON tipoprestamo USING btree (cuentaintnormalvencida);


--
-- Name: tipoprestamo_fkindex8; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex8 ON tipoprestamo USING btree (cuentaiva);


--
-- Name: tipoprestamo_fkindex9; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipoprestamo_fkindex9 ON tipoprestamo USING btree (cuentaordenaval);


--
-- Name: tipopromocion_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tipopromocion_fkindex1 ON tipopromocion USING btree (tipomovimientoid);


--
-- Name: tiposocio_descritiposocio_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX tiposocio_descritiposocio_key ON tiposocio USING btree (descritiposocio);


--
-- Name: tiposociosocio_fk; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX tiposociosocio_fk ON socio USING btree (tiposocioid);


--
-- Name: tipousuario_descripciontipousuario_key; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX tipousuario_descripciontipousuario_key ON tipousuario USING btree (descripciontipousuario);


--
-- Name: udis_unico; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE UNIQUE INDEX udis_unico ON udis USING btree (fecha);


--
-- Name: usuarios_fkindex1; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX usuarios_fkindex1 ON usuarios USING btree (tipousuarioid);


--
-- Name: usuarios_fkindex2; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX usuarios_fkindex2 ON usuarios USING btree (usu_usuarioid);


--
-- Name: usuarios_fkindex3; Type: INDEX; Schema: sucursal1; Owner: sistema; Tablespace: 
--

CREATE INDEX usuarios_fkindex3 ON usuarios USING btree (sujetoid);


--
-- Name: trigger_amortizacion; Type: TRIGGER; Schema: sucursal1; Owner: sistema
--

CREATE TRIGGER trigger_amortizacion
    BEFORE INSERT OR UPDATE ON amortizaciones
    FOR EACH ROW
    EXECUTE PROCEDURE public.trigger_insert_update_amortizacion();


--
-- Name: trigger_inversion; Type: TRIGGER; Schema: sucursal1; Owner: sistema
--

CREATE TRIGGER trigger_inversion
    BEFORE INSERT OR UPDATE ON inversion
    FOR EACH ROW
    EXECUTE PROCEDURE public.trigger_insert_update_inversion();


--
-- Name: trigger_prestamo; Type: TRIGGER; Schema: sucursal1; Owner: sistema
--

CREATE TRIGGER trigger_prestamo
    BEFORE INSERT OR UPDATE ON prestamos
    FOR EACH ROW
    EXECUTE PROCEDURE public.trigger_insert_update_prestamo();


SET search_path = public, pg_catalog;

--
-- Name: carteracobrador_cobradorid_fkey; Type: FK CONSTRAINT; Schema: public; Owner: sistema
--

ALTER TABLE ONLY carteracobrador
    ADD CONSTRAINT carteracobrador_cobradorid_fkey FOREIGN KEY (cobradorid) REFERENCES cobradores(cobradorid);


--
-- Name: carteracobrador_prestamoid_fkey; Type: FK CONSTRAINT; Schema: public; Owner: sistema
--

ALTER TABLE ONLY carteracobrador
    ADD CONSTRAINT carteracobrador_prestamoid_fkey FOREIGN KEY (prestamoid) REFERENCES sucursal1.prestamos(prestamoid);


--
-- Name: cobradores_sujetoid_fkey; Type: FK CONSTRAINT; Schema: public; Owner: sistema
--

ALTER TABLE ONLY cobradores
    ADD CONSTRAINT cobradores_sujetoid_fkey FOREIGN KEY (sujetoid) REFERENCES sucursal1.sujeto(sujetoid);


--
-- Name: datosfiscales_socioid_fkey; Type: FK CONSTRAINT; Schema: public; Owner: sistema
--

ALTER TABLE ONLY datosfiscales
    ADD CONSTRAINT datosfiscales_socioid_fkey FOREIGN KEY (socioid) REFERENCES sucursal1.socio(socioid);


--
-- Name: fksesocio; Type: FK CONSTRAINT; Schema: public; Owner: sistema
--

ALTER TABLE ONLY socioeconomico
    ADD CONSTRAINT fksesocio FOREIGN KEY (socioid) REFERENCES sucursal1.socio(socioid);


SET search_path = sucursal1, pg_catalog;

--
-- Name: accesso; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY permisosmodulos
    ADD CONSTRAINT accesso FOREIGN KEY (clavemodulo) REFERENCES modulos(clavemodulo);


--
-- Name: avales; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY avales
    ADD CONSTRAINT avales FOREIGN KEY (prestamoid) REFERENCES prestamos(prestamoid);


--
-- Name: avalsocio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY avales
    ADD CONSTRAINT avalsocio FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: bancosmovibanco; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movibanco
    ADD CONSTRAINT bancosmovibanco FOREIGN KEY (no_cuenta) REFERENCES bancos(no_cuenta);


--
-- Name: beneficiarioprocampo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY procampo
    ADD CONSTRAINT beneficiarioprocampo FOREIGN KEY (beneficiarioid) REFERENCES beneficiario(beneficiarioid);


--
-- Name: calculomoradefault; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tipoprestamo
    ADD CONSTRAINT calculomoradefault FOREIGN KEY (calculomoraid) REFERENCES calculo(calculoid);


--
-- Name: calculomoratorio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT calculomoratorio FOREIGN KEY (calculomoratorioid) REFERENCES calculo(calculoid);


--
-- Name: calculonormal; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT calculonormal FOREIGN KEY (calculonormalid) REFERENCES calculo(calculoid);


--
-- Name: calculonormaldefault; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tipoprestamo
    ADD CONSTRAINT calculonormaldefault FOREIGN KEY (calculonormalid) REFERENCES calculo(calculoid);


--
-- Name: calculotipoinversion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tipoinversion
    ADD CONSTRAINT calculotipoinversion FOREIGN KEY (calculoid) REFERENCES calculo(calculoid);


--
-- Name: catalogorangoi; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY subrango
    ADD CONSTRAINT catalogorangoi FOREIGN KEY (rangoinicial) REFERENCES catalogo_ctas(cuentaid);


--
-- Name: chequeprocampo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movibanco
    ADD CONSTRAINT chequeprocampo FOREIGN KEY (procampoid) REFERENCES procampo(procampoid);


--
-- Name: ciudaddomicilio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY domicilio
    ADD CONSTRAINT ciudaddomicilio FOREIGN KEY (ciudadmexid) REFERENCES ciudadesmex(ciudadmexid);


--
-- Name: coloniaasentamiento; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY colonia
    ADD CONSTRAINT coloniaasentamiento FOREIGN KEY (tipoasentamientoid) REFERENCES tipoasentamiento(tipoasentamientoid);


--
-- Name: coloniasciudad; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY colonia
    ADD CONSTRAINT coloniasciudad FOREIGN KEY (ciudadmexid) REFERENCES ciudadesmex(ciudadmexid);


--
-- Name: cuentaempresa; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY empresa
    ADD CONSTRAINT cuentaempresa FOREIGN KEY (cuentaid) REFERENCES catalogo_ctas(cuentaid);


--
-- Name: cuentaidsaldos; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY saldosc
    ADD CONSTRAINT cuentaidsaldos FOREIGN KEY (cuentaid) REFERENCES catalogo_ctas(cuentaid);


--
-- Name: datosfiscales_socioid_fkey; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY datosfiscales
    ADD CONSTRAINT datosfiscales_socioid_fkey FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: depreciacionactivos; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY activos
    ADD CONSTRAINT depreciacionactivos FOREIGN KEY (depreciacionid) REFERENCES depreciacion(depreciacionid);


--
-- Name: domicilioempresa; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY empresa
    ADD CONSTRAINT domicilioempresa FOREIGN KEY (domicilioid) REFERENCES domicilio(domicilioid);


--
-- Name: domicilioempresa; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudprestamo
    ADD CONSTRAINT domicilioempresa FOREIGN KEY (domicilioid) REFERENCES domicilio(domicilioid);


--
-- Name: estadociudad; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY ciudadesmex
    ADD CONSTRAINT estadociudad FOREIGN KEY (estadomexid) REFERENCES estadosmex(estadomexid);


--
-- Name: estadoscreditoprestamo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT estadoscreditoprestamo FOREIGN KEY (claveestadocredito) REFERENCES estados_credito(claveestadocredito);


--
-- Name: estatus; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY amortizaciones
    ADD CONSTRAINT estatus FOREIGN KEY (claveestadocredito) REFERENCES estados_credito(claveestadocredito);


--
-- Name: finalidad; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tipoprestamo
    ADD CONSTRAINT finalidad FOREIGN KEY (clavefinalidad) REFERENCES finalidades(clavefinalidad);


--
-- Name: finalidaddefault; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tipoprestamo
    ADD CONSTRAINT finalidaddefault FOREIGN KEY (clavefinalidad) REFERENCES finalidades(clavefinalidad);


--
-- Name: finalidadprestamo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT finalidadprestamo FOREIGN KEY (clavefinalidad) REFERENCES finalidades(clavefinalidad);


--
-- Name: fk_usuario_id; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY autorizabonificacion
    ADD CONSTRAINT fk_usuario_id FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: garantiainversion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY garantia
    ADD CONSTRAINT garantiainversion FOREIGN KEY (inversionid) REFERENCES inversion(inversionid);


--
-- Name: garantiaprestamo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT garantiaprestamo FOREIGN KEY (clavegarantia) REFERENCES tipo_garantia(clavegarantia);


--
-- Name: ingresociudadnac; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudingreso
    ADD CONSTRAINT ingresociudadnac FOREIGN KEY (ciudadmexid) REFERENCES ciudadesmex(ciudadmexid);


--
-- Name: ingresoconyuge; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudingreso
    ADD CONSTRAINT ingresoconyuge FOREIGN KEY (conyugeid) REFERENCES sujeto(sujetoid);


--
-- Name: ingresopersonaaut; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudingreso
    ADD CONSTRAINT ingresopersonaaut FOREIGN KEY (personaautorizadaid) REFERENCES sujeto(sujetoid);


--
-- Name: ingresosocio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY socio
    ADD CONSTRAINT ingresosocio FOREIGN KEY (solicitudingresoid) REFERENCES solicitudingreso(solicitudingresoid);


--
-- Name: ingresosujeto; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudingreso
    ADD CONSTRAINT ingresosujeto FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: ingresousuario; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudingreso
    ADD CONSTRAINT ingresousuario FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: ingresousuarioup; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudingreso
    ADD CONSTRAINT ingresousuarioup FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: intmoradefault; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tipoprestamo
    ADD CONSTRAINT intmoradefault FOREIGN KEY (calculomoraid) REFERENCES calculo(calculoid);


--
-- Name: intnormaldefault; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tipoprestamo
    ADD CONSTRAINT intnormaldefault FOREIGN KEY (calculonormalid) REFERENCES calculo(calculoid);


--
-- Name: inversionbeneficiario; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY beneficiario
    ADD CONSTRAINT inversionbeneficiario FOREIGN KEY (inversionid) REFERENCES inversion(inversionid);


--
-- Name: inversionmovicaja; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movicaja
    ADD CONSTRAINT inversionmovicaja FOREIGN KEY (inversionid) REFERENCES inversion(inversionid);


--
-- Name: jefede; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY usuarios
    ADD CONSTRAINT jefede FOREIGN KEY (usu_usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: logdepoliza; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY logpoliza
    ADD CONSTRAINT logdepoliza FOREIGN KEY (polizaid) REFERENCES polizas(polizaid);


--
-- Name: logpolizausuario; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY logpoliza
    ADD CONSTRAINT logpolizausuario FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: monedasdepreciacion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY depreciacion
    ADD CONSTRAINT monedasdepreciacion FOREIGN KEY (monedaid) REFERENCES monedas(monedaid);


--
-- Name: movicajapoliza; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movicaja
    ADD CONSTRAINT movicajapoliza FOREIGN KEY (polizaid) REFERENCES polizas(polizaid);


--
-- Name: movimientos; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movipolizas
    ADD CONSTRAINT movimientos FOREIGN KEY (polizaid) REFERENCES polizas(polizaid);


--
-- Name: movipolizasmovibanco; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movibanco
    ADD CONSTRAINT movipolizasmovibanco FOREIGN KEY (movipolizaid) REFERENCES movipolizas(movipolizaid);


--
-- Name: movipolizasmovicaja; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movicaja
    ADD CONSTRAINT movipolizasmovicaja FOREIGN KEY (movipolizaid) REFERENCES movipolizas(movipolizaid);


--
-- Name: ocupacion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudingreso
    ADD CONSTRAINT ocupacion FOREIGN KEY (ocupacion) REFERENCES ocupacion(ocupacion);


--
-- Name: polizasmovibanco; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movibanco
    ADD CONSTRAINT polizasmovibanco FOREIGN KEY (polizaid) REFERENCES polizas(polizaid);


--
-- Name: precorteprestamo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY precorte
    ADD CONSTRAINT precorteprestamo FOREIGN KEY (prestamoid) REFERENCES prestamos(prestamoid);


--
-- Name: prestamoaviso; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY aviso
    ADD CONSTRAINT prestamoaviso FOREIGN KEY (prestamoid) REFERENCES prestamos(prestamoid);


--
-- Name: prestamoconvenio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY convenio
    ADD CONSTRAINT prestamoconvenio FOREIGN KEY (prestamoid) REFERENCES prestamos(prestamoid);


--
-- Name: prestamohipoteca; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY garantia
    ADD CONSTRAINT prestamohipoteca FOREIGN KEY (prestamoid) REFERENCES prestamos(prestamoid);


--
-- Name: prestamomovibanco; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movibanco
    ADD CONSTRAINT prestamomovibanco FOREIGN KEY (prestamoid) REFERENCES prestamos(prestamoid);


--
-- Name: prestamosamortizaciones; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY amortizaciones
    ADD CONSTRAINT prestamosamortizaciones FOREIGN KEY (prestamoid) REFERENCES prestamos(prestamoid);


--
-- Name: prestamosmovicaja; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movicaja
    ADD CONSTRAINT prestamosmovicaja FOREIGN KEY (prestamoid) REFERENCES prestamos(prestamoid);


--
-- Name: prestamossolicitud; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT prestamossolicitud FOREIGN KEY (solicitudprestamoid) REFERENCES solicitudprestamo(solicitudprestamoid);


--
-- Name: rangofinal; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY subrango
    ADD CONSTRAINT rangofinal FOREIGN KEY (rangofinal) REFERENCES catalogo_ctas(cuentaid);


--
-- Name: rangos; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY subrango
    ADD CONSTRAINT rangos FOREIGN KEY (rangoid) REFERENCES rango(rangoid);


--
-- Name: rel_148; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY premovipolizas
    ADD CONSTRAINT rel_148 FOREIGN KEY (cuentaid) REFERENCES catalogo_ctas(cuentaid);


--
-- Name: rel_149; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT rel_149 FOREIGN KEY (clasificacioncreditoid) REFERENCES clasificacioncredito(clasificacioncreditoid);


--
-- Name: rel_150; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT rel_150 FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: rel_151; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT rel_151 FOREIGN KEY (tipoacreditadoid) REFERENCES tipoacreditador(tipoacreditadoid);


--
-- Name: rel_152; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY saldosc
    ADD CONSTRAINT rel_152 FOREIGN KEY (cuentaid) REFERENCES catalogo_ctas(cuentaid);


--
-- Name: relacionsujeto; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY relacion
    ADD CONSTRAINT relacionsujeto FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: sabanadenominacion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY sabana
    ADD CONSTRAINT sabanadenominacion FOREIGN KEY (denominacionid) REFERENCES denominacion(denominacionid);


--
-- Name: sociobeneficiario; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY beneficiario
    ADD CONSTRAINT sociobeneficiario FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: socioingreso; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudingreso
    ADD CONSTRAINT socioingreso FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: socioinversion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY inversion
    ADD CONSTRAINT socioinversion FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: sociomotivobaja; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY socio
    ADD CONSTRAINT sociomotivobaja FOREIGN KEY (motivobajaid) REFERENCES motivobaja(motivobajaid);


--
-- Name: sociomovicaja; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movicaja
    ADD CONSTRAINT sociomovicaja FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: socioprestamos; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT socioprestamos FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: sociopromocion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY promocion
    ADD CONSTRAINT sociopromocion FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: sociorelacion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY relacion
    ADD CONSTRAINT sociorelacion FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: sociosabana; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY sabana
    ADD CONSTRAINT sociosabana FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: solicitudprestamoavales; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY avales
    ADD CONSTRAINT solicitudprestamoavales FOREIGN KEY (solicitudprestamoid) REFERENCES solicitudprestamo(solicitudprestamoid);


--
-- Name: solicitudprestamofinalidad; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudprestamo
    ADD CONSTRAINT solicitudprestamofinalidad FOREIGN KEY (clavefinalidad) REFERENCES finalidades(clavefinalidad);


--
-- Name: solicitudprestamogarantia; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudprestamo
    ADD CONSTRAINT solicitudprestamogarantia FOREIGN KEY (clavegarantia) REFERENCES tipo_garantia(clavegarantia);


--
-- Name: solicitudprestamohipoteca; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY garantia
    ADD CONSTRAINT solicitudprestamohipoteca FOREIGN KEY (solicitudprestamoid) REFERENCES solicitudprestamo(solicitudprestamoid);


--
-- Name: solicitudprestamolastuser; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudprestamo
    ADD CONSTRAINT solicitudprestamolastuser FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: solicitudprestamosocio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudprestamo
    ADD CONSTRAINT solicitudprestamosocio FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: solicitudprestamosujeto; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudprestamo
    ADD CONSTRAINT solicitudprestamosujeto FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: solicitudprestamotipoprestamo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudprestamo
    ADD CONSTRAINT solicitudprestamotipoprestamo FOREIGN KEY (tipoprestamoid) REFERENCES tipoprestamo(tipoprestamoid);


--
-- Name: solicitudprestamousuario; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudprestamo
    ADD CONSTRAINT solicitudprestamousuario FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: solicitudrelacion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY relacion
    ADD CONSTRAINT solicitudrelacion FOREIGN KEY (solicitudingresoid) REFERENCES solicitudingreso(solicitudingresoid);


--
-- Name: sujetoaval; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY avales
    ADD CONSTRAINT sujetoaval FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: sujetobeneficiario; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY beneficiario
    ADD CONSTRAINT sujetobeneficiario FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: sujetobienes; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY bienes
    ADD CONSTRAINT sujetobienes FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: sujetodomicilio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY domicilio
    ADD CONSTRAINT sujetodomicilio FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: sujetoprocampo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY procampo
    ADD CONSTRAINT sujetoprocampo FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: sujetosocio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY socio
    ADD CONSTRAINT sujetosocio FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: sujetousuario; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY usuarios
    ADD CONSTRAINT sujetousuario FOREIGN KEY (sujetoid) REFERENCES sujeto(sujetoid);


--
-- Name: tablareservaaplicada; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY precorte
    ADD CONSTRAINT tablareservaaplicada FOREIGN KEY (tablareservaid) REFERENCES tablareserva(tablareservaid);


--
-- Name: tablonsocio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tablon
    ADD CONSTRAINT tablonsocio FOREIGN KEY (socioid) REFERENCES socio(socioid);


--
-- Name: tasatipoinversion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tasa
    ADD CONSTRAINT tasatipoinversion FOREIGN KEY (tipoinversionid) REFERENCES tipoinversion(tipoinversionid);


--
-- Name: tasatipomovimiento; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tasa
    ADD CONSTRAINT tasatipomovimiento FOREIGN KEY (tipomovimientoid) REFERENCES tipomovimiento(tipomovimientoid);


--
-- Name: tasatipoprestamo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tasa
    ADD CONSTRAINT tasatipoprestamo FOREIGN KEY (tipoprestamoid) REFERENCES tipoprestamo(tipoprestamoid);


--
-- Name: tipoavisoaviso; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY aviso
    ADD CONSTRAINT tipoavisoaviso FOREIGN KEY (tipoavisoid) REFERENCES tipoaviso(tipoavisoid);


--
-- Name: tipodeusuario; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY usuarios
    ADD CONSTRAINT tipodeusuario FOREIGN KEY (tipousuarioid) REFERENCES tipousuario(tipousuarioid);


--
-- Name: tipoinversioninversion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY inversion
    ADD CONSTRAINT tipoinversioninversion FOREIGN KEY (tipoinversionid) REFERENCES tipoinversion(tipoinversionid);


--
-- Name: tipomovibancomovibanco; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movibanco
    ADD CONSTRAINT tipomovibancomovibanco FOREIGN KEY (tipomovibancoid) REFERENCES tipomovibanco(tipomovibancoid);


--
-- Name: tipomovimientomovicaja; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY movicaja
    ADD CONSTRAINT tipomovimientomovicaja FOREIGN KEY (tipomovimientoid) REFERENCES tipomovimiento(tipomovimientoid);


--
-- Name: tipomovimientopromocion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tipopromocion
    ADD CONSTRAINT tipomovimientopromocion FOREIGN KEY (tipomovimientoid) REFERENCES tipomovimiento(tipomovimientoid);


--
-- Name: tipomovimientotipoprestamo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tipoprestamo
    ADD CONSTRAINT tipomovimientotipoprestamo FOREIGN KEY (tipomovimientoid) REFERENCES tipomovimiento(tipomovimientoid);


--
-- Name: tipoprestamoprestamos; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT tipoprestamoprestamos FOREIGN KEY (tipoprestamoid) REFERENCES tipoprestamo(tipoprestamoid);


--
-- Name: tipoprestamoprocampo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY procampo
    ADD CONSTRAINT tipoprestamoprocampo FOREIGN KEY (tipoprestamoid) REFERENCES tipoprestamo(tipoprestamoid);


--
-- Name: tipopromocionpromocion; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY promocion
    ADD CONSTRAINT tipopromocionpromocion FOREIGN KEY (tipopromocionid) REFERENCES tipopromocion(tipopromocionid);


--
-- Name: tiposocio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY socio
    ADD CONSTRAINT tiposocio FOREIGN KEY (tiposocioid) REFERENCES tiposocio(tiposocioid);


--
-- Name: tiposocioingreso; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY solicitudingreso
    ADD CONSTRAINT tiposocioingreso FOREIGN KEY (tiposocioid) REFERENCES tiposocio(tiposocioid);


--
-- Name: usuarioconvenio; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY convenio
    ADD CONSTRAINT usuarioconvenio FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: usuarioprestamo; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY prestamos
    ADD CONSTRAINT usuarioprestamo FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: usuariosmodulos; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY permisosmodulos
    ADD CONSTRAINT usuariosmodulos FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: usuariosparametros; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY parametros
    ADD CONSTRAINT usuariosparametros FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: usuariotablon; Type: FK CONSTRAINT; Schema: sucursal1; Owner: sistema
--

ALTER TABLE ONLY tablon
    ADD CONSTRAINT usuariotablon FOREIGN KEY (usuarioid) REFERENCES usuarios(usuarioid);


--
-- Name: public; Type: ACL; Schema: -; Owner: postgres
--

REVOKE ALL ON SCHEMA public FROM PUBLIC;
REVOKE ALL ON SCHEMA public FROM postgres;
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO PUBLIC;


--
-- PostgreSQL database dump complete
--

